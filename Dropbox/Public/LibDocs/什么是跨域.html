<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<style>
body {
 font-size: 24px;
 background-color: #000000;
 color: #40C060;
 margin-left: 15%;
 margin-right: 15%;
}
a { text-decoration: none;
    color: #28B8B8;}
a:visited { color: #88A828;}
A:hover {   color: yellow;}
A:focus {   color: red;}
code { color: pink; background-color: #001500}
pre { color: gray; background-color: #001010}
u {text-decoration: none; border-bottom: 1px solid gold; }​
h1 {font-size: 50%;}
a.newtype { color: pink}
#absoluteImg { position: absolute; left: 10%; top: 15%; width: 10%;
  padding: 3px;
  border-radius: 10%;
  border: 2px solid gold;
  background-color: darkgray;
  width: 114px;
  height: 150px; 
}
#redrose { color: #cc0099}
#redword { color: red}
#yellowword { color: yellow}
#greenword { color: lightgreen}
#limeword { color: #00ff00}
#orangeword { color: orange}
#cyanword { color: cyan}
#whiteword { color: white}
#grayword { color: gray}
#brownword { color: #ff8000}
#yellowgreen { color: #bfff00}
#palered { color: #ffcccc}
#blueword { color: dodgerblue}

#toc, #gdstuff, #bdstuff, #someReasons, #contentIndex  {
 margin-left: 20%;
 margin-right: 20%;
   padding: 1%;
   text-align: left;
   box-shadow: 5px 5px 15px #8B8;
}

}
#toc {
	color: gold;
	font-size: 60%;
	line-height: 60%
}
#contentIndex {
   color: gray;
   font-size: 80%;

}
#gdstuff {
    color: red;
    font-size: 80%;
}
#bdstuff {
    color: green;
    font-size: 80%;
}
#someReasons {
    color: orange;
    font-size: 80%;
}
.left {
    position: absolute;
    border-radius: 4px;
    left: 100px;
    color: GoldenRod;
    border: 1px solid GoldenRod;
    padding: 3px;
    font-size: 60%;
}
.right {
    position: absolute;
    border-radius: 4px;
    right: 100px;
    color: blue;
    border: 1px solid GoldenRod;
    padding: 3px;
    font-size: 60%;
}
.ulleft {
    left: 150px;
    border-radius: 8px;
    border-bottom: 1px solid GoldenRod;
    padding: 3px;
    font-size: 90%;
}
.tophat {
    right: 150px;
    border-radius: 10px;
    border-top: 1px solid GoldenRod;
    padding: 3px;
    font-size: 90%;
}
.tophatdot {
    border-radius: 16px;
    border-top: 1px dotted GoldenRod;
    padding: 1px;
    font-size: 90%;
}
.redtophatdot {
    border-radius: 32px;
    border-top: 1px dotted red;
    padding: 1px;
    font-size: 90%;
}
.bracketit {
    border-radius: 5px;
    border-left: 1px solid GoldenRod;
    border-right: 1px solid GoldenRod;
    padding: 3px;
    font-size: 90%;
}
.aquacolor {
    color: Aqua;
}
.bordsub {
    display: inline-block;
    color: #F07070;
    border: 1px solid darkcyan;
    padding: 1px;
    border-radius: 3px;
    font-size: 90%;
}
.bord {
    color: redrose;
    border: 1px solid GoldenRod;
  	border-radius: 4px;
    font-size: 90%;
    padding: 1px;
    font-size: 90%;
}
.redbord {
    color: white;
    border: 1px solid red;
    padding: 3px;
    font-size: 60%;
    border-radius: 6px;
}
.whitebord {
    color: red;
    border: 1px solid white;
    padding: 3px;
    font-size: 60%;
    border-radius: 6px;
}
.brownbord {
    color: gold;
    border: 1px solid brown;
    padding: 2px;
    font-size: 60%;
    border-radius: 3px;
}
.goldbord {
    color: white;
    border: 1px solid gold;
    padding: 2px;
    font-size: 60%;
    border-radius: 3px;
}
.greenbord {
    background-color: #003300;
    color: orange;
    border: 1px solid green;
    padding: 2px;
    font-size: 60%;
    border-radius: 3px;
}
.orangebord {
    background-color: #003300;
    color: green;
    border: 1px solid orange;
    padding: 2px;
    font-size: 60%;
    border-radius: 3px;
}
.gotop {
    color: Tan;
    border: 1px solid #e6afff;
    padding: 3px;
    font-size: 60%;
    border-radius: 6px;
}
.highlight { 
    color: white;
    background-color: #002030
  }
.redrose { color: #cc0099}
.redword { color: red}
.yellowword { color: yellow}
.greenword { color: #ccff66}
.limeword { color: .00ff00}
.orangeword { color: orange}
.cyanword { color: cyan}
.pinkword { color: pink}
.whiteword { color: white}
.grayword { color: gray}
.brownword { color: #ff8000}
.yellowgreen { color: #bfff00}
.palered { color: #ffcccc}
.blueword { color: dodgerblue}
.purpleword { color: darkorchid}
.goldword, h2, h3, h4 { color: GoldenRod}
.silverword { color: silver}
.blackword { color: black}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.js"></script>
<script>
$(document).ready(function(){
    $('h1, h2, h3, h4, .redword, .greenword, .orangeword, .blueword, strong').click(function(){
    parent.history.back();
    return false;
    });
});
</script>

</head>
<body>
<div id="toc">目錄：<br></div>

<h2>前端常见跨域解决方案</h2>
<h3>什么是跨域？</h3>
跨域是指一个域下的文档或脚本试图去请求另一个域下的资源，这里跨域是广义的。
<br><br>
广义的跨域：
<br><br>
1) 资源跳转：A链接、重定向、表单提交
<br>
2) 资源嵌入：&lt;link&gt;、&lt;script&gt;、&lt;img&gt;、&lt;frame&gt;等dom标签，还有样式中background:url()、@font-face()等文件外链
<br>
3) 脚本请求：js发起的ajax请求、dom和js对象的跨域操作等
<br><br>
其实我们通常所说的跨域是狭义的，是由浏览器同源策略限制的一类请求场景。
<br><br>
<strong>
什么是同源策略？
</strong>
<br><br>
同源策略/SOP（Same origin policy）是一种约定，由Netscape公司1995年引入浏览器，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到XSS、CSFR等攻击。所谓同源是指“协议+域名+端口”三者相同，即便两个不同的域名指向同一个ip地址，也非同源。
<br><br>
同源策略限制以下几种行为：
<br><br>
1) Cookie、LocalStorage 和 IndexDB 无法读取
<br>
2) DOM 和 Js对象无法获得
<br>
3) AJAX 请求不能发送
<br><br>
<strong>
常见跨域场景
</strong>
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgVuMfv1IP1XCNdps3oUmAicLvGc6lcdtcibn4eujGBhc56Y9hueKMIWTA/0?wx_fmt=png">
<br>
<strong>

</strong>
<br>
<strong>
跨域解决方案
</strong>
<br><br>
1、 通过jsonp跨域
<br>
2、 document.domain + iframe跨域
<br>
3、 location.hash + iframe
<br>
4、 window.name + iframe跨域
<br>
5、 postMessage跨域
<br>
6、 跨域资源共享（CORS）
<br>
7、 nginx代理跨域
<br>
8、 nodejs中间件代理跨域
<br>
9、 WebSocket协议跨域
<br><br>
<strong>
一、通过jsonp跨域
</strong>
<br><br>
通常为了减轻web服务器的负载，我们把js、css，img等静态资源分离到另一台独立域名的服务器上，在html页面中再通过相应的标签从不同域名下加载静态资源，而被浏览器允许，基于此原理，我们可以通过动态创建script，再请求一个带参网址实现跨域通信。
<br><br>
1）原生实现：
<br>

<br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgMWl0iaokd3CB2picLD0ibceNm8FIamPPkoHrFrXrRO1I1Ribu9T3M0mWvw/0?wx_fmt=png">
<br><br>
服务端返回如下（返回时即执行全局函数）：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgW3Uib3NJIJyysX10MxyeBzUrg8h4zA1Hzaia8nic4s1NsMXLvZicsKXuLA/0?wx_fmt=png">
<br>

<br>
2）jquery ajax：
<br>

<br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgf55m9Zd65W11zM6NdO6ibiaStrgmvW6dDNRCmy9TujZILRAZ9ZPjlibgw/0?wx_fmt=png">
<br>

<br>
3）vue.js：
<br>

<br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgaJnYL5VRT4yIznrUSiaF78vVvVLCJmRTm83fd6eAuQ25RiaqKftSdIeg/0?wx_fmt=png">
<br><br>
后端node.js代码示例：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbggFlLznSyRpypzFzvC7gT02UaoZdrMTKAqicBUs8UWibSsZvAQeWAYMAw/0?wx_fmt=png">
<br><br>
jsonp缺点：只能实现get一种请求。
<br><br>
<strong>
二、document.domain + iframe跨域
</strong>
<br><br>
此方案仅限主域相同，子域不同的跨域应用场景。
<br><br>
实现原理：两个页面都通过js强制设置document.domain为基础主域，就实现了同域。
<br><br>
1）父窗口：
<br>
(http://www.domain.com/a.html)
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgwico5YBMrTnGTticxs5gSmkia8Df51dp5wg6iblawkqiamBRVxU0dgBtBqw/0?wx_fmt=png">
<br><br>
2）子窗口：
<br>
(http://child.domain.com/b.html)
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgwfcV4rUHomyicTKXd2O3vlZT87jcWDXV7S6lSM0yyuFvOrFZJ3TMeNg/0?wx_fmt=png">
<br><br>
<strong>
三、location.hash + iframe跨域
</strong>
<br><br>
实现原理：a欲与b跨域相互通信，通过中间页c来实现。 三个页面，不同域之间利用iframe的location.hash传值，相同域之间直接js访问来通信。
<br><br>
具体实现：A域：a.html -&gt; B域：b.html -&gt; A域：c.html，a与b不同域只能通过hash值单向通信，b与c也不同域也只能单向通信，但c与a同域，所以c可通过parent.parent访问a页面所有对象。
<br><br>
1）a.html：
<br>
(http://www.domain1.com/a.html)
<br>

<br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgSCuH7IWsumqtcVFUQaeqEfxSl5U11VlvLh75rHFI1MLtFlqTuXRnGw/0?wx_fmt=png">
<br><br>
2）b.html：
<br>
(http://www.domain2.com/b.html)
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbg5HglbX3WAK407XbbeibIHlg86Od4IpSPhJpGXQEhEDCNukZfETswOFQ/0?wx_fmt=png">
<br>

<br>
3）c.html：
<br>
(http://www.domain1.com/c.html)
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgWOnXkia6pM0JApXRox5z6KCXmJl6kEcRTTbFdgjVztLTicWmG6lKB1Zw/0?wx_fmt=png">
<br><br>
<strong>
四、window.name + iframe跨域
</strong>
<br><br>
window.name属性的独特之处：name值在不同的页面（甚至不同域名）加载后依旧存在，并且可以支持非常长的 name 值（2MB）。
<br><br>
1）a.html：
<br>
(http://www.domain1.com/a.html)
<br>

<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgz861pich8YtvicF9PMkPhxDY4mAgApWUCaTP56QPm7ETH75o9xYpnqgg/0?wx_fmt=png">
<br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgcwEjaAtS98APNmOaIa7hUIft21uBGPrlQCLbFw0Yq820EB5HKKZ7Wg/0?wx_fmt=png">
<br>

<br>
2）proxy.html：
<br>
(http://www.domain1.com/proxy....
 
<br>
中间代理页，与a.html同域，内容为空即可。
<br><br>
3）b.html：
<br>
(http://www.domain2.com/b.html)
<br>

<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbguYdSia2icUX7ibQwJWcB1JibRG9ArHfngsrKebJ2cybSjb7PtsDw89fJVA/0?wx_fmt=png">
<br>

<br>
总结：通过iframe的src属性由外域转向本地域，跨域数据即由iframe的window.name从外域传递到本地域。这个就巧妙地绕过了浏览器的跨域访问限制，但同时它又是安全操作。
<br><br>
<strong>
五、postMessage跨域
</strong>
<br><br>
postMessage是HTML5 XMLHttpRequest Level 2中的API，且是为数不多可以跨域操作的window属性之一，它可用于解决以下方面的问题：
<br><br>
a） 页面和其打开的新窗口的数据传递
<br>
b） 多窗口之间消息传递
<br>
c） 页面与嵌套的iframe消息传递
<br>
d） 上面三个场景的跨域数据传递
<br><br>
<ul class=" list-paddingleft-2" style="list-style-type: circle;">
<li>
用法：postMessage(data,origin)方法接受两个参数
<br>
</li>
<li>
data： html5规范支持任意基本类型或可复制的对象，但部分浏览器只支持字符串，所以传参时最好用JSON.stringify()序列化。
<br>
</li>
<li>
origin： 协议+主机+端口号，也可以设置为"*"，表示可以传递给任意窗口，如果要指定和当前窗口同源的话设置为"/"。
<br>
</li>
</ul>
<br>
1）a.html：
<br>
(http://www.domain1.com/a.html)
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbg65yE2eMS5dicDl5f1ibCzPlQO6ibXZK2aIK5z5G9dvQE2UsYPC5zZ2lWQ/0?wx_fmt=png">
<br><br>
2）b.html：
<br>
(http://www.domain2.com/b.html)
<br>

<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgIicI3DkPxRctgvdgOnib6Ye8ViaibLjAKx09sNuyJgalEUR3rnib9y4gqnw/0?wx_fmt=png">
<br><br>
<strong>
六、跨域资源共享（CORS）
</strong>
<br><br>
普通跨域请求：只服务端设置Access-Control-Allow-Origin即可，前端无须设置，若要带cookie请求：前后端都需要设置。
<br><br>
另外需注意：所带cookie为跨域请求接口所在域的cookie，而非当前页。如果想实现当前页cookie的写入，可参考下文七、nginx反向代理时设置proxy_cookie_domain和八、NodeJs中间件代理时cookieDomainRewrite设置。
<br><br>
目前，所有浏览器都支持该功能(IE8+：IE8/9需要使用XDomainRequest对象来支持CORS）)，CORS也已经成为主流的跨域解决方案。
<br><br>
1. 前端设置：
<br><br>
1）原生ajax
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgg2xRCBRflJJh8C3FLY8UmO4RF15ibMZOE2ug1nB6CdouECUwcX4srwg/0?wx_fmt=png">
<br>

<br>
示例代码：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgWVoeEiarpHVqRroEnT8319ULe5LArrb2pgTiaxNk9jbP80SA3rNjBQYA/0?wx_fmt=png">
<br><br>
2）jQuery ajax
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgoTmzJkGMiaMVQbQHIXbribe85qibjMBAO5jdZicEcFkYOQjp1VGQXN51BA/0?wx_fmt=png">
<br><br>
3）vue框架
<br>
在vue-resource封装的ajax组件中加入以下代码：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgQFZicwXCNAIOYRP69Spp52pNqia0hl99kCGHd7WiaAR90wnLQaltk8hlQ/0?wx_fmt=png">
<br><br>
2. 服务端设置：
<br><br>
若后端设置成功，前端浏览器控制台则不会出现跨域报错信息，反之，说明没设成功。
<br><br>
1）Java后台：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgbuuRb9ibvePhGaz9ibH1ibjaWQL06hn92vKWpibvAqMTicvaFAc5ZZAjoiaA/0?wx_fmt=png">
<br><br>
2）Nodejs后台示例：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgibwoXNicKnbKibm5TMPnyPbTlVDODj1RGPxiaksbHMib2tuuJRU7dhSfVRA/0?wx_fmt=png">
<br><br>
<strong>
七、nginx代理跨域
</strong>
<br><br>
1. nginx配置解决iconfont跨域
<br><br>
浏览器跨域访问js、css、img等常规静态资源被同源策略许可，但iconfont字体文件(eot|otf|ttf|woff|svg)例外，此时可在nginx的静态资源服务器中加入以下配置。
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgKU9Gpicsiaf6X6uVtKdiccsKKqbHYhWsqUE9h6utyJURnSRjFH502PydQ/0?wx_fmt=png">
<br><br>
2. nginx反向代理接口跨域
<br><br>
跨域原理： 同源策略是浏览器的安全策略，不是HTTP协议的一部分。服务器端调用HTTP接口只是使用HTTP协议，不会执行JS脚本，不需要同源策略，也就不存在跨越问题。
<br><br>
实现思路：通过nginx配置一个代理服务器（域名与domain1相同，端口不同）做跳板机，反向代理访问domain2接口，并且可以顺便修改cookie中domain信息，方便当前域cookie写入，实现跨域登录。
<br><br>
nginx具体配置：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgjH1sFh956XldqpGLo75Yn0WrUqyR2sia126Iej6KdQibR9bFjrGtibWGw/0?wx_fmt=png">
<br><br>
1)&nbsp;前端代码示例：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgFIlJoGGFucIkX02u50jf0SbqibV6myFLk30zcdxNLCP7MOqGHOBVUGA/0?wx_fmt=png">
<br><br>
2)&nbsp;Nodejs后台示例：
<br>

<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgRHca64NoiaAnqoUdxgdIWeuZYmQw8qWjdaGIx8ktRadgQdpGxlHYI0g/0?wx_fmt=png">
<br><br>
<strong>
八、Nodejs中间件代理跨域
</strong>
<br><br>
node中间件实现跨域代理，原理大致与nginx相同，都是通过启一个代理服务器，实现数据的转发。
<br><br>
1. 非vue框架的跨域（2次跨域）
<br><br>
利用node + express + http-proxy-middleware搭建一个proxy服务器。
<br><br>
1）前端代码示例：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgDYKcFxwrv2ChxkVy43NRuN0jz00hXicjB1EibugtgupcrOib52bKuiaosA/0?wx_fmt=png">
<br><br>
2）中间件服务器：
<br>

<br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgdSazXUicKPmgcibCgLYkVGEVHzIfxeuRCemfAVmoHPjasHSV7DVrby7w/0?wx_fmt=png">
<br><br>
3）Nodejs后台同（六：nginx）
<br><br>
2. vue框架的跨域（1次跨域）
<br><br>
利用node + webpack + webpack-dev-server代理接口跨域。在开发环境下，由于vue渲染服务和接口代理服务都是webpack-dev-server同一个，所以页面与代理接口之间不再跨域，无须设置headers跨域信息了。
<br><br>
webpack.config.js部分配置：
<br>

<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbg58PBiaXicv8ajicSZibWJkYySut8gQTvFrUOQ0U7rhHbDvw4IbW1F0Fl9A/0?wx_fmt=png">
<br><br>
<strong>
九、WebSocket协议跨域
</strong>
<br><br>
WebSocket protocol是HTML5一种新的协议。它实现了浏览器与服务器全双工通信，同时允许跨域通讯，是server push技术的一种很好的实现。
<br><br>
原生WebSocket API使用起来不太方便，我们使用Socket.io，它很好地封装了webSocket接口，提供了更简单、灵活的接口，也对不支持webSocket的浏览器提供了向下兼容。
<br><br>
1）前端代码：
<br><br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbgoSJy4icZt7sBQQth9u1VZNWD1venn7dc1No2FozAYkT9HA7hzbSe2YA/0?wx_fmt=png">
<br><br>
2）Nodejs socket后台：
<br>
</section>
</section>
<br>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eDpwXmSEM4FbibFicfokYf7iaRNCf1XDWbg4RolsdiabiaDwibn5tA0Bs6y7WNj4WFvOWR7nrxMc645tqzMYO6QWLu6Q/0?wx_fmt=png">
<script>
  $(function() {
    var toc = $('#toc');

    function makeLi(text, href) {
      return $('<a href="' + href + '">' + text + '</a>');
    }

    $('h1, h2, h3, h4, strong').each(function(i) {
      var chapter = $(this), chapterNumber = i + 1;
      toc.append(
        makeLi(chapter.text(), '#chapter-' + chapterNumber), "<br>"
      );
      chapter.attr('id', 'chapter-' + chapterNumber);
    });
  });
</script>

</body>
</html>
