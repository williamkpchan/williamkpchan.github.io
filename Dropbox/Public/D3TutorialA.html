<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">


<style type="text/css">

body { 
 margin: 5%;
 font-size: 22px;
 background-color: #000000;
 color: #109030;
}
a { text-decoration: none;
	color: #28B8B8;}
a:visited {	color: #389898;}
A:hover {	color: yellow;}
A:focus {	color: red;}
code { color: #90B090; background-color: #001800}
pre { color: gray; background-color: #001010}
#newtype { color: pink}
#redpink { color: #cc0099}
#redword { color: red}
#yellowword { color: yellow}
#greenword { color: lightgreen}
#limeword { color: #00ff00}
#orangeword { color: orange}
#cyanword { color: cyan}
#whiteword { color: white}
#grayword { color: gray}
#brownword { color: #ff8000}
#yellowgreen { color: #bfff00}
#palered { color: #ffcccc}
#blueword { color: dodgerblue}
#purpleword { color: darkorchid}
#goldword { color: GoldenRod}
#silverword { color: silver}
#blackword { color: black}
.left {
    position: absolute;
    left: 100px;
    color: GoldenRod;
    border: 1px solid GoldenRod;
    padding: 2px;
    font-size: 60%;
}
.bord {
    color: redpink;
    border: 1px solid GoldenRod;
    padding: 1px;
    font-size: 90%;
}
.highlight { 
    color: white;
    background-color: #002030
  }
</STYLE>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

<script>
$(document).ready(function(){
    $('h1,h2,h3').click(function(){
    parent.history.back();
    return false;
    });
});
</script>
</head>

<body>



<br>

<span class="preface">
<a href="#_conventions_used_in_this_book">Preface</a></span>

<ul>

<li>
<span class="sect1">
<a href="#_conventions_used_in_this_book">Conventions Used in This Book</a></span></li>

<li>
<span class="sect1">
<a href="#_using_code_examples">Using Code Examples</a></span></li>

<li>
<span class="sect1">
<a href="#list_interactive_examples">List of Interactive Examples</a></span></li>

<li>
<span class="sect1">
<a href="#_safari_books_online">Safari? Books Online</a></span></li>

<li>
<span class="sect1">
<a href="#_how_to_contact_us">How to Contact Us</a></span></li>

<li>
<span class="sect1">
<a href="#_acknowledgments">Acknowledgments</a></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_why_data_visualization">1. Introduction</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_why_data_visualization">Why Data Visualization?</a></span></li>

<li>
<span class="sect1">
<a href="#_why_write_code">Why Write Code?</a></span></li>

<li>
<span class="sect1">
<a href="#_why_interactive">Why Interactive?</a></span></li>

<li>
<span class="sect1">
<a href="#_why_on_the_web">Why on the Web?</a></span></li>

<li>
<span class="sect1">
<a href="#_what_this_book_is">What This Book Is</a></span></li>

<li>
<span class="sect1">
<a href="#_who_you_are">Who You Are</a></span></li>

<li>
<span class="sect1">
<a href="#_what_this_book_is_not">What This Book Is Not</a></span></li>

<li>
<span class="sect1">
<a href="#_using_sample_code">Using Sample Code</a></span></li>

<li>
<span class="sect1">
<a href="#_thank_you">Thank You</a></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_what_it_does">2. Introducing D3</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_what_it_does">What It Does</a></span></li>

<li>
<span class="sect1">
<a href="#_what_it_doesn_t_do">What It Doesn’t Do</a></span></li>

<li>
<span class="sect1">
<a href="#_origins_and_context">Origins and Context</a></span></li>

<li>

<span class="sect1">
<a href="#alternatives_2">Alternatives</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_easy_charts">Easy Charts</a></span></li>

<li>
<span class="sect2">
<a href="#_graph_visualizations">Graph Visualizations</a></span></li>

<li>
<span class="sect2">
<a href="#_geomapping">Geomapping</a></span></li>

<li>
<span class="sect2">
<a href="#_almost_from_scratch">Almost from Scratch</a></span></li>

<li>
<span class="sect2">
<a href="#_three_dimensional">Three-Dimensional</a></span></li>

<li>
<span class="sect2">
<a href="#_tools_built_with_d3">Tools Built with D3</a></span></li>
</ul>
</li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_the_web">3. Technology Fundamentals</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_the_web">The Web</a></span></li>

<li>

<span class="sect1">
<a href="#_html">HTML</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_content_plus_structure">Content Plus Structure</a></span></li>

<li>
<span class="sect2">
<a href="#_adding_structure_with_elements">Adding Structure with Elements</a></span></li>

<li>
<span class="sect2">
<a href="#_common_elements">Common Elements</a></span></li>

<li>
<span class="sect2">
<a href="#_attributes">Attributes</a></span></li>

<li>
<span class="sect2">
<a href="#_classes_and_ids">Classes and IDs</a></span></li>

<li>
<span class="sect2">
<a href="#_comments">Comments</a></span></li>
</ul>
</li>

<li>
<span class="sect1">
<a href="#_dom">DOM</a></span></li>

<li>
<span class="sect1">
<a href="#developer_tools_3">Developer Tools</a></span></li>

<li>
<span class="sect1">
<a href="#_rendering_and_the_box_model">Rendering and the Box Model</a></span></li>

<li>

<span class="sect1">
<a href="#_css">CSS</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_selectors">Selectors</a></span></li>

<li>
<span class="sect2">
<a href="#_properties_and_values">Properties and Values</a></span></li>

<li>
<span class="sect2">
<a href="#_comments_2">Comments</a></span></li>

<li>
<span class="sect2">
<a href="#_referencing_styles">Referencing Styles</a></span></li>

<li>
<span class="sect2">
<a href="#_inheritance_cascading_and_specificity">Inheritance, Cascading, and Specificity</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_javascript">JavaScript</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_hello_console">Hello, Console</a></span></li>

<li>
<span class="sect2">
<a href="#_variables">Variables</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_other_variable_types">Other Variable Types</a></span></li>

<li>
<span class="sect2">
<a href="#_arrays">Arrays</a></span></li>

<li>
<span class="sect2">
<a href="#_objects">Objects</a></span></li>

<li>
<span class="sect2">
<a href="#_objects_and_arrays">Objects and Arrays</a></span></li>

<li>
<span class="sect2">
<a href="#_mathematical_operators">Mathematical Operators</a></span></li>

<li>
<span class="sect2">
<a href="#_comparison_operators">Comparison Operators</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_control_structures">Control Structures</a></span></li>

<li>
<span class="sect2">
<a href="#_functions">Functions</a></span></li>

<li>
<span class="sect2">
<a href="#_comments_3">Comments</a></span></li>

<li>
<span class="sect2">
<a href="#_referencing_scripts">Referencing Scripts</a></span></li>

<li>
<span class="sect2">
<a href="#_javascript_gotchas">JavaScript Gotchas</a></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#SVG_3">SVG</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_the_svg_element">The SVG Element</a></span></li>

<li>
<span class="sect2">
<a href="#_simple_shapes">Simple Shapes</a></span></li>

<li>
<span class="sect2">
<a href="#_styling_svg_elements">Styling SVG Elements</a></span></li>

<li>
<span class="sect2">
<a href="#_layering_and_drawing_order">Layering and Drawing Order</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_transparency">Transparency</a></span></li>
</ul>
</li>

<li>
<span class="sect1">
<a href="#_a_note_on_compatibility">A Note on Compatibility</a></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_downloading_d3">4. Setup</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_downloading_d3">Downloading D3</a></span></li>

<li>
<span class="sect1">
<a href="#_referencing_d3">Referencing D3</a></span></li>

<li>

<span class="sect1">
<a href="#_setting_up_a_web_server">Setting Up a Web Server</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_terminal_with_python">Terminal with Python</a></span></li>

<li>
<span class="sect2">
<a href="#_mamp_wamp_and_lamp">MAMP, WAMP, and LAMP</a></span></li>

<li>
<span class="sect2">
<a href="#_diving_in">Diving In</a></span></li>
</ul>
</li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_generating_page_elements">5. Data</a></span>
<ul>

<li>

<span class="sect1">
<a href="#_generating_page_elements">Generating Page Elements</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_chaining_methods">Chaining Methods</a></span></li>

<li>
<span class="sect2">
<a href="#_one_link_at_a_time">One Link at a Time</a></span></li>

<li>
<span class="sect2">
<a href="#_the_hand_off">The Hand-off</a></span></li>

<li>
<span class="sect2">
<a href="#_going_chainless">Going Chainless</a></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_binding_data">Binding Data</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_in_a_bind">In a Bind</a></span></li>

<li>
<span class="sect2">
<a href="#_data">Data</a></span></li>

<li>
<span class="sect2">
<a href="#please_make_your_selection_5">Please Make Your Selection</a></span></li>

<li>
<span class="sect2">
<a href="#_bound_and_determined">Bound and Determined</a></span></li>

<li>
<span class="sect2">
<a href="#_using_your_data">Using Your Data</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_high_functioning">High-Functioning</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_data_wants_to_be_held">Data Wants to Be Held</a></span></li>

<li>
<span class="sect2">
<a href="#_beyond_text">Beyond Text</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_drawing_divs">6. Drawing with Data</a></span>
<ul>

<li>

<span class="sect1">
<a href="#_drawing_divs">Drawing divs</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_setting_attributes">Setting Attributes</a></span></li>

<li>
<span class="sect2">
<a href="#_a_note_on_classes">A Note on Classes</a></span></li>

<li>
<span class="sect2">
<a href="#_back_to_the_bars">Back to the Bars</a></span></li>

<li>
<span class="sect2">
<a href="#_setting_styles">Setting Styles</a></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_the_power_of_data">The Power of data()</a>
<i class="icon-bolt"></i></span>
<ul>
<li>
<span class="sect2">
<a href="#_random_data">Random Data</a>
<i class="icon-bolt"></i></span></li></ul>
</li>

<li>

<span class="sect1">
<a href="#_drawing_svgs">Drawing SVGs</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_create_the_svg">Create the SVG</a></span></li>

<li>
<span class="sect2">
<a href="#_data_driven_shapes">Data-Driven Shapes</a></span></li>

<li>
<span class="sect2">
<a href="#_pretty_colors_oooh">Pretty Colors, Oooh!</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_making_a_bar_chart">Making a Bar Chart</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_the_old_chart">The Old Chart</a></span></li>

<li>
<span class="sect2">
<a href="#_the_new_chart">The New Chart</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_color">Color</a></span></li>

<li>
<span class="sect2">
<a href="#_labels">Labels</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_making_a_scatterplot">Making a Scatterplot</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_the_data">The Data</a></span></li>

<li>
<span class="sect2">
<a href="#_the_scatterplot">The Scatterplot</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_size">Size</a></span></li>

<li>
<span class="sect2">
<a href="#_labels_2">Labels</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>
<span class="sect1">
<a href="#_next_steps">Next Steps</a></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_apples_and_pixels">7. Scales</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_apples_and_pixels">Apples and Pixels</a></span></li>

<li>
<span class="sect1">
<a href="#_domains_and_ranges">Domains and Ranges</a></span></li>

<li>
<span class="sect1">
<a href="#_normalization">Normalization</a></span></li>

<li>
<span class="sect1">
<a href="#_creating_a_scale">Creating a Scale</a>
<i class="icon-bolt"></i></span></li>

<li>

<span class="sect1">
<a href="#_scaling_the_scatterplot">Scaling the Scatterplot</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_d3_min_and_d3_max">d3.min() and d3.max()</a></span></li>

<li>
<span class="sect2">
<a href="#_setting_up_dynamic_scales">Setting Up Dynamic Scales</a></span></li>

<li>
<span class="sect2">
<a href="#_incorporating_scaled_values">Incorporating Scaled Values</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>
<span class="sect1">
<a href="#_refining_the_plot">Refining the Plot</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect1">
<a href="#_other_methods">Other Methods</a></span></li>

<li>
<span class="sect1">
<a href="#_other_scales">Other Scales</a></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_introducing_axes">8. Axes</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_introducing_axes">Introducing Axes</a></span></li>

<li>
<span class="sect1">
<a href="#_setting_up_an_axis">Setting Up an Axis</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect1">
<a href="#_cleaning_it_up">Cleaning It Up</a></span></li>

<li>
<span class="sect1">
<a href="#_check_for_ticks">Check for Ticks</a></span></li>

<li>
<span class="sect1">
<a href="#_y_not">Y Not?</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect1">
<a href="#_final_touches">Final Touches</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect1">
<a href="#_formatting_tick_labels">Formatting Tick Labels</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_modernizing_the_bar_chart">9. Updates, Transitions, and Motion</a></span>
<ul>

<li>

<span class="sect1">
<a href="#_modernizing_the_bar_chart">Modernizing the Bar Chart</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_ordinal_scales_explained">Ordinal Scales, Explained</a></span></li>

<li>
<span class="sect2">
<a href="#_round_bands_are_all_the_range_these_days">Round Bands Are All the Range These Days</a></span></li>

<li>
<span class="sect2">
<a href="#_referencing_the_ordinal_scale">Referencing the Ordinal Scale</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_other_updates">Other Updates</a></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_updating_data">Updating Data</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_interaction_via_event_listeners">Interaction via Event Listeners</a></span></li>

<li>
<span class="sect2">
<a href="#_changing_the_data">Changing the Data</a></span></li>

<li>
<span class="sect2">
<a href="#_updating_the_visuals">Updating the Visuals</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_transitions">Transitions</a>
<i class="icon-bolt"></i></span>
<ul>

<li>
<span class="sect2">
<a href="#_duration_or_how_long_is_this_going_to_take">duration(), or How Long Is This Going to Take?</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_ease_y_does_it">ease()-y Does It</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_please_do_not_delay">Please Do Not delay()</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_randomizing_the_data">Randomizing the Data</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_updating_scales">Updating Scales</a></span></li>

<li>
<span class="sect2">
<a href="#_updating_axes">Updating Axes</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_each_transition_starts_and_ends">each() Transition Starts and Ends</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>

<span class="sect1">
<a href="#_other_kinds_of_data_updates">Other Kinds of Data Updates</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_adding_values_and_elements">Adding Values (and Elements)</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_removing_values_and_elements">Removing Values (and Elements)</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_data_joins_with_keys">Data Joins with Keys</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_add_and_remove_combo_platter">Add and Remove: Combo Platter</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_recap">Recap</a></span></li>
</ul>
</li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_binding_event_listeners">10. Interactivity</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_binding_event_listeners">Binding Event Listeners</a></span></li>

<li>

<span class="sect1">
<a href="#_introducing_behaviors">Introducing Behaviors</a></span>
<ul>
<li>
<span class="sect2">
<a href="#_hover_to_highlight">Hover to Highlight</a>
<i class="icon-bolt"></i></span></li></ul>
</li>

<li>

<span class="sect1">
<a href="#_grouping_svg_elements">Grouping SVG Elements</a></span>
<ul>
<li>
<span class="sect2">
<a href="#_click_to_sort">Click to Sort</a>
<i class="icon-bolt"></i></span></li></ul>
</li>

<li>

<span class="sect1">
<a href="#_tooltips">Tooltips</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_default_browser_tooltips">Default Browser Tooltips</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_svg_element_tooltips">SVG Element Tooltips</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect2">
<a href="#_html_div_tooltips">HTML div Tooltips</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>
<span class="sect1">
<a href="#_consideration_for_touch_devices">Consideration for Touch Devices</a></span></li>

<li>
<span class="sect1">
<a href="#_moving_forward">Moving Forward</a></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_pie_layout">11. Layouts</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_pie_layout">Pie Layout</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect1">
<a href="#_stack_layout">Stack Layout</a>
<i class="icon-bolt"></i></span></li>

<li>
<span class="sect1">
<a href="#_force_layout">Force Layout</a>
<i class="icon-bolt"></i></span></li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_json_meet_geojson">12. Geomapping</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_json_meet_geojson">JSON, Meet GeoJSON</a></span></li>

<li>
<span class="sect1">
<a href="#_paths">Paths</a></span></li>

<li>
<span class="sect1">
<a href="#_projections">Projections</a></span></li>

<li>
<span class="sect1">
<a href="#_choropleth">Choropleth</a></span></li>

<li>
<span class="sect1">
<a href="#_adding_points">Adding Points</a></span></li>

<li>

<span class="sect1">
<a href="#_acquiring_and_parsing_geodata">Acquiring and Parsing Geodata</a></span>
<ul>

<li>
<span class="sect2">
<a href="#_find_shapefiles">Find Shapefiles</a></span></li>

<li>
<span class="sect2">
<a href="#_choose_a_resolution">Choose a Resolution</a></span></li>

<li>
<span class="sect2">
<a href="#_simplify_the_shapes">Simplify the Shapes</a></span></li>

<li>
<span class="sect2">
<a href="#_convert_to_geojson">Convert to GeoJSON</a></span></li>
</ul>
</li>
</ul>
</li>

<li>

<span class="chapter">
<a href="#_bitmaps">13. Exporting</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_bitmaps">Bitmaps</a></span></li>

<li>
<span class="sect1">
<a href="#_pdf">PDF</a></span></li>

<li>
<span class="sect1">
<a href="#_svg">SVG</a></span></li>
</ul>
</li>

<li>

<span class="appendix">
<a href="#_books">A. Appendix: Further Study</a></span>
<ul>

<li>
<span class="sect1">
<a href="#_books">Books</a></span></li>

<li>
<span class="sect1">
<a href="#_websites">Websites</a></span></li>

<li>
<span class="sect1">
<a href="#_twitterers">Twitterers</a></span></li>
</ul>
</li>

<li>
<span class="index">
<a href="ix01.html">Index</a></span></li>
</ul>

<br>

<section class="preface" data-original-filename="0_preface.asciidoc" id="_preface">
<div class="titlepage">
<div>
<div>
<h1 class="title">Preface</h1></div></div></div> 
<p id="this_is_a_book_">This is a book about programming data visualizations for nonprogrammers.  If you’re an artist or graphic designer with visual skills but no prior experience working with data or code, this book is for you.  If you’re a journalist or researcher with lots of data but no prior experience working with visuals or code, this book is for you, too.</p> 
<p id="this_book_will_">This book will introduce you to D3, a JavaScript-based tool for loading data into a web page and generating visuals from that data.  I assume that you have little or no programming experience.  Or, perhaps you have programmed before, but D3 and data visualization are bringing you to JavaScript for the first time, and you’ve heard bad things about it.  Well, JavaScript 
<span class="emphasis">
<em>is</em></span> a little weird, but it’s not as bad as you’ve heard, and everything is going to be all right.  Please sit down and make yourself comfortable.</p> 
<p id="this_book_began">This book began as 

<a class="ulink" href="http://alignedleft.com/tutorials/d3/" target="_top">a series of tutorials</a> posted on my website.  At the time (January 2012), there wasn’t much information on D3 available that was accessible to beginners.  Very quickly, I was getting hundreds, then thousands of page views a day—evidence that interest in the field generally (and D3 specifically) was growing like gangbusters.  If you’ve read the tutorials, portions of the book will feel familiar, but there is a 
<span class="emphasis">
<em>lot</em></span> of new material here, including many more examples, sneaky tips, and warnings of things to avoid.  Also, the book contains 78 percent more bad jokes.</p> 
<p id="data_visualizat_id1">Data visualization is an interdisciplinary field, which is just one reason it’s impossible to document the breadth of skills needed in a single book.  Fortunately, because the field is exploding in popularity, there are many new titles to choose from, each of which complements this one.</p> 
<p id="on_design_proce">On design process:</p> 
<div class="itemizedlist" id="designing_data__id1">
<ul class="itemizedlist"> 
<li class="listitem"> 

<a class="ulink" href="http://shop.oreilly.com/product/0636920022060.do" target="_top">
<span class="emphasis">
<em>Designing Data Visualizations: Intentional Communication from Data to Display</em></span></a> by Noah Iliinsky and Julie Steele. O’Reilly Media, 2011. </li> 
<li class="listitem"> 

<a class="ulink" href="http://bit.ly/15eJJJj" target="_top">
<span class="emphasis">
<em>Data Visualization: A Successful Design Process</em></span></a> by Andy Kirk.  Packt Publishing, 2012. </li> </ul></div> 
<p id="on_visual_desig">On visual design principles and techniques:</p> 
<div class="itemizedlist" id="the_functional__id1">
<ul class="itemizedlist"> 
<li class="listitem"> 

<a class="ulink" href="http://bit.ly/VINWSz" target="_top">
<span class="emphasis">
<em>The Functional Art: An Introduction to Information Graphics and Visualization</em></span></a> by Alberto Cairo. New Riders, 2012. </li> 
<li class="listitem"> 

<a class="ulink" href="http://shop.oreilly.com/product/9780596100162.do" target="_top">
<span class="emphasis">
<em>Information Dashboard Design: The Effective Visual Communication of Data</em></span></a> by Stephen Few. O’Reilly Media, 2006. </li> </ul></div> 
<p id="on_the_practica">On the practicalities of working with data:</p> 
<div class="itemizedlist" id="bad_data_handbo_id1">
<ul class="itemizedlist"> 
<li class="listitem"> 

<a class="ulink" href="http://shop.oreilly.com/product/9780596802363.do" target="_top">
<span class="emphasis">
<em>Bad Data Handbook: Mapping the World of Data Problems</em></span></a> by Q. Ethan McCallum. O’Reilly Media, 2012. </li> 
<li class="listitem"> 

<a class="ulink" href="http://shop.oreilly.com/product/9780596802363.do" target="_top">
<span class="emphasis">
<em>Data Analysis with Open Source Tools: A Hands-On Guide for Programmers and Data Scientists</em></span></a> by Philipp K. Janert. O’Reilly Media, 2010. </li> 
<li class="listitem"> 

<a class="ulink" href="http://shop.oreilly.com/product/0636920023784.do" target="_top">
<span class="emphasis">
<em>Python for Data Analysis: Agile Tools for Real World Data</em></span></a> by Wes McKinney. O’Reilly Media, 2012. </li> </ul></div> 
<div class="sect1" data-original-filename="0_preface.asciidoc" id="_conventions_used_in_this_book"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Conventions Used in This Book</h2></div></div></div> 
<p id="the_following_t">The following typographical conventions are used in this book:</p> 
<div class="variablelist" id="italic_indicate">
<dl class="variablelist"> 
<dt>
<span class="term"> 
<span class="emphasis">
<em>Italic</em></span> </span></dt> 
<dd> Indicates new terms, URLs, email addresses, filenames, and file extensions. </dd> 
<dt>
<span class="term"> <code class="literal">Constant width</code> </span></dt> 
<dd> Used for program listings, as well as within paragraphs to refer to program elements such as variable or function names, databases, data types, environment variables, statements, and keywords. </dd> 
<dt>
<span class="term"> 
<span class="strong">
<strong><code class="literal">Constant width bold</code></strong></span> </span></dt> 
<dd> Shows commands or other text that should be typed literally by the user. </dd> 
<dt>
<span class="term"> 
<span class="emphasis">
<em><code class="literal">Constant width italic</code></em></span> </span></dt> 
<dd> Shows text that should be replaced with user-supplied values or by values determined by context. </dd> </dl></div> 
<div class="tip" id="this_icon_signi_id1">
<p id="this_icon_signi_id2">This icon signifies a tip, suggestion, or general note.</p></div> 
<div class="warning" id="this_icon_indic_id1">
<p id="this_icon_indic_id2">This icon indicates a warning or caution.</p></div> </div> 
<div class="sect1" data-original-filename="0_preface.asciidoc" id="_using_code_examples"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Using Code Examples</h2></div></div></div> 
<p id="this_book_is_he">This book is here to help you get your job done. In general, if this book includes code examples, you may use the code in this book in your programs and documentation. You do not need to contact us for permission unless you’re reproducing a significant portion of the code. For example, writing a program that uses several chunks of code from this book does not require permission. Selling or distributing a CD-ROM of examples from O’Reilly books does require permission. Answering a question by citing this book and quoting example code does not require permission. Incorporating a significant amount of example code from this book into your product’s documentation does require permission.</p> 
<p id="we_appreciate_">We appreciate, but do not require, attribution. An attribution usually includes the title, author, publisher, and ISBN. For example: “
<span class="emphasis">
<em>Interactive Data Visualization for the Web</em></span> by Scott Murray (O’Reilly). Copyright 2013 Scott Murray, 978-1-449-33973-9.”</p> 
<p id="if_you_feel_you">If you feel your use of code examples falls outside fair use or the permission given above, feel free to contact us at <code class="email">&lt;

<a class="email" href="mailto:permissions@oreilly.com">permissions@oreilly.com</a>&gt;</code>.</p> </div> 
<div class="sect1" data-original-filename="0_preface.asciidoc" id="list_interactive_examples"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">List of Interactive Examples</h2></div></div></div> 
<p id="the_online_vers">The online version of 
<span class="emphasis">
<em>Interactive Data Visualization for the Web</em></span> includes 44 interactive examples to help teach you how to represent your data on the Web using D3. Here’s a full listing of these examples:</p> 
<div class="variablelist" id="try_it_now_mod_id1">
<dl class="variablelist"> 
<dt>
<span class="term">

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a></span></dt> 
<dd> 
<p id="try_it_now_mod_id2">

<a class="link" href="#interactive_3-1" title="Try It Now!">Try It Now: Modifying CSS Rules</a></p> 
<p id="try_it_now_jav_id1">

<a class="link" href="#interactive_3-2" title="Try It Now!">Try It Now: JavaScript Variables in the Console</a></p> 
<p id="try_it_now_jav_id2">

<a class="link" href="#interactive_3-3" title="Try It Now!">Try It Now: JavaScript Comparison Operators in the Console</a></p> 
<p id="try_it_now_svg">

<a class="link" href="#interactive_3-4" title="Exercise">Try It Now: SVG</a></p> </dd> 
<dt>
<span class="term">

<a class="xref" href="" title="Chapter 5. Data">Chapter 5</a></span></dt> 
<dd> 
<p id="try_it_now_dyn_id1">

<a class="link" href="#interactive_5-1" title="Try It Now!">Try It Now: Dynamic Paragraphs in D3</a></p> 
<p id="try_it_now_sti">

<a class="link" href="#interactive_5-2" title="Try It Now!">Try It Now: Still More Dynamic Paragraphs in D3</a></p> 
<p id="exercise_dynam">

<a class="link" href="#interactive_5-3" title="Exercise">Exercise: Dynamically Styled Paragraphs</a></p> </dd> 
<dt>
<span class="term">

<a class="xref" href="#interactive_6-1" title="Chapter 6. Drawing with Data">Chapter 6</a></span></dt> 
<dd> 
<p id="try_it_now_bar_id1">

<a class="link" href="#interactive_6-1" title="Try It Now!">Try It Now: Bar Charts in D3</a></p> 
<p id="try_it_now_bar_id2">

<a class="link" href="#interactive_6-2" title="Try It Now!">Try It Now: Bar Charts with Random Values</a></p> 
<p id="try_it_now_col">

<a class="link" href="#interactive_6-3" title="Try It Now!">Try It Now: Colorful Data Circles</a></p> 
<p id="try_it_now_bar_id3">

<a class="link" href="#interactive_6-4" title="Try It Now!">Try It Now: Bar Heights and Widths</a></p> 
<p id="try_it_now_fin_id1">

<a class="link" href="#interactive_6-5" title="Try It Now!">Try It Now: Final Bar Chart</a></p> 
<p id="try_it_now_dat">

<a class="link" href="#interactive_6-6" title="Try It Now!">Try It Now: <code class="literal">dataset</code> in the Console</a></p> 
<p id="try_it_now_sca_id1">

<a class="link" href="#interactive_6-7" title="Try It Now!">Try It Now: Scatterplot</a></p> </dd> 
<dt>
<span class="term">

<a class="xref" href="#interactive_7-1" title="Chapter 7. Scales">Chapter 7</a></span></dt> 
<dd> 
<p id="try_it_now_sca_id2">

<a class="link" href="#interactive_7-1" title="Try It Now!">Try It Now: <code class="literal">scale</code> in the Console</a></p> 
<p id="try_it_now_sca_id3">

<a class="link" href="#interactive_7-2" title="Try It Now!">Try It Now: Scatterplot Using x and y Scales</a></p> 
<p id="try_it_now_fin_id2">

<a class="link" href="#interactive_7-3" title="Try It Now!">Try It Now: Final Scatterplot</a></p> </dd> 
<dt>
<span class="term">

<a class="xref" href="#interactive_8-1" title="Chapter 8. Axes">Chapter 8</a></span></dt> 
<dd> 
<p id="try_it_now_sim">

<a class="link" href="#interactive_8-1" title="Try It Now!">Try It Now: Simple, but Ugly Axis</a></p> 
<p id="try_it_now_sca_id4">

<a class="link" href="#interactive_8-2" title="Try It Now!">Try It Now: Scatterplot with y Axis</a></p> 
<p id="try_it_now_sca_id5">

<a class="link" href="#interactive_8-3" title="Try It Now!">Try It Now: Scatterplot with Random Data</a></p> 
<p id="try_it_now_for_id1">

<a class="link" href="#interactive_8-4" title="Try It Now!">Try It Now: <code class="literal">formatAsPercentage</code> in the console</a></p> </dd> 
<dt>
<span class="term">

<a class="xref" href="#ch09-interactive-0point5" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a></span></dt> 
<dd> 
<p id="try_it_now_xsc">

<a class="link" href="#ch09-interactive-0point5" title="Try It Now!">Try It Now: <code class="literal">xScale</code> in the Console</a></p> 
<p id="try_it_now_upd">

<a class="link" href="#interactive_9-1" title="Try It Now!">Try It Now: Updated Chart with Correct Colors and Labels</a></p> 
<p id="try_it_now_tra_id1">

<a class="link" href="#interactive_9-2" title="Try It Now!">Try It Now: Transition in Action</a></p> 
<p id="try_it_now_a_s">

<a class="link" href="#interactive_9-3" title="Try It Now!">Try It Now: A Smoother Transition</a></p> 
<p id="try_it_now_dif">

<a class="link" href="#interactive_9-4" title="Try It Now!">Try It Now: Different Ease Types</a></p> 
<p id="try_it_now_dyn_id2">

<a class="link" href="#interactive_9-5" title="Try It Now!">Try It Now: Dynamic, Per-Element Delay Before Transition</a></p> 
<p id="try_it_now_tra_id2">

<a class="link" href="#interactive_9-6" title="Try It Now!">Try It Now: Transition with Random Data Applied</a></p> 
<p id="try_it_now_tra_id3">

<a class="link" href="#interactive_9-7" title="Try It Now!">Try It Now: Transitioning Points to Randomized Values</a></p> 
<p id="try_it_now_tra_id4">

<a class="link" href="#interactive_9-8" title="Try It Now!">Try It Now: Transitioning Points to Randomized Values, Plus Rescaled Axes!</a></p> 
<p id="try_it_now_usi">

<a class="link" href="#interactive_9-9" title="Try It Now!">Try It Now: Using <code class="literal">each()</code> to Specify Two Transitions in Sequence</a></p> 
<p id="exercise_add_l">

<a class="link" href="#interactive_9-10" title="Exercise">Exercise: Add Labels to New Bar Elements</a></p> 
<p id="exercise_remov_id1">

<a class="link" href="#interactive_9-11" title="Exercise">Exercise: Remove Labels for Deleted Bar Elements</a></p> 
<p id="exercise_remov_id2">

<a class="link" href="#interactive_9-12" title="Exercise">Exercise: Remove Labels for Deleted Bar Elements 2</a></p> 
<p id="try_it_now_add_id1">

<a class="link" href="#interactive_9-13" title="Try It Now!">Try It Now: Adding and Removing Values from a Chart</a></p> </dd> 
<dt>
<span class="term">

<a class="xref" href="#interactive_10-1" title="Chapter 10. Interactivity">Chapter 10</a></span></dt> 
<dd> 
<p id="try_it_now_add_id2">

<a class="link" href="#interactive_10-1" title="Try It Now!">Try It Now: Adding Transitions with CSS</a></p> 
<p id="try_it_now_smo">

<a class="link" href="#interactive_10-2" title="Try It Now!">Try It Now: Smoother Highlight Transitions</a></p> 
<p id="exercise_sorti">

<a class="link" href="#interactive_10-3" title="Exercise">Exercise: Sorting and Re-Sorting Visual Elements with Delay</a></p> 
<p id="try_it_now_a_b">

<a class="link" href="#interactive_10-4" title="Try It Now!">Try It Now: A Browser Default Tooltip</a></p> 
<p id="try_it_now_an__id1">

<a class="link" href="#interactive_10-5" title="Try It Now!">Try It Now: An SVG Element Tooltip</a></p> 
<p id="try_it_now_an__id2">

<a class="link" href="#interactive_10-6" title="Try It Now!">Try It Now: An HTML <code class="literal">div</code> Tooltip</a></p> </dd> 
<dt>
<span class="term">

<a class="xref" href="#interactive_11-1" title="Chapter 11. Layouts">Chapter 11</a></span></dt> 
<dd> 
<p id="try_it_now_pie">

<a class="link" href="#interactive_11-1" title="Try It Now!">Try It Now: Pie Chart</a></p> 
<p id="try_it_now_rin">

<a class="link" href="#interactive_11-2" title="Try It Now!">Try It Now: Ring Chart</a></p> 
<p id="try_it_now_sta">

<a class="link" href="#interactive_11-3" title="Exercise">Try It Now: Stacked Bar Chart</a></p> 
<p id="try_it_now_for_id2">

<a class="link" href="#interactive_11-4" title="Try It Now!">Try It Now: Force Layout</a></p> </dd> </dl></div> </div> 
<div class="sect1" data-original-filename="0_preface.asciidoc" id="_safari_books_online"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Safari® Books Online</h2></div></div></div> 
<div class="note safaribooksonline" id="safari_books_on_id1">
<p id="safari_books_on_id2">

<a class="ulink" href="http://my.safaribooksonline.com/?portal=oreilly" target="_top">Safari Books Online</a> is an on-demand digital library that delivers expert 

<a class="ulink" href="http://www.safaribooksonline.com/content" target="_top">content</a> in both book and video form from the world’s leading authors in technology and business.</p></div> 
<p id="technology_prof">Technology professionals, software developers, web designers, and business and creative professionals use Safari Books Online as their primary resource for research, problem solving, learning, and certification training.</p> 
<p id="safari_books_on_id3">Safari Books Online offers a range of 

<a class="ulink" href="http://www.safaribooksonline.com/subscriptions" target="_top">product mixes</a> and pricing programs for 

<a class="ulink" href="http://www.safaribooksonline.com/organizations-teams" target="_top">organizations</a>, 

<a class="ulink" href="http://www.safaribooksonline.com/government" target="_top">government agencies</a>, and 

<a class="ulink" href="http://www.safaribooksonline.com/individuals" target="_top">individuals</a>. Subscribers have access to thousands of books, training videos, and prepublication manuscripts in one fully searchable database from publishers like O’Reilly Media, Prentice Hall Professional, Addison-Wesley Professional, Microsoft Press, Sams, Que, Peachpit Press, Focal Press, Cisco Press, John Wiley &amp; Sons, Syngress, Morgan Kaufmann, IBM Redbooks, Packt, Adobe Press, FT Press, Apress, Manning, New Riders, McGraw-Hill, Jones &amp; Bartlett, Course Technology, and dozens 

<a class="ulink" href="http://www.safaribooksonline.com/publishers" target="_top">more</a>. For more information about Safari Books Online, please visit us 

<a class="ulink" href="http://www.safaribooksonline.com/" target="_top">online</a>.</p> </div> 
<div class="sect1" data-original-filename="0_preface.asciidoc" id="_how_to_contact_us"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">How to Contact Us</h2></div></div></div> 
<p id="please_address_">Please address comments and questions concerning this book to the publisher:</p> 
<table style="border: 0; " class="simplelist"> 
<tr>
<td>O’Reilly Media, Inc.</td></tr> 
<tr>
<td>1005 Gravenstein Highway North</td></tr> 
<tr>
<td>Sebastopol, CA 95472</td></tr> 
<tr>
<td>800-998-9938 (in the United States or Canada)</td></tr> 
<tr>
<td>707-829-0515 (international or local)</td></tr> 
<tr>
<td>707-829-0104 (fax)</td></tr> </table> 
<p id="we_have_a_web_p">We have a web page for this book, where we list errata, examples, and any additional information. You can access this page at 

<a class="ulink" href="http://oreil.ly/interactive_data_visualization_web" target="_top">http://oreil.ly/interactive_data_visualization_web</a>.</p> 
<p id="to_comment_or_a">To comment or ask technical questions about this book, send email to <code class="email">&lt;

<a class="email" href="mailto:bookquestions@oreilly.com">bookquestions@oreilly.com</a>&gt;</code>.</p> 
<p id="for_more_inform">For more information about our books, courses, conferences, and news, see our website at 

<a class="ulink" href="http://www.oreilly.com" target="_top">http://www.oreilly.com</a>.</p> 
<p id="find_us_on_face">Find us on Facebook: 

<a class="ulink" href="http://facebook.com/oreilly" target="_top">http://facebook.com/oreilly</a></p> 
<p id="follow_us_on_tw">Follow us on Twitter: 

<a class="ulink" href="http://twitter.com/oreillymedia" target="_top">http://twitter.com/oreillymedia</a></p> 
<p id="watch_us_on_you">Watch us on YouTube: 

<a class="ulink" href="http://www.youtube.com/oreillymedia" target="_top">http://www.youtube.com/oreillymedia</a></p> </div> 
<div class="sect1" data-original-filename="0_preface.asciidoc" id="_acknowledgments"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Acknowledgments</h2></div></div></div> 
<p id="my_name_may_be_">My name may be on the cover, but as an author, I feel as though I am merely funneling the wisdom of hundreds of other brilliant minds onto the page.</p> 
<p id="first_and_forem">First and foremost, I must thank my wife Nora, not least for being the first to say “Hey, you should turn those tutorials into a book.”  Without her support and encouragement, this project never would have happened.</p> 
<p id="thanks_also_to_">Thanks also to 

<a class="ulink" href="http://wehavenoart.net" target="_top">Rosten Woo</a>, with whom I collaborated on my first D3 project, for reaching out and giving me a reason to finally dig into this new tool.  Thanks to 

<a class="ulink" href="http://golike.com" target="_top">Joe Golike</a> for several early D3 debugging sessions around that time, and to 

<a class="ulink" href="http://www.datatelling.com" target="_top">Jen Lowe</a> and 

<a class="ulink" href="http://postarchitectural.com" target="_top">Sha Hwang</a> for their reviews and feedback on the initial tutorials.</p> 
<p id="i_am_extremely_">I am extremely grateful to 

<a class="ulink" href="http://reas.com" target="_top">Casey Reas</a>, 

<a class="ulink" href="http://www.shiffman.net" target="_top">Dan Shiffman</a>, 

<a class="ulink" href="http://thefactoryfactory.com" target="_top">Joshua Noble</a>, and 

<a class="ulink" href="http://complexdiagrams.com" target="_top">Noah Iliinsky</a>—not just for offering advice on the book-creation process, but also for their groundbreaking work in the spheres of art, design, code, and data.  Their careers have greatly influenced my own.</p> 
<p id="in_that_vein_i">In that vein, I should also thank Jan Kubasiewicz at MassArt’s 

<a class="ulink" href="http://www.dynamicmediainstitute.org" target="_top">Dynamic Media Institute</a>.  Back in 2007, Jan encouraged me to check out something called 

<a class="ulink" href="http://processing.org" target="_top">Processing</a>, which eventually led me to a whole new career in code-driven arts, data visualization, and now this book.</p> 
<p id="it_has_been_a_p">It has been a pleasure working with my editor, Meghan Blanchette, and everyone else on the team at O’Reilly.  Thanks to Meghan and her crew for shepherding this project all the way through, from concept to an actual, physical, chunk of paper with words and strange diagrams printed on it.</p> 
<p id="special_thanks_">Special thanks to 

<a class="ulink" href="http://bost.ocks.org/mike/" target="_top">Mike Bostock</a>, 

<a class="ulink" href="http://www.datatelling.com" target="_top">Jen Lowe</a>, 

<a class="ulink" href="http://anna.ps" target="_top">Anna Powell-Smith</a>, and 

<a class="ulink" href="http://codenoobcentral.tumblr.com" target="_top">Daisy Vincent</a> for agreeing to tech review the book and sending incredibly valuable feedback.  The final product is vastly improved, thanks to their input.  That said, if you find an error or confusing code example, it is because they begged me to rewrite it, and I steadfastly refused.</p> 
<p id="mike_gets_an_ex">Mike gets an extra-special thanks for developing D3 in the first place.  Without this elegant piece of software, the community of data visualization practitioners wouldn’t be quite as vibrant, enthusiastic, and standards-compliant as it is today.</p> 
<p id="speaking_of_com">Speaking of community, many other people—including 

<a class="ulink" href="http://www.jeromecukier.net" target="_top">Jérôme Cukier</a>, 

<a class="ulink" href="http://www.ghostweather.com" target="_top">Lynn Cherny</a>, 

<a class="ulink" href="http://www.jasondavies.com" target="_top">Jason Davies</a>, 

<a class="ulink" href="http://hci.stanford.edu/jheer/" target="_top">Jeff Heer</a>, 

<a class="ulink" href="http://moebio.com" target="_top">Santiago Ortiz</a>, 

<a class="ulink" href="http://periscopic.com" target="_top">Kim Rees</a>, 

<a class="ulink" href="http://moritz.stefaner.eu" target="_top">Moritz Stefaner</a>, 

<a class="ulink" href="http://tulpinteractive.com" target="_top">Jan Willem Tulp</a>, and others who I have forgotten to mention—on the D3 list and in nearby orbits have also directly contributed to my thinking and process.  Thank you for your support.  I am lucky to get to collaborate with so many talented people.</p>
<section class="chapter" data-original-filename="1_intro.asciidoc" id="introduction">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 1. Introduction</h1></div></div></div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_why_data_visualization"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Why Data Visualization?</h2></div></div></div> 
<p id="our_information">Our information age more often feels like an era of information overload. Excess amounts of information are overwhelming; raw data becomes useful only when we apply methods of deriving insight from it.</p> 
<p id="fortunately_we_id1">Fortunately, we humans are intensely visual creatures. Few of us can detect patterns among rows of numbers, but even young children can interpret bar charts, extracting meaning from those numbers’ visual representations. For that reason, data visualization is a powerful exercise. Visualizing data is the fastest way to communicate it to others.</p> 
<p id="of_course_visu">Of course, visualizations, like words, can be used to lie, mislead, or distort the truth. But when practiced honestly and with care, the process of visualization can help us see the world in a new way, revealing unexpected patterns and trends in the otherwise hidden information around us. At its best, data visualization is expert storytelling.</p> 
<p id="more_literally">More literally, visualization is a process of 
<span class="emphasis">
<em>mapping</em></span> information to visuals. We craft rules that interpret data and express its values as visual properties. For example, the humble bar chart in 

<a class="xref" href="#data_values_mapped_to_visuals" title="Figure 1-1. Data values mapped to visuals">Figure 1-1</a> is generated from a very simple rule: larger values are 
<span class="emphasis">
<em>mapped</em></span> as taller bars.

<a id="id483388" class="indexterm"></a></p> 
<div class="figure" id="data_values_mapped_to_visuals"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0101.png" alt="Data values mapped to visuals"></div></div> 
<div class="figure-title">Figure 1-1. Data values mapped to visuals</div> </div> 
<p id="more_complex_vi">More complex visualizations are generated from datasets more complex than the sequence of numbers shown in 

<a class="xref" href="#data_values_mapped_to_visuals" title="Figure 1-1. Data values mapped to visuals">Figure 1-1</a> and more complex sets of mapping rules.</p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_why_write_code"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Why Write Code?</h2></div></div></div> 
<p id="mapping_data_by">Mapping data by hand can be satisfying, yet is slow and tedious. So we usually employ the power of computation to speed things up. The increased speed enables us to work with much larger datasets of thousands or millions of values; what would have taken years of effort by hand can be mapped in a moment. Just as important, we can rapidly experiment with 
<span class="emphasis">
<em>alternate mappings</em></span>, tweaking our rules and seeing their output re-rendered immediately. This loop of write/render/evaluate is critical to the iterative process of refining a design.

<a id="id483437" class="indexterm"></a></p> 
<p id="sets_of_mapping">Sets of mapping rules function as 
<span class="emphasis">
<em>design systems</em></span>. The human hand no longer executes the visual output; the computer does. Our human role is to conceptualize, craft, and write out the rules of the system, which is then finally executed by software.

<a id="id483453" class="indexterm"></a>

<a id="id483458" class="indexterm"></a></p> 
<p id="unfortunately_">Unfortunately, software (and computation generally) is extremely bad at understanding what, exactly, people want. (To be fair, many humans are also not good at this challenging task.) Because computers are binary systems, everything is either on or off, yes or no, this or that, there or not there. Humans are mushier, softer creatures, and the computers are not willing to meet us halfway—we must go to them. Hence the inevitable struggle of learning to write software, in which we train ourselves to communicate in the very limited and precise syntax that the computer can understand.</p> 
<p id="yet_we_continue">Yet we continue to write code because seeing our visual creations come to life is so rewarding. We practice data visualization because it is exciting to see what has never before been seen. It is like summoning a magical, visual genie out of an inscrutable data bottle.

<a id="id483484" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_why_interactive"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Why Interactive?</h2></div></div></div> 
<p id="static_visualiz">Static visualizations can offer only precomposed “views” of data, so multiple static views are often needed to present a variety of perspectives on the same information. The number of dimensions of data are limited, too, when all visual elements must be present on the same surface at the same time. Representing multidimensional datasets fairly in static images is notoriously difficult. A fixed image is ideal when alternate views are neither needed nor desired, and required when publishing to a static medium, such as print.

<a id="id483509" class="indexterm"></a>

<a id="id483517" class="indexterm"></a></p> 
<p id="dynamic_intera">Dynamic, interactive visualizations can empower people to explore the data for themselves. The basic functions of most interactive visualization tools have changed little since 1996, when Ben Shneiderman of the University of Maryland first proposed a “Visual Information-Seeking Mantra”: 
<span class="emphasis">
<em>overview first, zoom and filter, then details-on-demand.</em></span></p> 
<p id="this_design_pat">This design pattern is found in most interactive visualizations today. The combination of functions is successful, because it makes the data accessible to different audiences, from those who are merely browsing or exploring the dataset to those who approach the visualization with a specific question in search of an answer. An interactive visualization that offers an overview of the data alongside tools for “drilling down” into the details may successfully fulfill many roles at once, addressing the different concerns of different audiences, from those new to the subject matter to those already deeply familiar with the data.</p> 
<p id="of_course_inte">Of course, interactivity can also encourage engagement with the data in ways that static images cannot. With animated transitions and well-crafted interfaces, some visualizations can make exploring data feel more like playing a game. Interactive visualization can be a great medium for engaging an audience who might not otherwise care about the topic or data at hand.</p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_why_on_the_web"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Why on the Web?</h2></div></div></div> 
<p id="visualizations_">Visualizations aren’t truly visual unless they are 
<span class="emphasis">
<em>seen</em></span>. Getting your work out there for others to see is critical, and publishing on the Web is the quickest way to reach a global audience.  Working with web-standard technologies means that your work can be seen and experienced by anyone using a recent web browser, regardless of the operating system (Windows, Mac, Linux) and device type (laptop, desktop, smartphone, tablet).

<a id="id483578" class="indexterm"></a>

<a id="id483585" class="indexterm"></a></p> 
<p id="best_of_all_ev">Best of all, everything covered in this book can be done with freely accessible tools, so the only investment required is your time. And everything we’ll talk about uses open source, web-standard technologies.</p> 
<p id="by_avoiding_pro">By avoiding proprietary software and plug-ins, you can ensure that your projects are accessible on the widest possible range of devices, from typical desktop computers to tablets and even phones. The more accessible your visualization, the greater your audience and your impact.</p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_what_this_book_is"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">What This Book Is</h2></div></div></div> 
<p id="this_book_is_a_">This book is a practical introduction to merging three practices—data visualization, interactive design, and web development—using D3, a powerful tool for custom, web-based visualization.

<a id="id483620" class="indexterm"></a></p> 
<p id="these_chapters_">These chapters grew out of my own process of learning how to use D3. Many people, including myself, come to D3 with backgrounds in design, mapping, and data visualization, but not programming and computer science.</p> 
<p id="d_has_a_bit_of">D3 has a bit of an unfair reputation for being hard to learn. D3 itself is not so complicated, but it operates in the domain of the Web, and the Web 
<span class="emphasis">
<em>is</em></span> complicated. Using D3 comfortably requires some prior knowledge of the web technologies with which it interacts, such as HTML, CSS, JavaScript, and SVG. Many people (myself included) are self-taught when it comes to web skills. This is great, because the barrier to entry is so low, but problematic because it means we probably didn’t learn each of these technologies from the ground up—more often, we just hack something together until it seems to work, and call it a day. Yet successful use of D3 requires understanding some of these technologies in a fundamental way.</p> 
<p id="because_d_is_w">Because D3 is written in JavaScript, learning to use D3 often means learning a lot about JavaScript. For many datavis folks, D3 
<span class="emphasis">
<em>is</em></span> their introduction to JavaScript (or even web development generally). It’s hard enough to learn a new programming language, let alone a new tool built on that language. D3 will enable you to do great things with JavaScript that you never would have even attempted. The time you spend learning both the language and the tool will provide an incredible payoff.

<a id="id483666" class="indexterm"></a></p> 
<p id="my_goal_is_to_r">My goal is to reduce that learning time, so you can start creating awesome stuff sooner. We’ll take a ground-up approach, starting with the fundamental concepts and gradually adding complexity. I don’t intend to show you how to make specific kinds of visualizations so much as to help you understand the workings of D3 well enough to take those building blocks and generate designs of your own creation.</p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_who_you_are"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Who You Are</h2></div></div></div> 
<p id="you_may_be_an_a">You may be an absolute beginner, someone new to datavis, web development, or both. (Welcome!) Perhaps you are a journalist interested in new ways to communicate the data you collect during reporting. Or maybe you’re a designer, comfortable drawing static infographics but ready to make the leap to interactive projects on the Web. You could be an artist, interested in generative, data-based art. Or a programmer, already familiar with JavaScript and the Web, but excited to learn a new tool and pick up some visual design experience along the way.

<a id="id483705" class="indexterm"></a></p> 
<p id="whoever_you_are">Whoever you are, I hope that you:</p> 
<div class="itemizedlist" id="have_heard_of_t_id1">
<ul class="itemizedlist"> 
<li class="listitem"> Have heard of this new thing called the “World Wide Web” </li> 
<li class="listitem"> Are a bit familiar with HTML, the DOM, and CSS </li> 
<li class="listitem"> Might even have a little programming experience already </li> 
<li class="listitem"> Have heard of jQuery or written some JavaScript before </li> 
<li class="listitem"> Aren’t scared by unknown initialisms like CSV, SVG, or JSON </li> 
<li class="listitem"> Want to make useful, interactive visualizations </li> </ul></div> 
<p id="if_any_of_those">If any of those things are unknown or unclear, don’t fear. You might just want to spend more time with 

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>, which covers what you really need to know before diving into D3.</p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_what_this_book_is_not"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">What This Book Is Not</h2></div></div></div> 
<p id="that_said_this">That said, this is definitely not a computer science textbook, and it is not intended to teach the intricacies of any one web technology (HTML, CSS, JavaScript, SVG) in depth.</p> 
<p id="in_that_spirit">In that spirit, I might gloss over some technical points, grossly oversimplifying important concepts fundamental to computer science in ways that will make true software engineers recoil. That’s fine, because I’m writing for artists and designers here, not engineers. We’ll cover the basics, and then you can dive into the more complex pieces once you’re comfortable.</p> 
<p id="i_will_delibera">I will deliberately 
<span class="emphasis">
<em>not</em></span> address every possible approach to a given problem, but will typically present what I feel is the simplest solution, or, if not the simplest, then the most understandable.</p> 
<p id="my_goal_is_to_t">My goal is to teach you the fundamental concepts and methods of D3.  As such, this book is decidedly 
<span class="emphasis">
<em>not</em></span> organized around specific example projects.  Everyone’s data and design needs will be different.  It’s up to you to integrate these concepts in the way best suited to your particular project.</p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_using_sample_code"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Using Sample Code</h2></div></div></div> 
<p id="if_you_are_a_ma">If you are a mad genius, then you can probably learn to use D3 without ever looking at any sample code files, in which case you can skip the rest of this section.

<a id="id483824" class="indexterm"></a></p> 
<p id="if_youre_still">If you’re still with me, you are probably still very bright but not mad, in which case you should undertake this book with the full set of accompanying code samples in hand.  Before you go any further, please download the sample files from 

<a class="ulink" href="http://bit.ly/V25Xw6" target="_top">GitHub</a>.</p> 
<p id="normal_people_w">Normal people will want to click the ZIP link to download a compressed ZIP archive with all the files.  Hardcore geeksters will want to clone the repository using Git. If that last sentence sounds like total gibberish, please use the first option.</p> 
<p id="within_the_down">Within the download, you’ll notice there is a folder for each chapter that has code to go with it:</p> 
<pre class="screen" id="chapter__chap">chapter_04 chapter_05 chapter_06 chapter_07 chapter_08 …</pre> 
<p id="files_are_organ">Files are organized by chapter, so in 

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a> when I reference 
<span class="emphasis">
<em>01_bar_chart.html</em></span>, know that you can find that file in the corresponding location: 
<span class="emphasis">
<em>d3-book/chapter_9/01_bar_chart.html</em></span>.</p> 
<p id="you_are_welcome">You are welcome to copy, adapt, modify, and reuse the example code in these tutorials for any noncommercial purpose.</p> </div> 
<div class="sect1" data-original-filename="1_intro.asciidoc" id="_thank_you"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Thank You</h2></div></div></div> 
<p id="finally_this_b">Finally, this book has been handcrafted, carefully written, and pedagogically fine-tuned for maximum effect. Thank you for reading it. I hope you learn a great deal, and even have some fun along the way.</p>
<section class="chapter" data-original-filename="2_introducing_d3.asciidoc" id="_introducing_d3">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 2. Introducing D3</h1></div></div></div> 
<p id="dalso_referre">D3—also referred to as D
<sup>3</sup> or d3.js—is a JavaScript library for creating data visualizations. But that kind of undersells it.

<a id="id483913" class="indexterm"></a></p> 
<p id="the_abbreviatio">The abbreviation D3 references the tool’s full name, 
<span class="emphasis">
<em>Data-Driven Documents</em></span>. The 
<span class="emphasis">
<em>data</em></span> is provided by you, and the 
<span class="emphasis">
<em>documents</em></span> are web-based documents, meaning anything that can be rendered by a web browser, such as HTML and SVG. D3 does the 
<span class="emphasis">
<em>driving</em></span>, in the sense that it connects the data to the documents.

<a id="id483940" class="indexterm"></a>

<a id="id483948" class="indexterm"></a></p> 
<p id="of_course_the_">Of course, the name also functions as a clever allusion to the network of technologies underlying the tool itself: the W3, or World Wide Web, or, today, simply “the Web.”</p> 
<p id="ds_primary_au">D3’s primary author is the brilliant 

<a class="ulink" href="http://bost.ocks.org/mike/" target="_top">Mike Bostock</a>, although there are a few other dedicated contributors. The project is entirely open source and freely available on

<a id="id483971" class="indexterm"></a> 

<a class="ulink" href="https://github.com/mbostock/d3/" target="_top">GitHub</a>.</p> 
<p id="d_is_released_">D3 is released under a BSD license, so you may use, modify, and adapt the code for noncommercial or commercial use at no cost.</p> 
<p id="ds_official_h">D3’s official home on the Web is 

<a class="ulink" href="http://www.d3js.org/" target="_top">
<span class="emphasis">
<em>d3js.org</em></span></a>.</p> 
<div class="sect1" data-original-filename="2_introducing_d3.asciidoc" id="_what_it_does"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">What It Does</h2></div></div></div> 
<p id="fundamentally_">Fundamentally, D3 is an elegant piece of software that facilitates

<a id="id484016" class="indexterm"></a> generation and manipulation of web documents with data. It does this by:</p> 
<div class="itemizedlist" id="loading_data_in_id1">
<ul class="itemizedlist"> 
<li class="listitem"> 
<span class="emphasis">
<em>Loading</em></span> data into the browser’s memory </li> 
<li class="listitem"> 
<span class="emphasis">
<em>Binding</em></span> data to elements within the document, creating new elements as needed </li> </ul></div> 
<div class="itemizedlist" id="transforming_th_id1">
<ul class="itemizedlist"> 
<li class="listitem"> 
<span class="emphasis">
<em>Transforming</em></span> those elements by interpreting each element’s bound datum and setting its visual properties accordingly </li> 
<li class="listitem"> 
<span class="emphasis">
<em>Transitioning</em></span> elements between states in response to user input </li> </ul></div> 
<p id="learning_to_use">Learning to use D3 is simply a process of learning the syntax used to tell it how you want it to load and bind data, and transform and transition elements.</p> 
<p id="the_transformat">The 
<span class="emphasis">
<em>transformation</em></span> step is most important, as this is where the 
<span class="emphasis">
<em>mapping</em></span> happens. D3 provides a structure for applying these transformations, but, as we’ll see, you define the mapping rules. Should larger values make taller bars or brighter circles? Will clusters be sorted on the x-axis by age or category? What color palette is used to fill in countries on your world map? All of the visual design decisions are up to you. You provide the concept, you craft the rules, and D3 executes it—without telling you what to do. (Yes, it’s like the opposite of Excel’s pushy “Chart Wizard.”)

<a id="id484092" class="indexterm"></a>

<a id="id484099" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="2_introducing_d3.asciidoc" id="_what_it_doesn_t_do"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">What It Doesn’t Do</h2></div></div></div> 
<p id="here_is_a_list_">Here is a list of things D3 does not do:</p> 
<div class="itemizedlist" id="d_doesnt_gene_id1">
<ul class="itemizedlist"> 
<li class="listitem"> D3 doesn’t generate predefined or “canned” visualizations for you. This is on purpose.  D3 is intended primarily for 
<span class="emphasis">
<em>explanatory</em></span> visualization work, as opposed to 
<span class="emphasis">
<em>exploratory</em></span> visualizations.  Exploratory tools help you discover significant, meaningful patterns in data.  These are tools like 

<a class="ulink" href="http://bit.ly/13KrhFH" target="_top">Tableau</a> and 

<a class="ulink" href="http://ggplot2.org/" target="_top">ggplot2</a>, which help you quickly generate multiple views on the same data set.  That’s an essential step, but different from generating an 
<span class="emphasis">
<em>explanatory</em></span> presentation of the data, a view of the data that highlights what you’ve already discovered.  Explanatory views are more constrained and limited, but also focused, and designed to communicate only the important points.  D3 excels at this latter step, but is not ideal for the former.  (For ideas on other tools, see the section 

<a class="xref" href="#alternatives_2" title="Alternatives">“Alternatives”</a> later in this chapter.)

<a id="id484160" class="indexterm"></a>

<a id="id484167" class="indexterm"></a> </li> 
<li class="listitem"> D3 doesn’t even try to support older browsers. This helps keep the D3 codebase clean and free of hacks to support old versions of Internet Explorer, for example. The philosophy is that by creating more compelling tools and refusing to support older browsers, we encourage more people to upgrade (rather than forestall the process, thereby requiring us to continue to support those browsers, and so on—a vicious cycle). D3 wants us to move forward.

<a id="id484184" class="indexterm"></a>

<a id="id484191" class="indexterm"></a> </li> 
<li class="listitem"> D3’s core functionality doesn’t handle bitmap map tiles, such as those provided by Google Maps or Cloudmade. D3 is great with anything vector—SVG images or GeoJSON data—but wasn’t originally intended to work with traditional map tiles. (
<span class="emphasis">
<em>Bitmap</em></span> images are made up of pixels, so resizing them larger or smaller is difficult without a loss in quality.  
<span class="emphasis">
<em>Vector</em></span> images are defined by points, lines, and curves—mathematical equations, really—and can be scaled up or down without a loss in quality.)  This is starting to change, with the introduction of the 

<a class="ulink" href="http://bit.ly/W8L18u" target="_top">d3.geo.tile plug-in</a>.  Prior to this plug-in, geomapping with D3 meant either going all-SVG and avoiding tiles or using D3 to create SVG visuals 
<span class="emphasis">
<em>on top of</em></span> a base layer of map tiles (which would be managed by another library, like Leaflet or Polymaps—see the section 

<a class="xref" href="#alternatives_2" title="Alternatives">“Alternatives”</a> later in this chapter).  This question of how to integrate bitmap tiles and vector graphics comes up a lot in the D3 community.  As of today, there is no super-simple and perfect answer, but I think you can expect to see lots of work done in this area, and possibly the new tile-handling methods integrated into the D3 core at some point in the future.

<a id="id484239" class="indexterm"></a>

<a id="id484246" class="indexterm"></a>

<a id="id484254" class="indexterm"></a>

<a id="id484259" class="indexterm"></a>

<a id="id484264" class="indexterm"></a>

<a id="id484269" class="indexterm"></a>

<a id="id484274" class="indexterm"></a> </li> 
<li class="listitem"> D3 doesn’t hide your original data. Because D3 code is executed on the client side (meaning, in the user’s web browser, as opposed to on the web server), the data you want visualized must be sent to the client. If your data can’t be shared, then don’t use D3. Alternatives include using proprietary tools (like Flash) or prerendering visualizations as static images and sending those to the browser. (If you’re not interested in sharing your data, though, why would you bother visualizing it? The purpose of visualization is to communicate the data, so you might sleep better at night by choosing openness and transparency, rather than having nightmares about 

<a class="ulink" href="http://www.datathief.org/" target="_top">data thieves</a>.)

<a id="id484305" class="indexterm"></a>

<a id="id484310" class="indexterm"></a> </li> </ul></div> </div> 
<div class="sect1" data-original-filename="2_introducing_d3.asciidoc" id="_origins_and_context"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Origins and Context</h2></div></div></div> 
<p id="the_first_web_b">The first web browsers rendered static pages; interactivity was limited to clicking links. In 1996, Netscape introduced the first browser with JavaScript, a new scripting language that could be interpreted 
<span class="emphasis">
<em>by the browser while the page was being viewed</em></span>.

<a id="id484335" class="indexterm"></a></p> 
<p id="this_doesnt_so">This doesn’t sound as groundbreaking as it turned out to be, but this enabled web browsers to evolve from merely passive 
<span class="emphasis">
<em>browsers</em></span> to dynamic frames for interactive, networked experiences. This shift ultimately enabled every intrapage interaction we have on the Web today. Without JavaScript, D3 would never exist, and web-based data visualizations would be limited to prerendered, noninteractive GIFs. (Yuck. Thank you, Netscape!)

<a id="id484355" class="indexterm"></a>

<a id="id484362" class="indexterm"></a></p> 
<p id="jump_ahead_to_">Jump ahead to 2005, when Jeffrey Heer, Stuart Card, and James Landay introduced 

<a class="ulink" href="http://prefuse.org/" target="_top">prefuse</a>, a toolkit for bringing data visualization to the Web. prefuse (spelled with all lowercase letters) was written in Java, a compiled language, with programs that could run in web browsers via a Java plug-in.  (Note that 
<span class="emphasis">
<em>Java</em></span> is a completely different programming language than 
<span class="emphasis">
<em>JavaScript</em></span>, despite their similar names.)

<a id="id484388" class="indexterm"></a>

<a id="id484393" class="indexterm"></a>

<a id="id484398" class="indexterm"></a>

<a id="id484404" class="indexterm"></a>

<a id="id484409" class="indexterm"></a></p> 
<p id="prefuse_was_a_b">prefuse was a breakthrough application—the first to make web-based visualization accessible to less-than-expert programmers. Until prefuse came along, any datavis on the Web was very much a custom affair.</p> 
<p id="two_years_later">Two years later, Jeff Heer introduced 

<a class="ulink" href="http://flare.prefuse.org/" target="_top">Flare</a>, a similar toolkit, but written in ActionScript, so its visualizations could be viewed on the Web through Adobe’s Flash Player. Flare, like prefuse, relied on a browser plug-in.  Flare was a huge improvement, but as web browsers continued to evolve, it was clear that visualizations could be created with native browser technology, no plug-ins required.

<a id="id484439" class="indexterm"></a>

<a id="id484445" class="indexterm"></a></p> 
<p id="by__jeff_h">By 2009, Jeff Heer had moved to Stanford, where he was advising a graduate student named Michael Bostock. Together, in Stanford’s Vis Group, they created 

<a class="ulink" href="http://mbostock.github.com/protovis/" target="_top">Protovis</a>, a JavaScript-based visualization toolkit that relied 
<span class="keep-together">exclusively</span> on native browser technologies. (If you have used Protovis, be sure to reference Mike’s 

<a class="ulink" href="http://bit.ly/XxebvX" target="_top">introduction to D3 for Protovis users</a>.)

<a id="id484474" class="indexterm"></a>

<a id="id484479" class="indexterm"></a></p> 
<p id="protovis_made_g">Protovis made generating visualizations simple, even for users without prior programming experience. Yet to achieve this, it created an abstract representation layer. The designer could address this layer using Protovis syntax, but it wasn’t accessible through standard methods, so debugging was difficult.</p> 
<p id="in__mike_b">In 2011, Mike Bostock, Vadim Ogievetsky, and Jeff Heer 

<a class="ulink" href="http://vis.stanford.edu/papers/d3" target="_top">officially announced D3</a>, the next evolution in web visualization tools. Unlike Protovis, D3 operates directly on the web document itself. This means easier debugging, easier experimentation, and more visual possibilities.  The only downside to this approach is a potentially steeper learning curve, but this book will make that as painless as possible.  Plus, all the skills you gain while learning about D3 will prove useful even beyond the realm of datavis.

<a id="id484507" class="indexterm"></a>

<a id="id484512" class="indexterm"></a></p> 
<p id="if_youre_famil_id1">If you’re familiar with any of these groundbreaking tools, you’ll appreciate that D3 descends from a prestigious lineage. And if you have any interest in the philosophy underlying D3’s elegant technical design, I highly recommend Mike, Vadim, and Jeff’s 

<a class="ulink" href="http://vis.stanford.edu/files/2011-D3-InfoVis.pdf" target="_top">InfoVis paper</a>, which clearly articulates the need for this kind of tool. The paper encapsulates years’ worth of learning and insights made while developing visualization tools.

<a id="id484536" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="2_introducing_d3.asciidoc" id="alternatives_2"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Alternatives</h2></div></div></div> 
<p id="d_might_not_be">D3 might not be perfect for every project. Sometimes you just need a quick chart and you don’t have time to code it from scratch. Or you might need to support older browsers and can’t rely on recent technologies like SVG.

<a id="ix_D3alttools" class="indexterm"></a>

<a id="ix_alttools" class="indexterm"></a></p> 
<p id="for_those_situa">For those situations, it’s good to know what other tools are out there. Here is a brief, noncomprehensive list of D3 alternatives, all of which use web-standard technologies (mostly JavaScript) and are free to download and use.</p> 
<div class="sect2" id="_easy_charts"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Easy Charts</h3></div></div></div> 
<div class="variablelist" id="datawrapper_a_b">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://datawrapper.de" target="_top">DataWrapper</a> </span></dt> 
<dd> A beautiful web service that lets you upload your data and quickly generate a chart that you can republish elsewhere or embed on your site. This service was originally intended for journalists, but it is helpful for everyone.  DataWrapper displays interactive charts in current browsers and static images for old ones.  (Brilliant!)  You can also download all the code and run it on your own server instead of using theirs.

<a id="id484612" class="indexterm"></a> </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://www.flotcharts.org/" target="_top">Flot</a> </span></dt> 
<dd> A plotting library for jQuery that uses the HTML canvas element and supports older browsers, even all the way back to Internet Explorer 6. It supports limited visual forms (lines, points, bars, areas), but it is easy to use. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://developers.google.com/chart/" target="_top">Google Chart Tools</a> </span></dt> 
<dd> Having evolved from their earlier 

<a class="ulink" href="https://developers.google.com/chart/image/" target="_top">Image Charts API</a>, Google’s Chart Tools can be used to generate several standard chart types, with support for old versions of IE. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://g.raphaeljs.com/" target="_top">gRaphaël</a> </span></dt> 
<dd> A charting library based on Raphaël (see later in this chapter) that supports older browsers, including IE6.  It has more visual flexibility than Flot, and—some might say—it is prettier. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://www.highcharts.com/" target="_top">Highcharts JS</a> </span></dt> 
<dd> A JavaScript-based charting library with several predesigned themes and chart types. It uses SVG for modern browsers and 

<a class="ulink" href="http://www.highcharts.com/documentation/compatibility" target="_top">falls back on VML</a> for old versions of IE, including IE6 and later. The tool is free only for noncommercial use. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://thejit.org/" target="_top">JavaScript InfoVis Toolkit</a> </span></dt> 
<dd> The JIT provides several preset visualization styles for your data.  It includes lots of examples, but the documentation is pretty technical.  The toolkit is great if you like one of the preset styles, but browser support is unclear. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://www.jqplot.com/" target="_top">jqPlot</a> </span></dt> 
<dd> A plug-in for charting with jQuery. This supports very simple charts and is great if you are okay with the predefined styles.  jqPlot supports IE7 and newer. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://omnipotent.net/jquery.sparkline/" target="_top">jQuery Sparklines</a> </span></dt> 
<dd> A jQuery plug-in for generating sparklines, typically small bar, line, or area charts used inline with text. Supports most browsers, even back to IE6. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://benpickles.github.com/peity/" target="_top">Peity</a> </span></dt> 
<dd> A jQuery plug-in for very simple and very 
<span class="emphasis">
<em>tiny</em></span> bar, line, and pie charts that supports only recent browsers.  Did I mention that this makes only very 
<span class="emphasis">
<em>tiny</em></span> visualizations? +10 cuteness points. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://timeline.verite.co/" target="_top">Timeline.js</a> </span></dt> 
<dd> A library specifically for generating interactive timelines.  No coding is required; just use the code generator.  There is not much room for customization, but hey, timelines are really hard to do well.  Timeline.js supports only IE8 and newer. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://yuilibrary.com/yui/docs/charts/" target="_top">YUI Charts</a> </span></dt> 
<dd> The Charts module for the Yahoo! User Interface Library enables creation of simple charts with a goal of wide browser support. </dd> </dl></div> </div> 
<div class="sect2" id="_graph_visualizations"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Graph Visualizations</h3></div></div></div> 
<p id="a_graph_is_ju">A “graph” is just data with a networked structure (for example, B is connected to A, and A is connected to C).

<a id="id484804" class="indexterm"></a></p> 
<div class="variablelist" id="arborjs_a_libr">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://arborjs.org/" target="_top">Arbor.js</a> </span></dt> 
<dd> A library for graph visualization using jQuery.  Even if you never use this, you should check out how the documentation is presented as a graph, using the tool itself.  (It’s so 
<span class="emphasis">
<em>meta</em></span>.)  It uses the HTML canvas, so it works only in IE9 or current browsers, although some workarounds are available. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://sigmajs.org/" target="_top">Sigma.js</a> </span></dt> 
<dd> A very lightweight library for graph visualization.  You have to visit this website, move your mouse over the header graphic, and then play with the demos.  Sigma.js is beautiful and fast, and it also uses canvas. </dd> </dl></div> </div> 
<div class="sect2" id="_geomapping"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Geomapping</h3></div></div></div> 
<p id="i_distinguish_b">I distinguish between 
<span class="emphasis">
<em>mapping</em></span> (all visualizations are maps) and 
<span class="emphasis">
<em>geomapping</em></span> (visualizations that include geographic data, or geodata, such as traditional maps). D3 has a lot of geomapping functionality, but you should know about these other tools.

<a id="id484868" class="indexterm"></a></p> 
<div class="variablelist" id="kartograph_a_ja">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://kartograph.org/" target="_top">Kartograph</a> </span></dt> 
<dd> A JavaScript-and-Python combo for gorgeous, entirely vector-based mapping by Gregor Aisch with must-see demos.  Please go look at them now.  I promise you’ve never seen online maps this beautiful.  Kartograph works with IE7 and newer. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://leaflet.cloudmade.com/" target="_top">Leaflet</a> </span></dt> 
<dd> A library for tiled maps, designed for smooth interaction on both desktop and mobile devices. It includes some support for displaying data layers of SVG on top </dd> </dl></div> 
<p id="of_the_map_tile">of the map tiles. (See Mike’s demo 

<a class="ulink" href="http://bost.ocks.org/mike/leaflet/" target="_top">“Using D3 with Leaflet”</a>.)  Leaflet works with IE6 (barely) or IE7 (better!) and of course all current browsers.</p> 
<div class="variablelist" id="modest_maps_the">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://modestmaps.com/" target="_top">Modest Maps</a> </span></dt> 
<dd> The granddaddy of tiled map libraries, Modest Maps has been succeeded by Polymaps, but lots of people still love it, as it is lightweight and works with old versions of IE and other browsers.  Modest Maps has been adapted for ActionScript, Processing, Python, PHP, Cinder, openFrameworks…yeah, basically everything.  File this under “oldie, but goodie.” </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://polymaps.org/" target="_top">Polymaps</a> </span></dt> 
<dd> A library for displaying tiled maps, with layers of data on top of the tiles.  Polymaps relies on SVG and thus works best with current browsers. </dd> </dl></div> </div> 
<div class="sect2" id="_almost_from_scratch"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Almost from Scratch</h3></div></div></div> 
<p id="these_tools_li">These tools, like D3, provide methods of drawing visual forms, but without predesigned visual templates. If you enjoy the creative freedom of starting from scratch, you might enjoy these.

<a id="id484972" class="indexterm"></a></p> 
<div class="variablelist" id="processingjs_a">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://processingjs.org/" target="_top">Processing.js</a> </span></dt> 
<dd> A native JavaScript implementation of 

<a class="ulink" href="http://processing.org/" target="_top">Processing</a>, the fantastic programming language for artists and designers new to programming. Processing is written in Java, so exporting Processing sketches to the Web traditionally involved clunky Java applets. Thanks to Processing.js, regular Processing code can run natively, in the browser. It renders using canvas, so only modern browsers are supported. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://paperjs.org/" target="_top">Paper.js</a> </span></dt> 
<dd> A framework for rendering vector graphics to canvas. Also, its website is one of the most beautiful on the Internet, and their demos are unbelievable. (Go play with them now.) </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://raphaeljs.com/" target="_top">Raphaël</a> </span></dt> 
<dd> Another library for drawing vector graphics, popular due to its friendly syntax and support for older browsers. </dd> </dl></div> </div> 
<div class="sect2" id="_three_dimensional"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Three-Dimensional</h3></div></div></div> 
<p id="d_is_not_the_b">D3 is not the best at 3D, simply because web browsers are historically two-dimensional beasts. But with increased support for WebGL, there are now more opportunities for 3D web experiences.

<a id="id485046" class="indexterm"></a></p> 
<div class="variablelist" id="philogl_a_webgl">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://www.senchalabs.org/philogl/" target="_top">PhiloGL</a> </span></dt> 
<dd> A WebGL framework specifically for 3D visualization. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://mrdoob.github.com/three.js/" target="_top">Three.js</a> </span></dt> 
<dd> A library for generating any sort of 3D scene you could imagine, produced by Google’s Data Arts team. You could spend all day exploring the mind-blowing demos on their site. </dd> </dl></div> </div> 
<div class="sect2" id="_tools_built_with_d3"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Tools Built with D3</h3></div></div></div> 
<p id="when_you_want_t">When you want to use D3 without actually writing any D3 code, you can choose one of the many tools built on top of D3!</p> 
<div class="variablelist" id="crossfilter_a_l">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://square.github.com/crossfilter/" target="_top">Crossfilter</a> </span></dt> 
<dd> A library for working with large, multivariate datasets, written primarily by Mike Bostock.  This is useful for trying to squeeze your “big data” into a relatively small web browser. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://square.github.com/cubism/" target="_top">Cubism</a> </span></dt> 
<dd> A D3 plug-in for visualizing time series data, also written by Mike Bostock. (One of my favorite demos.) </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://dashku.com/" target="_top">Dashku</a> </span></dt> 
<dd> An online tool for data dashboards and widgets updated in real time, by Paul Jensen. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://nickqizhu.github.com/dc.js/" target="_top">dc.js</a> </span></dt> 
<dd> The “dc” is short for 
<span class="emphasis">
<em>dimensional charting</em></span>, as this library is optimized for exploring large, multidimensional datasets. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://nvd3.org" target="_top">NVD3</a> </span></dt> 
<dd> Reusable charts with D3.  NVD3 offers lots of beautiful examples, with room for visual customizations without requiring as much code as D3 alone. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://polychart.com/" target="_top">Polychart.js</a> </span></dt> 
<dd> More reusable charts, with a range of chart types available.  Polychart.js is free only for noncommercial use. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://code.shutterstock.com/rickshaw/" target="_top">Rickshaw</a> </span></dt> 
<dd> A toolkit for displaying time series data that is also very customizable. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://enjalot.com/" target="_top">Tributary</a> </span></dt> 
<dd> A great tool for experimenting with live coding using D3, by Ian Johnson.

<a id="id485224" class="indexterm"></a>

<a id="id485231" class="indexterm"></a> </dd> </dl></div> </div>
<section class="chapter" data-original-filename="3_tech_fundamentals.asciidoc" id="technology_fundamentals">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 3. Technology Fundamentals</h1></div></div></div> 
<p id="solid_familiari">Solid familiarity with the following concepts will make your time with D3 a lot less frustrating and a lot more rewarding. Consider this a brief refresher course on Web-Making 101.</p> 
<div class="warning" id="beware_this_is_id1">
<p id="beware_this_is_id2">Beware! This is a pretty dense chapter, packed with years’ worth of web development knowledge, and nothing in here is specific to D3.  I recommend skimming just the sections on information that is new to you, and skipping the rest.  You can always reference this chapter later as questions arise.</p></div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="_the_web"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">The Web</h2></div></div></div> 
<p id="if_youre_brand">If you’re brand new to making web pages, you will now have to think about things that regular people blissfully disregard every day, such as this: How does the Web actually work?

<a id="id485280" class="indexterm"></a></p> 
<p id="we_think_of_the">We think of the Web as a bunch of interlinked pages, but it’s really a collection of conversations between web servers and web clients (browsers).</p> 
<p id="the_following_s">The following scene is a dramatization of a typical such conversation that happens whenever you or anyone else clicks a link or types an address into your browser (meaning, this brief conversation is had about 88 zillion times every day):</p> 
<div class="blockquote">
<blockquote class="blockquote"> 
<p id="client_id_rea">CLIENT: I’d really like to know what’s going on over at 
<span class="emphasis">
<em>somewebsite.com</em></span>. I better call over there to get the latest info. [Silent sound of Internet connection being established.]</p> 
<p id="server_hello_">SERVER: Hello, unknown web client! I am the server hosting 
<span class="emphasis">
<em>somewebsite.com</em></span>. What page would you like?</p> 
<p id="client_this_mo">CLIENT: This morning, I am interested in the page at 
<span class="emphasis">
<em>somewebsite.com/news/</em></span>.</p> 
<p id="server_of_cour">SERVER: Of course, one moment.</p> 
<p id="code_is_transmi">
<span class="emphasis">
<em>Code is transmitted from SERVER to CLIENT.</em></span></p> 
<p id="client_i_have_">CLIENT: I have received it. Thank you!</p> 
<p id="server_youre_">SERVER: You’re welcome! Would love to stay on the line and chat, but I have other requests to process. Bye!</p> </blockquote></div> 
<p id="clients_contact">Clients contact servers with 
<span class="emphasis">
<em>requests</em></span>, and servers respond with data. But what is a server and what is a client?

<a id="id485352" class="indexterm"></a>

<a id="id485357" class="indexterm"></a>

<a id="id485365" class="indexterm"></a></p> 
<p id="web_servers_are">
<span class="emphasis">
<em>Web servers</em></span> are Internet-connected computers running server software, so called because they 
<span class="emphasis">
<em>serve</em></span> web documents as requested. Servers are typically always on and always connected, but web developers often also run 
<span class="emphasis">
<em>local</em></span> servers, meaning they run on the same computer that you’re working on. 
<span class="emphasis">
<em>Local</em></span> means here; 
<span class="emphasis">
<em>remote</em></span> means somewhere else, on any computer but the one right in front of you.

<a id="id485393" class="indexterm"></a>

<a id="id485398" class="indexterm"></a></p> 
<p id="there_are_lots_">There are lots of different server software packages, but Apache is the most common. Web server software is not pretty, and no one ever wants to look at it.

<a id="id485409" class="indexterm"></a></p> 
<p id="in_contrast_we">In contrast, web 
<span class="emphasis">
<em>browsers</em></span> can be very pretty, and we spend a lot of time looking at them. Regular people recognize names like Firefox, Safari, Chrome, and Internet Explorer, all of which are browsers or 
<span class="emphasis">
<em>web clients</em></span>.

<a id="id485426" class="indexterm"></a></p> 
<p id="every_web_page">Every web page, in theory, can be identified by its URL (Uniform Resource Locator) or URI (Uniform Resource Identifier). Most people don’t know what 
<span class="emphasis">
<em>URL</em></span> stands for, but they recognize one when they see it. By obsolete convention, URLs commonly begin with 
<span class="emphasis">
<em>www</em></span>, as in 

<a class="ulink" href="http://www.calmingmanatee.com" target="_top">http://www.calmingmanatee.com</a>, but with a properly configured server, the 
<span class="emphasis">
<em>www</em></span> part is wholly unnecessary.

<a id="id485458" class="indexterm"></a></p> 
<p id="complete_urls_c">Complete URLs consist of four parts:</p> 
<div class="itemizedlist" id="an_indication_o_id1">
<ul class="itemizedlist"> 
<li class="listitem"> An indication of the 
<span class="emphasis">
<em>communication protocol</em></span>, such as HTTP or HTTPS </li> 
<li class="listitem"> The 
<span class="emphasis">
<em>domain name</em></span> of the resource, such as 
<span class="emphasis">
<em>calmingmanatee.com</em></span> </li> 
<li class="listitem"> The 
<span class="emphasis">
<em>port number</em></span>, indicating over which port the connection to the server should be attempted </li> 
<li class="listitem"> Any additional locating information, such as the path of the requested file, or any query parameters

<a id="id485506" class="indexterm"></a>

<a id="id485511" class="indexterm"></a>

<a id="id485516" class="indexterm"></a>

<a id="id485522" class="indexterm"></a> </li> </ul></div> 
<p id="a_complete_url">A complete URL, then, might look like this: 

<a class="ulink" href="http://alignedleft.com:80/tutorials/d3/" target="_top">http://alignedleft.com:80/tutorials/d3/</a>.</p> 
<p id="typically_the_">Typically, the port number is excluded, as web browsers will try to connect over port 80 by default.  So the preceding URL is functionally the same as the following: 

<a class="ulink" href="http://alignedleft.com/tutorials/d3/" target="_top">http://alignedleft.com/tutorials/d3/</a></p> 
<p id="note_that_the_p">Note that the protocol is separated from the domain name by a colon and two forward (regular) slashes. Why two slashes? No reason. The inventor of the Web 

<a class="ulink" href="http://nyti.ms/Xaol4j" target="_top">regrets the error</a>.</p> 
<p id="http_stands_for">HTTP stands for Hypertext Transfer Protocol, and it’s the most common protocol for transferring web content from server to client. The “S” on the end of HTTPS stands for 
<span class="emphasis">
<em>Secure</em></span>. HTTPS connections are used whenever information should be encrypted in transit, such as for online banking or e-commerce.

<a id="id485569" class="indexterm"></a></p> 
<p id="lets_briefly_s">Let’s briefly step through the process of what happens when a person goes to visit a website.

<a id="id485580" class="indexterm"></a></p> 
<div class="orderedlist" id="user_runs_the_w_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> User runs the web browser of her choice, then types a URL into the address bar, such as 
<span class="emphasis">
<em>alignedleft.com/tutorials/d3/</em></span>. Because she did not specify a protocol, HTTP is assumed, and “http://” is prepended to the URL. </li> 
<li class="listitem"> The browser then attempts to connect to the server behind 
<span class="emphasis">
<em>alignedleft.com</em></span> across the network, via port 80, the default port for HTTP. </li> 
<li class="listitem"> The server associated with 
<span class="emphasis">
<em>alignedleft.com</em></span> acknowledges the connection and is taking requests. (“I’ll be here all night.”) </li> 
<li class="listitem"> The browser sends a request for the page that lives at 
<span class="emphasis">
<em>/tutorials/d3/</em></span>. </li> 
<li class="listitem"> The server sends back the HTML content for that page. </li> 
<li class="listitem"> As the client browser receives the HTML, it discovers references to 
<span class="emphasis">
<em>other files</em></span> needed to assemble and display the entire page, including CSS stylesheets and image files. So it contacts the same server again, once per file, requesting the additional information. </li> 
<li class="listitem"> The server responds, dispatching each file as needed. </li> 
<li class="listitem"> Finally, all the web documents have been transferred over. Now the client performs its most arduous task, which is to 
<span class="emphasis">
<em>render</em></span> the content. It first parses through the HTML to understand the structure of the content. Then it reviews the CSS selectors, applying any properties to matched elements. Finally, it plugs in any image files and executes any JavaScript code. </li> </ol></div> 
<p id="can_you_believe">Can you believe that all that happens every time you click a link? It’s a lot more complicated than most people realize, but it’s important to understand that client/server conversations are fundamental to the Web.</p> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="_html"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">HTML</h2></div></div></div> 
<p id="hypertext_marku">Hypertext Markup Language is used to structure content for web browsers. HTML is stored in plain text files with the 
<span class="emphasis">
<em>.html</em></span> suffix. A simple

<a id="ix_HTML" class="indexterm"></a> HTML document looks like this:</p> 
<pre class="programlisting" data-language="html" id="doctype_html_id1"><code class="cp">&lt;!DOCTYPE html&gt;</code> <code class="nt">&lt;html&gt;</code>     <code class="nt">&lt;head&gt;</code>         <code class="nt">&lt;title&gt;</code>Page Title<code class="nt">&lt;/title&gt;</code>     <code class="nt">&lt;/head&gt;</code>     <code class="nt">&lt;body&gt;</code>         <code class="nt">&lt;h1&gt;</code>Page Title<code class="nt">&lt;/h1&gt;</code>         <code class="nt">&lt;p&gt;</code>This is a really interesting paragraph.<code class="nt">&lt;/p&gt;</code>     <code class="nt">&lt;/body&gt;</code> <code class="nt">&lt;/html&gt;</code></pre> 
<p id="html_is_a_compl">HTML is a complex language with a rich history. This overview will address only the current iteration of HTML (formerly known as HTML5) and will touch on only what is immediately relevant for our practice with D3.</p> 
<div class="sect2" id="_content_plus_structure"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Content Plus Structure</h3></div></div></div> 
<p id="the_core_functi">The core function of HTML is to enable you to “mark up” content, thereby

<a id="id485792" class="indexterm"></a> giving it structure. Take, for example, this raw text:</p> 
<pre class="screen" id="amazing_visuali_id1">Amazing Visualization Tool Cures All Ills A new open-source tool designed for visualization of data turns out to have an unexpected, positive side effect: it heals any ailments of the viewer. Leading scientists report that the tool, called D3000, can cure even the following symptoms: fevers chills general malaise It achieves this end with a patented, three-step process. Load in data. Generate a visual representation. Activate magic healing function.</pre> 
<p id="reading_between">Reading between the lines, we can infer that this is a very exciting news story. But as unstructured content, it is very hard to read. By adding structure, we can differentiate between the headline, for example, and the body of the story.</p> 
<div class="blockquote">
<blockquote class="blockquote"> 
<p id="amazing_visuali_id2">
<span class="strong">
<strong>Amazing Visualization Tool Cures All Ills</strong></span></p> 
<p id="a_new_opensour">A new open-source tool designed for visualization of data turns out to have an unexpected, positive side effect: it heals any ailments of the viewer. Leading scientists report that the tool, called D3000, can cure even the following symptoms:</p> 
<div class="itemizedlist" id="fevers_chills_g">
<ul class="itemizedlist"> 
<li class="listitem"> fevers </li> 
<li class="listitem"> chills </li> 
<li class="listitem"> general malaise </li> </ul></div> 
<p id="it_achieves_thi">It achieves this end with a patented, three-step process.</p> 
<div class="orderedlist" id="load_in_data_g">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Load in data. </li> 
<li class="listitem"> Generate a visual representation. </li> 
<li class="listitem"> Activate magic healing function. </li> </ol></div> </blockquote></div> 
<p id="that_has_the_sa">That has the same raw text content, but with a 
<span class="emphasis">
<em>visual structure</em></span> that makes the content more accessible.

<a id="id485887" class="indexterm"></a></p> 
<p id="html_is_a_tool_">HTML is a tool for specifying 
<span class="emphasis">
<em>semantic structure</em></span>, or attaching hierarchy, relationships, and 
<span class="emphasis">
<em>meaning</em></span> to content. (HTML doesn’t address the visual representation of a 
<span class="keep-together">document’s</span> structure—that’s CSS’ job.) Here is our story with each chunk of content replaced by a 
<span class="emphasis">
<em>semantic description</em></span> of what that content is.

<a id="id485914" class="indexterm"></a></p> 
<div class="blockquote">
<blockquote class="blockquote"> 
<p id="headline">
<span class="strong">
<strong>Headline</strong></span></p> 
<p id="paragraph_text_id1">Paragraph text</p> 
<div class="itemizedlist" id="unordered_list__id1">
<ul class="itemizedlist"> 
<li class="listitem"> Unordered list item </li> 
<li class="listitem"> Unordered list item </li> 
<li class="listitem"> Unordered list item </li> </ul></div> 
<p id="paragraph_text_id2">Paragraph text</p> 
<div class="orderedlist" id="numbered_list_i_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Numbered list item </li> 
<li class="listitem"> Numbered list item </li> 
<li class="listitem"> Numbered list item </li> </ol></div> </blockquote></div> 
<p id="this_is_the_kin">This is the kind of structure we specify with HTML markup.</p> </div> 
<div class="sect2" id="_adding_structure_with_elements"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Adding Structure with Elements</h3></div></div></div> 
<p id="marking_up_is">“Marking up” is the process of adding 
<span class="emphasis">
<em>tags</em></span> to create 
<span class="emphasis">
<em>elements</em></span>. HTML tags begin with <code class="literal">&lt;</code> and end with <code class="literal">&gt;</code>, as in <code class="literal">&lt;p&gt;</code>, which is the tag indicating a paragraph of text.  Tags usually occur in pairs, in which case adding an opening and closing pair of tags creates a new 
<span class="emphasis">
<em>element</em></span> in the document structure.

<a id="id486020" class="indexterm"></a>

<a id="id486027" class="indexterm"></a>

<a id="id486033" class="indexterm"></a></p> 
<p id="closing_tags_ar">Closing tags are indicated with a slash that closes or ends the element, as in <code class="literal">&lt;/p&gt;</code>. Thus, a paragraph of text may be marked up like the following:</p> 
<pre class="programlisting" data-language="html" id="pthis_is_a_re"><code class="nt">&lt;p&gt;</code>This is a really interesting paragraph.<code class="nt">&lt;/p&gt;</code></pre> 
<p id="some_elements_c">Some elements can be 
<span class="emphasis">
<em>nested</em></span>. For example, here we use the <code class="literal">em</code> element to add 
<span class="emphasis">
<em>emphasis</em></span>.</p> 
<pre class="programlisting" data-language="html" id="pthis_is_a_e"><code class="nt">&lt;p&gt;</code>This is a <code class="nt">&lt;em&gt;</code>really<code class="nt">&lt;/em&gt;</code> interesting paragraph.<code class="nt">&lt;/p&gt;</code></pre> 
<p id="nesting_element">Nesting elements introduces hierarchy to the document. In this case, <code class="literal">em</code> is a child of <code class="literal">p</code> because it is contained by <code class="literal">p</code>. (Conversely, <code class="literal">p</code> is <code class="literal">em</code>’s parent.)</p> 
<p id="when_elements_a">When elements are nested, they cannot overlap closures of their parent elements, as doing so would disrupt the hierarchy. For example:</p> 
<pre class="programlisting" data-language="html" id="pthis_could_c"><code class="nt">&lt;p&gt;</code>This could cause <code class="nt">&lt;em&gt;</code>unexpected<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;p&gt;</code>results<code class="nt">&lt;/em&gt;</code>, and is best avoided.<code class="nt">&lt;/p&gt;</code></pre> 
<p id="some_tags_never">Some tags never occur in pairs, such as the <code class="literal">img</code> element, which references an image file. Although HTML no longer requires it, you will sometimes see such tags written in 
<span class="emphasis">
<em>self-closing</em></span> fashion, with a trailing slash before the closing bracket:</p> 
<pre class="programlisting" data-language="html" id="img_srcphoto_id1"><code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"photo.jpg"</code> <code class="nt">/&gt;</code></pre> 
<p id="as_of_html_th">As of HTML5, the self-closing slash is optional, so the following code is equivalent to the preceding code:</p> 
<pre class="programlisting" data-language="html" id="img_srcphoto_id2"><code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"photo.jpg"</code><code class="nt">&gt;</code></pre> </div> 
<div class="sect2" id="_common_elements"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Common Elements</h3></div></div></div> 
<p id="there_are_hundr">There are hundreds of different HTML elements. Here are some of the most common. We’ll cover additional elements in later chapters. (Reference the excellent 

<a class="ulink" href="https://developer.mozilla.org/en/HTML/Element" target="_top">Mozilla Developer Network documentation</a> for a complete listing.)

<a id="id486271" class="indexterm"></a></p> 
<div class="variablelist" id="doctype_html_id2">
<dl class="variablelist"> 
<dt>
<span class="term"> <code class="literal">&lt;!DOCTYPE html&gt;</code> </span></dt> 
<dd> The standard document type declaration. Must be the first thing in the document. </dd> 
<dt>
<span class="term"> <code class="literal">html</code> </span></dt> 
<dd> Surrounds all HTML content in a document. </dd> 
<dt>
<span class="term"> <code class="literal">head</code> </span></dt> 
<dd> The document <code class="literal">head</code> contains all metadata about the document, such as its <code class="literal">title</code> and any references to external stylesheets and scripts. </dd> 
<dt>
<span class="term"> <code class="literal">title</code> </span></dt> 
<dd> The title of the document. Browsers typically display this at the top of the browser window and use this title when bookmarking a page. </dd> 
<dt>
<span class="term"> <code class="literal">body</code> </span></dt> 
<dd> Everything not in the <code class="literal">head</code> should go in the <code class="literal">body</code>. This is the primary visible content of the page. </dd> 
<dt>
<span class="term"> <code class="literal">h1</code>, <code class="literal">h2</code>, <code class="literal">h3</code>, <code class="literal">h4</code> </span></dt> 
<dd> These let you specify headings of different levels. <code class="literal">h1</code> is a top-level heading, <code class="literal">h2</code> is below that, and so on. </dd> 
<dt>
<span class="term"> <code class="literal">p</code> </span></dt> 
<dd> A paragraph! </dd> 
<dt>
<span class="term"> <code class="literal">ul</code>, <code class="literal">ol</code>, <code class="literal">li</code> </span></dt> 
<dd> Unordered lists are specified with <code class="literal">ul</code>, most often used for bulleted lists. Ordered lists (<code class="literal">ol</code>) are often numbered. Both <code class="literal">ul</code> and <code class="literal">ol</code> should include <code class="literal">li</code> elements to specify list items. </dd> 
<dt>
<span class="term"> <code class="literal">em</code> </span></dt> 
<dd> Indicates emphasis. Typically rendered in 
<span class="emphasis">
<em>italics</em></span>. </dd> 
<dt>
<span class="term"> <code class="literal">strong</code> </span></dt> 
<dd> Indicates additional emphasis. Typically rendered in 
<span class="strong">
<strong>boldface</strong></span>. </dd> 
<dt>
<span class="term"> <code class="literal">a</code> </span></dt> 
<dd> A link. Typically rendered as underlined, blue text, unless otherwise specified. </dd> 
<dt>
<span class="term"> <code class="literal">span</code> </span></dt> 
<dd> An arbitrary <code class="literal">span</code> of text, typically within a larger containing element like <code class="literal">p</code>. </dd> 
<dt>
<span class="term"> <code class="literal">div</code> </span></dt> 
<dd> An arbitrary 
<span class="emphasis">
<em>division</em></span> within the document. Used for grouping and containing related elements. </dd> </dl></div> 
<p id="our_earlier_exa">Our earlier example could be given semantic structure by marking it up using some of these element’s tags:</p> 
<pre class="programlisting" data-language="html" id="hamazing_vis"><code class="nt">&lt;h1&gt;</code>Amazing Visualization Tool Cures All Ills<code class="nt">&lt;/h1&gt;</code> <code class="nt">&lt;p&gt;</code>A new open-source tool designed for visualization of data turns out to have an unexpected, positive side effect: it heals any ailments of the viewer. Leading scientists report that the tool, called D3000, can cure even the following symptoms:<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;ul&gt;</code>     <code class="nt">&lt;li&gt;</code>fevers<code class="nt">&lt;/li&gt;</code>     <code class="nt">&lt;li&gt;</code>chills<code class="nt">&lt;/li&gt;</code>     <code class="nt">&lt;li&gt;</code>general malaise<code class="nt">&lt;/li&gt;</code> <code class="nt">&lt;/ul&gt;</code> <code class="nt">&lt;p&gt;</code>It achieves this end with a patented, three-step process.<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;ol&gt;</code>     <code class="nt">&lt;li&gt;</code>Load in data.<code class="nt">&lt;/li&gt;</code>     <code class="nt">&lt;li&gt;</code>Generate a visual representation.<code class="nt">&lt;/li&gt;</code>     <code class="nt">&lt;li&gt;</code>Activate magic healing function.<code class="nt">&lt;/li&gt;</code> <code class="nt">&lt;/ol&gt;</code></pre> 
<p id="when_viewed_in_">When viewed in a web browser, that markup is rendered as shown in 

<a class="xref" href="#Typical_default_rendering_of_simple_HTML" title="Figure 3-1. Typical default rendering of simple HTML">Figure 3-1</a>.</p> 
<div class="figure" id="Typical_default_rendering_of_simple_HTML"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0301.png" alt="Typical default rendering of simple HTML"></div></div> 
<div class="figure-title">Figure 3-1. Typical default rendering of simple HTML</div> </div> 
<p id="notice_that_we_">Notice that we specified only the 
<span class="emphasis">
<em>semantic</em></span> structure of the content; we didn’t specify any visual properties, such as color, type size, indents, or line spacing. Without such instructions, the browser falls back on its 
<span class="emphasis">
<em>default styles</em></span>, which, frankly, are not too 
<span class="keep-together">exciting</span>.</p> </div> 
<div class="sect2" id="_attributes"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Attributes</h3></div></div></div> 
<p id="all_html_elemen">All HTML elements can be assigned 
<span class="emphasis">
<em>attributes</em></span> by including property/value pairs in the opening tag.

<a id="id486753" class="indexterm"></a>

<a id="id486760" class="indexterm"></a></p> 
<pre class="programlisting" data-language="html" id="tagname_proper"><code class="nt">&lt;tagname</code> <code class="na">property=</code><code class="s">"value"</code><code class="nt">&gt;&lt;/tagname&gt;</code></pre> 
<p id="the_name_of_the">The name of the property is followed by an equals sign, and the value is enclosed within double quotation marks.</p> 
<p id="different_kinds">Different kinds of elements can be assigned different attributes. For example, the <code class="literal">a</code> link tag can be given an <code class="literal">href</code> attribute, whose value specifies the URL for that link. (<code class="literal">href</code> is short for “HTTP reference.”)</p> 
<pre class="programlisting" data-language="html" id="a_hrefhttp"><code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://d3js.org/"</code><code class="nt">&gt;</code>The D3 website<code class="nt">&lt;/a&gt;</code></pre> 
<p id="some_attributes">Some attributes can be assigned to 
<span class="emphasis">
<em>any</em></span> type of element, such as <code class="literal">class</code> and <code class="literal">id</code>.</p> </div> 
<div class="sect2" id="_classes_and_ids"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Classes and IDs</h3></div></div></div> 
<p id="classes_and_ids">Classes and IDs are extremely useful attributes, as they can be

<a id="id486877" class="indexterm"></a>

<a id="id486884" class="indexterm"></a> referenced later to identify specific pieces of content. Your CSS and JavaScript code will rely heavily on classes and IDs to identify elements. For example:</p> 
<pre class="programlisting" data-language="html" id="pbrilliant_pa"><code class="nt">&lt;p&gt;</code>Brilliant paragraph<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;p&gt;</code>Insightful paragraph<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"awesome"</code><code class="nt">&gt;</code>Awe-inspiring paragraph<code class="nt">&lt;/p&gt;</code></pre> 
<p id="these_are_three">These are three very uplifting paragraphs, but only one of them is truly awesome, as I’ve indicated with <code class="literal">class="awesome"</code>. The third paragraph becomes part of a 
<span class="emphasis">
<em>class</em></span> of 
<span class="emphasis">
<em>awesome</em></span> elements, and it can be selected and manipulated along with other class members. (We’ll get to that in a moment.)</p> 
<p id="elements_can_be">Elements can be assigned multiple classes, simply by separating them with a space:</p> 
<pre class="programlisting" data-language="html" id="p_classuplif"><code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"uplifting"</code><code class="nt">&gt;</code>Brilliant paragraph<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"uplifting"</code><code class="nt">&gt;</code>Insightful paragraph<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"uplifting awesome"</code><code class="nt">&gt;</code>Awe-inspiring paragraph<code class="nt">&lt;/p&gt;</code></pre> 
<p id="now_all_three_">Now, all three paragraphs are <code class="literal">uplifting</code>, but only the last one is both <code class="literal">uplifting</code> 
<span class="emphasis">
<em>and</em></span> <code class="literal">awesome</code>.</p> 
<p id="ids_are_used_in">IDs are used in much the same way, but there can be only one ID per

<a id="id487075" class="indexterm"></a> element, and each ID value can be used only once on the page. For example:</p> 
<pre class="programlisting" data-language="html" id="div_idconten"><code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"content"</code><code class="nt">&gt;</code>     <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"visualization"</code><code class="nt">&gt;&lt;/div&gt;</code>     <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"button"</code><code class="nt">&gt;&lt;/div&gt;</code> <code class="nt">&lt;/div&gt;</code></pre> 
<p id="ids_are_useful_">IDs are useful when a single element has some special quality, like a <code class="literal">div</code> that functions as a button or as a container for other content on the page.

<a id="id487160" class="indexterm"></a>

<a id="id487165" class="indexterm"></a></p> 
<p id="as_a_general_ru">As a general rule, if there will be only 
<span class="emphasis">
<em>one</em></span> such element on the page, you can use an <code class="literal">id</code>. Otherwise, use a <code class="literal">class</code>.</p> 
<div class="warning" id="class_and_id_na_id1">
<p id="class_and_id_na_id2">Class and ID names cannot begin with numerals; they must begin with alphabetic characters. So <code class="literal">id="1"</code> won’t work, but <code class="literal">id="item1"</code> will. The browser will not give you any errors; your code simply won’t work, and you will go crazy trying to figure out why.</p></div> </div> 
<div class="sect2" id="_comments"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Comments</h3></div></div></div> 
<p id="as_code_grows_i">As code grows in size and complexity, it is good practice to include comments. These are friendly notes that you leave for yourself to remind you why you wrote the code the way you did. If you are like me, you will revisit projects only weeks later and have lost all recollections of it. Commenting is an easy way to reach out and provide guidance and solace to your future (and very confused) self.

<a id="id487222" class="indexterm"></a>

<a id="id487229" class="indexterm"></a></p> 
<p id="in_html_commen">In HTML, comments are written in the following format:</p> 
<pre class="programlisting" data-language="html" id="your_comme"><code class="c">&lt;!-- Your comment here --&gt;</code></pre> 
<p id="anything_betwee">Anything between the <code class="literal">&lt;!--</code> and <code class="literal">--&gt;</code> will be ignored by the web browser.

<a id="id487264" class="indexterm"></a></p> </div> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="_dom"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">DOM</h2></div></div></div> 
<p id="the_term_docume">The term Document Object Model refers to the hierarchical structure of

<a id="id487284" class="indexterm"></a>

<a id="id487291" class="indexterm"></a>

<a id="id487299" class="indexterm"></a>

<a id="id487304" class="indexterm"></a>

<a id="id487309" class="indexterm"></a>

<a id="id487314" class="indexterm"></a>

<a id="id487319" class="indexterm"></a> HTML. Each pair of bracketed tags (or, in some cases, a single tag) is an 
<span class="emphasis">
<em>element</em></span>, and we refer to elements’ relative relationships to each other in human terms: parent, child, sibling, ancestor, and descendant. For example, in this HTML:</p> 
<pre class="programlisting" data-language="html" id="html_body_"><code class="nt">&lt;html&gt;</code>     <code class="nt">&lt;body&gt;</code>         <code class="nt">&lt;h1&gt;</code>Breaking News<code class="nt">&lt;/h1&gt;</code>         <code class="nt">&lt;p&gt;&lt;/p&gt;</code>     <code class="nt">&lt;/body&gt;</code> <code class="nt">&lt;/html&gt;</code></pre> 
<p id="body_is_the_par"><code class="literal">body</code> is the parent element to both of its children, <code class="literal">h1</code> and <code class="literal">p</code> (which are siblings to each other). All elements on the page are descendants of <code class="literal">html</code>.</p> 
<p id="web_browsers_pa">Web browsers parse the DOM to make sense of a page’s content. As coders building visualizations, we care about the DOM, because our code must navigate its hierarchy to apply styles and actions to its elements. We don’t want to make 
<span class="emphasis">
<em>all</em></span> the <code class="literal">div</code> elements blue; we need to know how to select just the <code class="literal">div</code>s of the class <code class="literal">sky</code> and make 
<span class="emphasis">
<em>them</em></span> blue.</p> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="developer_tools_3"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Developer Tools</h2></div></div></div> 
<p id="in_the_olden_da">In the olden days, the web development process went like this:</p> 
<div class="orderedlist" id="write_some_code_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Write some code in a text editor.

<a id="ix_devtool" class="indexterm"></a>

<a id="ix_webtool" class="indexterm"></a> </li> 
<li class="listitem"> Save the files. </li> 
<li class="listitem"> Switch to a browser window. </li> 
<li class="listitem"> Reload the page, and see if your code worked. </li> 
<li class="listitem"> If it didn’t work, take a guess at what went wrong inside the magical black box of the web browser, then go back to step 1. </li> </ol></div> 
<p id="browsers_were_n">Browsers were notoriously secretive about what went on 
<span class="emphasis">
<em>inside</em></span> the rendering engine, which made debugging a total nightmare.  (Seriously, in the late 1990s and early 2000s, I literally had nightmares about this.)  Fortunately, we live in a more enlightened age, and every modern-day browser has built-in 
<span class="emphasis">
<em>developer tools</em></span> that expose the inner workings of the beast and enable us to poke around under the hood (to mix incompatible metaphors).</p> 
<p id="all_this_is_to__id1">All this is to say that developer tools are a big deal and you will rely on them heavily to both test your code and, when something breaks, figure out what went wrong.</p> 
<p id="lets_start_wit">Let’s start with the simplest possible use of the developer tools: viewing the raw

<a id="id487525" class="indexterm"></a> source code of an HTML page (see 

<a class="xref" href="#plain_source_view_window" title="Figure 3-2. Looking at the source code in a new window">Figure 3-2</a>).</p> 
<p id="every_browser_s">Every browser supports this, although different browsers hide this option in different places.  In Chrome 23.0, it’s under View→Developer→View Source.  In Firefox 17.0, look under Tools→Web Developer→Page Source.  In Safari 6.0, it’s under Develop→Show Page Source (although you must first set the “Develop” menu to display under Safari→Preferences→Advanced).  Going forward, I’m going to assume that you’re using the newest version of whatever browser you choose.

<a id="id487546" class="indexterm"></a>

<a id="id487551" class="indexterm"></a>

<a id="id487557" class="indexterm"></a></p> 
<div class="figure" id="plain_source_view_window"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0302.png" alt="Looking at the source code in a new window"></div></div> 
<div class="figure-title">Figure 3-2. Looking at the source code in a new window</div> </div> 
<p id="that_gets_you_t">That gets you the raw HTML, but if any D3 or JavaScript code has been executed, the current DOM may be vastly different.

<a id="id487582" class="indexterm"></a></p> 
<p id="fortunately_yo_id1">Fortunately, your browser’s developer tools enable you to see the current state of the DOM.  And, again, the developer tools are different in every browser.  In Chrome, find them under View→Developer→Developer Tools.  In Firefox, try Tools→Web Developer.  In Safari, first enable the developer tools (in Safari→Preferences→Advanced).  Then, in the Develop menu, choose Show Web Inspector.  In any browser, you can also use the corresponding keyboard shortcut (as shown adjacent to the menu item) or right-click and choose “inspect element” or something similar.</p> 
<p id="until_recently">Until recently, Safari and Chrome shared the same developer tools, but with Safari 6.0, Apple completely redesigned their dev tools, much to the dismay of many web-developing Safari fans.  (The new tools are very hard to navigate, and I don’t think I’m the only one who feels that way.)  Whichever browser you use might look a bit different from my screenshots, but the functionality will be very similar.</p> 
<p id="shows_the_eleme">

<a class="xref" href="#Safari_web_inspector" title="Figure 3-3. Chrome’s web inspector">Figure 3-3</a> shows the Elements tab of Chrome’s web inspector.  Here we can see the current state of the DOM. This is useful because your code will modify DOM elements dynamically.  In the web inspector, you can watch elements as they change.</p> 
<div class="figure" id="Safari_web_inspector"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0303.png" alt="Chrome’s web inspector"></div></div> 
<div class="figure-title">Figure 3-3. Chrome’s web inspector</div> </div> 
<p id="if_you_look_clo">If you look closely, you’ll already see some differences between the raw HTML and the DOM, including the fact that Chrome generated the required <code class="literal">html</code>, <code class="literal">head</code>, and <code class="literal">body</code> elements. (I was lazy and didn’t include them in my original HTML.)</p> 
<p id="one_more_thing_id1">One more thing: why am I focusing on Chrome, Firefox, and Safari? Why not Internet Explorer, Opera, or the many other browsers out there? For one, it’s best to develop your projects using a browser with the broadest support for web standards. Internet Explorer made huge progress with versions 9 and 10, but Chrome, Firefox, and Safari are understood to have the broadest standards support, and they are updated more frequently.</p> 
<p id="second_youre_">Second, you’re going to spend a lot of time using the developer tools, so you should develop with a browser that has tools you enjoy using.  I was pretty devoted to Safari until the 6.0 update changed everything.  Now I’m going back and forth between Chrome and Firefox’s new dev tools.  I recommend you try them all and decide what works best for you.

<a id="id487681" class="indexterm"></a>

<a id="id487688" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="_rendering_and_the_box_model"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Rendering and the Box Model</h2></div></div></div> 
<p id="rendering_is_th">
<span class="emphasis">
<em>Rendering</em></span> is the process by which browsers, after parsing the HTML and generating the DOM, apply visual rules to the DOM contents and draw those pixels to the screen.

<a id="id487711" class="indexterm"></a>

<a id="id487716" class="indexterm"></a></p> 
<p id="the_most_import">The most important thing to keep in mind when considering how browsers render content is this: to a browser, everything is a box.</p> 
<p id="paragraphs_div">Paragraphs, <code class="literal">div</code>s, <code class="literal">span</code>s—all are boxes in the sense that they are two-dimensional rectangles, with properties that any rectangle can have, such as width, height, and positions in space. Even if something looks curved or irregularly shaped, rest assured, to the browser, it is merely another rectangular box.

<a id="id487746" class="indexterm"></a>

<a id="id487751" class="indexterm"></a>

<a id="id487758" class="indexterm"></a></p> 
<p id="you_can_see_the">You can see these boxes with the help of the web inspector. Just mouse over any element, and the box associated with that element is highlighted in blue, as shown in 

<a class="xref" href="#Inspector_with_element_box_highlighted" title="Figure 3-4. Inspector with element box highlighted">Figure 3-4</a>.</p> 
<div class="figure" id="Inspector_with_element_box_highlighted"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0304.png" alt="Inspector with element box highlighted"></div></div> 
<div class="figure-title">Figure 3-4. Inspector with element box highlighted</div> </div> 
<p id="theres_a_lot_o">There’s a lot of information about the <code class="literal">ul</code> unordered list here. Note that the list’s total dimensions (width and height) are shown in the yellow box at the element’s lower-left corner. Also, the list’s position in the DOM hierarchy is indicated in the lower-left corner of the inspector: <code class="literal">html &gt; body &gt; ul</code>.

<a id="id487808" class="indexterm"></a></p> 
<p id="the_box_for_the">The box for the <code class="literal">ul</code> expands to fill the width of the entire window because it is a 
<span class="emphasis">
<em>block-level</em></span> element. (Note how under “Computed Style” is listed <code class="literal">display: block</code>.) This is in contrast to 
<span class="emphasis">
<em>inline</em></span> elements, which rest 
<span class="emphasis">
<em>in line</em></span> with each other, not stacked on top of each other like blocks. Common inline elements include <code class="literal">strong</code>, <code class="literal">em</code>, <code class="literal">a</code>, and <code class="literal">span</code>.

<a id="id487860" class="indexterm"></a>

<a id="id487866" class="indexterm"></a></p> 
<p id="by_default_blo">By default, block-level elements expand to fill their container elements and force any subsequent sibling elements further down the page. Inline elements do not expand to fill extra space, and happily exist side by side, next to their fellow inline neighbors. (Discussion question: what kind of element would you rather be?)</p> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="_css"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">CSS</h2></div></div></div> 
<p id="cascading_style">Cascading Style Sheets are used to style the visual presentation of DOM

<a id="ix_CSS" class="indexterm"></a>

<a id="id487900" class="indexterm"></a> elements. A simple CSS stylesheet looks like the following:</p> 
<pre class="programlisting" data-language="css" id="body__backgrou"><code class="nt">body</code> <code class="p">{</code>     <code class="k">background-color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="css_styles_cons">CSS styles consist of 
<span class="emphasis">
<em>selectors</em></span> and 
<span class="emphasis">
<em>properties</em></span>. Selectors are

<a id="id487978" class="indexterm"></a>

<a id="id487986" class="indexterm"></a>

<a id="id487991" class="indexterm"></a> followed by properties, grouped in curly brackets. A property and its value are separated by a colon, and the line is terminated with a semicolon, like the following:</p> 
<pre class="programlisting" data-language="css" id="selector__prop"><code class="nt">selector</code> <code class="p">{</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="the_same_proper">The same properties can be applied to multiple selectors at once by separating the selectors with a comma, as in the following:</p> 
<pre class="programlisting" data-language="css" id="selectora_sele"><code class="nt">selectorA</code><code class="o">,</code> <code class="nt">selectorB</code><code class="o">,</code> <code class="nt">selectorC</code> <code class="p">{</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="for_example_yo_id1">For example, you might want to specify that both <code class="literal">p</code> paragraphs and <code class="literal">li</code> list items should use the same font size, line height, and color.</p> 
<pre class="programlisting" data-language="css" id="p_li__fontsi"><code class="nt">p</code><code class="o">,</code> <code class="nt">li</code> <code class="p">{</code>     <code class="k">font-size</code><code class="o">:</code> <code class="m">12px</code><code class="p">;</code>     <code class="k">line-height</code><code class="o">:</code> <code class="m">14px</code><code class="p">;</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">orange</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="collectively_t">Collectively, this whole chunk of code (selectors and bracketed properties) is called a 
<span class="emphasis">
<em>CSS rule</em></span>.

<a id="id488288" class="indexterm"></a></p> 
<div class="sect2" id="_selectors"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Selectors</h3></div></div></div> 
<p id="d_uses_csssty">D3 uses CSS-style selectors to identify elements on which to operate, so it’s important to understand how to use them.</p> 
<p id="selectors_ident">Selectors identify specific elements to which styles will be applied. There are several different kinds of selectors. We’ll use only the simplest ones in this book.</p> 
<div class="variablelist" id="type_selectors_">
<dl class="variablelist"> 
<dt>
<span class="term"> Type selectors </span></dt> 
<dd> These are the simplest. They match DOM elements with the same

<a id="id488326" class="indexterm"></a> name: </dd> </dl></div> 
<pre class="programlisting" data-language="css" id="h__selects_a"><code class="n">h1</code>          <code class="c">/* Selects all level 1 headings           */</code> <code class="n">p</code>           <code class="c">/* Selects all paragraphs                 */</code> <code class="n">strong</code>      <code class="c">/* Selects all strong elements            */</code> <code class="n">em</code>          <code class="c">/* Selects all em elements                */</code> <code class="n">div</code>         <code class="c">/* Selects all divs                       */</code></pre> 
<div class="variablelist" id="descendant_sele">
<dl class="variablelist"> 
<dt>
<span class="term"> Descendant selectors </span></dt> 
<dd> These match elements that are contained by (or “descended from”) another element. We will rely heavily on descendant

<a id="id488404" class="indexterm"></a> selectors to apply styles: </dd> </dl></div> 
<pre class="programlisting" data-language="css" id="h_em__select"><code class="n">h1</code> <code class="n">em</code>       <code class="c">/* Selects em elements contained in an h1 */</code> <code class="n">div</code> <code class="n">p</code>       <code class="c">/* Selects p elements contained in a div  */</code></pre> 
<div class="variablelist" id="class_selectors">
<dl class="variablelist"> 
<dt>
<span class="term"> Class selectors </span></dt> 
<dd> These match elements of any type that have been assigned a

<a id="id488460" class="indexterm"></a> specific class. Class names are preceded with a period, as shown here: </dd> </dl></div> 
<pre class="programlisting" data-language="css" id="caption__sel"><code class="o">.</code><code class="n">caption</code>    <code class="c">/* Selects elements with class "caption"  */</code> <code class="o">.</code><code class="n">label</code>      <code class="c">/* Selects elements with class "label"    */</code> <code class="o">.</code><code class="n">axis</code>       <code class="c">/* Selects elements with class "axis"     */</code></pre> 
<p id="because_element">Because elements can have more than one class, you can target elements with multiple classes by stringing the classes together, as in the following:</p> 
<pre class="programlisting" data-language="css" id="barhighlight_"><code class="o">.</code><code class="n">bar</code><code class="o">.</code><code class="n">highlight</code>  <code class="c">/* Could target highlighted bars      */</code> <code class="o">.</code><code class="n">axis</code><code class="o">.</code><code class="n">x</code>         <code class="c">/* Could target an x-axis             */</code> <code class="o">.</code><code class="n">axis</code><code class="o">.</code><code class="n">y</code>         <code class="c">/* Could target a y-axis              */</code></pre> 
<p id="axis_could_be_"><code class="literal">.axis</code> could be used to apply styles to both axes, for example, whereas <code class="literal">.axis.x</code> would apply only to the x-axis.</p> 
<div class="variablelist" id="id_selectors_th">
<dl class="variablelist"> 
<dt>
<span class="term"> ID selectors </span></dt> 
<dd> These match the single element with a given ID. (Remember, IDs can be

<a id="id488622" class="indexterm"></a> used only once each in the DOM.) IDs are preceded with a hash mark. </dd> </dl></div> 
<pre class="programlisting" data-language="css" id="header__sele"><code class="m">#header</code>     <code class="c">/* Selects element with ID "header"       */</code> <code class="m">#nav</code>        <code class="c">/* Selects element with ID "nav"          */</code> <code class="m">#export</code>     <code class="c">/* Selects element with ID "export"       */</code></pre> 
<p id="selectors_get_p">Selectors get progressively more useful as you combine them in different ways to target specific elements. You can string selectors together to get very specific results. For 
<span class="keep-together">example</span>:</p> 
<pre class="programlisting" data-language="css" id="divsidebar__"><code class="n">div</code><code class="o">.</code><code class="n">sidebar</code> <code class="c">/* Selects divs with class "sidebar", but</code> <code class="c">               not other elements with that class     */</code> <code class="m">#button</code><code class="o">.</code><code class="n">on</code>  <code class="c">/* Selects element with ID "button", but</code> <code class="c">               only when the class "on" is applied    */</code></pre> 
<p id="remember_becau">Remember, because the DOM is dynamic, classes and IDs can be added and removed, so you might have CSS rules that apply only in certain scenarios.</p> 
<p id="for_details_on_">For details on additional selectors, see the 

<a class="ulink" href="http://mzl.la/V27Mcr" target="_top">Mozilla Developer Network</a>.</p> </div> 
<div class="sect2" id="_properties_and_values"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Properties and Values</h3></div></div></div> 
<p id="groups_of_prope">Groups of property/value pairs cumulatively form the

<a id="id488757" class="indexterm"></a>

<a id="id488764" class="indexterm"></a>

<a id="id488769" class="indexterm"></a> styles:</p> 
<pre class="programlisting" data-language="css" id="margin_px_p"><code class="k">margin</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code> <code class="k">padding</code><code class="o">:</code> <code class="m">25px</code><code class="p">;</code> <code class="k">background-color</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code> <code class="k">color</code><code class="o">:</code> <code class="nb">pink</code><code class="p">;</code> <code class="k">font-family</code><code class="o">:</code> <code class="n">Helvetica</code><code class="o">,</code> <code class="n">Arial</code><code class="o">,</code> <code class="nb">sans-serif</code><code class="p">;</code></pre> 
<p id="at_the_risk_of_">At the risk of stating the obvious, notice that each property expects a different kind of information. <code class="literal">color</code> wants a color, <code class="literal">margin</code> requires a measurement (here in <code class="literal">px</code> or pixels), and so on.</p> 
<p id="by_the_way_col">By the way, colors can be specified in several different formats:</p> 
<div class="itemizedlist" id="named_colors_o_id1">
<ul class="itemizedlist"> 
<li class="listitem"> Named colors: <code class="literal">orange</code> </li> 
<li class="listitem"> Hex values: <code class="literal">#3388aa</code> or <code class="literal">#38a</code> </li> 
<li class="listitem"> RGB values: <code class="literal">rgb(10, 150, 20)</code> </li> 
<li class="listitem"> RGB with alpha transparency: <code class="literal">rgba(10, 150, 20, 0.5)</code> </li> </ul></div> 
<p id="you_can_find_ex">You can find 

<a class="ulink" href="https://developer.mozilla.org/en/CSS/CSS_Reference" target="_top">exhaustive lists of properties online</a>; I won’t try to list them here. Instead, I’ll just introduce relevant properties as we go.

<a id="id488982" class="indexterm"></a>

<a id="id488989" class="indexterm"></a></p> </div> 
<div class="sect2" id="_comments_2"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Comments</h3></div></div></div> 
<pre class="programlisting" data-language="css" id="by_the_way_"><code class="c">/* By the way, this is what a comment looks like</code> <code class="c">   in CSS.  They start with a slash-asterisk pair,</code> <code class="c">   and end with an asterisk-slash pair.  Anything</code> <code class="c">   in between will be ignored. */</code></pre> </div> 
<div class="sect2" id="_referencing_styles"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Referencing Styles</h3></div></div></div> 
<p id="there_are_three">There are three common ways to apply CSS style rules to your HTML document.

<a id="id489037" class="indexterm"></a>

<a id="id489044" class="indexterm"></a></p> 
<div class="sect3" id="_embed_the_css_in_your_html"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Embed the CSS in your HTML.</h4></div></div></div> 
<p id="if_you_embed_th">If you embed the CSS rules in your HTML document, you can keep everything in one file. In the document <code class="literal">head</code>, include all CSS code within a <code class="literal">style</code> element.</p> 
<pre class="programlisting" data-language="html" id="html_head__id1"><code class="nt">&lt;html&gt;</code>     <code class="nt">&lt;head&gt;</code>         <code class="nt">&lt;style </code><code class="na">type=</code><code class="s">"text/css"</code><code class="nt">&gt;</code>              <code class="nt">p</code> <code class="p">{</code>                 <code class="k">font-size</code><code class="o">:</code> <code class="m">24px</code><code class="p">;</code>                 <code class="k">font-weight</code><code class="o">:</code> <code class="k">bold</code><code class="p">;</code>                 <code class="k">background-color</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code>                 <code class="k">color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>             <code class="p">}</code>          <code class="nt">&lt;/style&gt;</code>     <code class="nt">&lt;/head&gt;</code>     <code class="nt">&lt;body&gt;</code>         <code class="nt">&lt;p&gt;</code>If I were to ask you, as a mere paragraph, would you say that I         have style?<code class="nt">&lt;/p&gt;</code>     <code class="nt">&lt;/body&gt;</code> <code class="nt">&lt;/html&gt;</code></pre> 
<p id="that_html_page_">That HTML page with CSS renders as shown in 

<a class="xref" href="#Rendering_of_an_embedded_CSS_rule" title="Figure 3-5. Rendering of an embedded CSS rule">Figure 3-5</a>.</p> 
<div class="figure" id="Rendering_of_an_embedded_CSS_rule"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0305.png" alt="Rendering of an embedded CSS rule"></div></div> 
<div class="figure-title">Figure 3-5. Rendering of an embedded CSS rule</div> </div> 
<p id="embedding_is_th">Embedding is the simplest option, but I generally prefer to keep different kinds of code (for example, HTML, CSS, JavaScript) in separate documents.</p> </div> 
<div class="sect3" id="_reference_an_external_stylesheet_from_the_html"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Reference an external stylesheet from the HTML.</h4></div></div></div> 
<p id="to_store_css_ou">To store CSS outside of your HTML, save it in a plain-text file with a

<a id="id489269" class="indexterm"></a> 
<span class="emphasis">
<em>.css</em></span> suffix, such as 
<span class="emphasis">
<em>style.css</em></span>. Then use a <code class="literal">link</code> element in the document <code class="literal">head</code> to reference the external CSS file, like so:</p> 
<pre class="programlisting" data-language="html" id="html_head__id2"><code class="nt">&lt;html&gt;</code>     <code class="nt">&lt;head&gt;</code>         <code class="nt">&lt;link</code> <code class="na">rel=</code><code class="s">"stylesheet"</code> <code class="na">href=</code><code class="s">"style.css"</code><code class="nt">&gt;</code>     <code class="nt">&lt;/head&gt;</code>     <code class="nt">&lt;body&gt;</code>         <code class="nt">&lt;p&gt;</code>If I were to ask you, as a mere paragraph, would you say that         I have style?<code class="nt">&lt;/p&gt;</code>     <code class="nt">&lt;/body&gt;</code> <code class="nt">&lt;/html&gt;</code></pre> 
<p id="this_example_re">This example renders exactly the same as the prior example.</p> </div> 
<div class="sect3" id="_attach_inline_styles"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Attach inline styles.</h4></div></div></div> 
<p id="a_third_method_">A third method is to attach style rules 
<span class="emphasis">
<em>inline</em></span> directly to elements in

<a id="id489386" class="indexterm"></a> the HTML. You can do this by adding a <code class="literal">style</code> attribute to any element. Then include the CSS rules within the double quotation marks. The result is shown in 

<a class="xref" href="#Rendering_of_an_inline_CSS_rule" title="Figure 3-6. Rendering of an inline CSS rule">Figure 3-6</a>.</p> 
<pre class="programlisting" data-language="html" id="p_stylecolor"><code class="nt">&lt;p</code> <code class="na">style=</code><code class="s">"color: blue; font-size: 48px; font-style: italic;"</code><code class="nt">&gt;</code>Inline styles are kind of a hassle<code class="nt">&lt;/p&gt;</code></pre> 
<div class="figure" id="Rendering_of_an_inline_CSS_rule"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0306.png" alt="Rendering of an inline CSS rule"></div></div> 
<div class="figure-title">Figure 3-6. Rendering of an inline CSS rule</div> </div> 
<p id="because_inline_">Because inline styles are attached directly to elements, there is no need for selectors.</p> 
<p id="inline_styles_a">Inline styles are messy and hard to read, but they are useful for giving special treatment to a single element, when that style information doesn’t make sense in a larger stylesheet. We’ll learn how to apply inline styles programmatically with D3 (which is much easier than typing them in by hand, one at a time).</p> </div> </div> 
<div class="sect2" id="_inheritance_cascading_and_specificity"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Inheritance, Cascading, and Specificity</h3></div></div></div> 
<p id="many_style_prop">Many style properties are 
<span class="emphasis">
<em>inherited</em></span> by an element’s descendants unless otherwise specified. For example, this document’s style rule applies to

<a id="id489476" class="indexterm"></a>

<a id="id489484" class="indexterm"></a> the <code class="literal">div</code>:</p> 
<pre class="programlisting" data-language="html" id="html_head__id3"><code class="nt">&lt;html&gt;</code>     <code class="nt">&lt;head&gt;</code>         <code class="nt">&lt;title&gt;&lt;/title&gt;</code>         <code class="nt">&lt;style </code><code class="na">type=</code><code class="s">"text/css"</code><code class="nt">&gt;</code>              <code class="nt">div</code> <code class="p">{</code>                 <code class="k">background-color</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code>                 <code class="k">font-size</code><code class="o">:</code> <code class="m">24px</code><code class="p">;</code>                 <code class="k">font-weight</code><code class="o">:</code> <code class="k">bold</code><code class="p">;</code>                 <code class="k">color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>             <code class="p">}</code>          <code class="nt">&lt;/style&gt;</code>     <code class="nt">&lt;/head&gt;</code>     <code class="nt">&lt;body&gt;</code>         <code class="nt">&lt;p&gt;</code>I am a sibling to the div.<code class="nt">&lt;/p&gt;</code>         <code class="nt">&lt;div&gt;</code>             <code class="nt">&lt;p&gt;</code>I am a descendant and child of the div.<code class="nt">&lt;/p&gt;</code>         <code class="nt">&lt;/div&gt;</code>     <code class="nt">&lt;/body&gt;</code> <code class="nt">&lt;/html&gt;</code></pre> 
<p id="yet_when_this_p">Yet when this page renders, the styles intended for the <code class="literal">div</code> (red background, bold text, and so on) are 
<span class="emphasis">
<em>inherited</em></span> by the second paragraph, as shown in 

<a class="xref" href="#Inherited_style" title="Figure 3-7. Inherited style">Figure 3-7</a>, because that <code class="literal">p</code> is a descendant of the styled <code class="literal">div</code>.</p> 
<div class="figure" id="Inherited_style"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0307.png" alt="Inherited style"></div></div> 
<div class="figure-title">Figure 3-7. Inherited style</div> </div> 
<p id="inheritance_is_">Inheritance is a great feature of CSS, as children adopt the styles of their parents. (There’s a metaphor in there somewhere.)</p> 
<p id="finally_an_ans">Finally, an answer to the most pressing question of the day: why are they called Cascading Style Sheets? It’s because selector matches cascade from the top down. When more than one selector applies to an element, the later rule generally overrides the earlier one. For

<a id="id489739" class="indexterm"></a>

<a id="id489746" class="indexterm"></a> example, the following rules set the text of all paragraph elements in the document to be blue 
<span class="emphasis">
<em>except</em></span> for those with the class of <code class="literal">highlight</code> applied, which will be black 
<span class="emphasis">
<em>and</em></span> have a yellow background, as shown in 

<a class="xref" href="#CSS_cascading_and_inheritance_at_work" title="Figure 3-8. CSS cascading and inheritance at work">Figure 3-8</a>. The rules for <code class="literal">p</code> are applied first, but then the rules for <code class="literal">p.highlight</code> override the less specific <code class="literal">p</code> rules.</p> 
<pre class="programlisting" data-language="css" id="p__color_blue"><code class="nt">p</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">blue</code><code class="p">;</code> <code class="p">}</code>  <code class="nt">p</code><code class="nc">.highlight</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>     <code class="k">background-color</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code> <code class="p">}</code></pre> 
<div class="sidebar online_only" id="interactive_3-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_modifying_t_id1">Try modifying the CSS rules on the left, and see the effect on the Web page rendering on the right.</p> 
<div class="interactive">

<div class="figure" id="CSS_cascading_and_inheritance_at_work"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0308.png" alt="CSS cascading and inheritance at work"></div></div> 
<div class="figure-title">Figure 3-8. CSS cascading and inheritance at work</div> </div> 
<p id="later_rules_gen">Later rules generally override earlier ones, but not always. The true logic has to do with the 
<span class="emphasis">
<em>specificity</em></span> of each selector. The <code class="literal">p.highlight</code> selector would override the <code class="literal">p</code> rule even if it were listed first, simply because it is a more specific selector. If two selectors have the same specificity, then the later one will be applied.

<a id="id489935" class="indexterm"></a>

<a id="id489943" class="indexterm"></a></p> 
<p id="this_is_one_of_">This is one of the main causes of confusion with CSS. The rules for calculating specificity are inscrutable, and I won’t cover them here. To save yourself headaches later, keep your selectors clear and easy to read. Start with general selectors on top, and work your way down to more specific ones, and you’ll be all right.

<a id="id489958" class="indexterm"></a></p> </div> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="_javascript"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">JavaScript</h2></div></div></div> 
<p id="javascript_is_t">JavaScript is the scripting language that can make pages dynamic by manipulating the DOM after a page has already loaded in the browser. As I mentioned earlier, getting to know D3 is also a process of getting to know JavaScript. We’ll dig in deeper as we go, but here is a taste to get you started.

<a id="ix_Java" class="indexterm"></a></p> 
<div class="sect2" id="_hello_console"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Hello, Console</h3></div></div></div> 
<p id="normally_we_wr">Normally, we write JavaScript code (or, a “script”) in a text file, and then load that file to the browser in a web page. But you can also just type JavaScript code directly into your browser. This is an easy and quick way to get your feet wet and test out code.  We’ll also use the JavaScript console for debugging, as it’s an essential tool for seeing what’s going on with your code.

<a id="id490006" class="indexterm"></a></p> 
<p id="in_chrome_sele">In Chrome, select View→Developer→JavaScript Console.  In Firefox, choose Tools→Web Developer→Web Console.  In Safari, go to Develop→Show Error Console (see 

<a class="xref" href="#A_fresh_JavaScript_console" title="Figure 3-9. A fresh JavaScript console… delicious!">Figure 3-9</a>).</p> 
<div class="figure" id="A_fresh_JavaScript_console"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0309.png" alt="A fresh JavaScript console… delicious!"></div></div> 
<div class="figure-title">Figure 3-9. A fresh JavaScript console… delicious!</div> </div> 
<p id="the_console_acc">The console accepts one line of code at a time, and it always spits back the result of whatever you input. For example, if you enter the number <code class="literal">7</code>, the console returns the mind-numbingly obvious result of <code class="literal">7</code>. Brilliant.</p> 
<p id="other_times_yo">Other times, you’ll want your script to print values out to the console automatically, so you can keep an eye on what’s going on. As you’ll see in some examples that follow, you can use <code class="literal">console.log("something");</code> to do that.</p> 
<p id="type_the_follow_id1">Type the following examples into the console to see how it works.

<a id="id490074" class="indexterm"></a>

<a id="id490081" class="indexterm"></a>

<a id="id490087" class="indexterm"></a></p> </div> 
<div class="sect2" id="_variables"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Variables</h3></div></div></div> 
<p id="variables_are_c">Variables are containers for data. A simple variable holds one value:</p> 
<pre class="programlisting" data-language="javascript" id="var_number__"><code class="kd">var</code> <code class="nx">number</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code></pre> 
<p id="in_that_stateme">In that statement, <code class="literal">var</code> indicates you are declaring a new variable, the name of which is <code class="literal">number</code>. The equals sign is an

<a id="id490148" class="indexterm"></a> 
<span class="emphasis">
<em>assignment operator</em></span> because it takes the value on the right (<code class="literal">5</code>) and 
<span class="emphasis">
<em>assigns</em></span> it to the variable on the left (<code class="literal">number</code>). So when you see something such as:</p> 
<pre class="programlisting" data-language="javascript" id="defaultcolor__"><code class="nx">defaultColor</code> <code class="o">=</code> <code class="s2">"hot pink"</code><code class="p">;</code></pre> 
<p id="try_to_read_the">try to read the equals sign not as “equals” but as “is set to.” So that statement could be stated in plain English as “The variable <code class="literal">defaultColor</code> 
<span class="emphasis">
<em>is set to</em></span> hot pink.”</p> 
<p id="as_youve_just_">As you’ve just seen, variables can store numeric values as well as strings of text, so called because they are formed by stringing together individual characters of text. Strings must be enclosed by quotation marks. True or false (Boolean) values can also be stored:</p> 
<pre class="programlisting" data-language="javascript" id="var_thismakesse"><code class="kd">var</code> <code class="nx">thisMakesSenseSoFar</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code></pre> 
<p id="also_note_that__id1">Also note that in JavaScript, statements are concluded with a semicolon.</p> 
<p id="you_can_try_mak">You can try making some variables yourself in the console. For example, type <code class="literal">var amount = 200</code>, then press Enter, then on a new line just enter <code class="literal">amount</code> and press Enter. You should see <code class="literal">200</code> returned to you in the console—proof that JavaScript remembered the value you assigned to <code class="literal">amount</code>!</p> 
<div class="sidebar online_only" id="interactive_3-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="enter_the_follo_id1">Enter the following commands into the console below in sequence (hit Enter after each command):</p> 
<div class="itemizedlist" id="var_amount___id1">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">var amount = 200</code> </li> 
<li class="listitem"> <code class="literal">amount</code> </li> </ul></div> 
<div class="interactive">

<div class="sect2" id="_other_variable_types"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Other Variable Types</h3></div></div></div> 
<p id="a_variable_is_a">A variable is a datum, the smallest building block of data. The variable is the foundation of all other data structures, which are simply different configurations of variables.</p> 
<p id="now_well_addre">Now we’ll address some of these more complex forms of data, including arrays, objects, and arrays of objects. You might want to skip this section for now, but reference it later, once you’re ready to load your own data into D3.</p> </div> 
<div class="sect2" id="_arrays"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Arrays</h3></div></div></div> 
<p id="an_array_is_a_s">An array is a sequence of values, conveniently stored in a single variable.

<a id="id490355" class="indexterm"></a>

<a id="id490363" class="indexterm"></a></p> 
<p id="keeping_track_o">Keeping track of related values in separate variables is inefficient:</p> 
<pre class="programlisting" data-language="javascript" id="var_numbera__"><code class="kd">var</code> <code class="nx">numberA</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberB</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberC</code> <code class="o">=</code> <code class="mi">15</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberD</code> <code class="o">=</code> <code class="mi">20</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberE</code> <code class="o">=</code> <code class="mi">25</code><code class="p">;</code></pre> 
<p id="rewritten_as_an">Rewritten as an array, those values are much simpler. Hard brackets <code class="literal">[]</code> indicate an array, and each value is separated by a comma:</p> 
<pre class="programlisting" data-language="javascript" id="var_numbers___id1"><code class="kd">var</code> <code class="nx">numbers</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<p id="arrays_are_ubiq">Arrays are ubiquitous in data visualization, so you will become very comfortable with them. You can access (retrieve) a value in an array by using 
<span class="emphasis">
<em>bracket notation</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="numbers_re_id1"><code class="nx">numbers</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code>  <code class="c1">//Returns 15</code></pre> 
<p id="the_numeral_in_">The numeral in the bracket refers to a corresponding position in the array. Remember, array positions begin counting at zero, so the first position is 0, the second position is 1, and so on:</p> 
<pre class="programlisting" data-language="javascript" id="numbers_re_id2"><code class="nx">numbers</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>  <code class="c1">//Returns 5</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>  <code class="c1">//Returns 10</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code>  <code class="c1">//Returns 15</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">3</code><code class="p">]</code>  <code class="c1">//Returns 20</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">4</code><code class="p">]</code>  <code class="c1">//Returns 25</code></pre> 
<p id="some_people_fin">Some people find it helpful to think of arrays in spatial terms, as though they have rows and columns, like in a spreadsheet:</p> 
<div class="informaltable" id="position_value">
<table style="width: 50%; border-collapse: collapse;"> 
<colgroup> 
<col class="col_1"> 
<col class="col_2"> </colgroup> 
<thead>
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Position </td> 
<td style="border-bottom: 0.5pt solid ; "> Value</td> </tr></thead> 
<tbody> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="simpara_id1">0</p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="simpara_id2">5</p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="simpara_id3">1</p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="simpara_id4">10</p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="simpara_id5">2</p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="simpara_id6">15</p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="simpara_id7">3</p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="simpara_id8">20</p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; ">
<p id="simpara_id9">4</p></td> 
<td>
<p id="simpara_id10">25</p></td> </tr> </tbody> </table></div> 
<p id="arrays_can_cont">Arrays can contain any type of data, not just integers:</p> 
<pre class="programlisting" data-language="javascript" id="var_percentages"><code class="kd">var</code> <code class="nx">percentages</code> <code class="o">=</code> <code class="p">[</code> <code class="mf">0.55</code><code class="p">,</code> <code class="mf">0.32</code><code class="p">,</code> <code class="mf">0.91</code> <code class="p">];</code> <code class="kd">var</code> <code class="nx">names</code> <code class="o">=</code> <code class="p">[</code> <code class="s2">"Ernie"</code><code class="p">,</code> <code class="s2">"Bert"</code><code class="p">,</code> <code class="s2">"Oscar"</code> <code class="p">];</code>  <code class="nx">percentages</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>  <code class="c1">//Returns 0.32</code> <code class="nx">names</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>        <code class="c1">//Returns "Bert"</code></pre> 
<p id="although_i_don">Although I don’t recommend it, different types of values can even be stored within the same array:</p> 
<pre class="programlisting" data-language="javascript" id="var_mishmash__"><code class="kd">var</code> <code class="nx">mishmash</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mf">4.5</code><code class="p">,</code> <code class="mf">5.6</code><code class="p">,</code> <code class="s2">"oh boy"</code><code class="p">,</code> <code class="s2">"say it isn't"</code><code class="p">,</code> <code class="kc">true</code> <code class="p">];</code></pre> </div> 
<div class="sect2" id="_objects"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Objects</h3></div></div></div> 
<p id="arrays_are_grea">Arrays are great for simple lists of values, but with more complex datasets, you’ll want to put your data into an object. For our purposes, think of a JavaScript object as a custom data structure. We use curly brackets <code class="literal">{}</code> to indicate an object. In between the brackets, we include

<a id="id491168" class="indexterm"></a>

<a id="id491173" class="indexterm"></a>

<a id="id491179" class="indexterm"></a>

<a id="id491187" class="indexterm"></a> 
<span class="emphasis">
<em>properties</em></span> and 
<span class="emphasis">
<em>values</em></span>. A colon <code class="literal">:</code> separates each property and its value, and a comma separates each property/value pair:</p> 
<pre class="programlisting" data-language="javascript" id="var_fruit___k"><code class="kd">var</code> <code class="nx">fruit</code> <code class="o">=</code> <code class="p">{</code>     <code class="nx">kind</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>     <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>     <code class="nx">quantity</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>     <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code></pre> 
<p id="to_reference_ea">To reference each value, we use 
<span class="emphasis">
<em>dot notation</em></span>, specifying the name of the property:</p> 
<pre class="programlisting" data-language="javascript" id="fruitkind_re"><code class="nx">fruit</code><code class="p">.</code><code class="nx">kind</code>      <code class="c1">//Returns "grape"</code> <code class="nx">fruit</code><code class="p">.</code><code class="nx">color</code>     <code class="c1">//Returns "red"</code> <code class="nx">fruit</code><code class="p">.</code><code class="nx">quantity</code>  <code class="c1">//Returns 12</code> <code class="nx">fruit</code><code class="p">.</code><code class="nx">tasty</code>     <code class="c1">//Returns true</code></pre> 
<p id="think_of_the_va">Think of the value as “belonging” to the object. Oh, look, some fruit. “What kind of fruit is that?” you might ask. As it turns out, <code class="literal">fruit.kind</code> is <code class="literal">"grape"</code>. “Are they tasty?” Oh, definitely, because <code class="literal">fruit.tasty</code> is <code class="literal">true</code>.</p> </div> 
<div class="sect2" id="_objects_and_arrays"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Objects and Arrays</h3></div></div></div> 
<p id="you_can_combine">You can combine these two structures to create arrays of objects, or objects of arrays, or objects of objects or, well, basically whatever structure makes sense for your dataset.

<a id="id491462" class="indexterm"></a>

<a id="id491470" class="indexterm"></a></p> 
<p id="lets_say_we_ha">Let’s say we have acquired a couple more pieces of fruit, and we want to expand our catalog accordingly. We use hard brackets <code class="literal">[]</code> on the outside, to indicate an array, followed by curly brackets <code class="literal">{}</code> and object notation on the inside, with each object separated by a comma:</p> 
<pre class="programlisting" data-language="javascript" id="var_fruits___"><code class="kd">var</code> <code class="nx">fruits</code> <code class="o">=</code> <code class="p">[</code>     <code class="p">{</code>         <code class="nx">kind</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>         <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>         <code class="nx">quantity</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>         <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code>     <code class="p">},</code>     <code class="p">{</code>         <code class="nx">kind</code><code class="o">:</code> <code class="s2">"kiwi"</code><code class="p">,</code>         <code class="nx">color</code><code class="o">:</code> <code class="s2">"brown"</code><code class="p">,</code>         <code class="nx">quantity</code><code class="o">:</code> <code class="mi">98</code><code class="p">,</code>         <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code>     <code class="p">},</code>     <code class="p">{</code>         <code class="nx">kind</code><code class="o">:</code> <code class="s2">"banana"</code><code class="p">,</code>         <code class="nx">color</code><code class="o">:</code> <code class="s2">"yellow"</code><code class="p">,</code>         <code class="nx">quantity</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>         <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code>     <code class="p">}</code> <code class="p">];</code></pre> 
<p id="to_access_this_">To access this data, we just follow the trail of properties down to the values we want. Remember, <code class="literal">[]</code> means array, and <code class="literal">{}</code> means object. <code class="literal">fruits</code> is an array, so first we use bracket notation to specify an array index:</p> 
<pre class="programlisting" data-language="javascript" id="fruits"><code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code></pre> 
<p id="next_each_arra">Next, each array element is an object, so just tack on a dot and a property:</p> 
<pre class="programlisting" data-language="javascript" id="fruitsquant"><code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">quantity</code>   <code class="c1">//Returns 98</code></pre> 
<p id="heres_a_map_of">Here’s a map of how to access every value in the <code class="literal">fruits</code> array of objects:</p> 
<pre class="programlisting" data-language="javascript" id="fruitskind_"><code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">kind</code>      <code class="o">==</code>  <code class="s2">"grape"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">color</code>     <code class="o">==</code>  <code class="s2">"red"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">quantity</code>  <code class="o">==</code>  <code class="mi">12</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">tasty</code>     <code class="o">==</code>  <code class="kc">true</code>  <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">kind</code>      <code class="o">==</code>  <code class="s2">"kiwi"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">color</code>     <code class="o">==</code>  <code class="s2">"brown"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">quantity</code>  <code class="o">==</code>  <code class="mi">98</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">tasty</code>     <code class="o">==</code>  <code class="kc">true</code>  <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">kind</code>      <code class="o">==</code>  <code class="s2">"banana"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">color</code>     <code class="o">==</code>  <code class="s2">"yellow"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">quantity</code>  <code class="o">==</code>  <code class="mi">0</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">tasty</code>     <code class="o">==</code>  <code class="kc">true</code></pre> 
<p id="yes_thats_rig">Yes, that’s right, we have <code class="literal">fruits[2].quantity</code> bananas.</p> 
<div class="sect3" id="_json"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">JSON</h4></div></div></div> 
<p id="at_some_point_i">At some point in your D3 career, you will encounter JavaScript Object Notation. You can 

<a class="ulink" href="http://en.wikipedia.org/wiki/Json" target="_top">read up on the details</a>, but JSON is basically a specific syntax for organizing data as JavaScript objects. The syntax is optimized for use with JavaScript (obviously) and AJAX requests, which is why you’ll see a lot of 
<span class="keep-together">web-based</span> application programming interfaces (APIs) that return data formatted as JSON. It’s faster and easier to parse with JavaScript than XML, and of course D3 works well with it.

<a id="id492336" class="indexterm"></a>

<a id="id492344" class="indexterm"></a></p> 
<p id="all_that_and_i">All that, and it doesn’t look much weirder than what we’ve already seen:</p> 
<pre class="programlisting" data-language="javascript" id="kind_grap"><code class="p">{</code>     <code class="s2">"kind"</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>     <code class="s2">"color"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>     <code class="s2">"quantity"</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>     <code class="s2">"tasty"</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code></pre> 
<p id="the_only_differ">The only difference here is that our property names are now surrounded by double quotation marks <code class="literal">""</code>, making them string values.</p> 
<p id="json_objects_l">JSON objects, like all other JavaScript objects, can of course be stored in variables like so:</p> 
<pre class="programlisting" data-language="javascript" id="var_jsonfruit_"><code class="kd">var</code> <code class="nx">jsonFruit</code> <code class="o">=</code> <code class="p">{</code>     <code class="s2">"kind"</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>     <code class="s2">"color"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>     <code class="s2">"quantity"</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>     <code class="s2">"tasty"</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code></pre> </div> 
<div class="sect3" id="_geojson"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">GeoJSON</h4></div></div></div> 
<p id="just_as_json_is">Just as JSON is just a formalization of existing JavaScript object syntax, 
<span class="keep-together">GeoJSON</span> is a formalized syntax of JSON objects, optimized for storing geodata. All GeoJSON object are JSON objects, and all JSON objects are JavaScript objects.

<a id="id492597" class="indexterm"></a>

<a id="id492606" class="indexterm"></a></p> 
<p id="geojson_can_sto">

<a class="ulink" href="http://geojson.org/geojson-spec.html" target="_top">GeoJSON</a> can store points in geographical space (typically as longitude/latitude coordinates), but also shapes (such as lines and polygons) and other spatial features. If you have a lot of geodata, it’s worth it to parse it into GeoJSON format for best use with D3.</p> 
<p id="well_get_into_">We’ll get into the details of GeoJSON when we talk about geomaps, but for now, just know that this is what simple GeoJSON data could look like the following:</p> 
<pre class="programlisting" data-language="javascript" id="type_feat_id1"><code class="p">{</code>     <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"FeatureCollection"</code><code class="p">,</code>     <code class="s2">"features"</code><code class="o">:</code> <code class="p">[</code>         <code class="p">{</code>             <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code>             <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code>                 <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Point"</code><code class="p">,</code>                 <code class="s2">"coordinates"</code><code class="o">:</code> <code class="p">[</code> <code class="mf">150.1282427</code><code class="p">,</code> <code class="o">-</code><code class="mf">24.471803</code> <code class="p">]</code>             <code class="p">},</code>             <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code>                 <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"town"</code>             <code class="p">}</code>         <code class="p">}</code>     <code class="p">]</code> <code class="p">}</code></pre> 
<p id="confusingly_lo">Confusingly, longitude is always listed before latitude. Get used to thinking in terms of lon/lat instead of lat/lon.</p> </div> </div> 
<div class="sect2" id="_mathematical_operators"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Mathematical Operators</h3></div></div></div> 
<p id="you_can_add_su">You can add, subtract, multiply, and divide values using the following

<a id="id492857" class="indexterm"></a>

<a id="id492864" class="indexterm"></a> operators, 
<span class="keep-together">respectively</span>:</p> 
<pre class="screen" id="add__sub">+   //Add -   //Subtract *   //Multiply /   //Divide</pre> 
<p id="for_example_ty">For example, type <code class="literal">8 * 2</code> into the console, press Enter, and you should see <code class="literal">16</code>. More examples:</p> 
<pre class="programlisting" data-language="javascript" id="__returns"><code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code>       <code class="c1">//Returns 3</code> <code class="mi">10</code> <code class="o">-</code> <code class="mf">0.5</code>    <code class="c1">//Retuns 9.5</code> <code class="mi">33</code> <code class="o">*</code> <code class="mi">3</code>      <code class="c1">//Returns 99</code> <code class="mi">3</code> <code class="o">/</code> <code class="mi">4</code>       <code class="c1">//Returns 0.75</code></pre> </div> 
<div class="sect2" id="_comparison_operators"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Comparison Operators</h3></div></div></div> 
<p id="you_can_compare">You can compare values against each other using the following

<a id="id493012" class="indexterm"></a>

<a id="id493020" class="indexterm"></a> operators:</p> 
<pre class="programlisting" data-language="javascript" id="equal_to_"><code class="o">==</code>  <code class="c1">//Equal to</code> <code class="o">!=</code>  <code class="c1">//Not equal to</code> <code class="o">&lt;</code>   <code class="c1">//Less than</code> <code class="o">&gt;</code>   <code class="c1">//Greater than</code> <code class="o">&lt;=</code>  <code class="c1">//Less than or equal to</code> <code class="o">&gt;=</code>  <code class="c1">//Greater than or equal to</code></pre> 
<p id="these_all_compa">These all compare some value on the left to some value on the right. If the result is true, then <code class="literal">true</code> is returned. If the result is false, <code class="literal">false</code> is returned.</p> 
<p id="try_it_type_ea">Try it! Type each of the following into the console and see what you get:</p> 
<pre class="programlisting" data-language="javascript" id="______id1"><code class="mi">3</code> <code class="o">==</code> <code class="mi">3</code> <code class="mi">3</code> <code class="o">==</code> <code class="mi">5</code> <code class="mi">3</code> <code class="o">&gt;=</code> <code class="mi">3</code> <code class="mi">3</code> <code class="o">&gt;=</code> <code class="mi">2</code> <code class="mi">100</code> <code class="o">&lt;</code> <code class="mi">2</code> <code class="mi">298</code> <code class="o">!=</code> <code class="mi">298</code></pre> 
<div class="sidebar online_only" id="interactive_3-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="type_the_follow_id2">Type the following commands into the console below, and hit Enter to see the results</p> 
<div class="itemizedlist" id="______id2">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">3 == 3</code> </li> 
<li class="listitem"> <code class="literal">3 == 5</code> </li> 
<li class="listitem"> <code class="literal">3 &gt;= 3</code> </li> 
<li class="listitem"> <code class="literal">3 &gt;= 2</code> </li> 
<li class="listitem"> <code class="literal">100 &lt; 2</code> </li> 
<li class="listitem"> <code class="literal">298 != 298</code> </li> </ul></div> 
<div class="interactive">

<p id="javascript_als">(JavaScript also offers the <code class="literal">===</code> and <code class="literal">!==</code> operators, which perform equality comparisons without type coercion, but I won’t be addressing that distinction in this book.)</p> </div> 
<div class="sect2" id="_control_structures"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Control Structures</h3></div></div></div> 
<p id="whenever_your_c">Whenever your code needs to make a decision or repeat something, you need a control structure. There are lots to choose from, but we are primarily interested in <code class="literal">if</code> statements and <code class="literal">for</code> loops.

<a id="id493381" class="indexterm"></a>

<a id="id493389" class="indexterm"></a>

<a id="id493395" class="indexterm"></a></p> 
<div class="sect3" id="_if_only"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">if() only</h4></div></div></div> 
<p id="an_if_statement">An <code class="literal">if</code> statement uses comparison operators to determine if a statement is true or false:</p> 
<pre class="programlisting" data-language="javascript" id="if_test__c"><code class="k">if</code> <code class="p">(</code><code class="nx">test</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Code to run if true</code> <code class="p">}</code></pre> 
<p id="if_the_test_bet">If the test between parentheses is <code class="literal">true</code>, then the code between the curly brackets is run. If the test turns up <code class="literal">false</code>, then the bracketed code is ignored, and life goes on. (Technically, life goes on either way.)</p> 
<pre class="programlisting" data-language="javascript" id="if_____co"><code class="k">if</code> <code class="p">(</code><code class="mi">3</code> <code class="o">&lt;</code> <code class="mi">5</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Eureka! Three is less than five!"</code><code class="p">);</code> <code class="p">}</code></pre> 
<p id="in_the_precedin">In the preceding example, the bracketed code will always be executed, because <code class="literal">3 &lt; 5</code> is always true. <code class="literal">if</code> statements are more useful when comparing variables or other conditions that change.</p> 
<pre class="programlisting" data-language="javascript" id="if_somevalue_"><code class="k">if</code> <code class="p">(</code><code class="nx">someValue</code> <code class="o">&lt;</code> <code class="nx">anotherValue</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Set someValue to anotherValue, thereby restoring</code>     <code class="c1">//a sense of balance and equilibrium to the world.</code>     <code class="nx">someValue</code> <code class="o">=</code> <code class="nx">anotherValue</code><code class="p">;</code> <code class="p">}</code></pre> </div> 
<div class="sect3" id="_for_now"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">for() now</h4></div></div></div> 
<p id="you_can_use_for">You can use <code class="literal">for</code> loops to repeatedly execute the same code, with slight

<a id="id493677" class="indexterm"></a> variations. A <code class="literal">for</code> loop uses this syntax:</p> 
<pre class="programlisting" data-language="javascript" id="for_initializa"><code class="k">for</code> <code class="p">(</code><code class="nx">initialization</code><code class="p">;</code> <code class="nx">test</code><code class="p">;</code> <code class="nx">update</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Code to run each time through the loop</code> <code class="p">}</code></pre> 
<p id="they_are_socal">They are so-called because they loop through the code 
<span class="emphasis">
<em>for</em></span> as many times as specified. First, the initialization statement is run. Then, the test is evaluated, like a mini <code class="literal">if</code> statement. If the test is true, then the bracketed code is run. Finally, the <code class="literal">update</code> statement is run, and the test is reevaluated.</p> 
<p id="the_most_common">The most common application of a <code class="literal">for</code> loop is to increase some variable by 1 each time through the loop. The test statement can then control how many times the loop is run by referencing that value. (The variable is often named <code class="literal">i</code>, purely by convention, because it is short and easy to type.)</p> 
<pre class="programlisting" data-language="javascript" id="for_var_i__"><code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">5</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>  <code class="c1">//Prints value to console</code> <code class="p">}</code></pre> 
<p id="the_preceding_f">The preceding <code class="literal">for</code> loop prints the following to the console:</p> 
<pre class="screen" id="____id1">0 1 2 3 4</pre> 
<p id="the_first_time_">The first time through, a variable named <code class="literal">i</code> is declared and set to zero. <code class="literal">i</code> is less than five, so the bracketed code is run, printing the current value of <code class="literal">i</code> (zero) to the console. Finally, the value of <code class="literal">i</code> is increased by one. (<code class="literal">i++</code> is shorthand for <code class="literal">i = i + 1</code>.) So now <code class="literal">i</code> is <code class="literal">1</code>, so the test again evaluates as true, the bracketed code is run again, but this time the value printed to the console is 1.</p> 
<p id="as_you_can_see_id1">As you can see, reading prose descriptions of loops is about as interesting as executing them by hand yourself. This is why we invented computers. So I’ll skip to the end and point out that after the final iteration, <code class="literal">i</code> is increased to 5, after which the test returns false, and the loop is over.</p> 
<p id="its_important__id1">It’s important to note that counting began at zero, and not one. That is, the “first” value of <code class="literal">i</code> was <code class="literal">0</code>. Why not <code class="literal">1</code>? This is another arbitrary convention, but it nicely parallels how computers count arrays of values.</p> </div> 
<div class="sect3" id="_what_arrays_are_made_for"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">What arrays are made for()</h4></div></div></div> 
<p id="codebased_data">Code-based data visualization would not be possible without arrays and the mighty <code class="literal">for()</code> loop. Together, they form a data geek’s dynamic duo. (If you do not consider yourself a “data geek,” then may I remind you that you are reading a book titled 
<span class="emphasis">
<em>Interactive Data Visualization for the Web</em></span>?)

<a id="id494059" class="indexterm"></a>

<a id="id494067" class="indexterm"></a></p> 
<p id="an_array_organi">An array organizes lots of data values in one convenient place. Then <code class="literal">for()</code> can quickly “loop” through every value in an array and perform some action with it—such as, express the value as a visual form. D3 often manages this looping for us, such as with its magical <code class="literal">data()</code> method.</p> 
<p id="note_this_examp">Note this example, which loops through each of the values in an array called <code class="literal">numbers</code>:</p> 
<pre class="programlisting" data-language="javascript" id="var_numbers___id2"><code class="kd">var</code> <code class="nx">numbers</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">100</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">98</code><code class="p">,</code> <code class="mi">99</code><code class="p">,</code> <code class="mi">45</code> <code class="p">];</code>  <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numbers</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">numbers</code><code class="p">[</code><code class="nx">i</code><code class="p">]);</code>  <code class="c1">//Print value to console</code> <code class="p">}</code></pre> 
<p id="see_that_number">See that <code class="literal">numbers.length</code>? That’s the beautiful part. <code class="literal">length</code> is a property of every array. In this case, <code class="literal">numbers</code> contains six values, so <code class="literal">numbers.length</code> resolves to <code class="literal">6</code>, and the loop runs six times. If <code class="literal">numbers</code> were 10 positions long, the loop would run 10 times. If it were 10 million positions long … yeah, you get it. This is what computers are good at: taking a set of instructions and executing them over and over. And this is at the heart of why data visualization can be so rewarding—you design and code the visualization system, and the system will respond appropriately, even as you feed it different data. The system’s mapping rules are consistent, even when the data is not.</p> </div> </div> 
<div class="sect2" id="_functions"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Functions</h3></div></div></div> 
<p id="functions_are_c">Functions are chunks of code that do things.</p> 
<p id="more_specifical">More specifically, functions are special because they can take arguments or parameters as input, and then return values as output. Parentheses are used to 
<span class="emphasis">
<em>call</em></span> (execute) a function. If that function requires any arguments (input values), then they are 
<span class="emphasis">
<em>passed</em></span> to the function by including them in the parentheses.

<a id="id494401" class="indexterm"></a>

<a id="id494409" class="indexterm"></a>

<a id="id494417" class="indexterm"></a></p> 
<p id="whenever_you_se">Whenever you see something like the following code, you know it’s a function:</p> 
<pre class="programlisting" data-language="javascript" id="calculategratui_id1"><code class="nx">calculateGratuity</code><code class="p">(</code><code class="mi">38</code><code class="p">);</code></pre> 
<p id="in_fact_youve">In fact, you’ve already seen functions at work with <code class="literal">console.log</code>, as in the following:</p> 
<pre class="programlisting" data-language="javascript" id="consoleloglo"><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Look at me. I can do stuff!"</code><code class="p">);</code></pre> 
<p id="but_the_best_pa">But the best part about functions is that you can define your own. There are several ways to define functions in JavaScript, but here’s the simplest, which I’ll use throughout this book:</p> 
<pre class="programlisting" data-language="javascript" id="var_calculategr"><code class="kd">var</code> <code class="nx">calculateGratuity</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">bill</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">bill</code> <code class="o">*</code> <code class="mf">0.2</code><code class="p">;</code> <code class="p">};</code></pre> 
<p id="this_declares_a">This declares a new variable named <code class="literal">calculateGratuity</code>. Then, instead of assigning a simple number or string, we store an entire function in the variable. In the parentheses, we name <code class="literal">bill</code>, another variable to be used only by the function itself. <code class="literal">bill</code> is the expected input. When called, the function will take that input, multiply it by <code class="literal">0.2</code>, and 
<span class="emphasis">
<em>return</em></span> the result as its output.</p> 
<p id="so_now_if_we_ca">So now if we call:</p> 
<pre class="programlisting" data-language="javascript" id="calculategratui_id2"><code class="nx">calculateGratuity</code><code class="p">(</code><code class="mi">38</code><code class="p">);</code></pre> 
<p id="the_function_re">the function returns 7.6. Not bad—a 20 percent tip!</p> 
<p id="of_course_you__id1">Of course, you could store the output to use it elsewhere later, as in:</p> 
<pre class="programlisting" data-language="javascript" id="var_tip__calcu"><code class="kd">var</code> <code class="nx">tip</code> <code class="o">=</code> <code class="nx">calculateGratuity</code><code class="p">(</code><code class="mi">38</code><code class="p">);</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tip</code><code class="p">);</code>  <code class="c1">//Prints 7.6 to the console</code></pre> 
<p id="there_are_also_">There are also 
<span class="emphasis">
<em>anonymous</em></span> functions that, unlike <code class="literal">calculateGratuity</code>, don’t have names. Anonymous functions are used all the time with D3, but I’ll introduce them later.

<a id="id494768" class="indexterm"></a>

<a id="id494774" class="indexterm"></a></p> </div> 
<div class="sect2" id="_comments_3"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Comments</h3></div></div></div> 
<pre class="programlisting" data-language="javascript" id="javascript_s"><code class="cm">/* JavaScript supports CSS-style comments like this. */</code>  <code class="c1">// But double-slashes can be used as well.</code> <code class="c1">// Anything following // on the same line will be ignored.</code> <code class="c1">// This is helpful for including brief notes to yourself</code> <code class="c1">// as to what each line of code does, as in:</code>  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Brilliant"</code><code class="p">);</code>  <code class="c1">//Prints "Brilliant" to the console</code></pre> </div> 
<div class="sect2" id="_referencing_scripts"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Referencing Scripts</h3></div></div></div> 
<p id="scripts_can_be_">Scripts can be included directly in HTML, between two <code class="literal">script</code> tags, as 

<a id="id494879" class="indexterm"></a>

<a id="id494887" class="indexterm"></a>in:</p> 
<pre class="programlisting" data-language="html" id="body_script_"><code class="nt">&lt;body&gt;</code>     <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">&gt;</code>         <code class="nx">alert</code><code class="p">(</code><code class="s2">"Hello, world!"</code><code class="p">);</code>     <code class="nt">&lt;/script&gt;</code> <code class="nt">&lt;/body&gt;</code></pre> 
<p id="or_stored_in_a_">or stored in a separate file with a 
<span class="emphasis">
<em>.js</em></span> suffix, and then referenced somewhere in the HTML (could be in the <code class="literal">head</code>, as shown here, or also just before the end of the closing <code class="literal">body</code> tag):</p> 
<pre class="programlisting" data-language="html" id="head_titlep"><code class="nt">&lt;head&gt;</code>     <code class="nt">&lt;title&gt;</code>Page Title<code class="nt">&lt;/title&gt;</code>     <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code> <code class="na">src=</code><code class="s">"myscript.js"</code><code class="nt">&gt;&lt;/script&gt;</code> <code class="nt">&lt;/head&gt;</code></pre> </div> 
<div class="sect2" id="_javascript_gotchas"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">JavaScript Gotchas</h3></div></div></div> 
<p id="as_a_bonus_and">As a bonus, and at no extra charge, I would like to share with you my top four JavaScript gotchas: things that, had I known earlier, would have saved me many hours of late-night debugging sessions, anxiety-induced panic, and increased cortisol levels. You might want to come back and reference this section later.

<a id="id495055" class="indexterm"></a>

<a id="id495063" class="indexterm"></a></p> 
<div class="sect3" id="_dynamic_typing"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Dynamic typing</h4></div></div></div> 
<p id="i_do_love_how_y">I do love how your fingers flutter across the keyboard, but that’s not what I’m talking about. No, JavaScript is a 
<span class="emphasis">
<em>loosely typed</em></span> language, meaning you don’t have to specify what 
<span class="emphasis">
<em>type</em></span> of information will be stored in a variable in advance. Many other languages, like Java (which is completely different from Java
<span class="emphasis">
<em>Script</em></span>), require you to declare a variable’s type, such as <code class="literal">int</code>, <code class="literal">float</code>, <code class="literal">boolean</code>, or <code class="literal">String</code>:</p> 
<pre class="programlisting" data-language="java" id="declaring_var_id1"><code class="c1">//Declaring variables in Java</code> <code class="kt">int</code> <code class="n">number</code> <code class="o">=</code> <code class="mi">5</code><code class="o">;</code> <code class="kt">float</code> <code class="n">value</code> <code class="o">=</code> <code class="mf">12.3467</code><code class="o">;</code> <code class="kt">boolean</code> <code class="n">active</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code> <code class="n">String</code> <code class="n">text</code> <code class="o">=</code> <code class="s">"Crystal clear"</code><code class="o">;</code></pre> 
<p id="javascript_how">JavaScript, however, automatically 
<span class="emphasis">
<em>types</em></span> a variable based on what kind of information you assign to it. (Note that <code class="literal">''</code> or <code class="literal">""</code> indicate string values. I prefer double quotation marks <code class="literal">""</code>, but some people like singles <code class="literal">''</code>.)</p> 
<pre class="programlisting" data-language="javascript" id="declaring_var_id2"><code class="c1">//Declaring variables in JavaScript</code> <code class="kd">var</code> <code class="nx">number</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">value</code> <code class="o">=</code> <code class="mf">12.3467</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">active</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">text</code> <code class="o">=</code> <code class="s2">"Crystal clear"</code><code class="p">;</code></pre> 
<p id="how_boringvar">How boring—<code class="literal">var</code>, <code class="literal">var</code>, <code class="literal">var</code>, <code class="literal">var</code>!—yet handy, as we can declare and name variables before we even know what type of data will go into them. You can even change a variable’s type on-the-fly without JavaScript freaking out on you:</p> 
<pre class="programlisting" data-language="javascript" id="var_value__"><code class="kd">var</code> <code class="nx">value</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="mf">99.9999</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="s2">"This can't possibly work."</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="s2">"Argh, it does work! No errorzzzz!"</code><code class="p">;</code></pre> 
<p id="i_mention_this_">I mention this because one day a numeric value will be accidentally stored as a string, and it will cause some part of your code to behave strangely, and basically I don’t want you to come crying to me when that happens. Thus, know that whenever a variable’s type is in doubt, you can

<a id="id495546" class="indexterm"></a> employ the <code class="literal">typeof</code> operator:</p> 
<pre class="programlisting" data-language="javascript" id="typeof__re"><code class="k">typeof</code> <code class="mi">67</code><code class="p">;</code>              <code class="c1">//Returns "number"</code> <code class="kd">var</code> <code class="nx">myName</code> <code class="o">=</code> <code class="s2">"Scott"</code><code class="p">;</code> <code class="k">typeof</code> <code class="nx">myName</code><code class="p">;</code>          <code class="c1">//Returns "string"</code> <code class="nx">myName</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code> <code class="k">typeof</code> <code class="nx">myName</code><code class="p">;</code>          <code class="c1">//Returns "boolean"</code></pre> </div> 
<div class="sect3" id="_variable_hoisting"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Variable hoisting</h4></div></div></div> 
<p id="contrary_to_wha_id1">Contrary to what you would expect, JavaScript code is usually, but not always, executed in linear, top-to-bottom order. For example, in this code, when would you expect the variable <code class="literal">i</code> to be established?

<a id="id495695" class="indexterm"></a>

<a id="id495703" class="indexterm"></a></p> 
<pre class="programlisting" data-language="javascript" id="var_numloops___id1"><code class="kd">var</code> <code class="nx">numLoops</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numLoops</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code> <code class="p">}</code></pre> 
<p id="in_many_other_l">In many other languages, <code class="literal">i</code> would be declared right when the <code class="literal">for</code> loop begins, as you’d expect. But thanks to a phenomenon known as 
<span class="emphasis">
<em>variable hoisting</em></span>, in JavaScript, variable declarations are 
<span class="emphasis">
<em>hoisted</em></span> up to the top of the function context in which they reside. So in our example, <code class="literal">i</code> is actually declared 
<span class="emphasis">
<em>before</em></span> the <code class="literal">for</code> loop even begins. The following is equivalent:</p> 
<pre class="programlisting" data-language="javascript" id="var_numloops___id2"><code class="kd">var</code> <code class="nx">numLoops</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">i</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numLoops</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code> <code class="p">}</code></pre> 
<p id="this_can_be_pro">This can be problematic when you have conflicting variable names, as a variable that you thought existed only later in the code is actually present right at the beginning.</p> </div> 
<div class="sect3" id="_function_level_scope"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Function-level scope</h4></div></div></div> 
<p id="in_programming">In programming, the concept of 
<span class="emphasis">
<em>variable scope</em></span> helps us identify which variables are accessible in which contexts. Generally, it is a bad idea to have every value accessible from everywhere else because you’d end up with so many conflicts and accidental value changes that you would just go crazy.

<a id="id496066" class="indexterm"></a>

<a id="id496074" class="indexterm"></a>

<a id="id496080" class="indexterm"></a></p> 
<p id="many_languages_">Many languages use 
<span class="emphasis">
<em>block-level scope</em></span>, in which variables exist only within the current “block” of code, usually indicated by curly braces. With block-level scope, our <code class="literal">i</code> would exist only within the context of the <code class="literal">for</code> loop, for example, so any attempts to read the value of <code class="literal">i</code> or change <code class="literal">i</code> outside of the loop would fail. This is nice because you could establish other variables from within your loop and know that they wouldn’t conflict with variables that exist elsewhere.

<a id="id496124" class="indexterm"></a></p> 
<p id="in_javascript__id1">In JavaScript, however, variables are scoped at the function level, meaning they are accessible anywhere within the 
<span class="emphasis">
<em>function</em></span> (not block) in which they reside.</p> 
<p id="this_is_primari">This is primarily something to be aware of if you’re used to other languages. Bottom line: You can keep values contained by wrapping them within functions.</p> </div> 
<div class="sect3" id="_global_namespace"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Global namespace</h4></div></div></div> 
<p id="speaking_of_var">Speaking of variable conflicts, please do me a favor: open any web page, activate the JavaScript console, type 
<span class="strong">
<strong><code class="literal">window</code></strong></span>, and click the gray disclosure triangle to view its 
<span class="keep-together">contents</span>.

<a id="id496179" class="indexterm"></a>

<a id="id496188" class="indexterm"></a></p> 
<p id="i_know_it_feels">I know it feels like you just entered the matrix, but this is actually called “the global namespace,” which might sound even cooler (see 

<a class="xref" href="#The_global_namespace" title="Figure 3-10. The global namespace">Figure 3-10</a>).</p> 
<div class="figure" id="The_global_namespace"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0310.png" alt="The global namespace"></div></div> 
<div class="figure-title">Figure 3-10. The global namespace</div> </div> 
<p id="window_is_the_t"><code class="literal">window</code> is the topmost object in the browser’s hierarchy of JavaScript elements, and all of these objects and values you see beneath <code class="literal">window</code> exist at the 
<span class="emphasis">
<em>global</em></span> level. What this means is that every time you declare a new variable, you are adding a new value to <code class="literal">window</code>. Or, as righteous JavaScript coders like to say, you are polluting the global 
<span class="keep-together">namespace</span>. (Surprisingly, most people who write things like this in online forums are actually quite friendly in person.)</p> 
<p id="for_example_tr">For example, try typing this into the console: 
<span class="strong">
<strong><code class="literal">var zebras = "amazing"</code></strong></span>.</p> 
<p id="then_type_windo">Then type 
<span class="strong">
<strong><code class="literal">window</code></strong></span> again, and scroll all the way down to the bottom, where you should now see <code class="literal">zebras</code>, as shown in 

<a class="xref" href="#The_global_namespace_now_with_zebras" title="Figure 3-11. The global namespace, now with zebras">Figure 3-11</a>.</p> 
<div class="figure" id="The_global_namespace_now_with_zebras"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0311.png" alt="The global namespace, now with zebras"></div></div> 
<div class="figure-title">Figure 3-11. The global namespace, now with zebras</div> </div> 
<p id="confusingly_i">(Confusingly, it is also possible to define new variables in JavaScript without using the standard <code class="literal">var</code> declaration, so typing simply 
<span class="strong">
<strong><code class="literal">zebras = "amazing"</code></strong></span> would have the same effect as that shown.)</p> 
<p id="whats_so_wrong">What’s so wrong with adding values to <code class="literal">window</code>? As you get started, nothing at all. But as your projects grow in complexity, and especially if you begin to incorporate other non-D3 JavaScript code (such as jQuery, Facebook “Like” buttons, or Google Analytics tracking code), at some point you’re bound to run into a conflict because you’re using the variable <code class="literal">zebras</code> for your project, but zebraTracker.js is 
<span class="emphasis">
<em>also</em></span> using a variable with the same name! The result: chaos. Or at least some bad data, which could lead to unexpected behavior or errors.</p> 
<p id="there_are_two_e">There are two easy workarounds (and, to clarify, you probably don’t have to worry about this until later):

<a id="id496382" class="indexterm"></a></p> 
<div class="itemizedlist" id="declare_variabl_id1">
<ul class="itemizedlist"> 
<li class="listitem"> Declare variables only within other functions. This is not usually feasible, but the function-level scope will prevent local variables from conflicting with others. </li> 
<li class="listitem"> Declare a single global object, and attach all of your would-be global variables to that object. For example: </li> </ul></div> 
<pre class="programlisting" data-language="javascript" id="var_vis___"><code class="kd">var</code> <code class="nx">Vis</code> <code class="o">=</code> <code class="p">{};</code>  <code class="c1">//Declare empty global object</code> <code class="nx">Vis</code><code class="p">.</code><code class="nx">zebras</code> <code class="o">=</code> <code class="s2">"still pretty amazing"</code><code class="p">;</code> <code class="nx">Vis</code><code class="p">.</code><code class="nx">monkeys</code> <code class="o">=</code> <code class="s2">"too funny LOL"</code><code class="p">;</code> <code class="nx">Vis</code><code class="p">.</code><code class="nx">fish</code> <code class="o">=</code> <code class="s2">"you know, not bad"</code><code class="p">;</code></pre> 
<p id="all_of_your_wei">All of your weird animal-related variables are no longer polluting the global namespace, but instead they all exist as values stored within your single, global object, <code class="literal">Vis</code>. Of course, <code class="literal">Vis</code> could be named whatever you like, but <code class="literal">Menagerie</code> is harder to type. Regardless, the only naming conflict you’ll have with other scripts is if one of them 
<span class="emphasis">
<em>also</em></span> wants to have a global object with the same name (<code class="literal">Vis</code>), which is far less likely.

<a id="id496566" class="indexterm"></a></p> </div> </div> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="SVG_3"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">SVG</h2></div></div></div> 
<p id="d_is_most_usef">D3 is most useful when used to generate and manipulate visuals as Scalable Vector Graphics (SVG). Drawing with <code class="literal">div</code>s and other native HTML elements is possible, but a bit clunky and subject to the usual inconsistencies across different browsers. Using SVG is more reliable, visually consistent, and faster.

<a id="ix_SVG" class="indexterm"></a></p> 
<p id="shows_a_small_c">

<a class="xref" href="#A_small_SVG_circle" title="Figure 3-12. A small SVG circle">Figure 3-12</a> shows a small circle, and its SVG code follows.</p> 
<div class="figure" id="A_small_SVG_circle"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0312.png" alt="A small SVG circle"></div></div> 
<div class="figure-title">Figure 3-12. A small SVG circle</div> </div> 
<pre class="programlisting" data-language="html" id="svg_width_id1"><code class="nt">&lt;svg</code> <code class="na">width=</code><code class="s">"50"</code> <code class="na">height=</code><code class="s">"50"</code><code class="nt">&gt;</code>     <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"22"</code> <code class="na">fill=</code><code class="s">"blue"</code> <code class="na">stroke=</code><code class="s">"gray"</code> <code class="na">stroke-width=</code><code class="s">"2"</code><code class="nt">/&gt;</code> <code class="nt">&lt;/svg&gt;</code></pre> 
<p id="vector_drawing_">Vector drawing software like Illustrator can be used to generate SVG files, but we need to learn how to generate them with code.</p> 
<div class="sect2" id="_the_svg_element"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">The SVG Element</h3></div></div></div> 
<p id="svg_is_a_textb">SVG is a text-based image format. Each SVG image is defined using markup code similar to HTML, and SVG code can be included directly within any HTML document, or inserted dynamically into the DOM. Every web browser supports SVG 
<span class="emphasis">
<em>except</em></span> 

<a class="ulink" href="http://caniuse.com/#feat=svg" target="_top">Internet Explorer versions 8 and earlier</a>. SVG is XML-based, so you’ll notice that elements

<a id="id496785" class="indexterm"></a>

<a id="id496794" class="indexterm"></a> that don’t have a closing tag must be self-closing. For example:</p> 
<pre class="programlisting" data-language="html" id="elementelem"><code class="nt">&lt;element&gt;&lt;/element&gt;</code> <code class="c">&lt;!-- Uses closing tag --&gt;</code> <code class="nt">&lt;element/&gt;</code>          <code class="c">&lt;!-- Self-closing tag --&gt;</code></pre> 
<p id="before_you_can__id1">Before you can draw anything, you must create an SVG element. Think of the SVG element as a canvas on which your visuals are rendered. (In that respect, SVG is conceptually similar to HTML’s <code class="literal">canvas</code> element.) At a minimum, it’s good to specify <code class="literal">width</code> and <code class="literal">height</code> values. If you don’t specify these, the SVG will behave like a typically greedy, block-level HTML element and take up as much room as it can within its enclosing element:</p> 
<pre class="programlisting" data-language="html" id="svg_width_id2"><code class="nt">&lt;svg</code> <code class="na">width=</code><code class="s">"500"</code> <code class="na">height=</code><code class="s">"50"</code><code class="nt">&gt;</code> <code class="nt">&lt;/svg&gt;</code></pre> 
<p id="note_that_pixel">Note that 
<span class="emphasis">
<em>pixels</em></span> are the default measurement units, so we can specify dimensions of <code class="literal">500</code> and <code class="literal">50</code>, not <code class="literal">500px</code> and <code class="literal">50px</code>. We could have specified <code class="literal">px</code> explicitly, or any number of other supported units, including <code class="literal">em</code>, <code class="literal">pt</code>, <code class="literal">in</code>, <code class="literal">cm</code>, and <code class="literal">mm</code>.</p> </div> 
<div class="sect2" id="_simple_shapes"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Simple Shapes</h3></div></div></div> 
<p id="there_are_a_num">There are a number of visual elements that you can include between those <code class="literal">svg</code> tags, including <code class="literal">rect</code>, <code class="literal">circle</code>, <code class="literal">ellipse</code>, <code class="literal">line</code>, <code class="literal">text</code>, and <code class="literal">path</code>. (Sorry, <code class="literal">zebras</code> is not valid in this context.)

<a id="id497037" class="indexterm"></a></p> 
<p id="if_youre_famil_id2">If you’re familiar with computer graphics programming, you’ll recognize the usual pixel-based coordinates system in which <code class="literal">0,0</code> is the top-left corner of the drawing space. Increasing <code class="literal">x</code> values move to the right,

<a id="id497066" class="indexterm"></a> while increasing <code class="literal">y</code> values move down (see 

<a class="xref" href="#The_SVG_coordinates_system" title="Figure 3-13. The SVG coordinates system">Figure 3-13</a>).</p> 
<div class="figure" id="The_SVG_coordinates_system"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0313.png" alt="The SVG coordinates system"></div></div> 
<div class="figure-title">Figure 3-13. The SVG coordinates system</div> </div> 
<p id="rect_draws_a_re"><code class="literal">rect</code> draws a rectangle. Use <code class="literal">x</code> and <code class="literal">y</code> to specify the coordinates of the upper-left corner, and <code class="literal">width</code> and <code class="literal">height</code> to specify the dimensions. This rectangle fills the entire space of our SVG, as shown in 

<a class="xref" href="#An_SVG_rect" title="Figure 3-14. An SVG rect">Figure 3-14</a>:</p> 
<pre class="programlisting" data-language="html" id="rect_x_y_id1"><code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"0"</code> <code class="na">y=</code><code class="s">"0"</code> <code class="na">width=</code><code class="s">"500"</code> <code class="na">height=</code><code class="s">"50"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="An_SVG_rect"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0314.png" alt="An SVG rect"></div></div> 
<div class="figure-title">Figure 3-14. An SVG rect</div> </div> 
<p id="circle_draws_a_"><code class="literal">circle</code> draws a circle. Use <code class="literal">cx</code> and <code class="literal">cy</code> to specify the coordinates of the 
<span class="emphasis">
<em>center</em></span>, and <code class="literal">r</code> to specify the radius. This circle is centered in the middle of our 500-pixel-wide SVG because its <code class="literal">cx</code> (“center-x”) value is 250 (see 

<a class="xref" href="#An_SVG_circle" title="Figure 3-15. An SVG circle">Figure 3-15</a>):</p> 
<pre class="programlisting" data-language="html" id="circle_cx_id1"><code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"250"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"25"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="An_SVG_circle"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0315.png" alt="An SVG circle"></div></div> 
<div class="figure-title">Figure 3-15. An SVG circle</div> </div> 
<p id="ellipse_is_simi"><code class="literal">ellipse</code> is similar, but expects separate radius values for each axis. Instead of <code class="literal">r</code>, use <code class="literal">rx</code> and <code class="literal">ry</code> to obtain the result shown in 

<a class="xref" href="#An_SVG_ellipse" title="Figure 3-16. An SVG ellipse">Figure 3-16</a>:</p> 
<pre class="programlisting" data-language="html" id="ellipse_cx"><code class="nt">&lt;ellipse</code> <code class="na">cx=</code><code class="s">"250"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">rx=</code><code class="s">"100"</code> <code class="na">ry=</code><code class="s">"25"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="An_SVG_ellipse"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0316.png" alt="An SVG ellipse"></div></div> 
<div class="figure-title">Figure 3-16. An SVG ellipse</div> </div> 
<p id="line_draws_a_li"><code class="literal">line</code> draws a line, as shown in 

<a class="xref" href="#An_SVG_line" title="Figure 3-17. An SVG line">Figure 3-17</a>. Use <code class="literal">x1</code> and <code class="literal">y1</code> to specify the coordinates of one end of the line, and <code class="literal">x2</code> and <code class="literal">y2</code> to specify the coordinates of the other end. A <code class="literal">stroke</code> color must be specified for the line to be visible:</p> 
<pre class="programlisting" data-language="html" id="line_x_y"><code class="nt">&lt;line</code> <code class="na">x1=</code><code class="s">"0"</code> <code class="na">y1=</code><code class="s">"0"</code> <code class="na">x2=</code><code class="s">"500"</code> <code class="na">y2=</code><code class="s">"50"</code> <code class="na">stroke=</code><code class="s">"black"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="An_SVG_line"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0317.png" alt="An SVG line"></div></div> 
<div class="figure-title">Figure 3-17. An SVG line</div> </div> 
<p id="text_renders_te"><code class="literal">text</code> renders text. Use <code class="literal">x</code> to specify the position of the left edge, and <code class="literal">y</code> to specify the vertical position of the type’s 
<span class="emphasis">
<em>baseline</em></span>. (Baseline is a typographical term for the invisible line on which the letters appear to rest. Portions of letters such as “p” and “y” that extend below the baseline are called descenders.) The result of the following code is displayed in 

<a class="xref" href="#SVG_text" title="Figure 3-18. SVG text">Figure 3-18</a>:</p> 
<pre class="programlisting" data-language="html" id="text_x_y_id1"><code class="nt">&lt;text</code> <code class="na">x=</code><code class="s">"250"</code> <code class="na">y=</code><code class="s">"25"</code><code class="nt">&gt;</code>Easy-peasy<code class="nt">&lt;/text&gt;</code></pre> 
<div class="figure" id="SVG_text"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0318.png" alt="SVG text"></div></div> 
<div class="figure-title">Figure 3-18. SVG text</div> </div> 
<p id="text_will_inher"><code class="literal">text</code> will inherit the CSS-specified font styles of its parent element unless specified otherwise. (More on styling text in a moment.) We could override that formatting as follows and obtain the result shown in 

<a class="xref" href="#More_SVG_text" title="Figure 3-19. More SVG text">Figure 3-19</a>:</p> 
<pre class="programlisting" data-language="html" id="text_x_y_id2"><code class="nt">&lt;text</code> <code class="na">x=</code><code class="s">"250"</code> <code class="na">y=</code><code class="s">"25"</code> <code class="na">font-family=</code><code class="s">"serif"</code> <code class="na">font-size=</code><code class="s">"25"</code>  <code class="na">fill=</code><code class="s">"gray"</code><code class="nt">&gt;</code>Easy-peasy<code class="nt">&lt;/text&gt;</code></pre> 
<div class="figure" id="More_SVG_text"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0319.png" alt="More SVG text"></div></div> 
<div class="figure-title">Figure 3-19. More SVG text</div> </div> 
<p id="also_note_that__id2">Also note that when any visual element runs up against the edge of the SVG, it will be clipped. Be careful when using <code class="literal">text</code> so your descenders don’t get cut off (ouch!). You can see this happen in 

<a class="xref" href="#Even_More_SVG_text" title="Figure 3-20. More SVG text">Figure 3-20</a> when we set the baseline (<code class="literal">y</code>) to 50, the same as the height of our SVG:</p> 
<pre class="programlisting" data-language="html" id="text_x_y_id3"><code class="nt">&lt;text</code> <code class="na">x=</code><code class="s">"250"</code> <code class="na">y=</code><code class="s">"50"</code> <code class="na">font-family=</code><code class="s">"serif"</code> <code class="na">font-size=</code><code class="s">"25"</code>  <code class="na">fill=</code><code class="s">"gray"</code><code class="nt">&gt;</code>Easy-peasy<code class="nt">&lt;/text&gt;</code></pre> 
<div class="figure" id="Even_More_SVG_text"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0320.png" alt="More SVG text"></div></div> 
<div class="figure-title">Figure 3-20. More SVG text</div> </div> 
<p id="path_is_for_dra"><code class="literal">path</code> is for drawing anything more complex than the preceding shapes (like country outlines for geomaps), and will be explained separately. For now, we’ll work with simple shapes.</p> </div> 
<div class="sect2" id="_styling_svg_elements"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Styling SVG Elements</h3></div></div></div> 
<p id="svgs_default_s">SVG’s default style is a black fill with no stroke. If you want anything else, you’ll have to apply styles to your elements. Common SVG

<a id="id497920" class="indexterm"></a>

<a id="id497928" class="indexterm"></a> properties are as follows:</p> 
<div class="variablelist" id="fill_a_color_va">
<dl class="variablelist"> 
<dt>
<span class="term"> <code class="literal">fill</code> </span></dt> 
<dd> A color value. Just as with CSS, colors can be specified as named colors, hex values, or RGB or RGBA values. </dd> 
<dt>
<span class="term"> <code class="literal">stroke</code> </span></dt> 
<dd> A color value. </dd> 
<dt>
<span class="term"> <code class="literal">stroke-width</code> </span></dt> 
<dd> A numeric measurement (typically in pixels). </dd> 
<dt>
<span class="term"> <code class="literal">opacity</code> </span></dt> 
<dd> A numeric value between 0.0 (completely transparent) and 1.0 (completely 
<span class="keep-together">opaque</span>). </dd> </dl></div> 
<p id="with_text_you_">With <code class="literal">text</code>, you can also use these properties, which work just like in CSS:</p> 
<div class="itemizedlist" id="fontfamily_fon">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">font-family</code> </li> 
<li class="listitem"> <code class="literal">font-size</code> </li> </ul></div> 
<p id="in_another_para">In another parallel to CSS, there are two ways to apply styles to an SVG element: either directly (inline) as an attribute of the element, or with a CSS style rule.</p> 
<p id="here_are_some_s">Here are some style properties applied directly to a <code class="literal">circle</code> as attributes, with the result shown in 

<a class="xref" href="#An_SVG_circle2" title="Figure 3-21. An SVG circle">Figure 3-21</a>:</p> 
<pre class="programlisting" data-language="html" id="circle_cx_id2"><code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"22"</code>  <code class="na">fill=</code><code class="s">"yellow"</code> <code class="na">stroke=</code><code class="s">"orange"</code> <code class="na">stroke-width=</code><code class="s">"5"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="An_SVG_circle2"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0321.png" alt="An SVG circle"></div></div> 
<div class="figure-title">Figure 3-21. An SVG circle</div> </div> 
<p id="alternatively__id1">Alternatively, we could strip the style attributes and assign the <code class="literal">circle</code> a class (just as if it were a normal HTML element):</p> 
<pre class="programlisting" data-language="html" id="circle_cx_id3"><code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"22"</code> <code class="na">class=</code><code class="s">"pumpkin"</code><code class="nt">/&gt;</code></pre> 
<p id="and_then_put_th">and then put the <code class="literal">fill</code>, <code class="literal">stroke</code>, and <code class="literal">stroke-width</code> rules into a CSS style that targets the new class:</p> 
<pre class="programlisting" data-language="css" id="pumpkin__fill"><code class="nc">.pumpkin</code> <code class="p">{</code>     <code class="n">fill</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code>     <code class="n">stroke</code><code class="o">:</code> <code class="nb">orange</code><code class="p">;</code>     <code class="n">stroke</code><code class="o">-</code><code class="n">width</code><code class="o">:</code> <code class="m">5</code><code class="p">;</code>  <code class="p">}</code></pre> 
<p id="the_css_approac">The CSS approach has a few obvious benefits:</p> 
<div class="itemizedlist" id="you_can_specify_id1">
<ul class="itemizedlist"> 
<li class="listitem"> You can specify a style once and have it applied to multiple elements. </li> 
<li class="listitem"> CSS code is easier to read than inline attributes. </li> 
<li class="listitem"> For those reasons, the CSS approach might be more maintainable and make design changes faster to implement. </li> </ul></div> 
<p id="using_css_to_ap">Using CSS to apply SVG styles, however, can be disconcerting for some. <code class="literal">fill</code>, <code class="literal">stroke</code>, and <code class="literal">stroke-width</code>, after all, are 
<span class="emphasis">
<em>not</em></span> CSS properties. (The nearest CSS equivalents are <code class="literal">background-color</code> and <code class="literal">border</code>.) It’s just that we are using CSS selectors to apply SVG-specific properties. If it helps you remember which rules in your stylesheet are SVG-specific, consider including <code class="literal">svg</code> in those selectors:</p> 
<pre class="programlisting" data-language="css" id="svg_pumpkin__"><code class="nt">svg</code> <code class="nt">.pumpkin</code> <code class="p">{</code>     <code class="c">/* ... */</code>  <code class="p">}</code></pre> </div> 
<div class="sect2" id="_layering_and_drawing_order"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Layering and Drawing Order</h3></div></div></div> 
<p id="there_are_no_l">There are no “layers” in SVG and no real concept of depth. SVG does not support CSS’s <code class="literal">z-index</code> property, so shapes can be arranged only within the two-dimensional x/y plane.

<a id="id498507" class="indexterm"></a></p> 
<p id="and_yet_if_we_">And yet, if we draw multiple shapes, they overlap:</p> 
<pre class="programlisting" data-language="html" id="rect_x_y_id2"><code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"0"</code> <code class="na">y=</code><code class="s">"0"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"purple"</code><code class="nt">/&gt;</code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"20"</code> <code class="na">y=</code><code class="s">"5"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"blue"</code><code class="nt">/&gt;</code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"40"</code> <code class="na">y=</code><code class="s">"10"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"green"</code><code class="nt">/&gt;</code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"60"</code> <code class="na">y=</code><code class="s">"15"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"yellow"</code><code class="nt">/&gt;</code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"80"</code> <code class="na">y=</code><code class="s">"20"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"red"</code><code class="nt">/&gt;</code></pre> 
<p id="the_order_in_wh">The order in which elements are coded determines their depth order. In 

<a class="xref" href="#Overlapping_SVG_elements" title="Figure 3-22. Overlapping SVG elements">Figure 3-22</a>, the purple square appears first in the code, so it is rendered first. Then, the blue square is rendered “on top” of the purple one, then the green square on top of that, and so on.</p> 
<div class="figure" id="Overlapping_SVG_elements"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0322.png" alt="Overlapping SVG elements"></div></div> 
<div class="figure-title">Figure 3-22. Overlapping SVG elements</div> </div> 
<p id="think_of_svg_sh">Think of SVG shapes as being rendered like paint on a canvas. The pixel-paint that is applied later obscures any earlier paint, and thus appears to be “in front.”</p> 
<div class="sidebar online_only" id="interactive_3-4"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Exercise</div></div></div></div> 
<p id="modify_the_svg_">Modify the SVG markup in the left panel to reverse how the squares are stacked (i.e, purple on top of blue, blue on top of green, and so on), and check your results in the output at right:</p> 
<div class="interactive">

<p id="this_aspect_of_">This aspect of drawing order becomes important when you have some visual elements that should not be obscured by others. For example, you might have axes or value labels that appear on a scatterplot. The axes and labels should be added to the SVG last, so they appear in front of any other elements.

<a id="id498900" class="indexterm"></a>

<a id="id498905" class="indexterm"></a></p> </div> 
<div class="sect2" id="_transparency"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Transparency</h3></div></div></div> 
<p id="transparency_ca">Transparency can be useful when elements in your visualization overlap but must remain visible, or you want to deemphasize some elements while highlighting others, as shown in 

<a class="xref" href="#RGBA_SVG_shapes" title="Figure 3-23. RGBA SVG shapes">Figure 3-23</a>.</p> 
<p id="there_are_two_w">There are two ways to apply transparency: use an RGB color with alpha, or set an <code class="literal">opacity</code> value.

<a id="id498946" class="indexterm"></a>

<a id="id498954" class="indexterm"></a></p> 
<p id="you_can_use_rgb">You can use <code class="literal">rgba()</code> anywhere you specify a color, such as with <code class="literal">fill</code> or <code class="literal">stroke</code>. <code class="literal">rgba()</code> expects three values between 0 and 255 for red, green, and blue, plus an alpha (transparency) value between 0.0 and 1.0:</p> 
<pre class="programlisting" data-language="html" id="circle_cx_id4"><code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 1.0)"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"50"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(0, 0, 255, 0.75)"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"75"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(0, 255, 0, 0.5)"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"100"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(255, 255, 0, 0.25)"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"125"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(255, 0, 0, 0.1)"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="RGBA_SVG_shapes"> 
<div class="figure-contents">
<div class="mediaobject">
<img style="width: 189; " src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0323.png" alt="RGBA SVG shapes"></div></div> 
<div class="figure-title">Figure 3-23. RGBA SVG shapes</div> </div> 
<p id="note_that_with_">Note that with <code class="literal">rgba()</code>, transparency is applied to the <code class="literal">fill</code> and <code class="literal">stroke</code> colors independently. The following circles’ <code class="literal">fill</code> is 75 percent opaque, and their <code class="literal">stroke</code>s are only 25 percent opaque:</p> 
<pre class="programlisting" data-language="html" id="circle_cx_id5"><code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"75"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(0, 255, 0, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 0, 255, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"125"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(255, 255, 0, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(255, 0, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/&gt;</code></pre> 
<p id="with_this_trans">With this transparency applied, and the result shown in 

<a class="xref" href="#More_RGBA_SVG_shapes" title="Figure 3-24. More RGBA SVG shapes">Figure 3-24</a>, we can see that strokes are aligned to the center of each shape’s edge.  That is, the stroke is neither fully inside nor outside the object, but is both half in and half out.  As a result of this transparency, these individual <code class="literal">10px</code> strokes look more like two separate <code class="literal">5px</code> strokes.</p> 
<div class="figure" id="More_RGBA_SVG_shapes"> 
<div class="figure-contents">
<div class="mediaobject">
<img style="width: 189; " src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0324.png" alt="More RGBA SVG shapes"></div></div> 
<div class="figure-title">Figure 3-24. More RGBA SVG shapes</div> </div> 
<p id="to_apply_transp">To apply transparency to an entire element, set an <code class="literal">opacity</code> attribute. 

<a class="xref" href="#Opaque_circles" title="Figure 3-25. Opaque circles">Figure 3-25</a> illustrates some completely opaque circles.</p> 
<div class="figure" id="Opaque_circles"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0325.png" alt="Opaque circles"></div></div> 
<div class="figure-title">Figure 3-25. Opaque circles</div> </div> 
<p id="shows_the_same_">

<a class="xref" href="#Semiopaque_circles" title="Figure 3-26. Semiopaque circles">Figure 3-26</a> shows the same circles, with <code class="literal">opacity</code> values:</p> 
<pre class="programlisting" data-language="html" id="circle_cx_id6"><code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"purple"</code> <code class="na">stroke=</code><code class="s">"green"</code> <code class="na">stroke-width=</code><code class="s">"10"</code>         <code class="na">opacity=</code><code class="s">"0.9"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"65"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"green"</code> <code class="na">stroke=</code><code class="s">"blue"</code> <code class="na">stroke-width=</code><code class="s">"10"</code>         <code class="na">opacity=</code><code class="s">"0.5"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"105"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"yellow"</code> <code class="na">stroke=</code><code class="s">"red"</code> <code class="na">stroke-width=</code><code class="s">"10"</code>         <code class="na">opacity=</code><code class="s">"0.1"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="Semiopaque_circles"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0326.png" alt="Semiopaque circles"></div></div> 
<div class="figure-title">Figure 3-26. Semiopaque circles</div> </div> 
<p id="you_can_employ_">You can employ <code class="literal">opacity</code> on an element that also has colors set with <code class="literal">rgba()</code>. When doing so, the transparencies are multiplied. The circles in 

<a class="xref" href="#More_opaque_circles" title="Figure 3-27. More opaque circles">Figure 3-27</a> use the same RGBA values for <code class="literal">fill</code> and <code class="literal">stroke</code>. The first circle has no element <code class="literal">opacity</code> set, but the other two do:</p> 
<pre class="programlisting" data-language="html" id="circle_cx_id7"><code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"65"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code> <code class="na">opacity=</code><code class="s">"0.5"</code><code class="nt">/&gt;</code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"105"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code> <code class="na">opacity=</code><code class="s">"0.2"</code><code class="nt">/&gt;</code></pre> 
<div class="figure" id="More_opaque_circles"> 
<div class="figure-contents">
<div class="mediaobject">
<img style="width: 189; " src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0327.png" alt="More opaque circles"></div></div> 
<div class="figure-title">Figure 3-27. More opaque circles</div> </div> 
<p id="notice_how_the__id1">Notice how the third circle’s <code class="literal">opacity</code> is <code class="literal">0.2</code>, or 20 percent. Yet its purple fill already has an alpha value of <code class="literal">0.75</code>, or 75 percent. The purple area, then, has a final transparency of 0.2 times 0.75 = 0.15, or 15 percent.

<a id="id500208" class="indexterm"></a></p> </div> </div> 
<div class="sect1" data-original-filename="3_tech_fundamentals.asciidoc" id="_a_note_on_compatibility"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">A Note on Compatibility</h2></div></div></div> 
<p id="older_browsers_">Older browsers don’t support SVG.  So, generally speaking, Internet Explorer version 8 and older will not display SVG images at all.  This is a little annoying because people could visit your page only to see emptiness in place of a gorgeous visualization.  On the other hand, D3 also does not work with older browsers (again, meaning IE8 and older), so it never would have worked in the first place.</p> 
<div class="note" id="d_can_be_made__id1">
<p id="d_can_be_made__id2">D3 
<span class="emphasis">
<em>can</em></span> be made to work with IE8 by employing the 

<a class="ulink" href="https://github.com/shawnbot/aight" target="_top">Aight</a> compatibility library, but that doesn’t help with older versions of IE.  

<a class="ulink" href="https://github.com/mhemesath/r2d3/" target="_top">r2d3</a> is an adaptation of D3 that integrates 

<a class="ulink" href="http://raphaeljs.com" target="_top">Raphaël</a> for drawing visuals, which should get you as far back as IE7.</p></div> 
<p id="internet_explor">

<a id="id500279" class="indexterm"></a>

<a id="id500285" class="indexterm"></a>

<a id="id500293" class="indexterm"></a></p> 
<p id="in_general_you">In general, your best bet is to encourage people to upgrade and use a web browser that has been built in the last few years.  The more people move to modern browsers, the better their web experiences will be, and the larger our potential audiences.</p> 
<p id="that_said_its">That said, it’s polite to notify users of older browsers why the piece isn’t working.  I recommend using 

<a class="ulink" href="http://modernizr.com" target="_top">Modernizr</a> or a similar JavaScript tool to detect whether or not the browser supports SVG.  If it does, then you can load your D3 code and proceed as normal.  If SVG is 
<span class="emphasis">
<em>not</em></span> supported, then you can display a static, noninteractive version of your visualization alongside a message explaining that a current browser is needed.  (Be nice and provide links to the 

<a class="ulink" href="http://www.google.com/chrome" target="_top">Chrome</a> and 

<a class="ulink" href="http://www.mozilla.org/en-US/firefox/new/" target="_top">Firefox</a> download pages.  I used to link to 

<a class="ulink" href="http://www.apple.com/safari/" target="_top">Safari</a> as well, but Apple now distributes it as part of the Mac OS, so it’s no longer available as a separate download.)</p> 
<p id="for_example_yo_id2">For example, you can use <code class="literal">Modernizr.load()</code> to check the results of Modernizr’s tests.  Then, if the tests pass (for example, because SVG support 
<span class="emphasis">
<em>is</em></span> detected), then tell Modernizr to go ahead and load D3 and your custom JavaScript code.  I’d typically have something like this in the <code class="literal">&lt;head&gt;</code> of my document:</p> 
<pre class="programlisting" data-language="html" id="script_srcjs"><code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"js/modernizr.js"</code><code class="nt">&gt;&lt;/script&gt;</code>  <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">&gt;</code>         <code class="nx">Modernizr</code><code class="p">.</code><code class="nx">load</code><code class="p">({</code>                 <code class="nx">test</code><code class="o">:</code> <code class="nx">Modernizr</code><code class="p">.</code><code class="nx">svg</code> <code class="o">&amp;&amp;</code> <code class="nx">Modernizr</code><code class="p">.</code><code class="nx">inlinesvg</code><code class="p">,</code>                 <code class="nx">yep</code> <code class="o">:</code> <code class="p">[</code> <code class="s1">'js/d3.v3.min.js'</code><code class="p">,</code>                         <code class="s1">'js/script.js'</code> <code class="p">]</code>         <code class="p">});</code> <code class="nt">&lt;/script&gt;</code></pre> 
<p id="this_loads_mode">This loads Modernizr in, performs the tests, and then bothers loading the other code only if the tests succeed.  (That’s the “<code class="literal">yep</code>” part.)  You can use CSS or more JavaScript to define what shows up to the user when the test 
<span class="emphasis">
<em>fails</em></span>, such as a static image of your visualization or a message encouraging the user to try a newer browser.  Learn more about how to do this in the 

<a class="ulink" href="http://modernizr.com/docs/#load" target="_top">Modernizr documentation</a>.</p> 
<p id="caniusecom_is_">
<span class="emphasis">
<em>caniuse.com</em></span> is a fantastic resource for supported browser features.  See their list of 

<a class="ulink" href="http://caniuse.com/#search=svg" target="_top">browsers with SVG support</a>.</p> 
<p id="people_have_tri">People have tried to get D3 working in older browsers, sometimes by mashing it up with Raphaël to render to canvas, or other hacky means. It is technically possible, but I don’t recommend it.</p>
<section class="chapter" data-original-filename="4_setup.asciidoc" id="setup-chapter4">
<div class="titlepage">
<div>
<div>
<h1 id="ch04" class="title">Chapter 4. Setup</h1></div></div></div> 
<p id="getting_set_up_">Getting set up with D3 is pretty straightforward—a simple matter of downloading the latest version, creating an empty page in which to write your code, and finally setting up a local web server.

<a id="id500605" class="indexterm"></a></p> 
<div class="sect1" data-original-filename="4_setup.asciidoc" id="_downloading_d3"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Downloading D3</h2></div></div></div> 
<p id="start_by_creati">Start by creating a new folder for your project. Call it whatever you like, but maybe something like 
<span class="emphasis">
<em>project-folder</em></span>.</p> 
<p id="within_that_fol">Within that folder, I recommend creating a subfolder called 
<span class="emphasis">
<em>d3</em></span>. Then download the latest version of D3 into that subfolder. 

<a class="ulink" href="http://d3js.org/d3.v3.zip" target="_top">Download the latest version of D3 as a ZIP file</a>, and then decompress the ZIP file.  As of this writing, the current version of D3 is 3.0.6.</p> 
<p id="d_is_also_prov">D3 is also provided in a “minified” version, 

<a class="ulink" href="http://d3js.org/d3.v3.min.js" target="_top">
<span class="emphasis">
<em>d3.v3.min.js</em></span></a>, from which whitespace has been removed for smaller file sizes and faster load times. The functionality is the same, but typically you’d use the regular version while working on a project (for friendlier debugging), and then switch to the minified version once you’ve launched the project publicly (for optimized load times). The choice is up to you, but in this book, I use the standard version.</p> 
<p id="a_third_option_">A third option is to download the entire D3 repository, which gives you not just the JavaScript files, but also all of the component source code. You can 

<a class="ulink" href="https://github.com/mbostock/d3" target="_top">browse the repository contents</a> first, or just 

<a class="ulink" href="https://github.com/mbostock/d3/zipball/master" target="_top">download the whole thing as a compressed ZIP file</a>. Of course, once you’ve downloaded everything, make a copy of the file 
<span class="emphasis">
<em>d3.v3.js</em></span> and move that into 
<span class="emphasis">
<em>project-folder/d3/</em></span>.</p> </div> 
<div class="sect1" data-original-filename="4_setup.asciidoc" id="_referencing_d3"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Referencing D3</h2></div></div></div> 
<p id="now_create_a_si">Now create a simple HTML page within your project folder named 
<span class="emphasis">
<em>index.html</em></span>. Remember, HTML documents are just plain text files, so you can use the text editor of your choice. Free editors like TextEdit and Notepad are fine, but your life might be easier if you use an editor designed specifically for working with code, like Coda, Espresso, or Sublime Text (among many, many others).

<a id="id500723" class="indexterm"></a></p> 
<p id="if_your_editor_">If your editor gives you the option to set the file encoding, choose Unicode (UTF-8).</p> 
<p id="your_folder_str">Your folder structure should now look something like this:</p> 
<pre class="screen" id="projectfolder">project-folder/     d3/         d3.v3.js         d3.v3.min.js (optional)     index.html</pre> 
<p id="paste_the_follo">Paste the following into your new HTML file:</p> 
<pre class="programlisting" data-language="html" id="doctype_html_id3"><code class="cp">&lt;!DOCTYPE html&gt;</code> <code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>     <code class="nt">&lt;head&gt;</code>         <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"utf-8"</code><code class="nt">&gt;</code>         <code class="nt">&lt;title&gt;</code>D3 Page Template<code class="nt">&lt;/title&gt;</code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code> <code class="na">src=</code><code class="s">"d3/d3.v3.js"</code><code class="nt">&gt;&lt;/script&gt;</code>     <code class="nt">&lt;/head&gt;</code>     <code class="nt">&lt;body&gt;</code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">&gt;</code>             <code class="c1">// Your beautiful D3 code will go here</code>         <code class="nt">&lt;/script&gt;</code>     <code class="nt">&lt;/body&gt;</code> <code class="nt">&lt;/html&gt;</code></pre> 
<p id="or_rather_than">Or, rather than go through all that manual labor, you could just download the sample code files (see 

<a class="xref" href="" title="Chapter 1. Introduction">Chapter 1</a> for instructions), and take a look at 
<span class="emphasis">
<em>01_empty_page_template.html</em></span>, which contains almost exactly the same code.  (The <code class="literal">src</code> path to D3 is different in my version.)

<a id="id500934" class="indexterm"></a></p> 
<p id="here_are_a_few_">Here are a few things to note about this template:</p> 
<div class="itemizedlist" id="the_meta_tag_id_id1">
<ul class="itemizedlist"> 
<li class="listitem"> The <code class="literal">meta</code> tag identifies the encoding for this file as <code class="literal">utf-8</code>, which is needed to ensure that the browser can parse D3’s functions and data properly. </li> 
<li class="listitem"> The first <code class="literal">script</code> tag sets the reference to 
<span class="emphasis">
<em>d3.v3.js</em></span>. You should edit this file path as needed if you’re using the minified version of D3 or decided to locate 
<span class="emphasis">
<em>d3.v3.js</em></span> somewhere other than the 
<span class="emphasis">
<em>d3</em></span> directory. </li> 
<li class="listitem"> The second <code class="literal">script</code> tag, in the <code class="literal">body</code>, is where you will soon key in all your beautiful code. And it will be beautiful. </li> </ul></div> 
<p id="done_your_d_t">Done! Your D3 template files and folders are all set up. You might want to make a copy of this template for each new project down the line.

<a id="id501025" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="4_setup.asciidoc" id="_setting_up_a_web_server"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Setting Up a Web Server</h2></div></div></div> 
<p id="in_some_cases_">In some cases, you can view local HTML files directly in your web browser. However, some browsers have restrictions that prevent them from loading local files via JavaScript, for security reasons. That means if your D3 code is trying to pull in any external datafiles (like CSVs or JSON), it will fail with no good explanation. This isn’t D3’s fault; it’s a browser feature that prevents loading of scripts and other external files from third-party, untrusted websites.

<a id="id501058" class="indexterm"></a>

<a id="id501066" class="indexterm"></a></p> 
<p id="for_this_reason">For this reason, it is much more reliable to load your page via a web server. Although you 
<span class="emphasis">
<em>could</em></span> use a remote web server, it is much, much faster to store and host everything locally (meaning, on the same computer, the one right in front of you). It is a strange idea, to use your local computer to host and serve files to itself, but you can think about it as the different programs talking to each other: the browser program requests files from the server program, which responds by serving them back.</p> 
<p id="the_good_news_i">The good news is that it’s quite easy to get a local server up and running. Here are a couple of ways to do that.</p> 
<div class="sect2" id="_terminal_with_python"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Terminal with Python</h3></div></div></div> 
<p id="if_youre_using">If you’re using Mac OS X or Linux, then you already have Python installed.  As long as you’re comfortable entering commands in the terminal, then running a miniserver with Python is definitely the quickest option.  (If you’re on Windows, you’ll need to install Python first.)</p> 
<p id="to_use_python_">To use Python, you’ll need to open up a terminal window on your system.  On a Mac, open the Terminal application.  You can find it in the Utilities folder, or by typing 
<span class="keep-together">
<span class="strong">
<strong><code class="literal">Terminal</code></strong></span></span> into Spotlight (the magnifying glass menu item in the upper-right corner of your screen).  Linux users are born knowing how to open a terminal window, so I won’t waste your time explaining it here.</p> 
<p id="to_run_a_python">To run a Python web server:</p> 
<div class="orderedlist" id="open_up_a_new_t_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Open up a new terminal window. </li> 
<li class="listitem"> Via the command line, navigate into the directory that you want served.  For example, if your project folder is in your Desktop folder on your Mac, you could type: 
<span class="strong">
<strong><code class="literal">cd ~/Desktop/project-folder</code></strong></span>. </li> 
<li class="listitem"> Enter 
<span class="strong">
<strong><code class="literal">python -m SimpleHTTPServer 8888 &amp;</code></strong></span>. </li> </ol></div> 
<p id="this_will_work">(This will work with Python version 2.x, but in Python versions 3.0 and newer, 
<span class="keep-together"><code class="literal">SimpleHTTPServer</code></span> has been removed.  For Python 3.x, just replace <code class="literal">SimpleHTTPServer</code> with <code class="literal">http.server</code> in the command.)</p> 
<p id="this_will_activ">This will activate the server on port <code class="literal">8888</code>. Switch back to your web browser and visit the following URL: 

<a class="ulink" href="http://localhost:8888/" target="_top">http://localhost:8888/</a>. Yes, instead of 
<span class="emphasis">
<em>www.something.com</em></span>, you just use 
<span class="emphasis">
<em>localhost</em></span>, which tells the browser to request a page from 
<span class="emphasis">
<em>this machine</em></span>.</p> 
<p id="you_should_see__id1">You should see the blank “D3 Page Template” page. Given that <code class="literal">body</code> of the page is empty, it won’t look like much. Select View source, and you should see the contents of our HTML template page.</p> </div> 
<div class="sect2" id="_mamp_wamp_and_lamp"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">MAMP, WAMP, and LAMP</h3></div></div></div> 
<p id="this_option_tak">This option takes longer, but is best if you like dragging and dropping to install things, and want to avoid scary things like the terminal.</p> 
<p id="all_of_the_amps">All of the AMPs in this section stand for Apache (the web server software), MySQL (popular database software), and PHP (a popular web scripting language). We are really interested only in Apache, the web server, but it usually comes bundled with the other two, as they all work well together.</p> 
<p id="on_a_mac_you_c">On a Mac, you can download and install 

<a class="ulink" href="http://mamp.info/en/" target="_top">MAMP</a> or 

<a class="ulink" href="http://bit.ly/W8RQa6" target="_top">XAMPP for Mac</a>.</p> 
<p id="the_windows_equ">The Windows equivalents are 

<a class="ulink" href="http://www.wampserver.com/en/" target="_top">WampServer</a> and 

<a class="ulink" href="http://bit.ly/ZEGJq1" target="_top">XAMPP for Windows</a>.</p> 
<p id="if_you_use_linu">If you use Linux, then all of this is probably already installed on your machine, but you could still download 

<a class="ulink" href="http://bit.ly/126txfk" target="_top">XAMPP for Linux</a>.</p> 
<p id="installation_fo">Installation for each of these packages varies somewhat, so follow the documentation carefully. (I’ve found MAMP to be the easiest to install.)</p> 
<p id="each_package_wi">Each package will designate one folder as the web server directory, so only the files 
<span class="emphasis">
<em>within that folder</em></span> will be served. You should find out what that folder is, and move your D3 
<span class="emphasis">
<em>project-folder</em></span> into it.</p> 
<p id="once_the_local_">Once the local server is up and running, you can view any pages within the server directory by opening a browser (on the same computer, of course) and pointing it to 
<span class="emphasis">
<em>localhost</em></span>, as in the following: 

<a class="ulink" href="http://localhost/" target="_top">http://localhost/</a>. Depending on your AMP configuration, you might need to append a port number to the URL, as in the following: 

<a class="ulink" href="http://localhost:8888/" target="_top">http://localhost:8888/</a>.</p> 
<p id="if_the_servers">If the server’s port number is <code class="literal">8888</code> and your project folder is called 
<span class="emphasis">
<em>project-folder</em></span>, then you could view your D3 template page by going to 

<a class="ulink" href="http://localhost:8888/project-folder/" target="_top">http://localhost:8888/project-folder/</a>.</p> </div> 
<div class="sect2" id="_diving_in"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Diving In</h3></div></div></div> 
<p id="all_set_great">All set? Great! Let’s start working with data.</p> </div>
<section class="chapter" data-original-filename="5_data.asciidoc" id="data-chapter5">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 5. Data</h1></div></div></div> 
<p id="data_is_an_extr">
<span class="emphasis">
<em>Data</em></span> is an extremely broad term, only slightly less vague than the nearly all-encompassing 
<span class="emphasis">
<em>information</em></span>. What is data? (What 
<span class="emphasis">
<em>isn’t</em></span> data?) What kinds of data are there, and what can we use with D3?

<a id="ix_data" class="indexterm"></a></p> 
<p id="broadly_speakin">Broadly speaking, data is structured information with potential for meaning.</p> 
<p id="in_the_context_">In the context of programming for visualization, data is stored in a digital file, typically in either text or binary form. Of course, potentially every piece of digital ephemera may be considered “data”—not just text, but bits and bytes representing images, audio, video, databases, streams, models, archives, and anything else.

<a id="id501486" class="indexterm"></a></p> 
<p id="within_the_scop">Within the scope of D3 and browser-based visualization, however, we will limit ourselves to 
<span class="emphasis">
<em>text-based data</em></span>. That is, anything that can be represented as numbers and strings of alpha characters. If you can get your data into a 
<span class="emphasis">
<em>.txt</em></span> plain text file, a 
<span class="emphasis">
<em>.csv</em></span> comma-separated value file, or a 
<span class="emphasis">
<em>.json</em></span> JSON document, then you can use it with D3.

<a id="id501517" class="indexterm"></a>

<a id="id501525" class="indexterm"></a>

<a id="id501531" class="indexterm"></a>

<a id="id501537" class="indexterm"></a>

<a id="id501543" class="indexterm"></a></p> 
<p id="whatever_your_d">Whatever your data, it can’t be made useful and visual until it is 
<span class="emphasis">
<em>attached</em></span> to something. In D3 lingo, the data must be 
<span class="emphasis">
<em>bound</em></span> to elements within the page. Let’s address how to create new page elements first. Then attaching data to those elements will be a cinch.

<a id="ix_pgelem" class="indexterm"></a></p> 
<div class="sect1" data-original-filename="5_data.asciidoc" id="_generating_page_elements"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Generating Page Elements</h2></div></div></div> 
<p id="typically_when">Typically, when using D3 to generate new DOM elements, the new elements will be circles, rectangles, or other visual forms that represent your data. But to avoid confusing matters, we’ll start with a simple example and create a lowly <code class="literal">p</code> paragraph element.

<a id="ix_pgelemcrt" class="indexterm"></a>

<a id="id501621" class="indexterm"></a></p> 
<p id="begin_by_creati">Begin by creating a new document with our simple HTML template from the last chapter.  You can find it in the sample code files as 
<span class="emphasis">
<em>01_empty_page_template.html</em></span>, and it looks like the following code.  (Eagle-eyed viewers will notice that I’ve modified the <code class="literal">src</code> path here due to work with the directory structure of the code samples.  If that doesn’t mean anything to you, don’t worry about it.)</p> 
<pre class="programlisting" data-language="html" id="doctype_html_id4"><code class="cp">&lt;!DOCTYPE html&gt;</code> <code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>     <code class="nt">&lt;head&gt;</code>         <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"utf-8"</code><code class="nt">&gt;</code>         <code class="nt">&lt;title&gt;</code>D3 Page Template<code class="nt">&lt;/title&gt;</code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code> <code class="na">src=</code><code class="s">"../d3/d3.v3.js"</code><code class="nt">&gt;&lt;/script&gt;</code>     <code class="nt">&lt;/head&gt;</code>     <code class="nt">&lt;body&gt;</code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">&gt;</code>             <code class="c1">// Your beautiful D3 code will go here</code>         <code class="nt">&lt;/script&gt;</code>     <code class="nt">&lt;/body&gt;</code> <code class="nt">&lt;/html&gt;</code></pre> 
<p id="open_that_page_">Open that page in your web browser.  Make sure you’re accessing the page via your local web server, as we discussed in 

<a class="xref" href="ch04" title="Chapter 4. Setup">Chapter 4</a>.  So the URL in your browser’s location bar should look something like this:</p> 
<pre class="literallayout" id="httplocalhos">http://localhost:8888/d3-book/chapter_05/01_empty_page_template.html</pre> 
<p id="if_not_viewed_t">If not viewed through a web server, the URL path will start with 
<span class="emphasis">
<em>file:///</em></span> instead of 
<span class="emphasis">
<em>http://</em></span>.  Confirm that the URL does 
<span class="emphasis">
<em>not</em></span> look like this:</p> 
<pre class="literallayout" id="filedbo">file:///…/d3-book/chapter_05/01_empty_page_template.html</pre> 
<p id="once_youre_vie">Once you’re viewing the page, pop open the web inspector.  (As a reminder, see 

<a class="xref" href="#developer_tools_3" title="Developer Tools">“Developer Tools”</a> on how to do that.) You should see an empty web page, with the DOM contents shown in 

<a class="xref" href="#Web_inspector" title="Figure 5-1. Web inspector">Figure 5-1</a>.</p> 
<div class="figure" id="Web_inspector"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0501.png" alt="Web inspector"></div></div> 
<div class="figure-title">Figure 5-1. Web inspector</div> </div> 
<p id="back_in_your_te">Back in your text editor, replace the comment between the <code class="literal">script</code> tags with:</p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id1"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code></pre> 
<p id="save_and_refres">Save and refresh, and voilà! There is text in the formerly empty browser window, and the web inspector will look like 

<a class="xref" href="#Web_inspector_again" title="Figure 5-2. Web inspector, again">Figure 5-2</a>.</p> 
<div class="figure" id="Web_inspector_again"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0502.png" alt="Web inspector, again"></div></div> 
<div class="figure-title">Figure 5-2. Web inspector, again</div> </div> 
<p id="see_the_differe">See the difference? Now in the DOM, there is a new paragraph element that was generated on the fly! This might not be exciting yet, but you will soon use a similar technique to dynamically generate tens or hundreds of elements, each one corresponding to a piece of your dataset.</p> 
<p id="lets_walk_thro">Let’s walk through what just happened. (You can follow along with 
<span class="emphasis">
<em>02_new_element.html</em></span>.)  To understand that first line of D3 code, you must first meet your new best friend, 
<span class="emphasis">
<em>chain syntax</em></span>.</p> 
<div class="sect2" id="_chaining_methods"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Chaining Methods</h3></div></div></div> 
<p id="d_smartly_empl">D3 smartly employs a technique called 
<span class="emphasis">
<em>chain syntax</em></span>, which you might recognize from jQuery. By “chaining” methods together with periods, you can perform several actions in a single line of code. It can be fast and easy, but it’s important to understand how it works, to save yourself hours of debugging headaches later.

<a id="id502050" class="indexterm"></a>

<a id="id502056" class="indexterm"></a></p> 
<p id="by_the_way_fun">By the way, 
<span class="emphasis">
<em>functions</em></span> and 
<span class="emphasis">
<em>methods</em></span> are just two different words for the same concept: a chunk of code that accepts an argument as input, performs some action, and returns some other information as output.

<a id="id502080" class="indexterm"></a>

<a id="id502088" class="indexterm"></a></p> 
<p id="the_following_c">The following code:</p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id2"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code></pre> 
<p id="might_look_like">might look like a big mess, especially if you’re new to programming. So the first thing to know is that JavaScript, like HTML, doesn’t care about whitespace and line breaks, so you can put each method on its own

<a id="id502179" class="indexterm"></a> line for legibility:</p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id3"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code></pre> 
<p id="both_i_and_your">Both I and your optometrist highly recommend putting each method on its own indented line. But programmers have their own coding style; use whatever indents, line breaks, and whitespace (tabs or spaces) are most legible for you.

<a id="id502275" class="indexterm"></a>

<a id="id502283" class="indexterm"></a></p> </div> 
<div class="sect2" id="_one_link_at_a_time"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">One Link at a Time</h3></div></div></div> 
<p id="lets_deconstru">Let’s deconstruct each line in this chain of code:</p> 
<div class="variablelist" id="d_references_t">
<dl class="variablelist"> 
<dt>
<span class="term"> <code class="literal">d3</code> </span></dt> 
<dd> References the D3 object, so we can access its methods. Our D3 adventure begins here. </dd> 
<dt>
<span class="term"> <code class="literal">.select("body")</code> </span></dt> 
<dd> Give the 

<a class="ulink" href="http://bit.ly/12h4SF1" target="_top"><code class="literal">select()</code></a> method a CSS selector as input, and it will return a reference to the first element in the DOM that matches. (Use 

<a class="ulink" href="http://bit.ly/WwINKs" target="_top"><code class="literal">selectAll()</code></a> when you need more than one element.) In this case, we just want the <code class="literal">body</code> of the document, so a reference to <code class="literal">body</code> is handed off to the next method in our chain. </dd> 
<dt>
<span class="term"> <code class="literal">.append("p")</code> </span></dt> 
<dd> 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-append" target="_top"><code class="literal">append()</code></a> creates whatever new DOM element you specify and appends it to the end (but 
<span class="emphasis">
<em>just inside</em></span>) of whatever selection it’s acting on. In our case, we want to create a new <code class="literal">p</code> within the <code class="literal">body</code>. We specified <code class="literal">"p"</code> as the input argument, but this method also sees the reference to <code class="literal">body</code> that was passed down the chain from the <code class="literal">select()</code> method. So an empty <code class="literal">p</code> paragraph is 
<span class="emphasis">
<em>appended</em></span> to the <code class="literal">body</code>. Finally, <code class="literal">append()</code> hands off a reference to the new element it just created. </dd> 
<dt>
<span class="term"> <code class="literal">.text("New paragraph!")</code> </span></dt> 
<dd> 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-text" target="_top"><code class="literal">text()</code></a> takes a string and inserts it between the opening and closing tags of the current selection. Because the previous method passed down a reference to our new <code class="literal">p</code>, this code just inserts the new text between <code class="literal">&lt;p&gt;</code> and <code class="literal">&lt;/p&gt;</code>. (In cases where there is existing content, it will be overwritten.) </dd> 
<dt>
<span class="term"> <code class="literal">;</code> </span></dt> 
<dd> The all-important semicolon indicates the end of this line of code. Chain over. </dd> </dl></div> </div> 
<div class="sect2" id="_the_hand_off"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">The Hand-off</h3></div></div></div> 
<p id="many_but_not_a">Many, but not all, D3 methods return a selection (actually, a reference to a selection), which enables this handy technique of method chaining. Typically, a method returns a reference to the element that it just acted on, but not always.

<a id="id502536" class="indexterm"></a></p> 
<p id="so_remember_thi">So remember this: when chaining methods, order matters. The output type of one method has to match the input type expected by the next method in the chain. If adjacent inputs and outputs are mismatched, the hand-off will function more like a dropped baton in a middle-school relay race.</p> 
<p id="when_sussing_ou">When sussing out what each function expects and returns, 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/API-Reference" target="_top">the API reference</a> is your friend. It contains detailed information on each method, including whether or not it returns a selection.

<a id="id502566" class="indexterm"></a>

<a id="id502575" class="indexterm"></a></p> </div> 
<div class="sect2" id="_going_chainless"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Going Chainless</h3></div></div></div> 
<p id="our_sample_code">Our sample code could be rewritten without chain syntax:</p> 
<pre class="programlisting" data-language="javascript" id="var_body__ds"><code class="kd">var</code> <code class="nx">body</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">);</code> <code class="kd">var</code> <code class="nx">p</code> <code class="o">=</code> <code class="nx">body</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">);</code> <code class="nx">p</code><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code></pre> 
<p id="ugh_what_a_mes">Ugh! What a mess. Yet there will be times you need to break the chain, such as when you are calling so many functions that it doesn’t make sense to string them all together. Or just because you want to organize your code in a way that makes more sense to you.</p> 
<p id="now_that_you_kn">Now that you know how to generate new page elements with D3, it’s time to attach data to them.

<a id="id502733" class="indexterm"></a>

<a id="id502742" class="indexterm"></a></p> </div> </div> 
<div class="sect1" data-original-filename="5_data.asciidoc" id="_binding_data"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Binding Data</h2></div></div></div> 
<p id="what_is_binding">What is binding, and why would I want to do it to my data?

<a id="ix_databind" class="indexterm"></a>

<a id="ix_pebind" class="indexterm"></a></p> 
<p id="data_visualizat_id3">Data visualization is a process of 
<span class="emphasis">
<em>mapping</em></span> data to visuals. Data in, visual properties out. Maybe bigger numbers make taller bars, or special categories trigger brighter colors. The mapping rules are up to you.

<a id="id502809" class="indexterm"></a></p> 
<p id="with_d_we_bin">With D3, we 
<span class="emphasis">
<em>bind</em></span> our data input values to elements in the DOM. Binding is like “attaching” or associating data to specific elements, so that later you can reference those values to apply mapping rules. Without the binding step, we have a bunch of data-less, unmappable DOM elements. No one wants that.</p> 
<div class="sect2" id="_in_a_bind"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">In a Bind</h3></div></div></div> 
<p id="we_use_ds_sel">We use D3’s 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-data" target="_top"><code class="literal">selection.data()</code></a> method to bind data to DOM elements. But there are two things we need in place first, before we can bind data:</p> 
<div class="itemizedlist" id="the_data_a_sele">
<ul class="itemizedlist"> 
<li class="listitem"> The data </li> 
<li class="listitem"> A selection of DOM elements </li> </ul></div> 
<p id="lets_tackle_th">Let’s tackle these one at a time.</p> </div> 
<div class="sect2" id="_data"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Data</h3></div></div></div> 
<p id="d_is_smart_abo">D3 is smart about handling different kinds of data, so it will accept practically any array of numbers, strings, or objects (themselves containing other arrays or key/value pairs). It can handle JSON (and GeoJSON) gracefully, and even has a built-in method to help you load in CSV files.

<a id="id502899" class="indexterm"></a>

<a id="id502907" class="indexterm"></a></p> 
<p id="but_to_keep_thi">But to keep things simple, for now we will start with a boring array of five numbers. Here is our sample dataset:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id1"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<p id="if_youre_feeli">If you’re feeling adventurous, or already have some data in CSV or JSON format that you want to play with, here’s how to do that. Otherwise, just skip ahead to 

<a class="xref" href="#please_make_your_selection_5" title="Please Make Your Selection">“Please Make Your Selection”</a>. 

<a id="id503013" class="indexterm"></a>

<a id="id503018" class="indexterm"></a></p> 
<div class="sect3" id="_loading_csv_data"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Loading CSV data</h4></div></div></div> 
<p id="csv_stands_for_">CSV stands for comma-separated values. A CSV data file might look something like this:</p> 
<pre class="screen" id="fooddeliciousn">Food,Deliciousness Apples,9 Green Beans,5 Egg Salad Sandwich,4 Cookies,10 Vegemite,0.2 Burrito,7</pre> 
<p id="each_line_in_th">Each line in the file has the same number of values (two, in this case), and values are separated by a comma. The first line in the file often serves as a header, providing names for each of the “columns” of data.</p> 
<p id="if_you_have_dat">If you have data in an Excel file, it probably follows a similar structure of rows and columns.  To get that data into D3, open it in Excel, then choose Save as… and select CSV as the file type.</p> 
<p id="if_we_saved_the">If we saved the preceding CSV data into a file called 
<span class="emphasis">
<em>food.csv</em></span>, then we could load the file into D3 by using the <code class="literal">d3.csv()</code> method:</p> 
<pre class="programlisting" data-language="javascript" id="dcsvfoodcs"><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code> <code class="p">});</code></pre> 
<p id="csv_takes_two"><code class="literal">csv()</code> takes two arguments: a string representing the path of the CSV file to load in, and an anonymous function, to be used as a 
<span class="emphasis">
<em>callback function</em></span>. The callback function is “called” only 
<span class="emphasis">
<em>after</em></span> the CSV file has been loaded into memory. So you can be sure that, by the time the callback is called, <code class="literal">d3.csv()</code> is done executing.

<a id="id503200" class="indexterm"></a>

<a id="id503206" class="indexterm"></a></p> 
<p id="when_called_th">When called, the anonymous function is handed the result of the CSV loading and parsing process; that is, the data. Here I’m naming it <code class="literal">data</code>, but this could be called whatever you like. You should use this callback function to do all the things you can do only 
<span class="emphasis">
<em>after</em></span> the data has been loaded. In the preceding example, we are just logging the value of the <code class="literal">data</code> array to the console, to verify it, as shown in 

<a class="xref" href="#Array_logged_to_console" title="Figure 5-3. Array logged to console">Figure 5-3</a>. (See 
<span class="emphasis">
<em>03_csv_loading_example.html</em></span> in the example code.)</p> 
<div class="figure" id="Array_logged_to_console"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0503.png" alt="Array logged to console"></div></div> 
<div class="figure-title">Figure 5-3. Array logged to console</div> </div> 
<p id="you_can_see_tha">You can see that <code class="literal">data</code> is an array (because of the hard brackets <code class="literal">[]</code> on either end) with six elements, each of which is an object. By toggling the disclosure triangles next to each object, we can see their

<a id="id503287" class="indexterm"></a> values (see 

<a class="xref" href="#Array_elements_expanded" title="Figure 5-4. Array elements expanded">Figure 5-4</a>).</p> 
<div class="figure" id="Array_elements_expanded"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0504.png" alt="Array elements expanded"></div></div> 
<div class="figure-title">Figure 5-4. Array elements expanded</div> </div> 
<p id="aha_each_objec">Aha! Each object has both a <code class="literal">Food</code> property and a <code class="literal">Deliciousness</code> property, the values of which correspond to the values in our CSV! (There is also a third property, <code class="literal">__proto__</code>, but that has to do with how JavaScript handles objects, and you can ignore it for now.) D3 has employed the first row of the CSV for property names, and subsequent rows for values. You might not realize it, but this just saved you a 
<span class="emphasis">
<em>lot</em></span> of time.

<a id="id503347" class="indexterm"></a></p> 
<p id="one_more_thing__id1">One more thing to note is that each value from the CSV is stored as a string, even the numbers. (You can tell because 9 is surrounded by quotation marks, as in <code class="literal">"9"</code> and not simply <code class="literal">9</code>.) This could cause unexpected behavior later, if you try to reference your data as a numeric value but it is still typed as a string.</p> 
<div class="sidebar" id="handling_data_loading_errors_5"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Handling Data Loading Errors</div></div></div></div> 
<p id="note_that_dcs">Note that <code class="literal">d3.csv()</code> is an 
<span class="emphasis">
<em>asynchronous</em></span> method, meaning that the rest of your code is executed even while JavaScript is simultaneously waiting for the file to finish downloading into the browser.  (The same is true of D3’s other functions that load external resources, such as <code class="literal">d3.json()</code>.)

<a id="id503406" class="indexterm"></a>

<a id="id503412" class="indexterm"></a></p> 
<p id="this_can_potent">This can potentially be 
<span class="emphasis">
<em>very</em></span> confusing, because you—as a reasonable human person—might assume that the CSV file’s data is available, when in fact it hasn’t finished loading yet.  A common mistake is to include references to the external data 
<span class="emphasis">
<em>outside of</em></span> the callback function.  Save yourself some headaches and make sure to reference your data only from 
<span class="emphasis">
<em>within</em></span> the callback function (or from within other functions that you call within the callback function).

<a id="id503442" class="indexterm"></a>

<a id="id503448" class="indexterm"></a></p> 
<p id="personally_i_l">Personally, I like to declare a global variable first, then call <code class="literal">d3.csv()</code> to load the data.  Within the callback function, I copy the data into my global variable (so it’s available to all of my subsequent functions), and finally I call any functions that rely on that data being present.  For example:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset__id1"><code class="kd">var</code> <code class="nx">dataset</code><code class="p">;</code>  <code class="c1">//Global variable</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">dataset</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>    <code class="c1">//Once loaded, copy to dataset.</code>     <code class="nx">generateVis</code><code class="p">();</code>     <code class="c1">//Then call other functions that</code>     <code class="nx">hideLoadingMsg</code><code class="p">();</code>  <code class="c1">//depend on data being present.</code> <code class="p">});</code></pre> 
<p id="to_further_conf">To further confuse matters, the callback function is executed 
<span class="emphasis">
<em>whether or not the datafile was loaded successfully</em></span>.  That’s right, if the network connection fails, or the filename is misspelled, or for some reason an error occurs on the web server end, the callback function will 
<span class="emphasis">
<em>still</em></span> be executed.  When the data fails to load, and you call functions that rely on that data being present, you will probably see an error in the console, and the visualization won’t be created.  This scenario might happen only rarely, but it’s useful to know how to handle it.</p> 
<p id="fortunately_yo_id2">Fortunately, you can include an optional <code class="literal">error</code> parameter in the callback function definition.  If there is a problem loading the file, then <code class="literal">error</code> will be set to the error message returned by the web server, and <code class="literal">data</code> will be <code class="literal">undefined</code>.  If the file loads successfully and there is no error, then <code class="literal">error</code> will be <code class="literal">null</code>, and the <code class="literal">data</code> array will be populated as expected.  Note that <code class="literal">error</code> must be the first parameter, and <code class="literal">data</code> the second:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset_d"><code class="kd">var</code> <code class="nx">dataset</code><code class="p">;</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>          <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">//If error is not null, something went wrong.</code>           <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>  <code class="c1">//Log the error.</code>         <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>      <code class="c1">//If no error, the file loaded correctly. Yay!</code>           <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>   <code class="c1">//Log the data.</code>        <code class="c1">//Include other code to execute after successful file load here</code>       <code class="nx">dataset</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>       <code class="nx">generateVis</code><code class="p">();</code>       <code class="nx">hideLoadingMsg</code><code class="p">();</code>         <code class="p">}</code>  <code class="p">});</code></pre> </div> 
<p id="verifying_your_">Verifying your data is a great use of the <code class="literal">csv()</code> callback function, but typically this is where you’d call other functions that construct the visualization, now that the data is available, as in:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset__id2"><code class="kd">var</code> <code class="nx">dataset</code><code class="p">;</code>  <code class="c1">//Declare global var</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>      <code class="c1">//Hand CSV data off to global var,</code>     <code class="c1">//so it's accessible later.</code>     <code class="nx">dataset</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>      <code class="c1">//Call some other functions that</code>     <code class="c1">//generate your visualization, e.g.:</code>     <code class="nx">generateVisualization</code><code class="p">();</code>     <code class="nx">makeAwesomeCharts</code><code class="p">();</code>     <code class="nx">makeEvenAwesomerCharts</code><code class="p">();</code>     <code class="nx">thankAwardsCommittee</code><code class="p">();</code>  <code class="p">});</code></pre> 
<p id="one_more_tip_i">One more tip: if you have 
<span class="emphasis">
<em>tab</em></span>-separated data in a TSV file, try the <code class="literal">d3.tsv()</code> method, which otherwise behaves exactly as the preceding method.

<a id="id504146" class="indexterm"></a></p> </div> 
<div class="sect3" id="_loading_json_data"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Loading JSON data</h4></div></div></div> 
<p id="well_spend_mor">We’ll spend more time talking about JSON later, but for now, all you need

<a id="id504167" class="indexterm"></a> to know is that the <code class="literal">d3.json()</code> method works the same way as <code class="literal">csv()</code>. Load your JSON data in this way:</p> 
<pre class="programlisting" data-language="javascript" id="djsonwaterf"><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"waterfallVelocities.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">json</code><code class="p">);</code>  <code class="c1">//Log output to console</code> <code class="p">});</code></pre> 
<p id="here_ive_name">Here, I’ve named the parsed output <code class="literal">json</code>, but it could be called <code class="literal">data</code> or whatever you like.</p> </div> </div> 
<div class="sect2" id="please_make_your_selection_5"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Please Make Your Selection</h3></div></div></div> 
<p id="the_data_is_rea_id1">The data is ready to go. As a reminder, we are working with this simple array:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id2"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<p id="now_you_need_to">Now you need to decide what to select. That is, what elements will your data be associated with? Again, let’s keep it super simple and say that we want to make a new paragraph for each value in the dataset. So you might imagine something like this would be helpful:</p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id4"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code></pre> 
<p id="and_youd_be_ri">and you’d be right, but there’s a catch: the paragraphs we want to select 
<span class="emphasis">
<em>don’t exist yet</em></span>. And this gets at one of the most common points of confusion with D3: how can we select elements that don’t yet exist? Bear with me, as the answer might require bending your mind a bit.</p> 
<p id="the_answer_lies">The answer lies with <code class="literal">enter()</code>, a truly magical method. See this code,

<a id="id504481" class="indexterm"></a>

<a id="id504487" class="indexterm"></a> which I’ll explain:</p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id5"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code></pre> 
<p id="view_the_exampl">View the example code 
<span class="emphasis">
<em>04_creating_paragraphs.html</em></span> and you should see five new paragraphs, each with the same content, as shown in 

<a class="xref" href="#Dynamic_paragraphs" title="Figure 5-5. Dynamic paragraphs">Figure 5-5</a>.</p> 
<div class="figure" id="Dynamic_paragraphs"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0505.png" alt="Dynamic paragraphs"></div></div> 
<div class="figure-title">Figure 5-5. Dynamic paragraphs</div> </div> 
<p id="heres_whats_h">Here’s what’s happening:</p> 
<div class="variablelist" id="dselectbody_id6">
<dl class="variablelist"> 
<dt>
<span class="term"> <code class="literal">d3.select("body")</code> </span></dt> 
<dd> Finds the <code class="literal">body</code> in the DOM and hands off a reference to the next step in the chain. </dd> 
<dt>
<span class="term"> <code class="literal">.selectAll("p")</code> </span></dt> 
<dd> Selects all paragraphs in the DOM. Because none exist yet, this returns an empty selection. Think of this empty selection as representing the paragraphs that 
<span class="emphasis">
<em>will soon exist</em></span>. </dd> 
<dt>
<span class="term"> <code class="literal">.data(dataset)</code> </span></dt> 
<dd> Counts and parses our data values. There are five values in our array called <code class="literal">dataset</code>, so everything past this point is executed five times, once for each value. </dd> 
<dt>
<span class="term"> <code class="literal">.enter()</code> </span></dt> 
<dd> To create new, data-bound elements, you must use <code class="literal">enter()</code>. This method looks at the current DOM selection, and then at the data being handed to it. If there are more data values than corresponding DOM elements, then <code class="literal">enter()</code> 
<span class="emphasis">
<em>creates a new placeholder element</em></span> on which you can work your magic. It then hands off a reference to this new placeholder to the next step in the chain. </dd> 
<dt>
<span class="term"> <code class="literal">.append("p")</code> </span></dt> 
<dd> Takes the empty placeholder selection created by <code class="literal">enter()</code> and appends a <code class="literal">p</code> element into the DOM. Hooray! Then it hands off a reference to the element it just created to the next step in the chain. </dd> 
<dt>
<span class="term"> <code class="literal">.text("New paragraph!")</code> </span></dt> 
<dd> Takes the reference to the newly created <code class="literal">p</code> and inserts a text value. </dd> </dl></div> </div> 
<div class="sect2" id="_bound_and_determined"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Bound and Determined</h3></div></div></div> 
<p id="all_right_our_">All right! Our data has been read, parsed, and bound to new <code class="literal">p</code> elements that we created in the DOM. Don’t believe me? Take another look at 
<span class="emphasis">
<em>04_creating_paragraphs.html</em></span> and whip out your web inspector, shown in 

<a class="xref" href="#new_p_elements_in_the_inspector" title="Figure 5-6. New p elements in the web inspector">Figure 5-6</a>.</p> 
<div class="figure" id="new_p_elements_in_the_inspector"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0506.png" alt="New p elements in the web inspector"></div></div> 
<div class="figure-title">Figure 5-6. New <code class="literal">p</code> elements in the web inspector</div> </div> 
<p id="okay_i_see_fiv">Okay, I see five paragraphs, but where’s the data? Switch to the JavaScript console, type in the following code, and click Enter. The results are shown in 

<a class="xref" href="#logging_to_from_console" title="Figure 5-7. Logging to the console, from the console">Figure 5-7</a>:</p> 
<pre class="programlisting" data-language="javascript" id="consolelogd"><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">))</code></pre> 
<div class="figure" id="logging_to_from_console"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0507.png" alt="Logging to the console, from the console"></div></div> 
<div class="figure-title">Figure 5-7. Logging to the console, from the console</div> </div> 
<p id="an_array_or_r">An array! Or, really, an array containing another array. Click the gray disclosure triangle to reveal its contents, shown in 

<a class="xref" href="#array_of_arrays" title="Figure 5-8. Array of arrays, expanded">Figure 5-8</a>.</p> 
<div class="figure" id="array_of_arrays"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0508.png" alt="Array of arrays, expanded"></div></div> 
<div class="figure-title">Figure 5-8. Array of arrays, expanded</div> </div> 
<p id="youll_notice_t_id1">You’ll notice the five <code class="literal">p</code>s, numbered 0 through 4. Click the disclosure triangle next to the first one (number zero), which results in the view shown in 

<a class="xref" href="#the_p_element_expanded" title="Figure 5-9. The p element, expanded">Figure 5-9</a>.</p> 
<div class="figure" id="the_p_element_expanded"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0509.png" alt="The p element, expanded"></div></div> 
<div class="figure-title">Figure 5-9. The p element, expanded</div> </div> 
<p id="see_it_do_you_">See it? Do you see it? I can barely contain myself. There it is (

<a class="xref" href="#finally_bound_data" title="Figure 5-10. Finally, bound data">Figure 5-10</a>).</p> 
<div class="figure" id="finally_bound_data"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0510.png" alt="Finally, bound data"></div></div> 
<div class="figure-title">Figure 5-10. Finally, bound data</div> </div> 
<p id="our_first_data_">Our first data value, the number <code class="literal">5</code>, is showing up under the first paragraph’s 
<span class="keep-together"><code class="literal">__data__</code></span> attribute. Click into the other paragraph elements, and you’ll see they also contain <code class="literal">__data__</code> values: 10, 15, 20, and 25, just as we specified.</p> 
<p id="you_see_when_d">You see, when D3 binds data to an element, that data doesn’t exist in the DOM, but it does exist in memory as a <code class="literal">__data__</code> attribute of that element. And the console is where you can go to confirm whether or not your data was bound as expected.</p> 
<p id="the_data_is_rea_id2">The data is ready. Let’s do something with it.

<a id="id505112" class="indexterm"></a>

<a id="id505121" class="indexterm"></a></p> </div> 
<div class="sect2" id="_using_your_data"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Using Your Data</h3></div></div></div> 
<p id="we_can_see_that">We can see that the data has been loaded into the page and is bound to

<a id="ix_bound" class="indexterm"></a> our newly created elements in the DOM, but can we 
<span class="emphasis">
<em>use</em></span> it? Here’s our code so far:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id3"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code></pre> 
<p id="lets_change_th">Let’s change the last line to:</p> 
<pre class="programlisting" data-language="javascript" id="textfunction_id1">    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="now_test_out_th">Now test out that new code in 
<span class="emphasis">
<em>05_creating_paragraphs_text.html</em></span>. You should see the result shown in 

<a class="xref" href="#more_dynamic_paragraphs" title="Figure 5-11. More dynamic paragraphs">Figure 5-11</a>.</p> 
<div class="figure" id="more_dynamic_paragraphs"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0511.png" alt="More dynamic paragraphs"></div></div> 
<div class="figure-title">Figure 5-11. More dynamic paragraphs</div> </div> 
<div class="sidebar online_only" id="interactive_5-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="change_the_last_id1">Change the last line of the D3 code below from <code class="literal">.text("New paragraph!");</code> to <code class="literal">.text(function(d) { return d; });</code> and see the results change to match 

<a class="xref" href="#more_dynamic_paragraphs" title="Figure 5-11. More dynamic paragraphs">Figure 5-11</a>.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_05/04_creating_paragraphs.html" target="_blank">04_creating_paragraphs</a></p> 

<p id="whoa_we_used_o">Whoa! We used our data to populate the contents of each paragraph, all thanks to the magic of the <code class="literal">data()</code> method. You see, when chaining methods together, anytime after you call <code class="literal">data()</code>, you can create an anonymous function that accepts <code class="literal">d</code> as input. The magical <code class="literal">data()</code> method ensures that <code class="literal">d</code> is set to the corresponding value in your original dataset, given the current element at hand.

<a id="id443742" class="indexterm"></a></p> 
<p id="the_value_of_t">The value of “the current element” changes over time as D3 loops through each element. For example, when looping through the third time, our code creates the third <code class="literal">p</code> tag, and <code class="literal">d</code> will correspond to the third value in our dataset (or <code class="literal">dataset[2]</code>). So the third paragraph gets text content of “15”.</p> </div> 
<div class="sect2" id="_high_functioning"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">High-Functioning</h3></div></div></div> 
<p id="in_case_youre__id1">In case you’re new to writing your own functions (a.k.a. methods), the

<a id="id506309" class="indexterm"></a>

<a id="id506317" class="indexterm"></a>

<a id="id506323" class="indexterm"></a>

<a id="id506329" class="indexterm"></a>

<a id="id506337" class="indexterm"></a> basic structure of a function definition is:</p> 
<pre class="programlisting" data-language="javascript" id="functioninput_"><code class="kd">function</code><code class="p">(</code><code class="nx">input_value</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Calculate something here</code>     <code class="k">return</code> <code class="nx">output_value</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="the_function_we">The function we used earlier is dead simple, nothing fancy:</p> 
<pre class="programlisting" data-language="javascript" id="functiond__r_id1"><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="this_is_called_">This is called an 
<span class="emphasis">
<em>anonymous function</em></span>, because it doesn’t have a name.  Contrast that with a function that’s stored in a variable, which is a 
<span class="emphasis">
<em>named function</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="var_dosomething"><code class="kd">var</code> <code class="nx">doSomething</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>     <code class="c1">//Code to do something here</code> <code class="p">};</code></pre> 
<p id="well_write_lot">We’ll write lots of anonymous functions when using D3.  They are the key to accessing individual data values and calculating dynamic properties.</p> 
<p id="this_particular_id1">This particular anonymous function is wrapped within D3’s <code class="literal">text()</code> function.  So our anonymous function is executed first. Then its result is handed off to <code class="literal">text()</code>. Then <code class="literal">text()</code> finally works its magic (by inserting its input argument as text within the selected DOM element):</p> 
<pre class="programlisting" data-language="javascript" id="textfunction_id2"><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="but_we_can_and">But we can (and will) get much fancier because you can customize these functions any way you like. Yes, this is both the pleasure and pain of writing your own JavaScript.  Maybe you’d like to add some extra text, as in:</p> 
<pre class="programlisting" data-language="javascript" id="textfunction_id3"><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="s2">"I can count up to "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="which_produces_">which produces the result shown in 

<a class="xref" href="#Still_more_dynamic_paragraphs" title="Figure 5-12. Still more dynamic paragraphs">Figure 5-12</a>, as seen in example file 
<span class="emphasis">
<em>06_creating_paragraphs_counting.html</em></span>.</p> 
<div class="figure" id="Still_more_dynamic_paragraphs"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0512.png" alt="Still more dynamic paragraphs"></div></div> 
<div class="figure-title">Figure 5-12. Still more dynamic paragraphs</div> </div> 
<div class="sidebar online_only" id="interactive_5-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="change_the_last_id2">Change the last line of the D3 code below from <code class="literal">return d;</code> to <code class="literal">return "I can count up to " + d;</code> and see the results change to match 

<a class="xref" href="#Still_more_dynamic_paragraphs" title="Figure 5-12. Still more dynamic paragraphs">Figure 5-12</a>.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_05/05_creating_paragraphs_text.html" target="_blank">05_creating_paragraphs_text</a></p> 

<div class="sect2" id="_data_wants_to_be_held"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Data Wants to Be Held</h3></div></div></div> 
<p id="you_might_be_wo">You might be wondering why you have to write out <code class="literal">function(d) { … }</code> instead of just <code class="literal">d</code> on its own. For example, this won’t work:</p> 
<pre class="programlisting" data-language="javascript" id="texti_can_co"><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"I can count up to "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">);</code></pre> 
<p id="in_this_context">In this context, without wrapping <code class="literal">d</code> in an anonymous function, <code class="literal">d</code> has

<a id="id506854" class="indexterm"></a>

<a id="id506863" class="indexterm"></a> no value. Think of <code class="literal">d</code> as a lonely little placeholder value that just needs a warm, containing hug from a kind, caring function’s parentheses. (Extending this metaphor further, yes, it is creepy that the hug is being given by an 
<span class="emphasis">
<em>anonymous</em></span> function, but that only confuses matters.)</p> 
<p id="here_is_d_being">Here is <code class="literal">d</code> being held gently and appropriately by a function:</p> 
<pre class="programlisting" data-language="javascript" id="textfunction_id4"><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">// &lt;-- Note tender embrace at left</code>     <code class="k">return</code> <code class="s2">"I can count up to "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="the_reason_for_">The reason for this syntax is that <code class="literal">.text()</code>, <code class="literal">attr()</code>, and many other D3 methods can take a 
<span class="emphasis">
<em>function</em></span> as an argument. For example, <code class="literal">text()</code> can

<a id="id507002" class="indexterm"></a>

<a id="id507008" class="indexterm"></a> take either simply a static string of text as an argument:</p> 
<pre class="programlisting" data-language="javascript" id="textsomestri"><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"someString"</code><code class="p">)</code></pre> 
<p id="or_the_result_o">
<span class="emphasis">
<em>or</em></span> the result of a function:</p> 
<pre class="programlisting" data-language="javascript" id="textsomefunct"><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">someFunction</code><code class="p">())</code>  <code class="c1">// Presumably, someFunction() would return a string</code></pre> 
<p id="or_an_anonymous">
<span class="emphasis">
<em>or</em></span> an anonymous function itself can be the argument, such as when you write:</p> 
<pre class="programlisting" data-language="javascript" id="textfunction_id5"><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">})</code></pre> 
<p id="here_you_are_d">Here, you are defining an anonymous function. If D3 sees a function there, it will 
<span class="emphasis">
<em>call</em></span> that function, while handing off the current datum <code class="literal">d</code> as the function’s argument.  Here, I’ve named the argument <code class="literal">d</code> just by convention.  You could call it <code class="literal">datum</code> or <code class="literal">info</code> or whatever you like.  All D3 is looking for is 
<span class="emphasis">
<em>any</em></span> argument name, into which it can pass the current datum.  Throughout this book, we’ll use <code class="literal">d</code> because it is concise and familiar from many of the other D3 examples found online.</p> 
<p id="in_any_case_wi">In any case, without that function in place, D3 couldn’t relay the current data value.  Without an anonymous function and its argument there to receive the value of <code class="literal">d</code>, D3 could get confused and even start crying. (D3 is more emotional than you’d expect.)</p> 
<p id="at_first_this_">At first, this might seem silly and like a lot of extra work to just get at <code class="literal">d</code>, but the value of this approach will become clear as we work on more complex pieces.</p> </div> 
<div class="sect2" id="_beyond_text"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Beyond Text</h3></div></div></div> 
<p id="things_get_a_lo">Things get a lot more interesting when we explore D3’s other methods,

<a id="id507246" class="indexterm"></a> like <code class="literal">attr()</code> and <code class="literal">style()</code>, which allow us to set HTML attributes and

<a id="id507267" class="indexterm"></a> CSS properties on selections, 
<span class="keep-together">respectively</span>.

<a id="id507282" class="indexterm"></a>

<a id="id507288" class="indexterm"></a></p> 
<p id="for_example_ad">For example, adding one more line to our code:</p> 
<pre class="programlisting" data-language="javascript" id="stylecolor_id1"><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"color"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code></pre> 
<p id="produces_the_re">produces the result shown in 

<a class="xref" href="#Red_paragraphs" title="Figure 5-13. Red paragraphs">Figure 5-13</a>, as seen in 
<span class="emphasis">
<em>07_creating_paragraphs_with_style.html</em></span>.</p> 
<div class="figure" id="Red_paragraphs"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0513.png" alt="Red paragraphs"></div></div> 
<div class="figure-title">Figure 5-13. Red paragraphs</div> </div> 
<p id="all_the_text_is">All the text is now red; big deal. But we could use a custom function to make the text red only if the current datum exceeds a certain threshold. So we revise that last line to use a function instead of a string:</p> 
<pre class="programlisting" data-language="javascript" id="stylecolor_id2"><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"color"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">d</code> <code class="o">&gt;</code> <code class="mi">15</code><code class="p">)</code> <code class="p">{</code>   <code class="c1">//Threshold of 15</code>         <code class="k">return</code> <code class="s2">"red"</code><code class="p">;</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"black"</code><code class="p">;</code>     <code class="p">}</code> <code class="p">});</code></pre> 
<p id="see_the_resulti">See the resulting change, displayed in 

<a class="xref" href="#Dynamically_styled_paragraphs" title="Figure 5-14. Dynamically styled paragraphs">Figure 5-14</a>, in 
<span class="emphasis">
<em>08_creating_paragraphs_with_style_functions.html</em></span>.</p> 
<div class="figure" id="Dynamically_styled_paragraphs"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0514.png" alt="Dynamically styled paragraphs"></div></div> 
<div class="figure-title">Figure 5-14. Dynamically styled paragraphs</div> </div> 
<p id="notice_how_the__id2">Notice how the first three lines are black, but once <code class="literal">d</code> exceeds the arbitrary threshold of 15, the text turns red.

<a id="id507562" class="indexterm"></a></p> 
<p id="okay_weve_got">Okay, we’ve got data loaded in, and dynamically created DOM elements bound to that data. I’d say we’re ready to start drawing with data!

<a id="id507573" class="indexterm"></a>

<a id="id507580" class="indexterm"></a></p> 
<div class="sidebar online_only" id="interactive_5-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Exercise</div></div></div></div> 
<p id="modify_the_code">Modify the code on the left from 
<span class="emphasis">
<em>08_creating_paragraphs_with_style_functions.html</em></span> to highlight even-number data values in red and odd-number data values in black, and check the results in the output on the right</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_05/08_creating_paragraphs_with_style_functions.html" target="_blank">08_creating_paragraphs_with_style_functions</a></p> 

<section class="chapter" data-original-filename="6_drawing_with_data.asciidoc" id="drawing_with_data">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 6. Drawing with Data</h1></div></div></div> 
<p id="its_time_to_st">It’s time to start drawing with data.</p> 
<p id="lets_continue_">Let’s continue working with our simple dataset for now:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id4"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<div class="sect1" data-original-filename="6_drawing_with_data.asciidoc" id="_drawing_divs"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Drawing divs</h2></div></div></div> 
<p id="well_use_this_">We’ll use this to generate a super-simple bar chart. Bar charts are essentially just rectangles, and an HTML <code class="literal">div</code> is the easiest way to draw a rectangle. (Then again, to a web browser, 
<span class="emphasis">
<em>everything</em></span> is a rectangle, so you could easily adapt this example to use <code class="literal">span</code>s or whatever element you prefer.)

<a id="id507732" class="indexterm"></a>

<a id="id507737" class="indexterm"></a></p> 
<p id="formally_a_cha">Formally, a chart with vertically oriented rectangles is a 
<span class="emphasis">
<em>column</em></span> chart, and one with horizontal rectangles is a 
<span class="emphasis">
<em>bar</em></span> chart. In practice, most people just call them all bar charts, as I’ll do from now on.

<a id="id507755" class="indexterm"></a>

<a id="id507761" class="indexterm"></a>

<a id="id507768" class="indexterm"></a></p> 
<p id="this_div_could_">This <code class="literal">div</code> could work well as a data bar, shown in 

<a class="xref" href="#A_humble_div" title="Figure 6-1. A humble div">Figure 6-1</a>.</p> 
<div class="figure" id="A_humble_div"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0601.png" alt="A humble div"></div></div> 
<div class="figure-title">Figure 6-1. A humble div</div> </div> 
<pre class="programlisting" data-language="html" id="div_styledis"><code class="nt">&lt;div</code> <code class="na">style=</code><code class="s">"display: inline-block;</code> <code class="s">            width: 20px;</code> <code class="s">            height: 75px;</code> <code class="s">            background-color: teal;"</code><code class="nt">&gt;&lt;/div&gt;</code></pre> 
<p id="among_web_stand">Among web standards folks, this is a semantic no-no. Normally, one shouldn’t use an empty <code class="literal">div</code> for purely visual effect, but I am making an exception for the sake of this example.</p> 
<p id="because_this_is">Because this is a <code class="literal">div</code>, its <code class="literal">width</code> and <code class="literal">height</code> are set with CSS styles. Except for <code class="literal">height</code>, each bar in our chart will share the same display properties, so I’ll put those shared styles into a class called <code class="literal">bar</code>, as an embedded style up in the <code class="literal">head</code> of the document:</p> 
<pre class="programlisting" data-language="css" id="divbar__displ"><code class="nt">div</code><code class="nc">.bar</code> <code class="p">{</code>     <code class="k">display</code><code class="o">:</code> <code class="nb">inline</code><code class="o">-</code><code class="nb">block</code><code class="p">;</code>     <code class="k">width</code><code class="o">:</code> <code class="m">20px</code><code class="p">;</code>     <code class="k">height</code><code class="o">:</code> <code class="m">75px</code><code class="p">;</code>   <code class="c">/* We'll override height later */</code>     <code class="k">background-color</code><code class="o">:</code> <code class="nb">teal</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="now_each_div_ne">Now each <code class="literal">div</code> needs to be assigned the <code class="literal">bar</code> class, so our new CSS rule will apply. If you were writing the HTML code by hand, you would write the following:</p> 
<pre class="programlisting" data-language="html" id="div_classbar"><code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"bar"</code><code class="nt">&gt;&lt;/div&gt;</code></pre> 
<p id="using_d_to_ad">Using D3, to add a class to an element, we use the <code class="literal">selection.attr()</code> method. It’s important to understand the difference between <code class="literal">attr()</code> and its close cousin, <code class="literal">style()</code>. <code class="literal">attr()</code> sets DOM attribute values, whereas <code class="literal">style()</code> applies CSS styles directly to an element.

<a id="id508080" class="indexterm"></a>

<a id="id508088" class="indexterm"></a></p> 
<div class="sect2" id="_setting_attributes"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Setting Attributes</h3></div></div></div> 
<p id="attr_is_used_">

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-attr" target="_top"><code class="literal">attr()</code></a> is used to set an HTML attribute and its value on an element. An HTML attribute is any property/value pair that you could include between an

<a id="id508114" class="indexterm"></a> element’s <code class="literal">&lt;&gt;</code> brackets. For example, these HTML elements:</p> 
<pre class="programlisting" data-language="html" id="p_classcapti"><code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"caption"</code><code class="nt">&gt;</code> <code class="nt">&lt;select</code> <code class="na">id=</code><code class="s">"country"</code><code class="nt">&gt;</code> <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"logo.png"</code> <code class="na">width=</code><code class="s">"100px"</code> <code class="na">alt=</code><code class="s">"Logo"</code> <code class="nt">/&gt;</code></pre> 
<p id="contain_a_total">contain a total of five attributes (and corresponding values), all of which could be set with <code class="literal">attr()</code>:</p> 
<div class="informaltable" id="attribute_value">
<table style="width: 50%; border-collapse: collapse;"> 
<colgroup> 
<col class="col_1"> 
<col class="col_2"> </colgroup> 
<thead>
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Attribute     </td> 
<td style="border-bottom: 0.5pt solid ; "> Value</td> </tr></thead> 
<tbody> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="class"><code class="literal">class</code></p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="caption"><code class="literal">caption</code></p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="id"><code class="literal">id</code></p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="country"><code class="literal">country</code></p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="src"><code class="literal">src</code></p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="logopng"><code class="literal">logo.png</code></p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<p id="width"><code class="literal">width</code></p></td> 
<td style="border-bottom: 0.5pt solid ; ">
<p id="px"><code class="literal">100px</code></p></td> </tr> 
<tr> 
<td style="border-right: 0.5pt solid ; ">
<p id="alt"><code class="literal">alt</code></p></td> 
<td>
<p id="logo"><code class="literal">Logo</code></p></td> </tr> </tbody> </table></div> 
<p id="to_assign_a_cla">To assign a class of <code class="literal">bar</code>, we can use:</p> 
<pre class="programlisting" data-language="javascript" id="attrclass_"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code></pre> </div> 
<div class="sect2" id="_a_note_on_classes"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">A Note on Classes</h3></div></div></div> 
<p id="note_that_an_el">Note that an element’s 
<span class="emphasis">
<em>class</em></span> is stored as an HTML attribute. The class, in turn, is used to reference a CSS style rule. This could cause some confusion because there is a difference between setting a 
<span class="emphasis">
<em>class</em></span> (from which styles are inferred) and applying a 
<span class="emphasis">
<em>style</em></span> directly to an element. You can do both with D3. Although you should use whatever approach makes the most sense to you, I recommend using 
<span class="emphasis">
<em>classes</em></span> for properties that are shared by multiple elements, and applying 
<span class="emphasis">
<em>style</em></span> rules directly only when deviating from the norm. (In fact, that’s what we’ll do in just a moment.)

<a id="id508413" class="indexterm"></a>

<a id="id508421" class="indexterm"></a></p> 
<p id="i_also_want_to_">I also want to briefly mention another D3 method, <code class="literal">classed()</code>, which can be used to quickly apply or remove classes from elements. The preceding line of

<a id="id508438" class="indexterm"></a> code could be rewritten as the following:</p> 
<pre class="programlisting" data-language="javascript" id="classedbar_id1"><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">,</code> <code class="kc">true</code><code class="p">)</code></pre> 
<p id="this_line_simpl">This line simply takes whatever selection is passed to it and applies the class <code class="literal">bar</code>. If <code class="literal">false</code> were specified, it would do the opposite, removing the class of <code class="literal">bar</code> from any elements in the selection:</p> 
<pre class="programlisting" data-language="javascript" id="classedbar_id2"><code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">,</code> <code class="kc">false</code><code class="p">)</code></pre> </div> 
<div class="sect2" id="_back_to_the_bars"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Back to the Bars</h3></div></div></div> 
<p id="putting_it_all__id1">Putting it all together with our dataset, here is the complete D3 code so far:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id5"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">);</code></pre> 
<p id="to_see_whats_g">To see what’s going on, look at 
<span class="emphasis">
<em>01_drawing_divs.html</em></span> in your browser, view the source, and open your web inspector. You should see five vertical <code class="literal">div</code> bars, one generated for each point in our dataset. However, with no space between them, they look like one big rectangle, as seen in Figures 

<a class="xref" href="#Five_divs_masquerading_as_one" title="Figure 6-2. Five divs masquerading as one">6-2</a> and 

<a class="xref" href="#Five_divs_masquerading_as_one_inspector" title="Figure 6-3. Five divs masquerading as one, as seen through the web inspector">6-3</a>.</p> 
<div class="figure" id="Five_divs_masquerading_as_one"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0602.png" alt="Five divs masquerading as one"></div></div> 
<div class="figure-title">Figure 6-2. Five <code class="literal">div</code>s masquerading as one</div> </div> 
<div class="figure" id="Five_divs_masquerading_as_one_inspector"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0603.png" alt="Five divs masquerading as one, as seen through the web inspector"></div></div> 
<div class="figure-title">Figure 6-3. Five <code class="literal">div</code>s masquerading as one, as seen through the web inspector</div> </div> </div> 
<div class="sect2" id="_setting_styles"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Setting Styles</h3></div></div></div> 
<p id="the_style_met">The 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-style" target="_top"><code class="literal">style()</code></a> method is used to apply a CSS property and value directly to an HTML

<a id="id508842" class="indexterm"></a> element. This is the equivalent of including CSS rules within a <code class="literal">style</code> attribute right in your HTML, as in:</p> 
<pre class="programlisting" data-language="html" id="div_stylehei"><code class="nt">&lt;div</code> <code class="na">style=</code><code class="s">"height: 75px;"</code><code class="nt">&gt;&lt;/div&gt;</code></pre> 
<p id="to_make_a_bar_c">To make a bar chart, the height of each bar must be a function of its corresponding data value. So let’s add this to the end of our D3 code (taking care to keep the final semicolon at the very end of the chain):</p> 
<pre class="programlisting" data-language="javascript" id="styleheight_id1"><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="see_that_code_i_id1">See that code in 
<span class="emphasis">
<em>02_drawing_divs_height.html</em></span>. You should see a very small bar chart, like the one in 

<a class="xref" href="#A_small_bar_chart" title="Figure 6-4. A small bar chart">Figure 6-4</a>.</p> 
<div class="figure" id="A_small_bar_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0604.png" alt="A small bar chart"></div></div> 
<div class="figure-title">Figure 6-4. A small bar chart</div> </div> 
<p id="when_d_loops_t">When D3 loops through each data point, the value of <code class="literal">d</code> will be set to that of the corresponding value. So we are setting a <code class="literal">height</code> value of <code class="literal">d</code> (the current data value) while appending the text <code class="literal">px</code> (to specify the units are pixels). The resulting heights are <code class="literal">5px</code>, <code class="literal">10px</code>, <code class="literal">15px</code>, <code class="literal">20px</code>, and <code class="literal">25px</code>.</p> 
<p id="this_looks_a_li">This looks a little bit silly, so let’s make those bars taller:</p> 
<pre class="programlisting" data-language="javascript" id="styleheight_id2"><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="kd">var</code> <code class="nx">barHeight</code> <code class="o">=</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">5</code><code class="p">;</code>  <code class="c1">//Scale up by factor of 5</code>     <code class="k">return</code> <code class="nx">barHeight</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="add_some_space_">Add some space to the right of each bar (in the embedded CSS style, in the document <code class="literal">head</code>), to space things out:</p> 
<pre class="programlisting" data-language="css" id="marginright_"><code class="k">margin-right</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code></pre> 
<p id="nice_we_could_">Nice! We could go to 

<a class="ulink" href="https://www.siggraph.org" target="_top">SIGGRAPH</a> with that chart (

<a class="xref" href="#A_taller_bar_chart" title="Figure 6-5. A taller bar chart">Figure 6-5</a>).</p> 
<div class="figure" id="A_taller_bar_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0605.png" alt="A taller bar chart"></div></div> 
<div class="figure-title">Figure 6-5. A taller bar chart</div> </div> 
<p id="try_out_the_sam">Try out the sample code 
<span class="emphasis">
<em>03_drawing_divs_spaced.html</em></span>. Again, view the source and use the web inspector to contrast the original HTML against the final DOM.

<a id="id509246" class="indexterm"></a></p> </div> </div> 
<div class="sect1" data-original-filename="6_drawing_with_data.asciidoc" id="_the_power_of_data"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">The Power of data()</h2></div></div></div> 
<p id="this_is_excitin_id1">This is exciting, but real-world data is never this clean:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id6"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<p id="lets_make_our_">Let’s make our data a bit messier, as in 
<span class="emphasis">
<em>04_power_of_data.html</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id7"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">26</code><code class="p">,</code> <code class="mi">11</code> <code class="p">];</code></pre> 
<p id="that_change_in_">That change in data results in the bars shown in 

<a class="xref" href="#New_data_values" title="Figure 6-6. New data values">Figure 6-6</a>. We’re not limited to five data points, of course. Let’s add many more! (See 
<span class="emphasis">
<em>05_power_of_data_more_points.html</em></span>.)</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id8"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">26</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">14</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code>                 <code class="mi">14</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">29</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code>                 <code class="mi">24</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">3</code> <code class="p">];</code></pre> 
<div class="figure" id="New_data_values"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0606.png" alt="New data values"></div></div> 
<div class="figure-title">Figure 6-6. New data values</div> </div> 
<p id="twentyfive_dat">Twenty-five data points instead of five (see 

<a class="xref" href="#Lots_more_data_values" title="Figure 6-7. Lots more data values">Figure 6-7</a>)!</p> 
<div class="figure" id="Lots_more_data_values"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0607.png" alt="Lots more data values"></div></div> 
<div class="figure-title">Figure 6-7. Lots more data values</div> </div> 
<p id="how_does_d_aut">How does D3 automatically expand our chart as needed?

<a id="id509737" class="indexterm"></a></p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id7"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>  <code class="c1">// &lt;-- The answer is here!</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="kd">var</code> <code class="nx">barHeight</code> <code class="o">=</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">5</code><code class="p">;</code>         <code class="k">return</code> <code class="nx">barHeight</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code>     <code class="p">});</code></pre> 
<p id="give_data__">Give <code class="literal">data()</code> 10 values, and it will loop through 10 times. Give it one million values, and it will loop through one million times. (Just be patient.)</p> 
<p id="that_is_the_pow">That is the power of <code class="literal">data()</code>—being smart enough to loop through the full length of whatever dataset you throw at it, executing each method beneath it in the chain, while updating the context in which each method operates, so <code class="literal">d</code> always refers to the current datum at that point in the loop.</p> 
<p id="that_might_be_a">That might be a mouthful, and if it all doesn’t make sense yet, it will soon. I encourage you to make a copy of 
<span class="emphasis">
<em>05_power_of_data_more_points.html</em></span>, tweak the <code class="literal">dataset</code> values, and note how the bar chart changes.</p> 
<div class="sidebar online_only" id="interactive_6-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="tweak_the_datas">Tweak the <code class="literal">dataset</code> values in the code below at left, and note how the bar chart changes at right.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_06/05_power_of_data_more_points.html" target="_blank">05_power_of_data_more_points</a></p> 

<p id="remember_the_d">Remember, the 
<span class="emphasis">
<em>data</em></span> is driving the visualization—not the other way around.</p> 
<div class="sect2" id="_random_data"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Random Data</h3></div></div></div> 
<p id="sometimes_its_">Sometimes it’s fun to generate random data values, whether for testing

<a id="id510105" class="indexterm"></a> purposes or just pure geekiness. That’s just what I’ve done in 
<span class="emphasis">
<em>06_power_of_data_random.html</em></span>. Notice that each time you reload the page, the bars render differently, as shown in 

<a class="xref" href="#Bar_charts_with_random_values" title="Figure 6-8. Bar charts with random values">Figure 6-8</a>.</p> 
<div class="figure" id="Bar_charts_with_random_values"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0608.png" alt="Bar charts with random values"></div></div> 
<div class="figure-title">Figure 6-8. Bar charts with random values</div> </div> 
<div class="sidebar online_only" id="interactive_6-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_it_out_righ">Try it out right here in your browser. Hover over the bar graph and click the "Run with JS" button, and see the bars render differently as new random numbers are generated.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_06/06_power_of_data_random.html" target="_blank">06_power_of_data_random</a></p> 

<p id="view_the_source">View the source, and you’ll see this code:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id9"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[];</code>                         <code class="c1">//Initialize empty array</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">25</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>            <code class="c1">//Loop 25 times</code>     <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">30</code><code class="p">;</code>   <code class="c1">//New random number (0-30)</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">newNumber</code><code class="p">);</code>              <code class="c1">//Add new number to array</code> <code class="p">}</code></pre> 
<p id="that_code_doesn">That code doesn’t use any D3 methods; it’s just JavaScript. Without going into too much detail, this code does the following:</p> 
<div class="orderedlist" id="creates_an_empt_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Creates an empty array called <code class="literal">dataset</code>. </li> 
<li class="listitem"> Initiates a <code class="literal">for</code> loop, which is executed 25 times. </li> 
<li class="listitem"> Each time, it generates a new random number with a value between 0 and 30.  (Well, technically, 
<span class="emphasis">
<em>almost</em></span> 30.  <code class="literal">Math.random()</code> returns values as low as 0.0 all the way up to, but not including, 1.0.  So if <code class="literal">Math.random()</code> returned 0.99999, then the result would be 0.99999 times 30, which is 29.9997, or the teensiest bit less than 30.) </li> 
<li class="listitem"> That new number is appended to the <code class="literal">dataset</code> array. (<code class="literal">push()</code> is an array method that appends a new value to the end of an array.) </li> </ol></div> 
<p id="just_for_kicks">Just for kicks, open up the JavaScript console and enter <code class="literal">console.log(dataset)</code>. You should see the full array of 25 randomized data values, as shown in 

<a class="xref" href="#Random_values_in_console" title="Figure 6-9. Random values in console">Figure 6-9</a>.</p> 
<div class="figure" id="Random_values_in_console"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0609.png" alt="Random values in console"></div></div> 
<div class="figure-title">Figure 6-9. Random values in console</div> </div> 
<p id="notice_that_the_id1">Notice that they are all decimal or floating point values (such as 14.793717765714973), not whole numbers or integers (such as 14) like we used initially. For this example, decimal values are fine, but if you ever need whole numbers, you could use JavaScript’s <code class="literal">Math.round()</code> or <code class="literal">Math.floor()</code> methods.  <code class="literal">Math.round()</code> rounds any number to the nearest integer, whereas <code class="literal">Math.floor()</code> always rounds down, for greater control over the result.  For example, you could wrap the random number generator from this line:</p> 
<pre class="programlisting" data-language="javascript" id="var_newnumber__id1">    <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">30</code><code class="p">;</code></pre> 
<p id="as_follows">as follows:</p> 
<pre class="programlisting" data-language="javascript" id="var_newnumber__id2">    <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">30</code><code class="p">);</code></pre> 
<p id="using_this_code">Using this code, <code class="literal">newNumber</code> would always be either 0 or 29, or any integer in between.  Why not 30?  Because <code class="literal">Math.random()</code> always returns values 
<span class="emphasis">
<em>less than</em></span> 1.0, and <code class="literal">Math.floor()</code> will always 
<span class="emphasis">
<em>round down</em></span>, so 29 is the highest possible return value.</p> 
<p id="try_it_out_in__id1">Try it out in 
<span class="emphasis">
<em>07_power_of_data_rounded.html</em></span>, and use the console to verify that the numbers have indeed been rounded to integers, as displayed in 

<a class="xref" href="#Random_integer_values_in_console" title="Figure 6-10. Random integer values in console">Figure 6-10</a>.</p> 
<div class="figure" id="Random_integer_values_in_console"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0610.png" alt="Random integer values in console"></div></div> 
<div class="figure-title">Figure 6-10. Random integer values in console</div> </div> 
<p id="thats_about_al">That’s about all we can do visually with <code class="literal">div</code>s. Let’s expand our visual possibilities with SVG.</p> </div> </div> 
<div class="sect1" data-original-filename="6_drawing_with_data.asciidoc" id="_drawing_svgs"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Drawing SVGs</h2></div></div></div> 
<p id="for_a_quick_ref">For a quick refresher on SVG syntax, see 

<a class="xref" href="#SVG_3" title="SVG">“SVG”</a>.</p> 
<p id="one_thing_you_m">One thing you might notice about SVG elements is that all of their properties are specified as 
<span class="emphasis">
<em>attributes</em></span>. That is, they are included as

<a id="id510788" class="indexterm"></a>

<a id="ix_svgshapes" class="indexterm"></a> property/value pairs within each element tag, like this:</p> 
<pre class="programlisting" data-language="html" id="element_proper"><code class="nt">&lt;element</code> <code class="na">property=</code><code class="s">"value"</code><code class="nt">&gt;&lt;/element&gt;</code></pre> 
<p id="hmm_that_looks">Hmm, that looks strangely like HTML!</p> 
<pre class="programlisting" data-language="html" id="p_classeurek"><code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"eureka"</code><code class="nt">&gt;</code>Eureka!<code class="nt">&lt;/p&gt;</code></pre> 
<p id="we_have_already">We have already used D3’s handy <code class="literal">append()</code> and <code class="literal">attr()</code> methods to create new HTML elements and set their attributes. Because SVG elements exist in the DOM, just as HTML elements do, we can use <code class="literal">append()</code> and <code class="literal">attr()</code> in exactly the same way to generate SVG images.

<a id="id510911" class="indexterm"></a>

<a id="id510916" class="indexterm"></a></p> 
<div class="sect2" id="_create_the_svg"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Create the SVG</h3></div></div></div> 
<p id="first_we_need__id1">First, we need to create the SVG element in which to place all our shapes:</p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id8"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">);</code></pre> 
<p id="that_will_find_">That will find the document’s <code class="literal">body</code> and append a new <code class="literal">svg</code> element just before the closing <code class="literal">&lt;/body&gt;</code> tag. That code will work, but I’d like to suggest a slight modification:</p> 
<pre class="programlisting" data-language="javascript" id="var_svg__dse_id1"><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">);</code></pre> 
<p id="remember_how_mo">Remember how most D3 methods return a reference to the DOM element on which they act? By creating a new variable <code class="literal">svg</code>, we are able to capture the reference handed back by <code class="literal">append()</code>. Think of <code class="literal">svg</code> not as a variable but as a reference pointing to the SVG object that we just created. This reference will save us a lot of code later. Instead of having to search for that SVG each time—as in <code class="literal">d3.select("svg")</code>—we just say <code class="literal">svg</code>:</p> 
<pre class="programlisting" data-language="javascript" id="svgattrwidth"><code class="nx">svg</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code></pre> 
<p id="alternatively__id2">Alternatively, that could all be written as one line of code:</p> 
<pre class="programlisting" data-language="javascript" id="var_svg__dse_id2"><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code></pre> 
<p id="see__drawing_">See 
<span class="emphasis">
<em>08_drawing_svgs.html</em></span> for that code. Inspect the DOM and notice that there is, indeed, an empty SVG element.</p> 
<p id="to_simplify_you">To simplify your life, I recommend putting the width and height values

<a id="id511352" class="indexterm"></a> into variables at the top of your code, as in 
<span class="emphasis">
<em>09_drawing_svgs_size.html</em></span>. View the source, and you’ll see the following code:</p> 
<pre class="programlisting" data-language="javascript" id="width_and_hei_id1"><code class="c1">//Width and height</code> <code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">50</code><code class="p">;</code></pre> 
<p id="ill_be_doing_t">I’ll be doing that with all future examples. By 
<span class="emphasis">
<em>variabalizing</em></span> the size values, they can be easily referenced throughout your code, as in the following:</p> 
<pre class="programlisting" data-language="javascript" id="var_svg__dse_id3"><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>   <code class="c1">// &lt;-- Here</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code> <code class="c1">// &lt;-- and here!</code></pre> 
<p id="also_if_you_se">Also, if you send me a petition to make “variabalize” a real word, I will gladly sign it.</p> </div> 
<div class="sect2" id="_data_driven_shapes"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Data-Driven Shapes</h3></div></div></div> 
<p id="time_to_add_som">Time to add some shapes. I’ll bring back our trusty old dataset: 

<a id="id511610" class="indexterm"></a></p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id10"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<p id="and_then_use_da">and then use <code class="literal">data()</code> to iterate through each data point, creating a <code class="literal">circle</code> for each one:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id1"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">);</code></pre> 
<p id="remember_selec">Remember, <code class="literal">selectAll()</code> will return empty references to all <code class="literal">circle</code>s (which don’t exist yet), <code class="literal">data()</code> binds our data to the elements we’re about to create, <code class="literal">enter()</code> returns a placeholder reference to the new element, and <code class="literal">append()</code> finally adds a <code class="literal">circle</code> to the DOM. In this case, it appends those <code class="literal">circle</code>s to the end of the SVG element, as our initial selection is our reference <code class="literal">svg</code> (as opposed to the document <code class="literal">body</code>, for example).</p> 
<p id="to_make_it_easy">To make it easy to reference all of the <code class="literal">circle</code>s later, we can create a new variable to store references to them all:</p> 
<pre class="programlisting" data-language="javascript" id="var_circles__s"><code class="kd">var</code> <code class="nx">circles</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>                  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>                  <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>                  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">);</code></pre> 
<p id="great_but_all_">Great, but all these circles still need positions and sizes, displayed in 

<a class="xref" href="#Row_of_data_circles" title="Figure 6-11. Row of data circles">Figure 6-11</a>. Be warned, the following code might blow your mind:</p> 
<pre class="programlisting" data-language="javascript" id="circlesattrc_id1"><code class="nx">circles</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>             <code class="k">return</code> <code class="p">(</code><code class="nx">i</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code><code class="p">;</code>         <code class="p">})</code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>             <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>        <code class="p">});</code></pre> 
<div class="figure" id="Row_of_data_circles"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0611.png" alt="Row of data circles"></div></div> 
<div class="figure-title">Figure 6-11. Row of data circles</div> </div> 
<p id="feast_your_eyes">Feast your eyes on the demo 
<span class="emphasis">
<em>10_drawing_svgs_circles.html</em></span>. Let’s step through the code, one line at a time:</p> 
<pre class="programlisting" data-language="javascript" id="circlesattrc_id2"><code class="nx">circles</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>             <code class="k">return</code> <code class="p">(</code><code class="nx">i</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code><code class="p">;</code>         <code class="p">})</code></pre> 
<p id="this_takes_the_">This takes the reference to all <code class="literal">circle</code>s and sets the <code class="literal">cx</code> attribute for each one. (Remember that, in SVG lingo, <code class="literal">cx</code> is the x position value of the 
<span class="emphasis">
<em>center</em></span> of the circle.) Our data has already been bound to the <code class="literal">circle</code> elements, so for each <code class="literal">circle</code>, the value <code class="literal">d</code> matches the corresponding value in our original dataset (5, 10, 15, 20, or 25).</p> 
<p id="another_value_">Another value, <code class="literal">i</code>, is also automatically populated for us. (Thanks, D3!)  Just as with <code class="literal">d</code>, the name <code class="literal">i</code> here is arbitrary and could be set to whatever you like, such as <code class="literal">counter</code> or <code class="literal">elementID</code>.  I prefer to use <code class="literal">i</code> because it is concise, it alludes to the convention of using <code class="literal">i</code> in <code class="literal">for</code> loops, and it is very common, as you’ll see it in all the online examples.</p> 
<p id="so_i_is_a_nume">So, <code class="literal">i</code> is a numeric index value of the current element. Counting starts at zero, so for our “first” circle <code class="literal">i == 0</code>, the second circle’s <code class="literal">i == 1</code>, and so on. We’re using <code class="literal">i</code> to push each subsequent circle over to the right, because each subsequent loop through, the value of <code class="literal">i</code> increases by one:</p> 
<pre class="programlisting" data-language="javascript" id="____"><code class="p">(</code><code class="mi">0</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 25</code> <code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 75</code> <code class="p">(</code><code class="mi">2</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 125</code> <code class="p">(</code><code class="mi">3</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 175</code> <code class="p">(</code><code class="mi">4</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 225</code></pre> 
<p id="to_make_sure_i_">To make sure <code class="literal">i</code> is available to your custom function, you must include it as an argument in the function definition, <code class="literal">function(d, i)</code>. You must also include <code class="literal">d</code>, even if you don’t use <code class="literal">d</code> within your function (as in the preceding case).  This is because, again, the actual names used for these arguments are not important, but the total number of arguments (one or two) is.</p> 
<p id="also_in_case_y_id1">Also, in case you’re feeling a surge of parameter anxiety, don’t worry.  You’ll only ever have to worry about <code class="literal">d</code> and <code class="literal">i</code>.  There are no additional anonymous function parameters to learn about later.</p> 
<p id="on_to_the_next_">On to the next line:</p> 
<pre class="programlisting" data-language="javascript" id="attrcy_h"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code></pre> 
<p id="cy_is_the_y_pos"><code class="literal">cy</code> is the y position value of the center of each circle. We’re setting <code class="literal">cy</code> to <code class="literal">h</code> divided by two, or one-half of <code class="literal">h</code>. You’ll recall that <code class="literal">h</code> stores the height of the entire SVG, so <code class="literal">h/2</code> has the effect of aligning all <code class="literal">circle</code>s in the vertical center of the image:</p> 
<pre class="programlisting" data-language="javascript" id="attrr_func_id1"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="finally_the_ra">Finally, the radius <code class="literal">r</code> of each <code class="literal">circle</code> is simply set to <code class="literal">d</code>, the corresponding data value.</p> </div> 
<div class="sect2" id="_pretty_colors_oooh"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Pretty Colors, Oooh!</h3></div></div></div> 
<p id="color_fills_and">Color fills and strokes are just other attributes that you can set using

<a id="id512975" class="indexterm"></a> the same methods. Simply by appending this code:</p> 
<pre class="programlisting" data-language="javascript" id="attrfill__id1"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"yellow"</code><code class="p">)</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"orange"</code><code class="p">)</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="o">/</code><code class="mi">2</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="we_get_the_colo">we get the colorful circles shown in 

<a class="xref" href="#Colorful_data_circles" title="Figure 6-12. Colorful data circles">Figure 6-12</a>, as seen in 
<span class="emphasis">
<em>11_drawing_svgs_color.html</em></span>.</p> 
<div class="figure" id="Colorful_data_circles"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0612.png" alt="Colorful data circles"></div></div> 
<div class="figure-title">Figure 6-12. Colorful data circles</div> </div> 
<div class="sidebar online_only" id="interactive_6-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_modifying_t_id2">Try modifying the values in <code class="literal">dataset</code> and the <code class="literal">fill</code> and <code class="literal">stroke</code> attribute values for <code class="literal">circles</code> at left to see how they affect the rendering of the circles at right:</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_06/11_drawing_svgs_color.html" target="_blank">11_drawing_svgs_color</a></p> 

<p id="of_course_you__id2">Of course, you can mix and match attributes and custom functions to apply any combination of properties. The trick with data visualization, of course, is choosing appropriate 
<span class="emphasis">
<em>mappings</em></span>, so the visual expression of your data is understandable and useful for the viewer.

<a id="id513218" class="indexterm"></a></p> </div> </div> 
<div class="sect1" data-original-filename="6_drawing_with_data.asciidoc" id="_making_a_bar_chart"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Making a Bar Chart</h2></div></div></div> 
<p id="now_well_integ">Now we’ll integrate everything we’ve learned so far to generate a simple bar chart as an SVG image.

<a id="ix_bchrt" class="indexterm"></a></p> 
<p id="well_start_by__id1">We’ll start by adapting the <code class="literal">div</code> bar chart code to draw its bars with SVG instead, giving us more flexibility over the visual presentation. Then we’ll add labels, so we can see the data values clearly.</p> 
<div class="sect2" id="_the_old_chart"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">The Old Chart</h3></div></div></div> 
<p id="see_the_div_cha">See the <code class="literal">div</code> chart, updated with some new data, in 
<span class="emphasis">
<em>12_making_a_bar_chart_divs.html</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id11"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code>                 <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="kd">var</code> <code class="nx">barHeight</code> <code class="o">=</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">5</code><code class="p">;</code>         <code class="k">return</code> <code class="nx">barHeight</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code>     <code class="p">});</code></pre> 
<p id="it_might_be_har">It might be hard to imagine, but we can definitely improve on the simple bar chart in 

<a class="xref" href="#Bar_chart_with_divs" title="Figure 6-13. Bar chart with divs">Figure 6-13</a> made of <code class="literal">div</code>s.</p> 
<div class="figure" id="Bar_chart_with_divs"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0613.png" alt="Bar chart with divs"></div></div> 
<div class="figure-title">Figure 6-13. Bar chart with <code class="literal">div</code>s</div> </div> </div> 
<div class="sect2" id="_the_new_chart"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">The New Chart</h3></div></div></div> 
<p id="first_we_need__id2">First, we need to decide on the size of the new SVG:</p> 
<pre class="programlisting" data-language="javascript" id="width_and_hei_id2"><code class="c1">//Width and height</code> <code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code></pre> 
<p id="of_course_you__id3">Of course, you could name <code class="literal">w</code> and <code class="literal">h</code> something else, like <code class="literal">svgWidth</code> and <code class="literal">svgHeight</code>. Use whatever is most clear to you. JavaScript programmers, as a group, are fixated on efficiency, so you’ll often see single-character variable names, code written with no spaces, and other hard-to-read, yet programmatically efficient, syntax.</p> 
<p id="then_we_tell_d">Then, we tell D3 to create an empty SVG element and add it to the DOM:</p> 
<pre class="programlisting" data-language="javascript" id="create_svg_el_id1"><code class="c1">//Create SVG element</code> <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code></pre> 
<p id="to_recap_this_">To recap, this inserts a new <code class="literal">&lt;svg&gt;</code> element just before the closing <code class="literal">&lt;/body&gt;</code> tag, and assigns the SVG a width and height of 500 by 100 pixels. This statement also puts the result into our new variable called <code class="literal">svg</code>, so we can easily reference the new SVG without having to reselect it later using something like <code class="literal">d3.select("svg")</code>.</p> 
<p id="next_instead_o">Next, instead of creating <code class="literal">div</code>s, we generate <code class="literal">rect</code>s and add them to <code class="literal">svg</code>:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id2"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code></pre> 
<p id="this_code_selec">This code selects all <code class="literal">rect</code>s inside of <code class="literal">svg</code>. Of course, there aren’t any yet, so an empty selection is returned. (Weird, yes, but stay with me. With D3, you always have to first select whatever it is you’re about to act on, even if that selection is momentarily empty.)</p> 
<p id="then_datadata">Then, <code class="literal">data(dataset)</code> sees that we have 20 values in the dataset, and those values are handed off to <code class="literal">enter()</code> for processing.  <code class="literal">enter()</code>, in turn, returns a placeholder selection for each data point that does not yet have a corresponding <code class="literal">rect</code>—which is to say, all of them.</p> 
<p id="for_each_of_the">For each of the 20 placeholders, <code class="literal">append("rect")</code> inserts a <code class="literal">rect</code> into the DOM. As we learned in 

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>, every <code class="literal">rect</code> must have <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, and <code class="literal">height</code> values. We use <code class="literal">attr()</code> to add those attributes onto each newly created <code class="literal">rect</code>.</p> 
<p id="beautiful_no_">Beautiful, no? Okay, maybe not. All of the bars are there (check the DOM of 
<span class="emphasis">
<em>13_making_a_bar_chart_rects.html</em></span> with your web inspector), but they all share the same <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, and <code class="literal">height</code> values, with the result that they all overlap (see 

<a class="xref" href="#One_lonely_bar" title="Figure 6-14. One lonely bar">Figure 6-14</a>). This isn’t a visualization of data yet.</p> 
<div class="figure" id="One_lonely_bar"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0614.png" alt="One lonely bar"></div></div> 
<div class="figure-title">Figure 6-14. One lonely bar</div> </div> 
<p id="lets_fix_the_o">Let’s fix the overlap issue first. Instead of an <code class="literal">x</code> of <code class="literal">0</code>, we’ll assign a dynamic value that corresponds to <code class="literal">i</code>, or each value’s position in the dataset. So the first bar will be at <code class="literal">0</code>, but subsequent bars will be at <code class="literal">21</code>, then <code class="literal">42</code>, and so on.  (In a later chapter, we’ll learn about D3’s 
<span class="emphasis">
<em>scales</em></span>, which offer a better, more flexible way to accomplish this same feat.)</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id1"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="mi">21</code><code class="p">;</code>  <code class="c1">//Bar width of 20 plus 1 for padding</code> <code class="p">})</code></pre> 
<p id="see_that_code_i_id2">See that code in action with 
<span class="emphasis">
<em>14_making_a_bar_chart_offset.html</em></span> and the result in 

<a class="xref" href="#Twenty_bars" title="Figure 6-15. Twenty bars">Figure 6-15</a>.</p> 
<div class="figure" id="Twenty_bars"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0615.png" alt="Twenty bars"></div></div> 
<div class="figure-title">Figure 6-15. Twenty bars</div> </div> 
<p id="that_works_but">That works, but it’s not particularly flexible. If our dataset were longer, then the bars would just run off to the right, past the end of the SVG! Because each bar is 20 pixels wide, plus 1 pixel of padding, a 500-pixel wide SVG can only accommodate 23 data points. Note how the 24th bar gets clipped in 

<a class="xref" href="#Twentyfour_bars" title="Figure 6-16. Twenty-four bars">Figure 6-16</a>.</p> 
<div class="figure" id="Twentyfour_bars"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0616.png" alt="Twenty-four bars"></div></div> 
<div class="figure-title">Figure 6-16. Twenty-four bars</div> </div> 
<p id="its_good_pract">It’s good practice to use flexible, dynamic coordinates—heights, widths, x values, and y values—so your visualization can scale appropriately along with your data.</p> 
<p id="as_with_anythin">As with anything else in programming, there are a thousand ways to achieve that end. I’ll use a simple one. First, I’ll amend the line where we set each bar’s <code class="literal">x</code> position:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id2"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="p">})</code></pre> 
<p id="notice_how_the__id3">Notice how the <code class="literal">x</code> value is now tied directly to the width of the SVG (<code class="literal">w</code>) and the number of values in the dataset (<code class="literal">dataset.length</code>). This is exciting because now our bars will be evenly spaced, whether we have 20 data values, as in 

<a class="xref" href="#Twenty_evenly_spaced_bars" title="Figure 6-17. Twenty evenly spaced bars">Figure 6-17</a>.</p> 
<div class="figure" id="Twenty_evenly_spaced_bars"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0617.png" alt="Twenty evenly spaced bars"></div></div> 
<div class="figure-title">Figure 6-17. Twenty evenly spaced bars</div> </div> 
<p id="or_only_five_a">Or only five, as in 

<a class="xref" href="#Five_evenly_spaced_bars" title="Figure 6-18. Five evenly spaced bars">Figure 6-18</a>.</p> 
<div class="figure" id="Five_evenly_spaced_bars"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0618.png" alt="Five evenly spaced bars"></div></div> 
<div class="figure-title">Figure 6-18. Five evenly spaced bars</div> </div> 
<p id="see_that_code_s">See that code so far in 
<span class="emphasis">
<em>15_making_a_bar_chart_even.html</em></span>.</p> 
<p id="now_we_should_s">Now we should set the bar 
<span class="emphasis">
<em>widths</em></span> to be proportional, too, so they get narrower as more data is added, or wider when there are fewer values. I’ll add a new variable near where we set the SVG’s width and height:</p> 
<pre class="programlisting" data-language="javascript" id="width_and_hei_id3"><code class="c1">//Width and height</code> <code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">barPadding</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>  <code class="c1">// &lt;-- New!</code></pre> 
<p id="and_then_refere">and then reference that variable in the line where we set each bar’s <code class="literal">width</code>. Instead of a static value of <code class="literal">20</code>, the width will now be set as a fraction of the SVG width and number of data points, minus a padding value:</p> 
<pre class="programlisting" data-language="javascript" id="attrwidth__id1"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">)</code></pre> 
<p id="it_works_see_">It works! (See 

<a class="xref" href="#Twenty_evenly_spaced_bars_with_dynamic_widths" title="Figure 6-19. Twenty evenly spaced bars with dynamic widths">Figure 6-19</a> and 
<span class="emphasis">
<em>16_making_a_bar_chart_widths.html</em></span>.)</p> 
<div class="figure" id="Twenty_evenly_spaced_bars_with_dynamic_widths"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0619.png" alt="Twenty evenly spaced bars with dynamic widths"></div></div> 
<div class="figure-title">Figure 6-19. Twenty evenly spaced bars with dynamic widths</div> </div> 
<p id="the_bar_widths_">The bar widths and x positions scale correctly whether there are 20 points, only 5 (see 

<a class="xref" href="#Five_evenly_spaced_bars_with_dynamic_widths" title="Figure 6-20. Five evenly spaced bars with dynamic widths">Figure 6-20</a>), or even 100 (see 

<a class="xref" href="#One_hundred_evenly_spaced_bars_with_dynamic_widths" title="Figure 6-21. One hundred evenly spaced bars with dynamic widths">Figure 6-21</a>).</p> 
<div class="figure" id="Five_evenly_spaced_bars_with_dynamic_widths"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0620.png" alt="Five evenly spaced bars with dynamic widths"></div></div> 
<div class="figure-title">Figure 6-20. Five evenly spaced bars with dynamic widths</div> </div> 
<div class="figure" id="One_hundred_evenly_spaced_bars_with_dynamic_widths"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0621.png" alt="One hundred evenly spaced bars with dynamic widths"></div></div> 
<div class="figure-title">Figure 6-21. One hundred evenly spaced bars with dynamic widths</div> </div> 
<p id="finally_we_enc">Finally, we encode our data as the 
<span class="emphasis">
<em>height</em></span> of each bar. You would hope it were as easy as referencing the <code class="literal">d</code> data value when setting each bar’s <code class="literal">height</code>:</p> 
<pre class="programlisting" data-language="javascript" id="attrheight_id1"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code></pre> 
<p id="hmm_the_chart_">Hmm, the chart in 

<a class="xref" href="#Dynamic_heights" title="Figure 6-22. Dynamic heights">Figure 6-22</a> looks funky. Maybe we can just scale up our numbers a bit?</p> 
<pre class="programlisting" data-language="javascript" id="attrheight_id2"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">;</code>  <code class="c1">// &lt;-- Times four!</code> <code class="p">});</code></pre> 
<div class="figure" id="Dynamic_heights"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0622.png" alt="Dynamic heights"></div></div> 
<div class="figure-title">Figure 6-22. Dynamic heights</div> </div> 
<p id="alas_it_is_not">Alas, it is not that easy! We want our bars to grow upward from the bottom edge, not down from the top, as in 

<a class="xref" href="#Dynamic_heights_magnified" title="Figure 6-23. Dynamic heights, magnified">Figure 6-23</a>—but don’t blame D3, blame SVG.</p> 
<div class="figure" id="Dynamic_heights_magnified"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0623.png" alt="Dynamic heights, magnified"></div></div> 
<div class="figure-title">Figure 6-23. Dynamic heights, magnified</div> </div> 
<p id="youll_recall_t_id1">You’ll recall that, when drawing SVG <code class="literal">rect</code>s, the <code class="literal">x</code> and <code class="literal">y</code> values specify the coordinates of the 
<span class="emphasis">
<em>upper-left corner</em></span>. That is, the origin or reference point for every <code class="literal">rect</code> is its top-left. For our purposes, it would be soooooo much easier to set the origin point as the bottom-left corner, but that’s just not how SVG does it, and frankly, SVG is pretty indifferent about our feelings on the matter.</p> 
<p id="given_that_our_">Given that our bars do have to “grow down from the top,” then where is “the top” of each bar in relationship to the top of the SVG? Well, the top of each bar could be 
<span class="keep-together">expressed</span> as a relationship between the height of the SVG and the corresponding data value, as in:</p> 
<pre class="programlisting" data-language="javascript" id="attry_func_id1"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">d</code><code class="p">;</code>  <code class="c1">//Height minus data value</code> <code class="p">})</code></pre> 
<p id="then_to_put_th">Then, to put the “bottom” of the bar on the bottom of the SVG (see 

<a class="xref" href="#Growing_down_from_above" title="Figure 6-24. Growing down from above">Figure 6-24</a>), each <code class="literal">rect</code>’s height can be just the data value itself:</p> 
<pre class="programlisting" data-language="javascript" id="attrheight_id3"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>  <code class="c1">//Just the data value</code> <code class="p">});</code></pre> 
<div class="figure" id="Growing_down_from_above"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0624.png" alt="Growing down from above"></div></div> 
<div class="figure-title">Figure 6-24. Growing down from above</div> </div> 
<p id="lets_scale_thi">Let’s scale things up a bit by changing <code class="literal">d</code> to <code class="literal">d * 4</code>, with the result shown in 

<a class="xref" href="#Growing_bigger_from_above" title="Figure 6-25. Growing bigger from above">Figure 6-25</a>. (Just as with the bar placements, this can be done more properly using D3 scales, but we’re not there yet.)</p> 
<div class="figure" id="Growing_bigger_from_above"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0625.png" alt="Growing bigger from above"></div></div> 
<div class="figure-title">Figure 6-25. Growing bigger from above</div> </div> 
<p id="the_working_cod">The working code for our growing-down-from-above, SVG bar chart is in 
<span class="emphasis">
<em>17_making_a_bar_chart_heights.html</em></span>.</p> 
<div class="sidebar online_only" id="interactive_6-4"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_adding_or_d">Try adding or deleting data points from <code class="literal">dataset</code> at left and see how the width of the bars adjusts at right. Then try adjusting the values of the data points and see the changes reflected in the height of the bars.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_06/17_making_a_bar_chart_heights.html" target="_blank">17_making_a_bar_chart_heights</a></p> 

<div class="sect2" id="_color"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Color</h3></div></div></div> 
<p id="adding_color_is">Adding color is easy. Just use <code class="literal">attr()</code> to set

<a id="id515837" class="indexterm"></a> a <code class="literal">fill</code>:</p> 
<pre class="programlisting" data-language="javascript" id="attrfill__id2"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"teal"</code><code class="p">);</code></pre> 
<p id="find_the_allte">Find the all-teal bar chart shown in 

<a class="xref" href="#Teal_bars" title="Figure 6-26. Teal bars">Figure 6-26</a> in 
<span class="emphasis">
<em>18_making_a_bar_chart_teal.html</em></span>.</p> 
<div class="figure" id="Teal_bars"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0626.png" alt="Teal bars"></div></div> 
<div class="figure-title">Figure 6-26. Teal bars</div> </div> 
<p id="teal_is_nice_b">Teal is nice, but you’ll often want a shape’s color to reflect some quality of the data. That is, you might want to 
<span class="emphasis">
<em>encode</em></span> the data values as color. (In the case of our bar chart, that makes a 
<span class="emphasis">
<em>dual encoding</em></span>, in which the same data value is encoded in two different visual properties: both height and color.)

<a id="id515942" class="indexterm"></a>

<a id="id515950" class="indexterm"></a>

<a id="id515956" class="indexterm"></a></p> 
<p id="using_data_to_d">Using data to drive color is as easy as writing a custom function that again references <code class="literal">d</code>. Here, we replace <code class="literal">"teal"</code> with a custom function, resulting in the chart in 

<a class="xref" href="#Datadriven_blue_bars" title="Figure 6-27. Data-driven blue bars">Figure 6-27</a>:</p> 
<pre class="programlisting" data-language="javascript" id="attrfill_f"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code></pre> 
<div class="figure" id="Datadriven_blue_bars"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0627.png" alt="Data-driven blue bars"></div></div> 
<div class="figure-title">Figure 6-27. Data-driven blue bars</div> </div> 
<p id="see_the_code_in">See the code in 
<span class="emphasis">
<em>19_making_a_bar_chart_blues.html</em></span>. This is not a particularly useful visual encoding, but you can get the idea of how to translate data into color. Here, <code class="literal">d</code> is multiplied by 10, and then used as the blue value in an <code class="literal">rgb()</code> color definition. So the greater values of <code class="literal">d</code> (taller bars) will be more blue. Smaller values of <code class="literal">d</code> (shorter bars) will be less blue (closer to black). The red and green components of the color are fixed at zero.</p> 
<div class="sidebar" id="multivalue_maps"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Multivalue Maps</div></div></div></div> 
<p id="you_might_have__id1">You might have noticed we now have a total of 
<span class="emphasis">
<em>five</em></span> different calls to <code class="literal">attr()</code> in the chain, one each to specify the bars’ <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, <code class="literal">height</code>, and <code class="literal">fill</code> values.

<a id="id516204" class="indexterm"></a>

<a id="id516212" class="indexterm"></a>

<a id="id516218" class="indexterm"></a></p> 
<p id="if_you_get_tire">If you get tired of typing <code class="literal">attr()</code> over and over again, you might appreciate D3’s support for 

<a class="ulink" href="http://bl.ocks.org/3305515" target="_top">
<span class="emphasis">
<em>multivalue maps</em></span></a>, with which you can set multiple 
<span class="keep-together">attribute</span> values using a single <code class="literal">attr()</code> statement.  For example, to move a circle to the top-left corner of the SVG and make it red, I could use separate <code class="literal">attr()</code> statements:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectcir_id1"><code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code></pre> 
<p id="or_i_could_defi">or I could define all three of these attributes and their values within a single object, which is then relayed to a single <code class="literal">attr()</code> statement:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectcir_id2"><code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">({</code>         <code class="nx">cx</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>         <code class="nx">cy</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>         <code class="nx">fill</code><code class="o">:</code> <code class="nx">red</code>    <code class="p">});</code></pre> 
<p id="the_resulting_c">The resulting code is more concise, and if you’ve used jQuery, this syntax of tucking property/value pairs into objects might already be familiar.  The 
<span class="emphasis">
<em>value</em></span> portion of each pair can include anonymous functions, referencing <code class="literal">d</code> and <code class="literal">i</code> to generate dynamic values, per usual.  We could rewrite our bar-creation code thus far using multivalue maps as:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id3"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">({</code>         <code class="nx">x</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="p">},</code>         <code class="nx">y</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">);</code> <code class="p">},</code>         <code class="nx">width</code><code class="o">:</code> <code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">,</code>         <code class="nx">height</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">;</code> <code class="p">},</code>         <code class="nx">fill</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">}</code>    <code class="p">});</code></pre> 
<p id="if_you_like_thi">If you like this sort of thing, you’ll be happy to know it also works with <code class="literal">style()</code> and 

<a class="ulink" href="http://bl.ocks.org/3305515" target="_top">a few other methods</a>.  Throughout this book, I’ve used the more verbose structure of individual attribute statements, but it’s always good to know you have options.</p> </div> </div> 
<div class="sect2" id="_labels"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Labels</h3></div></div></div> 
<p id="visuals_are_gre">Visuals are great, but sometimes you need to show the actual data values as text within the visualization. Here’s where value labels come in, and they are very, very easy to generate with D3.

<a id="id517063" class="indexterm"></a></p> 
<p id="youll_recall_f">You’ll recall from the SVG primer that you can add <code class="literal">text</code> elements to an SVG element. Let’s start with:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id4"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code></pre> 
<p id="look_familiar_">Look familiar? Just as we did for the <code class="literal">rect</code>s, here we do for the <code class="literal">text</code>s. First, select what you want, bring in the data, enter the new elements (which are just placeholders at this point), and finally append the new <code class="literal">text</code> elements to the DOM.</p> 
<p id="well_extend_th">We’ll extend that code to include a data value within each <code class="literal">text</code> element by using the <code class="literal">text()</code> method:</p> 
<pre class="programlisting" data-language="javascript" id="textfunction_id6">   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">})</code></pre> 
<p id="and_then_extend">and then extend it further, by including <code class="literal">x</code> and <code class="literal">y</code> values to position the text. It’s easiest if I just copy and paste the same x/y code we previously used for the bars:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id3">   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">);</code>    <code class="p">});</code></pre> 
<p id="aha_value_labe">Aha! Value labels! But some are getting cut off at the top (see 

<a class="xref" href="#Baby_value_labels" title="Figure 6-28. Baby value labels!">Figure 6-28</a>).</p> 
<div class="figure" id="Baby_value_labels"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0628.png" alt="Baby value labels!"></div></div> 
<div class="figure-title">Figure 6-28. Baby value labels!</div> </div> 
<p id="lets_try_movin">Let’s try moving them down, inside the bars, by adding a small amount to the <code class="literal">x</code> and <code class="literal">y</code> calculations:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id4">   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="o">+</code> <code class="mi">5</code><code class="p">;</code>  <code class="c1">// +5</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">)</code> <code class="o">+</code> <code class="mi">15</code><code class="p">;</code>              <code class="c1">// +15</code>    <code class="p">});</code></pre> 
<p id="the_chart_in_is">The chart in 

<a class="xref" href="#Inbar_value_labels" title="Figure 6-29. In-bar value labels">Figure 6-29</a> is better, but not legible.</p> 
<div class="figure" id="Inbar_value_labels"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0629.png" alt="In-bar value labels"></div></div> 
<div class="figure-title">Figure 6-29. In-bar value labels</div> </div> 
<p id="fortunately_we_id2">Fortunately, we can fix that:</p> 
<pre class="programlisting" data-language="javascript" id="attrfontfam_id1">   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-family"</code><code class="p">,</code> <code class="s2">"sans-serif"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"11px"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"white"</code><code class="p">);</code></pre> 
<p id="fantasticode_">Fantasti-code! See 
<span class="emphasis">
<em>20_making_a_bar_chart_labels.html</em></span> for the brilliant visualization shown in 

<a class="xref" href="#Really_nice_value_labels" title="Figure 6-30. Really nice value labels">Figure 6-30</a>.</p> 
<div class="figure" id="Really_nice_value_labels"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0630.png" alt="Really nice value labels"></div></div> 
<div class="figure-title">Figure 6-30. Really nice value labels</div> </div> 
<p id="if_you_are_not_">If you are not typographically obsessive, then you’re all done. If, however, you are like me, you’ll notice that the value labels aren’t perfectly aligned within their bars. (For example, note the “5” in the first column.) That’s easy enough to fix. Let’s use the SVG <code class="literal">text-anchor</code> attribute to center the text horizontally at the assigned <code class="literal">x</code> value:</p> 
<pre class="programlisting" data-language="javascript" id="attrtextanc">    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code></pre> 
<p id="then_lets_cha">Then, let’s change the way we calculate the <code class="literal">x</code> position by setting it to the left edge of each bar 
<span class="emphasis">
<em>plus</em></span> half the bar width:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id5">    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="o">+</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>     <code class="p">})</code></pre> 
<p id="and_ill_also_b">And I’ll also bring the labels up one pixel for perfect spacing, as you can see in 

<a class="xref" href="#Centered_labels" title="Figure 6-31. Centered labels">Figure 6-31</a> and 
<span class="emphasis">
<em>21_making_a_bar_chart_aligned.html</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="attry_func_id2">    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">)</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code>  <code class="c1">//15 is now 14</code>     <code class="p">})</code></pre> 
<div class="figure" id="Centered_labels"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0631.png" alt="Centered labels"></div></div> 
<div class="figure-title">Figure 6-31. Centered labels</div> </div> 
<p id="simpara_id11">

<a id="id518400" class="indexterm"></a></p> 
<div class="sidebar online_only" id="interactive_6-5"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="experiment_with_id1">Experiment with the code for the final bar chart below. Adjust the code at left and see the chart output at right.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_06/21_making_a_bar_chart_aligned.html" target="_blank">21_making_a_bar_chart_aligned</a></p> 

<div class="sect1" data-original-filename="6_drawing_with_data.asciidoc" id="_making_a_scatterplot"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Making a Scatterplot</h2></div></div></div> 
<p id="so_far_weve_d">So far, we’ve drawn only bar charts with simple data—just one-dimensional sets of numbers.

<a id="ix_splot" class="indexterm"></a></p> 
<p id="but_when_you_ha">But when you have two sets of values to plot against each other, you need a second dimension. The scatterplot is a common type of visualization that represents two sets of corresponding values on two different axes: horizontal and vertical, x and y.</p> 
<div class="sect2" id="_the_data"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">The Data</h3></div></div></div> 
<p id="as_you_saw_in_">As you saw in 

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>, you have a lot of flexibility around how to structure a dataset. For our scatterplot, I’m going to use an array of arrays. The primary array will contain one element for each data “point.” Each of those “point” elements will be another array, with just two values: one for the x value, and one for y:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id12"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                 <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">20</code><code class="p">],</code> <code class="p">[</code><code class="mi">480</code><code class="p">,</code> <code class="mi">90</code><code class="p">],</code> <code class="p">[</code><code class="mi">250</code><code class="p">,</code> <code class="mi">50</code><code class="p">],</code> <code class="p">[</code><code class="mi">100</code><code class="p">,</code> <code class="mi">33</code><code class="p">],</code> <code class="p">[</code><code class="mi">330</code><code class="p">,</code> <code class="mi">95</code><code class="p">],</code>                 <code class="p">[</code><code class="mi">410</code><code class="p">,</code> <code class="mi">12</code><code class="p">],</code> <code class="p">[</code><code class="mi">475</code><code class="p">,</code> <code class="mi">44</code><code class="p">],</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">67</code><code class="p">],</code> <code class="p">[</code><code class="mi">85</code><code class="p">,</code> <code class="mi">21</code><code class="p">],</code> <code class="p">[</code><code class="mi">220</code><code class="p">,</code> <code class="mi">88</code><code class="p">]</code>               <code class="p">];</code></pre> 
<p id="remember__me">Remember, <code class="literal">[]</code> means array, so nested hard brackets <code class="literal">[[]]</code> indicate an array within another array. We separate array elements with commas, so an array containing three other arrays would look like this: <code class="literal">[[],[],[]]</code>.</p> 
<p id="we_could_rewrit">We could rewrite our dataset with more whitespace so it’s easier to read:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id13"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                   <code class="p">[</code> <code class="mi">5</code><code class="p">,</code>     <code class="mi">20</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">480</code><code class="p">,</code>   <code class="mi">90</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">250</code><code class="p">,</code>   <code class="mi">50</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">100</code><code class="p">,</code>   <code class="mi">33</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">330</code><code class="p">,</code>   <code class="mi">95</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">410</code><code class="p">,</code>   <code class="mi">12</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">475</code><code class="p">,</code>   <code class="mi">44</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">25</code><code class="p">,</code>    <code class="mi">67</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">85</code><code class="p">,</code>    <code class="mi">21</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">220</code><code class="p">,</code>   <code class="mi">88</code> <code class="p">]</code>               <code class="p">];</code></pre> 
<p id="now_you_can_see">Now you can see that each of these 10 rows will correspond to one point in our visualization. With the row <code class="literal">[5, 20]</code>, for example, we’ll use <code class="literal">5</code> as the x value, and <code class="literal">20</code> for the y.</p> </div> 
<div class="sect2" id="_the_scatterplot"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">The Scatterplot</h3></div></div></div> 
<p id="lets_carry_ove">Let’s carry over most of the code from our bar chart experiments, including the piece that creates the SVG element:</p> 
<pre class="programlisting" data-language="javascript" id="create_svg_el_id2"><code class="c1">//Create SVG element</code> <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code></pre> 
<p id="instead_of_crea">Instead of creating <code class="literal">rect</code>s, however, we’ll make a <code class="literal">circle</code> for each data point:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id5"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>  <code class="c1">// &lt;-- No longer "rect"</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>     <code class="c1">// &lt;-- No longer "rect"</code></pre> 
<p id="also_instead_o">Also, instead of specifying the <code class="literal">rect</code> attributes of <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, and <code class="literal">height</code>, our <code class="literal">circle</code>s need <code class="literal">cx</code>, <code class="literal">cy</code>, and <code class="literal">r</code>:</p> 
<pre class="programlisting" data-language="javascript" id="attrcx_fun_id1">   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code></pre> 
<p id="see_the_working">See the working scatterplot code that recreates the result shown in 

<a class="xref" href="#Simple_scatterplot" title="Figure 6-32. Simple scatterplot">Figure 6-32</a> in 
<span class="emphasis">
<em>22_scatterplot.html</em></span>.</p> 
<div class="figure" id="Simple_scatterplot"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0632.png" alt="Simple scatterplot"></div></div> 
<div class="figure-title">Figure 6-32. Simple scatterplot</div> </div> 
<p id="notice_how_we_a">Notice how we access the data values and use them for the <code class="literal">cx</code> and <code class="literal">cy</code> values. When using <code class="literal">function(d)</code>, D3 automatically hands off the current data value as <code class="literal">d</code> to your function. In this case, the current data value is one of the smaller, subarrays in our larger <code class="literal">dataset</code> array.</p> 
<p id="when_each_singl">When each single datum <code class="literal">d</code> is itself an array of values (and not just a single value, like <code class="literal">3.14159</code>), you need to use bracket notation to access its values. Hence, instead of <code class="literal">return d</code>, we use <code class="literal">return d[0]</code> and <code class="literal">return d[1]</code>, which return the first and second values of the array, respectively.</p> 
<p id="for_example_in">For example, in the case of our first data point <code class="literal">[5, 20]</code>, the first value (array position <code class="literal">0</code>) is <code class="literal">5</code>, and the second value (array position <code class="literal">1</code>) is <code class="literal">20</code>. Thus:</p> 
<pre class="screen" id="d_returns__">d[0] returns 5 d[1] returns 20</pre> 
<p id="by_the_way_if_">By the way, if you ever want to access any value in the larger dataset (outside of D3, say), you can do so using bracket notation. For example:</p> 
<pre class="screen" id="dataset_retu">dataset[5] returns [410, 12]</pre> 
<p id="you_can_even_us">You can even use multiple sets of brackets to access values within nested arrays:</p> 
<pre class="screen" id="dataset_r">dataset[5][1] returns 12</pre> 
<p id="dont_believe_m">Don’t believe me? Take another look at the scatterplot page 
<span class="emphasis">
<em>22_scatterplot.html</em></span>, open your JavaScript console, type in 
<span class="strong">
<strong><code class="literal">dataset[5]</code></strong></span> or 
<span class="strong">
<strong><code class="literal">dataset[5][1]</code></strong></span>, and see what happens.</p> 
<div class="sidebar online_only" id="interactive_6-6"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="enter_the_follo_id2">Enter the following statements in the JavaScript console below and see the results:</p> 
<div class="itemizedlist" id="dataset_dataset">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">dataset</code> </li> 
<li class="listitem"> <code class="literal">dataset[5]</code> </li> 
<li class="listitem"> <code class="literal">dataset[5][1]</code> </li> </ul></div> 
<div class="interactive">

<div class="sect2" id="_size"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Size</h3></div></div></div> 
<p id="maybe_you_want_">Maybe you want the circles to be different sizes, so each circle’s area corresponds to its y value.  As a general rule, when visualizing quantitative values with circles, make sure to encode the values as 
<span class="emphasis">
<em>area</em></span>, not as a circle’s 
<span class="emphasis">
<em>radius</em></span>.  Perceptually, we understand the overall amount of “ink” or pixels to reflect the data value.  A common mistake is to map the value to the radius.  (I’ve done this many times myself.)  Mapping to the radius is easier to do, as it requires less math, but the result will visually distort your data.</p> 
<p id="yet_when_creati">Yet when creating SVG circles, we can’t specify an <code class="literal">area</code> value; we have to calculate the radius <code class="literal">r</code> and then set that.  So, starting with a data value as area, how do we get to a radius value?</p> 
<p id="you_might_remem">You might remember that the area of a circle equals π times the radius squared, or 
<span class="keep-together">A = πr
<sup>2</sup>.</span></p> 
<p id="lets_say_the_a">Let’s say the area, then, is our data value, which is <code class="literal">d[1]</code>, in this case.  Actually, let’s subtract that value from <code class="literal">h</code>, so the circles at the top are larger.  So our 
<span class="emphasis">
<em>area</em></span> value is <code class="literal">h - d[1]</code>.  (We’ll cover a cleaner way to achieve this effect using scales in 

<a class="xref" href="" title="Chapter 7. Scales">Chapter 7</a>.)</p> 
<p id="to_convert_this">To convert this area to a radius value, we simply have to take its square root.  We can do that using JavaScript’s built-in <code class="literal">Math.sqrt()</code> function, as in <code class="literal">Math.sqrt(h - d[1])</code>.</p> 
<p id="now_instead_of">Now, instead of setting all <code class="literal">r</code> values to the static value of <code class="literal">5</code>, try:</p> 
<pre class="programlisting" data-language="javascript" id="attrr_func_id2"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">});</code></pre> 
<p id="see__scatterp">See 
<span class="emphasis">
<em>23_scatterplot_sqrt.html</em></span> for the code that results in the scatterplot shown in 

<a class="xref" href="#Scatterplot_with_sized_circles" title="Figure 6-33. Scatterplot with sized circles">Figure 6-33</a>.</p> 
<div class="figure" id="Scatterplot_with_sized_circles"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0633.png" alt="Scatterplot with sized circles"></div></div> 
<div class="figure-title">Figure 6-33. Scatterplot with sized circles</div> </div> 
<p id="after_arbitrari">After arbitrarily subtracting the datum’s y value <code class="literal">d[1]</code> from the SVG height <code class="literal">h</code>, and then taking the square root, we see that circles with greater y values (those circles lower down) have smaller areas (and shorter radii).</p> 
<p id="this_particular_id2">This particular use of circle area as a visualization tool isn’t necessarily useful.  I simply want to illustrate how you can use <code class="literal">d</code>, along with bracket notation, to reference an individual datum, apply some transformation to that value, and use the newly calculated value to 
<span class="emphasis">
<em>return</em></span> a value back to the attribute-setting method (a value used for <code class="literal">r</code>, in this case).</p> </div> 
<div class="sect2" id="_labels_2"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Labels</h3></div></div></div> 
<p id="lets_label_our">Let’s label our data points with <code class="literal">text</code> elements. I’ll adapt the label code from our bar chart experiments, starting with the following:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id6"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>  <code class="c1">// &lt;-- Note "text", not "circle" or "rect"</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>     <code class="c1">// &lt;-- Same here!</code></pre> 
<p id="this_looks_for_">This looks for all <code class="literal">text</code> elements in the SVG (there aren’t any yet), and then appends a new <code class="literal">text</code> element for each data point. Then we use the <code class="literal">text()</code> method to specify each element’s contents:</p> 
<pre class="programlisting" data-language="javascript" id="textfunction_id7">   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>    <code class="p">})</code></pre> 
<p id="this_looks_mess">This looks messy, but bear with me. Once again, we’re using <code class="literal">function(d)</code> to access each data point. Then, within the function, we’re using 
<span class="emphasis">
<em>both</em></span> <code class="literal">d[0]</code> 
<span class="emphasis">
<em>and</em></span> <code class="literal">d[1]</code> to get both values within that data point array.</p> 
<p id="the_plus__symb">The plus <code class="literal">+</code> symbols, when used with strings, such as the comma between quotation marks <code class="literal">","</code>, act as 
<span class="emphasis">
<em>append</em></span> operators. So what this one line of code is really saying is this: get the values of <code class="literal">d[0]</code> and <code class="literal">d[1]</code> and smush them together with a comma in the middle. The end result should be something like <code class="literal">5,20</code> or <code class="literal">25,67</code>.</p> 
<p id="next_we_specif">Next, we specify 
<span class="emphasis">
<em>where</em></span> the text should be placed with <code class="literal">x</code> and <code class="literal">y</code> values. For now, let’s just use <code class="literal">d[0]</code> and <code class="literal">d[1]</code>, the same values that we used to specify the <code class="literal">circle</code> positions:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id6">   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>    <code class="p">})</code></pre> 
<p id="finally_add_a_">Finally, add a bit of font styling with:</p> 
<pre class="programlisting" data-language="javascript" id="attrfontfam_id2">   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-family"</code><code class="p">,</code> <code class="s2">"sans-serif"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"11px"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code></pre> 
<p id="the_result_in_m">The result in 

<a class="xref" href="#Scatterplot_with_labels" title="Figure 6-34. Scatterplot with labels">Figure 6-34</a> might not be pretty, but we got it working! See 
<span class="emphasis">
<em>24_scatterplot_labels.html</em></span> for the latest.

<a id="id520889" class="indexterm"></a></p> 
<div class="figure" id="Scatterplot_with_labels"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0634.png" alt="Scatterplot with labels"></div></div> 
<div class="figure-title">Figure 6-34. Scatterplot with labels</div> </div> 
<div class="sidebar online_only" id="interactive_6-7"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="experiment_with_id2">Experiment with the code for the scatterplot below. Adjust the code at left and see the chart output at right.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_06/24_scatterplot_labels.html" target="_blank">24_scatterplot_labels</a></p> 

<div class="sect1" data-original-filename="6_drawing_with_data.asciidoc" id="_next_steps"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Next Steps</h2></div></div></div> 
<p id="hopefully_some">Hopefully, some core concepts of D3 are becoming clear: loading data, generating new elements, and using data values to derive attribute values for those elements.

<a id="id520955" class="indexterm"></a></p> 
<p id="yet_the_image_i">Yet the image in 

<a class="xref" href="#Scatterplot_with_labels" title="Figure 6-34. Scatterplot with labels">Figure 6-34</a> is barely passable as a data visualization. The scatterplot is hard to read, and the code doesn’t use our data flexibly. To be honest, we haven’t yet improved on—gag—Excel’s 
<span class="emphasis">
<em>Chart Wizard!</em></span></p> 
<p id="not_to_worry_d">Not to worry: D3 is way cooler than Chart Wizard (not to mention Clippy), but generating a shiny, interactive chart involves taking our D3 skills to the next level. To use data flexibly, we’ll learn about D3’s 
<span class="emphasis">
<em>scales</em></span> in the next chapter. And to make our scatterplot easier to read, we’ll learn about 
<span class="emphasis">
<em>axis generators</em></span> and axis labels.</p> 
<p id="this_would_be_a">This would be a good time to take a break and stretch your legs. Maybe go for a walk, or grab a coffee or a sandwich. I’ll hang out here (if you don’t mind), and when you get back, we’ll jump into D3 scales!</p>
<section class="chapter" data-original-filename="7_scales.asciidoc" id="scales-chapter7">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 7. Scales</h1></div></div></div> 
<p id="scales_are_fun">“Scales are functions that map from an input domain to an output range.”

<a id="ix_scales" class="indexterm"></a></p> 
<p id="thats_mike_bos">That’s 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales" target="_top">Mike Bostock’s definition of D3 scales</a>, and there is no clearer way to say it.

<a id="id521048" class="indexterm"></a></p> 
<p id="the_values_in_a">The values in any dataset are unlikely to correspond exactly to pixel measurements for use in your visualization. Scales provide a convenient way to map those data values to new values useful for visualization purposes.</p> 
<p id="d_scales_are_f">D3 scales are 
<span class="emphasis">
<em>functions</em></span> with parameters that you define. Once they are created, you call the <code class="literal">scale</code> function, pass it a data value, and it nicely returns a scaled output value. You can define and use as many scales as you like.

<a id="id521081" class="indexterm"></a></p> 
<p id="it_might_be_tem">It might be tempting to think of a scale as something that appears visually in the final image—like a set of tick marks, indicating a progression of values. 
<span class="emphasis">
<em>Do not be fooled!</em></span> Those tick marks are part of an 
<span class="emphasis">
<em>axis</em></span>, which is a 
<span class="emphasis">
<em>visual representation</em></span> of a scale. A scale is a mathematical relationship, with no direct visual output. I encourage you to think of scales and axes as two different, yet related, elements.

<a id="id521111" class="indexterm"></a>

<a id="id521119" class="indexterm"></a></p> 
<p id="this_chapter_ad">This chapter addresses only 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear" target="_top">
<span class="emphasis">
<em>linear</em></span></a> scales, because they are most common and easiest understood. Once you understand linear scales, the others—ordinal, logarithmic, square root, and so 
<span class="keep-together">on—will be a piece of cake.</span>

<a id="id521148" class="indexterm"></a></p> 
<div class="sect1" data-original-filename="7_scales.asciidoc" id="_apples_and_pixels"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Apples and Pixels</h2></div></div></div> 
<p id="imagine_that_th">Imagine that the following dataset represents the number of apples sold at a roadside fruit stand each month:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id14"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">100</code><code class="p">,</code> <code class="mi">200</code><code class="p">,</code> <code class="mi">300</code><code class="p">,</code> <code class="mi">400</code><code class="p">,</code> <code class="mi">500</code> <code class="p">];</code></pre> 
<p id="first_of_all_t">First of all, this is great news, as the stand is selling 100 additional apples each month! Business is booming. To showcase this success, you want to make a bar chart illustrating the steep upward climb of apple sales, with each data value corresponding to the height of one bar.</p> 
<p id="until_now_wev">Until now, we’ve used data values directly as display values, ignoring unit differences. So if 500 apples were sold, the corresponding bar would be 500 pixels tall.</p> 
<p id="that_could_work">That could work, but what about next month, when 600 apples are sold? And a year later, when 1,800 apples are sold? Your audience would have to purchase ever-larger displays just to be able to see the full height of those very tall apple bars! (Mmm, apple bars!)</p> 
<p id="this_is_where_s">This is where scales come in. Because apples are not pixels (which are also not oranges), we need scales to translate between them.</p> </div> 
<div class="sect1" data-original-filename="7_scales.asciidoc" id="_domains_and_ranges"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Domains and Ranges</h2></div></div></div> 
<p id="a_scales_input">A scale’s 
<span class="emphasis">
<em>input domain</em></span> is the range of possible input data values. Given the preceding apples data, appropriate input domains would be either 100 and 500 (the minimum and maximum values of the dataset) or 0 and 500.

<a id="id521300" class="indexterm"></a>

<a id="id521305" class="indexterm"></a>

<a id="id521311" class="indexterm"></a></p> 
<p id="a_scales_outpu">A scale’s 
<span class="emphasis">
<em>output range</em></span> is the range of possible output values, commonly used as display values in pixel units. The output range is completely up to you, as the information designer. If you decide the shortest apple bar will be 10 pixels tall, and the tallest will be 350 pixels tall, then you could set an output range of 10 and 350.</p> 
<p id="for_example_cr">For example, create a scale with an input domain of <code class="literal">[100,500]</code> and an output range of <code class="literal">[10,350]</code>. If you handed the low input value of <code class="literal">100</code> to that scale, it would return its lowest range value, <code class="literal">10</code>. If you gave it <code class="literal">500</code>, it would spit back <code class="literal">350</code>. If you gave it <code class="literal">300</code>, it would hand <code class="literal">180</code> back to you on a silver platter. (<code class="literal">300</code> is in the center of the domain, and <code class="literal">180</code> is in the center of the range.)</p> 
<p id="we_can_visualiz">We can visualize the domain and range as corresponding axes, side-by-side, displayed in 

<a class="xref" href="#input_output_axes" title="Figure 7-1. An input domain and an output range, visualized as parallel axes">Figure 7-1</a>.</p> 
<div class="figure" id="input_output_axes"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0701.png" alt="An input domain and an output range, visualized as parallel axes"></div></div> 
<div class="figure-title">Figure 7-1. An input domain and an output range, visualized as parallel axes</div> </div> 
<p id="one_more_thing_id2">One more thing: to prevent your brain from mixing up the 
<span class="emphasis">
<em>input domain</em></span> and 
<span class="emphasis">
<em>output range</em></span> terminology, I’d like to propose a little exercise. When I say “input,” you say “domain.” Then I say “output,” and you say “range.” Ready? Okay:</p> 
<div class="blockquote">
<blockquote class="blockquote">
<p id="input_domain_id1">Input! Domain!</p></blockquote></div> 
<div class="blockquote">
<blockquote class="blockquote">
<p id="output_range_id1">Output! Range!</p></blockquote></div> 
<div class="blockquote">
<blockquote class="blockquote">
<p id="input_domain_id2">Input! Domain!</p></blockquote></div> 
<div class="blockquote">
<blockquote class="blockquote">
<p id="output_range_id2">Output! Range!</p></blockquote></div> 
<p id="got_it_great">Got it? Great.</p> </div> 
<div class="sect1" data-original-filename="7_scales.asciidoc" id="_normalization"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Normalization</h2></div></div></div> 
<p id="if_youre_famil_id3">If you’re familiar with the concept of 
<span class="emphasis">
<em>normalization</em></span>, it might be helpful to know that, with a linear scale, that’s all that is really going on here.

<a id="id521500" class="indexterm"></a>

<a id="id521508" class="indexterm"></a></p> 
<p id="normalization_i">Normalization is the process of mapping a numeric value to a new value between 0 and 1, based on the possible minimum and maximum values. For example, with 365 days in the year, day number 310 maps to about 0.85, or 85 percent of the way through the year.</p> 
<p id="with_linear_sca">With linear scales, we are just letting D3 handle the math of the normalization process. The input value is normalized according to the domain, and then the normalized value is scaled to the output range.</p> </div> 
<div class="sect1" data-original-filename="7_scales.asciidoc" id="_creating_a_scale"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Creating a Scale</h2></div></div></div> 
<p id="ds_scale_func">D3’s scale function generators are accessed with <code class="literal">d3.scale</code> followed by

<a id="id521552" class="indexterm"></a> the type of scale you want. I recommend opening up the sample code page 
<span class="emphasis">
<em>01_scale_test.html</em></span> and typing each of the following into the console:</p> 
<pre class="programlisting" data-language="javascript" id="var_scale__d_id1"><code class="kd">var</code> <code class="nx">scale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">();</code></pre> 
<p id="congratulations_id1">Congratulations! Now <code class="literal">scale</code> is a function to which you can pass input values. (Don’t be misled by the <code class="literal">var</code>. Remember that in JavaScript, variables can store functions.)</p> 
<pre class="programlisting" data-language="javascript" id="scale_r_id1"><code class="nx">scale</code><code class="p">(</code><code class="mf">2.5</code><code class="p">);</code>  <code class="c1">//Returns 2.5</code></pre> 
<p id="because_we_have">Because we haven’t set a domain and a range yet, this function will map input to output on a 1:1 scale. That is, whatever we input will be returned unchanged.</p> 
<p id="we_can_set_the_">We can set the scale’s input domain to <code class="literal">100,500</code> by passing those values to the 
<span class="keep-together"><code class="literal">domain()</code></span> method as an array. Note the hard brackets indicating an array:</p> 
<pre class="programlisting" data-language="javascript" id="scaledomain"><code class="nx">scale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">100</code><code class="p">,</code> <code class="mi">500</code><code class="p">]);</code></pre> 
<p id="set_the_output_">Set the output range in similar fashion, with <code class="literal">range()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="scalerange"><code class="nx">scale</code><code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">10</code><code class="p">,</code> <code class="mi">350</code><code class="p">]);</code></pre> 
<p id="these_steps_can">These steps can be done separately, as just shown, or chained together into one line of code:</p> 
<pre class="programlisting" data-language="javascript" id="var_scale__d_id2"><code class="kd">var</code> <code class="nx">scale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                     <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">100</code><code class="p">,</code> <code class="mi">500</code><code class="p">])</code>                     <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">10</code><code class="p">,</code> <code class="mi">350</code><code class="p">]);</code></pre> 
<p id="either_way_our">Either way, our scale is ready to use!</p> 
<pre class="programlisting" data-language="javascript" id="scale_r_id2"><code class="nx">scale</code><code class="p">(</code><code class="mi">100</code><code class="p">);</code>  <code class="c1">//Returns 10</code> <code class="nx">scale</code><code class="p">(</code><code class="mi">300</code><code class="p">);</code>  <code class="c1">//Returns 180</code> <code class="nx">scale</code><code class="p">(</code><code class="mi">500</code><code class="p">);</code>  <code class="c1">//Returns 350</code></pre> 
<div class="sidebar online_only" id="interactive_7-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_entering_th_id1">Try entering the following <code class="literal">scale</code> statements in the console below to see the results:</p> 
<div class="itemizedlist" id="scale_sca">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">scale(200);</code> </li> 
<li class="listitem"> <code class="literal">scale(450.5);</code> </li> 
<li class="listitem"> <code class="literal">scale(-100);</code> </li> </ul></div> 
<div class="interactive">

<p id="typically_you_">Typically, you will call scale functions from within an <code class="literal">attr()</code> method or similar, not on their own. Let’s modify our scatterplot visualization to use dynamic scales.

<a id="id522089" class="indexterm"></a>

<a id="id522097" class="indexterm"></a>

<a id="id522103" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="7_scales.asciidoc" id="_scaling_the_scatterplot"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Scaling the Scatterplot</h2></div></div></div> 
<p id="to_revisit_our_">To revisit our dataset from the scatterplot:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id15"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                 <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">20</code><code class="p">],</code> <code class="p">[</code><code class="mi">480</code><code class="p">,</code> <code class="mi">90</code><code class="p">],</code> <code class="p">[</code><code class="mi">250</code><code class="p">,</code> <code class="mi">50</code><code class="p">],</code> <code class="p">[</code><code class="mi">100</code><code class="p">,</code> <code class="mi">33</code><code class="p">],</code> <code class="p">[</code><code class="mi">330</code><code class="p">,</code> <code class="mi">95</code><code class="p">],</code>                 <code class="p">[</code><code class="mi">410</code><code class="p">,</code> <code class="mi">12</code><code class="p">],</code> <code class="p">[</code><code class="mi">475</code><code class="p">,</code> <code class="mi">44</code><code class="p">],</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">67</code><code class="p">],</code> <code class="p">[</code><code class="mi">85</code><code class="p">,</code> <code class="mi">21</code><code class="p">],</code> <code class="p">[</code><code class="mi">220</code><code class="p">,</code> <code class="mi">88</code><code class="p">]</code>               <code class="p">];</code></pre> 
<p id="youll_recall_t_id2">You’ll recall that this <code class="literal">dataset</code> is an array of arrays. We mapped the first value in each array onto the x-axis, and the second value onto the y-axis. Let’s start with the x-axis.</p> 
<p id="just_by_eyeball">Just by eyeballing the x values, it looks like they range from 5 to 480, so a reasonable input domain to specify might be <code class="literal">0,500</code>, right?</p> 
<p id="why_are_you_giv">Why are you giving me that look? Oh, because you want to keep your code flexible and scalable, so it will continue to work even if the data changes in the future. Very smart! Remember, if we were building a data dashboard for the roadside apple stand, we’d want our code to accommodate the enormous projected growth in apple sales. Our chart should work just as well with 5 apples sold as 5 million.</p> 
<div class="sect2" id="_d3_min_and_d3_max"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">d3.min() and d3.max()</h3></div></div></div> 
<p id="instead_of_spec">Instead of specifying fixed values for the domain, we can use the convenient array functions <code class="literal">d3.min()</code> and <code class="literal">d3.max()</code> to analyze our data set on the fly. For example, this loops through each of the x values in our arrays and returns the value of the greatest one:</p> 
<pre class="programlisting" data-language="javascript" id="dmaxdataset_id1"><code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>  <code class="c1">//References first value in each subarray</code> <code class="p">});</code></pre> 
<p id="that_code_will_">That code will return the value 480, because 480 is the largest x value in our dataset.  Let me explain how it works.</p> 
<p id="both_min_and_">Both <code class="literal">min()</code> and <code class="literal">max()</code> work the same way, and they can take either one or two arguments. The first argument must be a reference to the array of values you want evaluated, which is <code class="literal">dataset</code>, in this case. If you have a simple, one-dimensional array of numeric values, like <code class="literal">[7, 8, 4, 5, 2]</code>, then it’s obvious how to compare the values against each other, and no second argument is needed. For example:</p> 
<pre class="programlisting" data-language="javascript" id="var_simpledatas"><code class="kd">var</code> <code class="nx">simpleDataset</code> <code class="o">=</code> <code class="p">[</code><code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">2</code><code class="p">];</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">simpleDataset</code><code class="p">);</code>  <code class="c1">// Returns 8</code></pre> 
<p id="the_max_funct">The <code class="literal">max()</code> function simply loops through each value in the array, and identifies the largest one.</p> 
<p id="but_our_dataset">But our <code class="literal">dataset</code> is not just an array of numbers; it is an array of arrays. Calling <code class="literal">d3.max(dataset)</code> might produce unexpected results:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id16"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                 <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">20</code><code class="p">],</code> <code class="p">[</code><code class="mi">480</code><code class="p">,</code> <code class="mi">90</code><code class="p">],</code> <code class="p">[</code><code class="mi">250</code><code class="p">,</code> <code class="mi">50</code><code class="p">],</code> <code class="p">[</code><code class="mi">100</code><code class="p">,</code> <code class="mi">33</code><code class="p">],</code> <code class="p">[</code><code class="mi">330</code><code class="p">,</code> <code class="mi">95</code><code class="p">],</code>                 <code class="p">[</code><code class="mi">410</code><code class="p">,</code> <code class="mi">12</code><code class="p">],</code> <code class="p">[</code><code class="mi">475</code><code class="p">,</code> <code class="mi">44</code><code class="p">],</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">67</code><code class="p">],</code> <code class="p">[</code><code class="mi">85</code><code class="p">,</code> <code class="mi">21</code><code class="p">],</code> <code class="p">[</code><code class="mi">220</code><code class="p">,</code> <code class="mi">88</code><code class="p">]</code>               <code class="p">];</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code>  <code class="c1">// Returns [85, 21].  What???</code></pre> 
<p id="to_tell_max_w">To tell <code class="literal">max()</code> which 
<span class="emphasis">
<em>specific</em></span> values we want compared, we must include a second argument, an 
<span class="emphasis">
<em>accessor function</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="dmaxdataset_id2"><code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">});</code></pre> 
<p id="the_accessor_fu">The accessor function is an anonymous function to which <code class="literal">max()</code> hands

<a id="id523137" class="indexterm"></a>

<a id="id523142" class="indexterm"></a> off each value in the data array, one at a time, as <code class="literal">d</code>. The accessor function specifies 
<span class="emphasis">
<em>how to access</em></span> the value to be used for the comparison. In this case, our data array is <code class="literal">dataset</code>, and we want to compare only the x values, which are the first values in each subarray, meaning in position <code class="literal">[0]</code>. So our accessor function looks like this:</p> 
<pre class="programlisting" data-language="javascript" id="functiond__r_id2"><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>  <code class="c1">//Return the first value in each subarray</code> <code class="p">}</code></pre> 
<p id="note_that_this_">Note that this looks suspiciously similar to the syntax we used when generating our scatterplot circles, which also used anonymous functions to retrieve and return values:</p> 
<pre class="programlisting" data-language="javascript" id="attrcx_fun_id2"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">})</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})</code></pre> 
<p id="this_is_a_commo">This is a common D3 pattern. Soon you will be very comfortable with all manner of anonymous functions crawling all over your code.</p> </div> 
<div class="sect2" id="_setting_up_dynamic_scales"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Setting Up Dynamic Scales</h3></div></div></div> 
<p id="putting_togethe">Putting together what we’ve covered, let’s create the scale function for

<a id="id523424" class="indexterm"></a>

<a id="id523432" class="indexterm"></a> our x-axis:</p> 
<pre class="programlisting" data-language="javascript" id="var_xscale__d_id1"><code class="kd">var</code> <code class="nx">xScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">})])</code>                      <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">]);</code></pre> 
<p id="first_notice_t">First, notice that I named it <code class="literal">xScale</code>. Of course, you can name your scales whatever you want, but a name like <code class="literal">xScale</code> helps me remember what this function does.</p> 
<p id="second_notice_">Second, notice that both the domain and range are specified as two-value arrays in hard brackets.</p> 
<p id="third_notice_t">Third, notice that I set the low end of the input domain to 0. (Alternatively, you could use <code class="literal">min()</code> to calculate a dynamic value.) The upper end of the domain is set to the maximum value in <code class="literal">dataset</code> (which is currently 480, but could change in the future).</p> 
<p id="finally_observ">Finally, observe that the output range is set to <code class="literal">0</code> and <code class="literal">w</code>, the SVG’s width.</p> 
<p id="well_use_very_">We’ll use very similar code to create the scale function for the y-axis:</p> 
<pre class="programlisting" data-language="javascript" id="var_yscale__d_id1"><code class="kd">var</code> <code class="nx">yScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})])</code>                      <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code></pre> 
<p id="note_that_the_m">Note that the <code class="literal">max()</code> function here references <code class="literal">d[1]</code>, the y value of each subarray. Also, the upper end of <code class="literal">range()</code> is set to <code class="literal">h</code> instead of <code class="literal">w</code>.</p> 
<p id="the_scale_funct">The scale functions are in place! Now all we need to do is use them.</p> </div> 
<div class="sect2" id="_incorporating_scaled_values"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Incorporating Scaled Values</h3></div></div></div> 
<p id="revisiting_our_">Revisiting our scatterplot code, we now simply modify the original line

<a id="id523930" class="indexterm"></a> where we created a <code class="literal">circle</code> for each data value:</p> 
<pre class="programlisting" data-language="javascript" id="attrcx_fun_id3"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>  <code class="c1">//Returns original value bound from dataset</code> <code class="p">})</code></pre> 
<p id="to_return_a_sca">to return a scaled value (instead of the original value):</p> 
<pre class="programlisting" data-language="javascript" id="attrcx_fun_id4"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>  <code class="c1">//Returns scaled value</code> <code class="p">})</code></pre> 
<p id="likewise_for_t">Likewise, for the y-axis, this:</p> 
<pre class="programlisting" data-language="javascript" id="attrcy_fun_id1"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})</code></pre> 
<p id="is_modified_as">is modified as:</p> 
<pre class="programlisting" data-language="javascript" id="attrcy_fun_id2"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">})</code></pre> 
<p id="for_good_measur">For good measure, let’s make the same change where we set the coordinates for the text labels, so these lines:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id7"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">})</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})</code></pre> 
<p id="become_this">become this:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_func_id8"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code> <code class="p">})</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">})</code></pre> 
<p id="and_there_we_ar">And there we are!</p> 
<p id="check_out_the_w">Check out the working code in 
<span class="emphasis">
<em>02_scaled_plot.html</em></span>. Visually, the result in 

<a class="xref" href="#Scatterplot_using_x_and_y_scales" title="Figure 7-2. Scatterplot using x and y scales">Figure 7-2</a> is disappointingly similar to our original scatterplot! Yet we are making more progress than might be apparent.

<a id="id524683" class="indexterm"></a></p> 
<div class="figure" id="Scatterplot_using_x_and_y_scales"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0702.png" alt="Scatterplot using x and y scales"></div></div> 
<div class="figure-title">Figure 7-2. Scatterplot using x and y scales</div> </div> 
<div class="sidebar online_only" id="interactive_7-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="experiment_with_id3">Experiment with the code for the scatterplot below. Adjust the <code class="literal">w</code> and <code class="literal">h</code> values to see the effect on the scale. Do the same with the dataset values.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_07/02_scaled_plot.html" target="_blank">02_scaled_plot</a></p> 

<div class="sect1" data-original-filename="7_scales.asciidoc" id="_refining_the_plot"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Refining the Plot</h2></div></div></div> 
<p id="you_might_have__id2">You might have noticed that smaller y values are at the top of the plot, and the larger y values are toward the bottom. Now that we’re using D3 scales, it’s super easy to reverse that, so greater values are higher up, as you would expect. It’s just a matter of changing the output range of <code class="literal">yScale</code> from:</p> 
<pre class="programlisting" data-language="javascript" id="range_h"><code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code></pre> 
<p id="to">to:</p> 
<pre class="programlisting" data-language="javascript" id="rangeh_"><code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">h</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code></pre> 
<p id="see__scaled_p">See 
<span class="emphasis">
<em>03_scaled_plot_inverted.html</em></span> for the code that results in 

<a class="xref" href="#Scatterplot_with_y_scale_inverted" title="Figure 7-3. Scatterplot with y scale inverted">Figure 7-3</a>.</p> 
<div class="figure" id="Scatterplot_with_y_scale_inverted"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0703.png" alt="Scatterplot with y scale inverted"></div></div> 
<div class="figure-title">Figure 7-3. Scatterplot with y scale inverted</div> </div> 
<p id="yes_now_a_smal">Yes, now a 
<span class="emphasis">
<em>smaller</em></span> input to <code class="literal">yScale</code> will produce a 
<span class="emphasis">
<em>larger</em></span> output value, thereby pushing those <code class="literal">circle</code>s and <code class="literal">text</code> elements down, closer to the base of the image. I know, it’s almost too easy!</p> 
<p id="yet_some_elemen">Yet some elements are getting cut off. Let’s introduce a <code class="literal">padding</code> variable:</p> 
<pre class="programlisting" data-language="javascript" id="var_padding___id1"><code class="kd">var</code> <code class="nx">padding</code> <code class="o">=</code> <code class="mi">20</code><code class="p">;</code></pre> 
<p id="then_well_inco">Then we’ll incorporate the <code class="literal">padding</code> amount when setting the range of both scales. This will help push our elements in, away from the edges of the SVG, to prevent them from being clipped.

<a id="id524978" class="indexterm"></a></p> 
<p id="the_range_for_x">The range for <code class="literal">xScale</code> was <code class="literal">range([0, w])</code>, but now it’s:</p> 
<pre class="programlisting" data-language="javascript" id="rangepadding_id1"><code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">padding</code><code class="p">,</code> <code class="nx">w</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">]);</code></pre> 
<p id="the_range_for_y">The range for <code class="literal">yScale</code> was <code class="literal">range([h, 0])</code>, but now it’s:</p> 
<pre class="programlisting" data-language="javascript" id="rangeh__pad"><code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">,</code> <code class="nx">padding</code><code class="p">]);</code></pre> 
<p id="this_should_pro">This should provide us with 20 pixels of extra room on the left, right, top, and bottom edges of the SVG. And it does (see 

<a class="xref" href="#Scatterplot_with_padding" title="Figure 7-4. Scatterplot with padding">Figure 7-4</a>)!</p> 
<div class="figure" id="Scatterplot_with_padding"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0704.png" alt="Scatterplot with padding"></div></div> 
<div class="figure-title">Figure 7-4. Scatterplot with padding</div> </div> 
<p id="but_the_text_la">But the text labels on the far right are still getting cut off, so I’ll double the amount of <code class="literal">xScale</code>’s padding on the right side by multiplying by two to achieve the result shown in 

<a class="xref" href="#Scatterplot_with_more_padding" title="Figure 7-5. Scatterplot with more padding">Figure 7-5</a>:</p> 
<pre class="programlisting" data-language="javascript" id="rangepadding_id2"><code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">padding</code><code class="p">,</code> <code class="nx">w</code> <code class="o">-</code> <code class="nx">padding</code> <code class="o">*</code> <code class="mi">2</code><code class="p">]);</code></pre> 
<div class="figure" id="Scatterplot_with_more_padding"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0705.png" alt="Scatterplot with more padding"></div></div> 
<div class="figure-title">Figure 7-5. Scatterplot with more padding</div> </div> 
<div class="tip" id="the_way_ive_in_id1">
<p id="the_way_ive_in_id2">The way I’ve introduced padding here is simple, but not elegant.  Eventually, you’ll want more control over how much padding is on each side of your charts (top, right, bottom, left), and it’s useful to standardize how you specify those values across projects.  Although I haven’t used 

<a class="ulink" href="http://bl.ocks.org/3019563" target="_top">Mike Bostock’s margin convention</a> for the code samples in this book, I recommend taking a look to see if it could work for you.</p></div> 
<p id="better_referen">Better! Reference the code so far in 
<span class="emphasis">
<em>04_scaled_plot_padding.html</em></span>. But there’s one more change I’d like to make. Instead of setting the radius of each <code class="literal">circle</code> as the square root of its y value (which was a bit of a hack, and not visually useful), why not create another custom scale?</p> 
<pre class="programlisting" data-language="javascript" id="var_rscale__d"><code class="kd">var</code> <code class="nx">rScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})])</code>                      <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">2</code><code class="p">,</code> <code class="mi">5</code><code class="p">]);</code></pre> 
<p id="then_setting_t">Then, setting the radius looks like this:</p> 
<pre class="programlisting" data-language="javascript" id="attrr_func_id3"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">rScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">});</code></pre> 
<p id="this_is_excitin_id2">This is exciting because we are guaranteeing that our radius values will 
<span class="emphasis">
<em>always</em></span> fall within the range of <code class="literal">2,5</code>. (Or 
<span class="emphasis">
<em>almost</em></span> always; see reference to <code class="literal">clamp()</code> later.) So data values of <code class="literal">0</code> (the minimum input) will get circles of radius <code class="literal">2</code> (or a diameter of 4 pixels). The very largest data value will get a circle of radius <code class="literal">5</code> (diameter of 10 pixels).</p> 
<p id="voila_shows_ou">Voila: 

<a class="xref" href="#Scatterplot_with_scaled_radii" title="Figure 7-6. Scatterplot with scaled radii">Figure 7-6</a> shows our first scale used for a visual property other than an axis value. (See 
<span class="emphasis">
<em>05_scaled_plot_radii.html</em></span>.)</p> 
<div class="figure" id="Scatterplot_with_scaled_radii"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0706.png" alt="Scatterplot with scaled radii"></div></div> 
<div class="figure-title">Figure 7-6. Scatterplot with scaled radii</div> </div> 
<p id="finally_just_i">Finally, just in case the power of scales hasn’t yet blown your mind, I’d like to add one more array to the dataset: <code class="literal">[600, 150]</code>.</p> 
<p id="boom_check_out">Boom! Check out 
<span class="emphasis">
<em>06_scaled_plot_big.html</em></span>. Notice how all the old points in 

<a class="xref" href="#Scatterplot_with_big_numbers_added" title="Figure 7-7. Scatterplot with big numbers added">Figure 7-7</a> maintained their relative positions but have migrated closer together, down and to the left, to accommodate the newcomer in the top-right corner.</p> 
<div class="figure" id="Scatterplot_with_big_numbers_added"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0707.png" alt="Scatterplot with big numbers added"></div></div> 
<div class="figure-title">Figure 7-7. Scatterplot with big numbers added</div> </div> 
<p id="and_now_one_fi">And now, one final revelation: we can now very easily change the size of our SVG, and 
<span class="emphasis">
<em>everything scales accordingly</em></span>. In 

<a class="xref" href="#Large_scaled_scatterplot" title="Figure 7-8. Large, scaled scatterplot">Figure 7-8</a>, I’ve increased the value of <code class="literal">h</code> from <code class="literal">100</code> to <code class="literal">300</code> and made 
<span class="emphasis">
<em>no other changes</em></span>.</p> 
<div class="figure" id="Large_scaled_scatterplot"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0708.png" alt="Large, scaled scatterplot"></div></div> 
<div class="figure-title">Figure 7-8. Large, scaled scatterplot</div> </div> 
<p id="boom_again_se">Boom, again! See 
<span class="emphasis">
<em>07_scaled_plot_large.html</em></span>. Hopefully, you are seeing this and realizing: no more late nights tweaking your code because the client decided the graphic should be 800 pixels wide instead of 600. Yes, you will get more sleep because of me (and D3’s brilliant built-in methods). Being well-rested is a competitive advantage. You can thank me later.</p> 
<div class="sidebar online_only" id="interactive_7-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="experiment_with_id4">Experiment with the code for the final scatterplot below. Adjust the code at left and see the chart output at right.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_07/07_scaled_plot_large.html" target="_blank">07_scaled_plot_large</a></p> 

<div class="sect1" data-original-filename="7_scales.asciidoc" id="_other_methods"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Other Methods</h2></div></div></div> 
<p id="dscalelinear"><code class="literal">d3.scale.linear()</code> has several other handy methods that deserve a brief

<a id="id525812" class="indexterm"></a> mention here:</p> 
<div class="variablelist" id="nice_this_tel">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/ZR9Si0" target="_top"><code class="literal">nice()</code></a> </span></dt> 
<dd> This tells the scale to take whatever input domain that you gave to <code class="literal">range()</code> and expand both ends to the nearest round value. From the D3 wiki: “For example, 
<span class="keep-together">for a domain of</span> [0.20147987687960267, 0.996679553296417], the nice domain is [0.2, 1].” This is useful for normal people, who are not computers and find it hard to read numbers like 0.20147987687960267. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/Z2ZLke" target="_top"><code class="literal">rangeRound()</code></a> </span></dt> 
<dd> Use <code class="literal">rangeRound()</code> in place of <code class="literal">range()</code>, and all values output by the scale will be rounded to the nearest whole number. This is useful if you want shapes to have exact pixel values, to avoid the fuzzy edges that could arise with antialiasing. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/12h7uTf" target="_top"><code class="literal">clamp()</code></a> </span></dt> 
<dd> By default, a linear scale 
<span class="emphasis">
<em>can</em></span> return values outside of the specified range. For example, if given a value outside of its expected input domain, a scale will return a number also outside of the output range. Calling <code class="literal">clamp(true)</code> on a scale, however, forces all output values to be within the specified range. This means excessive values will be rounded to the range’s low or high value (whichever is nearest). </dd> </dl></div> 
<p id="to_use_any_of_t">To use any of these special methods, just tack them onto the chain in which you define the original scale function.  For example, to use <code class="literal">nice()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="var_scale__d_id3"><code class="kd">var</code> <code class="nx">scale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                     <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mf">0.123</code><code class="p">,</code> <code class="mf">4.567</code><code class="p">])</code>                     <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">500</code><code class="p">])</code>                     <code class="p">.</code><code class="nx">nice</code><code class="p">();</code></pre> </div> 
<div class="sect1" data-original-filename="7_scales.asciidoc" id="_other_scales"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Other Scales</h2></div></div></div> 
<p id="in_addition_to_">In addition to

<a id="id526084" class="indexterm"></a> 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear" target="_top"><code class="literal">linear</code> scales</a> (discussed earlier), D3 has several other built-in scale methods:</p> 
<div class="variablelist" id="sqrt_a_square_r">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/15ePKWb" target="_top"><code class="literal">sqrt</code></a> </span></dt> 
<dd> A square root scale. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/XBKvuq" target="_top"><code class="literal">pow</code></a> </span></dt> 
<dd> A power scale (good for the gym, er, I mean, useful when working with exponential series of values, as in “to the power of” some exponent). </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/YTuRdX" target="_top"><code class="literal">log</code></a> </span></dt> 
<dd> A logarithmic scale. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/ZEJXtP" target="_top"><code class="literal">quantize</code></a> </span></dt> 
<dd> A linear scale with discrete values for its output range, for when you want to sort data into “buckets.” </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/XxlWlr" target="_top"><code class="literal">quantile</code></a> </span></dt> 
<dd> Similar to <code class="literal">quantize</code>, but with discrete values for its input domain (when you already have “buckets”). </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/XWSVvB" target="_top"><code class="literal">ordinal</code></a> </span></dt> 
<dd> Ordinal scales use nonquantitative values (like category names) for output; perfect for comparing apples and oranges. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/X6O0fT" target="_top"><code class="literal">d3.scale.category10()</code></a>, 

<a class="ulink" href="http://bit.ly/Wn3QPH" target="_top"><code class="literal">d3.scale.category20()</code></a>, 

<a class="ulink" href="http://bit.ly/13bmamp" target="_top"><code class="literal">d3.scale.category20b()</code></a>, and 

<a class="ulink" href="http://bit.ly/Wn3Saf" target="_top"><code class="literal">d3.scale.category20c()</code></a> </span></dt> 
<dd> Handy preset ordinal scales that output either 10 or 20 categorical colors. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bit.ly/Xxm6tc" target="_top"><code class="literal">d3.time.scale()</code></a> </span></dt> 
<dd> A scale method for date and time values, with special handling of ticks for dates. </dd> </dl></div> 
<p id="now_that_you_ha">Now that you have mastered the power of scales, it’s time to express them visually as, yes, 
<span class="emphasis">
<em>axes</em></span>!</p>
<section class="chapter" data-original-filename="8_axes.asciidoc" id="axes-chapter8">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 8. Axes</h1></div></div></div> 
<p id="having_mastered">Having mastered the use of D3 scales, we now have the scatterplot shown in 

<a class="xref" href="#Large_scaled_scatterplot2" title="Figure 8-1. Large, scaled scatterplot">Figure 8-1</a>.</p> 
<div class="figure" id="Large_scaled_scatterplot2"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0801.png" alt="Large, scaled scatterplot"></div></div> 
<div class="figure-title">Figure 8-1. Large, scaled scatterplot</div> </div> 
<p id="lets_add_horiz">Let’s add horizontal and vertical axes, so we can do away with the horrible red numbers cluttering up our chart.

<a id="ix_axes" class="indexterm"></a>

<a id="id526376" class="indexterm"></a></p> 
<div class="sect1" data-original-filename="8_axes.asciidoc" id="_introducing_axes"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Introducing Axes</h2></div></div></div> 
<p id="much_like_its_s">Much like its scales, 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/SVG-Axes" target="_top">D3’s 
<span class="emphasis">
<em>axes</em></span></a> are actually 
<span class="emphasis">
<em>functions</em></span> whose parameters you define. Unlike scales, when an axis function is called, it doesn’t return a value, but generates the visual elements of the axis, including lines, labels, and ticks.

<a id="id526415" class="indexterm"></a>

<a id="id526421" class="indexterm"></a></p> 
<p id="note_that_the_a">Note that the axis functions are SVG-specific, as they generate SVG elements. Also, axes are intended for use with quantitative scales (as opposed to ordinal ones).

<a id="id526436" class="indexterm"></a>

<a id="id526441" class="indexterm"></a>

<a id="id526447" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="8_axes.asciidoc" id="_setting_up_an_axis"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Setting Up an Axis</h2></div></div></div> 
<p id="use_dsvgaxis">Use <code class="literal">d3.svg.axis()</code> to create a generic axis 

<a id="id526477" class="indexterm"></a>function:</p> 
<pre class="programlisting" data-language="javascript" id="var_xaxis__d_id1"><code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">();</code></pre> 
<p id="at_a_minimum_e">At a minimum, each axis also needs to be told on what 
<span class="emphasis">
<em>scale</em></span> to operate. Here we’ll pass in the <code class="literal">xScale</code> from the scatterplot code:</p> 
<pre class="programlisting" data-language="javascript" id="xaxisscalexsc"><code class="nx">xAxis</code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">);</code></pre> 
<p id="we_can_also_spe">We can also specify where the labels should appear relative to the axis

<a id="id526595" class="indexterm"></a> itself. The default is <code class="literal">bottom</code>, meaning the labels will appear below the axis line. (Although this is the default, it can’t hurt to specify it explicitly.) Possible orientations for horizontal axes are <code class="literal">top</code> and <code class="literal">bottom</code>. For vertical axes, use <code class="literal">left</code> and <code class="literal">right</code>:</p> 
<pre class="programlisting" data-language="javascript" id="xaxisorientb"><code class="nx">xAxis</code><code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">);</code></pre> 
<p id="of_course_we_c">Of course, we can be more concise and string all this together into one line:</p> 
<pre class="programlisting" data-language="javascript" id="var_xaxis__d_id2"><code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>                   <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">);</code></pre> 
<p id="finally_to_act">Finally, to actually generate the axis and insert all those little lines and labels into our SVG, we must 
<span class="emphasis">
<em>call</em></span> the <code class="literal">xAxis</code> function. This is similar to the scale functions, which we first configured by setting parameters, and then later 
<span class="emphasis">
<em>called</em></span>, to put them into action.

<a id="id526795" class="indexterm"></a></p> 
<p id="ill_put_this_c">I’ll put this code at the end of our script, so the axis is generated after the other elements in the SVG, and therefore appears “on top”:</p> 
<pre class="programlisting" data-language="javascript" id="svgappendg_id1"><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code></pre> 
<p id="this_is_where_t">This is where things get a little funky. You might be wondering why this looks so different from our friendly scale functions. Here’s why: because an 
<span class="emphasis">
<em>axis</em></span> function actually draws something to the screen (by appending SVG elements to the DOM), we need to specify 
<span class="emphasis">
<em>where</em></span> in the DOM it should place those new elements. This is in contrast to scale functions like <code class="literal">xScale()</code>, for example, which calculate a value and return those values, typically for use by yet another function, without impacting the DOM at all.

<a id="id526892" class="indexterm"></a></p> 
<p id="so_what_were_d">So what we’re doing with the preceding code is to first reference <code class="literal">svg</code>, the SVG image in the DOM. Then, we <code class="literal">append()</code> a new <code class="literal">g</code> element to the end of the SVG. In SVG land, a <code class="literal">g</code> element is a 
<span class="emphasis">
<em>group</em></span> element. Group

<a id="id526935" class="indexterm"></a>

<a id="id526943" class="indexterm"></a> elements are invisible, unlike <code class="literal">line</code>, <code class="literal">rect</code>, and <code class="literal">circle</code>, and they have no visual presence themselves. Yet they help us in two ways: first, <code class="literal">g</code> elements can be used to contain (or “group”) other elements, which keeps our code nice and tidy. Second, we can apply 
<span class="emphasis">
<em>transformations</em></span> to <code class="literal">g</code> elements, which affects how visual elements within that group (such as <code class="literal">line</code>s, <code class="literal">rect</code>s, and <code class="literal">circle</code>s) are rendered. We’ll get to transformations in just a minute.</p> 
<p id="so_weve_create">So we’ve created a new <code class="literal">g</code>, and then finally, the function <code class="literal">call()</code> is called on our new <code class="literal">g</code>. So what is <code class="literal">call()</code>, and who is it calling?</p> 
<p id="ds_call_fun">

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-call" target="_top">D3’s <code class="literal">call()</code> function</a> takes the incoming 
<span class="emphasis">
<em>selection</em></span>, as received from the prior link in the chain, and hands that selection off to any 
<span class="emphasis">
<em>function</em></span>. In this case, the selection is our new <code class="literal">g</code> group element.  Although the <code class="literal">g</code> isn’t strictly necessary, we are using it because the axis function is about to generate lots of crazy lines and numbers, and it’s nice to contain all those elements within a single group object.  <code class="literal">call()</code> hands off <code class="literal">g</code> to the <code class="literal">xAxis</code> function, so our axis is generated 
<span class="emphasis">
<em>within</em></span> <code class="literal">g</code>.</p> 
<p id="if_we_were_mess">If we were messy people who loved messy code, we could also rewrite the preceding snippet as this exact equivalent:</p> 
<pre class="programlisting" data-language="javascript" id="svgappendg_id2"><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>     <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code>     <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">));</code></pre> 
<p id="see_you_could_">See, you could cram the whole axis function within <code class="literal">call()</code>, but it’s usually easier on our brains to define functions first, then call them later.</p> 
<p id="in_any_case_sh">In any case, 

<a class="xref" href="#Simple_but_ugly_axis" title="Figure 8-2. Simple, but ugly axis">Figure 8-2</a> shows what that looks like. See code example 
<span class="emphasis">
<em>01_axes.html</em></span>.</p> 
<div class="figure" id="Simple_but_ugly_axis"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0802.png" alt="Simple, but ugly axis"></div></div> 
<div class="figure-title">Figure 8-2. Simple, but ugly axis</div> </div> 
<div class="sidebar online_only" id="interactive_8-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_editing_the_id1">Try editing the <code class="literal">dataset</code> values below at left, and watch the scale adjust in the output at right.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_08/01_axes.html" target="_blank">01_axes</a></p> 

<div class="sect1" data-original-filename="8_axes.asciidoc" id="_cleaning_it_up"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Cleaning It Up</h2></div></div></div> 
<p id="technically_th">Technically, that is an axis, but it’s neither pretty nor useful. To

<a id="id527319" class="indexterm"></a>

<a id="id527327" class="indexterm"></a> clean it up, let’s first assign a class of <code class="literal">axis</code> to the new <code class="literal">g</code> element, so we can target it with CSS:</p> 
<pre class="programlisting" data-language="javascript" id="svgappendg_id3"><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code> <code class="c1">//Assign "axis" class</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code></pre> 
<p id="then_we_introd">Then, we introduce our first CSS styles, up in the <code class="literal">&lt;head&gt;</code> of our page:</p> 
<pre class="programlisting" data-language="css" id="axis_path_ax"><code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code> <code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>     <code class="k">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>     <code class="k">stroke</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>     <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code> <code class="p">}</code>  <code class="nc">.axis</code> <code class="nt">text</code> <code class="p">{</code>     <code class="k">font-family</code><code class="o">:</code> <code class="nb">sans-serif</code><code class="p">;</code>     <code class="k">font-size</code><code class="o">:</code> <code class="m">11px</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="see_how_useful_">See how useful it is to group all the axis elements within one <code class="literal">g</code> group? Now we can very easily apply styles to anything within the group using the simple CSS selector <code class="literal">.axis</code>. The axes themselves are made up of <code class="literal">path</code>, <code class="literal">line</code>, and <code class="literal">text</code> elements, so those are the three elements that we target in our CSS. The <code class="literal">path</code>s and <code class="literal">line</code>s can be styled with the same rules, and <code class="literal">text</code> gets its own rules around font and font size.</p> 
<p id="you_might_notic_id1">You might notice that when we use CSS rules to style SVG elements, only SVG attribute names—not regular CSS properties—should be used. This is confusing, because many properties share the same names in both CSS and SVG, but some do not. For example, in regular CSS, to set the color

<a id="id527692" class="indexterm"></a> of some text, you would use the <code class="literal">color</code> property, as in:</p> 
<pre class="programlisting" data-language="css" id="p__color_oliv"><code class="nt">p</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">olive</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="that_will_set_t">That will set the text color of all <code class="literal">p</code> paragraphs to be <code class="literal">olive</code>. But try to apply this property to an SVG element, as with:</p> 
<pre class="programlisting" data-language="css" id="text__color_o"><code class="nt">text</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">olive</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="and_it_will_hav">and it will have no effect because <code class="literal">color</code> is not a property recognized by SVG. Instead, you must use SVG’s equivalent, <code class="literal">fill</code>:</p> 
<pre class="programlisting" data-language="css" id="text__fill_ol"><code class="nt">text</code> <code class="p">{</code>     <code class="k">fill</code><code class="o">:</code> <code class="nb">olive</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="if_you_ever_fin">If you ever find yourself trying to style SVG elements, but for some reason the stupid CSS code just isn’t working, I suggest you take a deep breath, pause, and then review your 
<span class="emphasis">
<em>property names</em></span> very closely to ensure you’re using SVG names, not CSS ones. (You can reference the complete SVG attribute list on 

<a class="ulink" href="https://developer.mozilla.org/en-US/docs/SVG/Attribute" target="_top">the MDN site</a>.)

<a id="id527891" class="indexterm"></a></p> 
<p id="the_shaperende">

<a class="ulink" href="https://developer.mozilla.org/en/SVG/Attribute/shape-rendering" target="_top">The <code class="literal">shape-rendering</code> property</a> is another weird SVG attribute you should know. We use it here to make sure our axis and its tick mark lines are pixel-perfect. No blurry axes for us!

<a id="id527918" class="indexterm"></a>

<a id="id527924" class="indexterm"></a></p> 
<p id="the_chart_looks">The chart looks like 

<a class="xref" href="#Cleaner_axis" title="Figure 8-3. Cleaner axis">Figure 8-3</a> after our CSS clean-up.</p> 
<div class="figure" id="Cleaner_axis"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0803.png" alt="Cleaner axis"></div></div> 
<div class="figure-title">Figure 8-3. Cleaner axis</div> </div> 
<p id="thats_better_">That’s better, but the top horizontal line of the axis is cut off, and the axis itself should be down at the base of the chart anyway. Here’s where SVG 
<span class="emphasis">
<em>transformations</em></span> come in. By adding one line of code, we can

<a id="id527974" class="indexterm"></a>

<a id="id527980" class="indexterm"></a> <code class="literal">transform</code> the entire axis group, pushing it to the bottom:</p> 
<pre class="programlisting" data-language="javascript" id="svgappendg_id4"><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code></pre> 
<p id="note_that_we_us">Note that we use <code class="literal">attr()</code> to apply <code class="literal">transform</code> as an attribute of <code class="literal">g</code>. 

<a class="ulink" href="https://developer.mozilla.org/en-US/docs/SVG/Attribute/transform" target="_top">SVG transforms</a> are quite powerful, and can accept several different kinds of transform definitions, including scales and rotations. But we are keeping it simple here with only a 
<span class="emphasis">
<em>translation</em></span> transform, which simply pushes the whole <code class="literal">g</code> group over and down by some amount.

<a id="id528197" class="indexterm"></a></p> 
<p id="translation_tra">Translation transforms are specified with the easy syntax of <code class="literal">translate(x,y)</code>, where <code class="literal">x</code> and <code class="literal">y</code> are, obviously, the number of horizontal and vertical pixels by which to translate the element. So, in the end, we would like our <code class="literal">g</code> to look like this in the DOM:</p> 
<pre class="programlisting" data-language="html" id="g_classaxis"><code class="nt">&lt;g</code> <code class="na">class=</code><code class="s">"axis"</code> <code class="na">transform=</code><code class="s">"translate(0,280)"</code><code class="nt">&gt;</code></pre> 
<p id="as_you_can_see_id2">As you can see, the <code class="literal">g.axis</code> isn’t moved horizontally at all, but it is pushed 280 pixels down, conveniently to the base of our chart. We specify as much in this line of code:</p> 
<pre class="programlisting" data-language="javascript" id="attrtransfor">    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code></pre> 
<p id="note_the_use_of">Note the use of <code class="literal">(h - padding)</code>, so the group’s top edge is set to <code class="literal">h</code>, the height of the entire image, minus the <code class="literal">padding</code> value we created earlier. <code class="literal">(h - padding)</code> is calculated to be <code class="literal">280</code>, and then connected to the rest of the string, so the final transform property value is

<a id="id528402" class="indexterm"></a> <code class="literal">translate(0,280)</code>.</p> 
<p id="the_result_in_i">The result in 

<a class="xref" href="#Nice_clean_axis" title="Figure 8-4. Nice, clean axis">Figure 8-4</a> is much better! Check out the code so far in 
<span class="emphasis">
<em>02_axes_bottom.html</em></span>.</p> 
<div class="figure" id="Nice_clean_axis"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0804.png" alt="Nice, clean axis"></div></div> 
<div class="figure-title">Figure 8-4. Nice, clean axis</div> </div> </div> 
<div class="sect1" data-original-filename="8_axes.asciidoc" id="_check_for_ticks"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Check for Ticks</h2></div></div></div> 
<p id="some_ticks_spre">Some ticks spread disease, but 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear_ticks" target="_top">D3’s ticks</a> communicate information. Yet more ticks are not necessarily better, and at a certain point, they begin to clutter your chart. You’ll notice that we never specified how many ticks to include on the axis, nor at what intervals they should appear. Without clear instruction, D3 has automagically examined our scale <code class="literal">xScale</code> and made informed judgments about how many ticks to include, and at what intervals (every 50, in this case).

<a id="id528482" class="indexterm"></a>

<a id="id528490" class="indexterm"></a>

<a id="id528496" class="indexterm"></a></p> 
<p id="as_you_would_ex">As you would expect, you can customize all aspects of your axes, starting with the rough number of ticks, using <code class="literal">ticks()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="var_xaxis__d_id3"><code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>                   <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>  <code class="c1">//Set rough # of ticks</code></pre> 
<p id="see__axes_cle">See 
<span class="emphasis">
<em>03_axes_clean.html</em></span> for that code.</p> 
<p id="youll_notice_i">You’ll notice in 

<a class="xref" href="#Fewer_ticks" title="Figure 8-5. Fewer ticks">Figure 8-5</a> that, although we specified only five ticks, D3 has made an executive decision and ordered up a total of seven. That’s because D3 has got your back, and figured out that including only 
<span class="emphasis">
<em>five</em></span> ticks would require slicing the input domain into less-than-gorgeous values—in this case, 0, 150, 300, 450, and 600. D3 inteprets the <code class="literal">ticks()</code> value as merely a suggestion and will override your suggestion with what it determines to be the most clean and human-readable values—in this case, intervals of 100—even when that requires including slightly more or fewer ticks than you requested. This is actually a totally brilliant feature that increases the scalability of your design; as the dataset changes and the input domain expands or contracts (bigger numbers or smaller numbers), D3 ensures that the tick labels remain easy to read.</p> 
<div class="figure" id="Fewer_ticks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0805.png" alt="Fewer ticks"></div></div> 
<div class="figure-title">Figure 8-5. Fewer ticks</div> </div> </div> 
<div class="sect1" data-original-filename="8_axes.asciidoc" id="_y_not"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Y Not?</h2></div></div></div> 
<p id="time_to_label_t">Time to label the vertical axis! By copying and tweaking the code we

<a id="id528716" class="indexterm"></a>

<a id="id528722" class="indexterm"></a>

<a id="id528730" class="indexterm"></a> already wrote for the <code class="literal">xAxis</code>, we add this near the top of of our code:</p> 
<pre class="programlisting" data-language="javascript" id="define_y_axis"><code class="c1">//Define Y axis</code> <code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>                   <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">yScale</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code></pre> 
<p id="and_this_near_">and this, near the bottom:</p> 
<pre class="programlisting" data-language="javascript" id="create_y_axis"><code class="c1">//Create Y axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">padding</code> <code class="o">+</code> <code class="s2">",0)"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code></pre> 
<p id="note_in_that_th">Note in 

<a class="xref" href="#Initial_Y_axis" title="Figure 8-6. Initial y-axis">Figure 8-6</a> that the labels will be oriented <code class="literal">left</code> and that the <code class="literal">yAxis</code> group <code class="literal">g</code> is translated to the right by the amount <code class="literal">padding</code>.</p> 
<div class="figure" id="Initial_Y_axis"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0806.png" alt="Initial y-axis"></div></div> 
<div class="figure-title">Figure 8-6. Initial y-axis</div> </div> 
<p id="this_is_startin">This is starting to look like a real chart! But the <code class="literal">yAxis</code> labels are getting cut off. To give them more room on the left side, I’ll bump up the value of <code class="literal">padding</code> from 20 to 30:</p> 
<pre class="programlisting" data-language="javascript" id="var_padding___id2"><code class="kd">var</code> <code class="nx">padding</code> <code class="o">=</code> <code class="mi">30</code><code class="p">;</code></pre> 
<p id="of_course_you__id4">Of course, you could also introduce separate <code class="literal">padding</code> variables for each axis, say 
<span class="keep-together"><code class="literal">xPadding</code></span> and <code class="literal">yPadding</code>, for more control over the layout.

<a id="id529154" class="indexterm"></a></p> 
<p id="see_the_updated">See the updated code in 
<span class="emphasis">
<em>04_axes_y.html</em></span>. It looks like 

<a class="xref" href="#Scatterplot_with_Y_axis" title="Figure 8-7. Scatterplot with y-axis">Figure 8-7</a>.</p> 
<div class="figure" id="Scatterplot_with_Y_axis"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0807.png" alt="Scatterplot with y-axis"></div></div> 
<div class="figure-title">Figure 8-7. Scatterplot with y-axis</div> </div> 
<div class="sidebar online_only" id="interactive_8-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_editing_the_id2">Try editing the <code class="literal">dataset</code> values below at left, and watch both the x- and y- scales update at right</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_08/04_axes_y.html" target="_blank">04_axes_y</a></p> 

<div class="sect1" data-original-filename="8_axes.asciidoc" id="_final_touches"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Final Touches</h2></div></div></div> 
<p id="i_appreciate_th">I appreciate that so far you have been very quiet and polite, and not at all confrontational. Yet I still feel as though I have to win you over. So to prove to you that our new axes are dynamic and scalable, I’d like

<a id="id529241" class="indexterm"></a>

<a id="id529249" class="indexterm"></a> to switch from using a static dataset to using randomized numbers:</p> 
<pre class="programlisting" data-language="javascript" id="dynamic_rand"><code class="c1">//Dynamic, random dataset</code> <code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[];</code> <code class="kd">var</code> <code class="nx">numDataPoints</code> <code class="o">=</code> <code class="mi">50</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">xRange</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">yRange</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numDataPoints</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="kd">var</code> <code class="nx">newNumber1</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">xRange</code><code class="p">);</code>     <code class="kd">var</code> <code class="nx">newNumber2</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">yRange</code><code class="p">);</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="nx">newNumber1</code><code class="p">,</code> <code class="nx">newNumber2</code><code class="p">]);</code> <code class="p">}</code></pre> 
<p id="this_code_initi">This code initializes an empty array, then loops through 50 times, chooses two random numbers each time, and adds (“pushes”) that pair of values to the <code class="literal">dataset</code> array (see 

<a class="xref" href="#Scatterplot_with_random_data" title="Figure 8-8. Scatterplot with random data">Figure 8-8</a>).</p> 
<div class="figure" id="Scatterplot_with_random_data"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0808.png" alt="Scatterplot with random data"></div></div> 
<div class="figure-title">Figure 8-8. Scatterplot with random data</div> </div> 
<p id="try_out_that_ra">Try out that randomized dataset code in 
<span class="emphasis">
<em>05_axes_random.html</em></span>. Each time you reload the page, you’ll get different data values. Notice how both axes scale to fit the new domains, and ticks and label values are chosen accordingly.</p> 
<div class="sidebar online_only" id="interactive_8-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="regenerate_the_">Regenerate the scatterplot below by hovering over the graph and then hitting the "Run with JS" button, and watch the scales on the axes dynamically update to fit the randomly generated data points.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_08/05_axes_random.html" target="_blank">05_axes_random</a></p> 

<p id="having_made_my_">Having made my point, I think we can finally cut those horrible, red labels, by commenting out the relevant lines of code.</p> 
<p id="the_result_is_s">The result is shown in 

<a class="xref" href="#Scatterplot_with_random_data_and_no_red_labels" title="Figure 8-9. Scatterplot with random data and no red labels">Figure 8-9</a>. Our final scatterplot code lives in 
<span class="emphasis">
<em>06_axes_no_labels.html</em></span>.</p> 
<div class="figure" id="Scatterplot_with_random_data_and_no_red_labels"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0809.png" alt="Scatterplot with random data and no red labels"></div></div> 
<div class="figure-title">Figure 8-9. Scatterplot with random data and no red labels</div> </div> </div> 
<div class="sect1" data-original-filename="8_axes.asciidoc" id="_formatting_tick_labels"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Formatting Tick Labels</h2></div></div></div> 
<p id="one_last_thing">One last thing: so far, we’ve been working with integers—whole numbers—which are nice and easy. But data is often messier, and in those cases, you might want more control over how the axis labels are formatted.

<a id="id529796" class="indexterm"></a>

<a id="id529804" class="indexterm"></a> Enter 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear_tickFormat" target="_top"><code class="literal">tickFormat()</code></a>, which enables you to specify how your numbers should be formatted. For example, you might want to include three places after the decimal point, or display values as percentages, or both.</p> 
<p id="to_use_tickform">To use <code class="literal">tickFormat()</code>, first define a new number-formatting function. This one, for example, says to treat values as percentages with one decimal point precision. That is, if you give this function the number <code class="literal">0.23</code>, it will return the string <code class="literal">23.0%</code>. (See 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Formatting#wiki-d3_format" target="_top">the reference entry for <code class="literal">d3.format()</code></a> for more options.)</p> 
<pre class="programlisting" data-language="javascript" id="var_formatasper"><code class="kd">var</code> <code class="nx">formatAsPercentage</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">".1%"</code><code class="p">);</code></pre> 
<p id="then_tell_your">Then, tell your axis to use that formatting function for its ticks, for example:</p> 
<pre class="programlisting" data-language="javascript" id="xaxistickforma"><code class="nx">xAxis</code><code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">formatAsPercentage</code><code class="p">);</code></pre> 
<div class="tip" id="i_find_it_easie_id1"> 
<p id="i_find_it_easie_id2">I find it easiest to test these formatting functions out in the JavaScript console. For example, just open any page that loads D3, such as 
<span class="keep-together">
<span class="emphasis">
<em>06_axes_no_labels.html</em></span></span>, and type your format rule into the console. Then test it by feeding it a value, as you would with any other function.

<a id="id529975" class="indexterm"></a></p> 
<p id="you_can_see_in_">You can see in 

<a class="xref" href="#Testing_format_console" title="Figure 8-10. Testing format() in the console">Figure 8-10</a> that a data value of <code class="literal">0.54321</code> is converted to <code class="literal">54.3%</code> for display purposes—perfect!</p> 
<div class="figure" id="Testing_format_console"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0810.png" alt="Testing format() in the console"></div></div> 
<div class="figure-title">Figure 8-10. Testing format() in the console</div> </div> </div> 
<div class="sidebar online_only" id="interactive_8-4"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_entering_th_id2">Try entering the following <code class="literal">formatAsPercentage</code> statements in the console below to see the results:</p> 
<div class="itemizedlist" id="formataspercent_id1">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">formatAsPercentage(.365);</code> </li> 
<li class="listitem"> <code class="literal">formatAsPercentage(1.2);</code> </li> 
<li class="listitem"> <code class="literal">formatAsPercentage(-.5);</code> </li> </ul></div> 
<div class="interactive">

<p id="you_can_play_wi">You can play with that code in 
<span class="emphasis">
<em>07_axes_format.html</em></span>. Obviously, a percentage format doesn’t make sense with our scatterplot’s current dataset, but as an exercise, you could try tweaking how the random numbers are generated, to make more appropriate, non-whole number values, or just experiment with the format function itself.

<a id="id530107" class="indexterm"></a></p>
<section class="chapter" data-original-filename="9_updates_transitions_and_motion.asciidoc" id="updates-chapter9">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 9. Updates, Transitions, and Motion</h1></div></div></div> 
<p id="until_this_poin">Until this point, we have used only static datasets. But real-world data almost always 
<span class="emphasis">
<em>changes</em></span> over time. And you might want your visualization to reflect those changes.

<a id="ix_updates" class="indexterm"></a></p> 
<p id="in_d_terms_th">In D3 terms, those changes are handled by 
<span class="emphasis">
<em>updates</em></span>. The visual adjustments are made pretty with 
<span class="emphasis">
<em>transitions</em></span>, which can employ 
<span class="emphasis">
<em>motion</em></span> for perceptual benefit.

<a id="id530167" class="indexterm"></a></p> 
<p id="well_start_by__id2">We’ll start by generating a visualization with one dataset, and then changing the data completely.</p> 
<div class="sect1" data-original-filename="9_updates_transitions_and_motion.asciidoc" id="_modernizing_the_bar_chart"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Modernizing the Bar Chart</h2></div></div></div> 
<p id="lets_revisit_o">Let’s revisit our trusty old bar chart in 

<a class="xref" href="#The_bar_chart_as_seen_last" title="Figure 9-1. The bar chart, as seen last">Figure 9-1</a>.</p> 
<div class="figure" id="The_bar_chart_as_seen_last"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0901.png" alt="The bar chart, as seen last"></div></div> 
<div class="figure-title">Figure 9-1. The bar chart, as seen last</div> </div> 
<p id="if_you_examine_">If you examine the code in 
<span class="emphasis">
<em>01_bar_chart.html</em></span>, you’ll see that we used this static dataset:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id17"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code>                 <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<p id="since_then_we">Since then, we’ve learned how to write more flexible code, so our chart elements resize to accommodate different sized datasets (meaning shorter or longer arrays) and different data values (smaller or larger numbers). We accomplished that flexibility using D3 scales, so I’d like to start by bringing our bar chart up to speed.

<a id="ix_ubcht" class="indexterm"></a></p> 
<p id="ready_okay_ju">Ready? Okay, just give me a sec…</p> 
<p id="aaaaaand_done">Aaaaaand, done! Thanks for waiting.</p> 
<p id="looks_pretty_si">

<a class="xref" href="#A_scalable_flexible_bar_chart" title="Figure 9-2. A scalable, flexible bar chart">Figure 9-2</a> looks pretty similar, but a lot has changed under the hood. You can

<a id="ix_bcscal" class="indexterm"></a> follow along by opening up 
<span class="emphasis">
<em>02_bar_chart_with_scales.html</em></span>.</p> 
<div class="figure" id="A_scalable_flexible_bar_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0902.png" alt="A scalable, flexible bar chart"></div></div> 
<div class="figure-title">Figure 9-2. A scalable, flexible bar chart</div> </div> 
<p id="to_start_i_adj">To start, I adjusted the width and height, to make the chart taller and wider:</p> 
<pre class="programlisting" data-language="javascript" id="var_w___va_id1"><code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">250</code><code class="p">;</code></pre> 
<p id="next_i_introdu">Next, I introduced an 
<span class="emphasis">
<em>ordinal scale</em></span> to handle the left/right

<a id="id530613" class="indexterm"></a> positioning of bars and labels along the x-axis:</p> 
<pre class="programlisting" data-language="javascript" id="var_xscale__d_id2"><code class="kd">var</code> <code class="nx">xScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">ordinal</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">))</code>                 <code class="p">.</code><code class="nx">rangeRoundBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">],</code> <code class="mf">0.05</code><code class="p">);</code></pre> 
<p id="this_may_seem_l">This may seem like gobbledegook, so I’ll walk through it one line at a time.</p> 
<div class="sect2" id="_ordinal_scales_explained"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Ordinal Scales, Explained</h3></div></div></div> 
<p id="first_in_this_">First, in this line:</p> 
<pre class="programlisting" data-language="javascript" id="var_xscale__d_id3"><code class="kd">var</code> <code class="nx">xScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">ordinal</code><code class="p">()</code></pre> 
<p id="we_declare_a_ne">we declare a new variable called <code class="literal">xScale</code>, just as we had done with our scatterplot. Only here, instead of a 
<span class="emphasis">
<em>linear</em></span> scale, we create an 
<span class="emphasis">
<em>ordinal</em></span> one. Ordinal scales are typically used for ordinal data, typically categories with some inherent 
<span class="emphasis">
<em>order</em></span> to them, such as:</p> 
<div class="itemizedlist" id="freshman_sopho_id1">
<ul class="itemizedlist"> 
<li class="listitem"> freshman, sophomore, junior, senior </li> 
<li class="listitem"> grade B, grade A, grade AA </li> 
<li class="listitem"> strongly dislike, dislike, neutral, like, strongly like </li> </ul></div> 
<p id="we_dont_have_t">We don’t have true ordinal data for use with this bar chart. Instead, we just want the bars to be drawn from left to right using the same order in which values occur in our dataset. D3’s ordinal scale is useful in this situation, when we have many visual elements (vertical bars) that are positioned in an arbitrary order (left to right), but must be evenly spaced. This will become clear in a moment.

<a id="id530893" class="indexterm"></a></p> 
<pre class="programlisting" data-language="javascript" id="domaindrang_id1"><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">))</code></pre> 
<p id="this_next_line_">This next line of code sets the input domain for the scale. Remember how linear scales need a two-value array to set their domains, as in <code class="literal">[0, 100]</code>? For a linear scale, that array would set the low and high values of the domain. But ordinal domains are, well, ordinal, so they don’t think in linear, quantitative terms. To set the domain of an ordinal scale, you typically specify an array with the category names, as in:</p> 
<pre class="programlisting" data-language="javascript" id="domainfresh"><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="s2">"freshman"</code><code class="p">,</code> <code class="s2">"sophomore"</code><code class="p">,</code> <code class="s2">"junior"</code><code class="p">,</code> <code class="s2">"senior"</code><code class="p">])</code></pre> 
<p id="for_our_bar_cha">For our bar chart, we don’t have explicit categories, but we could assign each data point or bar an ID value corresponding to its position within the <code class="literal">dataset</code> array, as in 0, 1, 2, 3, and so on. So perhaps our domain statement could read:</p> 
<pre class="programlisting" data-language="javascript" id="domain__"><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code>          <code class="mi">10</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">14</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">19</code><code class="p">])</code></pre> 
<p id="it_turns_out_th">It turns out there is a very simple way to quickly generate an array of sequential numbers: the <code class="literal">d3.range()</code> method.

<a id="id531267" class="indexterm"></a>

<a id="id531273" class="indexterm"></a></p> 
<p id="while_viewing_">While viewing 
<span class="emphasis">
<em>02_bar_chart_with_scales.html</em></span>, go ahead and open up the console, and type the following:</p> 
<pre class="screen" id="drange">d3.range(10)</pre> 
<p id="you_should_see__id2">You should see the following output array:</p> 
<pre class="screen" id="____id2">[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</pre> 
<p id="how_nice_is_tha">How nice is that? D3 saves you time once again (and the hassle of extra <code class="literal">for()</code> loops).</p> 
<p id="coming_back_to_">Coming back to our code, it should now be clear what’s happening here:</p> 
<pre class="programlisting" data-language="javascript" id="domaindrang_id2"><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">))</code></pre> 
<div class="orderedlist" id="datasetlength_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> <code class="literal">dataset.length</code>, in this case, is evaluted as <code class="literal">20</code>, because we have 20 items in our dataset. </li> 
<li class="listitem"> <code class="literal">d3.range(20)</code> is then evaluated, which returns this array: <code class="literal">[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]</code>. </li> 
<li class="listitem"> Finally, <code class="literal">domain()</code> sets the domain of our new ordinal scale to those values. </li> </ol></div> 
<p id="this_might_be_s">This might be somewhat confusing because we are using numbers (0, 1, 2…) as ordinal values, but ordinal values are typically nonnumeric.</p> </div> 
<div class="sect2" id="_round_bands_are_all_the_range_these_days"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Round Bands Are All the Range These Days</h3></div></div></div> 
<p id="the_great_thing">The great thing about <code class="literal">d3.scale.ordinal()</code> is it supports 
<span class="emphasis">
<em>range banding</em></span>. Instead of returning a continuous range, as any quantitative scale (like <code class="literal">d3.scale.linear()</code>) would, ordinal scales use 
<span class="emphasis">
<em>discrete</em></span> ranges, meaning the output values are determined in advance, and could be numeric or not.

<a id="id531496" class="indexterm"></a>

<a id="id531502" class="indexterm"></a>

<a id="id531507" class="indexterm"></a></p> 
<p id="we_could_use_ra">We could use <code class="literal">range()</code> like everyone else, 
<span class="emphasis">
<em>or</em></span> we can be smooth and use <code class="literal">rangeBands()</code>, which takes a low and high value, and automatically divides it into even chunks or “bands,” based on the length of the domain. For example:</p> 
<pre class="programlisting" data-language="javascript" id="rangebands_id1"><code class="p">.</code><code class="nx">rangeBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">])</code></pre> 
<p id="this_says_calc">this says “calculate even bands starting at 0 and ending at <code class="literal">w</code>, then set this scale’s range to those bands.” In our case, we specified 20 values in the domain, so D3 will calculate:</p> 
<pre class="screen" id="w____xscal">(w - 0) / xScale.domain().length (600 - 0) / 20 600 / 20 30</pre> 
<p id="in_the_end_eac">In the end, each band will be <code class="literal">30</code> “wide.”</p> 
<p id="it_is_also_poss">It is also possible to include a second parameter, which includes a bit of spacing between each band. Here, I’ve used <code class="literal">0.2</code>, meaning that 20 percent of the width of each band will be used for spacing in between bands:</p> 
<pre class="programlisting" data-language="javascript" id="rangebands_id2"><code class="p">.</code><code class="nx">rangeBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">],</code> <code class="mf">0.2</code><code class="p">)</code></pre> 
<p id="we_can_be_even_">We can be even smoother and use <code class="literal">rangeRoundBands()</code>, which is the same as <code class="literal">rangeBands()</code>, except that the output values are rounded to the nearest whole pixel, so 12.3456 becomes just 12, for example. This is helpful for keeping visual elements lined up precisely on the pixel grid, for clean, sharp edges.

<a id="id531695" class="indexterm"></a>

<a id="id531703" class="indexterm"></a>

<a id="id531709" class="indexterm"></a></p> 
<p id="ill_also_decre">I’ll also decrease the amount of spacing to just 5 percent.  So, our final line of code in that statement is:</p> 
<pre class="programlisting" data-language="javascript" id="rangeroundband"><code class="p">.</code><code class="nx">rangeRoundBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">],</code> <code class="mf">0.05</code><code class="p">);</code></pre> 
<p id="this_gives_us_n">This gives us nice, clean pixel values, with a teensy bit of visual space between them.</p> </div> 
<div class="sect2" id="_referencing_the_ordinal_scale"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Referencing the Ordinal Scale</h3></div></div></div> 
<p id="later_in_the_co">Later in the code (and I recommend viewing the source), when we create

<a id="id531795" class="indexterm"></a> the <code class="literal">rect</code> elements, we set their horizontal, x-axis positions like so:</p> 
<pre class="programlisting" data-language="javascript" id="create_bars_s_id1"><code class="c1">//Create bars</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>       <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>         <code class="c1">// &lt;-- Set x values</code>    <code class="p">})</code>            <code class="err">…</code></pre> 
<p id="note_that_beca">Note that, because we include <code class="literal">d</code> and <code class="literal">i</code> as parameters to the anonymous function, D3 will automatically pass in the correct values. Of course, <code class="literal">d</code> is the current datum, and <code class="literal">i</code> is its index value. So <code class="literal">i</code> will be passed 0, 1, 2, 3, and so on.</p> 
<p id="coincidentally_">Coincidentally (hmmm!), we used those same values (0, 1, 2, 3…) for our ordinal scale’s input domain. So when we call <code class="literal">xScale(i)</code>, <code class="literal">xScale()</code> will look up the ordinal value <code class="literal">i</code> and return its associated output (band) value. (You can verify all this for yourself in the console. Just try typing <code class="literal">xScale(0)</code> or <code class="literal">xScale(5)</code>.)</p> 
<div class="sidebar online_only" id="ch09-interactive-0point5"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_entering_th_id3">Try entering the following <code class="literal">xScale</code> statements in the console below to see the results:</p> 
<div class="itemizedlist" id="xscale_xscal">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">xScale(0)</code> </li> 
<li class="listitem"> <code class="literal">xScale(5)</code> </li> </ul></div> 
<div class="interactive">

<p id="even_better_se">Even better, setting the widths of these bars just got a lot easier. Before using the ordinal scale, we had:</p> 
<pre class="programlisting" data-language="javascript" id="attrwidth__id2"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">)</code></pre> 
<p id="we_dont_even_n">We don’t even need <code class="literal">barPadding</code> anymore because now the padding is built into 
<span class="keep-together"><code class="literal">rangeRoundBands()</code></span>. Setting the width of each <code class="literal">rect</code> needs only

<a id="id532238" class="indexterm"></a>

<a id="id532244" class="indexterm"></a> this:</p> 
<pre class="programlisting" data-language="javascript" id="attrwidth__id3">        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code></pre> 
<p id="isnt_it_nice_w">Isn’t it nice when D3 does the math for you?</p> </div> 
<div class="sect2" id="_other_updates"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Other Updates</h3></div></div></div> 
<p id="ive_made_sever">I’ve made several other updates in 
<span class="emphasis">
<em>02_bar_chart_with_scales.html</em></span>, including creating a new linear scale <code class="literal">yScale</code> to calculate vertical values. You already know how to use linear scales, so you can skim the source and note how that’s being used to set the bar heights.

<a id="id532334" class="indexterm"></a></p> </div> </div> 
<div class="sect1" data-original-filename="9_updates_transitions_and_motion.asciidoc" id="_updating_data"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Updating Data</h2></div></div></div> 
<p id="okay_once_agai">Okay, once again, we have the amazing bar chart shown in 

<a class="xref" href="#The_bar_chart" title="Figure 9-3. The bar chart">Figure 9-3</a>, flexible enough to handle any data we can throw at it.

<a id="id532367" class="indexterm"></a></p> 
<div class="figure" id="The_bar_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0903.png" alt="The bar chart"></div></div> 
<div class="figure-title">Figure 9-3. The bar chart</div> </div> 
<p id="or_is_it_lets">Or is it? Let’s see.</p> 
<p id="the_simplest_ki">The simplest kind of update is when all data values are updated at the same time 
<span class="emphasis">
<em>and</em></span> the number of values stays the same.</p> 
<p id="the_basic_appro">The basic approach in this scenario is this:</p> 
<div class="orderedlist" id="modify_the_valu_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Modify the values in your dataset. </li> 
<li class="listitem"> Rebind the new values to the existing elements (thereby overwriting the original values). </li> 
<li class="listitem"> Set new attribute values as needed to update the visual display. </li> </ol></div> 
<p id="before_any_of_t">Before any of those steps can happen, though, some 
<span class="emphasis">
<em>event</em></span> needs to kick things off. So far, all of our code has executed immediately on page load. We 
<span class="emphasis">
<em>could</em></span> have our update run right after the initial drawing code, but it would happen imperceptibly fast. To make sure we can observe the change as it happens, we will separate our update code from everything else. We will need a “trigger,” something that happens 
<span class="emphasis">
<em>after</em></span> page load to apply the updates. How about a mouse click?</p> 
<div class="sect2" id="_interaction_via_event_listeners"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Interaction via Event Listeners</h3></div></div></div> 
<p id="any_dom_element">Any DOM element can be used, so rather than design a fancy button, I’ll

<a id="id532487" class="indexterm"></a>

<a id="id532495" class="indexterm"></a> add a simple <code class="literal">p</code> paragraph to the HTML’s <code class="literal">body</code>:</p> 
<pre class="programlisting" data-language="html" id="pclick_on_thi_id1"><code class="nt">&lt;p&gt;</code>Click on this text to update the chart with new data values (once).<code class="nt">&lt;/p&gt;</code></pre> 
<p id="then_down_at_t">Then, down at the end of our D3 code, let’s add the following:</p> 
<pre class="programlisting" data-language="javascript" id="dselectp__id1"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something  on click</code>     <code class="p">});</code></pre> 
<p id="this_selects_ou">This selects our new <code class="literal">p</code>, and then adds an 
<span class="emphasis">
<em>event listener</em></span> to that element. Huh?</p> 
<p id="in_javascript__id2">In JavaScript, events are happening all the time. Not exciting events, like huge parties, but really insignificant events like <code class="literal">mouseover</code> and <code class="literal">click</code>. Most of the time, these insignificant events go ignored (just as in life, perhaps). But if someone is 
<span class="emphasis">
<em>listening</em></span>, then the event will be 
<span class="emphasis">
<em>heard</em></span>, and can go down in posterity, or at least trigger some sort of DOM interaction. (Rough JavaScript parallel of classic koan: if an event occurs, and no listener hears it, did it ever happen at all?)

<a id="id532667" class="indexterm"></a>

<a id="id532676" class="indexterm"></a></p> 
<p id="an_event_listen">An event 
<span class="emphasis">
<em>listener</em></span> is an anonymous function that 
<span class="emphasis">
<em>listens</em></span> for a

<a id="id532698" class="indexterm"></a>

<a id="id532703" class="indexterm"></a>

<a id="id532711" class="indexterm"></a> specific event 
<span class="emphasis">
<em>on</em></span> a specific element or elements. D3’s method <code class="literal">selection.on()</code> provides a nice shorthand for adding event listeners. As you can see, <code class="literal">on()</code> takes two arguments: the event 
<span class="emphasis">
<em>type</em></span> (<code class="literal">"click"</code>) and the listener itself (the anonymous function).

<a id="id532748" class="indexterm"></a></p> 
<p id="in_this_case_t_id1">In this case, the listener listens for a <code class="literal">click</code> event occurring on our

<a id="id532766" class="indexterm"></a> selection <code class="literal">p</code>. When that happens, the listener function is executed. You can put whatever code you want in between the brackets of the anonymous function:</p> 
<pre class="programlisting" data-language="javascript" id="dselectp__id2"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something mundane and annoying on click</code>         <code class="nx">alert</code><code class="p">(</code><code class="s2">"Hey, don't click that!"</code><code class="p">);</code>     <code class="p">});</code></pre> 
<p id="well_talk_a_lo">We’ll talk a lot more about interactivity in 

<a class="xref" href="" title="Chapter 10. Interactivity">Chapter 10</a>.</p> </div> 
<div class="sect2" id="_changing_the_data"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Changing the Data</h3></div></div></div> 
<p id="instead_of_gene">Instead of generating annoying pop-ups, I’d rather simply update

<a id="id532906" class="indexterm"></a> <code class="literal">dataset</code> by overwriting its original values. This is step 1, from earlier:</p> 
<pre class="programlisting" data-language="javascript" id="dataset___"><code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code>             <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code> <code class="p">];</code></pre> 
<p id="step__is_to_re">Step 2 is to rebind the new values to the existing elements. We can do that by selecting those <code class="literal">rect</code>s and simply calling <code class="literal">data()</code> one more time:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id7"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code>     <code class="c1">//New data successfully bound, sir!</code></pre> </div> 
<div class="sect2" id="_updating_the_visuals"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Updating the Visuals</h3></div></div></div> 
<p id="finally_step_">Finally, step 3 is to update the visual attributes, referencing the (now-updated) data values. This is super easy, as we simply copy and paste the relevant code that we’ve already written. In this case, the <code class="literal">rect</code>s can maintain their horizontal positions and widths; all we really need to update are their <code class="literal">height</code>s and <code class="literal">y</code> positions. I’ve added those lines here:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id8"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">});</code></pre> 
<p id="notice_this_loo">Notice this looks almost exactly like the code that generates the <code class="literal">rect</code>s initially, only without <code class="literal">enter()</code> and <code class="literal">append()</code>.</p> 
<p id="putting_it_all__id2">Putting it all together, here is all of our update code in one place:</p> 
<pre class="programlisting" data-language="javascript" id="on_click_upd"><code class="c1">//On click, update with new data</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>          <code class="c1">//New values for dataset</code>         <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code>                     <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code> <code class="p">];</code>          <code class="c1">//Update all rects</code>         <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>            <code class="p">});</code>      <code class="p">});</code></pre> 
<p id="check_out_the_r">Check out the revised bar chart in 
<span class="emphasis">
<em>03_updates_all_data.html</em></span>. It looks like 

<a class="xref" href="#Updateable_bar_chart" title="Figure 9-4. Updatable bar chart">Figure 9-4</a> to start.</p> 
<div class="figure" id="Updateable_bar_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0904.png" alt="Updatable bar chart"></div></div> 
<div class="figure-title">Figure 9-4. Updatable bar chart</div> </div> 
<p id="then_click_anyw">Then click anywhere on the paragraph, and it turns into 

<a class="xref" href="#Bar_chart_data_updated" title="Figure 9-5. Bar chart, data updated">Figure 9-5</a>.</p> 
<div class="figure" id="Bar_chart_data_updated"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0905.png" alt="Bar chart, data updated"></div></div> 
<div class="figure-title">Figure 9-5. Bar chart, data updated</div> </div> 
<p id="good_news_the_">Good news: the values in <code class="literal">dataset</code> were modified, rebound, and used to adjust the <code class="literal">rect</code>s. Bad news: it looks weird because we forgot to update the labels, and also the bar colors. Good news (because I always like to end with good news): this is easy to fix.</p> 
<p id="to_ensure_the_c">To ensure the colors change on update, we just copy and paste in the

<a id="id534088" class="indexterm"></a> line where we set the <code class="literal">fill</code>:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id9"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>   <code class="c1">// &lt;-- Down here!</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>    <code class="p">});</code></pre> 
<p id="to_update_the_l">To update the labels, we use a similar pattern, only here we adjust

<a id="id534436" class="indexterm"></a>

<a id="id534444" class="indexterm"></a> their text content and x/y values:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id10"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code>    <code class="p">});</code></pre> 
<p id="take_a_look_at_">Take a look at 
<span class="emphasis">
<em>04_updates_all_data_fixed.html</em></span>. You’ll notice it looks the same to start, but click the trigger and now the bar colors and labels update correctly, as shown in 

<a class="xref" href="#Updated_chart_with_correct_colors_and_labels" title="Figure 9-6. Updated chart with correct colors and labels">Figure 9-6</a>.</p> 
<div class="figure" id="Updated_chart_with_correct_colors_and_labels"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0906.png" alt="Updated chart with correct colors and labels"></div></div> 
<div class="figure-title">Figure 9-6. Updated chart with correct colors and labels</div> </div> 
<div class="sidebar online_only" id="interactive_9-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/04_updates_all_data_fixed.html" target="_blank">04_updates_all_data_fixed</a></p> 

<div class="sect1" data-original-filename="9_updates_transitions_and_motion.asciidoc" id="_transitions"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Transitions</h2></div></div></div> 
<p id="life_transition">Life transitions can be scary: the first day of school, moving to a new city, quitting your day job to do freelance data visualization full-time. But D3 transitions are fun, beautiful, and not at all emotionally taxing.

<a id="ix_trans" class="indexterm"></a></p> 
<p id="making_a_nice_">Making a nice, super smooth, animated transition is as simple as adding

<a id="id534879" class="indexterm"></a> one line of code:</p> 
<pre class="programlisting" data-language="javascript" id="transition_id1"><code class="p">.</code><code class="nx">transition</code><code class="p">()</code></pre> 
<p id="specifically_a">Specifically, add this link in the chain below where your selection is made, and 
<span class="emphasis">
<em>above</em></span> where any attribute changes are applied:</p> 
<pre class="programlisting" data-language="javascript" id="update_all_re_id1"><code class="c1">//Update all rects</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="c1">// &lt;-- This is new! Everything else here is unchanged.</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>    <code class="p">});</code></pre> 
<p id="now_run_the_cod">Now run the code in 
<span class="emphasis">
<em>05_transition.html</em></span>, and click the text to see the transition in action. Note that the end result looks the same visually, but the transition from the chart’s initial state to its end state is much, much nicer.</p> 
<div class="sidebar online_only" id="interactive_9-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/05_transition.html" target="_blank">05_transition</a></p> 

<p id="isnt_that_insa">Isn’t that 
<span class="emphasis">
<em>insane</em></span>? I’m not a psychologist, but I believe it is literally insane that we can add a single line of code, and D3 will 
<span class="emphasis">
<em>animate</em></span> our value changes for us over time.

<a id="id535314" class="indexterm"></a>

<a id="id535319" class="indexterm"></a></p> 
<p id="without_transit">Without <code class="literal">transition()</code>, D3 evaluates every <code class="literal">attr()</code> statement immediately, so the changes in height and fill happen right away. When you add <code class="literal">transition()</code>, D3 introduces the element of time. Rather than applying new values all at once, D3 
<span class="emphasis">
<em>interpolates</em></span> between the old values and the new values, meaning it normalizes the beginning and ending values, and calculates all their in-between states. D3 is also smart enough to recognize and interpolate between different attribute value formats. For example, if you specified a height of <code class="literal">200px</code> to start but transition to just <code class="literal">100</code> (without the <code class="literal">px</code>). Or if a <code class="literal">blue</code> fill turns <code class="literal">rgb(0,255,0)</code>. You don’t need to fret about being consistent; D3 takes care of it.</p> 
<p id="do_you_believe_">Do you believe me yet? This is really insane. And super helpful.</p> 
<div class="sect2" id="_duration_or_how_long_is_this_going_to_take"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">duration(), or How Long Is This Going to Take?</h3></div></div></div> 
<p id="so_the_attr_v">So the <code class="literal">attr()</code> values are interpolated over time, but how 
<span class="emphasis">
<em>much</em></span> time? It turns out the default is 250 milliseconds, or one-quarter second (1,000 milliseconds = 1 second). That’s why the transition in 
<span class="emphasis">
<em>05_transition.html</em></span> is so fast.

<a id="id535425" class="indexterm"></a></p> 
<p id="fortunately_yo_id3">Fortunately, you can control how much time is spent on any transition by—again, I kid you not—adding a single line of code:</p> 
<pre class="programlisting" data-language="javascript" id="duration"><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code></pre> 
<p id="the_duration_">The <code class="literal">duration()</code> must be specified 
<span class="emphasis">
<em>after</em></span> the <code class="literal">transition()</code>, and durations are always specified in milliseconds, so <code class="literal">duration(1000)</code> is a one-second duration.</p> 
<p id="here_is_that_li">Here is that line in context:</p> 
<pre class="programlisting" data-language="javascript" id="update_all_re_id2"><code class="c1">//Update all rects</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>  <code class="c1">// &lt;-- Now this is new!</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>    <code class="p">});</code></pre> 
<p id="open_up__dura">Open up 
<span class="emphasis">
<em>06_duration.html</em></span> and see the difference. Now make a copy of that file, and try plugging in some different numbers to slow or speed the transition. For example, try <code class="literal">3000</code> for a three-second transition, or <code class="literal">100</code> for one-tenth of a second.</p> 
<p id="the_actual_dura">The actual durations you choose will depend on the context of your design and what triggers the transition. In practice, I find that transitions of around 150 ms are useful for providing minor interface feedback (such as hovering over elements), and about 1,000 ms is ideal for many more significant visual transitions, such as switching from one view of the data to another. 1,000 ms (one second) is not too long, not too short.</p> 
<p id="in_case_youre__id2">In case you’re feeling lazy, I made 
<span class="emphasis">
<em>07_duration_slow.html</em></span>, which uses <code class="literal">5000</code> for a five-second transition.</p> 
<p id="with_such_a_slo">With such a slow transition, it becomes obvious that the value labels are not transitioning smoothly along with the bar heights. As you now know, we can correct that oversight by adding only two new lines of code, this time in the section where we update the labels:</p> 
<pre class="programlisting" data-language="javascript" id="update_all_la"><code class="c1">//Update all labels</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>        <code class="c1">// &lt;-- This is new,</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">5000</code><code class="p">)</code>      <code class="c1">//     and so is this.</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code>    <code class="p">});</code></pre> 
<p id="much_better_no">Much better! Note in 
<span class="emphasis">
<em>08_duration_slow_labels_fixed.html</em></span> how the labels now animate smoothly along with the bars.</p> 
<div class="sidebar online_only" id="interactive_9-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/08_duration_slow_labels_fixed.html" target="_blank">08_duration_slow_labels_fixed</a></p> 

<div class="sect2" id="_ease_y_does_it"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">ease()-y Does It</h3></div></div></div> 
<p id="with_a_ms">With a 5,000-ms, slow-as-molasses transition, we can also perceive the 
<span class="emphasis">
<em>quality</em></span> of motion. In this case, notice how the animation begins very slowly, then accelerates, then slows down again as the bars reach their destination heights. That is, the rate of motion is not 
<span class="emphasis">
<em>linear</em></span>, but 
<span class="emphasis">
<em>variable</em></span>.

<a id="id536370" class="indexterm"></a>

<a id="id536378" class="indexterm"></a></p> 
<p id="the_quality_of_">The quality of motion used for a transition is called 
<span class="emphasis">
<em>easing</em></span>. In animation terms, we think about elements 
<span class="emphasis">
<em>easing</em></span> into place, moving from here to there.</p> 
<p id="with_d_you_ca">With D3, you can specify different kinds of easing by using <code class="literal">ease()</code>. The default easing is <code class="literal">"cubic-in-out"</code>, which produces the gradual acceleration and deceleration we see in our chart. It’s a good default because you generally can’t go wrong with a nice, smooth transition.</p> 
<p id="contrast_that_s">Contrast that smoothness to 
<span class="emphasis">
<em>09_ease_linear.html</em></span>, which uses <code class="literal">ease("linear")</code> to specify a linear easing function. Notice how the rate of motion is constant. That is, there is no gradual acceleration and deceleration—the elements simply begin moving at an even pace, and then they stop abruptly. (Also, I lowered the duration to 2,000 ms.)</p> 
<p id="ease_must_als"><code class="literal">ease()</code> must also be specified after <code class="literal">transition()</code>, but before the <code class="literal">attr()</code> statements to which the transition applies. <code class="literal">ease()</code> can come before or after <code class="literal">duration()</code>, but this sequence makes the most sense to me:</p> 
<pre class="programlisting" data-language="javascript" id="selection_s"><code class="err">…</code>   <code class="c1">//Selection statement(s)</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code> <code class="p">.</code><code class="nx">ease</code><code class="p">(</code><code class="s2">"linear"</code><code class="p">)</code> <code class="err">…</code>   <code class="c1">//attr() statements</code></pre> 
<p id="fortunately_th_id1">Fortunately, there are several other built-in easing functions to choose from. Some of my favorites are:</p> 
<div class="variablelist" id="circle_gradual_">
<dl class="variablelist"> 
<dt>
<span class="term"> <code class="literal">circle</code> </span></dt> 
<dd> Gradual ease in and acceleration until elements snap into place. </dd> 
<dt>
<span class="term"> <code class="literal">elastic</code> </span></dt> 
<dd> The best way to describe this one is “sproingy.” </dd> 
<dt>
<span class="term"> <code class="literal">bounce</code> </span></dt> 
<dd> Like a ball bouncing, then coming to rest. </dd> </dl></div> 
<p id="sample_code_fil">Sample code files 
<span class="emphasis">
<em>10_ease_circle.html</em></span>, 
<span class="emphasis">
<em>11_ease_elastic.html</em></span>, and 
<span class="emphasis">
<em>12_ease_bounce.html</em></span> illustrate these three functions. The complete list of easing functions is on 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_ease" target="_top">the D3 wiki</a>.</p> 
<div class="sidebar online_only" id="interactive_9-4"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive">

<p id="wow_i_already_">Wow, I already regret telling you about <code class="literal">bounce</code>. Please use <code class="literal">bounce</code> only if you are making a satirical infographic that is mocking other bad graphics. Perceptually, I don’t think there is a real case to be used for <code class="literal">bounce</code> easing in visualization. <code class="literal">cubic-in-out</code> is the default for a reason.</p> </div> 
<div class="sect2" id="_please_do_not_delay"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Please Do Not delay()</h3></div></div></div> 
<p id="whereas_ease_">Whereas <code class="literal">ease()</code> controls the quality of motion, <code class="literal">delay()</code> specifies when the transition begins.

<a id="id536724" class="indexterm"></a></p> 
<p id="delay_can_be_"><code class="literal">delay()</code> can be given a static value, also in milliseconds, as in:</p> 
<pre class="programlisting" data-language="javascript" id="transition_id2"><code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>     <code class="c1">//1,000 ms or 1 second</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code>  <code class="c1">//2,000 ms or 2 seconds</code> <code class="err">…</code></pre> 
<p id="as_with_duratio">As with <code class="literal">duration()</code> and <code class="literal">ease()</code>, the order here is somewhat flexible, but I like to include <code class="literal">delay()</code> before <code class="literal">duration()</code>. That makes more sense to me because the delay happens first, followed by the transition itself.</p> 
<p id="see__delay_st">See 
<span class="emphasis">
<em>13_delay_static.html</em></span>, in which clicking the text triggers first a 1,000-ms delay (in which nothing happens), followed by a 2,000-ms transition.</p> 
<p id="static_delays_c">Static delays can be useful, but more exciting are delay values that we calculate dynamically. A common use of this is to generate staggered delays, so some elements transition before others. Staggered delays can assist with perception, as it’s easier for our eyes to follow an individual element’s motion when it is slightly out of sync with its neighboring elements’ motion.

<a id="id536886" class="indexterm"></a>

<a id="id536891" class="indexterm"></a></p> 
<p id="to_do_this_ins">To do this, instead of giving <code class="literal">delay()</code> a static value, we give it a function, in typical D3 fashion:</p> 
<pre class="programlisting" data-language="javascript" id="transition_id3"><code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="mi">100</code><code class="p">;</code> <code class="p">})</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code> <code class="err">…</code></pre> 
<p id="just_as_weve_s">Just as we’ve seen with other D3 methods, when given an anonymous function, the datum bound to the current element is passed into <code class="literal">d</code>, and the index position of that element is passed into <code class="literal">i</code>. So, in this case, as D3 loops through each element, the delay for each element is set to <code class="literal">i * 100</code>, meaning each subsequent element will be delayed 100 ms 
<span class="emphasis">
<em>more</em></span> than the preceding element.</p> 
<p id="all_this_is_to__id2">All this is to say that we now have staggered transitions. Check out the beautifully animated bars in 
<span class="emphasis">
<em>14_delay_dynamic.html</em></span> and see for yourself.</p> 
<p id="note_that_i_als">Note that I also decreased the duration to 500 ms to make it feel a bit snappier. Also note that <code class="literal">duration()</code> sets the duration for each 
<span class="emphasis">
<em>individual transition</em></span>, not for all transitions in aggregate. So, for example, if 20 elements have 500-ms transitions applied with no delay, then it will all be over in 500 ms, or one-half second. But if a 100-ms delay is applied to each subsequent element (<code class="literal">i * 100</code>), then the total running time of all transitions will be 2,400 ms:</p> 
<pre class="screen" id="max_value_of_i_">Max value of i times 100ms delay plus 500ms duration = 19 * 100 + 500 = 2400</pre> 
<p id="because_these_d">Because these delays are being calculated on a per-element basis, if you added more data, then the total running time of all transitions will increase. This is something to keep in mind if you have a dynamically loaded dataset with a variable array length. If you suddenly loaded 10,000 data points instead of 20, you could spend a long time watching those bars wiggle around (1,000,400 ms or 16.67 minutes to be precise). Suddenly, they’re not so cute anymore.</p> 
<p id="fortunately_we_id3">Fortunately, we can 
<span class="emphasis">
<em>scale</em></span> our delay values dynamically to the length of the dataset. This isn’t fancy D3 stuff; it’s just math.</p> 
<p id="see__delay_dy">See 
<span class="emphasis">
<em>15_delay_dynamic_scaled.html</em></span>, in which 30 values are included in the dataset. If you get out your stopwatch, you’ll see that the total transition time is 1.5 seconds, or around 1,500 ms.</p> 
<p id="now_see__dela">Now see 
<span class="emphasis">
<em>16_delay_dynamic_scaled_fewer.html</em></span>, which uses exactly the same transition code, but with only 10 data points. Notice how the delays are slightly longer (well, 200 percent longer), so the total transition time is the same: 1.5 seconds! How is this possible?</p> 
<div class="sidebar online_only" id="interactive_9-5"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive">

<pre class="programlisting" data-language="javascript" id="transition_id4"><code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">;</code>   <code class="c1">// &lt;-- Where the magic happens</code> <code class="p">})</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code> <code class="err">…</code></pre> 
<p id="the_two_precedi">The two preceding sample pages use the same delay calculations here. Instead of multiplying <code class="literal">i</code> by some static amount, we first divide <code class="literal">i</code> by <code class="literal">dataset.length</code>, in effect normalizing the value. Then, that normalized value is multiplied by <code class="literal">1000</code>, or 1 second. The result is that the maximum amount of delay for the last element will be <code class="literal">1000</code>, and all prior elements will be delayed by some amount less than that. A max delay of <code class="literal">1000</code> plus a duration of <code class="literal">500</code> equals 1.5 seconds total transition time.</p> 
<p id="this_approach_t">This approach to delays is great because it keeps our code 
<span class="emphasis">
<em>scalable</em></span>. The total duration will be tolerable whether we have only 10 data points or 10,000.</p> </div> 
<div class="sect2" id="_randomizing_the_data"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Randomizing the Data</h3></div></div></div> 
<p id="just_to_illustr">Just to illustrate how cool this is, let’s repurpose our random number generating code from 

<a class="xref" href="" title="Chapter 5. Data">Chapter 5</a> here, so we can update the chart as many times as we want, with new data each time.

<a id="id537421" class="indexterm"></a></p> 
<p id="down_in_our_cli">Down in our click-update function, let’s replace the static <code class="literal">dataset</code> with a randomly generated one:</p> 
<pre class="programlisting" data-language="javascript" id="new_values_fo"><code class="c1">//New values for dataset</code> <code class="kd">var</code> <code class="nx">numValues</code> <code class="o">=</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>               <code class="c1">//Count original length of dataset</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[];</code>                                       <code class="c1">//Initialize empty array</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numValues</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>               <code class="c1">//Loop numValues times</code>     <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">25</code><code class="p">);</code> <code class="c1">//New random integer (0-24)</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">newNumber</code><code class="p">);</code>                        <code class="c1">//Add new number to array</code> <code class="p">}</code></pre> 
<p id="this_will_overw">This will overwrite <code class="literal">dataset</code> with an array of random integers with values between 0 and 24. The new array will be the same length as the original array.</p> 
<p id="then_ill_upda">Then, I’ll update the paragraph text:</p> 
<pre class="programlisting" data-language="html" id="pclick_on_thi_id2"><code class="nt">&lt;p&gt;</code>Click on this text to update the chart with new data values as many times as you like!<code class="nt">&lt;/p&gt;</code></pre> 
<p id="now_open_up__">Now open up 
<span class="emphasis">
<em>17_randomized_data.html</em></span>, and you should see something like 

<a class="xref" href="#Initial_view" title="Figure 9-7. Initial view">Figure 9-7</a>.</p> 
<div class="figure" id="Initial_view"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0907.png" alt="Initial view"></div></div> 
<div class="figure-title">Figure 9-7. Initial view</div> </div> 
<p id="every_time_you_">Every time you click the paragraph at top, the code will do the following:</p> 
<div class="orderedlist" id="generate_new_r_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Generate new, random values. </li> 
<li class="listitem"> Bind those values to the existing elements. </li> 
<li class="listitem"> Transition elements to new positions, heights, and colors, using the new values (see 

<a class="xref" href="#Random_data_applied" title="Figure 9-8. Random data applied">Figure 9-8</a>). </li> </ol></div> 
<div class="figure" id="Random_data_applied"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0908.png" alt="Random data applied"></div></div> 
<div class="figure-title">Figure 9-8. Random data applied</div> </div> 
<div class="sidebar online_only" id="interactive_9-6"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/17_randomized_data.html" target="_blank">17_randomized_data</a></p> 

<p id="pretty_cool_if">Pretty cool! If this does not feel pretty cool or even a little cool to you, please turn off your computer and go for a short walk to clear your head, thereby making room for all the coolness to come. If, however, you are sufficiently cooled by this knowledge, read on.</p> </div> 
<div class="sect2" id="_updating_scales"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Updating Scales</h3></div></div></div> 
<p id="astute_readers_">Astute readers might take issue with this line from 

<a id="id537882" class="indexterm"></a>earlier:</p> 
<pre class="programlisting" data-language="javascript" id="var_newnumber__id3"><code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">25</code><code class="p">);</code></pre> 
<p id="why__in_prog">Why 25? In programming, this is referred to as a 
<span class="emphasis">
<em>magic number</em></span>. I

<a id="id537975" class="indexterm"></a>

<a id="id537980" class="indexterm"></a> know, it sounds fun, but the problem with magic numbers is that it’s difficult to tell why they exist (hence, the “magic”). Instead of <code class="literal">25</code>, something like <code class="literal">maxValue</code> would be more meaningful:</p> 
<pre class="programlisting" data-language="javascript" id="var_newnumber__id4"><code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">maxValue</code><code class="p">);</code></pre> 
<p id="ah_see_now_th">Ah, see, now the magic is gone, and I can remember that <code class="literal">25</code> was acting as the 
<span class="emphasis">
<em>maximum value</em></span> that could be calculated and put into <code class="literal">newNumber</code>. As a general rule, it’s best to avoid magic numbers, and instead store those numbers inside variables with meaningful names, like <code class="literal">maxValue</code> or <code class="literal">numberOfTimesWatchedTheMovieTopSecret</code>.</p> 
<p id="more_important_id1">More important, I now remember that I arbitrarily chose <code class="literal">25</code> because values larger than that exceeded the range of our chart’s scale, so those bars were cut off. For example, in 

<a class="xref" href="#Tootallwrongnumber" title="Figure 9-9. Too tall! We used the wrong magic number!">Figure 9-9</a>, I replaced <code class="literal">25</code> with <code class="literal">50</code>.</p> 
<div class="figure" id="Tootallwrongnumber"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0909.png" alt="Too tall! We used the wrong magic number!"></div></div> 
<div class="figure-title">Figure 9-9. Too tall! We used the wrong magic number!</div> </div> 
<p id="the_real_proble">The real problem is not that I chose the 
<span class="emphasis">
<em>wrong</em></span> magic number; it’s that our 
<span class="emphasis">
<em>scale</em></span> needs to be updated whenever the dataset is updated. Whenever we plug in new data values, we should also recalibrate our scale to ensure that bars don’t get too tall or too short.</p> 
<p id="updating_a_scal">Updating a scale is easy. You’ll recall we created <code class="literal">yScale</code> with this code:</p> 
<pre class="programlisting" data-language="javascript" id="var_yscale__d_id2"><code class="kd">var</code> <code class="nx">yScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)])</code>                 <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code></pre> 
<p id="the_range_can_s">The 
<span class="emphasis">
<em>range</em></span> can stay the same (as the visual size of our chart isn’t changing), but after the new dataset has been generated, we should update the scale’s 
<span class="emphasis">
<em>domain</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="update_scale_"><code class="c1">//Update scale domain</code> <code class="nx">yScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)]);</code></pre> 
<p id="this_sets_the_u">This sets the upper end of the input domain to the largest data value in <code class="literal">dataset</code>. Later, when we update all the bars and labels, we already reference <code class="literal">yScale</code> to calculate their positions, so no other code changes are necessary.</p> 
<p id="check_it_out_in_id1">Check it out in 
<span class="emphasis">
<em>18_dynamic_scale.html</em></span>. I went ahead and replaced our magic number <code class="literal">25</code> with <code class="literal">maxValue</code>, which I set here to <code class="literal">100</code>. So now when we click to update, we get random numbers between 0 and 100. If the 
<span class="emphasis">
<em>maximum</em></span> value in the dataset is 100, then <code class="literal">yScale</code>’s domain will go up to 100, as we see in 

<a class="xref" href="#Randomdatabuttheyaxisscaleautomaticallyaccommodates" title="Figure 9-10. Random data, but the y-axis scale automatically accommodates">Figure 9-10</a>.</p> 
<div class="figure" id="Randomdatabuttheyaxisscaleautomaticallyaccommodates"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0910.png" alt="Random data, but the y-axis scale automatically accommodates"></div></div> 
<div class="figure-title">Figure 9-10. Random data, but the y-axis scale automatically accommodates</div> </div> 
<p id="but_because_the">But because the numbers are random, they won’t always reach that maximum value of 100. In 

<a class="xref" href="#Aslightlydifferentscaleduetoslightlydifferentdata" title="Figure 9-11. A slightly different scale, due to slightly different data">Figure 9-11</a>, they top out at 85.</p> 
<div class="figure" id="Aslightlydifferentscaleduetoslightlydifferentdata"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0911.png" alt="A slightly different scale, due to slightly different data"></div></div> 
<div class="figure-title">Figure 9-11. A slightly different scale, due to slightly different data</div> </div> 
<p id="note_that_the_h">Note that the height of the 100 bar in the first chart is 
<span class="emphasis">
<em>the same</em></span> as the height of the 85 bar here. The data is changing; the scale input domain is changing; the output visual range does 
<span class="emphasis">
<em>not</em></span> change.</p> </div> 
<div class="sect2" id="_updating_axes"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Updating Axes</h3></div></div></div> 
<p id="the_bar_chart_d">The bar chart doesn’t have any axes, but our scatterplot from the last

<a id="id538546" class="indexterm"></a>

<a id="id538554" class="indexterm"></a> chapter does (

<a class="xref" href="#Updatedscatterplotnowwithdataupdatesanddynamicscales" title="Figure 9-12. Updated scatterplot, now with data updates and dynamic scales">Figure 9-12</a>). I’ve brought it back, with a few tweaks, in 
<span class="emphasis">
<em>19_axes_static.html</em></span>.</p> 
<div class="figure" id="Updatedscatterplotnowwithdataupdatesanddynamicscales"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0912.png" alt="Updated scatterplot, now with data updates and dynamic scales"></div></div> 
<div class="figure-title">Figure 9-12. Updated scatterplot, now with data updates and dynamic scales</div> </div> 
<p id="to_summarize_th">To summarize the changes to the scatterplot:</p> 
<div class="itemizedlist" id="you_can_now_cli_id1">
<ul class="itemizedlist"> 
<li class="listitem"> You can now click the text at top to generate and update with new data. </li> 
<li class="listitem"> Animated transitions are used after data updates. </li> 
<li class="listitem"> I eliminated the staggered delay, and set all transitions to occur over a full second (1,000 ms). </li> 
<li class="listitem"> Both the x- and y-axis scales are updated, too. </li> 
<li class="listitem"> Circles now have a constant radius. </li> </ul></div> 
<p id="try_clicking_th_id1">Try clicking the text and watch all those little dots zoom around. Cute! I sort of wish they represented some meaningful information, but hey, random data can be fun, too.</p> 
<div class="sidebar online_only" id="interactive_9-7"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/19_axes_static.html" target="_blank">19_axes_static</a></p> 

<p id="whats_not_happ_id1">What’s 
<span class="emphasis">
<em>not</em></span> happening yet is that the axes aren’t updating. Fortunately, that is simple to do.</p> 
<p id="first_i_am_goi">First, I am going to add the class names <code class="literal">x</code> and <code class="literal">y</code> to our x- and y-axes, respectively. This will help us select those axes later:</p> 
<pre class="programlisting" data-language="javascript" id="create_xaxis"><code class="c1">//Create x-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>    <code class="c1">// &lt;-- Note x added here</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>  <code class="c1">//Create y-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>    <code class="c1">// &lt;-- Note y added here</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">padding</code> <code class="o">+</code> <code class="s2">",0)"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code></pre> 
<p id="then_down_in_o">Then, down in our click function, we simply add:</p> 
<pre class="programlisting" data-language="javascript" id="update_xaxis"><code class="c1">//Update x-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".x.axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>  <code class="c1">//Update y-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".y.axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code></pre> 
<p id="for_each_axis_">For each axis, we do the following:</p> 
<div class="orderedlist" id="select_the_axis_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Select the axis. </li> 
<li class="listitem"> Initiate a transition. </li> 
<li class="listitem"> Set the transition’s duration. </li> 
<li class="listitem"> Call the appropriate axis generator. </li> </ol></div> 
<p id="remember_that_e">Remember that each axis generator is already referencing a scale (either <code class="literal">xScale</code> or <code class="literal">yScale</code>). Because those scales are being updated, the axis generators can calculate what the new tick marks should be.</p> 
<p id="open_up__axes">Open up 
<span class="emphasis">
<em>20_axes_dynamic.html</em></span> and give it a try.</p> 
<div class="sidebar online_only" id="interactive_9-8"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/20_axes_dynamic.html" target="_blank">20_axes_dynamic</a></p> 

<p id="once_again_tra">Once again, <code class="literal">transition()</code> handles all the interpolation magic for you—watch those ticks fade in and out. Just beautiful, and you barely had to lift a finger.</p> </div> 
<div class="sect2" id="_each_transition_starts_and_ends"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">each() Transition Starts and Ends</h3></div></div></div> 
<p id="there_will_be_t">There will be times when you want to make something happen at the start or end of a transition. In those times, you can use <code class="literal">each()</code> to execute arbitrary code for each element in the selection.

<a id="id539339" class="indexterm"></a>

<a id="id539345" class="indexterm"></a></p> 
<p id="each_expects_"><code class="literal">each()</code> expects two arguments:</p> 
<div class="itemizedlist" id="either_start__id1">
<ul class="itemizedlist"> 
<li class="listitem"> Either <code class="literal">"start"</code> or <code class="literal">"end"</code> </li> 
<li class="listitem"> An anonymous function, to be executed either at the start of a transition, or as soon as it has ended </li> </ul></div> 
<p id="for_example_he">For example, here is our circle-updating code, with two <code class="literal">each()</code> statements added:</p> 
<pre class="programlisting" data-language="javascript" id="update_all_ci"><code class="c1">//Update all circles</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>    <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>      <code class="c1">// &lt;-- Executes at start of transition</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"end"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>        <code class="c1">// &lt;-- Executes at end of transition</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>    <code class="p">});</code></pre> 
<p id="you_can_see_thi_id1">You can see this in action in 
<span class="emphasis">
<em>21_each.html</em></span>.</p> 
<p id="now_you_click_t">Now you click the trigger, and immediately each circle’s fill is set to magenta, and its radius is set to 3 (see 

<a class="xref" href="#Hotpinkcirclesinmidtransition" title="Figure 9-13. Hot pink circles, midtransition">Figure 9-13</a>). Then the transition is run, per usual. When complete, the fills and radii are restored to their original values.</p> 
<div class="figure" id="Hotpinkcirclesinmidtransition"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0913.png" alt="Hot pink circles, midtransition"></div></div> 
<div class="figure-title">Figure 9-13. Hot pink circles, midtransition</div> </div> 
<p id="something_to_no">Something to note is that within the anonymous function passed to <code class="literal">each()</code>, the context of <code class="literal">this</code> is maintained as “the current element.” This is handy because then <code class="literal">this</code> can be referenced with the function to easily reselect the current element and modify it, as done here:</p> 
<pre class="programlisting" data-language="javascript" id="eachstart__id1">   <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>              <code class="c1">// Selects 'this', the current element</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>   <code class="c1">// Sets fill of 'this' to magenta</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>             <code class="c1">// Sets radius of 'this' to 3</code>    <code class="p">})</code></pre> 
<div class="sect3" id="_warning_start_carefully"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Warning: Start carefully</h4></div></div></div> 
<p id="you_might_be_te">You might be tempted to throw another transition in here,

<a id="id540188" class="indexterm"></a>

<a id="id540196" class="indexterm"></a> resulting in a smooth fade from black to magenta. Don’t do it! Or do it, but note that this will break:</p> 
<pre class="programlisting" data-language="javascript" id="eachstart__id2">   <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>          <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>              <code class="c1">// New transition</code>          <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">250</code><code class="p">)</code>             <code class="c1">// New duration</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>    <code class="p">})</code></pre> 
<p id="if_you_try_this">If you try this, and I recommend that you do, you’ll find that the circles do indeed fade to pink, but they no longer change positions in space. That’s because, by default, only one transition can be active on any given element at any given time. Newer transitions interrupt and override older transitions.</p> 
<p id="this_might_seem">This might seem like a design flaw, but D3 operates this way on purpose. Imagine if you had several different buttons, each of which triggered a different view of the data, and a visitor was clicking through them in rapid succession. Wouldn’t you want an earlier transition to be interrupted, so the last-selected view could be put in place right away?</p> 
<p id="if_youre_famil_id4">If you’re familiar with jQuery, you’ll notice a difference here. By default, jQuery queues transitions, so they execute one after another, and calling a new transition doesn’t automatically interrupt any existing ones. This sometimes results in annoying interface behavior, like menus that fade in when you mouse over them, but won’t start fading out until 
<span class="emphasis">
<em>after</em></span> the fade-in has completed.

<a id="id540433" class="indexterm"></a>

<a id="id540438" class="indexterm"></a></p> 
<p id="in_this_case_t_id2">In this case, the code “breaks” because the first (spatial) transition is begun, then <code class="literal">each("start", …)</code> is called on each element. Within <code class="literal">each()</code>, a second transition is initiated (the fade to pink), overriding the first transition, so the circles never make it to their final destinations (although they look great, just sitting at home).</p> 
<p id="because_of_this">Because of this quirk of transitions, just remember that <code class="literal">each("start", …)</code> should be used only for immediate transformations, with no transitions.

<a id="id540478" class="indexterm"></a></p> </div> 
<div class="sect3" id="_end_gracefully"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">End gracefully</h4></div></div></div> 
<p id="eachend_"><code class="literal">each("end", …)</code>, however, 
<span class="emphasis">
<em>does</em></span> support transitions. By the time <code class="literal">each("end", …)</code> is called, the primary transition has already ended, so initiating a new transition won’t cause any harm.</p> 
<p id="see__each_com">See 
<span class="emphasis">
<em>22_each_combo_transition.html</em></span>. Within the first <code class="literal">each()</code> statement, I bumped the pink circle radius size up to 7. In the second, I added two lines for transition and a duration:</p> 
<pre class="programlisting" data-language="javascript" id="eachend_fu"><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"end"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>     <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>       <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>             <code class="c1">// &lt;-- New!</code>       <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>           <code class="c1">// &lt;-- New!</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code> <code class="p">});</code></pre> 
<p id="watch_that_tran">Watch that transition: so cool! Note the sequence of events:</p> 
<div class="orderedlist" id="you_click_the_p_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> You click the <code class="literal">p</code> text. </li> 
<li class="listitem"> Circles turn pink and increase in size immediately. </li> 
<li class="listitem"> Circles transition to new positions. </li> 
<li class="listitem"> Circles transition to original color and size. </li> </ol></div> 
<p id="also_try_click">Also, try clicking on the <code class="literal">p</code> trigger several times in a row. Go ahead, just go nuts, click as fast as you can. Notice how each click interrupts the circles’ progress. (Sorry, guys!) You’re seeing each new transition request override the old one. The circles will never reach their final positions and fade to black unless you stop clicking and give them time to rest.

<a id="id540790" class="indexterm"></a></p> 
<p id="as_cool_as_that">As cool as that is, there is an even simpler way to schedule multiple transitions to run one after the other: we simply chain transitions together.  (This is a new feature in version 3.0 and won’t work with older versions.)  For example, instead of reselecting elements and calling a new transition on each one within <code class="literal">each("end", …)</code>, we can just tack a second transition onto the end of the chain:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id11"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="c1">// &lt;-- Transition #1</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>    <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>            <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>              <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>              <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">7</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="c1">// &lt;-- Transition #2</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code></pre> 
<p id="try_that_code_o">Try that code out in 
<span class="emphasis">
<em>23_each_combo_transition_chained.html</em></span>, and you’ll see it has the same behavior.</p> 
<div class="sidebar online_only" id="interactive_9-9"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/23_each_combo_transition_chained.html" target="_blank">23_each_combo_transition_chained</a></p> 

<p id="when_sequencing">When sequencing multiple transitions, I recommend this chaining approach.  Then only use <code class="literal">each()</code> for immediate (nontransitioned) changes that need to occur right before or right after transitions.  As you can imagine, it’s possible to create quite complex sequences of discrete and animated changes by chaining together multiple transitions, each of which can have its own calls to <code class="literal">each("start", …)</code> and <code class="literal">each("end", …)</code>.</p> </div> 
<div class="sect3" id="_transitionless_each"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Transitionless each()</h4></div></div></div> 
<p id="you_can_also_us">You can also use <code class="literal">each()</code> outside of a transition, just to execute arbitrary code for each element in a selection. Outside of transitions, just omit the <code class="literal">"start"</code> or <code class="literal">"end"</code> parameter, and only pass in the anonymous function.</p> 
<p id="although_i_didn">Although I didn’t do this here, you can also include references to <code class="literal">d</code> and <code class="literal">i</code> within your function definition, and D3 will hand off those values, as you’d expect:</p> 
<pre class="programlisting" data-language="javascript" id="eachfunctio"><code class="err">…</code> <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Do something with d and i here</code> <code class="p">});</code></pre> </div> 
<div class="sect3" id="_containing_visual_elements_with_clipping_paths"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Containing visual elements with clipping paths</h4></div></div></div> 
<p id="on_a_slightly_r">On a slightly related note, you might have noticed that during these

<a id="id541511" class="indexterm"></a>

<a id="id541516" class="indexterm"></a>

<a id="id541524" class="indexterm"></a> transitions, points with low x or y values would exceed the boundaries of the chart area, and overlap the axis lines, as displayed in 

<a class="xref" href="#Pointsexceedingthechartarea" title="Figure 9-14. Points exceeding the chart area">Figure 9-14</a>.</p> 
<div class="figure" id="Pointsexceedingthechartarea"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0914.png" alt="Points exceeding the chart area"></div></div> 
<div class="figure-title">Figure 9-14. Points exceeding the chart area</div> </div> 
<p id="fortunately_sv">Fortunately, SVG has support for 
<span class="emphasis">
<em>clipping paths</em></span>, which might be more familiar to you as 
<span class="emphasis">
<em>masks</em></span>, as in Photoshop or Illustrator. A clipping path is an SVG element that contains visual elements that, together, make up the clipping path or mask to be applied to other elements. When a mask is applied to an element, only the pixels that land within that mask’s shape are displayed.</p> 
<p id="much_like_g_a_">Much like <code class="literal">g</code>, a <code class="literal">clipPath</code> has no visual presence of its own, but it contains visual elements (which are used to make the mask). For example, here’s a simple <code class="literal">clipPath</code>:</p> 
<pre class="programlisting" data-language="html" id="clippath_idc"><code class="nt">&lt;clipPath</code> <code class="na">id=</code><code class="s">"chart-area"</code><code class="nt">&gt;</code>     <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"30"</code> <code class="na">y=</code><code class="s">"30"</code> <code class="na">width=</code><code class="s">"410"</code> <code class="na">height=</code><code class="s">"240"</code><code class="nt">&gt;&lt;/rect&gt;</code> <code class="nt">&lt;/clipPath&gt;</code></pre> 
<p id="note_that_the_o">Note that the outer <code class="literal">clipPath</code> element has been given an ID of <code class="literal">chart-area</code>. We can use that ID to reference it later. Within the <code class="literal">clipPath</code> is a <code class="literal">rect</code>, which will function as the mask.</p> 
<p id="so_there_are_th">So there are three steps to using a clipping path:</p> 
<div class="orderedlist" id="define_the_clip_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Define the <code class="literal">clipPath</code> and give it an ID. </li> 
<li class="listitem"> Put visual elements within the <code class="literal">clipPath</code> (usually just a <code class="literal">rect</code>, but this could be <code class="literal">circle</code>s or any other visual elements). </li> 
<li class="listitem"> Add a reference to the <code class="literal">clipPath</code> from whatever element(s) you wish to be masked. </li> </ol></div> 
<p id="continuing_with_id1">Continuing with the scatterplot, I’ll define the clipping path with this new code (steps 1 and 2):</p> 
<pre class="programlisting" data-language="javascript" id="define_clippi"><code class="c1">//Define clipping path</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>                  <code class="c1">//Make a new clipPath</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"chart-area"</code><code class="p">)</code>           <code class="c1">//Assign an ID</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>                     <code class="c1">//Within the clipPath, create a new rect</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">padding</code><code class="p">)</code>                 <code class="c1">//Set rect's position and size…</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">padding</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code> <code class="o">-</code> <code class="nx">padding</code> <code class="o">*</code> <code class="mi">3</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code> <code class="o">*</code> <code class="mi">2</code><code class="p">);</code></pre> 
<p id="i_want_all_of_t">I want all of the <code class="literal">circle</code>s to be masked by this <code class="literal">clipPath</code>. I could add a <code class="literal">clipPath</code> reference to every single circle, but it’s much easier and cleaner to just put all the <code class="literal">circle</code>s into a <code class="literal">g</code> group, and then add the reference to that (this is step 3).</p> 
<p id="so_i_will_modi">So, I will modify this code:</p> 
<pre class="programlisting" data-language="javascript" id="create_circle_id1"><code class="c1">//Create circles</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="err">…</code></pre> 
<p id="by_adding_three">by adding three new lines, creating a new <code class="literal">g</code>, giving it an arbitrary ID, and finally adding the reference to the <code class="literal">chart-area</code> <code class="literal">clipPath</code>:</p> 
<pre class="programlisting" data-language="javascript" id="create_circle_id2"><code class="c1">//Create circles</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>                             <code class="c1">//Create new g</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"circles"</code><code class="p">)</code>                   <code class="c1">//Assign ID of 'circles'</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#chart-area)"</code><code class="p">)</code>   <code class="c1">//Add reference to clipPath</code>    <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>                     <code class="c1">//Continue as before…</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="err">…</code></pre> 
<p id="notice_that_the_id2">Notice that the attribute name is <code class="literal">clip-path</code>, and the element name is <code class="literal">clipPath</code>. Argh! I know; it drives me crazy, too.</p> 
<p id="view_the_sample">View the sample page 
<span class="emphasis">
<em>24_clip-path.html</em></span> and open the web inspector. Let’s look at that new <code class="literal">rect</code> in 

<a class="xref" href="#ThedimensionsofarectwithinaclipPath" title="Figure 9-15. The dimensions of a rect within a clipPath">Figure 9-15</a>.</p> 
<div class="figure" id="ThedimensionsofarectwithinaclipPath"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0915.png" alt="The dimensions of a rect within a clipPath"></div></div> 
<div class="figure-title">Figure 9-15. The dimensions of a rect within a clipPath</div> </div> 
<p id="because_clippat">Because <code class="literal">clipPath</code>s have no visual rendering (they only mask other elements), it’s helpful to highlight them in the web inspector, which will then outline the path’s position and size with a blue highlight. In 

<a class="xref" href="#ThedimensionsofarectwithinaclipPath" title="Figure 9-15. The dimensions of a rect within a clipPath">Figure 9-15</a> we can see that the <code class="literal">clipPath rect</code> is in the right place and is the right size.</p> 
<p id="notice_too_th">Notice, too, that now all the <code class="literal">circle</code>s are grouped within a single <code class="literal">g</code> element, whose <code class="literal">clip-path</code> attribute references our new clipping path, using the slightly peculiar syntax <code class="literal">url(#chart-area)</code>. Thanks for that, SVG specification.</p> 
<p id="the_end_result__id1">The end result is that our <code class="literal">circle</code>s’ pixels get clipped when they get too close to the edge of the chart area. Note the points at the extreme top and right edges.</p> 
<p id="the_clipping_is">The clipping is easier to see midtransition, as in 

<a class="xref" href="#Pointscontainedwithinthechartarea" title="Figure 9-16. Points contained within the chart area">Figure 9-16</a>.</p> 
<div class="figure" id="Pointscontainedwithinthechartarea"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0916.png" alt="Points contained within the chart area"></div></div> 
<div class="figure-title">Figure 9-16. Points contained within the chart area</div> </div> 
<p id="voil_the_poin">Voilà! The points no longer exceed the chart boundaries.

<a id="id542631" class="indexterm"></a></p> </div> </div> </div> 
<div class="sect1" data-original-filename="9_updates_transitions_and_motion.asciidoc" id="_other_kinds_of_data_updates"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Other Kinds of Data Updates</h2></div></div></div> 
<p id="until_now_when">Until now, when updating data, we have taken the “whole kit-and-kaboodle” approach: changing values in the dataset array, and then rebinding that revised dataset, overwriting the original values bound to our DOM elements.</p> 
<p id="that_approach_i">That approach is most useful when 
<span class="emphasis">
<em>all</em></span> the values are changing, and when the length of the dataset (i.e., the number of values) stays the same. But as we know, real-life data is messy, and calls for even more flexibility, such as when you only want to update one or two values, or you even need to add or subtract values. D3, again, comes to the rescue.</p> 
<div class="sect2" id="_adding_values_and_elements"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Adding Values (and Elements)</h3></div></div></div> 
<p id="lets_go_back_t">Let’s go back to our lovely bar chart, and say that some user interaction (a mouse click) should now trigger adding a 
<span class="emphasis">
<em>new</em></span> value to our dataset. That is, the length of the array <code class="literal">dataset</code> will increase by one.

<a id="ix_upadd" class="indexterm"></a>

<a id="id542712" class="indexterm"></a>

<a id="id542720" class="indexterm"></a></p> 
<p id="well_generatin">Well, generating a random number and pushing it to the array is easy enough:</p> 
<pre class="programlisting" data-language="javascript" id="add_one_new_v"><code class="c1">//Add one new value to dataset</code> <code class="kd">var</code> <code class="nx">maxValue</code> <code class="o">=</code> <code class="mi">25</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">maxValue</code><code class="p">);</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">newNumber</code><code class="p">);</code></pre> 
<p id="making_room_for">Making room for an extra bar will require recalibrating our x-axis scale. That’s just a matter of updating its input domain to reflect the new length of <code class="literal">dataset</code>:</p> 
<pre class="programlisting" data-language="javascript" id="xscaledomaind"><code class="nx">xScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">));</code></pre> 
<p id="thats_the_easy">That’s the easy stuff. Now prepare to bend your brain yet again, as we dive into the depths of D3 
<span class="emphasis">
<em>selections</em></span>.</p> 
<div class="sect3" id="_select"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Select</h4></div></div></div> 
<p id="by_now_you_are">By now, you are comfortable using <code class="literal">select()</code> and <code class="literal">selectAll()</code> to grab and return DOM element selections. And you’ve even seen how, when these methods are chained, they grab selections within selections, and so on,

<a id="id542980" class="indexterm"></a>

<a id="id542985" class="indexterm"></a> as in:</p> 
<pre class="programlisting" data-language="javascript" id="dselectbody_id9"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">);</code>   <code class="c1">//Returns all 'p' elements within 'body'</code></pre> 
<p id="when_storing_th">When storing the 
<span class="emphasis">
<em>results</em></span> of these selection methods, the most specific result—meaning the result of the last selector in the chain—is the reference handed off to the variable. For example:</p> 
<pre class="programlisting" data-language="javascript" id="var_paragraphs_"><code class="kd">var</code> <code class="nx">paragraphs</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">);</code></pre> 
<p id="now_paragraphs_">Now <code class="literal">paragraphs</code> contains a selection of all <code class="literal">p</code> elements in the DOM, even though we traversed through <code class="literal">body</code> to get there.</p> 
<p id="the_twist_here_">The twist here is that the <code class="literal">data()</code> method 
<span class="emphasis">
<em>also</em></span> returns a selection. Specifically, 
<span class="keep-together"><code class="literal">data()</code></span> returns references to all elements to which data was just bound, which we call the 
<span class="emphasis">
<em>update</em></span> selection.</p> 
<p id="in_the_case_of_">In the case of our bar chart, this means that we can select all the bars, then rebind the new data to those bars, and grab the update selection all in one fell swoop:</p> 
<pre class="programlisting" data-language="javascript" id="select_var_b"><code class="c1">//Select…</code> <code class="kd">var</code> <code class="nx">bars</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code></pre> 
<p id="now_the_update_">Now the update selection is stored in <code class="literal">bars</code>.</p> </div> 
<div class="sect3" id="_enter"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Enter</h4></div></div></div> 
<p id="when_we_changed">When we changed our data values, but not the 
<span class="emphasis">
<em>length</em></span> of the whole data set, we didn’t have to worry about an update selection—we simply rebound the data, and transitioned to new attribute values.</p> 
<p id="but_now_we_have">But now we have 
<span class="emphasis">
<em>added</em></span> a value. So <code class="literal">dataset.length</code> was originally 20, but now it is 21. How can we address that new data value, specifically, to draw a new <code class="literal">rect</code> for it? Stay with me here; your patience will be rewarded.</p> 
<p id="the_genius_of_t">The genius of the update selection is that it contains within it references to 
<span class="emphasis">
<em>enter</em></span> and 
<span class="emphasis">
<em>exit</em></span> subselections.</p> 
<p id="entering_elemen">
<span class="emphasis">
<em>Entering</em></span> elements are those that are new to the scene. It’s considered good form to welcome such elements to the neighborhood with a plate of cookies.</p> 
<p id="whenever_there__id1">Whenever there are more data values than corresponding DOM elements, the 
<span class="emphasis">
<em>enter</em></span> selection contains references to those elements 
<span class="emphasis">
<em>that do not yet exist</em></span>. You already know how to access the enter selection: by using <code class="literal">enter()</code> after binding the new data, as we do when first creating the bar chart. You have already seen the following code:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id12"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> <code class="c1">//Selects all rects (as yet nonexistent)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="c1">//Binds data to selection, returns update selection</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>           <code class="c1">//Extracts the enter selection, i.e., 20 placeholder elements</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="c1">//Creates a 'rect' inside each of the placeholder elements</code>    <code class="err">…</code></pre> 
<p id="you_have_alread">You have already seen this sequence of <code class="literal">selectAll()</code>→<code class="literal">data()</code>→<code class="literal">enter()</code>→
<span class="keep-together"><code class="literal">append()</code></span> many times, but only in the context of creating many elements at once, when the page first loads.</p> 
<p id="now_that_we_hav">Now that we have added one value to <code class="literal">dataset</code>, we can use <code class="literal">enter()</code> to address the one new corresponding DOM element, without touching all the existing <code class="literal">rect</code>s. Following the preceding <code class="literal">Select</code> code, I’ll add:</p> 
<pre class="programlisting" data-language="javascript" id="enter_barse"><code class="c1">//Enter…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>     <code class="p">});</code></pre> 
<p id="remember_bars_">Remember, <code class="literal">bars</code> contains the update selection, so <code class="literal">bars.enter()</code> extracts the enter selection from that. In this case, the enter selection is one reference to one new DOM element. We follow that with <code class="literal">append()</code> to create the new <code class="literal">rect</code>, and all the other <code class="literal">attr()</code> statements as usual, except for the following line:</p> 
<pre class="programlisting" data-language="javascript" id="attrx_w"><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code></pre> 
<p id="you_might_notic_id2">You might notice that this sets the horizontal position of the new <code class="literal">rect</code> to be just past the far right edge of the SVG. I want the new bar to be created just out of sight, so I can use a nice, smooth transition to move it gently into view.</p> </div> 
<div class="sect3" id="_update"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Update</h4></div></div></div> 
<p id="we_made_the_new">We made the new <code class="literal">rect</code>; now all that’s left is to update all <code class="literal">rect</code>’s visual attributes. Again, <code class="literal">bars</code> here stores the complete update selection (which includes the enter selection):</p> 
<pre class="programlisting" data-language="javascript" id="update_bars"><code class="c1">//Update…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">});</code></pre> 
<p id="this_has_the_ef">This has the effect of taking 
<span class="emphasis">
<em>all</em></span> the bars and transitioning them to their new x, y, width, and height values. Don’t believe me? See the working code in 
<span class="emphasis">
<em>25_adding_values.html</em></span>.</p> 
<p id="shows_the_initi">

<a class="xref" href="#Initialbarchart" title="Figure 9-17. Initial bar chart">Figure 9-17</a> shows the initial chart.</p> 
<div class="figure" id="Initialbarchart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0917.png" alt="Initial bar chart"></div></div> 
<div class="figure-title">Figure 9-17. Initial bar chart</div> </div> 
<p id="shows_the_chart">

<a class="xref" href="#Afteroneclick" title="Figure 9-18. After one click">Figure 9-18</a> shows the chart after one click on the text. Note the new bar on the right.</p> 
<div class="figure" id="Afteroneclick"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0918.png" alt="After one click"></div></div> 
<div class="figure-title">Figure 9-18. After one click</div> </div> 
<p id="after_two_click_id1">After two clicks, we get the chart shown in 

<a class="xref" href="#Aftertwoclicks" title="Figure 9-19. After two clicks">Figure 9-19</a>. 

<a class="xref" href="#Afterthreeclicks" title="Figure 9-20. After three clicks">Figure 9-20</a> shows the result after three clicks.</p> 
<div class="figure" id="Aftertwoclicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0919.png" alt="After two clicks"></div></div> 
<div class="figure-title">Figure 9-19. After two clicks</div> </div> 
<div class="figure" id="Afterthreeclicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0920.png" alt="After three clicks"></div></div> 
<div class="figure-title">Figure 9-20. After three clicks</div> </div> 
<p id="after_several_m">After several more clicks, you’ll see the chart shown in 

<a class="xref" href="#Aftermanyclicks" title="Figure 9-21. After many clicks">Figure 9-21</a>.</p> 
<div class="figure" id="Aftermanyclicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0921.png" alt="After many clicks"></div></div> 
<div class="figure-title">Figure 9-21. After many clicks</div> </div> 
<p id="not_only_are_ne">Not only are new bars being created, sized, and positioned, but on every click, 
<span class="emphasis">
<em>all other bars</em></span> are rescaled and moved into position as well.</p> 
<p id="whats_not_happ_id2">What’s 
<span class="emphasis">
<em>not</em></span> happening is that new value labels aren’t being created and transitioned into place. I leave that as an exercise for you to pursue.

<a id="id544578" class="indexterm"></a></p> 
<div class="sidebar online_only" id="interactive_9-10"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Exercise</div></div></div></div> 
<p id="add_code_in_the_id1">Add code in the below-left panel to add labels to the newly created bars. Test your solution in the output panel at right</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/25_adding_values.html" target="_blank">25_adding_values</a></p> 

<div class="sect2" id="_removing_values_and_elements"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Removing Values (and Elements)</h3></div></div></div> 
<p id="removing_elemen">Removing elements is easier.

<a id="ix_uprem" class="indexterm"></a></p> 
<p id="whenever_there__id2">Whenever there are more DOM elements than data values, the 
<span class="emphasis">
<em>exit</em></span> selection contains references to those elements without data. As you’ve

<a id="id544650" class="indexterm"></a> already guessed, we can access the exit selection with <code class="literal">exit()</code>.</p> 
<p id="first_ill_cha">First, I’ll change our trigger text to indicate we’re removing values:</p> 
<pre class="programlisting" data-language="html" id="pclick_on_thi_id3"><code class="nt">&lt;p&gt;</code>Click on this text to remove a data value from the chart!<code class="nt">&lt;/p&gt;</code></pre> 
<p id="then_on_click">Then, on click, instead of generating a new random value and adding it to <code class="literal">dataset</code>, we’ll use <code class="literal">shift()</code>, which removes the first element from the array:</p> 
<pre class="programlisting" data-language="javascript" id="remove_one_va"><code class="c1">//Remove one value from dataset</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code></pre> 
<div class="sect3" id="_exit"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Exit</h4></div></div></div> 
<p id="exiting_element">
<span class="emphasis">
<em>Exiting</em></span> elements are those that are on their way out. We should be polite and wish these elements a safe journey.

<a id="id544757" class="indexterm"></a></p> 
<p id="so_we_grab_the_">So we grab the exit selection, transition the exiting element off to the right side, and, finally, remove it:</p> 
<pre class="programlisting" data-language="javascript" id="exit_barsex_id1"><code class="c1">//Exit…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">exit</code><code class="p">()</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>     <code class="p">.</code><code class="nx">remove</code><code class="p">();</code></pre> 
<p id="remove_is_a_s"><code class="literal">remove()</code> is a special transition method that waits until the transition is complete, and then deletes the element from the DOM forever. (Sorry, there’s no getting it back.)</p> </div> 
<div class="sect3" id="_making_a_smooth_exit"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Making a smooth exit</h4></div></div></div> 
<p id="visually_speaki">Visually speaking, it’s good practice to perform a transition first, rather than simply <code class="literal">remove()</code> elements right away. In this case, we’re moving the bar off to the right, but you could just as easily transition <code class="literal">opacity</code> to zero, or apply some other visual transition.</p> 
<p id="that_said_if_y">That said, if you ever need to just get rid of an element ASAP, by all means, you can use <code class="literal">remove()</code> without calling a transition first.</p> 
<p id="okay_now_try_o">Okay, now try out the code in 
<span class="emphasis">
<em>26_removing_values.html</em></span>. 

<a class="xref" href="#Initial_bar_chart" title="Figure 9-22. Initial bar chart">Figure 9-22</a> shows the initial view.</p> 
<div class="figure" id="Initial_bar_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0922.png" alt="Initial bar chart"></div></div> 
<div class="figure-title">Figure 9-22. Initial bar chart</div> </div> 
<p id="then_after_one">Then, after one click on the text, note the loss of one bar in 

<a class="xref" href="#After_one_click" title="Figure 9-23. After one click">Figure 9-23</a>.</p> 
<div class="figure" id="After_one_click"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0923.png" alt="After one click"></div></div> 
<div class="figure-title">Figure 9-23. After one click</div> </div> 
<p id="after_two_click_id2">After two clicks, you’ll see the chart in 

<a class="xref" href="#After_two_clicks" title="Figure 9-24. After two clicks">Figure 9-24</a>. 

<a class="xref" href="#After_three_clicks" title="Figure 9-25. After three clicks">Figure 9-25</a> shows what displays after three clicks.</p> 
<div class="figure" id="After_two_clicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0924.png" alt="After two clicks"></div></div> 
<div class="figure-title">Figure 9-24. After two clicks</div> </div> 
<div class="figure" id="After_three_clicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0925.png" alt="After three clicks"></div></div> 
<div class="figure-title">Figure 9-25. After three clicks</div> </div> 
<p id="after_many_clic">After many clicks, the result is shown in 

<a class="xref" href="#After_many_clicks" title="Figure 9-26. After many clicks">Figure 9-26</a>.</p> 
<div class="figure" id="After_many_clicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0926.png" alt="After many clicks"></div></div> 
<div class="figure-title">Figure 9-26. After many clicks</div> </div> 
<p id="on_each_click_">On each click, one bar moves off to the right, and then is removed from the DOM. (You can confirm this with the web inspector.)</p> 
<p id="but_whats_not_">But what’s not working as expected? For starters, the value labels aren’t being removed, so they clutter up the top right of our chart. Again, I will leave fixing this aspect as an exercise to you.</p> 
<div class="sidebar online_only" id="interactive_9-11"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Exercise</div></div></div></div> 
<p id="add_code_in_the_id2">Add code in the below-left panel to remove the labels corresponding to the deleted bars. Test your solution in the output panel at right</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/26_removing_values.html" target="_blank">26_removing_values</a></p> 

<p id="more_important_id2">More important, although we are using the <code class="literal">Array.shift()</code> method to remove the 
<span class="emphasis">
<em>first</em></span> value from the <code class="literal">dataset</code> array, it’s not the 
<span class="emphasis">
<em>first</em></span> bar that is removed, is it? Instead, the last bar in the DOM, the one visually on the far right, is always removed. Although the data values are updating correctly (note how they move to the left with each click—5, 10, 13, 19, and so on), the bars are assigned new values, rather than “sticking” with their intial values. That is, the anticipated 
<span class="emphasis">
<em>object constancy</em></span> is broken—the “5” bar becomes the “10” bar, and so on, yet perceptually we would prefer that the “5” bar simply scoot off to the left and let all the other bars keep their original values.</p> 
<p id="why_why_oh_w">Why, why, oh, why is this happening?! Not to worry; there’s a perfectly reasonable explanation. The key to maintaining object constancy is, well, keys.  (On a side note, Mike Bostock has a very eloquent 

<a class="ulink" href="http://bost.ocks.org/mike/constancy/" target="_top">overview of the value of object constancy</a>, which I recommend.)

<a id="id545180" class="indexterm"></a></p> </div> </div> 
<div class="sect2" id="_data_joins_with_keys"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Data Joins with Keys</h3></div></div></div> 
<p id="now_that_you_un">Now that you understand update, enter, and exit selections, it’s time to dig deeper into data joins.

<a id="ix_dajoin" class="indexterm"></a>

<a id="ix_updajoin" class="indexterm"></a>

<a id="id545229" class="indexterm"></a>

<a id="id545237" class="indexterm"></a></p> 
<p id="a_data_join_hap">A data join happens whenever you bind data to DOM elements; that is, every time you call <code class="literal">data()</code>.

<a id="id545258" class="indexterm"></a></p> 
<p id="the_default_joi">The default join is by 
<span class="emphasis">
<em>index order</em></span>, meaning the first data value is bound to the first DOM element in the selection, the second value is bound to the second element, and so on.

<a id="id545277" class="indexterm"></a></p> 
<p id="but_what_if_the">But what if the data values and DOM elements are not in the same order? Then you need to tell D3 how to join or pair values and elements. Fortunately, you can define those rules by specifying a 
<span class="emphasis">
<em>key function</em></span>.

<a id="id545294" class="indexterm"></a></p> 
<p id="this_explains_t">This explains the problem with our bars. After we remove the first value from the <code class="literal">dataset</code> array, we rebind the new <code class="literal">dataset</code> on top of the existing elements. Those values are joined in index order, so the first <code class="literal">rect</code>, which originally had a value of 5, is now assigned 10. The former 10 bar is assigned 13, and so on. In the end, that leaves one <code class="literal">rect</code> element without data—the last one on the far right.</p> 
<p id="we_can_use_a_ke">We can use a 
<span class="emphasis">
<em>key function</em></span> to control the data join with more specificity and ensure that the right datum is bound to the right <code class="literal">rect</code> element.</p> 
<div class="sect3" id="_preparing_the_data"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Preparing the data</h4></div></div></div> 
<p id="until_now_our_">Until now, our dataset has been a simple array of values. But to use a key function, each value must have some “key” associated with it. Think of the key as a means of identifying the value without looking at the value itself, as the values themselves might change or exist in duplicate form. (If there were two separate values of <code class="literal">3</code>, how could you tell them apart?)

<a id="id545374" class="indexterm"></a></p> 
<p id="instead_of_an_a">Instead of an array of values, let’s use an array of 
<span class="emphasis">
<em>objects</em></span>, within which each object can contain both a key value and the actual data value:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id18"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">10</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">13</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">19</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">21</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">25</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">6</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">22</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">18</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">8</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">15</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">9</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">13</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">11</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">11</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">12</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">15</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">13</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">20</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">14</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">18</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">15</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">17</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">16</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">16</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">17</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">18</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">23</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">19</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">25</code> <code class="p">}</code> <code class="p">];</code></pre> 
<p id="remember_hard_">Remember, hard brackets <code class="literal">[]</code> indicate an array, and curly brackets <code class="literal">{}</code> indicate an object.</p> 
<p id="note_that_the_d">Note that the data values here are unchanged from our original <code class="literal">dataset</code>. What’s new are the keys, which just enumerate each object’s original position within the <code class="literal">dataset</code> array. (By the way, your chosen key name doesn’t have to be <code class="literal">key</code>—the name can be anything, like <code class="literal">id</code>, <code class="literal">year</code>, or <code class="literal">fruitType</code>. I am using <code class="literal">key</code> here for simplicity.)</p> </div> 
<div class="sect3" id="_updating_all_references"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Updating all references</h4></div></div></div> 
<p id="the_next_step_i">The next step isn’t fun, but it’s not hard. Now that our data values are buried within objects, we can no longer just reference <code class="literal">d</code>. (Ah, the good old days.) Anywhere in the code where we want to access the actual data 
<span class="emphasis">
<em>value</em></span>, we now need to specify <code class="literal">d.value</code>. When we use anonymous functions within D3 methods, <code class="literal">d</code> is handed whatever is in the current position in the array. In this case, each position in the array now contains an object, such as <code class="literal">{ key: 12, value: 15 }</code>. So to get at the value <code class="literal">15</code>, we now must write <code class="literal">d.value</code> to reach 
<span class="emphasis">
<em>into</em></span> the object and grab that <code class="literal">value</code> value. (I hope you see a lot of value in this paragraph.)

<a id="id546440" class="indexterm"></a></p> 
<p id="first_that_mea">First, that means a change to the <code class="literal">yScale</code> definition:</p> 
<pre class="programlisting" data-language="javascript" id="var_yscale__d_id3"><code class="kd">var</code> <code class="nx">yScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})])</code>                 <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code></pre> 
<p id="in_the_second_l">In the second line, we used to have simply <code class="literal">d3.max(dataset)</code>, but that only works with a simple array. Now that we’re using objects, we have to include an 
<span class="emphasis">
<em>accessor function</em></span> that tells <code class="literal">d3.max()</code> how to get at the correct values to compare. So as <code class="literal">d3.max()</code> loops through all the elements in the <code class="literal">dataset</code> array, now it knows not to look at <code class="literal">d</code> (which is an object, and not easily compared to other objects), but <code class="literal">d.value</code> (a number, which is easily compared to other numbers).

<a id="id546691" class="indexterm"></a>

<a id="id546697" class="indexterm"></a></p> 
<p id="note_we_also_ne">Note we also need to change the second reference to <code class="literal">yScale</code>, down in our click-update function:</p> 
<pre class="programlisting" data-language="javascript" id="yscaledomain"><code class="nx">yScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code></pre> 
<p id="next_up_everyw">Next up, everywhere <code class="literal">d</code> is used to set attributes, we must change <code class="literal">d</code> to <code class="literal">d.value</code>. For example, this:</p> 
<pre class="programlisting" data-language="javascript" id="attry_fu_id1"><code class="err">…</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>        <code class="c1">// &lt;-- d</code> <code class="p">})</code> <code class="err">…</code></pre> 
<p id="becomes_this">becomes this:</p> 
<pre class="programlisting" data-language="javascript" id="attry_fu_id2"><code class="err">…</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>  <code class="c1">// &lt;-- d.value!</code> <code class="p">})</code> <code class="err">…</code></pre> </div> 
<div class="sect3" id="_key_functions"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Key functions</h4></div></div></div> 
<p id="finally_we_def">Finally, we define a key function, to be used whenever we bind data to

<a id="id547101" class="indexterm"></a>

<a id="id547106" class="indexterm"></a> elements:</p> 
<pre class="programlisting" data-language="javascript" id="var_key__funct"><code class="kd">var</code> <code class="nx">key</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">;</code> <code class="p">};</code></pre> 
<p id="notice_that_in">Notice that, in typical D3 form, the function takes <code class="literal">d</code> as input. Then this very simple function specifies to take the <code class="literal">key</code> value of whatever <code class="literal">d</code> object is passed into it.</p> 
<p id="now_in_all_fou">Now, in all four places where we bind data, we replace this line:</p> 
<pre class="programlisting" data-language="javascript" id="datadataset"><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code></pre> 
<p id="with_this">with this:</p> 
<pre class="programlisting" data-language="javascript" id="datadataset__id1"><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code></pre> 
<p id="note_that_rathe">Note that rather than defining the key function first, then referencing it, you could of course simply write the key function directly into the call to <code class="literal">data()</code> like so:</p> 
<pre class="programlisting" data-language="javascript" id="datadataset__id2"><code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">;</code> <code class="p">})</code></pre> 
<p id="but_in_this_cas">But in this case, you’d have to write that four times, which is redundant, so I think defining the key function once at the top is cleaner.</p> 
<p id="thats_it_cons">That’s it! Consider your data joined.</p> </div> 
<div class="sect3" id="_exit_transition"> 
<div class="titlepage">
<div>
<div>
<h4 class="title">Exit transition</h4></div></div></div> 
<p id="one_last_tweak">One last tweak: Let’s set the exiting bar to scoot off to the left side

<a id="id547422" class="indexterm"></a>

<a id="id547430" class="indexterm"></a> instead of the right:</p> 
<pre class="programlisting" data-language="javascript" id="exit_barsex_id2"><code class="c1">//Exit…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">exit</code><code class="p">()</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="o">-</code><code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>  <code class="c1">// &lt;-- Exit stage left</code>     <code class="p">.</code><code class="nx">remove</code><code class="p">();</code></pre> 
<p id="great_check_ou">Great! Check out the sample code, with all of those changes, in 
<span class="emphasis">
<em>27_data_join_with_key.html</em></span>. The initial view shown in 

<a class="xref" href="#Initial-bar-chart" title="Figure 9-27. Initial bar chart">Figure 9-27</a> is unchanged.</p> 
<div class="figure" id="Initial-bar-chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0927.png" alt="Initial bar chart"></div></div> 
<div class="figure-title">Figure 9-27. Initial bar chart</div> </div> 
<p id="try_clicking_th_id2">Try clicking the text, though, and the leftmost bar slides cleanly off to the left, all other bars’ widths rescale to fit, and then the exited bar is deleted from the DOM. (Again, you can confirm this by watching the <code class="literal">rect</code>s disappear one by one in the web inspector.)</p> 
<p id="shows_the_view_">

<a class="xref" href="#After-one-click" title="Figure 9-28. After one click">Figure 9-28</a> shows the view after one bar is removed.</p> 
<div class="figure" id="After-one-click"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0928.png" alt="After one click"></div></div> 
<div class="figure-title">Figure 9-28. After one click</div> </div> 
<p id="after_two_click_id3">After two clicks, you’ll see the chart in 

<a class="xref" href="#After-two-clicks" title="Figure 9-29. After two clicks">Figure 9-29</a>.</p> 
<div class="figure" id="After-two-clicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0929.png" alt="After two clicks"></div></div> 
<div class="figure-title">Figure 9-29. After two clicks</div> </div> 
<p id="displays_the_re">

<a class="xref" href="#After-three-clicks" title="Figure 9-30. After three clicks">Figure 9-30</a> displays the results after three clicks, and after several clicks, you’ll see the result shown in 

<a class="xref" href="#After-many-clicks" title="Figure 9-31. After many clicks">Figure 9-31</a>.</p> 
<div class="figure" id="After-three-clicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0930.png" alt="After three clicks"></div></div> 
<div class="figure-title">Figure 9-30. After three clicks</div> </div> 
<div class="figure" id="After-many-clicks"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0931.png" alt="After many clicks"></div></div> 
<div class="figure-title">Figure 9-31. After many clicks</div> </div> 
<p id="this_is_working">This is working better than ever. The only hitch is that the labels aren’t exiting to the left, and also are not removed from the DOM, so they clutter up the left side of the chart. Again, I leave this to you; put your new D3 chops to the test and clean up those labels.

<a id="id547743" class="indexterm"></a>

<a id="id547752" class="indexterm"></a></p> 
<div class="sidebar online_only" id="interactive_9-12"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Exercise</div></div></div></div> 
<p id="add_code_in_the_id3">Add code in the below-left panel to remove the labels corresponding to the deleted bars. Test your solution in the output panel at right</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/27_data_join_with_key.html" target="_blank">27_data_join_with_key</a></p> 

<div class="sect2" id="_add_and_remove_combo_platter"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Add and Remove: Combo Platter</h3></div></div></div> 
<p id="we_could_stop_t">We could stop there and be very satisfied with our newfound skills. But why not go all the way, and adjust our chart so data values can be added 
<span class="emphasis">
<em>and</em></span> removed?

<a id="id547804" class="indexterm"></a></p> 
<p id="this_is_easier_">This is easier than you might think. First, we’ll need two different triggers for the user interaction. I’ll split the one paragraph into two, and give each a unique ID, so we can tell which one is clicked:</p> 
<pre class="programlisting" data-language="html" id="p_idaddadd"><code class="nt">&lt;p</code> <code class="na">id=</code><code class="s">"add"</code><code class="nt">&gt;</code>Add a new data value<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;p</code> <code class="na">id=</code><code class="s">"remove"</code><code class="nt">&gt;</code>Remove a data value<code class="nt">&lt;/p&gt;</code></pre> 
<p id="later_down_whe">Later, down where we set up the click function, <code class="literal">select()</code> must become 
<span class="keep-together"><code class="literal">selectAll()</code></span>, now that we’re selecting more than one <code class="literal">p</code> element:</p> 
<pre class="programlisting" data-language="javascript" id="dselectallp"><code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="err">…</code></pre> 
<p id="now_that_this_c">Now that this click function will be bound to both paragraphs, we have to introduce some logic to tell the function to behave differently depending on which paragraph was clicked. There are many ways to achieve this; I’ll go with the most straightforward one.</p> 
<p id="fortunately_wi">Fortunately, within the context of our anonymous click function, <code class="literal">this</code> refers to the element that was clicked—the paragraph. So we can get the ID value of the clicked element by selecting <code class="literal">this</code> and inquiring using <code class="literal">attr()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="dselectthis"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">)</code></pre> 
<p id="that_statement_">That statement will return <code class="literal">"add"</code> when <code class="literal">p#add</code> is clicked, and <code class="literal">"remove"</code> when 
<span class="keep-together"><code class="literal">p#remove</code></span> is clicked. Let’s store that value in a variable, and use it to control an <code class="literal">if</code> statement:</p> 
<pre class="programlisting" data-language="javascript" id="see_which_p_w"><code class="c1">//See which p was clicked</code> <code class="kd">var</code> <code class="nx">paragraphID</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">);</code>  <code class="c1">//Decide what to do next</code> <code class="k">if</code> <code class="p">(</code><code class="nx">paragraphID</code> <code class="o">==</code> <code class="s2">"add"</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Add a data value</code>     <code class="kd">var</code> <code class="nx">maxValue</code> <code class="o">=</code> <code class="mi">25</code><code class="p">;</code>     <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">maxValue</code><code class="p">);</code>     <code class="kd">var</code> <code class="nx">lastKeyValue</code> <code class="o">=</code> <code class="nx">dataset</code><code class="p">[</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">].</code><code class="nx">key</code><code class="p">;</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lastKeyValue</code><code class="p">);</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code>         <code class="nx">key</code><code class="o">:</code> <code class="nx">lastKeyValue</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code>         <code class="nx">value</code><code class="o">:</code> <code class="nx">newNumber</code>     <code class="p">});</code> <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>     <code class="c1">//Remove a value</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code> <code class="p">}</code></pre> 
<p id="so_if_padd_is">So, if <code class="literal">p#add</code> is clicked, we calculate a new random value, and then look up the key value of the last item in <code class="literal">dataset</code>. Then we create a new object with an incremented key (to ensure we don’t duplicate keys; insert locksmith joke here) and the random data value.</p> 
<p id="no_additional_c">No additional changes are needed! The enter/update/exit code we wrote is already flexible enough to handle adding 
<span class="emphasis">
<em>or</em></span> removing data values—that’s the beauty of it.</p> 
<p id="try_it_out_in__id2">Try it out in 
<span class="emphasis">
<em>28_adding_and_removing.html</em></span>. You’ll see that you can click to add or remove data points at will. Of course, real-world data isn’t created this way, but you can imagine these data updates being triggered by some other event—such as data refreshes being pulled from a server—and not mouse clicks.</p> 
<p id="also_see__dyn">Also see 
<span class="emphasis">
<em>29_dynamic_labels.html</em></span>, which is the same thing, only I’ve updated the code to add, transition, and remove the labels as well.</p> 
<div class="sidebar online_only" id="interactive_9-13"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_09/29_dynamic_labels.html" target="_blank">29_dynamic_labels</a></p> 

<div class="sect2" id="_recap"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Recap</h3></div></div></div> 
<p id="that_was_a_lot_">That was a lot of information! Let’s review:</p> 
<div class="itemizedlist" id="data_binds_da_id1">
<ul class="itemizedlist"> 
<li class="listitem"> <code class="literal">data()</code> binds data to elements, but also returns the 
<span class="emphasis">
<em>update selection</em></span>.

<a id="id548636" class="indexterm"></a> </li> 
<li class="listitem"> The update selection can contain 
<span class="emphasis">
<em>enter</em></span> and 
<span class="emphasis">
<em>exit</em></span> selections, which can be accessed via <code class="literal">enter()</code> and <code class="literal">exit()</code>. </li> 
<li class="listitem"> When there are 
<span class="emphasis">
<em>more values than elements</em></span>, an enter selection will reference the placeholder, not-yet-existing elements. </li> 
<li class="listitem"> When there are 
<span class="emphasis">
<em>more elements than values</em></span>, an exit selection will reference the elements without data. </li> 
<li class="listitem"> Data joins determine how values are matched with elements. </li> 
<li class="listitem"> By default, data joins are performed by index, meaning in order of appearance. </li> 
<li class="listitem"> For more control over data joins, you can specify a key function. </li> </ul></div> 
<p id="as_a_final_note">As a final note, in the bar chart example, we used this sequence:</p> 
<div class="orderedlist" id="enter_update_ex">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Enter </li> 
<li class="listitem"> Update </li> 
<li class="listitem"> Exit </li> </ol></div> 
<p id="although_this_w">Although this worked well for us, this order isn’t set in stone. Depending on your design goals, you might want to update first, then enter new elements, and finally exit old ones. It all depends—just remember that once you have the update selection in hand, you can reach in to grab the enter and exit selections anytime. The order in which you do so is flexible and completely up to you.</p> 
<p id="fantastic_you_">Fantastic. You are well on your way to becoming a D3 wizard. Now let’s get to the really fun stuff: interactivity!

<a id="id548777" class="indexterm"></a></p> </div>
<section class="chapter" data-original-filename="10_interactivity.asciidoc" id="interactivity">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 10. Interactivity</h1></div></div></div> 
<p id="now_that_youre">Now that you’re an old pro at data updates, transitions, and motion, let’s incorporate true interactivity.

<a id="ix_interact" class="indexterm"></a></p> 
<div class="sect1" data-original-filename="10_interactivity.asciidoc" id="_binding_event_listeners"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Binding Event Listeners</h2></div></div></div> 
<p id="say_what_i_kno">Say 
<span class="emphasis">
<em>what?</em></span>  I know, I know:  First, we bound 
<span class="emphasis">
<em>data</em></span>, which was weird enough.  And now I’m talking about binding 
<span class="emphasis">
<em>event listeners?</em></span>  (This is how JavaScript earned its reputation for being such a strange language.)

<a id="id548845" class="indexterm"></a>

<a id="id548854" class="indexterm"></a></p> 
<p id="as_explained_in">As explained in 

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a>, JavaScript uses an 
<span class="emphasis">
<em>event model</em></span> in which “events” are triggered by things happening, such as new input from the user, provided via a keyboard, mouse, or touch screen.  Most of the time, events are being triggered constantly, left and right—it’s just that nobody is 
<span class="emphasis">
<em>listening</em></span> for them, so they are ignored.

<a id="id548882" class="indexterm"></a>

<a id="id548888" class="indexterm"></a></p> 
<p id="to_make_our_pie">To make our pieces interactive, we define chunks of code that 
<span class="emphasis">
<em>listen</em></span> for specific events being triggered on specific DOM elements.  In 

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a>, we used the following code:</p> 
<pre class="programlisting" data-language="javascript" id="dselectp__id3"><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something on click</code>     <code class="p">});</code></pre> 
<p id="this_binds_an_e">This 
<span class="emphasis">
<em>binds</em></span> an 
<span class="emphasis">
<em>event listener</em></span> to the <code class="literal">p</code> paragraph element.  The listener happens to be listening for the <code class="literal">click</code> event, which is the JavaScript event triggered when the user clicks the mouse 
<span class="emphasis">
<em>on that <code class="literal">p</code> element</em></span>. (D3 doesn’t use custom event names, although you can define your own.  For the sake of supporting existing standards, D3 recognizes all the standard JavaScript events, such as <code class="literal">mouseover</code> and <code class="literal">click</code>. The events supported vary somewhat by browser. Peter-Paul Koch’s 

<a class="ulink" href="http://www.quirksmode.org/dom/events/" target="_top">event compatibility tables</a> are a useful reference.)

<a id="id549053" class="indexterm"></a>

<a id="id549059" class="indexterm"></a></p> 
<p id="this_gets_at_on">This gets at one of the nuances of JavaScript’s event model, which is that events don’t happen in a vacuum.  Rather, they are always 
<span class="emphasis">
<em>called on</em></span> a specific element.  So the code just shown isn’t activated whenever 
<span class="emphasis">
<em>any</em></span> click occurs; it is run just when a click occurs 
<span class="emphasis">
<em>on the <code class="literal">p</code> element</em></span>.</p> 
<p id="you_could_achie">You could achieve all this with raw JavaScript, but D3’s <code class="literal">on()</code> method is a handy way to quickly bind event listeners to D3 selections.  As you can see, <code class="literal">on()</code> takes two arguments: the event name, and an anonymous function to be executed when the event is triggered on the selected element.</p> 
<p id="making_your_vis">Making your visualization interactive is a simple, two-step process that includes:</p> 
<div class="orderedlist" id="binding_event_l_id1">
<ol class="orderedlist" type="1"> 
<li class="listitem"> Binding event listeners </li> 
<li class="listitem"> Defining the behavior </li> </ol></div> </div> 
<div class="sect1" data-original-filename="10_interactivity.asciidoc" id="_introducing_behaviors"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Introducing Behaviors</h2></div></div></div> 
<p id="lets_start_by_">Let’s start by working with an earlier, static version of our bar chart.  See sample code 
<span class="emphasis">
<em>01_start.html</em></span>.</p> 
<p id="the_example_cod">The example code binds an event on only one element: <code class="literal">p</code>.  This is an unusual usage for <code class="literal">on()</code>.

<a id="id549183" class="indexterm"></a>

<a id="ix_beh" class="indexterm"></a>

<a id="id549203" class="indexterm"></a>

<a id="id549209" class="indexterm"></a> More commonly, you will want to bind event listeners to more than one element at a time, such as to 
<span class="emphasis">
<em>all</em></span> of the visual elements in your visualization.  Fortunately, that is very easy to do.  Instead of using <code class="literal">select()</code> to select only one element, use 
<span class="keep-together"><code class="literal">selectAll()</code></span> to select multiple elements and pass that selection to <code class="literal">on()</code>.</p> 
<p id="you_can_even_bi">You can even bind those event listeners right at the moment when you first create elements.  For example, here is our existing code that creates our bar chart’s <code class="literal">rect</code>s, to which I’ve simply tacked on <code class="literal">on()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="create_bars_s_id2"><code class="c1">//Create bars</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="err">…</code>   <code class="c1">//Set attributes (omitted here)</code>    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>        <code class="c1">//This will run whenever *any* bar is clicked</code>    <code class="p">});</code></pre> 
<p id="when_defining_t">When defining the anonymous function, you can reference <code class="literal">d</code>, or <code class="literal">d</code> and <code class="literal">i</code>, or neither, just as you’ve seen throughout D3.  And then whatever code you put between the function’s brackets will execute on click.</p> 
<p id="this_is_a_quick">This is a quick and easy way to verify your data values, for example:</p> 
<pre class="programlisting" data-language="javascript" id="onclick_fu"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>              <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code> <code class="p">});</code></pre> 
<p id="try_that_code_b">Try that code by running 
<span class="emphasis">
<em>02_click.html</em></span>, open the JavaScript console, and click on some bars.  When you click on each bar, you should see that bar’s data value printed to the console.  Nice!</p> 
<div class="sect2" id="_hover_to_highlight"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Hover to Highlight</h3></div></div></div> 
<p id="highlighting_el">Highlighting elements in response to mouse interaction is a common way to make your visualization feel more responsive, and it can help users navigate and focus on the data of interest.

<a id="id549578" class="indexterm"></a>

<a id="id549583" class="indexterm"></a>

<a id="id549591" class="indexterm"></a>

<a id="id549597" class="indexterm"></a>

<a id="id549605" class="indexterm"></a></p> 
<p id="a_simple_hover_">A simple hover effect can be achieved with CSS alone—no JavaScript required!  The CSS pseudoclass selector <code class="literal">:hover</code> can be used in combination with any other selector to select, well, that same thing, but when the mouse is hovering 
<span class="emphasis">
<em>over</em></span> the element.  Here, we select all SVG <code class="literal">rect</code>s and set their fill to <code class="literal">orange</code> (see 

<a class="xref" href="#simple_css_only_mouse_hover" title="Figure 10-1. A simple CSS-only mouse hover effect">Figure 10-1</a>):</p> 
<pre class="programlisting" data-language="css" id="recthover__fi"><code class="nt">rect</code><code class="nd">:hover</code> <code class="p">{</code>         <code class="k">fill</code><code class="o">:</code> <code class="nb">orange</code><code class="p">;</code> <code class="p">}</code></pre> 
<div class="figure" id="simple_css_only_mouse_hover"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1001.png" alt="A simple CSS-only mouse hover effect"></div></div> 
<div class="figure-title">Figure 10-1. A simple CSS-only mouse hover effect</div> </div> 
<p id="see__hoverht">See 
<span class="emphasis">
<em>03_hover.html</em></span>, and try it out yourself.</p> 
<p id="css_hover_styli">CSS hover styling is fast and easy, but limited.  There’s only so much you can achieve with <code class="literal">:hover</code>.  Fortunately, recent browsers support applying the new CSS3 transitions on SVG elements.  Try adding this above the <code class="literal">rect:hover</code> rule in that example:</p> 
<pre class="programlisting" data-language="css" id="rect__moztra_id1"><code class="nt">rect</code> <code class="p">{</code>         <code class="o">-</code><code class="n">moz</code><code class="o">-</code><code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>         <code class="o">-</code><code class="n">o</code><code class="o">-</code><code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>         <code class="o">-</code><code class="n">webkit</code><code class="o">-</code><code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>         <code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="this_tells_brow">This tells browsers (including Mozilla, Opera, and Webkit-based browsers) to apply a 0.2-second transition to any changes to the <code class="literal">rect</code> elements.  Run that, and you’ll see that the blue/orange switch no longer happens instantly, but smoothly, over a brief 
<span class="keep-together">0.2-second</span> period.  Nice!

<a id="id549925" class="indexterm"></a></p> 
<div class="sidebar online_only" id="interactive_10-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="add_the_followi">Add the following lines of code above the <code class="literal">rect:hover</code> rule in the CSS panel below:</p> 
<pre class="programlisting" data-language="css" id="rect__moztra_id2"><code class="nt">rect</code> <code class="p">{</code>    <code class="k">-moz-transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>    <code class="k">-o-transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>    <code class="k">-webkit-transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>    <code class="k">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="then_hover_over">Then hover over the bars in the output at right, and note the smooth transitions</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_10/03_hover.html" target="_blank">03_hover</a></p> 

<p id="yet_these_trans">Yet these transitions can also be managed using JavaScript and D3, for additional control and coordination with other parts of our visualization.  Luckily for us, D3 handles all the hassle of transitions for us, so working with JavaScript is not so bad.  Let’s re-create the orange hover effect without CSS.</p> 
<p id="instead_of_refe">Instead of referencing the <code class="literal">click</code> event, as we did earlier, we can call <code class="literal">on()</code> with <code class="literal">mouseover</code>, the JavaScript event equivalent of CSS’s <code class="literal">hover</code>:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseover_id1"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something on mouseover of any bar</code> <code class="p">});</code></pre> 
<p id="now_we_want_to_">Now we want to set the <code class="literal">fill</code> of 
<span class="emphasis">
<em>this</em></span> bar (the one on which the <code class="literal">mouseover</code> event is triggered) to orange.  Yet we are operating in the context of an anonymous function—how could we possibly select the same element on which the event was just triggered?</p> 
<p id="the_answer_is_t">The answer is 
<span class="emphasis">
<em>this</em></span>.  No, sorry, I mean <code class="literal">this</code>.  Just select <code class="literal">this</code>, and set its fill to orange:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseover_id2"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"orange"</code><code class="p">);</code> <code class="p">});</code></pre> 
<p id="another_reason_">Another reason “real” programmers hate JavaScript is because of its notoriously wishy washy use of the keyword <code class="literal">this</code>.  In other languages, the meaning of <code class="literal">this</code> is very clearly defined; not so in JavaScript.  (jQuery fans are used to this debate.)</p> 
<p id="for_our_purpose_id1">For our purposes, here is all you need to know:</p> 
<div class="itemizedlist" id="context_is_impo_id1">
<ul class="itemizedlist"> 
<li class="listitem"> Context is important. </li> 
<li class="listitem"> Within anonymous functions, D3 automatically sets the context of <code class="literal">this</code> so it references “the current element upon which we are acting.” </li> </ul></div> 
<p id="the_end_result__id2">The end result is that, when we hand off anonymous functions to any of D3’s methods, we can reference <code class="literal">this</code> when trying to act on the current element.</p> 
<p id="indeed_you_can">Indeed, you can see this (ha!) in action in 
<span class="emphasis">
<em>04_mouseover.html</em></span> (

<a class="xref" href="#using_d3" title="Figure 10-2. Using D3 to set an orange fill on mouseover">Figure 10-2</a>).</p> 
<div class="figure" id="using_d3"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1002.png" alt="Using D3 to set an orange fill on mouseover"></div></div> 
<div class="figure-title">Figure 10-2. Using D3 to set an orange fill on <code class="literal">mouseover</code> </div> </div> 
<p id="move_the_mouse_">Move the mouse over a <code class="literal">rect</code>, the event listener for that <code class="literal">rect</code> is triggered, that same <code class="literal">rect</code> is selected (as <code class="literal">this</code>), and then its fill is set to orange.</p> 
<p id="looks_good_but">

<a class="xref" href="#using_d3" title="Figure 10-2. Using D3 to set an orange fill on mouseover">Figure 10-2</a> looks good, but we should probably restore each bar’s original color once the hover is over, meaning on <code class="literal">mouseout</code>:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseout_id1"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code> <code class="p">});</code></pre> 
<p id="perfect_try_it">Perfect! Try it yourself in 
<span class="emphasis">
<em>05_mouseout.html</em></span>. See 

<a class="xref" href="#results_d3" title="Figure 10-3. Moving the mouse left to right, with fills set on mouseover and mouseout">Figure 10-3</a>.</p> 
<div class="figure" id="results_d3"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1003.png" alt="Moving the mouse left to right, with fills set on mouseover and mouseout"></div></div> 
<div class="figure-title">Figure 10-3. Moving the mouse left to right, with fills set on <code class="literal">mouseover</code> and <code class="literal">mouseout</code> </div> </div> 
<p id="i_am_really_exc">I am really excited to have accomplished in eight lines of JavaScript what I did originally with CSS in only three!  (Not!)</p> 
<p id="actually_what_">Actually, what I 
<span class="emphasis">
<em>am</em></span> excited about is to now make the outbound transition silky smooth (see 

<a class="xref" href="#smooth" title="Figure 10-4. Moving the mouse left to right (Smooth Operator Edition)">Figure 10-4</a>).  As you remember from 

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a>, accomplishing that involves adding only two lines of code, for <code class="literal">transition()</code> and <code class="literal">duration()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseout_id2"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>       <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>       <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">250</code><code class="p">)</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code> <code class="p">});</code></pre> 
<p id="try_that_out_in">Try that out in 
<span class="emphasis">
<em>06_smoother.html</em></span>.</p> 
<div class="figure" id="smooth"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1004.png" alt="Moving the mouse left to right (Smooth Operator Edition)"></div></div> 
<div class="figure-title">Figure 10-4. Moving the mouse left to right (Smooth Operator Edition)</div> </div> 
<div class="sidebar online_only" id="interactive_10-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="hover_over_the__id1">Hover over the bars below, and note the smooth transitions.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_10/06_smoother.html" target="_blank">06_smoother</a></p> 

<div class="sidebar" id="pointer_events_on_overlapping_elements"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Pointer Events on Overlapping Elements</div></div></div></div> 
<p id="mouse_events_ar">Mouse events are triggered only on elements with pixels that can be “touched” by the mouse.  If two elements overlap, and the mouse moves over the element that is “on top” (in other words, closer to the front), then the <code class="literal">mouseover</code> event will be triggered on the frontmost element, and 
<span class="emphasis">
<em>not</em></span> on the element behind it.

<a id="id551010" class="indexterm"></a>

<a id="id551016" class="indexterm"></a>

<a id="id551021" class="indexterm"></a>

<a id="id551030" class="indexterm"></a>

<a id="id551038" class="indexterm"></a>

<a id="id551046" class="indexterm"></a></p> 
<p id="you_can_see_thi_id2">You can see this in 
<span class="emphasis">
<em>06_smoother.html</em></span>.  Mouse over any bar, and then move your pointer directly above one of the value labels.  You’ll see the bar fade back from orange to blue.  The <code class="literal">text</code> elements are in front of the bars, so mousing over a label involves also 
<span class="emphasis">
<em>mousing out</em></span> of the <code class="literal">rect</code> behind it.  This is counterintuitive because, visually, we haven’t left the <code class="literal">rect</code> at all, but as far as JavaScript is concerned, we have.</p> 
<p id="remember_that_i">Remember that in SVG, elements placed later in the DOM are rendered visually “in front” of earlier elements.  (See the section "Layering and Drawing Order" in 

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>.)</p> 
<p id="in_many_cases_">In many cases, you might want mouse events on some elements (such as our value labels) to be ignored.  Luckily, this is as easy as applying one line of CSS to the elements you wish to have ignored:</p> 
<pre class="programlisting" data-language="css" id="pointerevents"><code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code></pre> 
<p id="this_magically_">This magically tells the browser “Hey, this element shouldn’t trigger any pointer events (such as <code class="literal">click</code>, <code class="literal">mouseover</code>, or <code class="literal">mouseout</code>), so just behave as if this element isn’t here.”  It lets events pass through to the next element below it.</p> 
<p id="use_normal_css_">Use normal CSS selectors to target the appropriate elements. For example, this would apply that to all SVG <code class="literal">text</code> elements:</p> 
<pre class="programlisting" data-language="css" id="svg_text__poin"><code class="nt">svg</code> <code class="nt">text</code> <code class="p">{</code>         <code class="n">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="k">none</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="or_instead_of_">Or, instead of including this in a stylesheet, you could specify the CSS with D3 directly when you create the <code class="literal">text</code> element, for example:</p> 
<pre class="programlisting" data-language="javascript" id="svgappendtex"><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="err">…</code>  <code class="c1">//other stuff here</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code></pre> </div> </div> </div> 
<div class="sect1" data-original-filename="10_interactivity.asciidoc" id="_grouping_svg_elements"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Grouping SVG Elements</h2></div></div></div> 
<p id="note_that_g_gro">Note that <code class="literal">g</code> group elements 
<span class="emphasis">
<em>do not</em></span>, by themselves, trigger any mouse events.  The reason for this is that <code class="literal">g</code> elements have no pixels!  Only their enclosed elements—like <code class="literal">rect</code>s, <code class="literal">circle</code>s, and <code class="literal">text</code> elements—have pixels.</p> 
<p id="you_can_still_b">You can still bind event listeners to <code class="literal">g</code> elements.  Just keep in mind that the elements within that <code class="literal">g</code> will then behave as a group.  For example, if 
<span class="emphasis">
<em>any</em></span> of the enclosed elements are clicked or moused over, then the listener function will be activated.

<a id="id551409" class="indexterm"></a>

<a id="id551417" class="indexterm"></a></p> 
<p id="this_technique_">This technique can be quite useful when you have several visual elements that should all act in concert.  In our bar chart, for example, we could group <code class="literal">rect</code> and <code class="literal">text</code> elements each into their own groups.  The element hierarchy currently looks like this:</p> 
<pre class="screen" id="svg_rect_rect_r">svg         rect         rect         rect         …         text         text         text         …</pre> 
<p id="after_grouping_">After grouping elements, it could look like this:</p> 
<pre class="screen" id="svg_g_rect_text">svg         g                 rect                 text         g                 rect                 text         …</pre> 
<p id="instead_of_worr">Instead of worrying about <code class="literal">pointer-events</code> and which element is on top, we just bind the event listener to the whole group.  So clicking on some <code class="literal">text</code> will trigger the same code as clicking on a <code class="literal">rect</code> because they’re both in the same group.</p> 
<p id="even_better_th">Even better, throw an invisible <code class="literal">rect</code> with a <code class="literal">fill</code> of <code class="literal">none</code> and <code class="literal">pointer-events</code> value of <code class="literal">all</code> on the top of each group.  Even though the <code class="literal">rect</code> is invisible, it will still trigger mouse events, so you could have the <code class="literal">rect</code> span the whole height of the chart.  The net effect is that mousing 
<span class="emphasis">
<em>anywhere</em></span> in that column—even in “empty” whitespace above a short blue bar—would trigger the highlight effect.</p> 
<div class="sect2" id="_click_to_sort"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Click to Sort</h3></div></div></div> 
<p id="interactive_vis">Interactive visualization is most powerful when it can provide different 
<span class="emphasis">
<em>views</em></span> of the data, empowering the user to explore the information from different angles.

<a id="id551569" class="indexterm"></a>

<a id="id551578" class="indexterm"></a>

<a id="id551583" class="indexterm"></a>

<a id="id551589" class="indexterm"></a></p> 
<p id="the_ability_to_">The ability to 
<span class="emphasis">
<em>sort</em></span> data is extremely important.  And yes, as you just guessed, D3 makes it very easy to sort elements.</p> 
<p id="continuing_with_id2">Continuing with the bar chart, let’s add an event listener for the <code class="literal">click</code> event, to which we bind an anonymous function that, in turn, will call a new function of our own creation, <code class="literal">sortBars()</code>.</p> 
<pre class="programlisting" data-language="javascript" id="onclick_"><code class="err">…</code> <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="nx">sortBars</code><code class="p">();</code> <code class="p">});</code></pre> 
<p id="for_simplicity">For simplicity, we are binding this to every bar, but of course you could bind this instead to a button or any other element, inside or outside of the SVG image.</p> 
<p id="at_the_end_of_t">At the end of the code, let’s define this new function and store it in <code class="literal">sortBars</code>:</p> 
<pre class="programlisting" data-language="javascript" id="var_sortbars___id1"><code class="kd">var</code> <code class="nx">sortBars</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>          <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>                  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">);</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                  <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>            <code class="p">});</code>  <code class="p">};</code></pre> 
<p id="you_can_see_thi_id3">You can see this code in 
<span class="emphasis">
<em>07_sort.html</em></span> and the result in 

<a class="xref" href="#click-to-sort" title="Figure 10-5. The view after click-to-sort">Figure 10-5</a>.  Try clicking any of the bars, and watch them reorganize.</p> 
<div class="figure" id="click-to-sort"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1005.png" alt="The view after click-to-sort"></div></div> 
<div class="figure-title">Figure 10-5. The view after click-to-sort</div> </div> 
<p id="when_sortbars">When <code class="literal">sortBars()</code> is called, first we reselect all the <code class="literal">rect</code>s.  Then we use D3’s handy <code class="literal">sort()</code> method, which reorders elements based on their bound data values.  <code class="literal">sort()</code> needs to know how to decide which elements come first, and which later, so we pass into it a 
<span class="emphasis">
<em>comparator</em></span> function.</p> 
<p id="unlike_our_anon">Unlike our anonymous functions so far, the comparator doesn’t take <code class="literal">d</code> (the current datum) or <code class="literal">i</code> (the current index).  Instead, it is passed 
<span class="emphasis">
<em>two values</em></span>, <code class="literal">a</code> and <code class="literal">b</code>, which represent the data values of two different elements.  (You could name them anything else; <code class="literal">a</code> and <code class="literal">b</code> are just the convention.)  The comparator will be called on every pair of elements in our array, comparing <code class="literal">a</code> to <code class="literal">b</code>, until, in the end, all the array elements are sorted per whatever rules we specify.</p> 
<p id="we_specify_how_">We specify 
<span class="emphasis">
<em>how</em></span> <code class="literal">a</code> and <code class="literal">b</code> should be compared within the comparator.  Thankfully, D3 also provides a handful of comparison functions that spare us from writing more JavaScript.  Here, we use <code class="literal">d3.ascending()</code>, into which both <code class="literal">a</code> and <code class="literal">b</code> are passed.  Whichever one is bigger comes out the winner.  And <code class="literal">sort()</code> loops through all the data values in this way until it has all the elements, er, sorted out.  (Note that 
<span class="keep-together"><code class="literal">d3.ascending</code></span> works well in this case, because our values are numbers.  Comparing strings of text is a whole other can of worms.)</p> 
<p id="finally_our_ne">Finally, our new order in place, we initiate a transition, set a duration of one second, and then calculate the new <code class="literal">x</code> position for each <code class="literal">rect</code>.  (This <code class="literal">attr</code> code is just copied from when we created the <code class="literal">rect</code>s initially.)</p> 
<p id="this_works_swim">This works swimmingly, except for two catches.</p> 
<p id="first_youll_n">First, you’ll notice that we haven’t accounted for the value labels yet, so they didn’t slide into place along with the bars.  (I leave that to you as an exercise.)</p> 
<p id="second_you_mig">Second, you might observe that if you mouse over some bars 
<span class="emphasis">
<em>while</em></span> the 
<span class="keep-together">transition</span> is occurring, those bars don’t fall properly into place (see 

<a class="xref" href="#interrupted" title="Figure 10-6. Transitions, interrupted">Figure 10-6</a>).

<a id="id552249" class="indexterm"></a></p> 
<div class="figure" id="interrupted"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1006.png" alt="Transitions, interrupted"></div></div> 
<div class="figure-title">Figure 10-6. Transitions, interrupted</div> </div> 
<p id="yeeesh_that_do">Yeeesh, that doesn’t look good.</p> 
<p id="remember_from_t">Remember from 

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a> that newer transitions interrupt and override older 
<span class="keep-together">transitions</span>.  Clicking the bars initiates one transition.  Immediately mousing over a bar interrupts that initial transition in order to run the <code class="literal">mouseover</code> highlight transition we specified earlier.  The end result is that those moused-over bars never make it to their final destinations.</p> 
<p id="but_dont_worry">But don’t worry.  This example is just a good argument for keeping hover effects in CSS, while letting D3 and JavaScript manage the more visually intensive actions.</p> 
<p id="in__sort_hove">In 
<span class="emphasis">
<em>08_sort_hover.html</em></span>, I’ve restored the CSS-only highlight and removed the <code class="literal">mouseover</code> and <code class="literal">mouseout</code> event listeners, so this transition conflict no longer occurs.  (The only downside is we no longer have those smooth orange-to-blue fades.)</p> 
<p id="so_far_this_so">So far, this sort only goes one direction.  Let’s revise this so a second click triggers a re-sort, placing the bars in descending order.</p> 
<p id="to_remember_the">To remember the current state of the chart, we’ll need a Boolean variable:</p> 
<pre class="programlisting" data-language="javascript" id="var_sortorder_"><code class="kd">var</code> <code class="nx">sortOrder</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code></pre> 
<p id="then_in_the_so">Then, in the <code class="literal">sortBars()</code> function, we should flip the value of <code class="literal">sortOrder</code>, so if it starts out <code class="literal">true</code>, it is changed to <code class="literal">false</code>, and vice versa:</p> 
<pre class="programlisting" data-language="javascript" id="var_sortbars___id2"><code class="kd">var</code> <code class="nx">sortBars</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>          <code class="c1">//Flip value of sortOrder</code>         <code class="nx">sortOrder</code> <code class="o">=</code> <code class="o">!</code><code class="nx">sortOrder</code><code class="p">;</code>          <code class="err">…</code></pre> 
<p id="down_in_the_com">Down in the comparator function, we can add a bit of logic to say 
<span class="emphasis">
<em>if</em></span> <code class="literal">sortOrder</code> is <code class="literal">true</code>, then go ahead and sort

<a id="id552514" class="indexterm"></a>

<a id="id552520" class="indexterm"></a> the bars in 
<span class="emphasis">
<em>ascending</em></span> order.  Otherwise, use 
<span class="emphasis">
<em>descending</em></span> order:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id13">        <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>                         <code class="k">if</code> <code class="p">(</code><code class="nx">sortOrder</code><code class="p">)</code> <code class="p">{</code>                                 <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">);</code>                         <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>                                 <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">descending</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">);</code>                         <code class="p">}</code>                 <code class="p">})</code>                 <code class="err">…</code></pre> 
<p id="give_that_a_sho">Give that a shot in 
<span class="emphasis">
<em>09_resort.html</em></span>.  Now each time you click, the sort order reverses, as shown in 

<a class="xref" href="#second-sort" title="Figure 10-7. The second sort, now in descending order">Figure 10-7</a>.</p> 
<div class="figure" id="second-sort"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1007.png" alt="The second sort, now in descending order"></div></div> 
<div class="figure-title">Figure 10-7. The second sort, now in descending order</div> </div> 
<p id="one_more_thing__id2">One more thing would make this really nice: a per-element delay.  (Remember that whole “object constancy” thing?)</p> 
<p id="as_you_know_to">As you know, to do that, we just add a simple <code class="literal">delay()</code> statement after <code class="literal">transition()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="transition_id5"><code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="mi">50</code><code class="p">;</code> <code class="p">})</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code> <code class="err">…</code></pre> 
<p id="now_take_a_look">Now take a look at 
<span class="emphasis">
<em>10_delay.html</em></span>, in which you can easily follow individual bars with your eyes as they move left and right during each sort.

<a id="id552953" class="indexterm"></a></p> 
<div class="sidebar online_only" id="interactive_10-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Exercise</div></div></div></div> 
<p id="add_js_code_in_">Add JS code in the panel at left so that the labels sort along with the bars, and check the results in the output panel at right.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_10/10_delay.html" target="_blank">10_delay</a></p> 

<div class="sect1" data-original-filename="10_interactivity.asciidoc" id="_tooltips"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Tooltips</h2></div></div></div> 
<p id="in_interactive_">In interactive visualizations, tooltips are small overlays that present data values.  In many cases, it’s not necessary to label every individual data value in the default view, but that level of detail should still be accessible to users.  That’s where tooltips come in.

<a id="id553008" class="indexterm"></a>

<a id="ix_ttip" class="indexterm"></a>

<a id="id553027" class="indexterm"></a></p> 
<p id="in_this_section">In this section, I present three different methods to constructing tooltips with D3, ranging from the simplest to the most complex.</p> 
<div class="sect2" id="_default_browser_tooltips"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Default Browser Tooltips</h3></div></div></div> 
<p id="these_should_be">These should be your first stop.  A quick-and-dirty, functional but not pretty option, default browser tooltips are usually those ugly yellow boxes you see floating over content when you hold your mouse still for too long.  These are very easy to make, and the browser manages the placements for you, but you have zero control over how they look—that’s also set by the browser.

<a id="id553062" class="indexterm"></a></p> 
<p id="shows_our_bar_c">

<a class="xref" href="#safari-tooltip" title="Figure 10-8. A ridiculously simple default browser tooltip, as seen in Safari">Figure 10-8</a> shows our bar chart, with value labels removed, and default browser tooltips implemented.  The tooltips show up after hovering the mouse over any bar for a few seconds.</p> 
<div class="figure" id="safari-tooltip"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1008.png" alt="A ridiculously simple default browser tooltip, as seen in Safari"></div></div> 
<div class="figure-title">Figure 10-8. A ridiculously simple default browser tooltip, as seen in Safari</div> </div> 
<p id="see__browser__id1">See 
<span class="emphasis">
<em>11_browser_tooltip.html</em></span> for the code and a demo.  To make these tooltips, simply inject a <code class="literal">title</code> element into whatever element should have the tooltip applied.  For example, after we create all those <code class="literal">rect</code>s:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id14"><code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="err">…</code></pre> 
<p id="we_can_just_tac">we can just tack on to the end of that chain:</p> 
<pre class="programlisting" data-language="javascript" id="appendtitle_id1">   <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>          <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">});</code></pre> 
<p id="append_create_id2"><code class="literal">append()</code> creates the new <code class="literal">title</code> element, and then <code class="literal">text()</code> sets its content to <code class="literal">d</code>, the bound value.</p> 
<p id="we_could_make_t">We could make this text a little less spare by prefixing it with something (see 

<a class="xref" href="#default-tooltip" title="Figure 10-9. A default browser tooltip, with a prefix added">Figure 10-9</a>):</p> 
<pre class="programlisting" data-language="javascript" id="appendtitle_id2">   <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>          <code class="k">return</code> <code class="s2">"This value is "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">});</code></pre> 
<div class="figure" id="default-tooltip"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1009.png" alt="A default browser tooltip, with a prefix added"></div></div> 
<div class="figure-title">Figure 10-9. A default browser tooltip, with a prefix added</div> </div> 
<p id="see__browser__id2">See 
<span class="emphasis">
<em>12_browser_tooltip_text.html</em></span> for that code.</p> 
<div class="sidebar online_only" id="interactive_10-4"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="hover_over_the__id2">Hover over the bars in the graph to see corresponding tooltips.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_10/12_browser_tooltip_text.html" target="_blank">12_browser_tooltip_text</a></p> 

<div class="sect2" id="_svg_element_tooltips"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">SVG Element Tooltips</h3></div></div></div> 
<p id="for_more_visual">For more visual control over your tooltips, code them as SVG elements.

<a id="id553518" class="indexterm"></a>

<a id="id553526" class="indexterm"></a></p> 
<p id="as_usual_there">As usual, there are many different approaches you could take.  I’ll suggest adding event listeners, so on each <code class="literal">mouseover</code>, a new value label is created, and on <code class="literal">mouseout</code> it is destroyed.  (Another idea would be to pregenerate all the labels, but then just show or hide them based on mouse hover status.  Or just stick with one label, but show or hide it and change its position as needed.)</p> 
<p id="back_to_the_bar">Back to the bars we go.  We’ll add back in a <code class="literal">mouseover</code> event listener, in which we first get the <code class="literal">x</code> and <code class="literal">y</code> values for the current element (<code class="literal">this</code>, remember?).  We’ll need this information to know where to place the new tooltip, so it appears nicely “on top of” the bar that’s triggering the rollover.</p> 
<p id="when_we_retriev">When we retrieve those values, we wrap them in <code class="literal">parseFloat()</code>, which is a JavaScript function for “Hey, even if this information is a string of text, please convert it to a floating point number for me.”</p> 
<p id="lastly_im_add">Lastly, I’m adding a bit to both the <code class="literal">x</code> and <code class="literal">y</code> values, to center the new tooltips near the top of any given bar:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseover_id3"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">//Get this bar's x/y values, then augment for the tooltip</code> <code class="kd">var</code> <code class="nx">xPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">))</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">yPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">))</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code></pre> 
<p id="thats_the_hard">That’s the hard part.  Now all we do is create the tooltip as a simple <code class="literal">text</code> element, in this case, but of course you could add a background <code class="literal">rect</code> or do anything else here for visual effect:</p> 
<pre class="programlisting" data-language="javascript" id="create_the_to"><code class="c1">//Create the tooltip label</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"tooltip"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">xPosition</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">yPosition</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-family"</code><code class="p">,</code> <code class="s2">"sans-serif"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"11px"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-weight"</code><code class="p">,</code> <code class="s2">"bold"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>  <code class="p">})</code></pre> 
<p id="yes_this_is_ba">Yes, this is based on our earlier value label code, simply adapted slightly.  Note that the <code class="literal">x</code> and <code class="literal">y</code> attributes are set to the new position values we just calculated, and the actual text content of the label is set to <code class="literal">d</code>, the datum passed into the event listener function.</p> 
<p id="also_note_that__id3">Also note that I assigned this next <code class="literal">text</code> element an ID of <code class="literal">tooltip</code>.  This is so we can easily select (and delete!) the element when we’re done with it—on <code class="literal">mouseout</code>:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseout_id3"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>  <code class="c1">//Remove the tooltip</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">).</code><code class="nx">remove</code><code class="p">();</code>  <code class="p">})</code></pre> 
<p id="test_out_the_co">Test out the code in 
<span class="emphasis">
<em>13_svg_tooltip.html</em></span>.</p> 
<div class="sidebar online_only" id="interactive_10-5"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="hover_over_the__id3">Hover over the bars in the graph to see the custom tooltips.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_10/13_svg_tooltip.html" target="_blank">13_svg_tooltip</a></p> 

<p id="as_you_can_see__id1">As you can see in 

<a class="xref" href="#element-tooltip" title="Figure 10-10. An SVG element tooltip">Figure 10-10</a>, you have much more visual control when using SVG elements as tooltips, but they are a little more time-consuming to set up.  And of course, you can get much fancier than this simple example.</p> 
<div class="figure" id="element-tooltip"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1010.png" alt="An SVG element tooltip"></div></div> 
<div class="figure-title">Figure 10-10. An SVG element tooltip</div> </div> </div> 
<div class="sect2" id="_html_div_tooltips"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">HTML div Tooltips</h3></div></div></div> 
<p id="a_similar_appro">A similar approach can be used with HTML <code class="literal">div</code> elements as tooltips.  You might consider using a <code class="literal">div</code> when:</p> 
<div class="itemizedlist" id="you_want_to_ach_id1">
<ul class="itemizedlist"> 
<li class="listitem"> You want to achieve a visual effect that isn’t possible or well-supported with SVG (such as CSS drop shadows) </li> 
<li class="listitem"> You need the tooltips to extend beyond the frame of the SVG image

<a id="id554461" class="indexterm"></a>

<a id="id554469" class="indexterm"></a> </li> </ul></div> 
<p id="see_figures_and">See Figures 

<a class="xref" href="#div-tooltip" title="Figure 10-11. An HTML div tooltip">10-11</a> and 

<a class="xref" href="#overlapping-tooltip" title="Figure 10-12. An HTML div tooltip, overlapping the bounds of the SVG image beneath">10-12</a> for examples.</p> 
<div class="figure" id="div-tooltip"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1011.png" alt="An HTML div tooltip"></div></div> 
<div class="figure-title">Figure 10-11. An HTML div tooltip</div> </div> 
<div class="figure" id="overlapping-tooltip"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1012.png" alt="An HTML div tooltip, overlapping the bounds of the SVG image beneath"></div></div> 
<div class="figure-title">Figure 10-12. An HTML div tooltip, overlapping the bounds of the SVG image beneath</div> </div> 
<p id="again_there_ar">Again, there are many ways to do this, but I like to make a hidden <code class="literal">div</code> in my HTML that gets populated with the data value, and is then unhidden when triggered.  You can follow along with the final code in 
<span class="emphasis">
<em>14_div_tooltip.html</em></span>.</p> 
<p id="the_div_itself_">The <code class="literal">div</code> itself could be created dynamically with D3, but I like to just type it in by hand:</p> 
<pre class="programlisting" data-language="html" id="div_idtoolti"><code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"tooltip"</code> <code class="na">class=</code><code class="s">"hidden"</code><code class="nt">&gt;</code>         <code class="nt">&lt;p&gt;&lt;strong&gt;</code>Important Label Heading<code class="nt">&lt;/strong&gt;&lt;/p&gt;</code>         <code class="nt">&lt;p&gt;&lt;span</code> <code class="na">id=</code><code class="s">"value"</code><code class="nt">&gt;</code>100<code class="nt">&lt;/span&gt;</code>%<code class="nt">&lt;/p&gt;</code> <code class="nt">&lt;/div&gt;</code></pre> 
<p id="now_its_going_">Now it’s going to need some special CSS styling rules:</p> 
<pre class="programlisting" data-language="css" id="tooltip__posi"><code class="nf">#tooltip</code> <code class="p">{</code>         <code class="k">position</code><code class="o">:</code> <code class="k">absolute</code><code class="p">;</code>         <code class="k">width</code><code class="o">:</code> <code class="m">200px</code><code class="p">;</code>         <code class="k">height</code><code class="o">:</code> <code class="k">auto</code><code class="p">;</code>         <code class="k">padding</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">background-color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>         <code class="o">-</code><code class="k">webkit</code><code class="k">-</code><code class="k">border</code><code class="k">-</code><code class="k">radius</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">-</code><code class="k">moz</code><code class="k">-</code><code class="k">border</code><code class="k">-</code><code class="k">radius</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">border</code><code class="k">-</code><code class="k">radius</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">-</code><code class="k">webkit</code><code class="k">-</code><code class="k">box</code><code class="k">-</code><code class="k">shadow</code><code class="o">:</code> <code class="m">4px</code> <code class="m">4px</code> <code class="m">10px</code> <code class="n">rgba</code><code class="p">(</code><code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">.</code><code class="m">4</code><code class="p">);</code>         <code class="k">-</code><code class="k">moz</code><code class="k">-</code><code class="k">box</code><code class="k">-</code><code class="k">shadow</code><code class="o">:</code> <code class="m">4px</code> <code class="m">4px</code> <code class="m">10px</code> <code class="n">rgba</code><code class="p">(</code><code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">.</code><code class="m">4</code><code class="p">);</code>         <code class="k">box</code><code class="k">-</code><code class="k">shadow</code><code class="o">:</code> <code class="m">4px</code> <code class="m">4px</code> <code class="m">10px</code> <code class="n">rgba</code><code class="p">(</code><code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">.</code><code class="m">4</code><code class="p">);</code>         <code class="k">pointer</code><code class="k">-</code><code class="k">events</code><code class="o">:</code> <code class="k">none</code><code class="p">;</code> <code class="p">}</code>  <code class="nf">#tooltip</code><code class="nc">.hidden</code> <code class="p">{</code>         <code class="k">display</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code> <code class="p">}</code>  <code class="nf">#tooltip</code> <code class="nt">p</code> <code class="p">{</code>         <code class="k">margin</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>         <code class="k">font-family</code><code class="o">:</code> <code class="nb">sans-serif</code><code class="p">;</code>         <code class="k">font-size</code><code class="o">:</code> <code class="m">16px</code><code class="p">;</code>         <code class="k">line-height</code><code class="o">:</code> <code class="m">20px</code><code class="p">;</code> <code class="p">}</code></pre> 
<p id="note_in_particu">Note in particular that its <code class="literal">position</code> is <code class="literal">absolute</code>, so we can control exactly where it should appear on the page.  I’ve also added some fancy rounded corners and a drop shadow.  Plus, <code class="literal">pointer-events: none</code> ensures that mousing over the tooltip itself won’t trigger a <code class="literal">mouseout</code> event on the bars, thereby hiding the tooltip.  (Try the code without this line, and you’ll see what I mean.)  Lastly, when the tooltip is given a class of 
<span class="keep-together"><code class="literal">hidden</code></span>, it is not displayed.

<a id="id555381" class="indexterm"></a></p> 
<p id="i_made_some_mod">I made some modifications to the <code class="literal">mouseover</code> function, so the <code class="literal">div</code> is roughly centered vertically against its triggering bar.  The revised code now also sets the tooltip’s <code class="literal">left</code> and <code class="literal">top</code> position per CSS layout requirements, sets the text content of the <code class="literal">#value</code> span to <code class="literal">d</code>, and then—now that everything is in place—removes the <code class="literal">hidden</code> class, making the tooltip visible:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseover_id4"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">//Get this bar's x/y values, then augment for the tooltip</code> <code class="kd">var</code> <code class="nx">xPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">))</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">yPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">))</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="nx">h</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>  <code class="c1">//Update the tooltip position and value</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="nx">xPosition</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="nx">yPosition</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#value"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>  <code class="c1">//Show the tooltip</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">).</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"hidden"</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code>  <code class="p">})</code></pre> 
<p id="hiding_the_tool">Hiding the tooltip on <code class="literal">mouseout</code> is much easier; simply add on the <code class="literal">hidden</code> class:</p> 
<pre class="programlisting" data-language="javascript" id="onmouseout_id4"><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>  <code class="c1">//Hide the tooltip</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">).</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"hidden"</code><code class="p">,</code> <code class="kc">true</code><code class="p">);</code>  <code class="p">})</code></pre> 
<div class="sidebar online_only" id="interactive_10-6"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="hover_over_the__id4">Hover over the bars in the graph to see the custom &lt;div&gt; tooltips.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_10/14_div_tooltip.html" target="_blank">14_div_tooltip</a></p> 

<div class="warning" id="the_layout_of_t_id1">
<p id="the_layout_of_t_id2">The layout of this simple example works well, but in a real-world situation, the D3 chart would be just one of many other elements on the page.  As you probably know, perfecting HTML/CSS layouts can be a challenge, and this is the biggest hassle of getting HTML elements to interact properly with an SVG chart.  It can help to put both the tooltip <code class="literal">div</code> and SVG chart within the same enclosing element (like a container <code class="literal">div</code>), so then you only have to worry about relative positions.  

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-d3_mouse" target="_top"><code class="literal">d3.mouse</code></a> can be used to get mouse coordinates relative to any other element on the page, and can be useful in cases when you need to position non-SVG elements in relationship to the mouse.</p></div> </div> </div> 
<div class="sect1" data-original-filename="10_interactivity.asciidoc" id="_consideration_for_touch_devices"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Consideration for Touch Devices</h2></div></div></div> 
<p id="the_browsers_on">The browsers on most popular touch devices—such as iOS and Android devices—automatically translate touch events into mouse events, for JavaScript purposes.  So a tap on an element is interpreted by the browser as a <code class="literal">click</code> event.  This means that, for the most part, your code that was crafted for mouse interfaces will also work just fine for touch-based interfaces.

<a id="id556150" class="indexterm"></a>

<a id="id556156" class="indexterm"></a>

<a id="id556162" class="indexterm"></a>

<a id="id556167" class="indexterm"></a></p> 
<p id="the_primary_exc">The primary exception to this is multitouch, which is not automagically handled by D3.  There’s no easy answer on how to handle multitouch interactions yet, but D3 
<span class="emphasis">
<em>does</em></span> track the touches for you (although it’s up to you to decide how to use them).  See the 
<span class="keep-together">API reference</span> for 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-d3_touches" target="_top"><code class="literal">d3.touches</code></a>.</p> </div> 
<div class="sect1" data-original-filename="10_interactivity.asciidoc" id="_moving_forward"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Moving Forward</h2></div></div></div> 
<p id="congratulations_id2">Congratulations!  You now have all the basics of D3 under your cap.  You are a pro at binding data, generating and styling elements based on that data, implementing scales and drawing axes, and modifying your creations with new data, animated transitions, and interactivity.  What more could you ask for?</p> 
<p id="how_about_layou">How about layouts and geomaps?  The next two chapters will dive into these more advanced topics, but—be warned—without the same level of detail as the prior chapters.  Now that you know the basics, you don’t need every little thing spelled out. Here we go!

<a id="id556234" class="indexterm"></a></p>
<section class="chapter" data-original-filename="11_layouts.asciidoc" id="chapter11-layouts">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 11. Layouts</h1></div></div></div> 
<p id="contrary_to_wha_id2">Contrary to what the name implies, D3 
<span class="emphasis">
<em>layouts</em></span> do not, in fact, lay anything out for you on the screen.  The layout methods have no direct 
<span class="emphasis">
<em>visual</em></span> output.  Rather, D3 layouts take data that you provide and remap or otherwise transform it, thereby generating 
<span class="emphasis">
<em>new</em></span> data that is more convenient for a specific visual task.  It’s still up to you to take that new data and generate visuals from it.

<a id="ix_lay" class="indexterm"></a>

<a id="id556286" class="indexterm"></a></p> 
<p id="here_is_a_compl">Here is a complete list of all D3 layouts:</p> 
<div class="itemizedlist" id="bundle_chord_cl">
<ul class="itemizedlist"> 
<li class="listitem"> Bundle </li> 
<li class="listitem"> Chord </li> 
<li class="listitem"> Cluster </li> 
<li class="listitem"> Force </li> 
<li class="listitem"> Histogram </li> 
<li class="listitem"> Pack </li> 
<li class="listitem"> Partition </li> 
<li class="listitem"> Pie </li> 
<li class="listitem"> Stack </li> 
<li class="listitem"> Tree </li> 
<li class="listitem"> Treemap </li> </ul></div> 
<p id="in_this_chapter">In this chapter, I introduce three of the most common: 
<span class="emphasis">
<em>pie</em></span>, 
<span class="emphasis">
<em>stack</em></span>, and 
<span class="emphasis">
<em>force</em></span>.  Each layout performs a different function, and each has its own idiosyncrasies.</p> 
<p id="if_you_are_curi">If you are curious about any of the other D3 layouts, check out 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Gallery" target="_top">the many examples on the D3 website</a>, and be sure to reference 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Layouts" target="_top">the official API documentation on layouts</a>.</p> 
<div class="sect1" data-original-filename="11_layouts.asciidoc" id="_pie_layout"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Pie Layout</h2></div></div></div> 
<p id="dlayoutpie"><code class="literal">d3.layout.pie()</code> might not be as delicious as it sounds, but it’s still worthy of your attention.  Obviously, its typical use is for creating pie charts, like the example in 

<a class="xref" href="#simple_pie_chart" title="Figure 11-1. A simple pie chart">Figure 11-1</a>.</p> 
<div class="figure" id="simple_pie_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1101.png" alt="A simple pie chart"></div></div> 
<div class="figure-title">Figure 11-1. A simple pie chart</div> </div> 
<p id="feel_free_to_op">Feel free to open up the sample code for this in 
<span class="emphasis">
<em>01_pie.html</em></span> and poke around.

<a id="id556477" class="indexterm"></a>

<a id="id556485" class="indexterm"></a>

<a id="id556491" class="indexterm"></a></p> 
<p id="to_draw_those_p">To draw those pretty wedges, we need to know a number of measurements, including an inner and outer radius for each wedge, plus the starting and ending angles.  The purpose of the pie layout is to take your data and calculate all those messy angles for you, sparing you from ever having to think about radians.</p> 
<p id="remember_radian">Remember radians?  In case you don’t, here’s a quick refresher.  Just as there are 360° in a circle, there are 2π radians.  So π radians equals 180°, or half a circle.  Most people find it easier to think in terms of degrees; computers prefer radians.

<a id="id556518" class="indexterm"></a>

<a id="id556523" class="indexterm"></a></p> 
<p id="for_this_pie_ch">For this pie chart, let’s start, as usual, with a very simple dataset:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id19"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">45</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code></pre> 
<p id="we_can_define_a">We can define a default pie layout very simply as:</p> 
<pre class="programlisting" data-language="javascript" id="var_pie__dla"><code class="kd">var</code> <code class="nx">pie</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">pie</code><code class="p">();</code></pre> 
<p id="then_all_that_">Then, all that remains is to hand off our data to the new <code class="literal">pie()</code> function, as in 
<span class="keep-together"><code class="literal">pie(dataset)</code></span>.  Compare the datasets before and after in 

<a class="xref" href="#pieified_data" title="Figure 11-2. Your data, pie-ified">Figure 11-2</a>.</p> 
<div class="figure" id="pieified_data"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1102.png" alt="Your data, pie-ified"></div></div> 
<div class="figure-title">Figure 11-2. Your data, pie-ified</div> </div> 
<p id="the_pie_layout_">The pie layout takes our simple array of numbers and generates an array of objects, one object for each value.  Each of those objects now has a few new values—most important, <code class="literal">startAngle</code> and <code class="literal">endAngle</code>.  Wow, that was easy!</p> 
<p id="now_to_actuall">Now, to actually draw the wedges, we turn to <code class="literal">d3.svg.arc()</code>, a handy built-in function for drawing arcs as SVG <code class="literal">path</code> elements.  We haven’t talked about <code class="literal">path</code>s yet, but they are SVG’s answer to drawing irregular forms.  Anything that’s not a <code class="literal">rect</code>, <code class="literal">circle</code>, or another basic shape can be drawn as a <code class="literal">path</code>.  The catch is, the syntax for defining <code class="literal">path</code> values is not particularly human-friendly.

<a id="id556797" class="indexterm"></a>

<a id="id556803" class="indexterm"></a>  For example, here’s the code for the big, red wedge in 

<a class="xref" href="#simple_pie_chart" title="Figure 11-1. A simple pie chart">Figure 11-1</a>:</p> 
<pre class="programlisting" data-language="html" id="path_filld"><code class="nt">&lt;path</code> <code class="na">fill=</code><code class="s">"#d62728"</code> <code class="na">d=</code><code class="s">"M9.184850993605149e-15,-150A150,150 0 0,1</code> <code class="s">        83.99621792063931,124.27644738657631L0,0Z"</code><code class="nt">&gt;&lt;/path&gt;</code></pre> 
<p id="if_you_can_unde">If you can understand that, then you don’t need this book.</p> 
<p id="the_bottom_line">The bottom line is, it’s best to let functions like <code class="literal">d3.svg.arc()</code> handle generating <code class="literal">path</code>s programatically.  You don’t want to try writing this stuff out by hand.</p> 
<p id="arcs_are_define">Arcs are defined as custom functions, and they require inner and outer radius values:</p> 
<pre class="programlisting" data-language="javascript" id="var_w___va_id2"><code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>  <code class="kd">var</code> <code class="nx">outerRadius</code> <code class="o">=</code> <code class="nx">w</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">innerRadius</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">arc</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">arc</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">innerRadius</code><code class="p">(</code><code class="nx">innerRadius</code><code class="p">)</code>                 <code class="p">.</code><code class="nx">outerRadius</code><code class="p">(</code><code class="nx">outerRadius</code><code class="p">);</code></pre> 
<p id="here_im_settin">Here I’m setting the size of the whole chart to be 300 by 300 square.  Then I’m setting the <code class="literal">outerRadius</code> to half of that, or 150.  The <code class="literal">innerRadius</code> is zero.  We’ll revisit 
<span class="keep-together"><code class="literal">innerRadius</code></span> in a moment.</p> 
<p id="were_ready_to_">We’re ready to draw some wedges!  First, we create the SVG element, per usual:</p> 
<pre class="programlisting" data-language="javascript" id="create_svg_el_id3"><code class="c1">//Create SVG element</code> <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code></pre> 
<p id="then_we_can_cre">Then we can create new groups for each incoming wedge, binding the pie-ified data to the new elements, and translating each group into the center of the chart, so the <code class="literal">path</code>s will appear in the right place:</p> 
<pre class="programlisting" data-language="javascript" id="set_up_groups"><code class="c1">//Set up groups</code> <code class="kd">var</code> <code class="nx">arcs</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"g.arc"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">pie</code><code class="p">(</code><code class="nx">dataset</code><code class="p">))</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"arc"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">outerRadius</code> <code class="o">+</code> <code class="s2">", "</code> <code class="o">+</code> <code class="nx">outerRadius</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code></pre> 
<p id="note_that_were">Note that we’re saving a reference to each newly created <code class="literal">g</code> in a variable called <code class="literal">arcs</code>.</p> 
<p id="finally_within">Finally, within each new <code class="literal">g</code>, we append a <code class="literal">path</code>.  A <code class="literal">path</code>s path description is defined in the <code class="literal">d</code> attribute.  So here we call the <code class="literal">arc</code> generator, which generates the path information based on the data already bound to this group:</p> 
<pre class="programlisting" data-language="javascript" id="draw_arc_path"><code class="c1">//Draw arc paths</code> <code class="nx">arcs</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">color</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">arc</code><code class="p">);</code></pre> 
<p id="oh_and_you_mig">Oh, and you might be wondering where those colors are coming from.  If you check out 
<span class="emphasis">
<em>01_pie.html</em></span>, you’ll note this line:</p> 
<pre class="programlisting" data-language="javascript" id="var_color__d_id1"><code class="kd">var</code> <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category10</code><code class="p">();</code></pre> 
<p id="d_has_a_number">D3 has a number of handy ways to generate categorical colors.  These might not be your favorite colors, but they are quick to drop into any visualization while you’re in the prototyping stage.  <code class="literal">d3.scale.category10()</code> creates an 
<span class="emphasis">
<em>ordinal</em></span> scale with an output range of 10 different colors.  (See 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Ordinal-Scales" target="_top">the wiki</a> for more information on these color scales as well as perceptually calibrated color palettes, based on research by Cynthia Brewer, that are included with D3.)

<a id="id557821" class="indexterm"></a>

<a id="id557827" class="indexterm"></a>

<a id="id557833" class="indexterm"></a></p> 
<p id="lastly_we_can_">Lastly, we can generate text labels for each wedge:</p> 
<pre class="programlisting" data-language="javascript" id="arcsappendte"><code class="nx">arcs</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">arc</code><code class="p">.</code><code class="nx">centroid</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>     <code class="p">});</code></pre> 
<p id="note_that_in_te">Note that in <code class="literal">text()</code>, we reference the value with <code class="literal">d.value</code> instead of just <code class="literal">d</code>.  This is because we bound the pie-ified data, so instead of referencing our original array (<code class="literal">d</code>), we have to reference the array of objects (<code class="literal">d.value</code>).</p> 
<p id="the_only_thing_">The only thing new here is <code class="literal">arc.centroid(d)</code>.  WTH?  A 
<span class="emphasis">
<em>centroid</em></span> is the calculated center point of any shape, whether that shape is regular (like a square) or highly irregular (like an outline of the state of Maryland).  <code class="literal">arc.centroid()</code> is a super-helpful function that calculates and returns the center point of any arc.  We translate each <code class="literal">text</code> label element to each arc’s centroid, and that’s how we get the text labels to float right in the middle of each wedge.

<a id="id558152" class="indexterm"></a></p> 
<div class="sidebar online_only" id="interactive_11-1"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="try_changing_th">Try changing the values in <code class="literal">dataset</code> and see how this affects the rendering of the pie chart.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_11/01_pie.html" target="_blank">01_pie</a></p> 

<p id="bonus_tip_reme">Bonus tip:  Remember how <code class="literal">arc()</code> required an <code class="literal">innerRadius</code> value?  We can expand that to anything greater than zero, and our pie chart becomes a 
<span class="emphasis">
<em>ring</em></span> chart like the one

<a id="id558209" class="indexterm"></a>

<a id="id558215" class="indexterm"></a> shown in 

<a class="xref" href="#simple_ring_chart" title="Figure 11-3. A simple ring chart">Figure 11-3</a>:</p> 
<pre class="programlisting" data-language="javascript" id="var_innerradius"><code class="kd">var</code> <code class="nx">innerRadius</code> <code class="o">=</code> <code class="nx">w</code> <code class="o">/</code> <code class="mi">3</code><code class="p">;</code></pre> 
<div class="figure" id="simple_ring_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1103.png" alt="A simple ring chart"></div></div> 
<div class="figure-title">Figure 11-3. A simple ring chart</div> </div> 
<p id="check_it_out_in_id2">Check it out in 
<span class="emphasis">
<em>02_ring.html</em></span>.</p> 
<div class="sidebar online_only" id="interactive_11-2"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="experiment_with_id5">Experiment with changing the values in <code class="literal">dataset</code> and see how this affects the rendering of the ring chart.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_11/02_ring.html" target="_blank">02_ring</a></p> 

<p id="one_more_thing_id3">One more thing:  The pie layout automatically reordered our data values from largest to smallest.  Remember, we started with <code class="literal">[ 5, 10, 20, 45, 6, 25 ]</code>, so the small value of 6 should have appeared between 45 and 25, but no—the layout sorted our values in descending order, so the chart began with 45 at the 12 o’clock position, and everything just goes clockwise from there.</p> </div> 
<div class="sect1" data-original-filename="11_layouts.asciidoc" id="_stack_layout"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Stack Layout</h2></div></div></div> 
<p id="dlayoutstack"><code class="literal">d3.layout.stack()</code> converts two-dimensional data into “stacked” data; it calculates a baseline value for each datum, so you can “stack” layers of data on top of one another.  This can be used to generate stacked bar charts, stacked area charts, and even 
<span class="keep-together">streamgraphs</span> (which are just stacked area charts but without the rigid starting baseline value of zero).

<a id="id558380" class="indexterm"></a>

<a id="id558388" class="indexterm"></a>

<a id="id558393" class="indexterm"></a></p> 
<p id="for_example_we">For example, we’ll start with the stacked bar chart in 

<a class="xref" href="#simple_stacked_bar_chart" title="Figure 11-4. A simple stacked bar chart">Figure 11-4</a>.</p> 
<div class="figure" id="simple_stacked_bar_chart"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1104.png" alt="A simple stacked bar chart"></div></div> 
<div class="figure-title">Figure 11-4. A simple stacked bar chart</div> </div> 
<p id="lets_say_you_h">Let’s say you had some data like this:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id20"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">22</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">28</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">19</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">32</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">23</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">35</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">23</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">17</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">43</code> <code class="p">}</code> <code class="p">];</code></pre> 
<p id="the_first_step_">The first step is to rearrange that data into an array of arrays.  Each array represents the data for one category (e.g., apples, oranges, or grapes).  Within each category array, you’ll need an object for each data value, which itself must contain an <code class="literal">x</code> and a <code class="literal">y</code> value.  The <code class="literal">x</code> in our case is just an ID number.  The <code class="literal">y</code> is the actual data value:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id21"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>         <code class="p">[</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">4</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">2</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">7</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">23</code> <code class="p">}</code>         <code class="p">],</code>         <code class="p">[</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">10</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">12</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">19</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">23</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">17</code> <code class="p">}</code>         <code class="p">],</code>         <code class="p">[</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">22</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">28</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">32</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">35</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">43</code> <code class="p">}</code>         <code class="p">]</code> <code class="p">];</code></pre> 
<p id="our_original_da">Our original <code class="literal">dataset</code> looks like 

<a class="xref" href="#prestacked_data" title="Figure 11-5. The data before stacking">Figure 11-5</a> in the console.</p> 
<div class="figure" id="prestacked_data"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1105.png" alt="The data before stacking"></div></div> 
<div class="figure-title">Figure 11-5. The data before stacking</div> </div> 
<p id="then_we_initial">Then we initialize our stack layout function, and call it on <code class="literal">dataset</code>:</p> 
<pre class="programlisting" data-language="javascript" id="var_stack__d"><code class="kd">var</code> <code class="nx">stack</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">stack</code><code class="p">();</code> <code class="nx">stack</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code></pre> 
<p id="now_the_stacked">Now the stacked data is shown in 

<a class="xref" href="#stacked_data" title="Figure 11-6. The data after stacking">Figure 11-6</a>.</p> 
<div class="figure" id="stacked_data"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1106.png" alt="The data after stacking"></div></div> 
<div class="figure-title">Figure 11-6. The data after stacking</div> </div> 
<p id="can_you_spot_th">Can you spot the difference?  In the stacked data, each object has been given a <code class="literal">y0</code> value.  This is the 
<span class="emphasis">
<em>baseline</em></span> value.  Notice that the <code class="literal">y0</code> baseline value is equal to the sum of all the <code class="literal">y</code> values in the preceding categories.  For example, reading left to right across the top, the first object’s <code class="literal">y</code> value is 5, and its <code class="literal">y0</code> is zero.  To the right (in the oranges column), the first object has a <code class="literal">y</code> value of 10, and a <code class="literal">y0</code> of 5.  (Aha! That’s just the value of the first object’s <code class="literal">y</code>!)  On the far right (in the grapes column), we see a <code class="literal">y</code> value of 22, and a <code class="literal">y0</code> of 15 (which is just 5 + 10).</p> 
<p id="to_stack_elem">To “stack” elements visually, now we can reference each data object’s baseline value as well as its height.  See all the code in 
<span class="emphasis">
<em>03_stacked_bar.html</em></span>.  (I leave it as an exercise to you to align the stacks against the bottom x-axis.)  Here’s the critical excerpt:</p> 
<pre class="programlisting" data-language="javascript" id="var_rects__gro"><code class="kd">var</code> <code class="nx">rects</code> <code class="o">=</code> <code class="nx">groups</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">})</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y0</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">());</code></pre> 
<p id="note_how_for_y_">Note how for <code class="literal">y</code> and <code class="literal">height</code> we reference <code class="literal">d.y0</code> and <code class="literal">d.y</code>, respectively.</p> 
<div class="sidebar online_only" id="interactive_11-3"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Exercise</div></div></div></div> 
<p id="add_code_to_the">Add code to the panel at left to align the stacked bars against the x-axis, and check the results in the output panel at right</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_11/03_stacked_bar.html" target="_blank">03_stacked_bar</a></p> 

<div class="sect1" data-original-filename="11_layouts.asciidoc" id="_force_layout"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Force Layout</h2></div></div></div> 
<p id="forcedirected_">Force-directed layouts are so-called because they use simulations of physical 
<span class="emphasis">
<em>forces</em></span> to arrange elements on the screen.  Arguably, they are a bit overused, yet they make a great demo and just look 
<span class="emphasis">
<em>so darn cool</em></span>.  Everyone wants to learn how to make one, so let’s talk about it.

<a id="ix_lflay" class="indexterm"></a>

<a id="ix_force" class="indexterm"></a></p> 
<p id="force_layouts_a">Force layouts are typically used with network data.  In computer science, this kind of dataset is called a 
<span class="emphasis">
<em>graph</em></span>.  A simple graph is a list of 
<span class="emphasis">
<em>nodes</em></span> and 
<span class="emphasis">
<em>edges</em></span>.  The nodes are entities in the dataset, and the edges are the 
<span class="emphasis">
<em>connections</em></span> between nodes.  Some nodes will be connected by edges, and others won’t.  Nodes are commonly represented as circles, and edges as lines.  But of course the visual representation is up to you—D3 just helps manage all the mechanics behind the scenes.

<a id="id560340" class="indexterm"></a>

<a id="id560351" class="indexterm"></a>

<a id="id560356" class="indexterm"></a></p> 
<p id="the_physical_me">The physical metaphor here is of particles that repel each other, yet are also connected by springs.  The repelling forces push particles away from each other, preventing visual overlap, and the springs prevent them from just flying out into space, thereby keeping them on the screen where we can see them.</p> 
<p id="provides_a_visu">

<a class="xref" href="#force_layouta" title="Figure 11-7. A simple force layout">Figure 11-7</a> provides a visual preview of what we’re coding toward.</p> 
<div class="figure" id="force_layouta"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1107.png" alt="A simple force layout"></div></div> 
<div class="figure-title">Figure 11-7. A simple force layout</div> </div> 
<p id="ds_force_layo">D3’s force layout expects us to provide nodes and edges separately, as arrays of objects.  Here we have one <code class="literal">dataset</code> object that contains two elements, <code class="literal">nodes</code> and <code class="literal">edges</code>, each of which is itself an array of objects:</p> 
<pre class="programlisting" data-language="javascript" id="var_dataset___id22"><code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">{</code>         <code class="nx">nodes</code><code class="o">:</code> <code class="p">[</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Adam"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Bob"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Carrie"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Donovan"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Edward"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Felicity"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"George"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Hannah"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Iris"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Jerry"</code> <code class="p">}</code>         <code class="p">],</code>         <code class="nx">edges</code><code class="o">:</code> <code class="p">[</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">2</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">3</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">4</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">4</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">8</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">9</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">6</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">7</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">8</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">8</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">9</code> <code class="p">}</code>         <code class="p">]</code> <code class="p">};</code></pre> 
<p id="as_usual_for_d">As usual for D3, you can store whatever data you like within these objects.  Our nodes are simple—just names of people.  The edges contain two values each: a source ID and a target ID.  These IDs correspond to the nodes above, so ID number 3 is Donovan, for example.  If 3 is connected to 4, then Donovan is connected to Edward.</p> 
<p id="the_data_shown_">The data shown is a bare minimum for using the force layout.  You can add more information, and, in fact, D3 will itself add a lot more data to what we’ve provided, as we’ll see in a moment.</p> 
<p id="heres_how_to_i">Here’s how to initialize a force layout:</p> 
<pre class="programlisting" data-language="javascript" id="var_force__d_id1"><code class="kd">var</code> <code class="nx">force</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">force</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">edges</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">w</code><code class="p">,</code> <code class="nx">h</code><code class="p">])</code>                      <code class="p">.</code><code class="nx">start</code><code class="p">();</code></pre> 
<p id="again_this_is_">Again, this is just the bare minimum.  We specify the nodes and links to be used, the size of the available space, and then call <code class="literal">start()</code> when we’re ready to go.</p> 
<p id="this_generates_">This generates a default force layout, but the default won’t be ideal for every dataset.  As you would expect, there are all kinds of options for customization.  

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Force-Layout" target="_top">See the API wiki</a> for all the gory details.  Here, I’ve increased the <code class="literal">linkDistance</code> (the length of the edges between connected nodes) as well as the negative <code class="literal">charge</code> between nodes, so they will repel each other more.  (It’s not personal; I just want them to spread out a bit.)</p> 
<pre class="programlisting" data-language="javascript" id="var_force__d_id2"><code class="kd">var</code> <code class="nx">force</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">force</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">edges</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">w</code><code class="p">,</code> <code class="nx">h</code><code class="p">])</code>                      <code class="p">.</code><code class="nx">linkDistance</code><code class="p">([</code><code class="mi">50</code><code class="p">])</code>        <code class="c1">// &lt;-- New!</code>                      <code class="p">.</code><code class="nx">charge</code><code class="p">([</code><code class="o">-</code><code class="mi">100</code><code class="p">])</code>            <code class="c1">// &lt;-- New!</code>                      <code class="p">.</code><code class="nx">start</code><code class="p">();</code></pre> 
<p id="next_we_create">Next, we create an SVG line for each edge:</p> 
<pre class="programlisting" data-language="javascript" id="var_edges__svg"><code class="kd">var</code> <code class="nx">edges</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">edges</code><code class="p">)</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"#ccc"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code></pre> 
<p id="note_that_i_set">Note that I set all the lines to have the same stroke color and weight, but of course you could set this dynamically based on data (say, thicker or darker lines for “stronger” connections, or some other value).</p> 
<p id="then_we_create">Then, we create an SVG circle for each node:</p> 
<pre class="programlisting" data-language="javascript" id="var_nodes__svg"><code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">colors</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">drag</code><code class="p">);</code></pre> 
<p id="i_set_all_circl">I set all circles to have the same radius, but each gets a different color fill, just because it’s prettier that way.  Of course, these values could be set dynamically, too, for a more useful visualization.</p> 
<p id="youll_notice_t_id2">You’ll notice the last line of code, which enabled drag-and-drop interaction.  (Comment that out, and the user won’t be able to move nodes around.)</p> 
<p id="lastly_we_have">Lastly, we have to specify what happens when the force layout “ticks.”  Yes, these ticks are different from the axis ticks addressed earlier, and definitely different from those little blood-sucking insects.  Physics simulations use the word “tick” to refer to the passage of some amount of time, like the ticking second hand of a clock.  For example, if an animation were running at 30 frames per second, you could have one tick represent 1/30th of a second.  Then each time the simulation ticked, you’d see the calculations of motion update in real time.  In some applications, it’s useful to run ticks faster than actual time. For example, if you were trying to model the effects of climate change on the planet 50 years from now, you wouldn’t want to wait 50 years to see the results, so you’d program the system to tick on ahead, faster than real time.

<a id="id562279" class="indexterm"></a></p> 
<p id="for_our_purpose_id2">For our purposes, what you need to know is that D3’s force layout “ticks” forward through time, just like every other physics simulation.  With each tick, the force layout adjusts the position values for each node and edge according to the rules we specified when the layout was first intialized.  To see this progress visually, we need to update the associated elements—the lines and circles:</p> 
<pre class="programlisting" data-language="javascript" id="forceontick"><code class="nx">force</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"tick"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>  <code class="nx">edges</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code> <code class="p">});</code>  <code class="nx">nodes</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code> <code class="p">});</code>  <code class="p">});</code></pre> 
<p id="this_tells_d_">This tells D3, “Okay, every time you tick, take the new x/y values for each line and circle and update them in the DOM.”</p> 
<p id="wait_a_minute_">Wait a minute.  Where did these x/y values come from?  We had only specified <code class="literal">name</code>s, <code class="literal">source</code>s, and <code class="literal">target</code>s!</p> 
<p id="d_calculated_t">D3 calculated those x/y values and appended them to the existing objects in our original <code class="literal">dataset</code> (see 

<a class="xref" href="#force_data_added" title="Figure 11-8. The first node in dataset, with lots of supplemental data added by D3">Figure 11-8</a>).  Go ahead and open up 
<span class="emphasis">
<em>04_force.html</em></span>, and type 
<span class="strong">
<strong><code class="literal">dataset</code></strong></span> into the console.  Expand any node or edge, and you’ll see lots of additional data that we didn’t provide.  That’s where D3 stores the information it needs to continue running the physics simulation.  With <code class="literal">on("tick", …)</code>, we are just specifying how to take those updated coordinates and map them on to the visual elements in the DOM.</p> 
<div class="figure" id="force_data_added"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1108.png" alt="The first node in dataset, with lots of supplemental data added by D3"></div></div> 
<div class="figure-title">Figure 11-8. The first node in dataset, with lots of supplemental data added by D3</div> </div> 
<p id="the_final_resul">The final result, then, is the lovely entanglement displayed in 

<a class="xref" href="#force_layout" title="Figure 11-9. A simple force layout with 10 nodes and 12 edges">Figure 11-9</a>.</p> 
<div class="figure" id="force_layout"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1109.png" alt="A simple force layout with 10 nodes and 12 edges"></div></div> 
<div class="figure-title">Figure 11-9. A simple force layout with 10 nodes and 12 edges</div> </div> 
<p id="again_you_can_">Again, you can run the final code youself in 
<span class="emphasis">
<em>04_force.html</em></span>.</p> 
<div class="sidebar online_only" id="interactive_11-4"> 
<div class="titlepage">
<div>
<div>
<div class="sidebar-title">Try It Now!</div></div></div></div> 
<p id="interact_with_t">Interact with the force diagram below by clicking and dragging the nodes.</p> 
<div class="interactive"> 
<p class="outlink">

<a href="http://examples.oreilly.com/0636920026938/chapter_11/04_force.html" target="_blank">04_force</a></p> 

<p id="note_that_each_">Note that each time you reload the page, the circles and lines spring to life, eventually resting in a state of equilibrium.  But that final state of rest is different every time because there is an element of randomness to how the circles enter the stage.  This illustrates the unpredictable nature of force-based layouts:  they might be quite different each time you use them, and they rely on the data to provide structure.  If your data is more structured, you might get a better visual result.</p> 
<p id="interactivity_c">Interactivity can be useful for improving our view of the data.  I don’t like how the edges overlap here, so I’ll drag the pink circle out and around (see 

<a class="xref" href="#force_drag" title="Figure 11-10. Dragging a node to change the arrangement of nodes">Figure 11-10</a>), then I’ll move the red one up and to the left (see 

<a class="xref" href="#force_drag_2" title="Figure 11-11. Dragging some more to untangle nodes">Figure 11-11</a>).</p> 
<div class="figure" id="force_drag"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1110.png" alt="Dragging a node to change the arrangement of nodes"></div></div> 
<div class="figure-title">Figure 11-10. Dragging a node to change the arrangement of nodes</div> </div> 
<div class="figure" id="force_drag_2"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1111.png" alt="Dragging some more to untangle nodes"></div></div> 
<div class="figure-title">Figure 11-11. Dragging some more to untangle nodes</div> </div> 
<p id="as_a_bonus_int">As a bonus, interactivity + physics simulation = irresistable demo.  I can’t explain it, but it’s true.  For some reason, we humans just love seeing real-world things replicated on screens.

<a id="id563073" class="indexterm"></a>

<a id="id563082" class="indexterm"></a>

<a id="id563092" class="indexterm"></a></p>
<section class="chapter" data-original-filename="12_geomapping.asciidoc" id="_geomapping_2">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 12. Geomapping</h1></div></div></div> 
<p id="bar_charts_sca">Bar charts, scatterplots, ring charts, and even force-directed graphs…  
<span class="emphasis">
<em>Yeah, that’s all okay</em></span>, you’re thinking, 
<span class="emphasis">
<em>but get to the maps already!</em></span></p> 
<div class="sect1" data-original-filename="12_geomapping.asciidoc" id="_json_meet_geojson"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">JSON, Meet GeoJSON</h2></div></div></div> 
<p id="youve_already_">You’ve already met JSON.  Now meet GeoJSON, the JSON-based standard for encoding geodata for web applications.  GeoJSON actually is not a totally different format, but just a very specific use of JSON.

<a id="ix_geom" class="indexterm"></a>

<a id="id563156" class="indexterm"></a>

<a id="id563162" class="indexterm"></a>

<a id="id563170" class="indexterm"></a>

<a id="id563175" class="indexterm"></a></p> 
<p id="before_you_can__id2">Before you can generate a geographic map, you need to acquire the path data (the outlines) for the shapes you want to display.  We’ll start with a common example, mapping US state boundaries.  I’ve included a file 
<span class="emphasis">
<em>us-states.json</em></span> with the sample code.  This file is taken directly from one of the D3 examples, and we owe Mike Bostock a word of thanks for generating this nice, clean file of state boundaries.</p> 
<p id="opening_up_uss">Opening up 
<span class="emphasis">
<em>us-states.json</em></span>, you’ll see it looks something like this (reformatted and greatly abbreviated here):</p> 
<pre class="programlisting" data-language="javascript" id="type_feat_id2"><code class="p">{</code>   <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"FeatureCollection"</code><code class="p">,</code>   <code class="s2">"features"</code><code class="o">:</code> <code class="p">[</code>      <code class="p">{</code>        <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code>        <code class="s2">"id"</code><code class="o">:</code> <code class="s2">"01"</code><code class="p">,</code>        <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Alabama"</code> <code class="p">},</code>        <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code>          <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Polygon"</code><code class="p">,</code>          <code class="s2">"coordinates"</code><code class="o">:</code> <code class="p">[[[</code><code class="o">-</code><code class="mf">87.359296</code><code class="p">,</code><code class="mf">35.00118</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">85.606675</code><code class="p">,</code><code class="mf">34.984749</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.431413</code><code class="p">,</code><code class="mf">34.124869</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">85.184951</code><code class="p">,</code><code class="mf">32.859696</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.069935</code><code class="p">,</code><code class="mf">32.580372</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">84.960397</code><code class="p">,</code><code class="mf">32.421541</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.004212</code><code class="p">,</code><code class="mf">32.322956</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">84.889196</code><code class="p">,</code><code class="mf">32.262709</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.058981</code><code class="p">,</code><code class="mf">32.13674</code><code class="p">]</code> <code class="err">…</code>           <code class="p">]]</code>       <code class="p">}</code>     <code class="p">},</code>     <code class="p">{</code>          <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code>          <code class="s2">"id"</code><code class="o">:</code> <code class="s2">"02"</code><code class="p">,</code>          <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Alaska"</code> <code class="p">},</code>          <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code>            <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"MultiPolygon"</code><code class="p">,</code>            <code class="s2">"coordinates"</code><code class="o">:</code> <code class="p">[[[[</code><code class="o">-</code><code class="mf">131.602021</code><code class="p">,</code><code class="mf">55.117982</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.569159</code><code class="p">,</code><code class="mf">55.28229</code><code class="p">],[</code><code class="o">-</code><code class="mf">131.355558</code><code class="p">,</code><code class="mf">55.183705</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.38842</code><code class="p">,</code><code class="mf">55.01392</code><code class="p">],[</code><code class="o">-</code><code class="mf">131.645836</code><code class="p">,</code><code class="mf">55.035827</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.602021</code><code class="p">,</code><code class="mf">55.117982</code><code class="p">]]],[[[</code><code class="o">-</code><code class="mf">131.832052</code><code class="p">,</code><code class="mf">55.42469</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.645836</code><code class="p">,</code><code class="mf">55.304197</code><code class="p">],[</code><code class="o">-</code><code class="mf">131.749898</code><code class="p">,</code><code class="mf">55.128935</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.832052</code><code class="p">,</code><code class="mf">55.189182</code><code class="p">],</code> <code class="err">…</code>             <code class="p">]]]</code>           <code class="p">}</code>       <code class="p">}</code> <code class="err">…</code></pre> 
<p id="in_typical_geoj">In typical GeoJSON style, we see, first of all, that this is all one giant object.  (Curly brackets, remember?)  That object has a <code class="literal">type</code> of <code class="literal">FeatureCollection</code>, followed by <code class="literal">features</code>, which is an array of individual <code class="literal">Feature</code> objects.  Each one of these 
<span class="keep-together"><code class="literal">Feature</code>s</span> represents a US state.  You can see each state’s name under <code class="literal">properties</code>.</p> 
<p id="but_the_real_me">But the real meat in any GeoJSON file is under <code class="literal">geometry</code>.  This is where the feature’s <code class="literal">type</code> is specified, followed by the many <code class="literal">coordinates</code> that constitute the feature’s boundary.  Within the <code class="literal">coordinates</code> are sets of longitude/latitude pairs, each one as a small, two-value array.  This is the information that cartographers dedicate their lives to compiling and refining.  We owe generations of explorers and researchers our gratitude for creating these sequences of tiny, yet extremely powerful numbers.</p> 
<p id="its_important__id2">It’s important to note that 
<span class="emphasis">
<em>longitude</em></span> is always listed first.  So despite the cultural bias toward lat/lon, GeoJSON is a lon/lat world.

<a id="id564109" class="indexterm"></a>

<a id="id564114" class="indexterm"></a></p> 
<p id="also_in_case_y_id2">Also, in case your cartographic skills are a bit rusty, here’s how you can always remember which is which:</p> 
<div class="itemizedlist" id="longtiude_is_lo_id1">
<ul class="itemizedlist"> 
<li class="listitem"> Longtiude is long.  Therefore, longitudinal lines run vertically, as though hanging down from above. </li> 
<li class="listitem"> Latitude is fatitude.  Therefore, latitudinal lines run horizontally, as though wrapping around the Earth’s waist. </li> </ul></div> 
<p id="longitude_and_l">Longitude and latitude together constitute an enormous grid that encircles the whole globe.  Conveniently for us, lon/lat can be easily converted to x/y values for screen display.  In bar charts, we map data values to display values—numbers to rectangle heights.  In geomapping, we also map data values to display values—lon/lat becomes x/y.  Thinking in terms of x/y also makes it easier to get used to the uncomfortable order of longitude first, latitude second.

<a id="id564164" class="indexterm"></a></p> 
<div class="tip" id="get_latlon_is__id1">
<p id="get_latlon_is__id2">

<a class="ulink" href="http://teczno.com/squares" target="_top">Get Lat+Lon</a> is a great resource by Michal Migurski for double-checking coordinate values.  Keep it open in a browser tab whenever you’re working on geomaps.  You will reference it often.</p></div> </div> 
<div class="sect1" data-original-filename="12_geomapping.asciidoc" id="_paths"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Paths</h2></div></div></div> 
<p id="weve_got_our_g">We’ve got our geodata.  Now get ready to rock.

<a id="id564204" class="indexterm"></a>

<a id="id564212" class="indexterm"></a></p> 
<p id="first_we_defin">First, we define our first 
<span class="emphasis">
<em>path generator</em></span>:</p> 
<pre class="programlisting" data-language="javascript" id="var_path__dg_id1"><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">();</code></pre> 
<p id="dgeopath_i"><code class="literal">d3.geo.path()</code> is a total lifesaver of a function.  It does all the dirty work of translating that mess of GeoJSON coordinates into even messier messes of SVG <code class="literal">path</code> codes.  All hail <code class="literal">d3.geo.path()</code>!</p> 
<p id="now_we_could_pa">Now we 
<span class="emphasis">
<em>could</em></span> paste all that GeoJSON directly into our HTML file, but ugh, so many coordinates and curly brackets—what a mess!  It’s cleaner and more common to keep the geodata in a separate file and load it in using <code class="literal">d3.json()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="djsonussta_id1"><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"us-states.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>          <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>            <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>            <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>  <code class="p">});</code></pre> 
<p id="djson_takes"><code class="literal">d3.json()</code> takes two arguments.  First, it takes a string pointing to the path of the file to load in.  Second, it takes a callback function that is fired when the JSON file has been loaded and parsed.  (See 

<a class="xref" href="#handling_data_loading_errors_5" title="Handling Data Loading Errors">“Handling Data Loading Errors”</a> for details on the callback function.)  <code class="literal">d3.json()</code>, just like <code class="literal">d3.csv()</code>, is 
<span class="emphasis">
<em>asynchronous</em></span>, meaning it won’t prevent the rest of your code from running while the browser waits for that external file to load.  For example, code placed 
<span class="emphasis">
<em>after</em></span> the callback function might be executed 
<span class="emphasis">
<em>before</em></span> the contents of the callback itself:</p> 
<pre class="programlisting" data-language="javascript" id="djsonsomefi"><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"someFile.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>         <code class="c1">//Put things here that depend on the JSON loading</code> <code class="p">});</code>  <code class="c1">//Only put things here that can operate independently of the JSON</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"I like cats."</code><code class="p">);</code></pre> 
<p id="so_as_a_rule_w">So as a rule, when loading external datafiles, put the code that depends on that data within the callback function.  (Or put the code into other custom functions, and then call those functions from within the callback.)</p> 
<p id="back_to_the_exa">Back to the example.  Finally, we bind the GeoJSON features to new <code class="literal">path</code> elements, creating one new <code class="literal">path</code> for each feature:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id15">        <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>            <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>            <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code></pre> 
<p id="notice_that_las">Notice that last line, in which <code class="literal">d</code> (the path data attribute) is referred to our path generator, which magically takes the bound geodata and calculates all that crazy SVG code. The result is 

<a class="xref" href="#geojson_simple" title="Figure 12-1. Our first view of GeoJSON data">Figure 12-1</a>.</p> 
<div class="figure" id="geojson_simple"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1201.png" alt="Our first view of GeoJSON data"></div></div> 
<div class="figure-title">Figure 12-1. Our first view of GeoJSON data</div> </div> 
<p id="a_map_that_was">A map!  That was so easy!  Check it out in 
<span class="emphasis">
<em>01_paths.html</em></span>.  The rest is just customization.</p> 
<div class="tip" id="you_can_find_lo_id1">
<p id="you_can_find_lo_id2">You can find lots more detail on paths and path generator options 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Geo-Paths" target="_top">on the wiki</a>.</p></div> </div> 
<div class="sect1" data-original-filename="12_geomapping.asciidoc" id="_projections"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Projections</h2></div></div></div> 
<p id="as_an_astute_ob">As an astute observer, you noticed that our map isn’t quite showing us the entire United States.  To correct this, we need to modify the 
<span class="emphasis">
<em>projection</em></span> being used.

<a id="id564903" class="indexterm"></a>

<a id="id564911" class="indexterm"></a>

<a id="id564917" class="indexterm"></a></p> 
<p id="what_is_a_proje">What is a projection?  Well, as an astute observer, you have also noticed that the globe is round, not flat.  Round things are three-dimensional, and don’t take well to being represented on two-dimensional surfaces.  A 
<span class="emphasis">
<em>projection</em></span> is an algorithm of compromise; it is the method by which 3D space is “projected” onto a 2D plane.</p> 
<p id="we_define_d_pr">We define D3 projections using a familiar structure:</p> 
<pre class="programlisting" data-language="javascript" id="var_projection__id1"><code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">albersUsa</code><code class="p">()</code>                        <code class="p">.</code><code class="nx">translate</code><code class="p">([</code><code class="nx">w</code><code class="o">/</code><code class="mi">2</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">]);</code></pre> 
<p id="d_has_several_">D3 has several built-in projections.  Albers USA is a composite projection that nicely tucks Alaska and Hawaii beneath the Southwest.  (You’ll see in a second.)  <code class="literal">albersUsa</code> is actually the default projection for <code class="literal">d3.path.geo()</code>, but now that we’ve specified it explicitly, we can set several custom options, such as a translation value.  You can see we’re translating the projection to the center of the image (half of its width and half of its height).

<a id="id565073" class="indexterm"></a>

<a id="id565078" class="indexterm"></a>

<a id="id565084" class="indexterm"></a></p> 
<p id="the_only_other_">The only other change we have to make is to tell the path generator explicitly that it should reference our customized projection when generating all those paths:</p> 
<pre class="programlisting" data-language="javascript" id="var_path__dg_id2"><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">()</code>                  <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">);</code></pre> 
<p id="that_gives_us_">That gives us 

<a class="xref" href="#geojson_centered" title="Figure 12-2. The same GeoJSON data, but now with a centered projection">Figure 12-2</a>. Getting there!  See 
<span class="emphasis">
<em>02_projection.html</em></span> for the working code.</p> 
<div class="figure" id="geojson_centered"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1202.png" alt="The same GeoJSON data, but now with a centered projection"></div></div> 
<div class="figure-title">Figure 12-2. The same GeoJSON data, but now with a centered projection</div> </div> 
<p id="we_can_also_add">We can also add a <code class="literal">scale()</code> method to our projection in order to shrink things down a bit and achieve the result shown in 

<a class="xref" href="#geojson_scaled" title="Figure 12-3. The USA, scaled and centered within the image">Figure 12-3</a>:</p> 
<pre class="programlisting" data-language="javascript" id="var_projection__id2"><code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">albersUsa</code><code class="p">()</code>                        <code class="p">.</code><code class="nx">translate</code><code class="p">([</code><code class="nx">w</code><code class="o">/</code><code class="mi">2</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">])</code>                        <code class="p">.</code><code class="nx">scale</code><code class="p">([</code><code class="mi">500</code><code class="p">]);</code></pre> 
<p id="the_default_sca">The default scale value is 1,000.  Anything smaller will shrink the map; anything larger will expand it.</p> 
<div class="figure" id="geojson_scaled"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1203.png" alt="The USA, scaled and centered within the image"></div></div> 
<div class="figure-title">Figure 12-3. The USA, scaled and centered within the image</div> </div> 
<p id="cool_see_that_">Cool!  See that working code in 
<span class="emphasis">
<em>03_scaled.html</em></span>.</p> 
<p id="by_adding_a_sin">By adding a single <code class="literal">style()</code> statement, we could set the path’s fills to something less severe, like the blue shown in 

<a class="xref" href="#geojson_filled" title="Figure 12-4. Now more blue-ish than black">Figure 12-4</a>.</p> 
<div class="figure" id="geojson_filled"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1204.png" alt="Now more blue-ish than black"></div></div> 
<div class="figure-title">Figure 12-4. Now more blue-ish than black</div> </div> 
<p id="see__fillhtm">See 
<span class="emphasis">
<em>04_fill.html</em></span> for that.  You could use the same technique to set stroke color and width, too.</p> 
<p id="map_projections">Map projections are extremely powerful algorithms, and different projections are useful for different purposes and different parts of the world (near the poles, versus the equator, for example).</p> 
<p id="thanks_primaril">Thanks primarily to the contributions of 

<a class="ulink" href="http://www.jasondavies.com" target="_top">Jason Davies</a>, D3’s geo projections plug-ins now support essentially every obscure projection you could imagine.  Reference 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Geo-Projections" target="_top">the complete visual reference of D3 projections on the wiki</a>.  You might also find the 

<a class="ulink" href="http://bl.ocks.org/3711652" target="_top">projection comparison demo</a> useful.

<a id="id565457" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="12_geomapping.asciidoc" id="_choropleth"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Choropleth</h2></div></div></div> 
<p id="chorowhat_thi">Choro-
<span class="emphasis">
<em>what?</em></span>  This word, which can be difficult to pronounce, refers to a geomap with areas filled in with different values (light or dark) or colors to reflect associated data values.  In the United States, so-called “red state, blue state” choropleth maps showing the Republican and Democratic leanings of each state are ubiquitous, especially around election time.  But choropleths can be generated from any values, not just political ones.

<a id="id565490" class="indexterm"></a>

<a id="id565498" class="indexterm"></a>

<a id="id565504" class="indexterm"></a>

<a id="id565509" class="indexterm"></a>

<a id="id565515" class="indexterm"></a>

<a id="id565523" class="indexterm"></a></p> 
<p id="these_maps_are_">These maps are also some of the most requested uses of D3.  Although choropleths can be fantastically useful, keep in mind that they have some inherent perceptual limitations.  Because they use 
<span class="emphasis">
<em>area</em></span> to encode values, large areas with low density (such as the state of Nevada) might be overrepresented visually.  A standard choropleth does not represent per-capita values fairly—Nevada is too big, and Delaware far too small.  But they 
<span class="emphasis">
<em>do</em></span> retain the geography of a place, and—as maps—they look really, really cool.  So let’s dive in.  (You can follow along with 
<span class="emphasis">
<em>05_choropleth.html</em></span>.)</p> 
<p id="first_ill_set">First, I’ll set up a scale that can take data values as input, and will return colors.  This is the heart of choropleth-style mapping:</p> 
<pre class="programlisting" data-language="javascript" id="var_color__d_id2"><code class="kd">var</code> <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">quantize</code><code class="p">()</code>                     <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="s2">"rgb(237,248,233)"</code><code class="p">,</code> <code class="s2">"rgb(186,228,179)"</code><code class="p">,</code>                      <code class="s2">"rgb(116,196,118)"</code><code class="p">,</code> <code class="s2">"rgb(49,163,84)"</code><code class="p">,</code><code class="s2">"rgb(0,109,44)"</code><code class="p">]);</code></pre> 
<p id="a_quantize_scal">A 
<span class="emphasis">
<em>quantize</em></span> scale functions as a linear scale, but it outputs values from within a discrete range.  These output values could be numbers, colors (as we’ve done here), or anything else you like.  This is useful for sorting values into “buckets.”  In this case, we’re using five buckets, but there could be as many as you like.

<a id="id565689" class="indexterm"></a></p> 
<p id="notice_ive_spe">Notice I’ve specified an output range, but not an input domain.  (I’m waiting until our data is loaded in to do that.)  These particular colors are taken from the 
<span class="keep-together"><code class="literal">colorbrewer.js</code></span> file included in 

<a class="ulink" href="https://github.com/mbostock/d3/tree/master/lib/colorbrewer" target="_top">the D3 GitHub repository</a>—a collection of perceptually optimized colors, selected by Cynthia Brewer, and based on her research.</p> 
<p id="next_we_need_t">Next, we need to load in some data.  I’ve provided a file 
<span class="emphasis">
<em>us-ag-productivity-2004.csv</em></span>, which looks like this:</p> 
<pre class="screen" id="statevalue_ala">state,value Alabama,1.1791 Arkansas,1.3705 Arizona,1.3847 California,1.7979 Colorado,1.0325 Connecticut,1.3209 Delaware,1.4345 …</pre> 
<p id="this_data_prov">This data, provided by the US Department of Agriculture, reports agricultural productivity by state during the year 2004.  The units are relative to an arbitrary baseline of the productivity of the state of Alabama in 1996 (1.0), so greater values are more productive, and smaller values less so.  (Find lots of open government datasets at 

<a class="ulink" href="http://data.gov" target="_top">http://data.gov</a>.)  I expect this data will give us a nice map of states’ agricultural productivity.</p> 
<p id="to_load_in_the_">To load in the data, we use <code class="literal">d3.csv()</code>:</p> 
<pre class="programlisting" data-language="javascript" id="dcsvusagp"><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"us-ag-productivity-2004.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code> <code class="err">…</code></pre> 
<p id="then_in_the_ca">Then, in the callback function, I want to set the <code class="literal">color</code> quantize scale’s input domain (before I forget!):</p> 
<pre class="programlisting" data-language="javascript" id="colordomain_">        <code class="nx">color</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code>                 <code class="nx">d3</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">}),</code>                 <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})</code>         <code class="p">]);</code></pre> 
<p id="this_uses_dmi">This uses <code class="literal">d3.min()</code> and <code class="literal">d3.max()</code> to calculate and return the smallest and largest data values, so the scale’s domain is dynamically calculated.</p> 
<p id="next_we_load_i">Next, we load in the JSON geodata, as before.  But what’s new here is I want to 
<span class="emphasis">
<em>merge</em></span> the agricultural data 
<span class="emphasis">
<em>into</em></span> the GeoJSON.  Why?  Because we can only bind one set of data to elements at a time.  We definitely need the GeoJSON, from which the <code class="literal">path</code>s are generated, but we also need the new agricultural data.  So if we can smush them into a single, monster array, then we can bind them to the new <code class="literal">path</code> elements all at the same time.  (There are several approaches to this step; what follows is my preferred method.)</p> 
<pre class="programlisting" data-language="javascript" id="djsonussta_id2">    <code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"us-states.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>          <code class="c1">//Merge the ag. data and GeoJSON</code>         <code class="c1">//Loop through once for each ag. data value</code>         <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>              <code class="c1">//Grab state name</code>             <code class="kd">var</code> <code class="nx">dataState</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">state</code><code class="p">;</code>              <code class="c1">//Grab data value, and convert from string to float</code>             <code class="kd">var</code> <code class="nx">dataValue</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">value</code><code class="p">);</code>              <code class="c1">//Find the corresponding state inside the GeoJSON</code>             <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">j</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">j</code> <code class="o">&lt;</code> <code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="nx">j</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>              <code class="kd">var</code> <code class="nx">jsonState</code> <code class="o">=</code> <code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">[</code><code class="nx">j</code><code class="p">].</code><code class="nx">properties</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>              <code class="k">if</code> <code class="p">(</code><code class="nx">dataState</code> <code class="o">==</code> <code class="nx">jsonState</code><code class="p">)</code> <code class="p">{</code>                  <code class="c1">//Copy the data value into the JSON</code>                 <code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">[</code><code class="nx">j</code><code class="p">].</code><code class="nx">properties</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">dataValue</code><code class="p">;</code>                  <code class="c1">//Stop looking through the JSON</code>                 <code class="k">break</code><code class="p">;</code>          <code class="p">}</code>     <code class="p">}</code> <code class="p">}</code></pre> 
<p id="read_through_th">Read through that closely.  Basically, for each state, we are finding the GeoJSON element with the same name (e.g., “Colorado”).  Then we take the state’s data value and tuck it in under <code class="literal">json.features[j].properties.value</code>, ensuring it will be bound to the element and available later, when we need it.</p> 
<p id="lastly_we_crea">Lastly, we create the <code class="literal">path</code>s just as before, only we make our <code class="literal">style()</code> value dynamic:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id16">                <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>                    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                                 <code class="c1">//Get data value</code>                                 <code class="kd">var</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">properties</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>                                  <code class="k">if</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>                                         <code class="c1">//If value exists…</code>                                         <code class="k">return</code> <code class="nx">color</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>                                 <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>                                         <code class="c1">//If value is undefined…</code>                                         <code class="k">return</code> <code class="s2">"#ccc"</code><code class="p">;</code>                                 <code class="p">}</code>                    <code class="p">});</code></pre> 
<p id="instead_of_ste">Instead of <code class="literal">"steelblue"</code> for everyone, now each state <code class="literal">path</code> gets a different fill value.  The trick is that we don’t have data for 
<span class="emphasis">
<em>every</em></span> state.  The dataset we’re using doesn’t have information for Alaska, the District of Columbia, Hawaii, or Puerto Rico (which, although not a state, is still included in the GeoJSON and appears in the projection).</p> 
<p id="so_to_accommoda">So to accommodate those exceptions, we include a little logic: an <code class="literal">if()</code> statement that checks to see whether or not the data value has been defined.  If it exists, then we return <code class="literal">color(value)</code>, meaning we pass the data value to our quantize scale, which returns a color.  For undefined values, we set a default of light gray (<code class="literal">#ccc</code>).</p> 
<p id="beautiful_just">Beautiful! Just look at the result in 

<a class="xref" href="#choropleth_map" title="Figure 12-5. A choropleth map showing agricultural productivity by state">Figure 12-5</a>. Check out the final code and try it yourself in 
<span class="emphasis">
<em>05_choropleth.html</em></span>.</p> 
<div class="figure" id="choropleth_map"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1205.png" alt="A choropleth map showing agricultural productivity by state"></div></div> 
<div class="figure-title">Figure 12-5. A choropleth map showing agricultural productivity by state</div> </div> </div> 
<div class="sect1" data-original-filename="12_geomapping.asciidoc" id="_adding_points"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Adding Points</h2></div></div></div> 
<p id="wouldnt_it_be_">Wouldn’t it be nice to put some cities on this map, for context?  Maybe it would be interesting or useful to see how many large, urban areas there are in the most (or least) agriculturally productive states.  Again, let’s start by finding the data.

<a id="id567093" class="indexterm"></a>

<a id="id567101" class="indexterm"></a>

<a id="id567107" class="indexterm"></a>

<a id="id567112" class="indexterm"></a></p> 
<p id="fortunately_th_id2">Fortunately, the US Census has us covered, once again.  (Your tax dollars at work!)  Here’s the start of a raw CSV dataset from the Census that shows 

<a class="ulink" href="http://1.usa.gov/XWUSrY" target="_top">“Annual Estimates of the Resident Population for Incorporated Places Over 50,000”</a>.</p> 
<pre class="screen" id="table_with_row_">table with row headers in column A and column headers in rows 3 through 4,,,,,,, ,,, "Table 1. Annual Estimates of the Resident Population for Incorporated Places Over 50,000, Ranked by July 1, 2011 Population: April 1, 2010 to July 1, 2011" ,,,,,,,,,, Rank,Geographic Area,,"April 1, 2010",,Population Estimate (as of July 1),, ,,,,Place,State,Census,Estimates Base,2010,2011,,,, 1,New York city,New York,"8,175,133","8,175,133","8,186,443","8,244,910",,,, 2,Los Angeles city,California,"3,792,621","3,792,625","3,795,761","3,819,702" ,,,, 3,Chicago city,Illinois,"2,695,598","2,695,598","2,698,283","2,707,120",,,, 4,Houston city,Texas,"2,099,451","2,099,430","2,108,278","2,145,146",,,, 5,Philadelphia city,Pennsylvania,"1,526,006","1,526,006","1,528,074","1,536,471" ,,,, 6,Phoenix city,Arizona,"1,445,632","1,445,656","1,448,531","1,469,471",,,, 7,San Antonio city,Texas,"1,327,407","1,327,606","1,334,431","1,359,758",,,, 8,San Diego city,California,"1,307,402","1,307,406","1,311,516","1,326,179",,,, 9,Dallas city,Texas,"1,197,816","1,197,816","1,201,715","1,223,229",,,, 10,San Jose city,California,"945,942","952,612","955,091","967,487",,,, …</pre> 
<p id="this_is_quite_m">This is quite messy, and I don’t even need all this data.  So I’ll open the CSV up in my favorite spreadsheet program and clean it up a bit, removing unneeded columns.  (You could use LibreOffice Calc, Apple Numbers, or Microsoft Excel.)  I’m also interested in only the largest 50 cities, so I’ll delete all the others.  Exporting back to CSV, I now have this:</p> 
<pre class="screen" id="rankplacepopu_id1">rank,place,population 1,New York city,8175133 2,Los Angeles city,3792621 3,Chicago city,2695598 4,Houston city,2099451 5,Philadelphia city,1526006 6,Phoenix city,1445632 7,San Antonio city,1327407 8,San Diego city,1307402 9,Dallas city,1197816 10,San Jose city,945942 …</pre> 
<p id="this_informatio">This information is useful, but to place it on the map, I’m going to need the latitude and longitude coordinates for each of these places.  Looking this up manually would take 
<span class="emphasis">
<em>forever</em></span>.  Fortunately, we can use a 
<span class="emphasis">
<em>geocoding</em></span> service to speed things up.  Geocoding is the process of taking place names, looking them up on a map (or in a database, really), and returning precise lat/lon coordinates.  “Precise” might be a bit of an overstatement—the geocoder does the best job it can, but it will sometimes be forced to make assumptions given vague data.  For example, if you specify “Paris,” it will probably assume you mean Paris, France and not Paris, Texas.  It’s good practice to eyeball the geocoder’s output once you get it on the map, and manually adjust any erroneous coordinates (using 

<a class="ulink" href="http://www.teczno.com/squares" target="_top">teczno.com/squares</a> as a reference).

<a id="id567219" class="indexterm"></a>

<a id="id567224" class="indexterm"></a>

<a id="id567230" class="indexterm"></a>

<a id="id567236" class="indexterm"></a></p> 
<p id="ill_head_over_">I’ll head over to 

<a class="ulink" href="http://www.gpsvisualizer.com/geocoder/" target="_top">my favorite batch geocoder</a>, paste in just the place names, and click Start!  A few minutes later, the geocoder spits out some more comma-separated values, which includes lat/lon pairs.  I bring those back into my spreadsheet, and save out a new, unified CSV with coordinates:</p> 
<pre class="screen" id="rankplacepopu_id2">rank,place,population,lat,lon 1,New York city,8175133,40.71455,-74.007124 2,Los Angeles city,3792621,34.05349,-118.245323 3,Chicago city,2695598,45.37399,-92.888759 4,Houston city,2099451,41.337462,-75.733627 5,Philadelphia city,1526006,37.15477,-94.486114 6,Phoenix city,1445632,32.46764,-85.000823 7,San Antonio city,1327407,37.706576,-122.440612 8,San Diego city,1307402,37.707815,-122.466624 9,Dallas city,1197816,40.636,-91.168309 10,San Jose city,945942,41.209716,-112.003047 …</pre> 
<p id="that_was_unbeli">That was unbelievably easy.  Ten years ago that step would have taken us hours of research and tedious data entry, not seconds of mindless copying-and-pasting.  Now you see why we’re experiencing an explosion of online mapping.</p> 
<p id="our_data_is_rea">Our data is ready, and we already know how to load it in:</p> 
<pre class="programlisting" data-language="javascript" id="dcsvusciti"><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"us-cities.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>         <code class="c1">//Do something…</code> <code class="p">});</code></pre> 
<p id="in_the_callback">In the callback function, we can specify how to create a new <code class="literal">circle</code> element for each city, and then 
<span class="emphasis">
<em>position each circle</em></span> according to the corresponding city’s geo-coordinates:</p> 
<pre class="programlisting" data-language="javascript" id="svgselectall_id17">        <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>            <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>            <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                    <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">0</code><code class="p">];</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                    <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">1</code><code class="p">];</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"yellow"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mf">0.75</code><code class="p">);</code></pre> 
<p id="the_magic_here_">The magic here is in those <code class="literal">attr()</code> statements that set the <code class="literal">cx</code> and <code class="literal">cy</code> values.  You see, we can access the raw latitude and longitude values as <code class="literal">d.lat</code> and <code class="literal">d.lon</code>.  But what we really need for positioning these circles are x/y 
<span class="emphasis">
<em>screen coordinates</em></span>, not 
<span class="emphasis">
<em>geo</em></span>-coordinates.

<a id="id567828" class="indexterm"></a></p> 
<p id="so_we_bring_bac">So we bring back our magical friend <code class="literal">projection()</code>, which is basically just a two-dimensional scale method.  With D3 scales, we put in one number, and get back another.  With projections, we put in two numbers, and get back two.  (The other main difference is that the behind-the-scenes math for projections is much more complex than the simple normalization of scales.)

<a id="id567849" class="indexterm"></a></p> 
<p id="the_map_project">The map projection takes a two-value array as input, with 
<span class="emphasis">
<em>longitude</em></span> first (remember, it’s lon/lat, not lat/lon, in GeoJSON-ville).  Then the projection returns a two-value array with x/y screen values.  So, for <code class="literal">cx</code>, we use <code class="literal">[0]</code> to grab the 
<span class="emphasis">
<em>first</em></span> of those values, which is 
<span class="emphasis">
<em>x</em></span>.  For <code class="literal">cy</code>, we use <code class="literal">[1]</code> to grab the 
<span class="emphasis">
<em>second</em></span> of those values, which is 
<span class="emphasis">
<em>y</em></span>.  Make sense?</p> 
<p id="the_resulting_m">The resulting map in 

<a class="xref" href="#choropleth_with_cities" title="Figure 12-6. The top 50 largest US cities, represented as cute little yellow dots">Figure 12-6</a> is suh-weeeet! Check out the code in 
<span class="emphasis">
<em>06_points.html</em></span>.</p> 
<div class="figure" id="choropleth_with_cities"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1206.png" alt="The top 50 largest US cities, represented as cute little yellow dots"></div></div> 
<div class="figure-title">Figure 12-6. The top 50 largest US cities, represented as cute little yellow dots</div> </div> 
<p id="yet_these_dots_">Yet these dots are all the same size.  Let’s link the population data to circle size.  Instead of a static area, we’ll reference the <code class="literal">population</code> value:</p> 
<pre class="programlisting" data-language="javascript" id="attrr_func_id4">           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                  <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nb">parseInt</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">population</code><code class="p">)</code> <code class="o">*</code> <code class="mf">0.00004</code><code class="p">);</code>            <code class="p">})</code></pre> 
<p id="here_we_grab_d">Here we grab <code class="literal">d.population</code>, wrap it in <code class="literal">parseInt()</code> to convert it from a string to an integer, scale that value down by an arbitrary amount, and finally take the square root (to convert from an area value to a radius value).  See the code in 
<span class="emphasis">
<em>07_points_sized.html</em></span>.</p> 
<p id="as_you_can_see__id2">As you can see in 

<a class="xref" href="#choropleth_with_cities_sized" title="Figure 12-7. Cities as dots, with area set by population">Figure 12-7</a>, now the largest cities really stand out.  The differences in city size are significant; this representation might be better suited to a log scale, especially if even smaller cities are included.  Instead of multiplying by 0.00004, you could more properly use a custom D3 scale function.  (I’ll leave that to you.)</p> 
<div class="figure" id="choropleth_with_cities_sized"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1207.png" alt="Cities as dots, with area set by population"></div></div> 
<div class="figure-title">Figure 12-7. Cities as dots, with area set by population</div> </div> 
<p id="the_point_here_">The point here is to see that we’ve successfully loaded and visualized two different datasets on a map.  (Make that three, counting the geocoded coordinates we merged in!)</p> </div> 
<div class="sect1" data-original-filename="12_geomapping.asciidoc" id="_acquiring_and_parsing_geodata"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Acquiring and Parsing Geodata</h2></div></div></div> 
<p id="if_we_only_ever">If we only ever wanted to make maps of the United States, then we would already have all the GeoJSON we’d ever need.  But the world is much bigger than that, and there are lots of other areas to map.  So allow me to digress for a moment and address how to acquire and parse geodata for the area of your choosing.  The end goal is to produce a GeoJSON file, like 
<span class="emphasis">
<em>us-states.json</em></span>, that can be used with D3.

<a id="ix_gapg" class="indexterm"></a></p> 
<div class="sect2" id="_find_shapefiles"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Find Shapefiles</h3></div></div></div> 
<p id="socalled_shape">So-called 
<span class="emphasis">
<em>shapefiles</em></span> predate the current explosion of online mapping and visualization.  These are documents that essentially contain the same kind of information you could store in GeoJSON—boundaries of geographic areas, and points within those areas—but their contents are not plain text and, therefore, are very hard to read.  The shapefile format grew out of the community of geographers, cartographers, and scientists using Geographic Information Systems (GIS) software.  If you have easy access to expensive GIS software, then shapefiles are your best friend.  But that’s a small group of people, and web browsers can’t make heads or tails of shapefiles, in any case.

<a id="id568209" class="indexterm"></a>

<a id="id568215" class="indexterm"></a></p> 
<p id="if_you_cant_fi">If you can’t find nice GeoJSON describing your area of interest, then hunt down a shapefile.  Government websites are good sources, especially if you’re looking for data on a specific country or region.  My favorite two sources are:</p> 
<div class="variablelist" id="natural_earth_a">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://www.naturalearthdata.com" target="_top">Natural Earth</a> </span></dt> 
<dd> A massive collection of geographic data for both cultural/political and natural features made available in the public domain.  Mapping countries is highly political, and Natural Earth posts detailed notes explaining their design decisions. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://www.census.gov/geo/www/cob/cbf_state.html" target="_top">The United States Census</a> </span></dt> 
<dd> Boundary data for every US state, plus counties, roadways, water features, and so much more, also in the public domain. </dd> </dl></div> </div> 
<div class="sect2" id="_choose_a_resolution"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Choose a Resolution</h3></div></div></div> 
<p id="before_you_down">Before you download, check the 
<span class="emphasis">
<em>resolution</em></span> of the data.  All shapefiles are vector data (not bitmap), so by resolution I don’t mean pixels—I mean the level of 
<span class="emphasis">
<em>cartographic detail</em></span> or granularity.

<a id="id568295" class="indexterm"></a>

<a id="id568301" class="indexterm"></a>

<a id="id568306" class="indexterm"></a>

<a id="id568312" class="indexterm"></a></p> 
<p id="natural_earths">Natural Earth’s datasets come in three different resolutions, listed here from most detailed to least:</p> 
<div class="itemizedlist" id="itemizedlist_id1">
<ul class="itemizedlist"> 
<li class="listitem"> 1:10,000,000 </li> 
<li class="listitem"> 1:50,000,000 </li> 
<li class="listitem"> 1:110,000,000 </li> </ul></div> 
<p id="that_is_in_the">That is, in the highest resolution data, one unit of measurement in the file corresponds to 10 million such units in the actual, physical world.  Or, to flip that around, every 10 million units in real life is simplified into one.  So 10 million inches (158 miles) would translate to a single inch in data terms.</p> 
<p id="these_resolutio">These resolution ratios can be written more simply as:</p> 
<div class="itemizedlist" id="m_m_">
<ul class="itemizedlist"> 
<li class="listitem"> 1:10m </li> 
<li class="listitem"> 1:50m </li> 
<li class="listitem"> 1:110m </li> </ul></div> 
<p id="for_a_lowdetai">For a low-detail (“zoomed out”) map of the world, the 1:110m resolution could work fine.  But to show detailed outlines of a specific state, 1:10m will be better.  If you’re mapping a very small (“zoomed in”) area, such as a specific city or even neighborhood, then you’ll need much higher resolution data.  (Try local state or city government websites for that information.)</p> 
<p id="different_sourc">Different sources will offer different resolutions.  Many of the US Census shapefiles are available in these three scales:</p> 
<div class="itemizedlist" id="itemizedlist_id2">
<ul class="itemizedlist"> 
<li class="listitem"> 1:500,000 (1:500k) </li> 
<li class="listitem"> 1:5,000,000 (1:5m) </li> 
<li class="listitem"> 1:20,000,000 (1:20m) </li> </ul></div> 
<p id="choose_a_resolu">Choose a resolution, and download the file.  Typically you’ll get a compressed ZIP file that contains several other files.  As an example, I’m going to download Natural Earth’s 1:110m (low detail) ocean file from here: 

<a class="ulink" href="http://www.naturalearthdata.com/downloads/110m-physical-vectors/110m-ocean/" target="_top">http://www.naturalearthdata.com/downloads/110m-physical-vectors/110m-ocean/</a>.</p> 
<p id="uncompressed_i">Uncompressed, it contains these files:</p> 
<pre class="screen" id="ne_m_oceand">ne_110m_ocean.dbf ne_110m_ocean.prj ne_110m_ocean.README.html ne_110m_ocean.shp ne_110m_ocean.shx ne_110m_ocean.VERSION.txt</pre> 
<p id="wow_those_are_">Wow, those are some funky extensions.  We’re primarily interested in the file ending with 
<span class="emphasis">
<em>.shp</em></span>, but don’t delete the rest just yet.</p> </div> 
<div class="sect2" id="_simplify_the_shapes"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Simplify the Shapes</h3></div></div></div> 
<p id="ideally_you_ca">Ideally, you can find shapefiles in exactly the resolution you need.  But what if you can only find a super-high-resolution file, say at 1:100k?  The size of the file might be huge.  And now that you’re a JavaScript programmer, you’re really concerned about efficiency, remember?  So no sending multimegabyte geodata to the browser.</p> 
<p id="fortunately_yo_id4">Fortunately, you can 
<span class="emphasis">
<em>simplify</em></span> those shapefiles, in effect converting them into lower-detail versions of themselves.  The process of simplification is illustrated beautifully in 

<a class="ulink" href="http://bost.ocks.org/mike/simplify/" target="_top">this interactive piece by Mike Bostock</a>.</p> 
<p id="mapshaper_by_m">

<a class="ulink" href="http://mapshaper.org" target="_top">MapShaper</a>, by Matt Bloch, is an excellent, easy-to-use interactive tool for this purpose.  It lets you upload your own shapefiles, and then drag sliders around to preview different levels of simplification.  Typically, the trade-off is between good detail and small files.

<a id="id568535" class="indexterm"></a>

<a id="id568541" class="indexterm"></a>

<a id="id568547" class="indexterm"></a></p> 
<p id="if_you_use_maps">If you use MapShaper, choose the “Shapefile – polygons” option when exporting. This will generate both a 
<span class="emphasis">
<em>.shp</em></span> and a 
<span class="emphasis">
<em>.shx</em></span> file for you. Download both files, and rename them so the filenames match the names of the original 
<span class="emphasis">
<em>.shp</em></span> and 
<span class="emphasis">
<em>.shx</em></span> files. Then, before converting to GeoJSON, make a copy of the original 
<span class="emphasis">
<em>.dbf</em></span> file, and put it in the same folder as the simplified shapefiles. This important step will ensure you don’t lose any of the important metadata that’s stored in the 
<span class="emphasis">
<em>.dbf</em></span>, like country IDs and other path identifiers.</p> 
<p id="other_options_i">Other options include Mike Migurski’s 

<a class="ulink" href="https://github.com/migurski/Bloch" target="_top">Bloch</a> with a Python implementation of Matt Bloch’s simplification algorithms, and a <code class="literal">d3.simplify</code> plug-in (used for Mike’s demo mentioned earlier).  The dream is one day we could use JavaScript to perform line simplification directly, and then export that simplified JSON to use in projects.  The tools are evolving quickly, so watch this space!  (Literally while I was writing this paragraph, Mr. Bostock posted 

<a class="ulink" href="http://bl.ocks.org/4090870" target="_top">a demo</a> for a new project for geometry simplification, 

<a class="ulink" href="https://github.com/mbostock/topojson" target="_top">TopoJSON</a>.  That’s how fast things are changing! By the time you read this, the TopoJSON command-line tool may be your best bet, as it can load shapefiles, perform simplification, 
<span class="emphasis">
<em>and</em></span> convert your data to JSON. As you’d expect, TopoJSON is designed to play well with D3, although it outputs a new TopoJSON format, which is similar to, but more efficient than GeoJSON.)

<a id="id568635" class="indexterm"></a></p> </div> 
<div class="sect2" id="_convert_to_geojson"> 
<div class="titlepage">
<div>
<div>
<h3 class="title">Convert to GeoJSON</h3></div></div></div> 
<p id="if_you_dont_al">If you don’t already have the right software installed, this can be the hairiest part of the process.  Our end goal is to get a terminal command called <code class="literal">ogr2ogr</code> running on your Mac, Unix, or Windows system.  The problem is that <code class="literal">ogr2ogr</code> depends on several other frameworks, libraries, and so on, so for it to work, they all have to be in place.

<a id="id568669" class="indexterm"></a></p> 
<p id="i_wont_cover_t">I won’t cover the intricacies of the installation here, but I’ll point you in the right 
<span class="keep-together">direction</span>.</p> 
<p id="first_you_need">First, you need 

<a class="ulink" href="http://www.gdal.org" target="_top">the Geospatial Data Abstraction Library</a>, or GDAL.  The <code class="literal">ogr2ogr</code> utility is part of this package.</p> 
<p id="you_also_need_g">You also need 

<a class="ulink" href="http://trac.osgeo.org/geos/" target="_top">GEOS</a>, which cleverly stands for Geometry Engine, Open Source.</p> 
<p id="if_you_have_a_w">If you have a Windows or Unix/Linux machine, you can now have fun downloading the source and installing it by typing funny commands like 
<span class="strong">
<strong><code class="literal">build</code></strong></span>, 
<span class="strong">
<strong><code class="literal">make</code></strong></span>, and 
<span class="strong">
<strong><code class="literal">seriously why isn’t this working omg please please please install this time or i will freak out</code></strong></span>.</p> 
<p id="i_dont_remembe">I don’t remember the exact command names, but they are something like that.  (On a serious note, if you get stuck on this step, be aware that there are literally entire other O’Reilly books on how to download and install software packages like this.)</p> 
<p id="if_youre_on_a_">If you’re on a Mac, and you happen to have both Xcode 
<span class="emphasis">
<em>and</em></span> Homebrew installed, then simply type 
<span class="strong">
<strong><code class="literal">brew install gdal</code></strong></span> into the terminal, and you’re done!  (If you don’t have either of these amazing tools, they might be worth getting.  Both tools are free, but could take some time and effort on your part to install.  Xcode is a massive 

<a class="ulink" href="http://bit.ly/XUTt81" target="_top">download from the App Store</a>.  Once you have Xcode, Homebrew can, in theory, be installed with 

<a class="ulink" href="http://mxcl.github.com/homebrew/" target="_top">a simple terminal command</a>.  In my experience, some troubleshooting was required to get it working.)</p> 
<p id="to_mac_users_wi">To Mac users without Xcode or Homebrew: you are very lucky that some kind soul has precompiled a friendly GUI installer, which installs GDAL, GEOS, and several other tools whose names you don’t really need to know.  Look for the newest version of the 

<a class="ulink" href="http://www.kyngchaos.com/software/frameworks" target="_top">“GDAL Complete” package</a>.  Review the GDAL ReadMe file closely.  After installation, you won’t automatically be able to type 
<span class="strong">
<strong><code class="literal">ogr2ogr</code></strong></span> in a terminal window.  You’ll need to add the GDAL programs to your shell path.  The easiest way to do that is:  Open a new terminal window.  Type 
<span class="strong">
<strong><code class="literal">nano .bash_profile</code></strong></span>.  Paste in <code class="literal">export PATH=/Library/Frameworks/GDAL.framework/Programs:$PATH</code> and then Control-X and Control-y to save.  Type 
<span class="strong">
<strong><code class="literal">exit</code></strong></span> to end the session, then open a new terminal window and type 
<span class="strong">
<strong><code class="literal">ogr2ogr</code></strong></span> to see if it worked.</p> 
<p id="no_matter_what_">No matter what system you’re on, once all the tools are installed, open up a new terminal window and navigate to whatever directory contains all the shapefiles (for example, 
<span class="strong">
<strong><code class="literal">cd ~/ocean_shapes/</code></strong></span>.)  Then use the form:</p> 
<pre class="programlisting" data-language="bash" id="ogrogr_f_geo_id1">ogr2ogr -f <code class="s2">"GeoJSON"</code> output.json filename.shp</pre> 
<p id="this_tells_ogr">This tells <code class="literal">ogr2ogr</code> to take <code class="literal">filename</code>, which should be a 
<span class="emphasis">
<em>.shp</em></span> file, convert it to GeoJSON, and finally save it as a file called 
<span class="emphasis">
<em>output.json</em></span>.</p> 
<p id="for_my_sample_o">For my sample ocean data file, using <code class="literal">ogr2ogr</code> looks like the following:</p> 
<pre class="programlisting" data-language="bash" id="ogrogr_f_geo_id2">ogr2ogr -f <code class="s2">"GeoJSON"</code> output.json ne_110m_ocean.shp</pre> 
<p id="type_that_in_a">Type that in, and hopefully you see nothing at all.</p> 
<p id="so_anticlimacti">So anticlimactic!  I know, after the hours you spent hacking the command line to get ol’ <code class="literal">ogr</code> installed, you were expecting some gradiose finale, as though you saved the princess in Super Mario 3, yet again.  (I actually have never done that, but I imagine it is pretty amazing.)</p> 
<p id="but_no_hopeful">But no, hopefully nothing happened at all.  Except there should be a new file in the same directory called 
<span class="emphasis">
<em>output.json</em></span>.</p> 
<p id="heres_the_star">Here’s the start of mine:</p> 
<pre class="programlisting" data-language="javascript" id="type_feat_id3"><code class="p">{</code> <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"FeatureCollection"</code><code class="p">,</code> <code class="s2">"features"</code><code class="o">:</code> <code class="p">[</code> <code class="p">{</code> <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code> <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"scalerank"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"featurecla"</code><code class="o">:</code> <code class="s2">"Ocean"</code> <code class="p">},</code> <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Polygon"</code><code class="p">,</code> <code class="s2">"coordinates"</code><code class="o">:</code>     <code class="p">[</code> <code class="p">[</code> <code class="p">[</code> <code class="mf">49.110290527343778</code><code class="p">,</code> <code class="mf">41.28228759765625</code> <code class="p">],</code>         <code class="p">[</code> <code class="mf">48.584472656250085</code><code class="p">,</code> <code class="mf">41.80889892578125</code> <code class="p">],</code>     <code class="p">[</code> <code class="mf">47.492492675781335</code><code class="p">,</code> <code class="mf">42.9866943359375</code> <code class="p">],</code>         <code class="p">[</code> <code class="mf">47.590881347656278</code><code class="p">,</code> <code class="mf">43.660278320312528</code> <code class="p">],</code>     <code class="p">[</code> <code class="mf">46.682128906250028</code><code class="p">,</code> <code class="mf">44.609313964843807</code> <code class="p">],</code>         <code class="p">[</code> <code class="mf">47.675903320312585</code><code class="p">,</code> <code class="mf">45.641479492187557</code> <code class="p">],</code>     <code class="p">[</code> <code class="mf">48.645507812500085</code><code class="p">,</code> <code class="mf">45.806274414062557</code> <code class="p">]</code>         <code class="err">…</code></pre> 
<p id="hey_finally_t">Hey, finally, this is starting to look familiar!</p> 
<p id="excitedly_now_">Excitedly, now we copy our new GeoJSON into our D3 directory.  I rename mine 
<span class="emphasis">
<em>oceans.json</em></span>, copy an earlier HTML document, and in the D3 code, simply change the reference from <code class="literal">us-states.json</code> to <code class="literal">oceans.json</code>, and then get the result shown in 

<a class="xref" href="#oceans" title="Figure 12-8. GeoJSON showing, um, the world’s oceans?">Figure 12-8</a>.</p> 
<div class="figure" id="oceans"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1208.png" alt="GeoJSON showing, um, the world’s oceans?"></div></div> 
<div class="figure-title">Figure 12-8. GeoJSON showing, um, the world’s oceans?</div> </div> 
<p id="blaaa_what_is_">Blaaa!  What is that?!  Whatever it is, you can see it in 
<span class="emphasis">
<em>08_oceans.html</em></span>.</p> 
<p id="in_my_haste_i_">In my haste, I forgot to update the projection!  Let’s make one tiny change, from 
<span class="keep-together"><code class="literal">albersUsa</code></span> to <code class="literal">mercator</code> (see 

<a class="xref" href="#oceans2" title="Figure 12-9. GeoJSON of the world’s oceans, now properly projected">Figure 12-9</a>).</p> 
<div class="figure" id="oceans2"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1209.png" alt="GeoJSON of the world’s oceans, now properly projected"></div></div> 
<div class="figure-title">Figure 12-9. GeoJSON of the world’s oceans, now properly projected</div> </div> 
<p id="see_the_result_">See the result in 
<span class="emphasis">
<em>09_mercator.html</em></span>—oceanic GeoJSON paths, downloaded, parsed, and visualized.

<a id="id569480" class="indexterm"></a>

<a id="id569490" class="indexterm"></a></p> </div>
<section class="chapter" data-original-filename="13_exporting.asciidoc" id="_exporting">
<div class="titlepage">
<div>
<div>
<h1 class="title">Chapter 13. Exporting</h1></div></div></div> 
<p id="sometimes_you_n">Sometimes you need to take your visualization beyond the browser, such as when you’re asked to present your work in a TED talk or in your first solo show at MoMA.</p> 
<p id="here_are_three_">Here are three easy ways to get D3 visualizations out of D3 and into formats suitable for other, noninteractive media.  D3 has no explicit “export” function built in (although some people have built their own), so what follows are simple techniques that will work for any SVG image in a web browser.

<a id="ix_dvexp" class="indexterm"></a>

<a id="ix_expvis" class="indexterm"></a></p> 
<div class="sect1" data-original-filename="13_exporting.asciidoc" id="_bitmaps"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Bitmaps</h2></div></div></div> 
<p id="the_easiest_and">The easiest and lowest-quality option is, obviously, to take a screenshot.  Depending on your operating system, this can be done using the Print Screen button on a PC, or ⌘-Shift-4 on the Mac.  (Drag those crosshairs over the area you want to capture, release, and check your desktop for a PNG image.)

<a id="id569577" class="indexterm"></a></p> 
<p id="is_a_bitmap_scr">

<a class="xref" href="#bitmap_export" title="Figure 13-1. A PNG screenshot">Figure 13-1</a> is a bitmap screenshot I made using the latter technique.</p> 
<div class="figure" id="bitmap_export"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1301.png" alt="A PNG screenshot"></div></div> 
<div class="figure-title">Figure 13-1. A PNG screenshot</div> </div> 
<p id="this_is_easy_an">This is easy and quick, but generates a bitmap image at screen resolution.  So, as you can see, the image won’t scale up nicely, nor print with sharp edges.  This approach is 
<span class="keep-together">probably</span> suitable only for reuse on-screen.  (The exception to this is if you have a super high-res display, then the resolution will be much finer.)</p> </div> 
<div class="sect1" data-original-filename="13_exporting.asciidoc" id="_pdf"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">PDF</h2></div></div></div> 
<p id="portable_docume">Portable Document Format documents can contain vector-based artwork, such as SVG images, so exporting to PDF gives you a quick, scalable copy of your visualization (see 

<a class="xref" href="#pdf_export" title="Figure 13-2. A PDF maintains the original vector data for clarity">Figure 13-2</a>).

<a id="id569652" class="indexterm"></a></p> 
<div class="figure" id="pdf_export"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1302.png" alt="A PDF maintains the original vector data for clarity"></div></div> 
<div class="figure-title">Figure 13-2. A PDF maintains the original vector data for clarity</div> </div> 
<p id="on_the_mac_in_">On the Mac, in your browser, go to File→Print.  Then look for the PDF menu, and choose Save as PDF.</p> 
<p id="on_windows_or_l">On Windows or Linux, you might need to install a third-party utility to enable print-to-PDF functionality.  (I’ve heard doPDF for Windows works, and it’s free.)

<a id="id569694" class="indexterm"></a></p> </div> 
<div class="sect1" data-original-filename="13_exporting.asciidoc" id="_svg"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">SVG</h2></div></div></div> 
<p id="finally_it_pro">Finally, it probably occurred to you that, because we are using D3 to generate images in SVG format, why not just save out a copy of the SVG image?  This has all the benefits of PDF: You maintain the original vector data, it’s scalable, and you can even bring the results into Illustrator or another SVG-compatible editor and tweak it after the fact.  (This is true to a certain extent for PDF files as well, but depending on the PDF generator, sometimes elements get grouped and layered in unexpected ways.)

<a id="id569724" class="indexterm"></a>

<a id="id569732" class="indexterm"></a></p> 
<p id="the_simplest_wa">The simplest way is to simply copy the SVG code straight out of the DOM (see 

<a class="xref" href="#copy_the_svg" title="Figure 13-3. Copying the D3-generated SVG code from the DOM">Figure 13-3</a>).  First, inspect the SVG element.  Click the element in the web inspector, and then click Copy.</p> 
<div class="figure" id="copy_the_svg"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1303.png" alt="Copying the D3-generated SVG code from the DOM"></div></div> 
<div class="figure-title">Figure 13-3. Copying the D3-generated SVG code from the DOM</div> </div> 
<p id="switch_back_to_">Switch back to your text editor, and paste the contents into a new file, as shown in 

<a class="xref" href="#paste_the_svg" title="Figure 13-4. SVG code pasted into a new document">Figure 13-4</a>.</p> 
<div class="figure" id="paste_the_svg"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1304.png" alt="SVG code pasted into a new document"></div></div> 
<div class="figure-title">Figure 13-4. SVG code pasted into a new document</div> </div> 
<p id="then_just_save_">Then just save the file as 
<span class="emphasis">
<em>something.svg</em></span>.  Now you can open it up in Illustrator, as shown in 

<a class="xref" href="#svg_in_illustrator" title="Figure 13-5. Exported SVG opened in Illustrator">Figure 13-5</a>, or any other SVG-compatible program.</p> 
<div class="figure" id="svg_in_illustrator"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1305.png" alt="Exported SVG opened in Illustrator"></div></div> 
<div class="figure-title">Figure 13-5. Exported SVG opened in Illustrator</div> </div> 
<p id="as_you_can_see__id3">As you can see in 

<a class="xref" href="#edit_the_svg" title="Figure 13-6. SVG elements selected and highlighted">Figure 13-6</a>, all of the elements remain individually selectable and editable.  In the version shown in 

<a class="xref" href="#edited_svg_in_illustrator" title="Figure 13-7. My groundbreaking image, made even more so with some manual touch-ups">Figure 13-7</a>, I’ve made some Tuftean enhancements to my design, adding variable-weight strokes and a neutral, lavender fill for a visually “calming” effect.  (To be clear, this is a joke, and neither Tufte nor I endorse this 
<span class="keep-together">approach</span>.)</p> 
<div class="figure" id="edit_the_svg"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1306.png" alt="SVG elements selected and highlighted"></div></div> 
<div class="figure-title">Figure 13-6. SVG elements selected and highlighted</div> </div> 
<div class="figure" id="edited_svg_in_illustrator"> 
<div class="figure-contents">
<div class="mediaobject">
<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1307.png" alt="My groundbreaking image, made even more so with some manual touch-ups"></div></div> 
<div class="figure-title">Figure 13-7. My groundbreaking image, made even more so with some manual 
<span class="keep-together">touch-ups</span> </div> </div> 
<p id="as_you_can_see_id3">As you can see, there are many options for getting your work out of the browser, documented, and saved for use in other contexts, whether for print or for the screen.

<a id="id569910" class="indexterm"></a>

<a id="id569918" class="indexterm"></a></p>
<section class="appendix" data-original-filename="14_appendix.asciidoc" id="further_study">
<div class="titlepage">
<div>
<div>
<h1 class="title">Appendix A. Appendix: Further Study</h1></div></div></div> 
<p id="you_are_a_troup">You are a trouper for making it this far.  We’ve covered a lot of ground, and by now you have a decent handle on D3’s basic concepts and common techniques.  If you’ve learned anything, I hope it’s that there are always several (or tens, or hundreds of) ways to accomplish the same task—that’s the joy of programming, right?  I’ve presented the ways that, to me, are the simplest or most intuitive, and the least difficult to understand.  But there are probably 
<span class="emphasis">
<em>better</em></span> ways to do anything that you learned in this book, whether “better” means “more computationally efficient” or “makes more sense to you and your way of working.”  I’m a fan of the latter definition.  Programming is like solving a puzzle; it’s up to you to figure out how to tell the computer what to do what you want—using language that you, the human, can still understand.

<a id="id569959" class="indexterm"></a></p> 
<p id="d_is_a_powerfu">D3 is a powerful tool, and we’ve only scratched the surface.  As you begin work on your own visualization projects, you’ll discover many additional helpful methods and sneaky shortcuts.  There are lots of valuable bits that I didn’t cover here, such as D3’s built-in methods for working with date and time values, dynamically selecting and calculating colors, and painlessly manipulating arrays, for all your client-side data processing needs—just to name a few.  There is a 
<span class="emphasis">
<em>lot</em></span> to this tool.  I’ve tried to introduce you to the core concepts, and now you’re ready to go dig into the pieces that really interest you.</p> 
<p id="so_where_to_tu">So, where to turn next?  Here’s a collection of valuable resources to aid you in your quest.  Keep in mind that the D3 software itself is still evolving, and so are these resources.  By the time you read this, there might be some other helpful website or set of tutorials not mentioned here.  That is why I recommend that you don’t just read, but 
<span class="emphasis">
<em>get involved</em></span> with the D3 community.  Join 

<a class="ulink" href="https://groups.google.com/forum/#!forum/d3-js" target="_top">the Google Group</a>, follow people on Twitter, and keep your eyes open for the latest developments.  Start a discussion, and meet fellow data visualizers in your local area.  If there aren’t D3 datavis groups getting together in your area yet, then start one yourself.  The more we can learn from each other, the better.</p> 
<p id="after_all_havi">After all, having worked through this book, you’re part of the community now (whether you like it or not).  Welcome!</p> 
<div class="sect1" data-original-filename="14_appendix.asciidoc" id="_books"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Books</h2></div></div></div> 
<p id="getting_startin">

<a class="ulink" href="http://shop.oreilly.com/product/0636920025429.do" target="_top">
<span class="emphasis">
<em>Getting Starting with D3</em></span></a> by Mike Dewar. O’Reilly, 2012.</p> 
<p id="yes_theres_on">Yes, there’s only one other book on D3 so far.  Mike Dewar’s introduction tackles some more advanced topics, and includes sample projects with real-world data from New York City’s transportation system.  (Fun!)</p> </div> 
<div class="sect1" data-original-filename="14_appendix.asciidoc" id="_websites"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Websites</h2></div></div></div> 
<div class="variablelist" id="djsorg_your_s">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="http://d3js.org" target="_top">d3js.org</a> </span></dt> 
<dd> Your starting point for everything D3. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Gallery" target="_top">github.com/mbostock/d3/wiki/Gallery</a> </span></dt> 
<dd> The D3 gallery contains 
<span class="emphasis">
<em>hundreds</em></span> of examples.  Add your own work! </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bl.ocks.org/mbostock" target="_top">bl.ocks.org/mbostock</a> </span></dt> 
<dd> Even more examples, in this case all by Mike Bostock, each one typically highlighting just one of D3’s features. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/API-Reference" target="_top">github.com/mbostock/d3/wiki/API-Reference</a> </span></dt> 
<dd> The D3 API reference, an essential reference for every method and its parameters. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://stackoverflow.com/questions/tagged/d3.js" target="_top">stackoverflow.com/questions/tagged/d3.js</a> </span></dt> 
<dd> When you get stuck, post questions on StackOverflow with the <code class="literal">d3.js</code> tag. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://groups.google.com/forum/?fromgroups#!forum/d3-js" target="_top">groups.google.com/forum/?fromgroups#!forum/d3-js</a> </span></dt> 
<dd> Everyone who’s anyone is on the D3 Google Group.  Find out about the latest projects and developments here.  (Please save technical questions for StackOverflow.) </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://bl.ocks.org" target="_top">bl.ocks.org</a> </span></dt> 
<dd> A service for posting code hosted on GitHub’s Gist, by Mike Bostock.  Perfect for quickly sharing your work with others, such as when seeking help on StackOverflow or boasting about your latest triumph on the Google Group. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://blog.visual.ly/creating-animations-and-transitions-with-d3-js/" target="_top">blog.visual.ly/creating-animations-and-transitions-with-d3-js/</a> </span></dt> 
<dd> An excellent tutorial on 
<span class="emphasis">
<em>Creating Animations and Transitions With D3</em></span> with lots of inline, interactive examples by Jérôme Cukier. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://www.d3noob.org" target="_top">d3noob.org</a> </span></dt> 
<dd> A new, promising resource for D3 tips and tricks. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="http://tributary.io" target="_top">tributary.io</a> </span></dt> 
<dd> A live-coding environment for experimenting with D3 code, by Ian Johnson. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://github.com/d3/d3-plugins" target="_top">D3 Plug-ins</a> </span></dt> 
<dd> A listing of all the official plug-ins that extend D3’s functionality, in case it doesn’t do enough for you already. </dd> </dl></div> </div> 
<div class="sect1" data-original-filename="14_appendix.asciidoc" id="_twitterers"> 
<div class="titlepage">
<div>
<div>
<h2 class="title">Twitterers</h2></div></div></div> 
<p id="twitter_is_a_gr">Twitter is a great way to find out about the latest projects and D3 developments.  At the risk of omitting many amazing people, here are some you should follow:</p> 
<div class="variablelist" id="mbostock_mike_">
<dl class="variablelist"> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/mbostock" target="_top">@mbostock</a> </span></dt> 
<dd> Mike Bostock, for announcements on D3’s progress as well as new visualizations for 
<span class="emphasis">
<em>The New York Times</em></span>. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/jasondavies" target="_top">@jasondavies</a> </span></dt> 
<dd> Jason Davies, for all manner of geographic and mathematical mapping experiments. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/d3visualization" target="_top">@d3visualization</a> </span></dt> 
<dd> Christophe Viau, for frequent updates from all over the D3 universe. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/enjalot" target="_top">@enjalot</a> </span></dt> 
<dd> Ian Johnson, for loads of new coding tools and techniques, plus video tutorials. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/syntagmatic" target="_top">@syntagmatic</a> </span></dt> 
<dd> Kai Chang, for too many D3 experiments to count. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/jcukier" target="_top">@jcukier</a> </span></dt> 
<dd> Jérôme Cukier, for innovative visualization projects with insightful process notes. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/darkgreener" target="_top">@darkgreener</a> </span></dt> 
<dd> Anna Powell-Smith, for beautiful interactive visualizations that explore personally relevant data. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/vlandham" target="_top">@vlandham</a> </span></dt> 
<dd> Jim Vallandingham, for excellent process notes on projects as well as great tutorials. </dd> 
<dt>
<span class="term"> 

<a class="ulink" href="https://twitter.com/alignedleft" target="_top">@alignedleft</a> </span></dt> 
<dd> Scott Murray, for learning about errata, updates, and revisions to this book, as well as future data-driven projects. </dd> </dl></div> 
<p id="i_should_acknow">I should acknowledge that, yes, there are mostly men listed here.  As of this writing, the community of D3 users and contributors tends to skew quite male.  I hope that future editions of this book can confidently include a more diverse listing.</p>