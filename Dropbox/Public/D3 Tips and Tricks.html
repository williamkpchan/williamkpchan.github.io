
<style type="text/css">

body {
 font-size:20px;
 margin:8%;
 background-color: #000000;
 color: #109030;
}
a { text-decoration: none;
	color: #28B8B8;}
a:visited {	color: #389898;}
A:hover {	color: yellow;}
A:focus {	color: red;}
code { color: steelblue; background-color: #001000}
pre { color: gray; background-color: #001010}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>
$(document).ready(function(){
  $('h2, h3, h4').click(function(){
  parent.history.back();
  return false;
  });
});
</script>

<h1>D3 Tips and Tricks v3.x</h1>

<div id="ttoc"></div>

<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-acknowledgements'>Acknowledgements</a>
    <ul>
      <li>
        <a href='#leanpub-auto-mike'>Mike</a>
      </li>
      <li>
        <a href='#leanpub-auto-partners-supporters-and-contributors'>Partners, Supporters and Contributors.</a>
      </li>
      <li>
        <a href='#leanpub-auto-proof-reading'>Proof Reading</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-d3js-community'>The d3.js Community</a>
      </li>
      <li>
        <a href='#leanpub-auto-cover-art'>Cover art</a>
      </li>
      <li>
        <a href='#leanpub-auto-leanpub'>Leanpub</a>
      </li>
      <li>
        <a href='#leanpub-auto-make-sure-you-get-the-most-up-to-date-copy-of-d3-tips-and-tricks'>Make sure you get the most up to date copy of D3 Tips and Tricks</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-what-is-d3js'>What is d3.js?</a>
  </li>
  <li>
    <a href='#leanpub-auto-introduction'>Introduction</a>
  </li>
  <li>
    <a href='#leanpub-auto-what-do-you-need-to-get-started'>What do you need to get started?</a>
    <ul>
      <li>
        <a href='#leanpub-auto-html'>HTML</a>
      </li>
      <li>
        <a href='#leanpub-auto-javascript'>JavaScript</a>
      </li>
      <li>
        <a href='#leanpub-auto-cascading-style-sheets-css'>Cascading Style Sheets (CSS)</a>
      </li>
      <li>
        <a href='#leanpub-auto-web-servers'>Web Servers</a>
      </li>
      <li>
        <a href='#leanpub-auto-php'>PHP</a>
      </li>
      <li>
        <a href='#leanpub-auto-other-useful-stuff'>Other Useful Stuff</a>
        <ul>
          <li>
            <a href='#leanpub-auto-text-editor'>Text Editor</a>
          </li>
          <li>
            <a href='#leanpub-auto-getting-d3'>Getting D3</a>
          </li>
          <li>
            <a href='#leanpub-auto-where-to-get-information-on-d3js'>Where to get information on d3.js</a>
            <ul>
              <li>
                <a href='#leanpub-auto-d3jsorg'>d3js.org</a>
              </li>
              <li>
                <a href='#leanpub-auto-google-groups'>Google Groups</a>
              </li>
              <li>
                <a href='#leanpub-auto-stack-overflow'>Stack Overflow</a>
              </li>
              <li>
                <a href='#leanpub-auto-github'>Github</a>
              </li>
              <li>
                <a href='#leanpub-auto-blocksorg'>bl.ocks.org</a>
              </li>
              <li>
                <a href='#leanpub-auto-twitter'>Twitter</a>
              </li>
              <li>
                <a href='#leanpub-auto-books'>Books</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-starting-with-a-basic-graph'>Starting with a basic graph</a>
    <ul>
      <li>
        <a href='#leanpub-auto-html-1'>HTML</a>
      </li>
      <li>
        <a href='#leanpub-auto-css'>CSS</a>
      </li>
      <li>
        <a href='#leanpub-auto-d3-javascript'>D3 JavaScript</a>
        <ul>
          <li>
            <a href='#leanpub-auto-setting-up-the-margins-and-the-graph-area'>Setting up the margins and the graph area.</a>
          </li>
          <li>
            <a href='#leanpub-auto-getting-the-data'>Getting the Data</a>
          </li>
          <li>
            <a href='#leanpub-auto-formatting-the-date--time'>Formatting the Date / Time.</a>
          </li>
          <li>
            <a href='#leanpub-auto-setting-scales-domains-and-ranges'>Setting Scales Domains and Ranges</a>
          </li>
          <li>
            <a href='#leanpub-auto-setting-up-the-axes'>Setting up the Axes</a>
          </li>
          <li>
            <a href='#leanpub-auto-adding-data-to-the-line-function'>Adding data to the line function</a>
          </li>
          <li>
            <a href='#leanpub-auto-adding-the-svg-canvas'>Adding the SVG Canvas.</a>
          </li>
          <li>
            <a href='#leanpub-auto-actually-drawing-something'>Actually Drawing Something!</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up'>Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-things-you-can-do-with-the-basic-graph'>Things you can do with the basic graph</a>
    <ul>
      <li>
        <a href='#leanpub-auto-adding-axis-labels'>Adding Axis Labels</a>
      </li>
      <li>
        <a href='#leanpub-auto-how-to-add-a-title-to-your-graph'>How to add a title to your graph</a>
      </li>
      <li>
        <a href='#smoothing'>Smoothing out graph lines</a>
      </li>
      <li>
        <a href='#leanpub-auto-adding-grid-lines-to-a-graph'>Adding grid lines to a graph</a>
        <ul>
          <li>
            <a href='#leanpub-auto-the-grid-line-css'>The grid line CSS</a>
          </li>
          <li>
            <a href='#leanpub-auto-define-the-grid-line-functions'>Define the grid line functions</a>
          </li>
          <li>
            <a href='#leanpub-auto-draw-the-lines'>Draw the lines</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-make-a-dashed-line'>Make a dashed line</a>
      </li>
      <li>
        <a href='#leanpub-auto-filling-an-area-under-the-graph'>Filling an area under the graph</a>
        <ul>
          <li>
            <a href='#leanpub-auto-css-for-an-area-fill'>CSS for an area fill</a>
          </li>
          <li>
            <a href='#leanpub-auto-define-the-area-function'>Define the area function</a>
          </li>
          <li>
            <a href='#leanpub-auto-draw-the-area'>Draw the area</a>
          </li>
          <li>
            <a href='#leanpub-auto-filling-an-area-above-the-line'>Filling an area above the line</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-adding-a-drop-shadow-to-allow-text-to-stand-out-on-graphics'>Adding a drop shadow to allow text to stand out on graphics.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-css-for-white-shadowy-background'>CSS for white shadowy background</a>
          </li>
          <li>
            <a href='#leanpub-auto-drawing-the-white-shadowy-background'>Drawing the white shadowy background.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-adding-more-than-one-line-to-a-graph'>Adding more than one line to a graph</a>
      </li>
      <li>
        <a href='#leanpub-auto-labelling-multiple-lines-on-a-graph'>Labelling multiple lines on a graph</a>
      </li>
      <li>
        <a href='#leanpub-auto-multiple-axes-for-a-graph'>Multiple axes for a graph</a>
      </li>
      <li>
        <a href='#leanpub-auto-how-to-rotate-the-text-labels-for-the-x-axis'>How to rotate the text labels for the x Axis.</a>
      </li>
      <li>
        <a href='#leanpub-auto-format-a-date--time-axis-with-specified-values'>Format a date / time axis with specified values</a>
      </li>
      <li>
        <a href='#leanpub-auto-update-data-dynamically---on-click'>Update data dynamically - On Click</a>
        <ul>
          <li>
            <a href='#leanpub-auto-adding-a-button'>Adding a Button</a>
          </li>
          <li>
            <a href='#leanpub-auto-updating-the-data'>Updating the data</a>
          </li>
          <li>
            <a href='#leanpub-auto-changes-to-the-d3js-code-layout'>Changes to the d3.js code layout</a>
          </li>
          <li>
            <a href='#leanpub-auto-whats-happening-in-the-code'>What’s happening in the code?</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-update-data-dynamically--automatically'>Update data dynamically – Automatically</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-elements-attributes-and-styles'>Elements, Attributes and Styles</a>
    <ul>
      <li>
        <a href='#EASframework'>The Framework</a>
      </li>
      <li>
        <a href='#leanpub-auto-elements'>Elements</a>
        <ul>
          <li>
            <a href='#leanpub-auto-circle'>Circle</a>
          </li>
          <li>
            <a href='#leanpub-auto-ellipse'>Ellipse</a>
          </li>
          <li>
            <a href='#leanpub-auto-rectangle'>Rectangle</a>
          </li>
          <li>
            <a href='#leanpub-auto-line'>Line</a>
          </li>
          <li>
            <a href='#leanpub-auto-polyline'>Polyline</a>
          </li>
          <li>
            <a href='#leanpub-auto-polygon'>Polygon</a>
          </li>
          <li>
            <a href='#leanpub-auto-path'>Path</a>
          </li>
          <li>
            <a href='#clipPath'>Clipped Path (AKA clipPath)</a>
          </li>
          <li>
            <a href='#leanpub-auto-text'>Text</a>
            <ul>
              <li>
                <a href='#leanpub-auto-anchor-at-the-bottom-middle-of-the-text'>Anchor at the bottom, middle of the text:</a>
              </li>
              <li>
                <a href='#leanpub-auto-anchor-at-the-bottom-right-of-the-text'>Anchor at the bottom, right of the text:</a>
              </li>
              <li>
                <a href='#leanpub-auto-anchor-at-the-middle-left-of-the-text'>Anchor at the middle, left of the text:</a>
              </li>
              <li>
                <a href='#leanpub-auto-anchor-in-the-middle-centre-of-the-text'>Anchor in the middle, centre of the text:</a>
              </li>
              <li>
                <a href='#leanpub-auto-anchor-in-the-middle-right-of-the-text'>Anchor in the middle, right of the text:</a>
              </li>
              <li>
                <a href='#leanpub-auto-anchor-at-the-top-left-of-the-text'>Anchor at the top, left of the text:</a>
              </li>
              <li>
                <a href='#leanpub-auto-anchor-at-the-top-middle-of-the-text'>Anchor at the top, middle of the text:</a>
              </li>
              <li>
                <a href='#leanpub-auto-anchor-at-the-top-right-of-the-text'>Anchor at the top, right of the text:</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-attributes'>Attributes</a>
        <ul>
          <li>
            <a href='#leanpub-auto-x-y'><code>x</code>, <code>y</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-x1-x2-y1-y2'><code>x1</code>, <code>x2</code>, <code>y1</code>, <code>y2</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-points'>points</a>
          </li>
          <li>
            <a href='#leanpub-auto-cx-cy'><code>cx</code>, <code>cy</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-r'><code>r</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-rx-ry'><code>rx</code>, <code>ry</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-transform-translatexy-scalek-rotatea'><code>transform (translate(x,y), scale(k), rotate(a))</code></a>
            <ul>
              <li>
                <a href='#leanpub-auto-transform-translatexy'><code>transform (translate(x,y))</code></a>
              </li>
              <li>
                <a href='#leanpub-auto-transform-scalek'><code>transform (scale(k))</code></a>
              </li>
              <li>
                <a href='#leanpub-auto-transform-rotatea'><code>transform (rotate(a))</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href='#leanpub-auto-width-height'><code>width</code>, <code>height</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-text-anchor'><code>text-anchor</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-dx-dy'><code>dx</code>, <code>dy</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-textlength'><code>textLength</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-lengthadjust'><code>lengthAdjust</code></a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-styles'>Styles</a>
        <ul>
          <li>
            <a href='#leanpub-auto-fill'><code>fill</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-stroke'><code>stroke</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-opacity'><code>opacity</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-fill-opacity'><code>fill-opacity</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-stroke-opacity'><code>stroke-opacity</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-stroke-width'><code>stroke-width</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-stroke-dasharray'><code>stroke-dasharray</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-stroke-linecap'><code>stroke-linecap</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-stroke-linejoin'><code>stroke-linejoin</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-writing-mode'><code>writing-mode</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-glyph-orientation-vertical'><code>glyph-orientation-vertical</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-using-styles-in-cascading-style-sheets'>Using styles in Cascading Style Sheets</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-assorted-tips-and-tricks'>Assorted Tips and Tricks</a>
    <ul>
      <li>
        <a href='#leanpub-auto-change-a-line-chart-into-a-scatter-plot'>Change a line chart into a scatter plot</a>
      </li>
      <li>
        <a href='#leanpub-auto-adding-tooltips'>Adding tooltips.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-transitions'>Transitions</a>
          </li>
          <li>
            <a href='#leanpub-auto-events'>Events</a>
          </li>
          <li>
            <a href='#leanpub-auto-get-tipping'>Get tipping</a>
          </li>
          <li>
            <a href='#leanpub-auto-onmouseover'>on.mouseover</a>
          </li>
          <li>
            <a href='#leanpub-auto-onmouseout'>on.mouseout</a>
          </li>
          <li>
            <a href='#leanpub-auto-including-an-html-link-in-a-tool-tip'>Including an HTML link in a tool tip</a>
            <ul>
              <li>
                <a href='#leanpub-auto-moar-links'>Moar Links!</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-what-are-the-predefined-named-colours'>What are the predefined, named colours?</a>
      </li>
      <li>
        <a href='#leanpub-auto-selecting--filtering-a-subset-of-objects'>Selecting / filtering a subset of objects</a>
      </li>
      <li>
        <a href='#leanpub-auto-select-items-with-an-if-statement'>Select items with an IF statement.</a>
      </li>
      <li>
        <a href='#leanpub-auto-applying-a-colour-gradient-to-a-line-based-on-value'>Applying a colour gradient to a line based on value.</a>
      </li>
      <li>
        <a href='#leanpub-auto-applying-a-colour-gradient-to-an-area-fill'>Applying a colour gradient to an area fill.</a>
      </li>
      <li>
        <a href='#leanpub-auto-show--hide-an-element-by-clicking-on-another-element'>Show / hide an element by clicking on another element</a>
        <ul>
          <li>
            <span>&#160;</span>
            <ul>
              <li>
                <a href='#leanpub-auto-the-code'>The code</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-export-an-image-from-a-d3js-page-as-a-svg-or-bitmap'>Export an image from a d3.js page as a SVG or bitmap</a>
        <ul>
          <li>
            <a href='#leanpub-auto-bitmaps'>Bitmaps</a>
          </li>
          <li>
            <a href='#leanpub-auto-vector-graphics-specifically-svg'>Vector Graphics (Specifically SVG)</a>
          </li>
          <li>
            <a href='#leanpub-auto-lets-get-exporting'>Let’s get exporting!</a>
            <ul>
              <li>
                <a href='#leanpub-auto-copying-the-image-off-the-web-page'>Copying the image off the web page</a>
              </li>
              <li>
                <a href='#leanpub-auto-open-the-svg-image-and-edit'>Open the SVG Image and Edit</a>
              </li>
              <li>
                <a href='#leanpub-auto-saving-as-a-bitmap'>Saving as a bitmap</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-using-html-inputs-with-d3js'>Using HTML inputs with d3.js</a>
        <ul>
          <li>
            <a href='#leanpub-auto-what-is-an-html-input'>What is an HTML input?</a>
          </li>
          <li>
            <a href='#leanpub-auto-using-a-range-input-with-d3js'>Using a <code>range</code> input with d3.js</a>
            <ul>
              <li>
                <a href='#leanpub-auto-the-code-1'>The code</a>
              </li>
              <li>
                <a href='#leanpub-auto-the-explanation'>The explanation</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='#leanpub-auto-using-more-than-one-input'>Using more than one input</a>
            <ul>
              <li>
                <a href='#leanpub-auto-the-code-2'>The code</a>
              </li>
              <li>
                <a href='#leanpub-auto-the-explanation-1'>The explanation</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='#leanpub-auto-rotate-text-with-an-input'>Rotate text with an input</a>
            <ul>
              <li>
                <a href='#leanpub-auto-the-explanation-2'>The explanation</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='#leanpub-auto-use-a-number-input-with-d3js'>Use a <code>number</code> input with d3.js</a>
          </li>
          <li>
            <a href='#leanpub-auto-change-more-than-one-element-with-an-input'>Change more than one element with an input</a>
            <ul>
              <li>
                <a href='#leanpub-auto-the-code-3'>The code</a>
              </li>
              <li>
                <a href='#leanpub-auto-the-explanation-3'>The explanation</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-add-an-html-table-to-your-graph'>Add an HTML table to your graph</a>
        <ul>
          <li>
            <a href='#leanpub-auto-html-tables'>HTML Tables</a>
          </li>
          <li>
            <a href='#leanpub-auto-first-the-css'>First the CSS</a>
          </li>
          <li>
            <a href='#leanpub-auto-now-the-d3js-code'>Now the d3.js code</a>
          </li>
          <li>
            <a href='#leanpub-auto-a-small-but-cunning-change'>A small but cunning change…</a>
          </li>
          <li>
            <a href='#leanpub-auto-explaining-the-d3js-code-reloaded'>Explaining the d3.js code (reloaded).</a>
          </li>
          <li>
            <a href='#leanpub-auto-wrap-up-1'>Wrap up</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-more-table-madness-sorting-prettifying-and-adding-columns'>More table madness: sorting, prettifying and adding columns</a>
        <ul>
          <li>
            <a href='#leanpub-auto-add-another-column-of-information'>Add another column of information:</a>
          </li>
          <li>
            <a href='#leanpub-auto-sorting-on-a-column'>Sorting on a column</a>
          </li>
          <li>
            <a href='#leanpub-auto-prettifying-actually-just-capitalising-the-header-for-each-column'>Prettifying (actually just capitalising the header for each column)</a>
          </li>
          <li>
            <a href='#leanpub-auto-add-borders'>Add borders</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-adding-web-links-to-d3js-objects'>Adding web links to d3.js objects</a>
        <ul>
          <li>
            <a href='#leanpub-auto-its-all-about-the-a-and-the-xlink'>It’s all about the ‘a’ and the ‘xlink’</a>
          </li>
          <li>
            <a href='#leanpub-auto-adding-in-the-links'>Adding in the links</a>
          </li>
          <li>
            <a href='#leanpub-auto-making-the-mouse-pointer-ignore-an-object'>Making the mouse pointer ignore an object</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-understanding-javascript-object-notation-json'>Understanding JavaScript Object Notation (JSON)</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-yahoo-query-language-yql-to-get-data'>Using the Yahoo Query Language (YQL) to get data.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-yql-by-example'>YQL by example</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-using-plunker-for-development-and-hosting-your-d3-creations'>Using Plunker for development and hosting your D3 creations.</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-manipulating-data'>Manipulating data</a>
    <ul>
      <li>
        <a href='#leanpub-auto-how-to-use-data-imported-from-a-csv-file-with-spaces-in-the-header'>How to use data imported from a csv file with spaces in the header.</a>
      </li>
      <li>
        <a href='#leanpub-auto-extracting-data-from-a-portion-of-a-string'>Extracting data from a portion of a string.</a>
      </li>
      <li>
        <a href='#leanpub-auto-grouping-and-summing-data-d3nest'>Grouping and summing data (d3.nest).</a>
      </li>
      <li>
        <a href='#leanpub-auto-padding-for-zero-values'>Padding for zero values</a>
        <ul>
          <li>
            <a href='#leanpub-auto-lo-dash'>Lo-Dash</a>
            <ul>
              <li>
                <a href='#leanpub-auto-find'>_.find</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='#leanpub-auto-the-explunit-method'>The explunit method</a>
            <ul>
              <li>
                <a href='#leanpub-auto-build-the-array'>Build the array</a>
                <ul>
                  <li>
                    <a href='#leanpub-auto-scaletickscount'><code>scale.ticks([count])</code></a>
                  </li>
                </ul>
              </li>
              <li>
                <a href='#leanpub-auto-populate-the-array'>Populate the array</a>
                <ul>
                  <li>
                    <a href='#leanpub-auto-xticks'><code>x.ticks()</code></a>
                  </li>
                  <li>
                    <a href='#leanpub-auto-mapobject'><code>.map([object])</code></a>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-bar-charts'>Bar Charts</a>
    <ul>
      <li>
        <a href='#leanpub-auto-the-data'>The data</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-code-4'>The code</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-bar-chart-explained'>The bar chart explained</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-sankey-diagrams'>Sankey Diagrams</a>
    <ul>
      <li>
        <a href='#leanpub-auto-what-is-a-sankey-diagram'>What is a Sankey Diagram?</a>
      </li>
      <li>
        <a href='#leanpub-auto-how-d3js-sankey-diagrams-want-their-data-formatted'>How d3.js Sankey Diagrams want their data formatted</a>
      </li>
      <li>
        <a href='#leanpub-auto-description-of-the-code'>Description of the code</a>
      </li>
      <li>
        <a href='#leanpub-auto-formatting-data-for-sankey-diagrams'>Formatting data for Sankey diagrams</a>
        <ul>
          <li>
            <a href='#leanpub-auto-from-a-json-file-with-numeric-link-values'>From a JSON file with numeric link values</a>
          </li>
          <li>
            <a href='#leanpub-auto-from-a-json-file-with-links-as-names'>From a JSON file with links as names</a>
          </li>
          <li>
            <a href='#leanpub-auto-from-a-csv-with-source-target-and-value-info-only'>From a CSV with ‘source’, ‘target’ and ‘value’ info only.</a>
          </li>
          <li>
            <a href='#leanpub-auto-from-mysql-as-link-information-only-automatically'>From MySQL as link information (only automatically).</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-sankey-diagram-case-study'>Sankey diagram case study</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-tree-diagrams'>Tree Diagrams</a>
    <ul>
      <li>
        <a href='#leanpub-auto-what-is-a-tree-diagram'>What is a Tree Diagram?</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-simple-tree-diagram-explained'>A simple Tree Diagram explained</a>
      </li>
      <li>
        <a href='#leanpub-auto-styling-nodes-in-a-tree-diagram'>Styling nodes in a tree diagram</a>
        <ul>
          <li>
            <a href='#leanpub-auto-changing-the-nodes-to-different-shapes'>Changing the nodes to different shapes</a>
          </li>
          <li>
            <a href='#leanpub-auto-using-images-as-nodes'>Using images as nodes</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-making-a-vertical-tree-diagram'>Making a vertical tree diagram</a>
      </li>
      <li>
        <a href='#treeFromFlat'>Generating a tree diagram from ‘flat’ data</a>
      </li>
      <li>
        <a href='#treeFromExternal'>Generating a tree diagram from external data</a>
      </li>
      <li>
        <a href='#leanpub-auto-generating-a-tree-diagram-from-a-csv-file'>Generating a tree diagram from a CSV file.</a>
      </li>
      <li>
        <a href='#leanpub-auto-an-interactive-tree-diagram'>An interactive tree diagram</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-force-layout-diagrams'>Force Layout Diagrams</a>
    <ul>
      <li>
        <a href='#leanpub-auto-what-is-a-force-layout-diagram'>What is a Force Layout Diagram?</a>
      </li>
      <li>
        <a href='#leanpub-auto-force-directed-graph-examples'>Force directed graph examples.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-basic-force-directed-graph-showing-directionality'>Basic force directed graph showing directionality</a>
          </li>
          <li>
            <a href='#leanpub-auto-directional-force-layout-diagram-node-highlighting'>Directional Force Layout Diagram (Node Highlighting)</a>
          </li>
          <li>
            <a href='#leanpub-auto-directional-force-layout-diagram--varying-link-opacity'>Directional Force Layout Diagram  (varying link opacity)</a>
          </li>
          <li>
            <a href='#leanpub-auto-directional-force-layout-diagram--unique-node-colour'>Directional Force Layout Diagram  (Unique Node Colour)</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-bullet-charts'>Bullet Charts</a>
    <ul>
      <li>
        <a href='#leanpub-auto-introduction-to-bullet-chart-structure'>Introduction to bullet chart structure</a>
      </li>
      <li>
        <a href='#leanpub-auto-d3js-code-for-bullet-charts'>D3.js code for bullet charts</a>
      </li>
      <li>
        <a href='#leanpub-auto-adapting-and-changing-bullet-chart-components'>Adapting and changing bullet chart components</a>
        <ul>
          <li>
            <a href='#leanpub-auto-understand-your-data'>Understand your data</a>
          </li>
          <li>
            <a href='#leanpub-auto-add-as-many-individual-charts-as-you-want'>Add as many individual charts as you want.</a>
          </li>
          <li>
            <a href='#leanpub-auto-add-more-ranges-and-measures'>Add more ranges and measures</a>
          </li>
          <li>
            <a href='#leanpub-auto-updating-a-bullet-chart-automatically'>Updating a bullet chart automatically</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-mapping-with-d3js'>Mapping with d3.js</a>
    <ul>
      <li>
        <a href='#leanpub-auto-examples'>Examples</a>
      </li>
      <li>
        <a href='#leanpub-auto-geojson-and-topojson'>GeoJSON and TopoJSON</a>
      </li>
      <li>
        <a href='#leanpub-auto-starting-with-a-simple-map'>Starting with a simple map</a>
        <ul>
          <li>
            <a href='#leanpub-auto-center'>center</a>
          </li>
          <li>
            <a href='#leanpub-auto-scale'>scale</a>
          </li>
          <li>
            <a href='#leanpub-auto-rotate'>rotate</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-zooming-and-panning-a-map'>Zooming and panning a map</a>
      </li>
      <li>
        <a href='#leanpub-auto-displaying-points-on-a-map'>Displaying points on a map</a>
      </li>
      <li>
        <a href='#leanpub-auto-making-maps-with-d3js-and-leafletjs-combined'>Making maps with d3.js and leaflet.js combined</a>
        <ul>
          <li>
            <a href='#leanpub-auto-leafletjs-overview'>leaflet.js Overview</a>
          </li>
          <li>
            <a href='#leanpub-auto-leaflet-map-with-d3js-objects-that-scale-with-the-map'>Leaflet map with d3.js objects that scale with the map</a>
          </li>
          <li>
            <a href='#leanpub-auto-leaflet-map-with-d3js-elements-that-are-overlaid-on-a-map'>Leaflet map with d3.js elements that are overlaid on a map</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-d3js-examples-explained'>D3.js Examples Explained</a>
    <ul>
      <li>
        <a href='#leanpub-auto-dynamically-retrieve-historical-stock-records-via-yql'>Dynamically retrieve historical stock records via YQL</a>
        <ul>
          <li>
            <a href='#leanpub-auto-purpose'>Purpose</a>
          </li>
          <li>
            <a href='#leanpub-auto-the-code-5'>The code</a>
          </li>
          <li>
            <a href='#leanpub-auto-the-description'>The description</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-linux-processes-via-interactive-tree-diagram'>Linux Processes via Interactive Tree diagram</a>
        <ul>
          <li>
            <a href='#leanpub-auto-purpose-1'>Purpose</a>
          </li>
          <li>
            <a href='#leanpub-auto-the-code-6'>The Code</a>
          </li>
          <li>
            <a href='#leanpub-auto-description'>Description</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-multi-line-graph-with-automatic-legend-and-toggling-show--hide-lines'>Multi-line graph with automatic legend and toggling show / hide lines.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-purpose-2'>Purpose</a>
          </li>
          <li>
            <a href='#leanpub-auto-the-code-7'>The Code</a>
          </li>
          <li>
            <a href='#leanpub-auto-description-1'>Description</a>
            <ul>
              <li>
                <a href='#leanpub-auto-nesting-the-data'>Nesting the data</a>
              </li>
              <li>
                <a href='#leanpub-auto-applying-the-colours'>Applying the colours</a>
              </li>
              <li>
                <a href='#leanpub-auto-adding-the-legend'>Adding the legend</a>
              </li>
              <li>
                <a href='#leanpub-auto-making-it-interactive'>Making it interactive</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-my-favourite-tooltip-method-for-a-line-graph'>My Favourite tooltip method for a line graph.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-purpose-3'>Purpose</a>
          </li>
          <li>
            <a href='#leanpub-auto-the-code-8'>The Code</a>
          </li>
          <li>
            <a href='#leanpub-auto-description-2'>Description</a>
            <ul>
              <li>
                <a href='#leanpub-auto-adding-the-circle-to-the-graph'>Adding the circle to the graph</a>
              </li>
              <li>
                <a href='#leanpub-auto-set-the-area-to-capture-the-mouse-movements'>Set the area to capture the mouse movements</a>
              </li>
              <li>
                <a href='#leanpub-auto-determining-which-date-will-be-highlighted'>Determining which date will be highlighted</a>
              </li>
              <li>
                <a href='#leanpub-auto-move-the-circle-to-the-appropriate-position'>Move the circle to the appropriate position</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='#leanpub-auto-complex-version'>Complex version</a>
            <ul>
              <li>
                <a href='#leanpub-auto-code--explanation'>Code / Explanation</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-exploring-event-data-by-combination-scatter-plot-and-interactive-line-graphs'>Exploring Event Data by Combination Scatter Plot and Interactive Line Graphs</a>
        <ul>
          <li>
            <a href='#leanpub-auto-purpose-4'>Purpose</a>
          </li>
          <li>
            <a href='#leanpub-auto-the-code-9'>The Code</a>
            <ul>
              <li>
                <a href='#leanpub-auto-wrangling-the-data'>Wrangling the data</a>
              </li>
              <li>
                <a href='#leanpub-auto-sizing-everything-up'>Sizing Everything Up</a>
              </li>
              <li>
                <a href='#leanpub-auto-the-scatter-plot'>The Scatter Plot</a>
              </li>
              <li>
                <a href='#leanpub-auto-date-and-time-graphs'>Date and Time Graphs</a>
              </li>
              <li>
                <a href='#leanpub-auto-mouse-movement-information-display'>Mouse Movement Information Display</a>
              </li>
              <li>
                <a href='#leanpub-auto-labelling'>Labelling</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#difference'>Difference Chart: Science vs Style.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-purpose-5'>Purpose</a>
          </li>
          <li>
            <a href='#leanpub-auto-the-code-10'>The Code</a>
          </li>
          <li>
            <a href='#leanpub-auto-description-3'>Description</a>
            <ul>
              <li>
                <a href='#leanpub-auto-nesting-the-data-1'>Nesting the data</a>
              </li>
              <li>
                <a href='#leanpub-auto-wrangle-the-data'>Wrangle the data</a>
              </li>
              <li>
                <a href='#leanpub-auto-cheating-with-the-domain'>Cheating with the domain</a>
              </li>
              <li>
                <a href='#leanpub-auto-data-vs-datum'><code>data</code> vs <code>datum</code></a>
              </li>
              <li>
                <a href='#leanpub-auto-setting-up-the-clippaths'>Setting up the <code>clipPath</code>s</a>
              </li>
              <li>
                <a href='#leanpub-auto-clipping-and-adding-the-areas'>Clipping and adding the areas</a>
              </li>
              <li>
                <a href='#leanpub-auto-draw-the-lines-and-the-axes'>Draw the lines and the axes</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='#leanpub-auto-adding-a-bit-more-to-our-difference-chart'>Adding a bit more to our difference chart.</a>
            <ul>
              <li>
                <a href='#leanpub-auto-add-a-y-axis-label'>Add a Y axis label</a>
              </li>
              <li>
                <a href='#leanpub-auto-add-a-title'>Add a title</a>
              </li>
              <li>
                <a href='#leanpub-auto-adding-the-legend-1'>Adding the legend</a>
              </li>
              <li>
                <a href='#leanpub-auto-link-the-areas'>Link the areas</a>
              </li>
              <li>
                <a href='#leanpub-auto-the-final-result'>The final result</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-crossfilter-dcjs-and-d3js-for-data-discovery'>Crossfilter, dc.js and d3.js for Data Discovery</a>
    <ul>
      <li>
        <a href='#leanpub-auto-introduction-to-crossfilter'>Introduction to Crossfilter</a>
        <ul>
          <li>
            <a href='#leanpub-auto-map-reduce'>Map-reduce</a>
          </li>
          <li>
            <a href='#leanpub-auto-what-can-crossfilter-do'>What can crossfilter do?</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-introduction-to-dcjs'>Introduction to dc.js</a>
        <ul>
          <li>
            <a href='#leanpub-auto-bar-chart'>Bar Chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-pie-chart'>Pie Chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-row-chart'>Row Chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-line-chart'>Line Chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-bubble-chart'>Bubble Chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-geo-choropleth-chart'>Geo Choropleth Chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-data-table'>Data Table</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-bare-bones-structure-for-dcjs-and-crossfilter-page'>Bare bones structure for dc.js and crossfilter page</a>
      </li>
      <li>
        <a href='#leanpub-auto-add-a-bar-chart'>Add a Bar Chart.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-position-the-bar-chart'>Position the bar chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-assign-the-bar-chart-type'>Assign the bar chart type</a>
          </li>
          <li>
            <a href='#leanpub-auto-dimension-and-group-the-bar-chart-data'>Dimension and group the bar chart data</a>
          </li>
          <li>
            <a href='#leanpub-auto-configure-the-bar-chart-parameters'>Configure the bar chart parameters</a>
          </li>
          <li>
            <a href='#leanpub-auto-just-one-more-thing'>Just one more thing…</a>
          </li>
          <li>
            <a href='#leanpub-auto-just-yet-another-thing'>Just yet another thing…</a>
            <ul>
              <li>
                <a href='#leanpub-auto-position-the-chart'>Position the chart</a>
              </li>
              <li>
                <a href='#leanpub-auto-assign-type'>Assign type</a>
              </li>
              <li>
                <a href='#leanpub-auto-dimension-and-group'>Dimension and Group</a>
              </li>
              <li>
                <a href='#leanpub-auto-configure-chart-parameters'>Configure chart parameters</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-add-a-line-chart'>Add a Line Chart.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-position-the-line-chart'>Position the line chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-assign-the-line-chart-type'>Assign the line chart type</a>
          </li>
          <li>
            <a href='#leanpub-auto-dimension-and-group-the-line-chart-data'>Dimension and group the line chart data</a>
          </li>
          <li>
            <a href='#leanpub-auto-configure-the-line-chart-parameters'>Configure the line chart parameters</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-adding-tooltips-to-a-line-chart'>Adding tooltips to a line chart</a>
      </li>
      <li>
        <a href='#leanpub-auto-add-a-row-chart'>Add a Row Chart.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-position-the-row-chart'>Position the row chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-assign-the-row-chart-type'>Assign the row chart type</a>
          </li>
          <li>
            <a href='#leanpub-auto-dimension-and-group-the-row-chart-data'>Dimension and group the row chart data</a>
          </li>
          <li>
            <a href='#leanpub-auto-configure-the-row-chart-parameters'>Configure the row chart parameters</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-add-a-pie-chart'>Add a Pie Chart.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-position-the-pie-chart'>Position the pie chart</a>
          </li>
          <li>
            <a href='#leanpub-auto-assign-the-pie-chart-type'>Assign the pie chart type</a>
          </li>
          <li>
            <a href='#leanpub-auto-dimension-and-group-the-pie-chart-data'>Dimension and group the pie chart data</a>
          </li>
          <li>
            <a href='#leanpub-auto-configure-the-pie-chart-parameters'>Configure the pie chart parameters</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-resetting-filters'>Resetting filters</a>
        <ul>
          <li>
            <a href='#leanpub-auto-making-the-reset-label-a-little-bit-better-behaved'>Making the reset label a little bit better behaved.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-reset-all-the-charts'>Reset all the charts</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-bootstrap-with-d3js'>Using Bootstrap with d3.js</a>
    <ul>
      <li>
        <a href='#leanpub-auto-what-is-bootstrap'>What is Bootstrap?</a>
        <ul>
          <li>
            <a href='#leanpub-auto-layout-grid'>Layout grid</a>
          </li>
          <li>
            <a href='#leanpub-auto-interface-components'>Interface components</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-incorporating-bootstrap-into-your-html-code'>Incorporating Bootstrap into your html code.</a>
      </li>
      <li>
        <a href='#leanpub-auto-arranging-more-than-one-graph-on-a-web-page'>Arranging more than one graph on a web page.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-first-make-a-page-with-two-graphs'>First make a page <em>with</em> two graphs</a>
          </li>
          <li>
            <a href='#leanpub-auto-arrange-the-graphs-with-the-same-anchor'>Arrange the graphs with the same anchor</a>
          </li>
          <li>
            <a href='#leanpub-auto-arrange-the-graphs-with-separate-anchors'>Arrange the graphs with separate anchors</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-how-does-bootstraps-grid-layout-work'>How does Bootstrap’s grid layout work</a>
        <ul>
          <li>
            <a href='#leanpub-auto-arrange-more-than-one-d3js-graph-with-bootstrap'>Arrange more than one d3.js graph with Bootstrap</a>
          </li>
          <li>
            <a href='#leanpub-auto-a-more-complicated-bootstrap-layout-example'>A more complicated Bootstrap layout example</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-mysql-tips-and-tricks-for-d3js'>MySQL Tips and Tricks for d3.js</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-a-mysql-database-as-a-source-of-data'>Using a MySQL database as a source of data.</a>
        <ul>
          <li>
            <a href='#leanpub-auto-php-is-our-friend'>PHP is our friend</a>
          </li>
          <li>
            <a href='#leanpub-auto-phpmyadmin'>phpMyAdmin</a>
          </li>
          <li>
            <a href='#leanpub-auto-create-your-database'>Create your database</a>
          </li>
          <li>
            <a href='#leanpub-auto-importing-your-data-into-mysql'>Importing your data into MySQL</a>
          </li>
          <li>
            <a href='#leanpub-auto-querying-the-database'>Querying the Database</a>
          </li>
          <li>
            <a href='#leanpub-auto-using-php-to-extract-json-from-mysql'>Using php to extract json from MySQL</a>
          </li>
          <li>
            <a href='#leanpub-auto-getting-the-data-into-d3js'>Getting the data into d3.js</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-manipulating-date--time-ranges'>Manipulating Date / Time Ranges</a>
        <ul>
          <li>
            <a href='#leanpub-auto-whats-a-standard-format-for-a-date--time-value'>What’s a standard format for a Date / Time value</a>
          </li>
          <li>
            <a href='#leanpub-auto-creating-a-standard-date--time-from-separate-columns'>Creating a standard Date / Time from separate columns</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='#leanpub-auto-general-mysql-titbits'>General MySQL titbits</a>
        <ul>
          <li>
            <a href='#leanpub-auto-group-parts-of-queries-and-text-together-with-concat'>Group parts of queries (and text) together with <code>CONCAT</code></a>
          </li>
          <li>
            <a href='#leanpub-auto-working-round-reserved-words-in-queries'>Working round reserved words in queries</a>
          </li>
          <li>
            <a href='#leanpub-auto-rounding-numbers'>Rounding numbers</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-working-with-github-gist-and-blocksorg'>Working with GitHub, Gist and bl.ocks.org</a>
    <ul>
      <li>
        <a href='#leanpub-auto-general-stuff-about-blocksorg'>General stuff about bl.ocks.org</a>
      </li>
      <li>
        <a href='#leanpub-auto-installing-the-plug-in-for-blocksorg-for-easy-block-viewing'>Installing the plug-in for bl.ocks.org for easy block viewing</a>
      </li>
      <li>
        <a href='#leanpub-auto-loading-a-thumbnail-into-gist-for-blocksorg-d3-graphs'>Loading a thumbnail into Gist for bl.ocks.org d3 graphs</a>
        <ul>
          <li>
            <a href='#leanpub-auto-setting-the-scene'>Setting the scene:</a>
          </li>
          <li>
            <a href='#leanpub-auto-enough-of-the-scene-setting-lets-git-going--'>Enough of the scene setting. Let’s git going :-).</a>
          </li>
          <li>
            <a href='#leanpub-auto-wrap-up-2'>Wrap up.</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-appendices'>Appendices</a>
    <ul>
      <li>
        <a href='#leanpub-auto-simple-line-graph'>Simple Line Graph</a>
      </li>
      <li>
        <a href='#leanpub-auto-graph-with-many-features'>Graph with Many Features</a>
      </li>
      <li>
        <a href='#leanpub-auto-graph-with-area-gradient'>Graph with Area Gradient</a>
      </li>
      <li>
        <a href='#leanpub-auto-bar-chart-1'>Bar Chart</a>
      </li>
      <li>
        <a href='#leanpub-auto-linking-objects'>Linking Objects</a>
      </li>
      <li>
        <a href='#leanpub-auto-php-with-mysql-access'>PHP with MySQL Access</a>
      </li>
      <li>
        <a href='#leanpub-auto-simple-sankey-graph'>Simple Sankey Graph</a>
      </li>
      <li>
        <a href='#leanpub-auto-simple-tree-diagram'>Simple Tree Diagram</a>
      </li>
      <li>
        <a href='#leanpub-auto-interactive-tree-diagram'>Interactive Tree Diagram</a>
      </li>
      <li>
        <a href='#leanpub-auto-force-layout-diagram'>Force Layout Diagram</a>
      </li>
      <li>
        <a href='#leanpub-auto-bullet-chart'>Bullet Chart</a>
      </li>
      <li>
        <a href='#leanpub-auto-map-with-zoom--pan-and-cities'>Map with zoom / pan and cities</a>
      </li>
    </ul>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="kramdown">
<h2 id="leanpub-auto-acknowledgements">Acknowledgements</h2>

<h3 id="leanpub-auto-mike">Mike</h3>

<p>First and foremost I would like to express my thanks to Mike Bostock, the driving force behind d3.js. His efforts are tireless and his altruism in making his work open and available to the masses is inspiring.</p>

<h3 id="leanpub-auto-partners-supporters-and-contributors">Partners, Supporters and Contributors.</h3>

<p>Mike has worked with a crew of like-minded individuals in bringing D3 to the World. Vadim Ogievetsky and Jeffrey Heer share honours for the work on <a href="http://vis.stanford.edu/papers/d3">D3: Data-Driven Documents</a> and while there has been a cast of over 40 people contributing to the D3 code base, Jason Davies stands out as the man who has provided a generous portion especially in the area of mapping.</p>

<p>Nick Zhu has created a fantastic resource in <a href="https://github.com/NickQiZhu/dc.js/wiki">dc.js</a> (which is built on top of d3.js and crossfilter) and has been kind enough to provide good advice and permission to include some of his work in the dc.js section. </p>

<p>Advice given by Christophe Viau has been a great help in getting me settled into the on-line world and his energy in managing and directing the D3 community is amazing.</p>

<p>Mike Dewar (<em>Getting Started with D3</em>), Scott Murray (<em>Interactive Data Visualization for the Web</em>) and Sebastian Gutierrez (<a href="http://www.dashingd3js.com/">dashingd3js.com</a>) lead the pack for providing high quality reference material for learning D3. Many thanks gentlemen.</p>

<h3 id="leanpub-auto-proof-reading">Proof Reading</h3>

<p>I am particularly grateful for the assistance given by Filiep Spyckerelle and Robin Bennett who selflessly donated their time and expertise in proofreading above and beyond the call of duty (where this document contains any errors, they are most certainly mine). </p>

<h3 id="leanpub-auto-the-d3js-community">The d3.js Community</h3>

<p>Big thanks go out to the D3 community. Whether providing advice on Google Groups or Stack Overflow, contributing examples on bl.ocks.org or just giving back in the form of time and effort to similar work. Well done all.</p>

<h3 id="leanpub-auto-cover-art">Cover art</h3>

<p>Out of the blue and in yet another example of the friendly and giving nature of people involved in this community I was contacted by Jose (‘Tactician Jenro’) who offered to use his skills to design a cover for the book. I think he did a great job and was super helpful. If you think that he could help you out with a project, you can get in touch with him at jenrothetactician@gmail.com or @tacticianjenro.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/banner.jpg" alt="A sampling of works by Tactician Jenro">
  <figcaption>A sampling of works by Tactician Jenro</figcaption>
</figure>


<h3 id="leanpub-auto-leanpub">Leanpub</h3>

<p>Lastly, I want to pay homage to <a href="https://leanpub.com/">Leanpub</a> who have made the publishing of this document possible. They offer an outstanding service for self-publishing and have made the task of providing and distributing content achievable.</p>

<h3 id="leanpub-auto-make-sure-you-get-the-most-up-to-date-copy-of-d3-tips-and-tricks">Make sure you get the most up to date copy of D3 Tips and Tricks</h3>

<p>If you’ve received a copy of this book from any location other than <a href="https://leanpub.com/D3-Tips-and-Tricks">Leanpub</a> then it’s possible that you haven’t got the latest version. Go to https://leanpub.com/D3-Tips-and-Tricks and download the most recent version. After all, it won’t cost you anything :-). If you find some value in the work, please consider contributing 99 cents when you download it so that Leanpub get something for hosting the book (and I’ll think of you fondly). Please also be aware that this book id for version 3 of d3.js and if you are considering writing code for version 4 (and you should) you will want the new edition here - https://leanpub.com/d3-t-and-t-v4.</p>

<h2 id="leanpub-auto-what-is-d3js">What is d3.js?</h2>

<p><a href="http://d3js.org/">d3.js</a> (hereafter abridged as D3) is “<em>a JavaScript library for manipulating documents based on data</em>”.</p>

<p>But that description doesn’t do it justice.</p>

<p>D3 is all about helping you to take information and make it more accessible to others via a web browser. </p>

<p>It’s a JavaScript library. That means that it’s a tool that can be used in conjunction with other tools to get a job done. Those other tools are mainly HTML and CSS (amongst others) but you don’t need to know too much about either to use D3 (although it will help :-)).</p>

<p>It’s an open framework, which means that there are no hidden mysteries about how it does its magic and it allows others to contribute to a constant cycle of improvement.</p>

<p>It’s built to leverage web standards which means that modern browsers don’t have to do anything special to use D3, they just have to support the framework that the Internet has adopted for ease of use.</p>

<p>The beauty of D3 is that it allows you to associate data and what appears on the screen in a way that directly links the two. Change the data and you change the object on the screen. D3’s trick is to let you set what appears on the screen. A circle, a line, a point on a map, a graph, a bouncing ball, a gradient (and way, way more). Once the data and the object are linked the possibilities are endless.</p>

<p>It won`t do everything for you in your quest to create the perfect visualization, but it does give you the ability to achieve that goal.</p>

<p>It bridges the gap between the static display of data and the desire of people to mess about with it. That applies equally to the developer who wants to show something cool and to the end user who wants to be able to explore information interactively.</p>

<p>It was (and still is being) developed by <a href="http://bost.ocks.org/mike/">Mike Bostock</a> who has not just spent time writing the code, but writing the <a href="https://github.com/mbostock/d3/wiki">documentation</a> for D3 as well. There is an extensive community of supporters who also contribute to the code, provide technical <a href="https://groups.google.com/forum/?fromgroups#!forum/d3-js">support</a> <a href="http://stackoverflow.com/questions/tagged/d3.js">online</a> and generally have fun creating amazing <a href="https://github.com/mbostock/d3/wiki/Gallery">visualizations</a>. Their contributions are extraordinary (you only have to look at the work of Jason Davies to be amazed).</p>

<h2 id="leanpub-auto-introduction">Introduction</h2>

<p>I never set out to write treatise on D3…</p>

<p>I am a simple user of this extraordinary framework and when I say simple, I <em>really</em> mean I had no idea how to get it to do anything when I started; I needed to do a lot of searching and learned by trial-and-error (emphasis on the errors which were entirely mine). The one thing that I did know was that the example graphics shown by Mike Bostock and others were the sort of graphical goodness that I wanted to play with.</p>

<p>So to get from the point of having no skills whatsoever to the point where I could begin to code up something to display data in a way I wanted, I had to capture the information as I went. 
The really cool thing about this sort of process is that it doesn’t need to occur all at once. You can start with no knowledge whatsoever (or pretty close) and by standing on the shoulders of other’s work, you can add building blocks to improve what you’re seeing and then change the blocks to adapt and improve. </p>

<p>For example (and this is pretty much how it started). I wanted to draw a line graph, so I imported an example and then got it running locally on my computer. Then I worked out how to change the example data for my data. Then I worked out how to move the Y axis from the right to the left. Then how to make the axis labels larger, change the tick size, make the lines fatter, change the colour, add a label, fill the area under the graph, put the graph in the centre of the page, add a glow to the text to help it stand out, put it in a framework (bootstrap), add buttons to change data sets, animate the transitions between data sets, update the data automatically when it changed, add a pan and zoom feature, turn parts of the graph into hyperlinks to move to other graphs… And then I started on bar graphs :-).  </p>

<p>The point to take away from all of this is that any one graph is just a collection of lots of blocks of code, each block designed to carry out a specific function. Pick the blocks you want and implement them. </p>

<p>I found it was much simpler to work on one thing (block) at a time, and this helped greatly to reduce  the uncertainty factor when things didn’t work as anticipated.
I’m not going to pretend that everything I’ve done while trying to build graphs employs the most elegant or efficient mechanism, but in the end, if it all works on the screen, I walk away happy :-). That’s not to say I have deliberately ignored any best practices – I just never knew what they were. Likewise, wherever possible, I have tried to make things as extensible as possible.</p>

<p>You will find that I have typically eschewed a simple “Do this approach” for more of a story telling exercise. This means that some explanations are longer and more flowery than might be to everyone’s liking, but there you go, try to be brave :-)</p>

<p>I’m sure most authors try to be as accessible as possible. I’d like to do the same, but be warned… There’s a good chance that if you ask me a technical question I may not know the answer. So please be gentle with your emails :-).</p>

<p>Email: d3noobmail+contact@gmail.com</p>

<h2 id="leanpub-auto-what-do-you-need-to-get-started">What do you need to get started?</h2>
<p>Let’s be frank. My grandmother will never put together a graphic using D3.</p>

<p>However, that doesn’t mean that it’s beyond those with a little computer savy and a willingness to have a play. Remember failure is your friend (I am fairly sure that I am also related by blood). Just learn from your mistakes and it’ll all work out.</p>

<p>So, here in no particular order is a list of good things to know. None of which are essential, but any one (or more) of which will  make your life slightly easier.</p>

<ul>
  <li>HyperText Markup Language (HTML)</li>
  <li>JavaScript</li>
  <li>Cascading Style Sheets (CSS)</li>
  <li>Web Servers</li>
  <li>PHP</li>
</ul>

<aside class="warning blurb">
    <h3 id="leanpub-auto-dont-freak-out"><strong>DON’T FREAK OUT!</strong></h3>
  <p>First things first. This isn’t rocket science. It’s just teh interwebs.
We’ll take it gently, and I’ll be a little more specific in the following sections.</p>

</aside>

<h3 id="leanpub-auto-html">HTML</h3>
<p>This stands for HyperText Markup Language and is the stuff that web pages are made of. Check out the definition and other information on <a href="http://en.wikipedia.org/wiki/HTML">Wikipedia</a> for a great overview. Just remember that all you’re going to use HTML for is to hold the code that you will use to present your information. This will be as a .html (or .htm) file and they can be pretty simple (we’ll look at some in a moment). </p>

<h3 id="leanpub-auto-javascript">JavaScript</h3>
<p><a href="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a> is what’s called a ‘scripting language’. It is the code that will be contained inside the HTML file that will make D3 do all its fanciness. In fact, D3 is a JavaScript Library, it’s the native language for using D3.</p>

<p>Knowing a little bit about this would be really good, but to be perfectly honest, I didn’t know anything about it before I started. I read a book along the way (<a href="http://shop.oreilly.com/product/9780596515898.do">JavaScript: The Missing Manual</a> from O’Reilly) and that helped with context, but the examples that are available for D3 graphics are understandable, and with a bit of trial and error, you can figure out what’s going on. </p>

<p>In fact, most of what this collection of information’s about is providing examples and explanations for the JavaScript components of D3.</p>

<h3 id="leanpub-auto-cascading-style-sheets-css">Cascading Style Sheets (CSS)</h3>
<p><a href="http://en.wikipedia.org/wiki/Css">Cascading Style Sheets</a> (everyone appears to call them ‘Style Sheets’ or ‘CSS’) is a language used to describe the formatting (or “look and feel”) of a document written in a markup language. The job of CSS is to make the presentation of the components you will draw with D3 simpler by assigning specific styles to specific objects. One of the cool things about CSS is that it is an enormously flexible and efficient method for making everything on the screen look more consistent and when you want to change the format of something you can just change the CSS component and the whole look and feel of your graphics will change.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/wordcloud.png" alt="The wonderful World of Cascading Style Sheets">
  <figcaption>The wonderful World of Cascading Style Sheets</figcaption>
</figure>


<aside class="information blurb">
    <h3 id="leanpub-auto-full-disclosure">Full disclosure</h3>
  <p>I know CSS is a ridiculously powerful tool that would make my life easier, but I use it in a very basic (and probably painful) way. Don’t judge me, just accept that the way I’ve learnt was what I needed to get the job done (this probably means that noobs like myself will find it easier, but where possible try and use examples that include what look like logical CSS structures)</p>

</aside>

<h3 id="leanpub-auto-web-servers">Web Servers</h3>
<p>Ok, this can go one of two ways. If you have access to a web server and know where to put the files so that you can access them with your browser, you’re on fire. If you’re not quite sure, read on…</p>

<p>A web server will allow you to access your HTML files and will provide the structure that allows it to be displayed on a web browser. There are some simple instructions on the main <a href="https://github.com/mbostock/d3/wiki">D3 wiki page</a> for setting up a local server. Or you might have access to a remote one and be able to upload your files. However, for a little more functionality and a whole lot of ease of use, I can thoroughly recommend WampServer as a free and simple way to set up a local web server that includes PHP and a MySQL database (more on those later). Go to the WampServer web page (http://www.wampserver.com/en/) and see if it suits you.</p>

<p>Throughout this document I will be describing the files and how they’re laid out in a way that has suited my efforts while using WAMP, but they will work equally well on a remote server. I will explain a little more about how I arrange the files later in the ‘Getting D3’ section.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/wamp.png" alt="WAMP = Windows + Apache + MySQL + PHP">
  <figcaption>WAMP = Windows + Apache + MySQL + PHP</figcaption>
</figure>


<p>There are other options of course. You could host code on <a href="https://github.com/about">GitHub</a> and present the resulting graphics on <a href="http://bl.ocks.org/">bl.ocks.org</a>. This is a great way to make sure that your code is available for peer review and sharing with the wider community. </p>

<p>One such alternative option that I have recently started playing with is Plunker (http://plnkr.co/) This is a lightweight collaborative online editing tool. It’s so cool I wrote a special section for it which you can find later in this document. This is definitely worth trying if you want to use something simple without a great deal of overhead. If you like what you see, perhaps consider an alternative that provides a greater degree of capability if you go on to greater d3.js things.</p>

<h3 id="leanpub-auto-php">PHP</h3>

<p>PHP is a scripting language for the web. That is to say that it is a programming language which is executed when you load web pages and it helps web pages do dynamic things. </p>

<p>You might think that this sounds familiar and that JavaScript does the same thing. But not quite.</p>

<p>JavaScript is designed so that it travels <em>with</em> the web page when it is downloaded by a browser (the <strong>client</strong>). However, PHP is executed remotely on the <strong>server</strong> that supplies the web page. This might sound a bit redundant, but it’s a big deal. This means that the PHP which is executed doesn’t form <em>part</em> of the web page, but it can <em>form</em> the web page. The implication here is that the web page you are viewing can be altered by the PHP code that runs on a remote server. This is the dynamic aspect of it.</p>

<p>In practice, PHP could be analogous to the glue that binds web pages together. Allowing different portions of the web page to respond to directions from the end user. </p>

<p>It is widely recognised not only as a relatively simple language to learn, but also as a fairly powerful one. At the same time it comes into criticism for being somewhat fragmented and sometimes contradictory or confusing. But in spite of any perceived shortcomings, it is a very widely used and implemented language and one for which there is no obvious better option.</p>

<h3 id="leanpub-auto-other-useful-stuff">Other Useful Stuff</h3>

<h4 id="leanpub-auto-text-editor">Text Editor</h4>
<p>A good text editor for writing up your code will be a real boost. Don’t make the fatal mistake of using an office word processor or similar. THEY WILL DOOM YOU TO A LIFE OF MISERY. They add in crazy stuff that you can’t even see and never save the files in a way that can be used properly. </p>

<p>Preferably, you should get an editor that will provide some assistance in the form of syntax highlighting which is where the editor knows what language you are writing in (JavaScript for example) and highlights the text in a way that helps you read it.
For example, it will change text that might appear as this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>// Get the data
d3.tsv("data/data.tsv", function(error, data) {
data.forEach(function(d) {
    d.date = parseDate(d.date);
    d.close = +d.close;
});
</pre></div>

</figure>

<p>Into something like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>// Get the data
d3.tsv("data/data.tsv", function(error, data) {
data.forEach(function(d) {
    d.date = parseDate(d.date);
    d.close = +d.close;
});
</pre></div>

</figure>

<p>Infinitely easier to use. Trust me.</p>

<p>There are plenty of editors that will do the trick. I have a preference for <a href="http://www.geany.org/">Geany</a>, mainly because it’s what I started with and it grew on me :-). </p>

<h4 id="leanpub-auto-getting-d3">Getting D3</h4>
<p>Luckily this is pretty easy. </p>

<p>Go to the D3 repository on <a href="https://github.com/mbostock/d3">github</a> and download the entire repository by clicking on the ‘ZIP’ button.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/downloadrepository.png" alt="Download the repository as a zip file">
  <figcaption>Download the repository as a zip file</figcaption>
</figure>


<p>What you do with it from here depends on how you’re hosting your graphs. If you’re working on them on your local PC, then you will want to have the d3.js file in the path that can be seen by the browser. Again, I would recommend WAMP (a local web server) to access your files locally. If you’re using WAMP, then you just have to make sure that it knows to use a directory that will contain the d3 directory and you will be away. </p>

<p>The following image is intended to provide a very crude overview of how you can set up the directories.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/dirlayout.png" alt="A potential directory structure for your files">
  <figcaption>A potential directory structure for your files</figcaption>
</figure>


<ul>
  <li>webserver: Use this as your ‘base’ directory where you put your files that you create. That way when you open your browser you point to this directory and it allows you to access the files like a normal web site.</li>
  <li>d3: This would be your unzipped d3 directory. It contains all the examples and more importantly the d3.v3.js file that you need to get things going. You will notice in the code examples that follow there is a line like the following;<br>
<code>&lt;script type="text/javascript" src="d3/d3.v3.js"&gt;&lt;/script&gt;</code>.<br>
This tells your browser that from the file it is running (one of the graph html files) if it goes into the ‘d3’ folder it will find the <code>d3.v3.js</code> file that it can load.</li>
  <li>data: I use this directory to hold any data files that I would use for processing. For example, you will see the following line in the code examples that follow <code>d3.tsv("data/data.tsv", function(error, data) {</code>. Again, that’s telling the browser to go into the ‘data’ directory and to load the ‘data.tsv’ file.</li>
  <li>js: Often you will find that you will want to include other JavaScript libraries to load. This is a good place to put them.</li>
</ul>

<h4 id="leanpub-auto-where-to-get-information-on-d3js">Where to get information on d3.js</h4>

<p>D3 has made huge advances in providing an extensible and practical framework for manipulating data as web objects. At the same time there has been significant increase in information available for people to use it. The following is a far from exhaustive list of sources, but from my own experience it represents a useful subset of knowledge.</p>

<h5 id="leanpub-auto-d3jsorg">d3js.org</h5>

<p>d3js.org would be the first port of call for people wanting to know something about d3.js.</p>

<p>From the overview on the main page you can access a dizzying array of <a href="https://github.com/mbostock/d3/wiki/Gallery">examples</a> that have been provided by the founder of d3 (Mike Bostock) and a host of additional developers, artists, coders and anyone who has something to add to the sum knowledge of cool things that can be done with d3.</p>

<p>There is a link to a <a href="https://github.com/mbostock/d3/wiki">documentation page</a> that serves as a portal to the ever important API reference, contributed tutorials and other valuable links (some of which I will mention in paragraphs ahead).</p>

<p>The last major link is to the <a href="https://github.com/mbostock/d3">Github repository</a> where you can download d3.js itself.</p>

<p>It is difficult to overstate the volume of available information that can be accessed from d3js.org. It stands alone as the one location that anyone interested in D3 should visit.</p>

<h5 id="leanpub-auto-google-groups">Google Groups</h5>

<p>There is a Google Group dedicated to <a href="https://groups.google.com/forum/?fromgroups#!forum/d3-js">discussions on d3.js</a>. </p>

<p>In theory this forum  is for discussions on topics including visualization design, API design, requesting new features, etc. With a specific direction made in the main header that “<em>If you want help using D3, please use the d3.js tag on Stack Overflow!</em>”. </p>

<p>In practice however, it would appear that a sizeable proportion of the posts there are technical assistance requests of one type or another. Having said that this means that if you’re having a problem, there could already be a solution posted there. However, if at all possible the intention is certainly that people use Stack Overflow, so this should be the first port of call for those types of inquiry.</p>

<p>So, by all means add this group as a favourite and this will provide you with the opportunity to receive emailed summaries of postings or just an opportunity to easily browse recent goings-on.</p>

<h5 id="leanpub-auto-stack-overflow">Stack Overflow</h5>

<p>Stack Overflow  is a question and answer site whose stated desire is “<em>to build a library of detailed answers to every question about programming</em>”. Ambitious. So how are they doing? Actually really well. Stack overflow is a fantastic place to get help and information. It’s also a great place to help people out if you have some knowledge on a topic.</p>

<p>They have a funny scheme for rewarding users that encourages providing good answers based on readers voting. It’s a great example of gamification working well. If you want to know a little more about how it works, check out this page; http://stackoverflow.com/about.</p>

<p>They have a d3.js tag (http://stackoverflow.com/questions/tagged/d3.js) and like Google Groups there is a running list of different topics that are an excellent source of information.</p>

<h5 id="leanpub-auto-github">Github</h5>

<p><a href="https://github.com/">Github</a> is predominantly a code repository and version control site. It is highly regarded for its technical acumen and provides a fantastic service that is broadly used for many purposes. Not the least of which is hosting the code (and the wiki) for d3.js.</p>

<p>Whilst not strictly a site that specialises in providing a Q &amp; A function, there is a significant number of repositories (825 at last count) which mention d3.js. With the help from an astute search phrase, there is potentially a solution to be found there.</p>

<p>The other associated feature of Github is Gist. Gist is a pastebin service (a place where you can copy and past code) that can provide a ‘wiki like’ feature for individual repositories and web pages that can be edited through a Git repository. Gist plays a role in providing the hub for the bl.ocks.org example hosting service set up by Mike Bostock.</p>

<p>For a new user, Github / Gist can be slightly daunting. It’s an area where you almost need to know what’s going on to know before you dive in. This is certainly true if you want to make use of its incredible features that are available for hosting code. However, if you want to browse other peoples code it’s an easier introduction. Have a look through what’s available and if you feel so inclined, I recommend that you learn enough to use their service. It’s time well spent. </p>

<h5 id="leanpub-auto-blocksorg">bl.ocks.org</h5>

<p><a href="http://bl.ocks.org/">bl.ocks.org</a> is a viewer for code examples which are hosted on Gist. You are able to load your code into Gist, and then from bl.ocks.org you can view them.</p>

<p>This is a really great way for people to provide examples of their work and there are many who do. However, it’s slightly tricky to know what is there. There is a <a href="https://groups.google.com/forum/?fromgroups=#!topic/d3-js/g7BxBMUZP8o">current project</a> being championed by Christophe Viau and others to provide better access to a range of D3 documentation. The early indications are that it will provide a fantastic method of accessing examples and information. Watch that space. </p>

<p>I would describe the process of getting your own code hosted and displaying as something that will be slightly challenging for people who are not familiar with Github / Gist, but again, in terms of visibility of the code and providing an external hosting solution, it is excellent and well worth the time to get to grips with.</p>

<h5 id="leanpub-auto-twitter">Twitter</h5>

<p>Twitter provides a great alerting service to inform a large disparate group of people about <em>stuff</em>. </p>

<p>It’s certainly a great way to keep in touch on an hour by hour basis with people who are involved with d3.js and this can be accomplished in a couple of ways. First, find as many people from the various D3 sites around the web who you consider to be influential in areas you want to follow (different aspects such as development, practical output, educational etc) and follow them. Even better, I found it useful to find a small subset who I considered to be influential people and I noted who they followed. It’s a bit ‘<em>stalky</em>’ if you’re unfamiliar with it, but the end result should be a useful collection of people with something useful to say.</p>

<h5 id="leanpub-auto-books">Books</h5>

<p>There are only a couple of books that have been released so far on d3.js.</p>

<p>There is “<em><a href="http://shop.oreilly.com/product/0636920025429.do">Getting Started with D3</a></em>” by Mike Dewar (O’Reilly Media, June 2012). This will take you through a good set of exercises to develop your D3 skills and is accompanied by downloadable examples.</p>

<p>There is “<em><a href="http://ofps.oreilly.com/titles/9781449339739/">Interactive Data Visualization for the Web</a></em>” by Scott Murray, (O’Reilly Media, November 2012). Currently this has only been released as an ebook, but is scheduled to be released in print form in 2013. The book is based on his great set of on-line tutorials (http://alignedleft.com/tutorials/).</p>

<p>Of course, there is the original paper that launched D3 “D3: Data-Driven Documents” by Michael Bostock, Vadim Ogievetsky and Jeffrey Heer (IEEE Trans. Visualization &amp; Comp. Graphics (Proc. InfoVis), 2011)</p>

<h2 id="leanpub-auto-starting-with-a-basic-graph">Starting with a basic graph</h2>

<p>I’ll start by providing the full code for a simple graph and then we can go through it piece by piece (The full code for this example is also in the appendices as ‘Simple Graph’.). </p>

<p>Here’s what the basic graph looks like;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/basicgraph.png" alt="Basic Graph">
  <figcaption>Basic Graph</figcaption>
</figure>


<p>And here’s the code that makes it happen;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>

<code class="nt">path</code> <code class="p">{</code> 
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// Set the dimensions of the canvas / graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="c1">// Set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// Define the axes</code>
<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="c1">// Define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
    
<code class="c1">// Adds the svg canvas</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data/data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="c1">// Add the valueline path.</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>

    <code class="c1">// Add the X Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="c1">// Add the Y Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/b3ff6ae1c120eea654b5">github</a>, in the appendices of this book or in the code samples bundled with this book (simple-graph.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/b3ff6ae1c120eea654b5">bl.ocks.org</a>. Please note that the <code>&lt;head&gt;&lt;/head&gt;</code> tags are omitted which is a common thing for d3 examples (I don’t know why). This can cause problems for some browsers in certain conditions. </p>

<p>Once we’ve finished explaining these parts, we’ll start looking at what we need to add in and adjust so that we can incorporate other useful functions that are completely reusable in other diagrams as well.</p>

<p>The end point being something hideous like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/finalgraph.png" alt="Graph with lots of 'tricks' incorperated">
  <figcaption>Graph with lots of ‘tricks’ incorperated</figcaption>
</figure>


<p>I say hideous since the graph is not intended to win any beauty prizes, but there are several components to it which some people may find useful (gridlines, area fill, axis label, drop shadow for text, title, text formatting).</p>

<p>So, we can break the file down into component parts. I’m going to play kind of fast and loose here, but never fear, it’ll all make sense.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-html-1">HTML</h3>
<p>Here’s the HTML portions of the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

    <code class="nt">The</code> <code class="nt">CSS</code> <code class="nt">is</code> <code class="nt">in</code> <code class="nt">here</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

    <code class="nx">The</code> <code class="nx">D3</code> <code class="nx">JavaScript</code> <code class="nx">code</code> <code class="nx">is</code> <code class="nx">here</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Compare it with the full code. It kind of looks like a wrapping for the CSS and JavaScript. You can see that it really doesn’t boil down to much at all (that doesn’t mean it’s not important).</p>

<p>There are plenty of good options for adding additional HTML stuff into this very basic part for the file, but for what we’re going to be doing, we really don’t need to bother too much.</p>

<p>One thing probably worth mentioning is the line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>That’s the line that identifies the file that needs to be loaded to get D3 up and running. In this case the file is sourced from the official d3.js repository on the internet (that way we are using the most up to date version). The D3 file is actually called <code>d3.v3.min.js</code> which may come as a bit of a surprise. That tells us that this is version 3 of the d3.js file (the <code>v3</code> part) which is an indication that it is separate from the v2 release, which was superseded in late 2012. The other point to note is that this version of d3.js is the minimised version (hence <code>min</code>). This means that any extraneous information has been removed from the file to make it quicker to load.</p>

<p>Later when doing things like implementing integration with bootstrap (a pretty layout framework) we will be doing a great deal more, but for now, that’s the basics done.</p>

<p>The two parts that we left out are the CSS and the D3 JavaScript.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-css">CSS</h3>

<p>The CSS is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>

<code class="nt">path</code> <code class="p">{</code> 
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Cascading Style Sheets give you control over the look / feel / presentation of web content. The idea is to define a set of properties to objects in the web page.</p>

<p>They are made up of ‘rules’. Each rule has a ‘selector’ and a ‘declaration’ and each declaration has a property and a value (or a group of properties and values).</p>

<p>For instance in the example code for this web page we have the following rule;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code> 
</pre></div>

</figure>

<p><code>body</code> is the selector. This tells you that on the web page, this rule will apply to the ‘body’ of the page. This actually applies to all the portions of the web page that are contained in the ‘body’ portion of the HTML code (everything between <code>&lt;body</code>&gt; and <code>&lt;/body&gt;</code> in the HTML bit).
<code>{ font: 12px Arial;}</code> is the declaration portion of the rule. It only has the one declaration which is the bit that is in between the curly braces.
So <code>font: 12px Arial;</code> is the declaration. The property is <code>font:</code> and the value is <code>12px Arial;</code>. This tells the web page that the font that appears in the body of the web page will be in 12 px Arial.</p>

<p>Sure enough if we look at the axes of the graph…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axis1.png" alt="x Axis with 12px Arial">
  <figcaption>x Axis with 12px Arial</figcaption>
</figure>


<p>We see that the font might <em>actually</em> be 12px Arial!</p>

<p>Let’s try a test. I will change the Rule to the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">16px</code> <code class="n">Arial</code><code class="p">;}</code>
</pre></div>

</figure>

<p>and the result is…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axis2.png" alt="x Axis with 16px Arial">
  <figcaption>x Axis with 16px Arial</figcaption>
</figure>


<p>Ahh…. 16px of goodness!</p>

<p>And now we change it to…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">16px</code> <code class="n">times</code><code class="p">;}</code>
</pre></div>

</figure>

<p>and we get…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axis3.png" alt="x Axis with Times font">
  <figcaption>x Axis with Times font</figcaption>
</figure>


<p>Hmm… Times font…. I think we can safely say that this has had the desired effect.</p>

<p>So what else is there?</p>

<p>What about the bit that’s like;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code> <code class="p">{</code> 
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Well, the whole thing is one rule, ‘path’ is the selector. In this case, ‘path’ is referring to a line in the D3 drawing nomenclature. </p>

<p>For that selector there are three declarations. They give values for the properties of ‘stroke’ (in this case colour), ‘stroke-width’ (the width of the line) and ‘fill’ (we can fill a path with a block of colour). </p>

<p>So let’s change things :-)</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code> <code class="p">{</code> 
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">5</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">yes</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/accidentalfill.png" alt="Filling of a path">
  <figcaption>Filling of a path</figcaption>
</figure>


<p>Wow! The line is now red, it looks about 5 pixels wide and it’s tried to fill the area (roughly defined by the curve) with a black colour.</p>

<p>It ain’t pretty, but it certainly did change. In fact if we go;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nt">fill</code><code class="o">:</code> <code class="nt">blue</code><code class="o">;</code>
</pre></div>

</figure>

<p>We’ll get…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/accidentalfillblue.png" alt="Filling of a path with added blue!">
  <figcaption>Filling of a path with added blue!</figcaption>
</figure>


<p>So the ‘fill’ property looks pretty flexible. And so does CSS.</p>

<h3 id="leanpub-auto-d3-javascript">D3 JavaScript</h3>

<p>The D3 JavaScript part of the code is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
    
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>		<code class="c1">// Add the valueline path.</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>			<code class="c1">// Add the X Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>			<code class="c1">// Add the Y Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>Again there’s quite a bit of detail in the code, but it’s not so long that you can’t work out what’s doing what.</p>

<p>Let’s examine the blocks bit by bit to get a feel for it.</p>

<h4 id="leanpub-auto-setting-up-the-margins-and-the-graph-area">Setting up the margins and the graph area.</h4>

<p>The part of the code responsible for defining the canvas (or the area where the graph and associated bits and pieces is placed ) is this part.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>This is really (<strong><em>really</em></strong>) well explained on Mike Bostock’s page on margin conventions here <a href="http://bl.ocks.org/3019563">http://bl.ocks.org/3019563</a>, but at the risk of confusing you here’s my crude take on it.</p>

<p>The first line defines the four margins which surround the block where the graph (as an object) is positioned.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>So there will be a border of 30 pixels at the top, 20 at the right and 30 and 50 at the bottom and left respectively. Now the cool thing about how these are set up is that they use an array to define everything. That means if you want to do calculations in the JavaScript later, you don’t need to put the numbers in, you just use the variable that has been set up. In this case margin.right = 20!</p>

<p>So when we go to the next line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
</pre></div>

</figure>

<p>the width of the inner block of the canvas where the graph will be drawn is 600 pixels – margin.left –  margin.right or 600-50-20 or 530 pixels wide. Of course now you have another variable ‘width’ that we can use later in the code.</p>

<p>Obviously the same treatment is given to height.</p>

<p>Another cool thing about all of this is that just because you appear to have defined separate areas for the graph and the margins, the whole area in there is available for use. It just makes it really useful to have areas designated for the axis labels and graph labels without having to juggle them and the graph proper at the same time.</p>

<p>So, let’s have a play and change some values.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">80</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">80</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">400</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/squishedgraph.png" alt="The effect of changing the margins">
  <figcaption>The effect of changing the margins</figcaption>
</figure>


<p>Here we’ve made the  graph narrower (400 pixels) but retained the left / right margins and increased the top bottom margins while maintaining the overall height of the canvas. The really cool thing that you can tell from this is that while we shrank the dimensions of the area that we had to draw the graph in, it was still able to dynamically adapt the axes and line to fit properly. That is the really cool part of this whole business. D3 is running in the background looking after the drawing of the objects, while you get to concentrate on how the data looks without too much maths!</p>

<h4 id="leanpub-auto-getting-the-data">Getting the Data</h4>

<p>We’re going to jump forward a little bit here to the bit of the JavaScript code that loads the data for the graph.</p>

<p>I’m going to go out of the sequence of the code here, because if you know what the data is that you’re using, it will make explaining some of the other functions that are coming up much easier.</p>

<p>The section that grabs the data is this bit.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>In fact it’s a combination of a few bits and another piece that isn’t shown!, But let’s take it one step at a time :-)</p>

<p>There’s lots of different ways that we can get data into our web page to turn into graphics. And the method that you’ll want to use will probably depend more on the format that the data is in than the mechanism you want to use for importing. </p>

<p>For instance, if it’s only a few points of data we could include the information directly in the JavaScript. </p>

<p>That would make it look something like;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"1-May-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"58.13"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"30-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"53.98"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"27-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"67.00"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"26-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"89.70"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"25-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"99.00"</code><code class="p">}</code>
<code class="p">];</code>
</pre></div>

</figure>

<p>The format of the data shown above is called JSON (JavaScript Object Notation) and it’s a great way to include data since it’s easy for humans to read what’s in there and it’s easy for computers to parse the data out. For a brief overview of JSON there is a separate section in the “Assorted Tips and Tricks Chapter” that may assist.</p>

<p>But if you’ve got a fair bit of data or if the data you want to include is dynamic and could be changing from one moment to the next, you’ll want to load it from an external source. That’s when we call on D3’s ‘Request’ functions.</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-request-functions">Request Functions</h3>
  <p>A ‘Request’ is a function that instructs the browser to reach out and grab some data from somewhere. It could be stored locally (on the web server) or somewhere out in the Internet.
There are different types of requests depending on the type of data you want to ingest. Each type of data is formatted with different rules, so the different requests interpret those rules to make sure that the data is returned to the D3 processing in a format that it understands. You could therefore think of the different ‘Requests’ as translators and the different data formats as being foreign languages.</p>

</aside>

<p>The different types of data that can be requested by D3 are;</p>

<ul>
  <li>
<strong>text</strong>: A plain old piece of text that has options to be encoded in a particular way (see the <a href="https://github.com/mbostock/d3/wiki/Requests">D3 API</a>).</li>
  <li>
<strong>json</strong>: This is the afore mentioned JavaScript Object Notation.</li>
  <li>
<strong>xml</strong>: Extensible Markup Language is a language that is widely used for encoding documents in a human readable forrm.</li>
  <li>
<strong>html</strong>: HyperText Markup Language is the language used for displaying web pages.</li>
  <li>
<strong>csv</strong>: Comma Separated Values is a widely used format for storing data where plain text information is separated by (wait for it) commas.</li>
  <li>
<strong>tsv</strong>: Tab Separated Values is a widely used format for storing data where plain text information is separated by a tab-stop character.</li>
</ul>

<p>Details on these ingestion methods and the formats for the requests are well explained on the <a href="https://github.com/mbostock/d3/wiki/Requests">D3 Wiki</a> page. In this particular script we will look at the csv request method.</p>

<aside class="information blurb">
    <p>Now, it’s important to note that this is not an exclusive list of what can be ingested. If you’ve got some funky data in a weird format, you can still get it in, but you will most likely need to stand up a small amount of code somewhere else in your page to do the conversion (we will look at this process when describing getting data from a MySQL database).</p>

</aside>

<p>Back to our request…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>The first line of that piece of code invokes the d3.csv request (<code>d3.csv</code>) and then the function is pointed to the data file that should be loaded (<code>data.csv</code>). This is referred to as the ‘url’ (unique resource locator) of the file. In this case the file is stored locally (in the same directory as the <code>simple-graph.html</code> file), but the url could just as easily point to a file somewhere on the Internet.</p>

<p>The format of the data in the data.csv file looks a bit like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
1-May-12,58.13
30-Apr-12,53.98
27-Apr-12,67.00
26-Apr-12,89.70
25-Apr-12,99.00
</pre></div>

</figure>

<p>(although the file is longer (about 26 data points)). The ‘date’ and the ‘close’ heading labels are separated by a comma as are each subsequent date and number. Hence the ‘comma separated values’ :-).</p>

<p>The next part is part of the coolness of JavaScript. With the request made and the file requested, the script is told to carry out a function on the data (which will now be called ‘data’).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>There are actually more things that get acted on as part of the function call, but the one we will consider here is contained in the following lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>This block of code simply ensures that all the numeric values that are pulled out of the csv file are set and formatted correctly. The first line sets the data variable that is being dealt with (called slightly confusingly ‘data’) and tells the block of code that, for each group within the ‘data’ array it should carry out a function on it. That function is designated ‘d’.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
</pre></div>

</figure>

<p>The information in the array can be considered as being stored in rows. Each row consists of two values: one value for ‘date’ and another value for ‘close’.</p>

<p>The function is pulling out values of ‘date’ and ‘close’ one row at a time.</p>

<p>Each time it gets a value of ‘date’ and ‘close’ it carries out the following operations;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
</pre></div>

</figure>

<p>For this specific value of date being looked at (d.date), d3.js changes it into a date format that is processed via a separate function ‘parseDate’. (The ‘parseDate’ function is defined in a separate part of the script, and we will examine that later.) For the moment, be satisfied that it takes the raw date information from the csv file in a specific row and converts it into a format that D3 can then process. That value is then re-saved in the same variable space.</p>

<p>The next line then sets the ‘close’ variable to a numeric value (if it isn’t already) using the ‘+’ operator.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
</pre></div>

</figure>
<aside class="tip blurb">
    <p>This appears to be good practice when the format of the number being pulled out of the data may not mean that it is automagically recognised as a number. This line will ensure that it is.</p>

</aside>

<p>So, at the end of that section of code, we have gone out and picked up a file with data in it of a particular type (comma separated values) and ensured that it is formatted in a way that the rest of the script can use correctly.</p>

<p>Now, the astute amongst you will have noticed that in the first line of that block of code (<code>d3.csv("data.csv", function(error, data) {</code>) we opened a normal bracket ( <code>(</code> ) and a curly bracket ( <code>{</code> ), but we never closed them. That’s because they stay open until the very end of the file. That means that all those blocks that occur after the d3.csv bit are referenced to the ‘data’ array. Or put another way, it uses ‘data’ to draw stuff!</p>

<p>But anyway, let’s get back to figuring what the code is doing by jumping back to the end of the margins block.</p>

<h4 id="leanpub-auto-formatting-the-date--time">Formatting the Date / Time.</h4>

<p>One of the glorious things about the World is that we all do things a bit differently. One of those things is how we refer to <a href="http://en.wikipedia.org/wiki/Date_format_by_country">dates and time</a>.</p>

<p>In my neck of the woods, it’s customary to write the date as day - month – year. E.g 23-12-2012. But in the United States the more common format would be 12-23-2012. Likewise, the data may be in formats that name the months or weekdays (E.g. January, Tuesday) or combine dates and time together (E.g. 2012-12-23 15:45:32). So, if we were to attempt to try to load in some data and to try and get D3 to recognise it as date / time information, we really need to tell it what format the date / time is in.</p>

<aside class="question blurb">
    <h3 id="leanpub-auto-does-time-matter">Does Time Matter?</h3>
  <p>You might be asking yourself “What’s the point?” All you want to do is give it a number and it can sort it out somehow. Well, that is true, but if you want to really bring out the best in your data and to keep maximum flexibility in representing it on the screen, you will want D3 to play to its strengths. And one of those is being able to adjust dynamically with variable time values.</p>

</aside>

<p>Time for a little demonstration (see what I did there).</p>

<p>We will change our data.csv file so that it only includes two points. The first one and the last one with a separation of a month and a bit.</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
1-May-12,58.13
26-Mar-12,606.98
</pre></div>

</figure>

<p>The graph now looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/straightgraph.png" alt="Simple line graph">
  <figcaption>Simple line graph</figcaption>
</figure>


<p>Nothing too surprising here, a very simple graph (note the time scale on the x axis). </p>

<p>Now we will change the later date in the data.csv file so that it is a lot closer to the starting date;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
29-Mar-12,58.13
26-Mar-12,606.98
</pre></div>

</figure>

<p>So, just a three day difference. Let’s see what happens.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/straightgraph2.png" alt="Simple line graph over three days">
  <figcaption>Simple line graph over three days</figcaption>
</figure>


<p>Ahh…. Not only did we not have to make any changes to our JavaScript code, but it was able to recognise the dates were closer and fill in the intervening gaps with appropriate time / day values. 
Now, one more time for giggles.</p>

<p>This time we’ll stretch the interval out by a few years.</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
29-Mar-21,58.13
26-Mar-12,606.98
</pre></div>

</figure>

<p>and the result is…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/straightgraph3.png" alt="Simple line graph over several years">
  <figcaption>Simple line graph over several years</figcaption>
</figure>


<p>Hopefully that’s enough encouragement to impress upon you that formatting the time is a <em>REALLY</em> good thing to get right. Trust me, it will never fail to impress :-).</p>

<p>Back to formatting.</p>

<p>The line in the JavaScript that parses the time is the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>
</pre></div>

</figure>

<p>This line is used when the <code>data.forEach(function(d)</code> portion of the code (that we looked at a couple of pages back) used <code>d.date = parseDate(d.date)</code> as a way to take a date in a specific format and to get it recognised by D3. In effect it said “<em>take this value that is supposedly a date and make it into a value I can work with</em>”.</p>

<p>The function used is the <code>d3.time.format(specifier)</code> function where the specifier in this case is the mysterious combination of characters <code>%d-%b-%y</code>. The good news is that these are just a combination of directives specific for the type of date we are presenting.</p>

<p>The <code>%</code> signs are used as prefixes to each separate format type and the ‘<code>-</code>’ (minus) signs are literals for the actual ‘<code>-</code>’ (minus) signs that appear in the date to be parsed.</p>

<p>The <code>d</code> refers to a zero-padded day of the month as a decimal number [01,31].</p>

<p>The <code>b</code> refers to an abbreviated month name. </p>

<p>And the <code>y</code> refers to the year (without the centuries) as a decimal number.</p>

<p>If we look at a subset of the data from the data.csv file we see that indeed, the dates therein are formatted in this way.</p>

<figure class="code">
<div class="highlight"><pre><code></code>1-May-12,58.13
30-Apr-12,53.98
27-Apr-12,67.00
26-Apr-12,89.70
25-Apr-12,99.00
</pre></div>

</figure>

<p>That’s all well and good, but what if your data isn’t formatted exactly like that?</p>

<p>Good news. There are multiple different formatters for different ways of telling time and you get to pick and choose which one you want. Check out the Time Formatting page on the D3 Wiki for a the authoritative list and some great detail, but the following is the list of currently available formatters (from the d3 wiki);</p>

<ul>
  <li>%a - abbreviated weekday name.</li>
  <li>%A - full weekday name.</li>
  <li>%b - abbreviated month name.</li>
  <li>%B - full month name.</li>
  <li>%c - date and time, as “%a %b %e %H:%M:%S %Y”.</li>
  <li>%d - zero-padded day of the month as a decimal number [01,31].</li>
  <li>%e - space-padded day of the month as a decimal number [ 1,31].</li>
  <li>%H - hour (24-hour clock) as a decimal number [00,23].</li>
  <li>%I - hour (12-hour clock) as a decimal number [01,12].</li>
  <li>%j - day of the year as a decimal number [001,366].</li>
  <li>%m - month as a decimal number [01,12].</li>
  <li>%M - minute as a decimal number [00,59].</li>
  <li>%p - either AM or PM.</li>
  <li>%S - second as a decimal number [00,61].</li>
  <li>%U - week number of the year (Sunday as the first day of the week) as a decimal number [00,53].</li>
  <li>%w - weekday as a decimal number [0(Sunday),6].</li>
  <li>%W - week number of the year (Monday as the first day of the week) as a decimal number [00,53].</li>
  <li>%x - date, as “%m/%d/%y”.</li>
  <li>%X - time, as “%H:%M:%S”.</li>
  <li>%y - year without century as a decimal number [00,99].</li>
  <li>%Y - year with century as a decimal number.</li>
  <li>%Z - time zone offset, such as “-0700”.</li>
  <li>There is also a  a literal “%” character that can be presented by using double % signs.</li>
</ul>

<p>As an example, if you wanted to input date / time formatted as a generic MySQL ‘YYYY-MM-DD HH:MM:SS’ TIMESTAMP format the D3 parse script would look like;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m-%d %H:%M:%S"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-setting-scales-domains-and-ranges">Setting Scales Domains and Ranges</h4>

<p>This is another example where, if you set it up right, D3 will look after you forever.</p>

<aside class="tip blurb">
    <h3 id="leanpub-auto-scales-ranges-and-the-ah-ha-moment">Scales, Ranges and the Ah Ha!” moment.</h3>
  <p>The “Ah Ha!” moment for me in understanding ranges and scales was after reading Jerome Cukier’s  great page on ‘<a href="http://www.jeromecukier.net/blog/2011/08/11/d3-scales-and-color/">d3:scales and color</a>’. I thoroughly recommend you read it (and plenty more of the great work by Jerome) as he really does nail the description in my humble opinion. I will put my own description down here, but if it doesn’t seem clear, head on over to Jerome’s page.</p>

</aside>

<p>From our basic web page we have now moved to the section that includes the following lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>The purpose of these portions of the script is to ensure that the data we ingest fits onto our graph correctly. Since we have two different types of data (date/time and numeric values) they need to be treated separately (but they do essentially the same job). To examine this whole concept of scales, domains and ranges properly, we will also move slightly out of sequence and (in conjunction with the earlier scale statements) take a look at the lines of script that occur later and set the domain. They are as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>The idea of scaling is to take the values of data that we have and to fit them into the space we have available. </p>

<p>If we have data that goes from 53.98 to 636.23 (as the data we have for ‘close’ in our csv file does), but we have a graph that is 210 pixels high (height = 270 - margin.top – margin.bottom;) we clearly need to make an adjustment.</p>

<p>Not only that. Even though our data  goes from 53.98 to 636.23, that would look slightly misleading on the graph and it should really go from 0 to a bit over 636.23.
It sound’s really complicated, but let’s simple it up a bit.</p>

<p>First we make sure that any quantity we specify on the x axis fits onto our graph.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
</pre></div>

</figure>

<p>Here we set our variable that will tell D3 where to draw something on the x axis. By using the d3.time.scale() function we make sure that D3 knows to treat the values as date / time entities (with all their ingrained peculiarities). Then we specify the range that those values will cover (.range) and we specify the range as being from 0 to the width of our graphing area (See! Setting those variables for margins and widths are starting to pay off now!).</p>

<p>Then we do the same for the Y axis. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>There’s a different function call (<code>d3.scale.linear()</code>) but the .range setting is still there. In the interests of drawing a (semi) pretty picture to try and explain, hopefully this will assist;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scales1.png" alt="Scaling the data to the graph size">
  <figcaption>Scaling the data to the graph size</figcaption>
</figure>


<p>I know, I know, it’s a little misleading because nowhere have we actually said to D3 this is our data from 53.98 to 636.23. All we’ve said is when we get the data, we’ll be scaling it into this space.</p>

<p>Now hang on, what’s going on with the <code>[height, 0]</code> part in y axis scale statement? The astute amongst you will note that for the time scale we set the range as <code>[0, width]</code> but for this one (<code>[height, 0]</code>) the values look backwards.</p>

<p>Well spotted.</p>

<p>This is all to do with how the screen is laid out and referenced. Take a look at the following diagram showing how the coordinates for drawing on your screen work;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scales2.png" alt="Coordinates that the browser expects">
  <figcaption>Coordinates that the browser expects</figcaption>
</figure>


<p>The top left hand of the screen is the origin or 0,0 point and as we go left or down the corresponding x and y values increase to the full values defined by height and width.</p>

<p>That’s good enough for the time values on the x axis that will start at lower values and increase, but for the values on the y axis we’re trying to go against the flow. We want the low values to be at the bottom and the high values to be at the top.</p>

<p>No problem. We just tell D3 via the statement <code>y = d3.scale.linear().range([height, 0]);</code> that the larger values (height) are at the low end of the screen (at the top) and the low values are at the bottom (as you most probably will have guessed by this stage, the .range statement uses the format <code>.range([closer_to_the_origin, further_from_the_origin])</code>. So when we put the height variable first, that is now associated at the top of the screen. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scales3.png" alt="Coordinates with adjusted ranges">
  <figcaption>Coordinates with adjusted ranges</figcaption>
</figure>


<p>We’ve scaled our data to the graph size and ensured that the range of values is set appropriately. What’s with the domain part that was in this section’s title?</p>

<p>Come on, you remember this little piece of script don’t you?</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>While it exists in a separate part of the file from the scale / range part, it is certainly linked.</p>

<p>That’s because there’s something missing from what we have been describing so far with the set up of the data ranges for the graphs. We haven’t actually told D3 what the range of the data is. That’s also the reason this part of the script occurs where it does. It is within the portion where the data.csv file has been loaded as ‘data’ and it’s therefore ready to use it.</p>

<p>So, the <code>.domain</code> function is designed to let D3 know what the scope of the data will be. This is what is then passed to the scale function.</p>

<p>Looking at the first part that is setting up the x axis values, it is saying that the domain for the x axis values will be determined by the <code>d3.extent</code> function which in turn is acting on a separate function which looks through all the ‘date’ values that occur in the ‘data’ array. In this case the <code>.extent</code> function returns the minimum and maximum value in the given array.</p>

<ul>
  <li>
<code>function(d) { return d.date; }</code> returns all the ‘date’ values in ‘data’. This is then passed to…</li>
  <li>The <code>.extent</code> function that finds the maximum and minimum values in the array and then…</li>
  <li>The <code>.domain</code> function which returns those maximum and minimum values to D3 as the range for the x axis.</li>
</ul>

<p>Pretty neat really. At first you might think it was overly complex, but breaking the function down into these components allows additional functionality with differing scales, values and quantities. In short, don’t sweat it. It’s a good thing.</p>

<p>The x axis values are dates; so the domain for them is basically from the 26th of March 2012 till 1st of May 2012. The y axis is done slightly differently</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>Because the range of values desired on the y axis goes from 0 to the maximum in the data range, that’s exactly what we tell D3. The ‘0’ in the .domain function is the starting point and the finishing point is found by employing a separate function that sorts through all the ‘close’ values in the ‘data’ array and returns the largest one. Therefore the domain is from 0 to 636.23.</p>

<p>Let’s try a small experiment. Let’s change the y axis domain to use the .extent function (the same way the x axis does) to see what it produces.</p>

<p>The JavaScript for the y domain will be;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">}));</code>
</pre></div>

</figure>

<p>You can see apart from a quick copy paste of the internals, all I had to change was the reference to ‘close’ rather than ‘date’.</p>

<p>And the result is…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scales4.png" alt="Graph using .extent for data values">
  <figcaption>Graph using .extent for data values</figcaption>
</figure>


<p>Look at that! The starting point for the y axis looks like it’s pretty much on the 53.98 mark and the graph itself certainly touches the x axis where the data would indicate it should.</p>

<p>Now, I’m not really advocating making a graph like this since I think it looks a bit nasty (and a casual observer might be fooled into thinking that the x axis was at 0). However, this would be a useful thing to do if the data was concentrated in a narrow range of values that are quite distant from zero.</p>

<p>For instance, if I change the data.csv file so that the values are represented like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scales5.png" alt="Concentrated data range graph">
  <figcaption>Concentrated data range graph</figcaption>
</figure>


<p>Then it kind of loses the ability to distinguish between values around the median of the data.</p>

<p>But, if I put in our magic .extent function for the y axis and redraw the graph…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scales6.png" alt="Expanded concentrated data range using .extent">
  <figcaption>Expanded concentrated data range using .extent</figcaption>
</figure>


<p>How about that?</p>

<p>The same data as the previous graph, but with one simple piece of the script changed and D3 takes care of the details.</p>

<h4 id="leanpub-auto-setting-up-the-axes">Setting up the Axes</h4>

<p>Now we come to our next piece of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>
</pre></div>

</figure>

<p>I’ve included both the x and y axes because they carry out the formatting in very similar ways. It’s worth noting that this is not the point where the axes get drawn. That occurs later in the piece where the data.csv file has been loaded as ‘data’.</p>

<p>D3 has it’s own axis component that aims to take the fuss out of setting up and displaying the axes. So it includes a number of configurable options.</p>

<p>Looking first at the x axis;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>
</pre></div>

</figure>

<p>The axis function is called with <code>d3.svg.axis()</code>. Then the scale is set using the x values that we set up in the scales, ranges and domains section using <code>.scale(x)</code>. Then a curious thing happens, we tell the graph to orientate itself to the bottom of the graph <code>.orient("bottom")</code>. If I tell you that “bottom” is the default setting, then you could be forgiven for thinking that technically, we don’t need to specify this since it will go there anyway, but it does give us an opportunity to change it to <code>"top"</code> to see what happens;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axistop.png" alt="x axis orientated to top">
  <figcaption>x axis orientated to top</figcaption>
</figure>


<p>Well, I hope you didn’t see that coming, because I didn’t. It transpires that what we’re talking about is the orientation of the values and ticks about the axis line itself. Ahh… Ok. Useful if your x axis is at the top of your graph, but for this one? Not so useful.</p>

<p>The next part (<code>.ticks(5)</code>) sets the number of ticks on the axis. Hopefully you just did a quick count across the bottom of the previous graph and went “Yep, five ticks. Spot on”. Well done if you did, but there’s a little bit of a sneaky trick up D3’s sleeve with the number of ticks on a graph axis.</p>

<p>For instance, here’s what the graph looks like when the <code>.ticks(5)</code> value is changed to <code>.ticks(4)</code>.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axis5ticks.png" alt="Five ticks on the x axis">
  <figcaption>Five ticks on the x axis</figcaption>
</figure>


<p>Eh? Hang on. Isn’t that some kind of mistake? There are still five ticks. Yep, sure is! But wait… we can keep dropping the ticks value till we get to two and it will still be the same. At <code>.ticks(2)</code> though, we finally see a change.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axis2ticks.png" alt="Two ticks on the x axis">
  <figcaption>Two ticks on the x axis</figcaption>
</figure>


<p>How about that? At first glance that just doesn’t seem right, then you have a bit of a think about it and you go “Hmm… When there were 5 ticks, they were separated by a week each, and that stayed that way till we got to a point where it could show a separation of a month.”.</p>

<p>D3 is making a command decision for you as to how your ticks should be best displayed. This is great for simple graphs and indeed for the vast majority of graphs. Like all things related to D3, if you really need to do something bespoke, it will let you if you understand enough code.</p>

<p>The following is the <a href="https://github.com/mbostock/d3/wiki/Time-Scales">list</a> of time intervals that D3 will consider when setting automatic ticks on a time based axis;</p>

<ul>
  <li>1-, 5-, 15and 30-second.</li>
  <li>1-, 5-, 15and 30-minute.</li>
  <li>1-, 3-, 6and 12-hour.</li>
  <li>1 and 2-day.</li>
  <li>1-week.</li>
  <li>1 and 3-month.</li>
  <li>1-year.</li>
</ul>

<p>Just for giggles have a think about what value of ticks you will need to increase to until you get D3 to show more than five ticks.</p>

<p>Hopefully you won’t sneak a glance at the following graph before you come up with the right answer.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axis10ticks.png" alt="Ten ticks on the x axis">
  <figcaption>Ten ticks on the x axis</figcaption>
</figure>


<p>Yikes! The answer is 10! And then when it does, the number of ticks is so great that they jumble all over each other. Not looking to good there. However, you could rotate the text (or perhaps slant it) and it could still fit in (that must be the topic of a future how-to). You could also make the graph longer if you wanted, but of course that is probably going to create other layout problems. Try to think about your data and presentation as a single entity.</p>

<p>The code that formats the y axis is pretty similar;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>
</pre></div>

</figure>

<p>We can change the orientation to <code>"right"</code> if we want, but it won’t be winning any beauty prizes.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/yaxisright.png" alt="y axis right orientated">
  <figcaption>y axis right orientated</figcaption>
</figure>


<p>Nope. Not a pretty sight.</p>

<p>What about the number of ticks? Well this scale is quite different to the x axis. Formatting the dates using logical separators (weeks, months) was tricky, but with standard numbers, it should be a little easier. In fact, there’s a fair chance that you’ve already had a look at the y axis and seen that there are 6 ticks there when the script is asking for 5 :-)</p>

<p>We can lower the tick number to 4 and we get a logical result.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/yaxis3ticks.png" alt="Three ticks on the y axis">
  <figcaption>Three ticks on the y axis</figcaption>
</figure>


<p>We need to raise the count to 10 before we get more than 6.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/yaxis10ticks.png" alt="Ten ticks on the y axis">
  <figcaption>Ten ticks on the y axis</figcaption>
</figure>


<h4 id="leanpub-auto-adding-data-to-the-line-function">Adding data to the line function</h4>

<p>We’re getting towards the end of our journey through the script now. The next step is to get the information from the array ‘data’ and to place it in a new array that consists of a set of coordinates that we are going to plot.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>I’m aware that the statement above may be somewhat ambiguous. You would be justified in thinking that we already had the data stored and ready to go. But that’s not <em>strictly</em> correct.</p>

<p>What we have is data in a raw format, we have added pieces of code that will allow the data to be adjusted for scale and range to fit in the area that we want to draw, but we haven’t actually taken our raw data and adjusted it for our desired coordinates. That’s what the code above does.</p>

<p>The main function that gets used here is the <code>d3.svg.line()</code> <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-line">function</a>. This function uses accessor functions to store the appropriate information in the right area and in the case above they use the x and y accessors (that would be the bits that are <code>.x</code> and <code>.y</code>). The <code>d3.svg.line()</code> function is called a ‘path generator’ and this is an indication that it can carry out some pretty clever things on its own accord. But in essence its job is to assign a set of coordinates in a form that can be used to draw a line.</p>

<p>Each time this line function is called on, it will go through the data and will assign coordinates to ‘date’ and ‘close’ pairs using the ‘x’ and ‘y’ functions that we set up earlier (which of course are responsible for scaling and setting the correct range / domain).</p>

<p>Of course, it doesn’t get the data all by itself, we still need to actually call the valueline function with  ‘data’ as the source to act on. But never fear, that’s coming up soon.</p>

<h4 id="leanpub-auto-adding-the-svg-canvas">Adding the SVG Canvas.</h4>

<p>As the title states, the next piece of script forms and adds the canvas that D3 will then use to draw on.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>So what exactly does that all mean?</p>

<p>Well D3 needs to be able to have a space defined for it to draw things. When you define the space it’s going to use, you can also give the space you’re going to use an identifying name and attributes. </p>

<p>In the example we’re using here, we are ‘appending’ an SVG element (a canvas that we are going to draw things on) to the <code>&lt;body&gt;</code> element of the HTML page.</p>

<aside class="information blurb">
    <p>In human talk that means that on the web page and bounded by the <code>&lt;body&gt;</code> tag that we saw in the HTML part, we will have an area to draw on. That area will be ‘width’ plus the left and right margins wide and ‘height’ plus the top and bottom margins wide.</p>

</aside>

<p>We also add an element ‘g’ that is referenced to the top left corner of the actual graph area on the canvas. ‘g’ is actually a grouping element in the sense that it is normally used for grouping together several related elements. So in this case those grouped elements will have a common reference.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/margins.png" alt="Canvas and margins">
  <figcaption>Canvas and margins</figcaption>
</figure>


<p>(the image above is definitely not to scale, but I hope you get the general idea)</p>

<p>Interesting things to note about the code. The <code>.attr(“stuff in here”)</code> parts are attributes of the appended elements they are part of.</p>

<p>For instance;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
</pre></div>

</figure>

<p>tells us that  the ‘svg’ element has a “width” of width + margin.left + margin.right and the “height”  of  height + margin.top + margin.bottom.</p>

<p>Likewise… </p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>tells us that the element “g” has been transformed by moving(translating) to the point margin.left, margin.top. Or to the top left of the graph space proper. This way when we tell something to be drawn on our canvas, we can use the reference point “g” to make sure everything is in the right place.</p>

<h4 id="leanpub-auto-actually-drawing-something">Actually Drawing Something!</h4>

<p>Up until now we have spent a lot of time defining, loading and setting up. Good news! We’re about to finally draw something!</p>

<p>We jump lightly over some of the code that we have already explained and land on the part that draws the line.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>		     <code class="c1">// Add the valueline path.</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>This area occurs in the part of the code that has the data loaded and ready for action.</p>

<p>The <code>svg.append("path")</code> portion adds a new path element . A path element represents a shape that can be manipulated in lots of different ways (see more here: <a href="http://www.w3.org/TR/SVG/paths.html">http://www.w3.org/TR/SVG/paths.html</a>). In this case it inherits the ‘path’ styles from the CSS section and on the following line (<code>.attr("d", valueline(data));</code>)  we add the attribute “d”. </p>

<p>This is an attributer that stands for ‘path data’ and sure enough the <code>valueline(data)</code> portion of the script passes the ‘valueline’ array (with its x and y coordinates) to the path element. This then creates a svg element which is a path going from one set of ‘valueline’ coordinates to another.</p>

<p>Then we get to draw in the axes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>                <code class="c1">// Add the X Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>               <code class="c1">// Add the Y Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
</pre></div>

</figure>

<p>We have covered the formatting of the axis components earlier. So this part is actually just about getting those components drawn onto our canvas.</p>

<p>So both axes start by being appended to the “g” group. Then each has its own classes applied for styling via CSS. If you recall from earlier, they look a little like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Feel free to mess about with these to change the appearance of your axes.</p>

<p>On the x axis, we have a transform statement (<code>.attr("transform", "translate(0," + height + ")")</code>). If you recall, our point of origin for drawing is in the top left hand corner. Therefore if we want our x axis to be on the bottom of the graph, we need to move (transform) it to the bottom by a set amount. The set amount in this case is the height of the graph proper (height). So, for the point of demonstration we will remove the transform line and see what happens;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/axistransformed.png" alt="x axis transformed to the top of the graph">
  <figcaption>x axis transformed to the top of the graph</figcaption>
</figure>


<p>Yep, pretty much as anticipated.</p>

<p>The last part of the two sections of script ( <code>.call(xAxis);</code> and <code>.call(yAxis);</code> ) call the x and y axis functions and initiate the drawing action.</p>

<h3 id="leanpub-auto-wrap-up">Wrap Up</h3>

<p>Well that’s it. In theory, you should now be a complete D3 ninja.</p>

<p>OK, perhaps a slight exaggeration. In fact there is a strong possibility that the information I have laid out here is at best borderline useful and at worst laden with evil practices and gross inaccuracies.</p>

<p>But look on the bright side. Irrespective of the nastiness of the way that any of it was accomplished or the inelegance of the code, if the picture drawn on the screen is pretty, you can walk away with a smile. :-)</p>

<p>This section concludes a very basic description of one type of a graphic that can be built with D3. We will look at adding value to it in subsequent chapters.</p>

<p>I’ve said it before and I’ll say it again. This is not a how-to for learning D3. This is how I have managed to muddle through in a bumbling way to try and achieve what I wanted to do. If some small part of it helps you. All good. Those with a smattering of knowledge of any of the topics I have butchered above (or below) are fully justified in feeling a large degree of righteous indignation. To those I say, please feel free to amend where practical and possible, but please bear in mind this was written from the point of view of someone with no experience in the topic and therefore try to keep any instructions at a level where a new entrant can step in.</p>

<h2 id="leanpub-auto-things-you-can-do-with-the-basic-graph">Things you can do with the basic graph</h2>

<p>The following headings in this section are intended to be a list of relatively simple ‘block’ type improvements that you can do to your graph to add functionality. The idea is to be able to use the simple graph that was used for the explanation of how D3 worked and just slot in code to add functionality (let’s hope it works for you :-)).</p>

<p>I have included the full code for a graph that includes rotated axis label, title, grid lines and filled area as an appendix (Graph with Many Features) for those who would prefer to see the code as a block.</p>

<p>The full code for this example can also be found on <a href="https://gist.github.com/d3noob/e1aa61856118edfa624d">github</a> or in the code samples bundled with this book (graph-with-many-features.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/e1aa61856118edfa624d">bl.ocks.org</a></p>

<h3 id="leanpub-auto-adding-axis-labels">Adding Axis Labels</h3>

<p>What’s the first thing you get told at school when drawing a graph?</p>

<p>“Always label your axes!”</p>

<p>So, time to add a couple of labels!</p>

<p>First things first (because they’re done slightly differently), the x axis. If we begin by describing what we want to achieve, it may make the process of implementing a solution a little more logical.</p>

<p>What we want to do is to add a simple piece of text under the x axis and in the centre of the total span. Wow, that does sound easy.</p>

<p>And it is, but there are different ways of accomplishing it, and I think I should take an opportunity to demonstrate them. Especially since one of those ways is a BAD idea.
Lets start with the bad idea first :-).</p>

<p>This is the code we’re going to add to the simple line graph script;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>             <code class="c1">// text label for the x axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">265</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="mi">240</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Date"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We will put it in between the blocks of script that add the x axis and the y axis.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>              <code class="c1">// Add the X Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="c1">//	PUT THE NEW CODE HERE!</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>             <code class="c1">// Add the Y Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
</pre></div>

</figure>

<p>Before we describe what’s happening, let’s take a look at the result;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/date01.png" alt="Date label on x axis">
  <figcaption>Date label on x axis</figcaption>
</figure>


<p>Well, it certainly did what it was asked to do. There’s a ‘Date’ label as advertised! (Yes, I know it’s not pretty.) Let’s describe the code and then work out why there’s a better way to do it.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>                <code class="c1">// text label for the x axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">265</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">240</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Date"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The first line appends a “text” element to our canvas. There is a lot more to learn about  “text” elements at the home of the <a href="http://www.w3.org/TR/SVG/text.html#TextElement">World Wide Web Consortium (W3C)</a>.
The next two lines ( <code>.attr("x", 265 ) and .attr("y", 240 )</code> ) set the attributes for the x and y coordinates to position the text on the canvas. </p>

<p>The second last line (<code>.style("text-anchor", "middle")</code>) ensures that the text ‘style’ is such that the text is centre aligned and therefore remains nicely centred on the x,y coordinates that we send it to.</p>

<p>The final line (<code>.text("Date");</code>) adds the actual text that we are going to place.</p>

<p>That seems really simple and effective and it is. However, the bad part about it is that we have hard coded the location for the date into the code. This means if we change any of the physical aspects of the graph, we will end up having to re-calculate and edit our code. And we don’t want to do that.</p>

<p>Here’s an example. If I decide that I would prefer to increase the height of the graph by editing the line here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>and making the height 350 pixels;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">height</code> <code class="o">=</code> <code class="mi">350</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>The result is as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/date02.png" alt="Hard coded Date label">
  <figcaption>Hard coded Date label</figcaption>
</figure>


<p><em>EVERYTHING</em> about the graph has adjusted itself, except our nasty, hard coded ‘Date’ label. This is far from ideal and can be easily fixed by using the variables that we set up ever so carefully earlier.</p>

<p>So, instead of;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">265</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">240</code> <code class="p">)</code>
</pre></div>

</figure>

<p>lets let our variables do the walking and use;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
</pre></div>

</figure>

<p>So with this code we tell the script that the ‘Date’ label will always be halfway across the width of the graph (no matter how wide it is) and at the bottom of the graph with respect to it’s height and the bottom margin (remember it uses a coordinates system that increases from the top down).</p>

<p>The end result of using variables is that if I go to an extreme of changing the height and width of my graph to;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">width</code> <code class="o">=</code> <code class="mi">400</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">200</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>We still finish up with an acceptable result;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/date03.png" alt="Auto adjusting Date label">
  <figcaption>Auto adjusting Date label</figcaption>
</figure>


<p>Well, for the label position at least :-).</p>

<p>So the changes to using variables is just a useful lesson that variables rock and mean that you don’t have to worry about your graph staying in relative shape while you change the dimensions. The astute readers amongst you will have learned this lesson very early on in your programming careers, but it’s never a bad idea to make sure that users that are unfamiliar with the concept have an indicator of why it’s a good idea.</p>

<p>Now the third method that I mentioned at the start of our x axis odyssey. This is not mentioned because it’s any better or worse way to implement your script (The reason that I say this is because I’m not sure if it’s better or worse.) but because it’s sufficiently different to make it look confusing if you didn’t think of it in the first place.</p>

<p>So, we’ll take our marvellous coordinates code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code> <code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
</pre></div>

</figure>

<p>And replace it with a single (longer) line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code><code class="nx">width</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" ,"</code> <code class="o">+</code> 
                         <code class="p">(</code><code class="nx">height</code><code class="o">+</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
</pre></div>

</figure>

<p>This uses the <code>"transform"</code> attribute to move (translate) the point to place the ‘Date’ label to exactly the same spot that we’ve been using for the other two examples (using variables of course).</p>

<aside class="question blurb">
    <h3 id="leanpub-auto-why-does-that-line-look-odd">Why does that line look odd?</h3>
  <p>The <code>"translate”</code> function is done in a ‘translate(x,y)’ style but it is put on the page in such a way that the verbatim pieces that get passed back are in speech marks and the variables are in the clear (in a manner of speaking). That’s why the comma is in speech marks.
Additionally, the variables are contained within plus signs. I make the assumption that this is a designator for ‘areas where there is variable action going on’. The end result is that if you try to do some maths in that area with a plus sign, it does not appear to work (or at least it didn’t for me). That’s why I put the variable for ( <code>+ (height + margin.bottom) +</code> )  in parenthesis (then I thought I should make the <code>+ (width / 2) +</code> part look the same, but actually you can get away without them there).</p>

</aside>

<p>So, that’s the x axis label. Time to do the y axis. The code we’re going to use looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code><code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value"</code><code class="p">);</code>
</pre></div>

</figure>

<p>For the sake of neatness we will put the piece of code in a nice logical spot and this would be following the block of code that added the y axis (but before the closing curly bracket)</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>			<code class="c1">// Add the Y Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

    <code class="c1">//	PUT THE NEW CODE HERE!</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>And the result looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/value01.png" alt="y axis label with rotation!">
  <figcaption>y axis label with rotation!</figcaption>
</figure>


<p>There we go, a label for the y axis that is nicely centred and (gasp!) rotated by 90 degrees! Woah, does the leetness never end! (No. No it does not.)</p>

<p>So, how do we get to this incredible result?</p>

<p>The first thing we do is the same as for the x axis and append a text element to our canvas (<code>svg.append("text")</code>).</p>

<p>Then things get interesting.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Because that line rotates everything by -90 degrees. While it’s obvious that the text label ‘Value’ has been rotated by -90 degrees (from the picture), the following lines of code show that we also rotated our reference point (which can be a little confusing).</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code><code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
</pre></div>

</figure>

<p>Let’s get graphical to illustrate how this works;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/value02.png" alt="Reference point pre-rotation">
  <figcaption>Reference point pre-rotation</figcaption>
</figure>


<p>Here’s our starting position, with x,y in the 0,0 coordinate of the graph drawing area surrounded by the margins.</p>

<p>When we apply a -90 degrees transform we get the equivalent of this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/value03.png" alt="Reference point after rotation">
  <figcaption>Reference point after rotation</figcaption>
</figure>


<p>Here the 0,0 coordinate has been shifted by -90 degrees and the x,y designations are flipped so that we now need to tell the script that we’re moving a ‘y’ coordinate when we would have otherwise been moving ‘x’.</p>

<p>Hence, when the script runs…   </p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
</pre></div>

</figure>

<p>… we can see that this is moving the x position to the left from the new 0 coordinate by the margin.left value. </p>

<p>Likewise when the script runs…</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code><code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
</pre></div>

</figure>

<p>… this is actually moving the y position from the new 0 coordinate halfway up the height of the graph area.</p>

<aside class="information blurb">
    <p>I will be the first to admit that this does seem a little confusing. But here’s the good part. You really don’t need to understand it completely. Simply do what I did when I saw the code. Play with it a bit till you get the result you were looking for. If that means putting in some hard coded numbers and incrementing them to see which way is the new ‘up’. Good! Once you work it out, then work out how to get the right variable expression in there and you’re set.</p>

  <p>In the worst case scenario, simply use the code blocks as shown here and leave well enough alone :-).</p>

</aside>

<p>Right, we’re not quite done yet. The following line has the effect of shifting the text slightly to the right.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Firstly the reason we do this is that our previous translation of coordinates means that when we place our text label it sits exactly on the line of 0 – margin.left. But in this case that takes the text to the other side of the line, so it actually sits just outside the boundary of the overall canvas. </p>

<p>The <code>"dy"</code> attribute is another coordinate adjustment move, but this time a relative adjustment and the “1em” is a unit of measure that equals exactly one unit of the currently specified <a href="http://en.wikipedia.org/wiki/Em_(typography)">text point size</a>. So what ends up happening is that the ‘Value’ label gets shifted to the right by exactly the height of the text, which neatly places it exactly on the edge of the canvas.</p>

<p>The two final lines of this part of the script are the same as for the x axis. They make sure the reference point is aligned to the centre of the text (<code>.style("text-anchor", "middle")</code>) and then it prints the text (<code>.text("Value");</code>). There, that wasn’t too painful.</p>

<p>The astute amongst you (and I’m picking that if you’re reading this far into the book, you will definitely qualify as astute or at least suckers for punishment) will notice that the example that I have included in the appendices and online does not have the ‘Value’ label. Instead it has the text ‘Price ($)’and it appears on the area of the graph itself! Well spotted. The technique used above is identical to the one used in the description here, but in the example code we have taken an additional step of demonstrating how to place a white shadowy background under the text (more of that to come in a couple of sections!).</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-how-to-add-a-title-to-your-graph">How to add a title to your graph</h3>

<p>If you’ve read through the adding the axis labels section most of this will come as no surprise.</p>

<p>What we want to do to add a title to the graph is to add a text element (just a few words) that will appear above the graph and centred left to right.</p>

<p>The code block we will use will looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>				
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"16px"</code><code class="p">)</code> 
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 	
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value vs Date Graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>And the end result will look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/title01.png" alt="Basic graph with title">
  <figcaption>Basic graph with title</figcaption>
</figure>


<p>A nice logical place to put the block of code would be towards the end of the JavaScript. In fact I would put it as the last element we add. So here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>              <code class="c1">// Add the Y Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

    <code class="c1">// PUT THE NEW CODE HERE!</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>Now since the vast majority of the code for this block is a regurgitation of the axis labels code, I don’t want to revisit that and bloat up this document even more, so I will direct you back to that section if you need to refresh yourself on any particular line. But….. There are a couple of new ones in there which could benefit from a little explanation.</p>

<p>Both of them are style descriptors and as such their job is to apply a very specific style to this element.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"16px"</code><code class="p">)</code> 
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 	
</pre></div>

</figure>

<p>What they do is pretty self explanatory. Make the text a specific size and underline it. But what is perhaps slightly more interesting is that we have this declaration in the JavaScript code and not in the CSS portion of the file.</p>

<aside class="information blurb">
    <p>Strictly speaking, this is the sort of thing that would be placed in the <code>&lt;style&gt;</code> section of the HTML code, but in this case, since it is only going to be used once, we shouldn’t feel too bad putting it here.</p>

</aside>

<div class="page-break"></div>
<h3 id="smoothing">Smoothing out graph lines</h3>

<p>When you draw a line graph, what you’re doing is taking two (or more) sets of coordinates and connecting them with a line (or lines). I know that sounds simplistic, but bear with me. When you connect these points, you’re telling the viewer of the graph that in between the individual points, you expect the value to vary in keeping with the points that the line passes through. So in a way, you’re trying to interpret the change in values that are not shown.</p>

<p>Now this is not strictly true for all graph types, but it does hold for a lot of line graphs. </p>

<p>So… when connecting these known coordinates together, you want to make the best estimate of how the values would be represented. In this respect, sometimes a straight line between points is not  the best representation.</p>

<p>For instance. Earlier, when demonstrating the extent function for graphing we showed a graph of the varying values with the y axis showing a narrow range.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth01.png" alt="Expanded values for a narrow range">
  <figcaption>Expanded values for a narrow range</figcaption>
</figure>


<p>The resulting variation of the graph shows a fair amount of extremes and you could be forgiven for thinking that if this represented a smoothly flowing analog system of some kind then some of those sharp peaks and troughs would not be a true representation of how the system or figures varied.</p>

<p>So how should it look? Ahh… The $64,000 question. I don’t know :-). You will have a better idea since you are the person who will know your data best. However, what I do know is that D3 has some tricks up its sleeve to help.</p>

<p>We can easily change what we see above into;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth02.png" alt='Smoothing using "basis"'>
  <figcaption>Smoothing using “basis”</figcaption>
</figure>


<p>How about that? And the massive amount of code required to carry out what must be a ridiculously difficult set of calculations?</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>	
</pre></div>

</figure>

<aside class="information blurb">
    <p>Now, that is slightly unfair because that’s the code that YOU need to put in your script, but Mike Bostock probably had to do the mental equivalent of walking across hot coals to get it to work so nicely.</p>

</aside>

<p>So where does this neat piece of code go? Here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>	 		<code class="c1">// &lt;=== THERE IT IS!</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>So is that it? Nooooo…….. There’s more! This is one form of interpolation effect that can be applied to your data, but there is a range and depending on your data you can select the one that is appropriate.</p>

<p>Here’s the list of available options and for more about them head on over to the <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-line_interpolate">D3 wiki</a> and look for ‘line.interpolate’.</p>

<ul>
  <li>linear – Normal line (jagged).</li>
  <li>step-before – a stepping graph alternating between vertical and horizontal segments.</li>
  <li>step-after - a stepping graph alternating between horizontal and vertical segments.</li>
  <li>basis - a B-spline, with control point duplication on the ends (that’s the one above).</li>
  <li>basis-open - an open B-spline; may not intersect the start or end.</li>
  <li>basis-closed - a closed B-spline, with the start and the end closed in a loop.</li>
  <li>bundle - equivalent to basis, except a separate tension parameter is used to straighten the spline. This could be really cool with varying tension.</li>
  <li>cardinal - a Cardinal spline, with control point duplication on the ends. It looks slightly more ‘jagged’ than basis.</li>
  <li>cardinal-open - an open Cardinal spline; may not intersect the start or end, but will intersect other control points. So kind of shorter than ‘cardinal’.</li>
  <li>cardinal-closed - a closed Cardinal spline, looped back on itself.</li>
  <li>monotone - cubic interpolation that makes the graph only slightly smoother.</li>
</ul>

<p>Because in the course of writing this I took an opportunity to play with each of them, I was pleasantly surprised to see some of the effects and it seems like a shame to deprive the reader of the same joy :-). So at the risk of deforesting the planet (so I hope you are reading this in electronic format) here is each of the above interpolation types applied to the same data.</p>

<p>This is also an opportunity to add some reader feedback awesomeness. Many thanks to ‘enjalot’ for the great suggestion to plot the points of the data as separate circles on the graphs. Since the process of interpolation has the effect of ‘interpreting’ the trends of the data to the extent that in some cases, the lines don’t intersect the actual data much at all.</p>

<p>Each of the following shows the smoothing curve and the data that is used to plot the graph.   </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth03.png" alt='Smoothing using "linear"'>
  <figcaption>Smoothing using “linear”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth04.png" alt='Smoothing using "step-before"'>
  <figcaption>Smoothing using “step-before”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth05.png" alt='Smoothing using "step-after"'>
  <figcaption>Smoothing using “step-after”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth06.png" alt='Smoothing using "basis"'>
  <figcaption>Smoothing using “basis”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth07.png" alt='Smoothing using "basis-open"'>
  <figcaption>Smoothing using “basis-open”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth08.png" alt='Smoothing using "basis-closed"'>
  <figcaption>Smoothing using “basis-closed”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth09.png" alt='Smoothing using "bundle"'>
  <figcaption>Smoothing using “bundle”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth10.png" alt='Smoothing using "cardinal"'>
  <figcaption>Smoothing using “cardinal”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth11.png" alt='Smoothing using "cardinal-open"'>
  <figcaption>Smoothing using “cardinal-open”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth12.png" alt='Smoothing using "cardinal-closed"'>
  <figcaption>Smoothing using “cardinal-closed”</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth13.png" alt='Smoothing using "monotone"'>
  <figcaption>Smoothing using “monotone”</figcaption>
</figure>


<p>Just in case you’re in the mood for another example, here are voronoi tessellations drawn with various d3 line interpolators (the original interactive version by ‘shawnbot’ can be found <a href="http://bl.ocks.org/shawnbot/5970227">here</a>).</p>

<div class="page-break"></div>
<p>First a version using the linear interpolation when each of the points is joined faithfully with a straight line. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth-linear.png" alt='Polygon Smoothing using "linear"'>
  <figcaption>Polygon Smoothing using “linear”</figcaption>
</figure>


<p>Now a version where the polygons are formed with the ‘basis-closed’ interpolator (note how the lines don’t go through the points that describe the bounds of the polygons/blobs).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth-basis-closed.png" alt='Polygon Smoothing using "basis-closed"'>
  <figcaption>Polygon Smoothing using “basis-closed”</figcaption>
</figure>


<div class="page-break"></div>
<p>And lastly, using the ‘cardinal-closed’ interpolator, while the line travels through each point in the polygon, they overshoot in an effort to maintain a nice curve and the resulting polygon/blobs overlap.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/smooth-cardinal-closed.png" alt='Polygon Smoothing using "cardinal-closed"'>
  <figcaption>Polygon Smoothing using “cardinal-closed”</figcaption>
</figure>


<p>So, over to you to decide which format of interpolation is going to suit your data best:-).</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-adding-grid-lines-to-a-graph">Adding grid lines to a graph</h3>

<p>Grid lines are an important feature for some graphs as they allow the eye to associate three analogue scales (the x and y axis and the displayed line).</p>

<p>There is currently a tendency to use graphs without grid lines online as it gives the appearance of a ‘cleaner’ interface, but they are still widely used and a necessary component for graphing.</p>

<p>This is what we’re going to draw;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/grid01.png" alt="Basic graph with gridlines">
  <figcaption>Basic graph with gridlines</figcaption>
</figure>


<aside class="information blurb">
    <p>Like pretty much everything in this document, the clever parts of this are not my work. I’ve simply used other peoples cleverness to solve my problems. In this case I think the source of this solution came from the good work of Justin Palmer in his excellent description of the design of a line graph <a href="http://dealloc.me/2011/06/24/d3-is-not-a-graphing-library.html">here</a>. However, in retrospect when I’ve looked back, I’m not sure if I got this right (as I did this quite a while ago when I was less fastidious about noting my sources). In any case, Justin’s work is excellent and I heartily recommend it, and here is my implementation of what I think is his work :-)</p>

</aside>

<p>How to build grid lines?</p>

<p>We’re going to use the axis function to generate two more axis elements (one for x and one for y) but for these ones instead of drawing the main lines and the labels, we’re just going to draw the tick lines. Really long ticklines (I’m considering calling them <a href="http://knowyourmeme.com/memes/longcat">long cat</a> lines).</p>

<p>To create them we have to add in 3 separate blocks of code.</p>

<ol class="numeric">
  <li>One in the CSS section to define what style the grid lines will have.</li>
  <li>One to define the functions that generate the grid lines. And…</li>
  <li>One to draw the lines.</li>
</ol>

<h4 id="leanpub-auto-the-grid-line-css">The grid line CSS</h4>

<p>This is the total styling that we need to add for the tick lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.grid</code> <code class="nc">.tick</code> <code class="p">{</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">lightgrey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">7</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.grid</code> <code class="nt">path</code> <code class="p">{</code>
          <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Just add this block of code at the end of the current CSS that is in the simple graph template (just before the <code>&lt;/style&gt;</code> tag).</p>

<p>The CSS here is done in two parts.</p>

<p>The first portion sets the line colour (stroke), the opacity (transparency) of the lines and make sure that the lines are narrow (<code>crispEdges</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nt">stroke</code><code class="o">:</code> <code class="nt">lightgrey</code><code class="o">;</code>
    <code class="nt">stroke-opacity</code><code class="o">:</code> <code class="nt">0</code><code class="nc">.7</code><code class="o">;</code>
    <code class="nt">shape-rendering</code><code class="o">:</code> <code class="nt">crispEdges</code><code class="o">;</code>
</pre></div>

</figure>

<p>The colour is pretty standard, but in using the opacity style we give ourselves the opportunity to use a good shade of colour (if grey actually is a colour) and to juggle the degree to which it stands out a little better.</p>

<p>The second part is the stroke width.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nt">stroke-width</code><code class="o">:</code> <code class="nt">0</code><code class="o">;</code>
</pre></div>

</figure>

<p>Now it might seem a little weird to be setting the stroke width to zero, but if you don’t (and we remove the style) this is what happens;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/grid02.png" alt="Axis lines made too thick">
  <figcaption>Axis lines made too thick</figcaption>
</figure>


<p>If you look closely (compare with the previous picture if necessary) the main lines for the axis have turned thicker. The stroke width style is obviously adding in new (thicker) axis lines and we’re not interested in them at the moment. Therefore, if we set the stroke width to zero, we get rid of the problem.</p>

<h4 id="leanpub-auto-define-the-grid-line-functions">Define the grid line functions</h4>

<p>We will need to define two functions to generate the grid lines and they look a little like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">make_x_axis</code><code class="p">()</code> <code class="p">{</code>		
    <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">make_y_axis</code><code class="p">()</code> <code class="p">{</code>		
    <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Each function will carry out it’s configuration when called from the later part of the script (the drawing part).</p>

<p>A good spot to place the code is just before we load the data with the d3.csv </p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="c1">//   &lt;== Put the functions here!</code>
<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Both functions are almost identical. They give the function a name (make_x_axis and  make_y_axis) which will be used later when the piece of code that draws the lines calls out to them.</p>

<p>Both functions also show which parameters will be fed back to the drawing process when called. Both make sure they use the d3.svg.axis function and then they set individual attributes which make sense. </p>

<p>They make sure they’ve got the right axis (<code>.scale(x)</code> and <code>.scale(y)</code>). 
They set the orientation of the axes to match the incumbent axes (<code>.orient("bottom")</code> and <code>.orient("left")</code>).
And they set the number of ticks to match the number of ticks in the main axis (<code>.ticks(5)</code> and <code>.ticks(5)</code>). You have the opportunity here to do something slightly different if you want. For instance, think back to when we were setting up the axis for the basic graph and we messed about, seeing how many ticks we could get to appear. If we increase the number of ticks that appear in the grid (lets say to <code>.ticks(30)</code> and <code>.ticks(10)</code>)) we get the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/grid03.png" alt="Grid lines with greater divisions">
  <figcaption>Grid lines with greater divisions</figcaption>
</figure>


<p>So the grid lines can now show divisions of 50 on the y axis and per day on the x axis :-)</p>

<h4 id="leanpub-auto-draw-the-lines">Draw the lines</h4>

<p>The final block of code we need is the bit that draws the lines.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>			
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"grid"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">make_x_axis</code><code class="p">()</code>
            <code class="p">.</code><code class="nx">tickSize</code><code class="p">(</code><code class="o">-</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="p">)</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>			
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"grid"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">make_y_axis</code><code class="p">()</code>
            <code class="p">.</code><code class="nx">tickSize</code><code class="p">(</code><code class="o">-</code><code class="nx">width</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="p">)</code>
</pre></div>

</figure>

<p>The first two lines of both the x and y axis grid lines code above should be pretty familiar by now. The first one appends the element to be drawn to the group “g”. the second line (<code>.attr("class", "grid")</code>) makes sure that the style information set out in the CSS is applied.</p>

<p>The x axis grid lines portion makes a slight deviation from conformity here to adjust its positioning to take into account the coordinates system <code>.attr("transform", "translate(0," + height + ")")</code>.</p>

<p>Then both portions call their respective make axis functions (<code>.call(make_x_axis()</code> and <code>.call(make_y_axis()</code>).</p>

<p>Now comes the really interesting bit. </p>

<p>What you will see if you go to the <a href="https://github.com/mbostock/d3/wiki/SVG-Axes#wiki-tickSize">D3 API wiki</a> is that for the .tickSize function, the following is the format.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">axis</code><code class="p">.</code><code class="nx">tickSize</code><code class="p">([</code><code class="nx">major</code><code class="p">[</code><code class="err">?</code><code class="p">[,</code> <code class="nx">minor</code><code class="p">],</code> <code class="nx">end</code><code class="p">]])</code>
</pre></div>

</figure>

<p>That tells us that you get to specify the size of the ticks on the axes, by the major ticks, the minor ticks and the end ticks (that is to say the lines on the very end of the graph which, in the case of the example we are looking at, aren’t there!).</p>

<p>So in our example we are setting our major ticks to a length that corresponds to the full height or width of the graph. Which of course means that they extend across the graph and have the appearance of grid lines! What a neat trick.</p>

<p>Something I haven’t done before is to see what would happen if I included the tick lines for the minor and end ticks. So here we go :-)</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/grid04.png" alt="Disappointment! Where did I go wrong?">
  <figcaption>Disappointment! Where did I go wrong?</figcaption>
</figure>


<p>Darn! Disappointment. We can see a minor tick line for the y axis, but nothing for the x axis and nothing on the ends. Clearly I will have to run some experiments to see what’s going on there (later).</p>

<p>The last thing that is included in the code to draw the grid lines is the instruction to suppress printing any label for the ticks;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
</pre></div>

</figure>

<p>After all, that would become a bit confusing to have two sets of labels. Even if one was on top of the other. They do tend to become obvious if that occurs (they kind of bulk out a bit like bold text).</p>

<p>And that’s it. Grid lines!</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-make-a-dashed-line">Make a dashed line</h3>

<p>Dashed lines totally rock!</p>

<aside class="information blurb">
    <p>OK, there may be an element of exaggeration there, but I certainly found it interesting that there didn’t seem to be a lot of explanation for a simple bloke like myself to make a dashed line in D3. So for me they rocked :-)</p>

</aside>

<p>One of the best parts about it is that they’re so simple to do!</p>

<p>Literally one line!!!!</p>

<p>So lets imagine that we want to make the line on our simple graph dashed. All we have to do is insert the following line in our JavaScript code here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"3, 3"</code><code class="p">))</code>  <code class="c1">// &lt;== This line here!!</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>And our graph ends up like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/dashed01.png" alt="Dashed line for the basic graph">
  <figcaption>Dashed line for the basic graph</figcaption>
</figure>


<p>Hey! It’s dashtastic!</p>

<p>So how does it work?</p>

<p>Well, obviously <code>"stroke-dasharray"</code> is a style for the path element, but the magic is in the numbers.</p>

<p>Essentially they describe the on length and off length of the line. So <code>"3, 3"</code> translates to 3 pixels (or whatever they are) on and 3 pixels off. Then it repeats. Simple eh?</p>

<p>So, experiment time :-)</p>

<p>What would the following represent?</p>

<p><code>“5, 5, 5, 5, 5, 5, 10, 5, 10, 5, 10, 5”</code></p>

<p>Try not to cheat…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/dashed02.png" alt="Dashed lines for fun">
  <figcaption>Dashed lines for fun</figcaption>
</figure>


<p>Ahh yes, Mr. Morse would be proud.</p>

<p>And you can put them anywhere. Here’s our axes perverted with dashes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"3, 3"</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"3, 3"</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/dashed03.png" alt="When dashed lines go bad">
  <figcaption>When dashed lines go bad</figcaption>
</figure>


<p>Well… I suppose you can have too much of a good thing. With great power comes great responsibility. Use your dash skills wisely and only for good.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-filling-an-area-under-the-graph">Filling an area under the graph</h3>

<p>Lines are all very well and good, but that’s not the whole story for graphs. Sometimes you’ve just got to go with a fill.</p>

<p>Filling an area with a solid colour isn’t too hard. I mean we did it by mistake back a few pages when we were trying to draw a line.</p>

<p>But to do it in a nice coherent way is fairly straight forward.</p>

<p>It takes three sections of code in much the same way that we drew our grid lines earlier;</p>

<ol class="numeric">
  <li>One in the CSS section to define what style the area will have.</li>
  <li>One to define the functions that generate the area. And…</li>
  <li>One to draw the area.</li>
</ol>

<p>The end result will looks a bit like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fill01.png" alt="Basic graph with an area fill">
  <figcaption>Basic graph with an area fill</figcaption>
</figure>


<h4 id="leanpub-auto-css-for-an-area-fill">CSS for an area fill</h4>

<p>This is pretty straight forward and only consists of two rules;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.area</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">lightsteelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Put them at the bottom of your <code>&lt;style&gt;</code> section.</p>

<p>The first one (<code>fill: lightsteelblue;</code>) sets the colour of our fill (and in this case we have chosen a lighter shade of the same colour as our line to match it) and the second one (stroke-width: 0;) sets the width of the line that surrounds the area to zero. This last rule is kind of important in making a filled area work well. The whole idea is that the graph is made up of separate elements that will compliment each other. There’s the axes, the line and the fill. If we don’t tell the code that there is no line surrounding the filled area, it will assume that there is one and add it in like this.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fill02.png" alt="Line surrounding filled area">
  <figcaption>Line surrounding filled area</figcaption>
</figure>


<p>So what has happened here is that the area element has inherited the line property from the path element and surrounding the area is a 2px wide steelblue line. Not too pretty. Let’s not go there.</p>

<h4 id="leanpub-auto-define-the-area-function">Define the area function</h4>

<p>We need a function that will tell the area what space to fill. This is accessed from the <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-area"><code>d3.svg.area</code> function</a></p>

<p>The code that we will use is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>I have placed it in between the axis variable definitions and the line definitions here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>
                         <code class="o">&lt;====</code> <code class="nx">Put</code> <code class="nx">the</code> <code class="k">new</code> <code class="nx">code</code> <code class="nx">here</code><code class="o">!</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>You will notice it looks <em>INCREDIBLY</em> similar to the valueline function definition. That’s because; while the line definition describes drawing a line that connects a set of coordinates, I imagine the area definition describes drawing two lines that share the same x coordinates, but simultaneously draws two y coordinates, y0 and y1. Then when it’s finished drawing the resultant shape, it fills it with the colour of your choosing.</p>

</aside>

<p>So the only changes to the code are the addition of the <code>y0</code> line and the renaming of the <code>y</code> line <code>y1</code>.</p>

<p>Here’s a picture that might help explain;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fill03.png" alt="How the area is defined">
  <figcaption>How the area is defined</figcaption>
</figure>


<p>As should be apparent, the top line (<code>y1</code>) follows the valueline line and the bottom line is at the constant ‘height’ value. Everything in between these lines is what gets filled. The function in this section describes the area.</p>

<h4 id="leanpub-auto-draw-the-area">Draw the area</h4>

<p>Now to the money maker.</p>

<p>The final section of code in the area filling odyssey is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">);</code>
</pre></div>

</figure>

<p>We should place this block directly after the domain functions but before the drawing of the valueline path;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
                                <code class="c1">//   &lt;== Area drawing code here!</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>		
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>This is actually a pretty good idea to put it there since the various bits and pieces that are drawn in the graph are done so one after the other. This means that the filled area comes first, then the valueline is layered on top and then the axes come last. This is a pretty good sequence since if there are areas where two or more elements overlap, it might cause the graph to look ‘wrong’.</p>

<p>For instance, here is the graph drawn with the area added last.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fill04.png" alt="Area overlaps and obscures">
  <figcaption>Area overlaps and obscures</figcaption>
</figure>


<p>You should be able to notice that part of the valueline line has been obscured and the line for the y axis where it coincides with the area is obscured also.</p>

<p>Looking at the code we are adding here, the first line appends a path element (<code>svg.append("path")</code>) much like the script that draws the line.</p>

<p>The second line (<code>.datum(data)</code>) declares the data we will be utilising for describing the area and the third line (<code>.attr("class", "area")</code>) makes sure that the style we apply to it is as defined in the CSS section (under ‘area’).</p>

<p>The final line (<code>.attr("d", area);</code>) declares “d” as the attributer for path data and calls the ‘area’ function to do the drawing.</p>

<p>And that’s it!</p>

<h4 id="leanpub-auto-filling-an-area-above-the-line">Filling an area above the line</h4>

<p>Pop Quiz:</p>

<p>How would you go about filling the area <em>ABOVE</em> the graph?</p>

<aside class="information blurb">
    <p>Now it might sound a little trite, but believe it or not, this could come in handy. For instance, what if you want to highlight an area that was too high and an area that was too low for a line of data on a graph with an area in the centre where a projected ‘normal’ set of values should be present?</p>

</aside>

<p>In this instance, you could fill the lower area as has been demonstrated here, and with a small change you can fill another area with a solid colour above another line.</p>

<p>How is this incredible feat achieved?</p>

<p>Well, remember the code that defined the area?</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>All we have to do is tell it that instead of setting the <code>y0</code> constant value to the height of the graph (remember, this is the bottom of the graph) we will set it to the constant value that is at the top of the graph. In other words zero (0).</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
</pre></div>

</figure>

<p>That’s it.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fill05.png" alt="Fill an area above a line">
  <figcaption>Fill an area above a line</figcaption>
</figure>


<p>Now, I’m not going to go over the process of drawing two lines and filling each in different directions to demonstrate the example I described, but this provides a germ of an idea that you might be able to flesh out :-)</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-adding-a-drop-shadow-to-allow-text-to-stand-out-on-graphics">Adding a drop shadow to allow text to stand out on graphics.</h3>

<p>I’ve deliberately positioned this particular tip to follow the ‘filling an area’ description because it provides an opportunity to demonstrate the principle to slightly better effect.</p>

<p>There have been several opportunities where I have wanted to place text overlaid on graphs for convenience sake only to have it look overly messy as the text interferes with the graph.</p>

<aside class="question blurb">
    <h3 id="leanpub-auto-is-this-evil">Is this evil?</h3>
  <p>Now, I’ll be the first to say that the principle of overlaying text on a graph is probably not best practice, but sometimes you’ve got to do what you’ve got to do. Besides. Sometimes it’s a valid idea. If I remember rightly, the first time I came across this idea, it was being used to highlight text when positioned on bars of a bar graph. So it’s not always an evil practice :-).</p>

</aside>

<p>Anyway, what we’ll do is leave the fill in place and place the title back on the graph, but position the title so that it lays on top of the fill like so;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/drop01.png" alt="Title lost in the area fill">
  <figcaption>Title lost in the area fill</figcaption>
</figure>


<p>The additional code for the title is the following and appears just after the drawing of the axes.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>				
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">25</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"16px"</code><code class="p">)</code> 
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 	
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value vs Date Graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>(the only change from the previous title example is the ‘y’ attribute which has been hard coded to 25 to place it inconveniently on the filled area.)</p>

<p>So, what we want to end up with is something like the following…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/drop02.png" alt="A nice white drop shadow effect">
  <figcaption>A nice white drop shadow effect</figcaption>
</figure>


<p>In my humble opinion, it’s just enough to make the text acceptable :-).</p>

<p>The method that I’ll describe to carry this out is designed so that the drop shadow effect can be applied to any text elements in the graph, not the isolated example that we will use here. In order to implement this marvel of utility we will need to make changes in two areas. One in the CSS where we will define a style for white shadowy backgrounds and the second to draw it.</p>

<h4 id="leanpub-auto-css-for-white-shadowy-background">CSS for white shadowy background</h4>

<p>The code to add to the CSS section is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">text</code><code class="nc">.shadow</code> <code class="p">{</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2.5px</code><code class="p">;</code>
    <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">9</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The first line designates that the style applies to text with a ‘shadow’ label. The stroke is set to white. the width of the line is set to 2.5px and it is made to be slightly see-through. So by setting the line that surrounds the text to be thick, white and see-through gives it a slightly ‘cloudy’ effect. If we remove the black text from over the top we get a slightly better look;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/drop03.png" alt="A closer look at just the drop shadow">
  <figcaption>A closer look at just the drop shadow</figcaption>
</figure>


<p>Of course if you want to have a play with any of these settings, you should have a go and see what works best for your graph.</p>

<h4 id="leanpub-auto-drawing-the-white-shadowy-background">Drawing the white shadowy background.</h4>

<p>Now that we’ve set the style for our background, we need to draw it in.</p>

<p>The code for this should be extremely familiar;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>				
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">25</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"16px"</code><code class="p">)</code> 
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 	
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"shadow"</code><code class="p">)</code>		<code class="c1">// &lt;=== Here's the different line</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value vs Date Graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>That’s because it’s identical to the piece of code that was used to draw the title except for the one line that is indicated above. The reason that it’s identical is that what we are doing is placing a white shadow on the graph and then the text on top of it, if it deviated by a significant amount it will just look silly. Of course a slight amount could look effective, in which case adjust the ‘<code>x</code>’ or ‘<code>y</code>’ attributes.</p>

<p>One of the things I pointed out in the previous paragraph was extremely important. That’s the bit that tells you that we needed to place the shadow before we placed the black text. For the same reason that we placed the area fill on first in the area fill example, If black text goes on before the shadow, it will look pretty silly. So place this block of code just before the block that draws the title.</p>

<p>So the line that has been added in is the one that tells D3 that the text that is being drawn will have the white cloudy effect. And at the risk of repeating myself, if you have several text elements that could benefit from this effect, once you have the CSS code in place, all you need to do is duplicate the block that adds the text and add in that single line and voila!</p>

<p>Again the astute amongst you will note that in the example code in the appendices and online, the shadow effect is applied to the Y axis label. Never fear, it’s exactly the same principle :-).</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-adding-more-than-one-line-to-a-graph">Adding more than one line to a graph</h3>

<p>All right, we’re starting to get serious now. Two lines on a graph is a bit of a step into a different world in one respect. I mean that in the sense that there’s more than one way to carry out the task, and I tend to do it one way and not the other mainly because I don’t fully understand the other way :-(.</p>

<aside class="information blurb">
    <p>I should stress that that’s not because it’s more complex, or that it’s a bad way, it’s just that once I started doing things one way, I haven’t come across a need to do things another way. There’s a good chance I will have to revisit this decision in the future, but for now I’ll keep moving.</p>

</aside>

<p>So, how are we going to do this? I think that the best way will be to make the executive decision that we have suddenly come across more data and that it is also in our data.csv file (which we’ll rename data2.csv just to highlight the difference between the two data sets). In fact it looks a little like this (apologies in advance for the big ugly block of data);</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,open
1-May-12,68.13,34.12
30-Apr-12,63.98,45.56
27-Apr-12,67.00,67.89
26-Apr-12,89.70,78.54
25-Apr-12,99.00,89.23
24-Apr-12,130.28,99.23
23-Apr-12,166.70,101.34
20-Apr-12,234.98,122.34
19-Apr-12,345.44,134.56
18-Apr-12,443.34,160.45
17-Apr-12,543.70,180.34
16-Apr-12,580.13,210.23
13-Apr-12,605.23,223.45
12-Apr-12,622.77,201.56
11-Apr-12,626.20,212.67
10-Apr-12,628.44,310.45
9-Apr-12,636.23,350.45
5-Apr-12,633.68,410.23
4-Apr-12,624.31,430.56
3-Apr-12,629.32,460.34
2-Apr-12,618.63,510.34
30-Mar-12,599.55,534.23
29-Mar-12,609.86,578.23
28-Mar-12,617.62,590.12
27-Mar-12,614.48,560.34
26-Mar-12,606.98,580.12
</pre></div>

</figure>

<p>Three columns, date open and close. The first two are exactly what we have been dealing with all along and the last (open) is our new made up data. Each column is separated by a comma (hence .csv (comma separated values)), which is the format we’re currently using to import data.</p>

<p>We should save this as a new file so we don’t mess up our previous data, so (as mentioned earlier) let’s call it data2.csv. </p>

<p>There is a copy of this file and the sample code at <a href="https://gist.github.com/d3noob/8603837">github</a> and in the code samples bundled with this book (dual-line-with-labels.html and data2.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/8603837">bl.ocks.org</a>. The dual-line-with-labels.html file includes the double lines and also a labelling scheme which we will be describing in a later section.</p>

<p>We will build our new code using our simple graph template to start with, so the immediate consequence of this is that we need to edit the line that was looking for ‘data.csv’ to reflect the new name.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data2.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>So when you browse to our new graph’s html file, we don’t see any changes. It still happily loads the new data, but because it hasn’t been told to do anything with it, nothing new happens.</p>

<p>What we need to do now it to essentially duplicate the code blocks that drew the first line for the second line.</p>

<p>The good news is that in the simplest way possible that’s just two code blocks.
The first sets up the function that defines the new line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">valueline2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>You should notice that this block is identical to the block that sets up the function for the first line, except this one is called (imaginatively) valueline2. We should put it directly after the block that sets up the function for valueline.</p>

<p>The second block draws our new line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>          <code class="c1">// Add the valueline2 path.</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline2</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>Again, this is identical to the block that draws the first line, except this one is called valueline2. We should put it directly after the block that draws valueline.</p>

<p>After those three small changes, check out your new graph;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/twolines01.png" alt="Two lines, but the same colour">
  <figcaption>Two lines, but the same colour</figcaption>
</figure>


<p>Hey! Two lines! Hmm…. Both being the same colour is a bit confusing. Good news. We can change the colour of the second line by inserting a line that adjusts it’s stroke (colour) very simply.</p>

<p>So here’s what our new drawing block looks like;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>		<code class="c1">// Add the valueline2 path.</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline2</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>And as if by magic, here’s our new graph;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/twolines02.png" alt="Two lines with two colours">
  <figcaption>Two lines with two colours</figcaption>
</figure>


<p>Wow. Right about now, we’re thinking ourselves pretty clever. But there’s two places where we’re not doing things right. We took a simple way, but we took some short cuts that might bite us in the posterior.</p>

<p>The first mistake we made was not ensuring that our variable <code>"d.open"</code> is being treated as a number or a string. We’re fortunate in this case that it is, but this can’t always be assumed. So, this is an easy fix and we just need to put the following (indicated line) in our code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">open</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">;</code>        <code class="c1">//  &lt;=== Add this line in!</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>The second and potentially more fatal flaw is that nowhere in our code do we make allowance for our second set of data (the second line’s values) exceeding our first lines values. </p>

<p>That might not sound too normal straight away, but consider this. What if when we made up our data earlier, some of the new data exceeded our maximum value in our original data? As a means of demonstration, here’s what happens when our second line of data has values higher than the first lines;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/twolines03.png" alt="Two lines but the domain's not right">
  <figcaption>Two lines but the domain’s not right</figcaption>
</figure>


<p>Ahh…. We’re not too clever now.</p>

<p>Good news though, we can fix it!</p>

<p>The problem comes about because when we set the domain for the y axis this is what we put in the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code><code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;})]);</code>
</pre></div>

</figure>

<p>So that only considers d.close when establishing the domain. With <code>d.open</code> exceeding our domain, it just keeps drawing off the graph!</p>

<p>The good news is that ‘Bill’ has provided a solution for just this problem <a href="http://stackoverflow.com/questions/12732487/d3-js-dataset-array-w-multiple-y-axis-values">here</a>; </p>

<p>All you need to replace the <code>y.domain</code> line with is this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
    <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>It does much the same thing, but this time it returns the maximum of <code>d.close</code> and <code>d.open</code> (whichever is largest). Good work Bill. </p>

<p>If we put that code into the graph with the higher values for our second line we are now presented with this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/twolines04.png" alt="Two lines with everything fitting onto the canvas">
  <figcaption>Two lines with everything fitting onto the canvas</figcaption>
</figure>


<p>And it doesn’t matter which of the two sets of data is largest, the graph will always adjust :-)</p>

<p>You will also have noticed that our y axis has auto adjusted again to cope. Clever eh?</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-labelling-multiple-lines-on-a-graph">Labelling multiple lines on a graph</h3>

<p>Our previous example of a graph with multiple lines is a thing of rare beauty, but which line relates to which set of data? We have data that defines values for <code>open</code> and <code>close</code>, but we don’t know which line is which.</p>

<p>In this section we will add labels to our lines so that we know what it what.</p>

<p>This section was inspired by a question from a reader (Arun b.s) of the <a href="http://www.d3noob.org/2013/01/adding-more-than-one-line-to-graph-in.html">d3noob.org</a> blog where the question was asked “How can we put text at the end of each line on the graph?”. </p>

<p>The question was so good I realised that it had to be part of the book, so here you go :-).</p>

<p>It’s actually not too difficult. What we are trying to achieve is to find the position of the end of each line and to add a text label at that position so that the association of proximity denotes the linkage. Of course we’re going to go a little further and colour the text so that it’s really clear which label belongs with which line, but you get the idea.</p>

<p>Each line requires a single block of script to add the text. The block that adds the <code>open</code> label is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code><code class="o">+</code><code class="p">(</code><code class="nx">width</code><code class="o">+</code><code class="mi">3</code><code class="p">)</code><code class="o">+</code><code class="s2">","</code><code class="o">+</code><code class="nx">y</code><code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">open</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Open"</code><code class="p">);</code>
</pre></div>

</figure>

<p>So firstly it appends a textual element to the svg object;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Then it finds the position of the end of the line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code><code class="o">+</code><code class="p">(</code><code class="nx">width</code><code class="o">+</code><code class="mi">3</code><code class="p">)</code><code class="o">+</code><code class="s2">","</code><code class="o">+</code><code class="nx">y</code><code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">open</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">)</code>
</pre></div>

</figure>

<p>To do this we use the <code>transform</code> and <code>translate</code> attribute and find the x position that equates to the end of the graph plus 3 pixels (<code>(width+3)</code>) (we add in the three pixels to create a small separation between the end of the line and the label). The <code>y</code> position is far more interesting. We need to find the position of the last point in our line for the <code>open</code> data. Because the data is in the form of an indexed array and because the data has the latest date at the start of the array, we only need to find the point at the <code>0</code> position of the array. This is <code>data[0].open</code>. But of course, we also need to adjust our data for our scale and range, so we transform it using the <code>y</code> function (in the same way that we do it for the <code>valueline</code> and <code>valueline2</code> points. So the script to find the point on the screen in the y direction is <code>y(data[0].open)</code>.</p>

<p>If our data was arranged with the last date at the end of our data we would have to find the final index point and we would use <code>y(data[data.length-1].open))</code>.</p>

<p>Then it’s just a matter of aligning and justifying our text correctly;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Then colouring it the correct colour;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
</pre></div>

</figure>

<p>And adding out text;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Open"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We put this block of code after the blocks that add in the axes so that they make sure they’re on top of anything else we draw.</p>

<p>The only other small change we want to make is to change the right margin for the graph that we set at the start of our script from 20 to 40 so that there is enough room to add our label without cutting it off.</p>

<p>After that you have a marvellously labelled multi-line graph!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/multiline-01.png" alt="Multi-line graph with labels">
  <figcaption>Multi-line graph with labels</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8603837">github</a> or in the code samples bundled with this book (dual-line-graph-with-labels.html and data2.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/8603837">bl.ocks.org</a>. </p>

<p>Now, I’d like to pretend that this is perfection, but it isn’t. If our lines end too close together, the labels will interfere with each other, so in the ideal world I would include a bit of fanciness to prevent that, but for the purposes of this exercise we can consider ourselves happy.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-multiple-axes-for-a-graph">Multiple axes for a graph</h3>

<p>Alrighty… Let’s imagine that we want to show our wonderful graph with two lines, much like we already have, but that the data that the lines are made from is significantly different in magnitude from the original data (in the example below, the data for the second line has been reduced by approximately a factor of 10 from our original data).</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,open
1-May-12,58.13,3.41
30-Apr-12,53.98,4.55
27-Apr-12,67.00,6.78
26-Apr-12,89.70,7.85
25-Apr-12,99.00,8.92
24-Apr-12,130.28,9.92
23-Apr-12,166.70,10.13
20-Apr-12,234.98,12.23
19-Apr-12,345.44,13.45
18-Apr-12,443.34,16.04
17-Apr-12,543.70,18.03
16-Apr-12,580.13,21.02
13-Apr-12,605.23,22.34
12-Apr-12,622.77,20.15
11-Apr-12,626.20,21.26
10-Apr-12,628.44,31.04
9-Apr-12,636.23,35.04
5-Apr-12,633.68,41.02
4-Apr-12,624.31,43.05
3-Apr-12,629.32,46.03
2-Apr-12,618.63,51.03
30-Mar-12,599.55,53.42
29-Mar-12,609.86,57.82
28-Mar-12,617.62,59.01
27-Mar-12,614.48,56.03
26-Mar-12,606.98,58.01
</pre></div>

</figure>

<p>Now this isn’t a problem in itself. D3 will still make a reasonable graph of the data, but because of the difference in range, the detail of the second line will be lost.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/multiaxes01.png" alt="One line is dominating the other">
  <figcaption>One line is dominating the other</figcaption>
</figure>


<p>What I’m proposing is that we have a second y axis on the right hand side of the graph that relates to the red line.</p>

<p>The mechanism used is based on the great examples put forward by Ben Christensen <a href="http://benjchristensen.com/2012/05/02/line-graphs-using-d3-js/">here</a>.</p>

<aside class="information blurb">
    <p>Now… You’ll need to concentrate a bit since there are quite a few different bits to change and adapt, but don’t despair, they’re all quite logical and make sense.</p>

</aside>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/e34791a32a54e015f57d">github</a> or in the code samples bundled with this book (dual-line-dual-axes.html and data2a.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/e34791a32a54e015f57d">bl.ocks.org</a>. </p>

<p>First things first, there won’t be space on the right hand side of our graph to show the extra axis, so we should make our right hand margin a little larger. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>I went for 40 and it seems to fit pretty well.</p>

<p>Then (and here’s where the main point of difference for this graph comes in) you want to amend the code to separate out the two scales for the two lines in the graph. This is actually a lot easier than it sounds, since it consists mainly of finding anywhere that mentions <code>y</code> and replacing it with <code>y0</code> and then adding in a reciprocal piece of code for <code>y1</code>.</p>

<aside class="tip blurb">
    <p>The idea here is that we will be creating two references for the y axis. One for each column of data. Then when we draw the lines the scales will automatically scale the data correctly (and separately) to our canvas and we will draw two different y axes with the different scales. Believe it or not, it’s sounds a lot harder than it is.</p>

</aside>

<p>Let’s get started. </p>

<p>Firstly, change the variable declaration for <code>y</code> to <code>y0</code> and add in <code>y1</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y0</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y1</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>Then change our <code>yAxis</code> declaration to be specific for <code>y0</code> and specifically <code>left</code>. And add in a declaration for the right hand axis;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">yAxisLeft</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y0</code><code class="p">)</code>    <code class="c1">//  &lt;==  Add in 'Left' and 'y0'</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxisRight</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y1</code><code class="p">)</code>   <code class="c1">// new declaration for 'Right', 'y\</code>
<code class="mi">1</code><code class="err">'</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"right"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>             <code class="c1">// and includes orientation .</code>
</pre></div>

</figure>

<p>Note the orientation change for the right hand axis.</p>

<p>Now change our valueline declarations so that they refer to the <code>y0</code> and <code>y1</code> scales.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y0</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>    <code class="c1">// &lt;== y0</code>
<code class="kd">var</code> <code class="nx">valueline2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y1</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">});</code>     <code class="c1">// &lt;== y1</code>
</pre></div>

</figure>

<p>There are a few different ways for the scaling to work, but we’ll stick with the fancy max method we used in the dual line example (although technically it’s not required).</p>

<figure class="code">
<div class="highlight"><pre><code></code>   <code class="nx">y0</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">})]);</code> 
   <code class="nx">y1</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">})]);</code> 
</pre></div>

</figure>

<p>Again, here’s the <code>y0</code> and <code>y1</code> changed and added and the maximums for <code>d.close</code> and <code>d.open</code> are separated out).
The final piece of the puzzle is to draw the new axis, but we also want to make a slight change to the original y axis. Since we have two lines and two axes, we need to know which belongs to which, so we can colour code the text in the axes to match the lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxisLeft</code><code class="p">);</code>	

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>				
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">width</code> <code class="o">+</code> <code class="s2">" ,0)"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>		
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxisRight</code><code class="p">);</code>	
</pre></div>

</figure>

<p>In the above code you can see where we have added in a ‘style’ change for the yAxisLeft to make it ‘steelblue’ and a complementary change in the new section for yAxisRight to make that text red.</p>

<p>The yAxisRight section obviously needs to be added in, but the only significant difference is the transform / translate attribute that moves the axis to the right hand side of the graph.</p>

<p>And after all that, here’s the result…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/multiaxes02.png" alt="Two lines with full range of the domain and two axes">
  <figcaption>Two lines with full range of the domain and two axes</figcaption>
</figure>


<p>Now, let’s not kid ourselves that it’s a thing of beauty, but we should console our aesthetic concerns with the warm glow of understanding how the function works :-).</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-how-to-rotate-the-text-labels-for-the-x-axis">How to rotate the text labels for the x Axis.</h3>

<p>The observant reader will recall the problem we had observed earlier when increasing the number of ticks on our x axis to 10. The effect had been to produce a large number of x axis ticks (actually 19) but they had run together and become unreadable.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/rotate01.png" alt="x axis labels crammed together">
  <figcaption>x axis labels crammed together</figcaption>
</figure>


<p>We postulated at the time that an answer to the problem might be to rotate the text to provide more space. Well, it’s about time we solved that problem.</p>

<p>The answer I found most usable was provided by Aaron Ward on <a href="https://groups.google.com/forum/#!msg/d3-js/CRlW0ISbOy4/1sgrE5uS5ysJ">Google Groups</a>.</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-there-might-be-a-better-way">There might be a better way</h3>
  <p>Now, I’ll put a bit of a caveat on this solution to the rotating axis label problem. It looks like it’s worked well, but I’ve only carried out this investigation to the point where I’ve got something that looks like it’s a solution. There may be better or more elegant ways of carrying out the same task, so  let Google be your friend if it doesn’t appear to be working out for you.</p>

</aside>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/ccdcb7673cdb3a796e13">github</a> or in the code samples bundled with this book (simple-graph-rotated-axis-text.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/ccdcb7673cdb3a796e13">bl.ocks.org</a>. The example code also includes the formatting of the x axis ticks in a specific format as described in the next section.</p>

<p>Starting out with our simple graph example, we should increase the number of ticks on the x axis to 10 to highlight the problem in the previous image.</p>

<p>The first substantive change would be a little housekeeping. Because we are going to be rotating the text at the bottom of the graph, we are going to need some extra space to fit in our labels. So we should change our bottom margin appropriately.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">50</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>	
</pre></div>

</figure>

<p>I found that 50 pixels was sufficient.</p>

<p>The remainder of our changes occur in the block that draws the x axis.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>	
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"-.8em"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".15em"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-65)"</code><code class="p">);</code>	
</pre></div>

</figure>

<p>It’s pretty standard until the <code>.call(xAxis)</code> portion of the code. Here we remove the semicolon that was there so that the block continues with its function. </p>

<p>Then we select all the text elements that comprise the x axis with the <code>.selectAll("text")</code>. From this point onwards, we are operating on the text elements associated with the x axis. In effect; the following 4 ‘actions’ are applied to the text labels.</p>

<p>The <code>.style("text-anchor", "end")</code> line ensures that the text label has the end of the label ‘attached’ to the axis tick. This has the effect of making sure that the text rotates about the end of the date. This makes sure that the text all ends up at a uniform distance from the axis ticks.</p>

<p>The <code>dx</code> and <code>dy</code> attribute lines move the end of the text just far enough away from the axis tick so that they don’t crowd it and not too far away so that it appears disassociated. This took a little bit of fiddling to ‘look’ right and you will notice that I’ve used the ‘em’ units to get an adjustment if the size of the font differs.</p>

<p>The final action is kind of the money shot.</p>

<p>The transform attribute applies itself to each text label and rotates each line by -65 degrees. I selected -65 degrees just because it looked OK. There was no deeper reason. </p>

<p>The end result then looks like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/rotate02.png" alt="Rotated x axis labels">
  <figcaption>Rotated x axis labels</figcaption>
</figure>


<p>This was a surprisingly difficult problem to find a solution to that I could easily understand (well done Aaron). That makes me think that there are some far deeper mysteries to it that I don’t fully appreciate that could trip this solution up. But in lieu of that, enjoy!</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-format-a-date--time-axis-with-specified-values">Format a date / time axis with specified values</h3>

<p>OK then. We’ve been very clever in rotating our text, but you will notice that D3 has used it’s own good judgement as to what format the days / date will be represented as.</p>

<p>Not that there’s anything wrong with it, but what if we want to put a specific format of date / time nomenclature as axis labels?</p>

<p>No problem. D3 has your back.</p>

<p>This is actually a pretty easy thing to do, but there are plenty of options for the formatting, so the only really tricky part is deciding what to put where.</p>

<p>But, before we start doing anything we are going to have to expand our bottom margin even more than we did with the rotate the axis labels feature.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">70</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>That should see us right.</p>

<p>Right, now the simple part :-). Changing the format of the label is as simple as inserting the <code>tickFormat</code> command into the xAxis declaration a little like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m-%d"</code><code class="p">));</code> <code class="c1">// insert the tickFormat function</code>
</pre></div>

</figure>

<p>An example using this code can be found on <a href="https://gist.github.com/d3noob/ccdcb7673cdb3a796e13">github</a> or in the code samples bundled with this book (simple-graph-rotated-axis-text.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/ccdcb7673cdb3a796e13">bl.ocks.org</a>. The example code also includes the rotating of the x axis text as described in the previous section.</p>

<p>What the tickFormat allows is the setting of formatting for the tick labels. The <code>d3.time.format</code> portion of the code is specifying the exact format of those ticks. This formatting is described using the same arguments that were explained in the earlier section on <a href="https://github.com/mbostock/d3/wiki/Time-Formatting">formatting date time values</a>. That means that the examples we see here (<code>%Y-%m-%d</code>) should display the year as a four digit number then a hyphen then the month as a two digit number, then another hyphen, then a two digit number corresponding to the day.</p>

<p>Let’s take a look at the result;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/format01.png" alt="Format change for the x axis labels">
  <figcaption>Format change for the x axis labels</figcaption>
</figure>


<p>There we go! You should be able to see this file in the downloads section on d3noob.org with the general examples as formatted-date-time-axis-labels.html.</p>

<p>So how about we try something a little out of the ordinary (extreme)?</p>

<p>How about the full weekday name (<code>%A</code>), the day (<code>%d</code>), the full month name (<code>%B</code>) and the year (<code>%Y</code>) as a four digit number?</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%A %d %B %Y"</code><code class="p">));</code>
</pre></div>

</figure>

<p>We will also need some extra space for the bottom margin, so how about 140?</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">140</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>and….</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/format02.png" alt="Extreme format change for the x axis labels">
  <figcaption>Extreme format change for the x axis labels</figcaption>
</figure>


<p>Oh yeah… When axis ticks go bad…</p>

<p>But seriously, that does work as a pretty good example of the flexibility available. </p>

<div class="page-break"></div>
<h3 id="leanpub-auto-update-data-dynamically---on-click">Update data dynamically - On Click</h3>

<p>OK, you’re going to enjoy this section. Mainly because it takes the traditional graph that we know, love and have been familiar with since childhood and adds in an aspect that that has been missing for most of your life.</p>

<p><strong>Animation!</strong></p>

<p>Graphs are cool. Seeing information represented in a graphical way allows leaps of understanding that are difficult or impossible to achieve from raw data. But in this crazy ever-changing world, a static image is only as effective as the last update. The ability to being able to have the most recent data represented in your graph and to have it occur automatically provides a new dimension to traditional visualizations. </p>

<aside class="information blurb">
    <p>Interestingly enough, part of the reason for moving from D3’s predecessor <a href="http://mbostock.github.com/d3/tutorial/protovis.html">Protovis</a> was the ability to provide greater control and scope to animating data.</p>

</aside>

<p>So what are we going to do?</p>

<p>First we’ll spend a bit of time setting the scene. We’ll add a button to our basic graph file so that we can control when our animation occurs, we’ll generate a new data set so that we can see how the data changes easily, then we’ll shuffle the code about a bit to make it do its magic. While we’re shuffling the code we’ll take a little bit of time to explain what’s going on with various parts of it that are different to what we might have seen thus far. Then we’ll change the graph to update automatically (on a schedule) when the data changes.</p>

<aside class="information blurb">
    <p>One of the problems with writing a manual about a moving object is that it’s difficult to represent that movement on a written page, so where there is something animated occurring, I will provide all the code that I’m using so that you can try it at home and have an online version as well.</p>

</aside>

<p>The code for this example can be found on <a href="https://gist.github.com/d3noob/7030f35b72de721622b8">github</a> or in the code samples bundled with this book (data-load-button.html, data.csv and data-alt.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/7030f35b72de721622b8">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-adding-a-button">Adding a Button</h4>

<p>It’s all well and good animating your data, but if you don’t know when it’s supposed to happen or what should happen, it’s a little difficult to evaluate how successful you’ve been. </p>

<p>To make life easy, we’re going to take some of the mystery out of the equation (don’t worry, we’ll put it back later) and add a button to our graph that will give you control over when your graph should update it’s data. When complete it should look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/button01.png" alt="A graph with a button!">
  <figcaption>A graph with a button!</figcaption>
</figure>


<p>To add a button, we will take our simple-graph.html example and just after the <code>&lt;body&gt;</code> tag we add the following code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"option"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"updateButton"</code> 
           <code class="na">type</code><code class="o">=</code><code class="s">"button"</code> 
           <code class="na">value</code><code class="o">=</code><code class="s">"Update"</code> 
           <code class="na">onclick</code><code class="o">=</code><code class="s">"updateData()"</code> 
    <code class="p">/&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The HTML <code>&lt;div&gt;</code> element (or HTML Document Division Element) is used to assign a division or section in an HTML document. We use it here as it’s good practice to keep sections of your HTML document distinct so that it’s easier to perform operations them at a later date.</p>

<p>In this case we have given the div the identifier “option” so that we can refer to it later if we need to (embarrassingly, we won’t be referring to it at all, but it’s good practice none the less).</p>

<p>The following line adds our button using the HTML <code>&lt;input&gt;</code> tag. The <code>&lt;input&gt;</code> tag has a wide range of attributes (options) for allowing user input. Check out the links to <a href="http://www.w3schools.com/tags/tag_input.asp">w3schools</a> and <a href="https://developer.mozilla.org/en-US/docs/HTML/Element/Input">Mozilla</a> for a whole lot of reading. </p>

<p>In our <code>&lt;input&gt;</code> line we have four different attributes;</p>

<ul>
  <li>name</li>
  <li>type</li>
  <li>value</li>
  <li>onclick</li>
</ul>

<p>Each of these attributes modifies the <code>&lt;input&gt;</code> function in some way so that our button does what we want it to do.</p>

<p><strong>name:</strong><br>
This is the name of the control (in this case a button) so that we can reference it in other parts of our HTML script.</p>

<p><strong>type:</strong><br>
Probably the most important attribute for a button, this declares that our type of input will be a button! There are <em>heaps</em> of other options for <code>type</code> which would form a significant section in itself.</p>

<p><strong>value:</strong><br>
For a <code>button</code> input type, this is the starting value for our button and forms the label that our button will have.</p>

<p><strong>onclick:</strong><br>
This is not an attribute that is specific to the <code>&lt;input&gt;</code> function, but it allows the browser to capture a mouse clicking event when it occurs and in our case we tell it to run the <code>updateData()</code> function (which we’ll be seeing more of soon).</p>

<h4 id="leanpub-auto-updating-the-data">Updating the data</h4>

<p>To make our first start at demonstrating changing the data, we’ll add another data file to our collection. We’ll name it <code>data-alt.csv</code> (you can find it in the sample code collection that can be downloaded with the book on Leanpub). This file changes our normal data (only the values, not the structure) just enough to see a movement of the time period of the graph and the range of values on the y axis (this will become really obvious in the transition). </p>

<aside class="information blurb">
    <h3 id="leanpub-auto-temporary-measure-only">Temporary measure only</h3>
  <p>We’ll only use this file while we want to demonstrate that dynamic updating really does work. Ultimately we will just use the one file and rely on an external process updating that file to provide the changing data.</p>

</aside>

<h4 id="leanpub-auto-changes-to-the-d3js-code-layout">Changes to the d3.js code layout</h4>
<p>While going through the process of working out how to do this, the iterations of my code were mostly horrifying to behold. However, I think my understanding has improved sufficiently to allow only a slight amendment to our simple-graph.html JavaScript code to get this going.</p>

<p>What we should do is add the following block of code to our script towards the end of the file just before the <code>&lt;/script&gt;</code> tag;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">updateData</code><code class="p">()</code> <code class="p">{</code>

    <code class="c1">// Get the data again</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data-alt.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
       	<code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
	    	<code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
	    	<code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
	    <code class="p">});</code>

    	<code class="c1">// Scale the range of the data again </code>
    	<code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
            <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="c1">// Select the section we want to apply our changes to</code>
    <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">transition</code><code class="p">();</code>

    <code class="c1">// Make the changes</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".line"</code><code class="p">)</code>   <code class="c1">// change the line</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".x.axis"</code><code class="p">)</code> <code class="c1">// change the x axis</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".y.axis"</code><code class="p">)</code> <code class="c1">// change the y axis</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

    <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-whats-happening-in-the-code">What’s happening in the code?</h4>

<p>There are several new concepts and techniques in this block of code for us to go through but we’ll start with the overall wrapper for the block which is a function call.</p>

<p>The entirety of our JavaScript code that we’re adding is a function called <code>updateData</code>. This is the subject of the first line in the code above (and the last closing curly bracket). It is called from the only other piece of code we’ve added to the file which is the button in the HTML section. So when that button is clicked, the <code>updateData</code> function is carried out.</p>

<aside class="tip blurb">
    <h3 id="leanpub-auto-repeatability">Repeatability</h3>
  <p>It’s worth noting that while our <code>updateData</code> function only appears to work the once when you first click the button, in fact every time the button is pushed the <code>updateData</code> function is carried out. It’s just that since the data doesn’t change after the first click, you never see any change.</p>

</aside>

<p>Then we get our new data with the block that starts with <code>d3.csv("data-alt.csv"</code>. This is a replica of the block in the main part of the code with one glaring exception. It is getting the data from our new file called <code>data-alt.csv</code>. However, one thing it’s doing that bears explanation is that it’s loading data into an array that we’ve already used to generate our line. At a point not too far from here (probably the next page) we’re going to replace the data that made up our line on the page with the new data that’s just been loaded.</p>

<p>We then set the scale and the range again using the <code>x.domain</code> and <code>y.domain</code> lines. We do this because it’s more than possible that our data has exceeded or shrunk with respect to our original domains so we recalculate them using our new data. The consequence of not doing this would be a graph that could exceed it’s available space or be cramped up.</p>

<p>Then we assign the variable svg to be our selection of the <code>"body"</code> div (which means the following actions will only be carried out on objects within the <code>"body"</code> div.</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-selection-study">Selection Study.</h3>
  <p>Selections are a very important topic and if reading Google Groups and Stack Overflow are anything to go by they are also a much misunderstood feature of D3. I won’t claim to be in any better position to describe them, but I would direct readers to a description of nested selections by Mike Bostock (http://bost.ocks.org/mike/nest/) and a video tutorial by Ian Johnson (http://blog.visual.ly/using-selections-in-d3-to-make-data-driven-visualizations/).</p>

</aside>

<p>The other part of that line is the transition command (<code>.transition()</code>). This command goes to the heart of animating dynamic data and visualizations and is a real treasure.</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-transition-training">Transition Training</h3>
  <p>I will just be brushing the surface of the subject of transitions in d3.js, and I will certainly not do the topic the justice it deserves for in depth animations. I heartily recommend that you take an opportunity to read Mike Bostock’s “Path Transitions” (http://bost.ocks.org/mike/path/), bar chart tutorial (http://mbostock.github.com/d3/tutorial/bar-2.html) and Jerome Cukier’s “Creating Animations and Transitions with D3” (http://blog.visual.ly/creating-animations-and-transitions-with-d3-js/). Of course, one of the main resources for information on transitions is also the D3 wiki (https://github.com/mbostock/d3/wiki/Transitions).</p>

</aside>

<p>As the name suggests, a transition is a method for moving from one state to another. In its simplest form for a d3.js visualisation, it could mean moving an object from one place to another, or changing an object’s properties such as opacity or colour. In our case, we will take our data which is in the form of a line, and change some of that data. And when we change the data we will get d3 to manage the change via a transition. At the same time (because we’re immensely clever) we will also  make sure we change the axes if they need it.</p>

<p>So in short, we’re going to change this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/button01.png" alt="The initial set of data">
  <figcaption>The initial set of data</figcaption>
</figure>


<p>… into this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/button02.png" alt="'Updated' data">
  <figcaption>‘Updated’ data</figcaption>
</figure>


<p>Obviously the line values have changed, and both axes have changed as well. And using a properly managed transition, it will all occur in a smooth ballet :-).</p>

<p>So, looking at the short block that manages the line transition;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".line"</code><code class="p">)</code>   <code class="c1">// change the line</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>We select the <code>".line"</code> object and since we’ve already told the script that <code>svg</code> is all about the transition (<code>var svg = d3.select("body").transition();</code>)  the attributes that follow specify how the transition for the line will proceed. In this case, the code describes the length of time that the transition will take as 750 milliseconds (<code>.duration(750)</code>) and uses the new data as transcribed by the <code>valueline</code> variable from the original part of the script (<code>.attr("d", valueline(data));</code>).</p>

<p>The same is true for both of the subsequent portions of the code that change the x and y axes. We’ve set both to a transition time of 750 milliseconds, although feel free to change those values (make each one different for an interesting effect).</p>

<p>Other attributes for the transition that we could have introduced would be a delay (<code>.delay(500)</code>, perhaps to stagger the movements) and more interestingly an easing attribute (<code>.ease(type[, arguments…])</code>) which will have the effect of changing how the movement of a transition appears (kind of like a fast-slow-fast vs linear, but with lots of variations).</p>

<p>But for us we’ll survive with the defaults.</p>

<p>In theory, you’ve added in your new data file (<code>data-alt.csv</code>) and made the two changes to the simple graph file (the HTML block for the button and the JavaScript one for the <code>updateData</code> function). The result has been a new beginning in your wonderful d3 journey!</p>

<aside class="exercise blurb">
    <h3 id="leanpub-auto-revert-the-data">Revert the data</h3>
  <p>If you fancy a quick test, consider what you would need to do to add another button that was labelled ‘Revert’ which, when pressed changed the graph back to the original data (so that you could merrily press ‘Update’ and ‘Revert’ all day if you wanted).<br>
I have loaded a simplistic version of the graph that will do this as an example can be found on <a href="https://gist.github.com/d3noob/a048edddbf83bff03a34">github</a> or in the code samples bundled with this book (data-load-revert-button.html, data.csv and data-alt.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/a048edddbf83bff03a34">bl.ocks.org</a>.. There are more elegant ways to code this, but the example I give is pretty easy to follow.</p>

</aside>

<div class="page-break"></div>
<h3 id="leanpub-auto-update-data-dynamically--automatically">Update data dynamically – Automatically</h3>

<p>I have no doubt that the excitement of updating your data and graph with the magic of buttons is quite a thrill. But believe it or not, there’s more to come.</p>

<p>In the example we’re going to demonstrate now, there are no buttons to click, the graph will simply update itself when the data changes.</p>

<p>I know, I know. It’s like magic!</p>

<p>So the sort of usage scenario that you would be putting this to is when you had a dashboard type display or a separate window just for the purposes of showing a changing value like a stock ticker or number of widgets sold (where the number was changing frequently).</p>

<p>So, how to create the magic?</p>

<p>Starting with the data-load-button.html file, firstly we should remove the button, so go ahead and delete the button block that we had in the HTML section (the bit that looked like this…).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"option"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"updateButton"</code> 
                 <code class="na">type</code><code class="o">=</code><code class="s">"button"</code> 
                <code class="na">value</code><code class="o">=</code><code class="s">"Update"</code> 
                <code class="na">onclick</code><code class="o">=</code><code class="s">"updateData()"</code> <code class="p">/&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Now, we have two references in our JavaScript where we load our data. One loads <code>data.csv</code> initially, then when the button was pushed, we loaded <code>data-alt.csv</code>. We’re going to retain that arrangement for the moment, because we want to make sure we can see something happening, but ultimately, we would just have them referencing a single file.</p>

<p>So, the magic piece of script that will do your updating is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">inter</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="nx">updateData</code><code class="p">();</code>
        <code class="p">},</code> <code class="mi">5000</code><code class="p">);</code> 
</pre></div>

</figure>

<p>And we should put that just above the <code>function updateData() {</code> line in our code.</p>

<p>The key to this piece of code is the <code>setInterval</code> function which will execute specified code (in this case it’s <code>updateData();</code> which will go and read in our new information) over and over again at a set interval (in this case 5000 milliseconds (<code>}, 5000);</code>)).</p>

<p>I honestly wish it was harder, but sadly it’s that simple. You now have in your possession the ability to make your visualizations do <em>stuff</em> on a regular basis, all by themselves!</p>

<p>There is a copy of this sample code and the data files at <a href="https://gist.github.com/d3noob/6bd13f974d6516f3e491">github</a> and in the code samples bundled with this book (data-load-automatic.html, data.csv and data-alt.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/6bd13f974d6516f3e491">bl.ocks.org</a>.</p>

<p>How to test?</p>

<p>Well, just load up your new file in a browsers. After an interval of 5 seconds, you should see the graph change all by itself. How cool is that?</p>

<p>You know it gets better though…</p>

<p>If you open your data-alt.csv file and change a value (increase one of the <code>close</code> values by a factor of 10 or something equally noticeable). Then save the file. Keep an eye on your graph. Before 5 seconds is up it should have changed to reflect your new data.</p>

<aside class="information blurb">
    <p>There is a possibility that your browser may have decided to cache the data from the data-alt.csv file, in which case you can tell it to stop that nonsense by going into the settings and clearing the cache.</p>

</aside>

<h2 id="leanpub-auto-elements-attributes-and-styles">Elements, Attributes and Styles</h2>

<p>This chapter is intended to provide an overview of some of the simpler things that d3.js can do, but in a way that may help some understand a little more about how images can be added to a web page and how they can be manipulated.</p>

<p>Loosely speaking we will look at how objects (elements (like circles, rectangles, lines and even text) can be declared and added to a page, how their attributes in relation to the page (position, size, shape, actions) can be changed and how their style (colour, width, transparency) can be applied.</p>

<p>As we go through the explanation of different changes that can be applied to different elements there will be a small amount of repetition where there is cross-over with related drawing features. Please be patient :-). The aim is to have each section as complete in its own right as practical. </p>

<h3 id="EASframework">The Framework</h3>

<p>To be able to demonstrate how these three related aspects of drawing objects work we will have to use a small, simple script to draw them in your web browser.</p>

<p>We will just take a moment to explain the script that draws a circle.</p>

<p>Here’s the contents of the file in it’s entirety. I have imaginatively called it <code>circle.html</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// select the 'body' element</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>           <code class="c1">// append an SVG element to the body</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">449</code><code class="p">)</code>      <code class="c1">// make the SVG element 449 pixels wide</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">249</code><code class="p">);</code>    <code class="c1">// make the SVG element 249 pixels high</code>

<code class="c1">// draw a circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Please feel free to jump ahead slightly if you understand how a HTML file with JavaScript goes together :-).</p>

<p>The HTML part of the file can be thought of as a wrapper for the JavaScript that will draw our circle. These are the HTML parts here…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
 
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This portion of the file is built using HTML ‘tags’. These will set up the environment for the Javascript.</p>

<p>The tags tell the web browser what sort of language is being used and the type of characters used to write the code…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Areas of the code are labelled. </p>

<p>Like the body…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

In this area we can put the stuff that will be 
displayed on our web page.

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>And the place where we put the JavaScript…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="nx">Our</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">js</code> <code class="nx">code</code> <code class="nx">will</code> <code class="nx">go</code> <code class="nx">here</code><code class="p">.</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We even load an external file that contains JavaScript that will help run our code.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Yes, that’s the line that loads d3.js. Once it’s loaded we can use the instructions that it makes available to make other JavaScript code (in this case ours) work.</p>

<p>Then we have the JavaScript code that allows us to <em>use</em> the functions made possible by d3.js.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// select the 'body' element</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>           <code class="c1">// append an SVG element to the body</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">449</code><code class="p">)</code>      <code class="c1">// make the SVG element 449 pixels wide</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">249</code><code class="p">);</code>    <code class="c1">// make the SVG element 249 pixels high</code>

<code class="c1">// draw a circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>I’ve broken the code into two separate portions to provide some clarity to their function. We could make it one block, but that wouldn’t necessarily make it easier to understand.</p>

<p>Firstly we add a ‘holder’ for our graphics on the web page. I’ve named it <code>holder</code> but we could just as easily named it anything we wanted.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// select the 'body' element</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>           <code class="c1">// append an SVG element to the body</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">449</code><code class="p">)</code>      <code class="c1">// make the SVG element 449 pixels wide</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">249</code><code class="p">);</code>    <code class="c1">// make the SVG element 249 pixels high</code>
</pre></div>

</figure>

<p>The first thing we do when declaring our holder is to select the <code>body</code> element of our web page (Remember those <code>&lt;body&gt;</code> tags in the HTML part earlier?).</p>

<p>Then we append a Scalable Vector Graphic (SVG) object to the body and we make it 449 pixels wide and 249 pixels high. </p>

<p>The <code>width</code> and <code>height</code> are ‘attributes’ of the SVG object. That is to say they describe a property of the object.</p>

<aside class="information blurb">
    <p>Believe it or not, I have made the container size unusual (not nice round numbers like 450 x 250) for a good reason. Later I will introduce a grid to our diagram so we can see where everything is laid out and this size makes the grid look better.</p>

</aside>

<p>The second block of our JavaScript finally draws our circle.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>The first line appends a new element (a circle) to our SVG ‘holder’.</p>

<aside class="information blurb">
    <p>If you like, you can think of having the <code>holder</code> declaration in front of the <code>.append("circle")</code> as being a nice short-hand way of writing the code. We could have had a much longer line that selected the <code>body</code>, appended the svg element and then appended our circle in one line, but it’s actually a far better scheme for building multiple objects to break the sequences up which will allow us to manipulate groupings of objects in future code.</p>

</aside>

<p>The second and third lines declare the attribute of our circle that specify where the centre of the circle is. In this case it’s at the x/y position 200/100 (<code>cx</code>/<code>cy</code>).</p>

<p>The last line adds the radius attribute <code>r</code>. Here it is set to 50 pixels.</p>

<p>The three attributes <code>cx</code>, <code>cy</code> and <code>r</code> are all required when drawing a circle. There are other attributes we can put in there (and when we look at some of the upcoming elements, you should get a feel for them), but these are the minimum.</p>

<p>The purpose of describing this block of code that draws a circle isn’t to show you how to draw a circle. This has only been a way of showing you how the code in the following sections is laid out and how it works. The elements we are going to generate can be drawn with exactly the same file but with just the section that adds the circle altered.  </p>

<p>For example if you were to change this block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>For this block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>          <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>            <code class="c1">// x position of the top-left corner</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// y position of the top-left corner</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>        <code class="c1">// set the rectangle width</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>      <code class="c1">// set the rectangle height</code>
</pre></div>

</figure>

<p>Instead of drawing a circle we would be drawing a rectangle.</p>

<p>So this is what our circle will look like;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-01.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>Because it will help a great deal to have a common frame of reference, I’m going to display the elements on a grid that looks a little like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-02.png" alt="Circle with Grid">
  <figcaption>Circle with Grid</figcaption>
</figure>


<aside class="information blurb">
    <p>The grid won’t form part of the code that gets explained, but I will take the time out to describe how it’s generated in another section, because it’s quite cool in its own way :-).</p>

</aside>

<p>With the grid in place it’s far easier to see that the centre of our circle is indeed at the coordinates x = 200, y = 100 and that the radius is 50.</p>

<p>The circle is still somewhat plain, but bear with me because as we start to explore what we can do with styles and attributes we can add some variation to our elements.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-03.png" alt="Fancier Circle">
  <figcaption>Fancier Circle</figcaption>
</figure>


<p>With that explanation behind us we should begin our odyssey into the world of d3 elements.</p>

<h3 id="leanpub-auto-elements">Elements</h3>

<p>We will begin by describing what we mean when we talk about an ‘element’.</p>

<p>There is considerable scope for confusion when talking about elements on a web page. Are we talking about <a href="http://reference.sitepoint.com/html/page-structure">HTML elements</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element">SVG elements</a> or something different?</p>

<p>In fact we are going to be describing a subset of SVG elements. Specifically those that are described in the <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#svg-elements">d3.js API reference</a> (since that’s why we’re here right?). These are a collection of common shapes and objects which include circles,
ellipses, rectangles, lines, polylines, polygons, text and paths.</p>

<p>“Text?” I hear you say. “Doesn’t sound like a shape.” I suppose it depends on how you think of it. We can use text in different ways in d3, but for this particular exercise we <em>can</em> regard text as an SVG element.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-circle">Circle</h4>

<p>A <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_circle">circle is a simple SVG shape</a> that is described by three required attributes. </p>

<ul>
  <li>
<code>cx</code>: The position of the centre of the circle in the x direction (left / right) measured from the left side of the screen.</li>
  <li>
<code>cy</code>: The position of the centre of the circle in the y direction (up / down) measured from the top of the screen.</li>
  <li>
<code>r</code>: The radius of the circle from the <code>cx</code>, <code>cy</code> position to the perimeter of the circle.</li>
</ul>

<p>The following is an example of the code section required to draw a circle in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-02.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>The centre of the circle is at x = 200 and y = 100 and the radius is 50 pixels. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-ellipse">Ellipse</h4>

<p>An <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_ellipse">ellipse</a> is described by four required attributes;</p>

<ul>
  <li>
<code>cx</code>: The position of the centre of the ellipse in the x direction (left / right) measured from the left side of the screen.</li>
  <li>
<code>cy</code>: The position of the centre of the ellipse in the y direction (up / down) measured from the top of the screen.</li>
  <li>
<code>rx</code>: The radius of the ellipse in the x dimension from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
  <li>
<code>ry</code>: The radius of the ellipse in the y dimension from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
</ul>

<p>The following is an example of the code section required to draw an ellipse in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>       <code class="c1">// attach an ellipse</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set the x radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>           <code class="c1">// set the y radius</code>
</pre></div>

</figure>

<p>This will produce an ellipse as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-04.png" alt="Ellipse">
  <figcaption>Ellipse</figcaption>
</figure>


<p>The centre of the ellipse is at x = 200 and y = 100 and the radius is 50 pixels vertically and 100 pixels horizontally. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-rectangle">Rectangle</h4>

<p>A <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_rect">rectangle</a> is described by four required attributes and two optional ones;</p>

<ul>
  <li>
<code>x</code>: The position on the x axis of the left hand side of the rectangle (required).</li>
  <li>
<code>y</code>: The position on the y axis of the top of the rectangle (required).</li>
  <li>
<code>width</code>: the width (in pixels) of the rectangle (required).</li>
  <li>
<code>height</code>: the height (in pixels) of the rectangle (required).</li>
  <li>
<code>rx</code>: The radius curve of the corner of the rectangle in the x dimension (optional).</li>
  <li>
<code>ry</code>: The radius curve of the corner of the rectangle in the y dimension (optional).</li>
</ul>

<p>The following is an example of the code section required to draw a rectangle (using only the required attributes) in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a rectangle as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-05.png" alt="Rectangle">
  <figcaption>Rectangle</figcaption>
</figure>


<p>The top left corner of the rectangle is at 100, 50 and the rectangle is 200 pixels wide and 100 pixels high.</p>

<p>The following code section includes the optional attributes for the curved corners;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>     <code class="c1">// set the width</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>         <code class="c1">// set the x corner curve radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>        <code class="c1">// set the y corner curve radius</code>
</pre></div>

</figure>

<p>This will produce a rectangle (with curved corners) as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-06.png" alt="Rectangle with curved corners">
  <figcaption>Rectangle with curved corners</figcaption>
</figure>


<p>The corners are curved with radii in the x and y direction of 10 pixels.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-line">Line</h4>

<p>A <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_line">line</a> is a simple line between two points and is described by four required attributes. </p>

<ul>
  <li>
<code>x1</code>: The x position of the first end of the line as measured from the left of the screen.</li>
  <li>
<code>y1</code>: The y position of the first end of the line as measured from the top of the screen.</li>
  <li>
<code>x2</code>: The x position of the second end of the line as measured from the left of the screen.</li>
  <li>
<code>y2</code>: The y position of the second end of the line as measured from the top of the screen.</li>
</ul>

<p>The following is an example of the code section required to draw a line in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code is the <code>style</code> declaration. In this case the line has no colour and this can be added with the <code>stroke</code> style which applies a colour to a line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>          <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>This will produce a line as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-07.png" alt="Line">
  <figcaption>Line</figcaption>
</figure>


<p>The line extends from the point 100,50 to 300,150. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-polyline">Polyline</h4>

<p>A <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_polyline">polyline</a> is a sequence of connected lines described with a single attribute. The <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_polyline">d3.js wiki</a> rightly makes the point that “<em>it is typically more convenient and flexible to use the d3.svg.line path generator in conjunction with a path element</em>”. So while drawing a polyline using this method may be possible, bear in mind that depending on your application, there may be a better way.</p>

<ul>
  <li>
<code>points</code>: The <code>points</code> attribute is a list of x,y coordinates that are the locations of the connecting points of the polyline.</li>
</ul>

<p>The following is an example of the code section required to draw a polyline in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code are the <code>style</code> declarations. In this case the line of the polyline has no colour and this can be added with the <code>stroke</code> style which applies the colour black to a line. Likewise the area that is bounded by the polyline will be automatically filled with black unless we explicitly tell the object not to. This is achieved in this example by addition of the <code>fill</code> style to <code>none</code>. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polyline"</code><code class="p">)</code>      <code class="c1">// attach a polyline</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points</code>
</pre></div>

</figure>

<p>This will produce a polyline as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-08.png" alt="Polyline">
  <figcaption>Polyline</figcaption>
</figure>


<p>The polyline extends from the point 100,50 to 200,150 to 300,50. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-polygon">Polygon</h4>

<p>A <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_polygon">polygon</a> is a sequence of connected lines which form a closed shape described with a single attribute. The <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_polygon">d3.js wiki</a> rightly makes the point that “<em>it is typically more convenient and flexible to use the d3.svg.line path generator in conjunction with a path element</em>”. So while drawing a polygon using this method may be possible, bear in mind that depending on your application, there may be a better way.</p>

<ul>
  <li>
<code>points</code>: The <code>points</code> attribute is a list of x,y coordinates that are the locations of the connecting points of the polygon. The last point is in turn connected to the first point.</li>
</ul>

<p>The following is an example of the code section required to draw a polygon in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code are the <code>style</code> declarations. In this case the line of the polygon has no colour and this can be added with the <code>stroke</code> style which applies the colour black to a line. Likewise the area that is bounded by the polygon will be automatically filled with black unless we explicitly tell the object not to. This is achieved in this example by addition of the <code>fill</code> style to <code>none</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polygon"</code><code class="p">)</code>       <code class="c1">// attach a polygon</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points </code>
</pre></div>

</figure>

<p>This will produce a polygon as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-09.png" alt="Polyline">
  <figcaption>Polyline</figcaption>
</figure>


<p>The polygon extends from the point 100,50 to 200,150 to 300,50 and then back to 100,50. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-path">Path</h4>

<p>A <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_path">path</a> is an outline of an SVG shape which is described with a ‘mini-language’ inside a single attribute.</p>

<ul>
  <li>
<code>d</code>: This attribute is a list of instructions that allow a shape to be drawn in a complex way using a <a href="http://www.w3.org/TR/SVG/paths.html#PathData">‘mini-language’ of commands</a>. These commands are written in a shorthand of single letters such as <code>M</code>-moveto, <code>Z</code>-closepath, <code>L</code>-lineto, <code>C</code>-curveto. These commands can be absolute (normally designated by capital letters) or relative (lower case).</li>
</ul>

<p>The following is an example of the code section required to draw a triangle in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code are the <code>style</code> declarations. In this case the line of the path has no colour and this can be added with the <code>stroke</code> style which applies the colour black to a line. Likewise the area that is bounded by the path will be automatically filled with black unless we explicitly tell the object not to. This is achieved in this example by addition of the <code>fill</code> style to <code>none</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>          <code class="c1">// attach a path</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="s2">"M 100,50, L 200,150, L 300,50 Z"</code><code class="p">);</code>  <code class="c1">// path commands </code>
</pre></div>

</figure>

<p>This will produce a path as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-10.png" alt="Path">
  <figcaption>Path</figcaption>
</figure>


<p>The path mini-language first moves (<code>M</code>) to 100,50 then draws a line (<code>L</code>) to 200,150 then draws another line (<code>L</code>) to 300,50 then closes the path (<code>Z</code>). </p>

<div class="page-break"></div>
<h4 id="clipPath">Clipped Path (AKA clipPath)</h4>

<p>A <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/clipPath">clipPath</a> is the path of a SVG shape that can be used in combination with another shape to remove any parts of the combined shape that doesn’t fall within the clipPath. That sounds slightly confusing, so we will break it down a bit to hopefully clarify the explanation. </p>

<p>Let’s imagine that we want to display the intersection of two shapes. What we will do is define our <code>clipPath</code> which will act as a ‘cookie cutter’ which can cut out the shape we want (we will choose an ellipse). Then we will draw our base shape (which is analogous to the dough) that we will use our cookie cutter on (our dough will be shaped as a rectangle). The intersection of the cookie cutter and the dough is our clipped path.</p>

<p>Our clipPath (cookie cutter) element is an ellipse;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-44.png" alt="clipPath (cookie cutter)">
  <figcaption>clipPath (cookie cutter)</figcaption>
</figure>


<p>Our shape that we will be clipping (the dough) is a rectangle;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-45.png" alt="Rectangle element (dough)">
  <figcaption>Rectangle element (dough)</figcaption>
</figure>


<p>The intersection of the two is the clipped path (shaded grey);</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-46.png" alt="Combination of the ellipse and the rectangle">
  <figcaption>Combination of the ellipse and the rectangle</figcaption>
</figure>


<p>The graphic examples above are misleading in the sense that the two basic shapes are not actually displayed. All that results from the use of the <code>clipPath</code> is the region that is the intersection of the two.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-47.png" alt="The clipped path">
  <figcaption>The clipped path</figcaption>
</figure>


<p>The following is an example of the code section required to draw the clipped path in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. The <code>clipPath</code> element is given the <code>ID</code> ‘ellipse-clip’ and a specified size and location. Then when the rectangle is appended. the <code>clipPath</code> is specified as an attribute (via a URL) using <code>clip-path</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the clipPath</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>       <code class="c1">// define a clip path</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"ellipse-clip"</code><code class="p">)</code> <code class="c1">// give the clipPath an ID</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>            <code class="c1">// shape it as an ellipse</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">175</code><code class="p">)</code>            <code class="c1">// position the x-centre</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// position the y-centre</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// set the x radius</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the y radius</code>

<code class="c1">// draw clipped path on the screen</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">125</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">75</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#ellipse-clip)"</code><code class="p">)</code> <code class="c1">// clip the rectangle</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightgrey"</code><code class="p">)</code>   <code class="c1">// fill the clipped path with grey</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a path as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-47.png" alt="The clipped path">
  <figcaption>The clipped path</figcaption>
</figure>


<p>An example of this in use can bee seen in the <a href="#difference">difference chart</a> explanation later in the book. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-text">Text</h4>

<p>A <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_text">text</a> element is an SVG object which is shaped as text. It is described by two required attributes and three optional ones.</p>

<ul>
  <li>
<code>x</code>: This attribute designates the anchor point location for the text in the x dimension (required).</li>
  <li>
<code>y</code>: This attribute designates the anchor point location for the text in the y dimension (required).</li>
  <li>
<code>dx</code>: This attribute designates the offset of the text from the anchor point in the x dimension (optional). There are several different sets of units that can be used to designated the offset of the text from an anchor point. These include <code>em</code> which is a scalable unit (used in these examples), <code>px</code> (pixels), <code>pt</code> (points (kind of like pixels)) and <code>5</code> (percent (scalable and kind of like <code>em</code>))  </li>
  <li>
<code>dy</code>: This attribute designates the offset of the text from the anchor point in the y dimension (optional).</li>
  <li>
<code>text-anchor</code>: This attribute controls the horizontal text alignment (optional). It has three values; <code>start</code> (left aligned), <code>middle</code> (centre aligned) and <code>end</code> (right aligned).</li>
</ul>

<p>The following is an example of the code section required to draw the text “Hello World” in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code is the <code>style</code> declaration which applies a <code>black</code> <code>fill</code> to the text. Additionally there is the declaration <code>.text</code> which defines the text that will be displayed.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>     <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-11.png" alt="Text">
  <figcaption>Text</figcaption>
</figure>


<p>It can be seen from the image that the anchor point for the text is at 200,100 and that the text is positioned with this anchor point at the bottom, left of the text.</p>

<p>The following examples will demonstrate the various options for positioning and aligning text so that you can arrange it correctly.</p>

<h5 id="leanpub-auto-anchor-at-the-bottom-middle-of-the-text">Anchor at the bottom, middle of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-12.png" alt="Text: Anchored Bottom-middle">
  <figcaption>Text: Anchored Bottom-middle</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-at-the-bottom-right-of-the-text">Anchor at the bottom, right of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>        <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-13.png" alt="Text: Anchored Bottom-Right">
  <figcaption>Text: Anchored Bottom-Right</figcaption>
</figure>


<h5 id="leanpub-auto-anchor-at-the-middle-left-of-the-text">Anchor at the middle, left of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-15.png" alt="Text: Anchored Middle-Left">
  <figcaption>Text: Anchored Middle-Left</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-in-the-middle-centre-of-the-text">Anchor in the middle, centre of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-14.png" alt="Text: Anchored Middle-Centre">
  <figcaption>Text: Anchored Middle-Centre</figcaption>
</figure>


<h5 id="leanpub-auto-anchor-in-the-middle-right-of-the-text">Anchor in the middle, right of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>         <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>        <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-16.png" alt="Text: Anchored Middle-Right">
  <figcaption>Text: Anchored Middle-Right</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-at-the-top-left-of-the-text">Anchor at the top, left of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-17.png" alt="Text: Anchored Top-Left">
  <figcaption>Text: Anchored Top-Left</figcaption>
</figure>


<h5 id="leanpub-auto-anchor-at-the-top-middle-of-the-text">Anchor at the top, middle of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>            <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>           <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-18.png" alt="Text: Anchored Top-Middle">
  <figcaption>Text: Anchored Top-Middle</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-at-the-top-right-of-the-text">Anchor at the top, right of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>          <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>   <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>         <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-19.png" alt="Text: Anchored Top-Right">
  <figcaption>Text: Anchored Top-Right</figcaption>
</figure>


<div class="page-break"></div>
<h3 id="leanpub-auto-attributes">Attributes</h3>

<p>At the start of writing this section I was faced with the question “What’s an attribute?”. But a reasonable answer has eluded me, so I will make the assumption that the answer will be something of a compromise :-). I like to think that an attribute of an element  is something that is a characteristic of the object without defining it, and/or it may affect the object’s position or orientation on the page. There could be a strong argument to say that the following section on styles could be seen to cross-over into attributes and I agree. However, for the purposes of providing a description of the syntax and effects, I’m happy with the following list :-).  </p>

<p>Because not all attributes are applicable to all elements, there will be a bit of variation in the type of shapes we deal with in the description below, but there won’t be any that are different to those that we’ve already looked at. There will be some repetition with recurring information from the elements section. This is intentional to hopefully allow each section to exist in its own right.</p>

<h4 id="leanpub-auto-x-y">
<code>x</code>, <code>y</code>
</h4>

<p>The <code>x</code> and <code>y</code> attributes are used to designate a position on the web page that is set from the top, left hand corner of the web page.
Using the <code>x</code> and <code>y</code> attributes places the anchor points for these elements at a specified location. Of the elements that we have examined thus far, the rectangle element and the text element have anchor points to allow them to be positioned.</p>

<p>For example the following is a code section required to draw a rectangle (using only the required attributes) in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a rectangle as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-05.png" alt="Rectangle with `x`,`y` at 100,50">
  <figcaption>Rectangle with <code>x</code>,<code>y</code> at 100,50</figcaption>
</figure>


<p>The top left corner of the rectangle is specified using <code>x</code> and <code>y</code> at 100 and 50 respectively.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-x1-x2-y1-y2">
<code>x1</code>, <code>x2</code>, <code>y1</code>, <code>y2</code>
</h4>

<p>The <code>x1</code>, <code>x2</code>, <code>y1</code> and <code>y2</code> attributes are used to designate the position of two points on a web page that are set from the top, left hand corner of the web page. These two points are connected with a line as part of the <code>line</code> element.</p>

<p>The attributes are described as follows;</p>

<ul>
  <li>
<code>x1</code>: The x position of the first end of the line as measured from the left of the screen.</li>
  <li>
<code>y1</code>: The y position of the first end of the line as measured from the top of the screen.</li>
  <li>
<code>x2</code>: The x position of the second end of the line as measured from the left of the screen.</li>
  <li>
<code>y2</code>: The y position of the second end of the line as measured from the top of the screen.</li>
</ul>

<p>The following is an example of the code section required to draw a line in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. The attributes connect the point 100,50 (<code>x1</code>, <code>y1</code>) with 300,150 (<code>x2</code>, <code>y2</code>);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>          <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x1 position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y1 position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x2 position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y2 position of the second end of the line</code>
</pre></div>

</figure>

<p>This will produce a line as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-07.png" alt="Line">
  <figcaption>Line</figcaption>
</figure>


<p>The line extends from the point 100,50 to 300,150. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-points">points</h4>

<p>The <code>points</code> attribute is used to set a series of points which are subsequently connected with a line and / or which may form the bounds of a shape. These are specifically associated with the <code>polyline</code> and <code>polygon</code> elements. Like the <code>x</code>, <code>y</code> and <code>x1</code>, <code>x2</code>, <code>y1</code>, <code>y2</code> attributes, the coordinates are set from the top, left hand corner of the web page.</p>

<p>The data for the points is entered as a sequence of x,y points in the following format;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code> 
</pre></div>

</figure>

<p>Where 100,50 is the first x,y point then 200,150 is the second. Now is probably the best time to mention that the <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-svg_polyline">d3.js wiki</a> makes the point that “<em>it is typically more convenient and flexible to use the d3.svg.line path generator in conjunction with a path element</em>” when describing complex shapes. So while drawing a polyline or polygon using this method may be possible, bear in mind that depending on your application, there may be a better way.</p>

<p>The following is an example of the code section required to draw a polyline in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. The additional <code>style</code> declarations are included to illustrate the shape better. The <code>points</code> values can be compared with the subsequent image.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polyline"</code><code class="p">)</code>      <code class="c1">// attach a polyline</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points</code>
</pre></div>

</figure>

<p>This will produce a polyline as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-08.png" alt="Polyline using `points` attribute">
  <figcaption>Polyline using <code>points</code> attribute</figcaption>
</figure>


<p>The polyline extends from the point 100,50 to 200,150 to 300,50. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-cx-cy">
<code>cx</code>, <code>cy</code>
</h4>

<p>The <code>cx</code>, <code>cy</code> attributes are associated with the circle and ellipse elements and designate the centre of each shape. The coordinates are set from the top, left hand corner of the web page.</p>

<ul>
  <li>
<code>cx</code>: The position of the centre of the element in the x axis measured from the left side of the screen.</li>
  <li>
<code>cy</code>: The position of the centre of the element in the y axis measured from the top of the screen.</li>
</ul>

<p>The following is an example of the code section required to draw an ellipse in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. In it the centre of the ellipse is set by <code>cx</code>, <code>cy</code> as 200, 100. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>       <code class="c1">// attach an ellipse</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set the x radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>           <code class="c1">// set the y radius</code>
</pre></div>

</figure>

<p>This will produce an ellipse as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-04.png" alt="Ellipse with Centre at 200, 100">
  <figcaption>Ellipse with Centre at 200, 100</figcaption>
</figure>


<p>The centre of the ellipse is at x = 200 and y = 100 and the radius is 50 pixels vertically and 100 pixels horizontally. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-r"><code>r</code></h4>

<p>The <code>r</code> attribute determines the radius of a circle element from the <code>cx</code>, <code>cy</code> position (the centre of the circle) to the perimeter of the circle.</p>

<p>The following is an example of the code section required to draw a circle in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle with a radius of 50 pixels as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-02.png" alt="Circle with Radius of 50 Pixels">
  <figcaption>Circle with Radius of 50 Pixels</figcaption>
</figure>


<p>The centre of the circle is at x = 200 and y = 100 and the radius is 50 pixels. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-rx-ry">
<code>rx</code>, <code>ry</code>
</h4>

<p>The <code>rx</code>, <code>ry</code> attributes are associated with the ellipse element and designates the radius in the x direction (<code>rx</code>) and the radius in the y direction (<code>ry</code>). </p>

<ul>
  <li>
<code>rx</code>: The radius of the ellipse in the x dimension from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
  <li>
<code>ry</code>: The radius of the ellipse in the y dimension from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
</ul>

<p>The following is an example of the code section required to draw an ellipse in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. In it, the centre of the ellipse is set by <code>cx</code>, <code>cy</code> as 200, 100 and the radius in the x direction (<code>rx</code>) is 100 pixels and the radius in the y direction (<code>ry</code>) is 50 pixels.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>       <code class="c1">// attach an ellipse</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set the x radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>           <code class="c1">// set the y radius</code>
</pre></div>

</figure>

<p>This will produce an ellipse as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-04.png" alt="Ellipse with x Radius of 100 and y Radius of 50">
  <figcaption>Ellipse with x Radius of 100 and y Radius of 50</figcaption>
</figure>


<p>The centre of the ellipse is at x = 200 and y = 100 and the radius is 50 pixels vertically and 100 pixels horizontally. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-transform-translatexy-scalek-rotatea"><code>transform (translate(x,y), scale(k), rotate(a))</code></h4>

<p>The transform attribute is a powerful one which allows us to change the properties of an element in several different ways.</p>

<ul>
  <li>
<code>translate</code>: Where the element is moved by a relative value in the x,y direction. </li>
  <li>
<code>scale</code>: Where the element’s attributes are increased or reduced by a specified factor.</li>
  <li>
<code>rotate</code>: Where the element is rotated about its reference point by an angular value.</li>
</ul>

<p>Without a degree of prior understanding, these transforms can appear to behave in unusual ways, but hopefully we’ll explain it sufficiently here so that you can appreciate the logic in the way they work.  </p>

<h5 id="leanpub-auto-transform-translatexy"><code>transform (translate(x,y))</code></h5>

<p>The transform-translate attribute will take an elements position and adjust it based on a specified value(s) in the x,y directions.</p>

<p>The best way to illustrate this is with an example;</p>

<p>This is the code snippet from <a href="#EASframework">the HTML file</a> outlined at the start of this chapter which draws a circle at the position 200,100 (<code>cx</code>,<code>cy</code>);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-02.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>If we add in a <code>transform (translate(*x*,*y*))</code> attribute for values of x,y of 50,50 this will shift our circle by an additional 50 pixels in the x direction and 50 pixels in the y direction. </p>

<p>Here’s the code snippet that will draw our new circle;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(50,50)"</code><code class="p">)</code> <code class="c1">// translate the circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>And here’s the resulting change;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-20.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>The circle was positioned at the point 200,100 and then translated by 50 pixels in both axes to 250,150.</p>

<p>The original code snippet could in fact be written as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(200,100)"</code><code class="p">)</code> <code class="c1">// translate the circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>Since by default our starting position is 0,0 if we apply a translation of 200,100 we will end up at 200,100.</p>

<h5 id="leanpub-auto-transform-scalek"><code>transform (scale(k))</code></h5>

<p>The translate-scale attribute will take an element’s attributes and scale them by a factor <em>k</em>.</p>

<p>Originally I thought that this attribute would affect the size of the element, but it affects more than that! As with the transform-translate attribute, the best way to illustrate this is with an example;</p>

<p>The following code snippet (in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) which draws a circle at the position 150,50 with a radius of 25 pixels;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>     <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>        <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>         <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">25</code><code class="p">);</code>         <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-21.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>If we now introduce a transform-scale attribute with a scale of 2 we will see all three of the other attributes (<code>cx</code>, <code>cy</code> and <code>r</code>) scaled by a factor of two to 300, 100 and 50 respectively.</p>

<p>Here is the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>             <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>                <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>                 <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">25</code><code class="p">)</code>                  <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"scale(2)"</code><code class="p">);</code> <code class="c1">// scale the circle attributes</code>
</pre></div>

</figure>

<p>Which will produce a circle as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-22.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>In this example we can see that the position (<code>cx</code>, <code>cy</code>) and the radius (<code>r</code>) have been scaled up by a factor of 2.</p>

<h5 id="leanpub-auto-transform-rotatea"><code>transform (rotate(a))</code></h5>

<p>The translate-rotate attribute will rotate an element and its attributes by a declared angle in degrees.</p>

<p>The ability to rotate elements is obviously a valuable tool. The transform-rotate attribute does a great job of it, but the key to making sure that you know exactly what will happen to an object is to remember where the anchor point is for the object and to ensure that the associated attributes are set appropriately.  As with the transform translate &amp; scale attributes, the best way to illustrate this is with an example;</p>

<p>The following is the code snippet (in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) which draws the text “Hello World” at the position 200,100 with the anchor point being the the middle of the text;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-14.png" alt="Text: Anchored Middle-Centre">
  <figcaption>Text: Anchored Middle-Centre</figcaption>
</figure>


<p>If we then apply a transform-rotate of 10 degrees as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(10)"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>We will see the following on the screen;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-23.png" alt="Text: Anchored Middle-Centre">
  <figcaption>Text: Anchored Middle-Centre</figcaption>
</figure>


<p>Obviously the text has been rotated, but hopefully you’ll have noticed that it’s also been displaced. This is because the transform-rotate attribute has been applied to both the text element (which <em>has</em> been rotated by 10 degrees) <em>and</em> the <code>x</code>,<code>y</code> attributes. If you imagine the origin point for the element being at 0,0, the centre, middle of the text element has been rotated about the point 0,0 by 10 degrees (hopefully slightly better explained in the following picture).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-24.png" alt="Text: All positioning Attributes Rotated">
  <figcaption>Text: All positioning Attributes Rotated</figcaption>
</figure>


<p>This could be seen as an impediment to getting things to move / change as you want to, but instead it’s an indication of a different way of doing things. The solution to this particular feature is to combine the transform-rotate with the transform-translate that we used earlier so that the code looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(200,100) rotate(10)"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>And the image on the page looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-25.png" alt="Text: Rotated by 10 Degrees Anchored Middle-Centre">
  <figcaption>Text: Rotated by 10 Degrees Anchored Middle-Centre</figcaption>
</figure>


<p>Which leads us to the final example for which is a combination of all three aspects of the transform attribute.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(200,100) scale(2) rotate(10)"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-26.png" alt="Text: Translated, Scaled and Rotated">
  <figcaption>Text: Translated, Scaled and Rotated</figcaption>
</figure>


<p>Here we have a text element translated to its position on the page, rotated by 10 degrees about the centre of the text and scaled by a factor of two.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-width-height">
<code>width</code>, <code>height</code>
</h4>

<p><code>width</code> and <code>height</code> are required attributes of the rectangle element. <code>width</code> designates the width of the rectangle and <code>height</code> designates the height (If you’re wondering, I often struggle defining the obvious). </p>

<p>The following is an example of the code section required to draw a rectangle (using only the required attributes) in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a rectangle as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-05.png" alt="Rectangle">
  <figcaption>Rectangle</figcaption>
</figure>


<p>The width of the triangle is 200 pixels and the height is 100 pixels. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-text-anchor"><code>text-anchor</code></h4>

<p>The <code>text-anchor</code> attribute determines the justification of a text element</p>

<p>Text can have one of three <code>text-anchor</code> types;</p>

<ul>
  <li>
<code>start</code> where the text is left justified.</li>
  <li>
<code>middle</code> where the text is centre justified.</li>
  <li>
<code>end</code> where the text is right justified.</li>
</ul>

<p>The following is an example of code that will draw three separate lines of text with the three different <code>text-anchor</code> types in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World - start"</code><code class="p">);</code> <code class="c1">// define the text to display</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World - middle"</code><code class="p">);</code> <code class="c1">// define the text to display</code>
    
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World - end"</code><code class="p">);</code> <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce an output as follows;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-27.png" alt="Text with Different `text-anchor` Attributes">
  <figcaption>Text with Different <code>text-anchor</code> Attributes</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-dx-dy">
<code>dx</code>, <code>dy</code>
</h4>

<p><code>dx</code> and <code>dy</code> are optional attributes that designate an offset of text elements from the anchor point in the x and y dimension . There are several different sets of units that can be used to designate the offset of the text from an anchor point. These include <code>em</code> which is a scalable unit, <code>px</code> (pixels), <code>pt</code> (points (kind of like pixels)) and <code>%</code> (percent (scalable and kind of like <code>em</code>))  </p>

<p>We can demonstrate the offset effect by noting the difference in two examples.</p>

<p>The first is a simple projection of SVG text that aligns the text “Hello World” above and to the right of the anchor point at 200,100 (It does this in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter.). </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>     <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>Which produces the following on the page;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-11.png" alt="Text with the Anchor at the Bottom Left Corner">
  <figcaption>Text with the Anchor at the Bottom Left Corner</figcaption>
</figure>


<p>The second example introduces the <code>dx</code> attribute setting the offset to 50 pixels. This adds another 50 pixels to the x dimension. We also introduce the <code>dy</code> attribute with an offset of <code>.35em</code>. This scalable unit allows the text to be set as a factor of the size of the text. In this case <code>.35em</code> will add half the height of the text to the y dimension placing the text so that it is exactly in the middle (vertically) of the 100 pixel line on the y dimension.  </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"50px"</code><code class="p">)</code>       <code class="c1">// set offset x position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>      <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>     <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>Which produces the following on the page;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-28.png" alt="Text with 50 Pixel x Offset and Half Height y Offset">
  <figcaption>Text with 50 Pixel x Offset and Half Height y Offset</figcaption>
</figure>


<p>The text has been moved 50 pixels to the right and half the height of the text down the page.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-textlength"><code>textLength</code></h4>

<p>The <code>textLength</code> attribute adjusts the length of the text to fit a specified value.</p>

<p>The following is a code snippet that prints the text “Hello World” above and to the right of the anchor point at 200,100 (It does this in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter.). The addition of the <code>textLength</code> attribute declaration in the code stretches the “Hello World” out so that it fills 150 pixels.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"textLength"</code><code class="p">,</code> <code class="s2">"150"</code><code class="p">)</code> <code class="c1">// set text length</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>Which produces the following on the page;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-29.png" alt="Text Stretched to 150 Pixels Wide">
  <figcaption>Text Stretched to 150 Pixels Wide</figcaption>
</figure>


<p>It is worth noting that while the text has been spread out, the individual letters remain un-stretched. Only the letter and word spacing has been adjusted. However, using the <code>lengthAdjust</code> attribute can change this.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-lengthadjust"><code>lengthAdjust</code></h4>

<p>The <code>lengthAdjust</code> attribute allows the <code>textLength</code> attribute to have the spacing of a text element controlled to be either <code>spacing</code> or <code>spacingAndGlyphs</code>;</p>

<ul>
  <li>
<code>spacing</code>: In this option the letters remain the same size, but the spacing between the letters and words are adjusted.</li>
  <li>
<code>spacingAndGlyphs</code>: In this option the text is stretched or squeezed to fit.</li>
</ul>

<p>The attribute can be best illustrated via an example. The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) shows three versions of the text element. The top line is the standard text. The middle line is the <code>textLength</code> set to 150 and the <code>lengthAdjust</code> set to <code>spacing</code> (which is the default). The bottom line is the <code>textLength</code> set to 150 and the <code>lengthAdjust</code> set to <code>spacingAndGlyphs</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>
    
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"textLength"</code><code class="p">,</code> <code class="s2">"150"</code><code class="p">)</code> <code class="c1">// set text length</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"lengthAdjust"</code><code class="p">,</code> <code class="s2">"spacing"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"textLength"</code><code class="p">,</code> <code class="s2">"150"</code><code class="p">)</code> <code class="c1">// set text length</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"lengthAdjust"</code><code class="p">,</code> <code class="s2">"spacingAndGlyphs"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>The image on the screen will look like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-30.png" alt="Text Stretched in Three Ways">
  <figcaption>Text Stretched in Three Ways</figcaption>
</figure>


<p>The image shows that the top line looks normal, the middle line has had the spaces increased to increase the length of the text and the bottom line has been stretched.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-styles">Styles</h3>

<p>What’s a style?</p>

<p>Believe it or not, that’s as difficult a question to answer as “What’s an attribute?”. I like to think that an element can be selected and arranged on a web page with <code>select</code> and <code>attr</code>, but once it’s there, changes to how it looks are a matter for <code>style</code>. We will cover a range of qualities that neatly fit into this definition in the following section (such as fill, opacity and stroke-width) but there are also a range of unusual style declarations that many may not have come across (I certainly hadn’t before writing this).</p>

<p>The other important thing to mention about setting styles for elements is that there are different ways to accomplish the task. We’ll go through the process of describing different styles as they can be applied to individual elements in isolation, but there is a more powerful way to manage styles across a range of elements via Cascading Style Sheets (CSS) in the <code>&lt;style&gt;</code> section of a web page or even via an external style sheet. We will examine these possibilities at the end of the section. </p>

<p>Full disclosure: I have not figured out how to work some of the styles for d3.js I’m afraid that <code>clip-path</code> and <code>mask</code> have exceeded my skill-set and I will have to leave them for another day :-(. I found that there are several good examples that make use of these styles, but I have struggled (unsuccessfully) to present them in a simple example.  </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-fill"><code>fill</code></h4>

<p>The <code>fill</code> style will fill the element being presented with a specified colour.</p>

<p>By default, most elements will be filled with black (the majority of the examples used in this chapter make no <code>fill</code> declaration). </p>

<p>The following example (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) shows the syntax for filling a simple circle with the colour red;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>     <code class="c1">// set the fill colour </code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-31.png" alt="Circle with Red Fill">
  <figcaption>Circle with Red Fill</figcaption>
</figure>


<p>As we saw with the <code>polyline</code> and <code>polygon</code> examples earlier in the chapter some shapes may need to have their <code>fill</code> colour turned off in some circumstances and this can be accomplished by declaring the colour to be <code>none</code> (<code>.style("fill", "none");</code>).</p>

<p>There are several different ways to define exactly what colour we want as a fill. The example above uses a ‘named colour code’ to declare the colour as “red” but we could also have defined it as rgb (<code>.style("fill", "rgb(255,0,0)");</code>) or in hexadecimal (<code>.style("fill", "#f00");</code>)</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke"><code>stroke</code></h4>

<p>The <code>stroke</code> style applies a colour to lines. </p>

<p>By default many elements do not have a stroke colour set, so it’s a matter of declaring the colour with either a named colour code (“red”), an rgb value (“rgb(255,0,0)”) or the appropriate hex (“#f00”).</p>

<p>The following example (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) shows the syntax for applying the colour red to a simple circle. The fill has been set to <code>none</code> to help the colour stand out.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>    <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>    <code class="c1">// set the fill colour </code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-32.png" alt="Circle with Red Border">
  <figcaption>Circle with Red Border</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-opacity"><code>opacity</code></h4>

<p>The <code>opacity</code> style has the effect of varying an element’s transparency.</p>

<p>The valid range for <code>opacity</code> is from 0 (completely transparent) to 1 (solid colour). We should make the distinction at this point that <code>opacity</code> affects the entire element, whereas the following <code>fill-opacity</code> and <code>stroke-opacity</code> affects only the fill and stroke respectively.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a green circle with a red border. The opacity value of .2 creates a degree of transparency which will show the grid lines underneath the element.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">2</code><code class="p">)</code>      <code class="c1">// set the element opacity</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>    <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"green"</code><code class="p">);</code>   <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-33.png" alt="Circle with opacity">
  <figcaption>Circle with opacity</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-fill-opacity"><code>fill-opacity</code></h4>

<p>The <code>fill-opacity</code> style changes the transparency of the fill of an element.</p>

<p>The valid range for <code>fill-opacity</code> is from 0 (completely transparent) to 1 (solid colour). We should make the distinction at this point that <code>fill-opacity</code> affects only the fill of an element, whereas <code>opacity</code> will affect the entire element.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a green circle with a red border. The opacity value of .2 creates a degree of transparency for the fill which will show the grid lines underneath.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">2</code><code class="p">)</code> <code class="c1">// set the fill opacity</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>    <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"green"</code><code class="p">);</code>   <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-34.png" alt="Circle with Semi-Transparent Fill">
  <figcaption>Circle with Semi-Transparent Fill</figcaption>
</figure>


<p>The distinction between this image and the one for the <code>opacity</code> style clearly shows the line around the outside of the object as still a solid (opaque) colour.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-opacity"><code>stroke-opacity</code></h4>

<p>The <code>stroke-opacity</code> style changes the transparency of the stroke (line) of an element.</p>

<p>The valid range for <code>stroke-opacity</code> is from 0 (completely transparent) to 1 (solid colour). We should make the distinction at this point that <code>stroke-opacity</code> affects only the line or border of an element, whereas <code>opacity</code> will affect the entire element.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates an empty circle with a red border. The opacity value of .2 creates a degree of transparency for the stroke which will show the grid lines underneath (or at least make it appear more ‘muted’).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>          <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>             <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>             <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>               <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">2</code><code class="p">)</code> <code class="c1">// set the stroke opacity</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>      <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>      <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-35.png" alt="Circle with Red Border and opacity">
  <figcaption>Circle with Red Border and opacity</figcaption>
</figure>


<p>Although it is not necessarily easy to see in this example because the line is quite thin, the lines of the grid behind the circle will be showing through the line of the circle.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-width"><code>stroke-width</code></h4>

<p>The <code>stroke-width</code> style adjusts the width of the line of an element.</p>

<p>The value specified when setting <code>stroke-width</code> is in pixels.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates an empty circle with a red border. The <code>stroke-width</code> is set to 5 which equates to 5 pixels (it can also be specified as “5px”).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>          <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>             <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>             <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>               <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>    <code class="c1">// set the stroke width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>      <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>      <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-36.png" alt="Circle with Thicker Red Border">
  <figcaption>Circle with Thicker Red Border</figcaption>
</figure>


<p>The width of the line that forms the border of the circle is now 5 pixels wide :-).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-dasharray"><code>stroke-dasharray</code></h4>

<p>The <code>stroke-dasharray</code> style allows us to form element lines with dashes instead of solid lines.</p>

<p>We have covered dashed lines in practical way in a previous section of the book (‘Make a Dashed Line’) but for the sake of completeness I will include dashed lines here as well.</p>

<p>We create a dashed line by specifying the length of a dash and then the length of a space. We can include a long list of dashes and spaces and once complete our line will simply repeat the pattern we have specified.</p>

<p>For example the following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a line with a dash of 10 pixels followed by a space of 2 pixels;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>       <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>          <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>          <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>            <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"10,3"</code><code class="p">))</code> <code class="c1">// make the stroke dashed</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>   <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>   <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-37.png" alt="Circle with Dashed Red Border">
  <figcaption>Circle with Dashed Red Border</figcaption>
</figure>


<p>More complex combinations of dashes and spaces are possible as are complex animation sequences that leverage the ability to move objects along a path (these are certainly more advanced examples).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-linecap"><code>stroke-linecap</code></h4>

<p>The <code>stroke-linecap</code> style allows control of the shape of the ends of lines in d3.js.</p>

<p>There are three shape options;</p>

<ul>
  <li>
<code>butt</code> where the line simply butts up to the starting or ending position and is cut off squarely.</li>
  <li>
<code>round</code> where the line is rounded in proportion to its width.</li>
  <li>
<code>square</code> where the line is squared off but extended in proportion to its width.</li>
</ul>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) generates three lines showing each <code>stroke-linecap</code> style option. The top line uses <code>butt</code>. The middle line uses <code>round</code> and the bottom line uses <code>square</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                 <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>         <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>        <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"butt"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>     <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                  <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>          <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>         <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                   <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>           <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"square"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-38.png" alt="Three Lines with Different End Shapes">
  <figcaption>Three Lines with Different End Shapes</figcaption>
</figure>


<p>The shapes are quite distinct for each type and it is useful to note the degree to which the lines extend beyond their start and end points.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-linejoin"><code>stroke-linejoin</code></h4>

<p>The <code>stroke-linejoin</code> style specifies the shape of the join of two lines. This would be used on <code>path</code>, <code>polyline</code> and <code>polygon</code> elements (and possibly more).</p>

<p>There are three line join options;</p>

<ul>
  <li>
<code>miter</code> where the join is squared off as would be expected at the join of two lines. </li>
  <li>
<code>round</code> where the outside portion of the join is rounded in proportion to its width.</li>
  <li>
<code>bevel</code> where the join  has a straight edged outer portion clipped off to provide a slightly more contoured effect while still being angular.</li>
</ul>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) generates a poly line where the join has the connection shaped using the <code>stroke-linejoin</code> <code>round</code> style. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polyline"</code><code class="p">)</code>       <code class="c1">// attach a polyline</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>      <code class="c1">// remove any fill colour</code>
	<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>  <code class="c1">// colour the line</code>
	<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linejoin"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// shape the line join</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points </code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-39.png" alt="Polyline with Round Join">
  <figcaption>Polyline with Round Join</figcaption>
</figure>


<p>Note the curve on the outer of the join.</p>

<p>Changing the shape of the line join to <code>bevel</code> produces the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-40.png" alt="Polyline with Bevel Join">
  <figcaption>Polyline with Bevel Join</figcaption>
</figure>


<p>Here we can see the clipping of the outer portion of the join.</p>

<p>And using <code>miter</code> produces a standard connection;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-41.png" alt="Polyline with Miter Join">
  <figcaption>Polyline with Miter Join</figcaption>
</figure>


<p>This is the default setting for line joins and does not need to be added unless the line join type has already been set to a different default.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-writing-mode"><code>writing-mode</code></h4>

<p>The <code>writing-mode</code> style changes the orientation of the text so that it prints out top to bottom. It has a single option “tb” that accomplishes this. It is relatively limited in scope compared to the equivalent for CSS, but for the purposes of generating some text it has a definite use.</p>

<p>The following code snippet (hich works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a line of text that is now printed from top to bottom instead of left to right.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>            <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>      <code class="c1">// make the text black</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"writing-mode"</code><code class="p">,</code> <code class="s2">"tb"</code><code class="p">)</code> <code class="c1">// set the writing mode</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>         <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>   <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-42.png" alt="Text rotated using writing-mode">
  <figcaption>Text rotated using writing-mode</figcaption>
</figure>


<p>It is significant to note that while it looks like the text has been rotated about it’s anchor point, this actually isn’t the case since the anchor point should be at 200,100. Also, the <code>glyph-orientation-vertical</code> style (which follows) will allow the text to be orientated vertically which will be useful.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-glyph-orientation-vertical"><code>glyph-orientation-vertical</code></h4>

<p>The <code>glyph-orientation-vertical</code> style changes the rotation of the individual glyphs (characters) in text and if used in conjunction with the <code>writing-mode</code> style (and set to 0) will allow the text to be displayed vertically with the letters orientated vertically as well.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a line of text that is now printed from top to bottom with letters orientated vertically.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>            <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>      <code class="c1">// make the text black</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"writing-mode"</code><code class="p">,</code> <code class="s2">"tb"</code><code class="p">)</code> <code class="c1">// set the writing mode</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"glyph-orientation-vertical"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>         <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">25</code><code class="p">)</code>          <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>   <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-43.png" alt="Text rotated and orientated">
  <figcaption>Text rotated and orientated</figcaption>
</figure>


<p>It is worth noting that the text spacing increases dramatically as the spacing for each letter relies on the normal distance between the bottom and top of a line of text.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-using-styles-in-cascading-style-sheets">Using styles in Cascading Style Sheets</h4>

<p>Declaring styles on an element by element basis is an OK way to apply styles, but when our visualizations become more complex, this can be an inefficient use of code.</p>

<p>A smarter way to provide a common set of styles to elements is to declare them in the <code>&lt;style&gt;</code> section of our HTML document using Cascading Style Sheets (CSS). These will then be automatically applied to our elements.</p>

<p>We start with an example script that draws our three lines that have different styles of linecaps. Our previous example looked like the following 
(in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter)</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                 <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>         <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>        <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"butt"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>     <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                  <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>          <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>         <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                   <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>           <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"square"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>Which resulted in the following image;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/EAS-38.png" alt="Three Lines with Different End Shapes">
  <figcaption>Three Lines with Different End Shapes</figcaption>
</figure>


<p>The block of code for each of the three lines contains three separate <code>style</code> declarations. Two of which are identical for all three blocks of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>         <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>        <code class="c1">// adjust line width</code>
</pre></div>

</figure>

<p>To make these styles available from a common point, we declare them in the <code>&lt;style&gt;</code> section of our HTML file as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="nt">line</code><code class="nc">.linecap</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">20</code><code class="p">;</code>  
<code class="p">}</code>
<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The <code>&lt;style&gt;</code> tags simply tell our browser which part of <a href="#EASframework">the HTML file</a> we are using to define our styles.</p>

<p>The <code>line.linecap</code> portion identifies the following styles as belonging to the <code>line</code> elements that are also identified as belonging to the ‘class’ <code>linecap</code> (We have used the <code>linecap</code> name as a convenience only and it could just as easily been <code>foobar</code>.).</p>

<p>The two styles are enclosed within curly braces and are declared in the form <code>&lt;style-name&gt;: &lt;style-value&gt;;</code>. So for our example here, the stroke is black and its width is 20 pixels.</p>

<p>Then our example script can have the two styles removed from each of the blocks that draws the lines and in their place we add a new attribute <code>class</code> that assigns a class to the element (in this case the class <code>linecap</code>). Our new code will look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>           <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"butt"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"linecap"</code><code class="p">)</code>   <code class="c1">// inherits styles from CSS</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>     <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>           <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"linecap"</code><code class="p">)</code>   <code class="c1">// inherits styles from CSS</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>           <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"square"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"linecap"</code><code class="p">)</code>   <code class="c1">// inherits styles from CSS</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>While this has only replaced two lines with one in our code, the potential for use in far more complex examples should be obvious. There is significantly more detail that can be gone into with regard to CSS, but that would be beyond my meagre abilities.</p>

<h2 id="leanpub-auto-assorted-tips-and-tricks">Assorted Tips and Tricks</h2>

<h3 id="leanpub-auto-change-a-line-chart-into-a-scatter-plot">Change a line chart into a scatter plot</h3>

<p>Confession time. </p>

<p>I didn’t actually intend to add in a section with a scatter plot in it for its own sake because I thought it would be;</p>

<ol class="numeric">
  <li>tricky</li>
  <li>not useful</li>
  <li>all of the above</li>
</ol>

<p>I was wrong on all counts.</p>

<aside class="information blurb">
    <p>I did want to have a scatter plot, because I wanted to display tool tips, but this is too neat to ignore.
It was literally a 5 minute job, 3 minutes of which was taken up by going to the <a href="https://github.com/mbostock/d3/wiki/Gallery">d3 gallery on the wiki</a> and ogling at the cool stuff there before snapping out of it and going to the <a href="http://bl.ocks.org/3887118">scatter plot example</a>.</p>

</aside>

<p>All you need to do is take the simple graph example file and slot the following block in between the ‘Add the valueline path’ and the ‘add the x axis’ blocks.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mf">3.5</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>And you will get…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scatter01.png" alt="A scatter plot! (with a line)">
  <figcaption>A scatter plot! (with a line)</figcaption>
</figure>


<p>The full code for this graph can also be found on <a href="https://gist.github.com/d3noob/38744a17f9c0141bcd04">github</a> or in the code samples bundled with this book (simple-scatterplot.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/38744a17f9c0141bcd04">bl.ocks.org</a>.</p>

<p>I deliberately put the dots <em>after</em> the line in the drawing section, because I thought they would look better, but you could put the block of code before the line drawing block to get the following effect;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scatter02.png" alt="A scatter plot with the line in front of the dots">
  <figcaption>A scatter plot with the line in front of the dots</figcaption>
</figure>


<p>(just trying to reinforce the concept that ‘order’ matters when drawing objects :-)).</p>

<p>You could of course just remove the line block all together…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scatter03.png" alt="A scatter plot without the line this time">
  <figcaption>A scatter plot without the line this time</figcaption>
</figure>


<p>But in my humble opinion it loses something.</p>

<p>So what do the individual lines in the scatter plot block of JavaScript do?</p>

<p>The first line (<code>svg.selectAll("dot")</code>) essentially provides a suitable grouping label for the svg circle elements that will be added. The next line associates the range of data that we have to the group of elements we are about to add in.</p>

<p>Then we add a circle for each data point (<code>.enter().append("circle")</code>) with a radius of 3.5 pixels (<code>.attr("r", 3.5)</code>) and appropriate x (<code>.attr("cx", function(d) { return x(d.date); })</code>) and y (<code>.attr("cy", function(d) { return y(d.close); });</code>) coordinates.</p>

<p>There is lots more that we could be doing with this piece of code (check out the <a href="http://bl.ocks.org/3887118">scatter plot example</a>) including varying the colour or size or opacity of the circles depending on the data and all sorts of really neat things, but for the mean time, there we go. Scatter plot!</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-adding-tooltips">Adding tooltips.</h3>

<p>Tooltips have a marvellous duality. They are on one hand a pretty darned useful thing that aids in giving context and information where required and on the other hand, if done with a bit of care, they can look very stylish :-).</p>

<p>Technically, they represent a slight move from what we have been playing with so far into a mildly more complex arena of ‘transitions’ and ‘events’. You can take this one of two ways. Either accept that it just works and implement it as shown, or you will know what’s going on and feel free to deride my efforts as those of a rank amateur :-).</p>

<aside class="information blurb">
    <p>The source for the implementation was taken from Mike Bostock’s example on <a href="http://bl.ocks.org/1087001">bl.ocks.org</a>. This was combined with a few other bit’s and pieces (the trickiest being working out how to format the displayed date correctly and inserting a line break in the tooltip (which I found on <a href="https://groups.google.com/forum/?fromgroups=#!topic/d3-js/GgFTf24ltjc">Google Groups</a>;  (well done to all those participating in that discussion)). I make the assumption that any or all errors that occur in the implementation will be mine, whereas, any successes will be down to the original contributors.</p>

</aside>

<p>Just in case there is some confusion, a tooltip (one word or two?) is a discrete piece of information that will pop into view when the mouse hovers over somewhere specific. Most of us have seen and used them, but I suppose we all tend to call them different things such as ‘infotip’, ‘hint’ or ‘hover box’ I don’t know if there’s a right name for them, but here’s an example of what we’re trying to achieve;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tips01.png" alt="A tooltip magically appears over a dot">
  <figcaption>A tooltip magically appears over a dot</figcaption>
</figure>


<p>You can see the mouse has hovered over one of the scatter plot circles and a tip has appeared that provides the user with the exact date and value for that point.</p>

<p>Now, you may also notice that there’s a certain degree of ‘fancy’ here as the information is bound by a rectangular shape with rounded corners and a slight opacity. The other piece of ‘fancy’ which you don’t see in a PDF (or whatever format this distinguished tome will be published in on its 33rd reprint in the year 2034), is that when these tool tips appear and disappear, they do so in an elegant fade-in, fade-out way. Pretty!</p>

<p>Now, before we get started describing how the code goes together, let’s take a quick look at the two technique specifics that I mentioned earlier, ‘transitions’ and ‘events’.</p>

<h4 id="leanpub-auto-transitions">Transitions</h4>

<p>From the main d3.js web page (d3js.org) transitions are described as gradually interpolating styles and attributes over time. So what I take that to mean is that if you want to change an object, you can do so be simply specifying the attribute / style end point that you want it to end up with and the time you want it to take and go!</p>

<p>Of course, it’s not quite that simple, but luckily, smarter people than I have done some fantastic work describing different aspects of transitions so please see the following for a more complete description of the topic;</p>

<ul>
  <li>Mike Bostock’s <a href="http://mbostock.github.com/d3/tutorial/bar-2.html">Bar chart tutorial</a>
</li>
  <li>Christophe Viau’s <a href="http://christopheviau.com/d3_tutorial/">‘Try D3 Now!’ tutorial</a>
</li>
</ul>

<p>Hopefully observing the mouseover and mouseout transitions in the tooltips example will whet your appetite for more!</p>

<h4 id="leanpub-auto-events">Events</h4>

<p>The other technique is related to mouse ‘events’. This describes the browser watching for when ‘something’ happens with the mouse on the screen and when it does, it takes a specified action. A (probably non-comprehensive) list of the types of events are the following;</p>

<ul>
  <li>mousedown: Triggered by an element when a mouse button is pressed down over it</li>
  <li>mouseup: Triggered by an element when a mouse button is released over it</li>
  <li>mouseover: Triggered by an element when the mouse comes over it</li>
  <li>mouseout: Triggered by an element when the mouse goes out of it</li>
  <li>mousemove: Triggered by an element on every mouse move over it.</li>
  <li>click: Triggered by a mouse click: mousedown and then mouseup over an element</li>
  <li>contextmenu: Triggered by a right-button mouse click over an element.</li>
  <li>dblclick: Triggered by two clicks within a short time over an element</li>
</ul>

<p>How many of these are valid to use within d3 I’m not sure, but I’m willing to bet that there are probably more than those here as well. Please go to <a href="http://javascript.info/tutorial/mouse-events">http://javascript.info/tutorial/mouse-events</a> for a far better description of the topic if required.</p>

<h4 id="leanpub-auto-get-tipping">Get tipping</h4>

<p>So, bolstered with a couple of new concepts to consider, let’s see how they are enacted in practice.</p>

<p>The full code for this graph can also be found on <a href="https://gist.github.com/d3noob/a22c42db65eb00d4e369">github</a> or in the code samples bundled with this book (simple-tooltips.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/a22c42db65eb00d4e369">bl.ocks.org</a>.</p>

<p>If we start with our simple-scatter plot graph there are 4 areas in it that we will want to modify (it may be easier to check the tooltips.html file in the example files in the downloads section on d3noob.org).</p>

<p>The first area is the CSS. The following code should be added just before the <code>&lt;/style&gt;</code> tag;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">div</code><code class="nc">.tooltip</code> <code class="p">{</code>	
    <code class="nb">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>			
    <code class="nb">text-align</code><code class="o">:</code> <code class="nb">center</code><code class="p">;</code>			
    <code class="nb">width</code><code class="o">:</code> <code class="m">60px</code><code class="p">;</code>					
    <code class="nb">height</code><code class="o">:</code> <code class="m">28px</code><code class="p">;</code>					
    <code class="nb">padding</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>				
    <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code>		
    <code class="nb">background</code><code class="o">:</code> <code class="nb">lightsteelblue</code><code class="p">;</code>	
    <code class="nb">border</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>		
    <code class="nb">border</code><code class="o">-</code><code class="n">radius</code><code class="o">:</code> <code class="m">8px</code><code class="p">;</code>			
    <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>			
<code class="p">}</code>
</pre></div>

</figure>

<p>These styles are defining how our tooltip will appear . Most of them are fairly straight forward. The position of the tooltip is done in absolute measurements, not relative. The text is centre aligned, the height, width and colour of the rectangle is 28px, 60px and lightsteelblue respectively. The ‘padding’ is an interesting feature that provides a neat way to grow a shape by a fixed amount from a specified size.</p>

<p>We set the border to 0px so that it doesn’t show up and a neat style (attribute?) called border-radius provides the nice rounded corners on the rectangle.</p>

<p>Lastly, but by no means least, the ‘pointer-events: none’ line is in place to instruct the mouse event to go “through” the element and target whatever is “underneath” that element instead (Read more <a href="https://developer.mozilla.org/en-US/docs/CSS/pointer-events">here</a>). That means that even if the tooltip partly obscures the circle, the code will still act as if the mouse is over only the circle.</p>

<p>The second addition is a simple one-liner that should (for forms sake) be placed under the ‘parseData’ variable declaration;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">formatTime</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%e %B"</code><code class="p">);</code>
</pre></div>

</figure>

<p>This line formats the date when it appears in our tooltip. Without it, the time would default to a disturbingly long combination of temporal details. In the case here we have declared that we want to see the day of the month (<code>%e</code>) and the full month name(<code>%B</code>).</p>

<p>The third block of code is the function declaration for ‘div’.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">div</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>	
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"tooltip"</code><code class="p">)</code>				
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
</pre></div>

</figure>

<p>We can place that just after the ‘valueline’ definition in the JavaScript. Again there’s not too much here that’s surprising. We tell it to attach ‘div’ to the body element, we set the class to the tooltip class (from the CSS) and we set the opacity to zero. It might sound strange to have the opacity set to zero, but remember, that’s the natural state of a tooltip. It will live unseen until it’s moment of revelation arrives and it pops up!</p>

<p>The final block of code is slightly more complex and could be described as a mutant version of the neat little bit of code that we used to do the drawing of the dots for the scatter plot. That’s because the tooltips are all about the scatter plot circles. Without a circle to ‘mouseover’, the tooltip never appears :-).</p>

<p>So here’s the code that includes the scatter plot drawing (it’s included since it’s pretty much integral);</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>			
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>								
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>		
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>		 
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">})</code>		
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>		
            <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>		
                <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>		
                <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">9</code><code class="p">);</code>		
            <code class="nx">div</code>	<code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code>  <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>	
                <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>		
                <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>	
            <code class="p">})</code>					
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>		
            <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>		
                <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>		
                <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>	
        <code class="p">});</code>
</pre></div>

</figure>

<aside class="tip blurb">
    <p>Before we start going through the code, the example file for tooltips that is on d3noob.org includes a brief series of comments for the lines that are added or changed from the scatter plot, so if you want to compare what is going on in context, that is an option.</p>

</aside>

<p>The first six lines of the code are a repeat of the scatter plot drawing script. The only changes are that we’ve increased the radius of the circle from 3.5 to 5 (just to make it easier to mouse over the object) and we’ve removed the semicolon from the <code>cy</code> attribute line since the code now has to carry on.</p>

<p>So the additions are broken into two areas that correspond to the two events. <code>mouseover</code> and <code>mouseout</code>. When the mouse moves over any of the circles in the scatter plot, the mouseover code is executed on the <code>div</code> element. When the mouse is moved off the circle a different set of instructions are executed.</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-there-is-only-one">There is only one!</h3>
  <p>It would be a mistake to think of tooltips in the plural because there aren’t a whole series of individual tooltips just waiting to appear for their specific circle. There is only one tooltip that will appear when the mouse moves over a circle. And depending on what circle it’s over, the properties of the tooltip will alter slightly (in terms of its position and contents).</p>

</aside>

<h4 id="leanpub-auto-onmouseover">on.mouseover</h4>

<p>The <code>.on("mouseover"</code> line initiates the introduction of the tooltip. Then we declare the element we will be introducing (‘<code>div</code>’) and that we will be applying a transition to its introduction (<code>.transition()</code>). The next two lines describe the transition. It will take 200 milliseconds (<code>.duration(200)</code>) and will result in changing the element’s opacity to .9 (<code>.style("opacity", .9);</code>). Given that the natural state of our tooltip is an opacity of 0, this make sense for something appearing, but it doesn’t go all the way to a solid object and it retains a slight transparency just to make it look less permanent.</p>

<p>The following three lines format our tooltip. The first one adds an html element that contains our x and y information (the <code>date</code> and the <code>d.close</code> value). Now this is done in a slightly strange way. Other tooltips that I have seen have used a ‘<code>.text</code>’ element instead of a ‘<code>.html</code>’ one, but I have used ‘<code>.html</code>’ in this case because I wanted to include the line break tag <code>&lt;br/&gt;</code> to separate the date and value. I’m sure there are other ways to do it, but this worked for me. The other interesting part of this line is that this is where we call our time formatting function that we described earlier. The next two lines position the tooltip on the screen and to do this they grab the x and y coordinates of the mouse when the event takes place (with the <code>d3.event.pageX</code> and <code>d3.event.pageY</code> snippets) and apply a correction in the case of the y coordinate to raise the tooltip up by the same amount as its height (28 pixels).</p>

<h4 id="leanpub-auto-onmouseout">on.mouseout</h4>

<p>The <code>.on("mouseout"</code> section is slightly simpler in that it doesn’t have to do any fancy text / html / coordinate stuff. All it has to do is to fade out the ‘div’ element. And that is done by simply reversing the opacity back to 0 and setting the duration for the transition to 500 milliseconds (being slightly longer than the fade-in makes it look slightly cooler IMHO).</p>

<p>Right, there you go. As a description it’s ended up being a bit of a wall of text I’m afraid. But hopefully between the explanation and the example code you will get the idea. Please take the time to fiddle with the settings described here to find the ones that work for you and in the process you will reinforce some of the principles that help D3 do its thing.</p>

<h4 id="leanpub-auto-including-an-html-link-in-a-tool-tip">Including an HTML link in a tool tip</h4>

<p>There was an interesting question on <a href="http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html">d3noob.org</a> about adding an HTML link to a tooltip. While the person asking the question had the problem pretty much solved already, I thought it might be useful for others.</p>

<p>The premise is that you want to add a tool tip to your visualization using the method described here, but you also want to include an HTML link in the tooltip that will  link somewhere else. This might look a little like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tool-01.png" alt="Tool tip with an HTML Link">
  <figcaption>Tool tip with an HTML Link</figcaption>
</figure>


<p>In the image above the date has been turned into a link. In this case the link goes to google.com, but that can obviously be configurable.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/c37cb8e630aaef7df30d">github</a> or in the code samples bundled with this book (tooltips-link.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/c37cb8e630aaef7df30d">bl.ocks.org</a>. </p>

<p>There are a few changes that we would want to make to our original tooltip code to implement this feature.</p>

<p>First of all, we’ll add the link to the date element. Adding an HTML link can be as simple as wrapping the ‘thing’ to be used as a link in <a href="http://www.w3schools.com/tags/tag_a.asp"><code>&lt;a&gt;</code> tags</a> with an appropriate URL to go to.</p>

<p>The following adaptation of the code that prints the information into our tooltip code does just that;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">div</code> <code class="p">.</code><code class="nx">html</code><code class="p">(</code>
        <code class="s1">'&lt;a href= "http://google.com"&gt;'</code> <code class="o">+</code> <code class="c1">// The first &lt;a&gt; tag</code>
        <code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code>
        <code class="s2">"&lt;/a&gt;"</code> <code class="o">+</code>                          <code class="c1">// closing &lt;/a&gt; tag</code>
        <code class="s2">"&lt;br/&gt;"</code>  <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>     
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>             
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
</pre></div>

</figure>

<p><code>&lt;a href= "http://google.com"&gt;</code> places our first <code>&lt;a&gt;</code> tag and declares the URL and the second tag follows after the date.</p>

<p>The second change we will want to make is to ensure that the tooltip stays in place long enough for us to actually click on the link. The problem being solved here is that our original code relies on the mouse being over the dot on the graph to display the tooltip. if the tooltip is displayed and the cursor moves to press the link, it will move off the dot on the graph and the tooltip vanishes (Nice!).</p>

<p>To solve the problem we can leave the tooltip in place adjacent to a dot while the mouse roams freely over the graph until the next time it reaches a dot and then the previous tooltip vanishes and a new one appears. The best way to appreciate this difference is to check out the live example on <a href="http://bl.ocks.org/d3noob/c37cb8e630aaef7df30d">bl.ocks.org</a>.</p>

<p>The code is as follows (you may notice that this also includes the link as described above);</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>        
        <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>    
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
        <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>    
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">9</code><code class="p">);</code>    
        <code class="nx">div</code> <code class="p">.</code><code class="nx">html</code><code class="p">(</code>
            <code class="s1">'&lt;a href= "http://google.com"&gt;'</code> <code class="o">+</code> <code class="c1">// The first &lt;a&gt; tag</code>
            <code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code>
            <code class="s2">"&lt;/a&gt;"</code> <code class="o">+</code>                          <code class="c1">// closing &lt;/a&gt; tag</code>
            <code class="s2">"&lt;br/&gt;"</code>  <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>     
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>             
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
        <code class="p">});</code>
</pre></div>

</figure>

<p>We have removed the <code>.on("mouseout"</code> portion and moved the function that it used to carry out to the start of the <code>.on("mouseover"</code> portion. That way the first thing that occurs when the mouse cursor moves over a dot is that it removes the previous tooltip and then it places the new one.</p>

<p>The last change we need to make is to remove from the <code>&lt;style&gt;</code> section the line that told the mouse to ignore the tooltip;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  /*  pointer-events: none;    This line needs to be removed */
</pre></div>

</figure>

<p>In this case I have just commented it out so that it’s a bit more obvious that it gets removed.</p>

<h5 id="leanpub-auto-moar-links">Moar Links!</h5>

<p>One link is interesting, but let’s face it, we didn’t go to all the trouble of putting a link into a tool tip to just go to one location. Now we shift it up a gear and start linking to different places depending on our data. At the same time (and because someone asked) we will make the link open in a new tab!</p>

<p>The changes to the script are fairly minor, but one fairly large change is the need to have links to go to. For this example I have added a range of links to visit to our csv file so it now looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,link
1-May-12,58.13,http://bl.ocks.org/d3noob/c37cb8e630aaef7df30d
30-Apr-12,53.98,http://bl.ocks.org/d3noob/11313583
27-Apr-12,67.00,http://bl.ocks.org/d3noob/11306153
26-Apr-12,89.70,http://bl.ocks.org/d3noob/11137963
25-Apr-12,99.00,http://bl.ocks.org/d3noob/10633856
24-Apr-12,130.28,http://bl.ocks.org/d3noob/10633704
23-Apr-12,166.70,http://bl.ocks.org/d3noob/10633421
20-Apr-12,234.98,http://bl.ocks.org/d3noob/10633192
19-Apr-12,345.44,http://bl.ocks.org/d3noob/10632804
18-Apr-12,443.34,http://bl.ocks.org/d3noob/9692795
17-Apr-12,543.70,http://bl.ocks.org/d3noob/9267535
16-Apr-12,580.13,http://bl.ocks.org/d3noob/9211665
13-Apr-12,605.23,http://bl.ocks.org/d3noob/9167301
12-Apr-12,622.77,http://bl.ocks.org/d3noob/8603837
11-Apr-12,626.20,http://bl.ocks.org/d3noob/8375092
10-Apr-12,628.44,http://bl.ocks.org/d3noob/8329447
9-Apr-12,636.23,http://bl.ocks.org/d3noob/8329404
5-Apr-12,633.68,http://bl.ocks.org/d3noob/8150631
4-Apr-12,624.31,http://bl.ocks.org/d3noob/8273682
3-Apr-12,629.32,http://bl.ocks.org/d3noob/7845954
2-Apr-12,618.63,http://bl.ocks.org/d3noob/6584483
30-Mar-12,599.55,http://bl.ocks.org/d3noob/5893649
29-Mar-12,609.86,http://bl.ocks.org/d3noob/6077996
28-Mar-12,617.62,http://bl.ocks.org/d3noob/5193723
27-Mar-12,614.48,http://bl.ocks.org/d3noob/5141528
26-Mar-12,606.98,http://bl.ocks.org/d3noob/5028304
</pre></div>

</figure>

<p>The code change is to the piece of JavaScript where we add the HTML. This is what we end up with;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">div</code> <code class="p">.</code><code class="nx">html</code><code class="p">(</code>
        <code class="s1">'&lt;a href= "'</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">link</code><code class="o">+</code><code class="s1">'" target="_blank"&gt;'</code> <code class="o">+</code> <code class="c1">//with a link</code>
        <code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code>
        <code class="s2">"&lt;/a&gt;"</code> <code class="o">+</code>
        <code class="s2">"&lt;br/&gt;"</code>  <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>     
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>             
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We’ve replaced the URL <code>http://google.com</code> with the variable for our <code>link</code> column <code>d.link</code> and we’ve also added in the <code>target="_blank"</code> statement so that our link opens in a new tab. </p>

<aside class="warning blurb">
    <p>A quick word of warning on this piece of code. it can look a little messy because it includes nested speech-marks and quotation marks. This makes it a bit confusing if you’re unused to the idea of nesting this type of information. If things aren’t working in this part of your code, I recommend going back to basics and adding one piece at a time, getting it right and then add the next piece. Take it slow :-).</p>

</aside>

<p>The full code for this multi link example can be found on <a href="https://gist.github.com/d3noob/2e224baa7472c5e9e0e8">github</a> or in the code samples bundled with this book (tooltips-link-multi.html and datatips.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/2e224baa7472c5e9e0e8">bl.ocks.org</a>. </p>

<p>Hopefully that helps people with a similar desire to include links in their tooltips. Many thanks to the reader who suggested it :-).</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-what-are-the-predefined-named-colours">What are the predefined, named colours?</h3>

<p>Throughout this document I generally use colours defined by name. This is mainly because I can, and not for any other reason. In fact there several different ways to define colours used in D3 / JavaScript / CSS and HTML. I have no idea what the limitations for use are and / or how their use in different browsers impacts on correct representation. But I do know that they’re used widely.</p>

<p>There seems to be several different standards for what constitute an authoritative list of named colours. After a cursory search I was able to find a great list on <a href="http://webdesign.about.com/od/colorcharts/l/bl_namedcolors.htm">about.com</a> and there are some nice representations on <a href="http://en.wikipedia.org/wiki/Web_colors#X11_color_names">Wikipedia</a>.</p>

<p>The overriding point of all this is that there’s more than one way to define colours in your graphs.</p>

<p>It means that considering… 
		<code>.style("fill", "steelblue")</code><br>
and…<br>
		<code>.style("fill", "#4682b4")</code><br>
and…<br>
		<code>.style("fill", "rgb(70,130,180)")</code>  </p>

<p>All three alternatives result in the same colour being applied.</p>

<p>For a long time I didn’t actually have the images of the colours represented here in D3 Tips and Tricks, but like all things, one day I thought ‘Hey, I could just write a simple script that placed them on the screen’. So here they are :-). </p>

<p>I have tried to group them as ‘like’ colours per the entry in Wikipedia.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-01.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-02.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-03.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-04.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-05.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-06.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-07.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-08.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-09.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-10.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-11.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-12.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-13.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-14.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-15.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-16.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-17.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-18.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-19.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-20.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-21.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-22.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-23.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-24.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-25.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-26.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-27.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-28.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-29.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-30.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-31.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-32.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-33.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-34.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-35.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-36.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-37.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-39.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-40.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-41.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-42.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-43.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-44.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-45.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-46.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/colour-47.png" alt="">
  <figcaption></figcaption>
</figure>


<p>You can also see a live page with the script that produces the rectangles at <a href="http://bl.ocks.org/d3noob/11313583">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-selecting--filtering-a-subset-of-objects">Selecting / filtering a subset of objects</h3>

<p>OK, Imagine a scenario where you want to select (or should we say filter) a particular range of objects from a larger set.</p>

<p>For example, what if we wanted to use our scatter plot example to show the line as normal, but we are particularly interested in the points where the values of the points fall below 400. And when it does we want them highlighted with a circle as we have done with <em>all</em> the points previously.</p>

<p>So that we end up with something that looks a little like this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/filter01.png" alt="Only the points below 400 are selected">
  <figcaption>Only the points below 400 are selected</figcaption>
</figure>


<p>Err… Yes, for those among you who are of the observant persuasion, I have deliberately coloured them red as well (red for <strong>DANGER</strong>!).</p>

<p>This is a fairly simple example, but serves to illustrate the principle adequately.
From our simple scatter plot example we only need to add in two lines to the block of code that draws the circles as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>		
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>										
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>								
    <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&lt;</code> <code class="mi">400</code> <code class="p">})</code>    <code class="c1">// &lt;== This line</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>                        <code class="c1">// &lt;== and this one</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mf">3.5</code><code class="p">)</code>										
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>		 
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8dc93bce7e7200ab487d">github</a> or in the code samples bundled with this book (filter-selection.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/8dc93bce7e7200ab487d">bl.ocks.org</a>. </p>

<p>The first added line uses the <code>.filter</code> function to act on the data points and according to the arguments passed to it in this case, only return those where the value of d.close is less than 400 (<code>return d.close &lt; 400</code>).</p>

<p>The second added line is our line that simply colours the circles red (<code>.style("fill", "red")</code>).</p>

<p>That’s all there is to it. Pretty simple, but the filter function can be very powerful when used wisely.</p>

<p>I’ve placed a copy of the file for selecting / filtering into the downloads section on d3noob.org with the general examples as filter-selection.html.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-select-items-with-an-if-statement">Select items with an IF statement.</h3>

<p>The filtering – selection section above is a good way to adapt what you see on a graph, but so is a more familiar friend… The ‘if’ statement.</p>

<p>An if statement will act to carry out a task in a particular way dependant on a condition that you specify. </p>

<aside class="tip blurb">
    <p>Here’s an example, what if we wanted to show our scatter plot as normal, but all those with a ‘close’ value less than 400 should be coloured red. Sound familiar?  Yes, I know it’s similar to the example above, with the subtle difference that it is leaving the circles above 400 in place (more on that to follow).</p>

</aside>

<p>Starting with the simple scatter plot example all we have to do is include the if statement in the block of code that draws the circles. Here’s the entire block with the additions highlighted;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>										
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>								
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mf">3.5</code><code class="p">)</code>		
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>            <code class="c1">// &lt;== Add these</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&lt;=</code> <code class="mi">400</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="s2">"red"</code><code class="p">}</code>  <code class="c1">// &lt;== Add these</code>
            <code class="k">else</code> 	<code class="p">{</code> <code class="k">return</code> <code class="s2">"black"</code> <code class="p">}</code>          <code class="c1">// &lt;== Add these</code>
        <code class="p">;})</code>                                     <code class="c1">// &lt;== Add these</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>		 
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>	
</pre></div>

</figure>

<p>Our first added line introduces the style modifier and the rest of the code acts to provide a return for the ‘fill’ attribute.</p>

<p>The second line introduces our if statement. There’s very little difference using <code>if</code> statements between languages. Just look out for maintaining the correct syntax and you should be fine. In this case we’re asking if the value of d.close is less than or equal to 400 and if it is it will return the <code>"red"</code> statement for our fill.</p>

<p>The third line covers our rear and make sure that if the colour isn’t going to be red, it’s going to be black. The last line just closes the style and function statements.</p>

<p>The result?</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/if01.png" alt="Points above 400 black and points below 400 red">
  <figcaption>Points above 400 black and points below 400 red</figcaption>
</figure>


<p>Aww….. nice.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/464c92429ac05c6a19a1">github</a> or in the code samples bundled with this book (if-selection.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/464c92429ac05c6a19a1">bl.ocks.org</a>. </p>

<p>Could it be any cooler? I’m glad you asked.</p>

<p>What if we wanted to have all the points where close was less than 400 red and all those where close was greater than 620 green? Oh yeah! Now we’re talking.</p>

<p>So with one small change to the if statement;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 		
            <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&lt;=</code> <code class="mi">400</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="s2">"red"</code><code class="p">}</code>	
            <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&gt;=</code> <code class="mi">620</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="s2">"lawngreen"</code><code class="p">}</code> <code class="c1">// &lt;== Right here </code>
            <code class="k">else</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"black"</code> <code class="p">}</code> 			
        <code class="p">;})</code>		
</pre></div>

</figure>

<p>Check it out…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/if02.png" alt="Points coloured differently depending on their value">
  <figcaption>Points coloured differently depending on their value</figcaption>
</figure>


<p>Nice.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-applying-a-colour-gradient-to-a-line-based-on-value">Applying a colour gradient to a line based on value.</h3>

<p>I just know that you were impressed with the changing dots in a scatter plot based on the value. But could we go one better?</p>

<p>How about we try to reproduce the same effect but by varying the colour of the plotted line.
This is a neat feature and a useful example of the flexibility of d3.js and SVG in general.
I used the appropriate bits of code from Mike Bostock’s <a href="http://bl.ocks.org/3970883">Threshold Encoding example</a>. And I should take the opportunity to heartily recommend browsing through his collection of examples on <a href="http://bl.ocks.org/mbostock">bl.ocks.org</a>. For those who prefer to see the code in it’s fullest, there is an example as an appendix (Graph with Area Gradient) that can assist (although it is for a later example that uses a gradient in a similar way (don’t worry we’ll get to it in a few pages)).</p>

<p>Here then is a plotted line that is red below 400, green above 620 and black in between.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/gradientline01.png" alt="Line colour varied with gradient">
  <figcaption>Line colour varied with gradient</figcaption>
</figure>


<p>How cool is that?</p>

<p>Enough beating around the bush, how is the magic line produced?</p>

<p>Starting with our simple line graph, there are only two blocks of code to go in. One is CSS in the <code>&lt;style&gt;</code> area and the second is a tricky little piece of code that deals with gradients.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/3e72cafd95e1834f599b">github</a> or in the code samples bundled with this book (line-colour-gradient-graph.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/3e72cafd95e1834f599b">bl.ocks.org</a>. </p>

<p>So, first the CSS.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.line</code> <code class="p">{</code>							
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>					
    <code class="n">stroke</code><code class="o">:</code> <code class="sx">url(#line-gradient)</code><code class="p">;</code>	
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>			
<code class="p">}</code>	
</pre></div>

</figure>

<p>This block can go in the <code>&lt;style&gt;</code> area towards the end.</p>

<p>There’s the fairly standard fill of none and a stroke width of 2 pixels, but the <code>stroke: url(#line-gradient);</code> is something different.</p>

<p>In this case the stroke (the colour of the line) is being determined at a link within the page which is set by the anchor <code>#line-gradient</code>. We will see shortly that this is in our second block of code, so the colour is being defined in a separate portion of the script.</p>

<p>And now the JavaScript gradient code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"linearGradient"</code><code class="p">)</code>				
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"line-gradient"</code><code class="p">)</code>			
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"gradientUnits"</code><code class="p">,</code> <code class="s2">"userSpaceOnUse"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">0</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="nx">y</code><code class="p">(</code><code class="mi">0</code><code class="p">))</code>			
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">0</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="nx">y</code><code class="p">(</code><code class="mi">1000</code><code class="p">))</code>		
    <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"stop"</code><code class="p">)</code>						
        <code class="p">.</code><code class="nx">data</code><code class="p">([</code>								
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"0%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>		
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"40%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>	
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"40%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"62%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"62%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">},</code>	
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"100%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">}</code>	
        <code class="p">])</code>					
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"stop"</code><code class="p">)</code>			
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"offset"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">offset</code><code class="p">;</code> <code class="p">})</code>	
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"stop-color"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">;</code> <code class="p">});</code>		
</pre></div>

</figure>

<p>There’s our anchor on the second line!</p>

<p>But let’s not get ahead of ourselves. This block should be placed after the x and y domains are set, but before the line is drawn.</p>

<aside class="information blurb">
    <p>Seems a bit strange doesn’t it? This block is all about defining the actions of an element, but the element in this case is a gradient and the gradient acts on the line.</p>

</aside>

<p>So, our first line adds our linear gradient. Gradients consist of continuously smooth colour transitions along a vector from one colour to another We can have a linear one or a radial one and depending on which you select, there are a few options to define. There is some great information on gradients at <a href="http://www.w3.org/TR/SVG/pservers.html">http://www.w3.org/TR/SVG/pservers.html</a> (more than I ever thought existed).</p>

<p>The second line (<code>.attr("id", "line-gradient")</code>) sets our anchor for the CSS that we saw earlier.</p>

<p>The third fourth and fifth lines define the bounds of the area over which the gradient will act. Since the coordinates <code>x1</code>, <code>y1</code>, <code>x2</code>, <code>y2</code> will describe an area. The values for <code>y1</code> (0) and <code>y2</code> (1000) are used more for convenience to align with our data (which has a maximum value around 630 or so). For more information on the gradientUnits attribute I found this page useful <a href="https://developer.mozilla.org/en-US/docs/SVG/Attribute/gradientUnits">https://developer.mozilla.org/en-US/docs/SVG/Attribute/gradientUnits</a>. We’ll come back to the coordinates in a moment.</p>

<p>The next block selects all the ‘stop’ elements for the gradients. These stop elements define where on the range covered by our coordinates the colours start and stop. These have to be defined as either percentages or numbers (where the numbers are really just percentages in disguise (i.e. 45% =0.45)).</p>

<p>The best way to consider the stop elements is in conjunction with the <code>gradientUnits</code>. The image following may help.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/gradientline02.png" alt="Varying colours for varying values make a gradient">
  <figcaption>Varying colours for varying values make a gradient</figcaption>
</figure>


<p>In this case our coordinates describe a vertical line from 0 to 1000. Our colours transition from red (0) to red (400) at which point they change to black (400) and this will continue until it gets to black (620). Then this changes to green (620) and from there, any value above that will be green.</p>

<aside class="information blurb">
    <p>Now, it might seem a little convoluted to be doubling up on the colours and values, but the reason is that the gradient functions have a lot more to them than we’re using and we’ll have a look at the possibilities once the explanation of the code is done.</p>

</aside>

<p>So after defining the stop elements, we enter and append the elements to the gradient (<code>.enter().append("stop")</code>) with attributes for offset and colour that we defined in the stop elements area.</p>

<p>Now, that <em>IS</em> cool, but by now, I hope that you have picked that a gradient function really does mean a gradient, and not just a straight change from one colour to another.</p>

<p>So, let’s try changing the stop element offsets to the following (and making the stroke-width slightly larger to see more clearly what’s going on);</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">data</code><code class="p">([</code>								
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"0%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>		
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"30%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>	
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"45%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"55%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"60%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">},</code>	
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"100%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">}</code>	
        <code class="p">])</code>		
</pre></div>

</figure>

<p>And here we go…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/gradientline03.png" alt="Line with a gradually changing gradient">
  <figcaption>Line with a gradually changing gradient</figcaption>
</figure>


<p>Ahh… A real gradient.</p>

<p>I have tended to find that I need to have a good think about how I set the offsets and bounds when doing this sort of thing since it can get quite complicated quite quickly :-)</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-applying-a-colour-gradient-to-an-area-fill">Applying a colour gradient to an area fill.</h3>

<p>The previous example of a varying gradient on a line is neat, but hopefully you’re already thinking “Hang on, can’t that same thing be applied to an area fill?”.</p>

<p>Damn! You’re catching on.</p>

<p>To do this there’s only a few things we need to change;</p>

<p>First of all the CSS for the line needs to be amended to refer to the area. So this…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.line</code> <code class="p">{</code>							
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>					
    <code class="n">stroke</code><code class="o">:</code> <code class="sx">url(#line-gradient)</code><code class="p">;</code>	
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>			
<code class="p">}</code>		
</pre></div>

</figure>

<p>…gets changed to this…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.area</code> <code class="p">{</code>							
    <code class="n">fill</code><code class="o">:</code> <code class="sx">url(#area-gradient)</code><code class="p">;</code>					
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>			
<code class="p">}</code>		
</pre></div>

</figure>

<p>We’ve defined the styles for the area this time, but instead of the stroke being defined by the separate script, now it’s the area. While we’ve changed the url name, it’s actually the same piece of code, with a different id (because it seemed wrong to be talking about an area when the label said line). We’ve also set the stroke width to zero, because we don’t want any lines around our filled area.</p>

<p>Now we want to take the block of code that defined our line…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code>	<code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>		
</pre></div>

</figure>

<p>… and we need to replace it with the standard block that defined an area fill.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code>	<code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>	
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>	
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>					
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>		
</pre></div>

</figure>

<p>So we’re not going to be drawing a line at all. Just the area fill.</p>

<p>Next, as I mentioned earlier, we change the id for the <code>linearGradient</code> block from <code>"line-gradient"</code> to <code>"area-gradient"</code></p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"area-gradient"</code><code class="p">)</code>			
</pre></div>

</figure>

<p>And lastly, we remove the block of code that drew the line and replace it with a block that draws  an area. So change this….</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>				
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>		
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>… to this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code> 	
        <code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">);</code>
</pre></div>

</figure>

<p>And then sit back and marvel at your creation;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/gradientarea01.png" alt="Area fill with a gradually changing gradient">
  <figcaption>Area fill with a gradually changing gradient</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/9fcf79b76c2643b98dd7">github</a> or in the code samples bundled with this book (area-colour-gradient-graph.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/9fcf79b76c2643b98dd7">bl.ocks.org</a>. </p>

<p>For a slightly ‘nicer’ looking example, you could check out a variation of one of Mike Bostocks originals here; <a href="http://bl.ocks.org/4433087">http://bl.ocks.org/4433087</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-show--hide-an-element-by-clicking-on-another-element">Show / hide an element by clicking on another element</h3>

<p>This is a trick that I found I wanted to impliment in order to present a graph with a range of lines and to then provide the reader with the facility to click on the associated legend to toggle the visibility of the lines off and on as required.</p>

<p>The example we’ll follow is our friend from earlier, a slightly modified example of the graph with two lines.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/show-hide-01.png" alt="Show / hide lines on a graph">
  <figcaption>Show / hide lines on a graph</figcaption>
</figure>


<p>In this example we will be able to click on either of the two titles at the bottom of the graph (‘Blue Line’ or ‘Red Line’) and have it toggle the respective line and Y axis.</p>

<h5 id="leanpub-auto-the-code">The code</h5>

<p>The code for the example is available online at <a href="http://bl.ocks.org/d3noob/5d621a60e2d1d02086bf">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/5d621a60e2d1d02086bf">GitHub</a>. It is also available as the file ‘show-hide.html’ as a separate download with D3 Tips and Tricks. A copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<p>There are two main parts to implementing this technique. Firstly we have to label the element (or elements) that we wish to show / hide and then we have to give the object that will get clicked on the attribute that allows it to recognise a mouse click and the code that it subsequently uses to show / hide our labelled element.</p>

<p>Labelling the element that is to be switched on and off is dreadfully easy. It simply involves including an <code>id</code> attribute to an element that identifies it uniquely. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"blueLine"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>In the example above we have applied the <code>id</code> <code>blueLine</code> to the path that draws the blue line on our graph.</p>

<p>The second part is a little trickier. The following is the portion of JavaScript that places our text label under the graph. The only part of it that is unusual is the <code>.on("click", function()</code> section of the code.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>             
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="mi">10</code><code class="p">)</code>    
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>         
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(){</code>
        <code class="c1">// Determine if current line is visible</code>
        <code class="kd">var</code> <code class="nx">active</code>   <code class="o">=</code> <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">?</code> <code class="kc">false</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
          <code class="nx">newOpacity</code> <code class="o">=</code> <code class="nx">active</code> <code class="o">?</code> <code class="mi">0</code> <code class="o">:</code> <code class="mi">1</code><code class="p">;</code>
        <code class="c1">// Hide or show the elements</code>
        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#blueLine"</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#blueAxis"</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
        <code class="c1">// Update whether or not the elements are active</code>
        <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">=</code> <code class="nx">active</code><code class="p">;</code>
</pre></div>

</figure>

<p>When we click on our ‘Blue Line’ text element the <code>.on("click", function()</code> section executes.</p>

<p>We’re using a short-hand version of the <code>if</code> statement a couple of times here. Firstly we check to see if the variable <code>blueLine.active</code> is true or false and if it’s true it gets set to false and if it’s false it gets set to true (not at all confusing).</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="kd">var</code> <code class="nx">active</code>   <code class="o">=</code> <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">?</code> <code class="kc">false</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
          <code class="nx">newOpacity</code> <code class="o">=</code> <code class="nx">active</code> <code class="o">?</code> <code class="mi">0</code> <code class="o">:</code> <code class="mi">1</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then after toggling this variable we set the value of <code>newOpacity</code> to either 0 or 1 depending on whether <code>active</code> is <code>false</code> or <code>true</code> (the second short-hand JavaScript if statement).</p>

<p>We can then select our identifiers that we have declared using the <code>id</code> attributes in the earlier pieces of code and modify their opacity to either <code>0</code> (off) or <code>1</code> (on) </p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#blueLine"</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#blueAxis"</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
</pre></div>

</figure>

<p>Lastly we update our <code>blueLine.active</code> variable to whatever the <code>active</code> state is so that it can toggle correctly the next time it is clicked on. </p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">=</code> <code class="nx">active</code><code class="p">;</code>
</pre></div>

</figure>

<p>Quite a neat piece of code. Kudos to Max Leiserson for providing the example on which it is largely based in an <a href="http://stackoverflow.com/questions/20249215/how-to-display-and-hide-links-and-nodes-when-clicking-on-a-node-in-d3-javascript">answer to a question on Stack Overflow</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-export-an-image-from-a-d3js-page-as-a-svg-or-bitmap">Export an image from a d3.js page as a SVG or bitmap</h3>

<p>At some point you will want to take your lovingly crafted D3 graphical masterpiece and put it in a 
(close your eyes if you’re squeamish) Power Point presentation or Word document or export it for sharing in some other way.</p>

<p>There could be many reasons for wanting to do this and some may be more complicated than I will be willing to explore, but for the occasional conversion of images I have found what I regard as a fairly easy process.</p>

<p>Before we begin our exporting odyssey, let’s cover a little bit of housekeeping and describe the difference between a vector graphic (in this case specifically Scalable Vector Graphics) and a bitmap. Please skip ahead if you’re comfortable with the terms.</p>

<h4 id="leanpub-auto-bitmaps">Bitmaps</h4>

<p>A bitmap (or raster) image is one that is composed of lots of discrete individual dots (let’s call them pixels) which, when joined together (and zoomed out a bit) give the impression of an image.
If we use the example of the force layout example we developed, and look at a screen shot (and it’s important to remember that this is a screen shot) of the image we see a picture that looks fairly benign.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/prezoom.png" alt="A bitmap at a normal zoom level">
  <figcaption>A bitmap at a normal zoom level</figcaption>
</figure>


<p>However, as we enlarge the image by doubling it’s size (x 2) we begin to see some rough edges appear.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/prezoomx2.png" alt="A bitmap at 200%">
  <figcaption>A bitmap at 200%</figcaption>
</figure>


<p>And if we enlarge it by doubling again (x 4) , it starts to look decidedly rough.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/prezoomx4.png" alt="A bitmap at 400%">
  <figcaption>A bitmap at 400%</figcaption>
</figure>


<p>Doubling again (x 8), starts to show the pixels pretty clearly.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/prezoomx8.png" alt="A bitmap at 800%">
  <figcaption>A bitmap at 800%</figcaption>
</figure>


<p>Doubling again for the last time (x 16) and the pixels are plainly evident.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/prezoomx16.png" alt="A bitmap at 1600%">
  <figcaption>A bitmap at 1600%</figcaption>
</figure>


<p>Bitmaps can be saved in a wide range of formats depending on users requirements including compression, colour depth, transparency and a host of other attributes. Typically they can be identified by the file suffix .jpg, .png or .bmp (and there are an equally large number of other suffixes).</p>

<p>This will be the type of format that most people will be familiar with for images and their ubiquity with the advent of digital cameras almost makes it redundant to describe them.</p>

<p>However, there is another type of image and it is even more important to d3.js users.</p>

<h4 id="leanpub-auto-vector-graphics-specifically-svg">Vector Graphics (Specifically SVG)</h4>

<p>Scalable Vector Graphics (SVG) use a technique of drawing an image that relies more on a description of an image than the final representation that a user sees. Instead of arranging individual pixels, an image is created by describing the way the image is created. </p>

<p>For instance, drawing a line would be accomplished by defining two sets of coordinates and specifying a line of a particular width and colour be drawn between the points.</p>

<p>This might sound a little long winded, and it does create a sense of abstraction, but it is a far more powerful mechanism for drawing as there is no loss of detail with increasing scale. Changes to the image can be simply carried out by adjusting the coordinates, colour description, line width or curve diameter. If this all sounds a little familiar, you have <em>definitely</em> been paying attention, because this is the heart of the way that d3.js draws images in a browser. It uses a combination of coordinates, shapes and attributes to create vector images in a web page.</p>

<p>As a demonstration of the difference, here is the same original picture which I have saved as a SVG image.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/svgzoom.png" alt="A SVG image at a normal zoom level">
  <figcaption>A SVG image at a normal zoom level</figcaption>
</figure>


<p>Enlarged by doubling it’s size (x 2) everything looks smooth.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/svgzoomx2.png" alt="A SVG at 200%">
  <figcaption>A SVG at 200%</figcaption>
</figure>


<p>If we enlarge it by doubling again (x 4) , it still looks good.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/svgzoomx4.png" alt="A SVG at 400%">
  <figcaption>A SVG at 400%</figcaption>
</figure>


<p>Doubling again (x 8) and we can see that the text ‘James’ is actually composed of a fill colour and a border.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/svgzoomx8.png" alt="A SVG at 800%">
  <figcaption>A SVG at 800%</figcaption>
</figure>


<p>Doubling again for the last time (x 16) everything still retains it’s clear sharp edges.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/svgzoomx16.png" alt="A SVG at 1600%">
  <figcaption>A SVG at 1600%</figcaption>
</figure>


<h4 id="leanpub-auto-lets-get-exporting">Let’s get exporting!</h4>

<p>We’ll use a three stage process for exporting our image (assuming the desired end result is a bitmap) and usefully, the first stage will result in us having a vector image as well!</p>

<p>The sequence will go as follows:</p>

<ol class="numeric">
  <li>Copy the image from the web page and save it as a SVG file</li>
  <li>Open the SVG image in a program designed to use vector images and edit it if required.</li>
  <li>Export that image as a bitmap</li>
</ol>

<h5 id="leanpub-auto-copying-the-image-off-the-web-page">Copying the image off the web page</h5>

<p>Getting the image out of a web page is made easy by using ‘<a href="http://nytimes.github.io/svg-crowbar/">SVG Crowbar</a>’. This is a “<em>A Chrome-specific bookmarklet that extracts SVG nodes and accompanying styles from an HTML document and downloads them as an SVG file</em>”. What that means is that once you drag the bookmarklet from the web page to your bookmarks (You need to be using Google Chrome, and I’m told that about 60% of the people who visit d3noob.org do) you’re ready to go. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/svgcrowbar.png" alt="Drag the 'SVG Crowbar' Object from the web page to your bookmarks bar">
  <figcaption>Drag the ‘SVG Crowbar’ Object from the web page to your bookmarks bar</figcaption>
</figure>


<p>Now when you have a web page open that’s displaying a D3 creation, all you need to do is click on the SVG Crowbar bookmark and you will be prompted for a location to save a svg image.</p>

<p>Really. It’s that simple.</p>

<h5 id="leanpub-auto-open-the-svg-image-and-edit">Open the SVG Image and Edit</h5>

<p>Obviously now that you have a SVG image, you need to be able to do something with it. My preferred software for this is <a href="http://inkscape.org/">Inkscape</a>. </p>

<p>Inkscape is “<em>An Open Source vector graphics editor, with capabilities similar to Illustrator, CorelDraw, or Xara X, using the W3C standard Scalable Vector Graphics (SVG) file format</em>”. </p>

<p>It really is an extremely capable drawing program and it is capable of a lot more than the job we’re going to use it for, so you may find it has other uses that may be valuable.</p>

<p>Once installed, you can open the saved file directly into Inkscape.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/inkscape.png" alt="Inkscape with our force diagram">
  <figcaption>Inkscape with our force diagram</figcaption>
</figure>


<p>While here you can edit the drawing to your hearts delight. I particularly recommend ungrouping the diagram and removing or adjusting individual elements if required.</p>

<p>Once you have finished editing, you are ready for the final step.</p>

<h5 id="leanpub-auto-saving-as-a-bitmap">Saving as a bitmap</h5>

<p>While still in Inkscape, go to the ‘File’, ‘Export Bitmap…’ menu.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/inkscape-export.png" alt="Inkscape Export Bitmap menu">
  <figcaption>Inkscape Export Bitmap menu</figcaption>
</figure>


<p>This will open a dialog box where you can select an appropriate resolution and location for your bitmap and then press the export button.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/inkscape-export-dialog.png" alt="Inkscape Export Bitmap dialog">
  <figcaption>Inkscape Export Bitmap dialog</figcaption>
</figure>


<p>There you go. </p>

<p>It is worth knowing that the default settings here will export the diagram with a transparent background (using *.png) which will fit in nicely with a wide range of graphical end uses.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-using-html-inputs-with-d3js">Using HTML inputs with d3.js</h3>

<p>Part of the attraction of using technologies like d3.js is that it expands the scope of what is possible in a web page. At the same time, there are many different options for displaying content on a page and plenty of ways of interacting with it. </p>

<p>Some of the most basic of capabilities has been the use of HTML entities that allow the entry of data on a page. This can take a range of different forms (pun intended) and the <code>&lt;input&gt;</code> tag is one of the most basic.</p>

<h4 id="leanpub-auto-what-is-an-html-input">What is an HTML input?</h4>

<p>An HTML input is an element in HTML that allows a web page to input data. There are a range of different input types (with varying degrees of compatibility with browsers) and they are typically utilised inside a <code>&lt;form&gt;</code> element.</p>

<p>For example the following code allows a web page to place two fields on a web page so that a user can enter their first and last names in separate boxes;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">form</code><code class="p">&gt;</code>
  First name: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"firstname"</code><code class="p">&gt;&lt;</code><code class="nt">br</code><code class="p">&gt;</code>
  Last name: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"lastname"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The page would then display the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/input-01.png" alt="A form input">
  <figcaption>A form input</figcaption>
</figure>


<p>The range of input types is large and includes;</p>

<ul>
  <li>text: A simple text field that a user can enter information into.</li>
  <li>radio: Buttons that let a user select only one of a limited number of choices.</li>
  <li>button: A clickable button that can activate JavaScript.</li>
  <li>range: A slider control for setting a number whose exact value is not important.</li>
  <li>number: A field for entering a number or toggling a number up and down.</li>
</ul>

<p>… and many more. To check out others and get further background, it would be worth while visiting the<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Input"> Mozilla developer</a> pages or <a href="http://www.w3schools.com/tags/tag_input.asp">w3schools.com</a>.</p>

<p>While d3.js has the power to control and manipulate a web page to an extreme extent, sometimes it’s desirable to use a simple process to get a result. The following explanations will demonstrate a simple use case linking an HTML input with a d3.js element and will go on to provide examples of using multiple inputs, affecting multiple elements and using different input types. The examples are deliberately kept simple. They are intended to demonstrate functionality and to provide a starting position for you to go forward :-).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-using-a-range-input-with-d3js">Using a <code>range</code> input with d3.js</h4>

<p>The first example we will follow will use a <code>range</code> input to adjust the radius of a circle.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/input-02.png" alt="Adjust the radius of a circle">
  <figcaption>Adjust the radius of a circle</figcaption>
</figure>


<h5 id="leanpub-auto-the-code-1">The code</h5>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/10632804">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/10632804">GitHub</a>. It is also available as the file ‘input-radius.html’ as a separate download with D3 Tips and Tricks. A copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Input test (circle)<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
  
<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nRadius"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         radius = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"150"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw the circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>   
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">120</code><code class="p">);</code>

<code class="c1">// when the input range changes update the circle </code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">update</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// Initial starting radius of the circle </code>
<code class="nx">update</code><code class="p">(</code><code class="mi">120</code><code class="p">);</code>

<code class="c1">// update the elements</code>
<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>

  <code class="c1">// update the circle radius</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-the-explanation">The explanation</h5>

<p>As with the other examples in the book I will not go over some of the simpler lines of code that are covered in greater detail in earlier sections of the book and will concentrate on those sections that contain new concepts, code or look like they might need expanding :-).</p>

<p>The first section is the portion that sets out the html <code>range</code> input;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nRadius"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         radius = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"150"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The entire block is enclosed in a paragraph (<code>&lt;p&gt;</code>) tag so that is appears on a single line. It can be broken down into the label that occurs before the input slider which is given the id <code>nRadius-value</code> and the <code>input</code> proper. </p>

<p>The <code>for</code> attribute of the <code>label</code> tag equals to the id attribute of the input element to bind them together. This allows us to update the text later as the slider is moved.</p>

<p>The <code>input</code> tag can include four attributes that specify restrictions on the operation of the slider;</p>

<ul>
  <li>
<code>max</code>: specifies the maximum value allowed</li>
  <li>
<code>min</code>: specifies the minimum value allowed</li>
  <li>
<code>step</code>: specifies the number intervals as you move the slider</li>
  <li>
<code>value</code>: Specifies the default value</li>
</ul>

<p>The <code>id</code>s supplied for both the label and the input are important since they provide the reference for our d3.js script. </p>

<p>The first portion of our JavaScript is fairly routine if you’ve been following along with the rest of the book.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw the circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>   
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">120</code><code class="p">);</code>
</pre></div>

</figure>

<p>We append an SVG element to the <code>body</code> of our page and then we append a circle with some particular styling to the SVG element.</p>

<p>Then things start to get more interesting…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">update</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>We select our input using the <code>id</code> that we had declared earlier in the html (<code>nRadius</code>). Then we use the <code>.on</code> operator which adds what is called an ‘<a href="https://github.com/mbostock/d3/wiki/Selections#on">event listener</a>’ to the element so that when there is a change in the element (in this case an adjustment of the slider of the input) a function is called (<code>function()</code>) that in turn calls the <code>update</code> function with the value from the input (<code>+this.value</code>). We haven’t seen the <code>update</code> function yet, but never fear, it’s coming.</p>

<p>We also call the update function with a specific value in the next line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">update</code><code class="p">(</code><code class="mi">120</code><code class="p">);</code>
</pre></div>

</figure>

<p>This might seem slightly redundant, but unless the function gets a value, the text associated with the range input doesn’t get a reading and remains on ‘…’ until the slider is moved.</p>

<p>Lastly we have our <code>update</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>

  <code class="c1">// update the circle radius</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The first part of the function selects the <code>label</code> associated with our input (with the <code>id</code>, <code>nRadius-value</code>) and applies the vaule that has been passed into the function (<code>nRadius</code>). The next line selects the input itself and applies the value to it (this would be the equivalent of having <code>value="&lt;number here&gt;"</code> as a property in the html).</p>

<p>Lastly, we select the circle element and apply the new radius value based on our input value <code>nRadius</code> (<code>.attr("r", nRadius)</code>). </p>

<p>And there we have it, a fully adjustable radius for our circle controlled with an HTML input.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/input-03.png" alt="Maximum radius for our circle">
  <figcaption>Maximum radius for our circle</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-using-more-than-one-input">Using more than one input</h4>

<p>In this example we will use two separate inputs (range type) to adjust the height and width of a rectangle.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/input-04.png" alt="Dual inputs">
  <figcaption>Dual inputs</figcaption>
</figure>


<p>This is not too much of a stretch from the previous single input example with the radius of a circle, but it may be useful to reinforce the concept and illustrate something slightly different.</p>

<h5 id="leanpub-auto-the-code-2">The code</h5>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/10633192">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/10633192">GitHub</a>. It is also available as the file ‘input-double.html’ as a separate download with D3 Tips and Tricks. A copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Double Input Test<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nHeight"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         height = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"280"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nWidth"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         width = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"400"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw a rectangle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>

<code class="c1">// read a change in the height input</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateHeight</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// read a change in the width input</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateWidth</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// update the values</code>
<code class="nx">updateHeight</code><code class="p">(</code><code class="mi">150</code><code class="p">);</code>
<code class="nx">updateWidth</code><code class="p">(</code><code class="mi">100</code><code class="p">);</code>

<code class="c1">// Update the height attributes</code>
<code class="kd">function</code> <code class="nx">updateHeight</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code>

  <code class="c1">// update the rectangle height</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="o">-</code><code class="p">(</code><code class="nx">nHeight</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code> 
<code class="p">}</code>

<code class="c1">// Update the width attributes</code>
<code class="kd">function</code> <code class="nx">updateWidth</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>

  <code class="c1">// update the rectangle width</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">300</code><code class="o">-</code><code class="p">(</code><code class="nx">nWidth</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-the-explanation-1">The explanation</h5>

<p>For the sake of brevity, this explanation will simply concentrate on the differences between the previous single input example and this one.</p>

<p>The declarations for the inputs in the HTML at the start of the code are simply duplicates of each other in terms of function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nHeight"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         height = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"280"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nWidth"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         width = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"400"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The only significant difference is the declaration of the <code>id</code>’s for each input and it’s respective label.</p>

<p>The JavaScript selection of the inputs is more duplication;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateHeight</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateWidth</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>Again the only substantive difference is the use of the appropriate <code>id</code> values.</p>

<p>The updating of the width and height is done via two different functions;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">updateHeight</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code>

  <code class="c1">// update the rectangle height</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="o">-</code><code class="p">(</code><code class="nx">nHeight</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code> 
<code class="p">}</code>

<code class="c1">// Update the width attributes</code>
<code class="kd">function</code> <code class="nx">updateWidth</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>

  <code class="c1">// update the rectangle width</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">300</code><code class="o">-</code><code class="p">(</code><code class="nx">nWidth</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The rectangle is selected using a common <code>rect</code> designator, so multiple rectangles could be controlled. But each function controls only a specific attribute (height or width).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-rotate-text-with-an-input">Rotate text with an input</h4>

<p>This example is really just a derivative of the adjustment of a single attribute of an element.</p>

<p>I happen to think it’s just a little bit ‘neater’ because it includes text, but in reality, it’s just another attribute that can be adjusted.</p>

<p>Here we let our range input adjust the rotation of a piece of text.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/input-05.png" alt="Text rotation with an input">
  <figcaption>Text rotation with an input</figcaption>
</figure>


<h5 id="leanpub-auto-the-explanation-2">The explanation</h5>

<p>We’ll dispense with the full code listing since it’s just a regurgitation of the adjusting of the radius of the circle example, but the code for the example is available online at <a href="http://bl.ocks.org/d3noob/10633421">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/10633421">GitHub</a>. It is also available as the file ‘input-text-rotate.html’ as a separate download with D3 Tips and Tricks. A copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<p>The only, thing of even a slight difference (other than some naming conventions) is the initial drawing of the text…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,150) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3noob.org"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and the update function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nAngle</code><code class="p">);</code>

  <code class="c1">// rotate the text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,150) rotate("</code><code class="o">+</code><code class="nx">nAngle</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h4 id="leanpub-auto-use-a-number-input-with-d3js">Use a <code>number</code> input with d3.js</h4>

<p>There are obviously different inputs that can be selected. The following example still rotates our text, but uses a <code>number</code> type of input to do it;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nValue"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         angle = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nValue-value"</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"number"</code> <code class="na">min</code><code class="o">=</code><code class="s">"0"</code> <code class="na">max</code><code class="o">=</code><code class="s">"360"</code> <code class="na">step</code><code class="o">=</code><code class="s">"5"</code> <code class="na">value</code><code class="o">=</code><code class="s">"0"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nValue"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>we have set the <code>step</code> value to speed things up a bit when rotating, but it’s completely optional.</p>

<p>The input itself can be adjusted up or down using a mouse click or have a number typed into the input box.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/input-06.png" alt="Text rotation with a number input">
  <figcaption>Text rotation with a number input</figcaption>
</figure>


<p>This type of input is slightly different from the range type since it isn’t fully supported under Firefox and as a result when I was testing it the arrow keys for going up and down weren’t present.</p>

<p>The full code for the example is available online at <a href="http://bl.ocks.org/d3noob/10633704">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/10633704">GitHub</a>. It is also available as the file ‘input-number-text.html’ as a separate download with D3 Tips and Tricks. A copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-change-more-than-one-element-with-an-input">Change more than one element with an input</h4>

<p>The final example looking at using HTML inputs with d3.js incorporates a single input acting or two different elements. This might seem self evident, but if you’re as unfamiliar with HTML as I am (it’s embarrassing I know, but what can you do?) it may be of assistance.</p>

<p>The end result is to produce a single slider as a <code>range</code> input that rotates two separate text objects in different directions simultaneously.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/input-07.png" alt="Dual text rotation">
  <figcaption>Dual text rotation</figcaption>
</figure>


<h5 id="leanpub-auto-the-code-3">The code</h5>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/10633856">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/10633856">GitHub</a>. It is also available as the file ‘input-text-rotate-2.html’ as a separate download with D3 Tips and Tricks. A copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Input test<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nAngle"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         angle = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nAngle-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"0"</code> <code class="na">max</code><code class="o">=</code><code class="s">"360"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nAngle"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw d3.js text</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3js"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3.js"</code><code class="p">);</code>

<code class="c1">// draw d3noob.org text</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3noob"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3noob.org"</code><code class="p">);</code>

<code class="c1">// when the input range changes update the rectangle </code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">update</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// Initial starting height of the rectangle </code>
<code class="nx">update</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>

<code class="c1">// update the elements</code>
<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">)</code> <code class="p">{</code>

<code class="c1">// adjust the range text</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nAngle</code><code class="p">);</code>

  <code class="c1">// adjust d3.js text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3js"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate("</code><code class="o">+</code><code class="nx">nAngle</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>

  <code class="c1">// adjust d3noob.org text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3noob"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate("</code><code class="o">+</code><code class="p">(</code><code class="mi">360</code> <code class="o">-</code> <code class="nx">nAngle</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-the-explanation-3">The explanation</h5>

<p>The explanation for this example differes from the others in the way that the d3.js elements (the two pieces of text) are initially appended and then updated.</p>

<p>When they are initially drawn…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3js"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3.js"</code><code class="p">);</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3noob"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3noob.org"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… both elements are declared with a <code>class</code> attribute that serves as a reference for the future updating. Here, the text ‘d3.js’ is given a <code>class</code> name of <code>d3js</code> and the text ‘d3noob.org’ is given a <code>class</code> name of <code>d3noob</code>.</p>

<p>Then when we call the <code>update</code> function each of the two text elements is adjusted seperately by selecting each based on the <code>class</code> name that was applied in the initial setup;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">)</code> <code class="p">{</code>

<code class="c1">// adjust the range text</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nAngle</code><code class="p">);</code>

  <code class="c1">// adjust d3.js text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3js"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate("</code><code class="o">+</code><code class="nx">nAngle</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>

  <code class="c1">// adjust d3noob.org text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3noob"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate("</code><code class="o">+</code><code class="p">(</code><code class="mi">360</code> <code class="o">-</code> <code class="nx">nAngle</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>So the ‘d3.js’ text is selected using <code>text.d3js</code> and ‘d3noob.org’ is selected using <code>text.d3noob</code>. That’s a pretty neat trick and a good lesson for applying specific transformations to specific objects.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-add-an-html-table-to-your-graph">Add an HTML table to your graph</h3>

<p>So graphs and graphics are D3’s bread and butter you’d think. Hmm…</p>

<p>Well yes and no.</p>

<p>Yes D3 has extraordinary powers for presenting and manipulating images in a web page. But if you’ve read through the entirety of the d3.js main site (haven’t we all) you will recall that D3 actually stands for Data Driven Documents. It’s not necessarily about the pretty pictures and the swirling cascade of colour. It’s about generating something in a web browser based on data.</p>

<p>This transitions nicely into consideration of adding a table of information that can accompany your graph (it could just as easily (or easier) stand alone, but for the sake of continuity, we’ll use the graph).</p>

<p>What we’ll do is add the data that we’ve used to make our graph under the graph itself. To make sure that it’s all nicely aligned, we’ll place it in a table.</p>

<p>It should end up looking a little like this (and this has been cropped slightly at the bottom to avoid expanding the page with rows of numbers / dates).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table01.png" alt="Basic graph with a table of data">
  <figcaption>Basic graph with a table of data</figcaption>
</figure>


<p>The code was drawn from an example provided by <a href="http://jsfiddle.net/7WQjr/">Shawn Allen</a> on <a href="http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-to-a-csv-file">Google Groups</a>. In fact, the post itself is an excellent one if you are considering creating a table straight from a csv file.</p>

<h4 id="leanpub-auto-html-tables">HTML Tables</h4>

<aside class="information blurb">
    <p>I’m walking a fine line here since I have a remarkably small amount of knowledge on HTML tables. So I’ll try to provide a brief overview as I understand it and as I see it represented in the code below, but for a far fuller explanation, take a look at some great work by <a href="http://prcweb.co.uk/lab/selection/">Peter Cook here</a> or let Google be your friend.</p>

</aside>

<p>Tables are made up of rows, columns and data (that goes in each cell). All you need to do to successfully place a table on a web page is to lay out the rows and columns in a logical sequence using the appropriate HTML tags and you’re away.</p>

<p>For example here’s the total HTML code for a web page to display a simple table;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">table</code> <code class="na">border</code><code class="o">=</code><code class="s">"1"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Header 1<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Header 2<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 1, cell 1<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 1, cell 2<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 2, cell 1<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 2, cell 2<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This will result in a table that looks a little like this in a web browser;</p>

<table style="width: 80%;">
  <tbody>
    <tr>
      <td><strong>Header 1</strong></td>
      <td><strong>Header 2</strong></td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <td>row 1, cell 1</td>
      <td>row 1, cell 2</td>
    </tr>
    <tr>
      <td>row 2, cell 1</td>
      <td>row 2, cell 2</td>
    </tr>
  </tfoot>

</table>

<p>The entire table itself is enclosed in <code>&lt;table&gt;</code> tags. Each row is enclosed in <code>&lt;tr&gt;</code>  tags. Each row has two items which equate to the two columns. Each piece of data for each cell is enclosed in a <code>&lt;td&gt;</code>  tag except for the first row, which is a header and therefore has a special tag <code>&lt;th&gt;</code> that denotes it as a header making it bold and centred. For the sake of ease of viewing we have told the table to place a border around each cell and we do this in the first <code>&lt;table&gt;</code> tag with the <code>border="1"</code> statement (although in this book view it may be absent).</p>

<aside class="information blurb">
    <p>The good news is that you don’t need to fully understand all this, but it will help with the explanation of what we’re doing in the code below.</p>

</aside>

<p>There are three main things you need to do to the basic line graph to get your table to display.</p>

<ol class="numeric">
  <li>Add some CSS</li>
  <li>Add some table building d3.js code</li>
  <li>Make a small but cunning change…</li>
</ol>

<p>There is a copy of the code and the data file for this example at <a href="https://gist.github.com/d3noob/473f0cf66196a008cf99">github</a> and in the code samples bundled with this book (simple-graph-plus-table.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/473f0cf66196a008cf99">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-first-the-css">First the CSS</h4>

<p>This just helps the table with formatting and making sure the individual cells are spaced appropriately;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">td</code><code class="o">,</code> <code class="nt">th</code> <code class="p">{</code>
    <code class="nb">padding</code><code class="o">:</code> <code class="m">1px</code> <code class="m">4px</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>This sets a padding of 1 px around each cell and 4 px between each column.</p>

<aside class="tip blurb">
    <p>Feel free to play with the figures to suit your application, I’ve just set them there because I thought they looked appropriate.</p>

</aside>

<p>I’ve placed this portion of CSS at the end of our <code>&lt;style&gt;</code> section.</p>

<h4 id="leanpub-auto-now-the-d3js-code">Now the d3.js code</h4>

<p>Oki doki… Hopefully you have a loose understanding of the html layout of a table as explained above, but if not you can always go with the ‘it just works’ approach.</p>

<p>Here’s what we should add into our simple graph example;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 250px"</code><code class="p">),</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>

    <code class="c1">// append the header row</code>
    <code class="nx">thead</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">columns</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">column</code><code class="p">;</code> <code class="p">});</code>

    <code class="c1">// create a row for each object in the data</code>
    <code class="kd">var</code> <code class="nx">rows</code> <code class="o">=</code> <code class="nx">tbody</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">);</code>

    <code class="c1">// create a cell in each row for each column</code>
    <code class="kd">var</code> <code class="nx">cells</code> <code class="o">=</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">row</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">columns</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code><code class="nx">column</code><code class="o">:</code> <code class="nx">column</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">row</code><code class="p">[</code><code class="nx">column</code><code class="p">]};</code>
            <code class="p">});</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"font-family: Courier"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
    
    <code class="k">return</code> <code class="nx">table</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// render the table</code>
 <code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">]);</code>
</pre></div>

</figure>

<p>And we should take care to add it into the code at the end of the portion where we’ve finished drawing the graph, but before the enclosing curly and regular brackets that complete the portion of the graph that has loaded our data.csv file. This is because we want our new piece of code to have access to that data and if we place it after those brackets it won’t know what data to display.</p>

<p>So, right about here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="c1">// Add the Y Axis</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
                                 <code class="c1">// &lt;= Add the code right here!</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>Now, we’re going to break with tradition a bit here and examine what our current state of code produces. Then we’re going to explain something different. <em>THEN</em> we’re going to come back and explain the code… </p>

<p>Check it out…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table02.png" alt="Woah! What happened to the date?">
  <figcaption>Woah! What happened to the date?</figcaption>
</figure>


<p>Not quite as we has originally envisaged?</p>

<p>Indeed, the date has taken it upon itself to expand from a relatively modest format of day-abbreviated month-two digit year (30-Apr-12) to a behemoth of a thing (Mon Apr 30 2012 00:00:00 GMT+1200 (New Zealand Standard Time)) that we certainly didn’t intend, let alone have in our data.csv file.</p>

<p>What’s going on here?</p>

<p>Well, To be perfectly frank, I’m not entirely sure. But this is what I’m going to propose. The JavaScript code recognises and deals with the ‘date’ variable as being a date/time. So that when we proceed to display the variable on the screen, the browser says, “this is a date / time formatted piece of data, therefore it must be formatted in the following way”. I had a play with a few ideas to correct it via an HTML formatting instruction, but drew a blank and then I stumbled on another way to solve the problem. Hence the third small but cunning change to our original code.</p>

<h4 id="leanpub-auto-a-small-but-cunning-change">A small but cunning change…</h4>

<p>So… Our table has decided to develop a mind of it’s own and format the date time as it sees fit. Well fair enough (I for one welcome our web time formatting overlords). So how do we convince it to display the values in their natural form?</p>

<p>Well, one solution that we could employ is to not tell the JavaScript that our <code>date</code> value in the data is actually time. In that condition, the code should treat the values as an ordinary string and print it directly as it appears.</p>

<p>The good news is that this is pretty easy to do. Where originally we had a block of data that consisted of <code>date</code> and <code>close</code>, all at different times, we will now add a new variable called <code>date1</code> which will be the variable that we convert to a time and draw the graph with. Leaving <code>date</code> to be the text string that will be printed in our table.</p>

<p>How to do it?</p>

<p>It’s actually remarkably easy. Just change the following lines in the basic line graph code to amend <code>date</code> to <code>date1</code> and you’re good to go.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date1</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">d</code><code class="p">.</code><code class="nx">date1</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date1</code><code class="p">;</code> <code class="p">}));</code>
</pre></div>

</figure>

<p>The middle line is probably the most significant, since this is the point where we declare <code>date1</code>, assign a time format and bring a new column of data into being. The others simply refer to the data.</p>

<p>So we’ll make those small changes and now we can return to explain the d3.js code…</p>

<h4 id="leanpub-auto-explaining-the-d3js-code-reloaded">Explaining the d3.js code (reloaded).</h4>

<p>So back we come to explain what is going on in the d3.js code that we presented a page or two back. Obviously it’s a fairly large chunk, and we can first break it down into two chunks.
The first chunk we’ll look at is in fact the last part of the code that look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// render the table</code>
 <code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">]);</code>
</pre></div>

</figure>

<p>This portion simply calls the <code>tabulate</code> function using the <code>date</code> and <code>close</code> columns of our <code>data</code> array. Simply add or remove whichever columns you want to appear in your table (so long as they are in your data.csv file) and they will be in your table. The tabulate function makes up all of the other part of the added code.
So we come to the first block of the tabulate function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 250px"</code><code class="p">),</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here the tabulate function is declared (<code>function tabulate</code>) and the variables that the function will be using are specified (<code>(data, columns)</code>). In our case <code>data</code> is of course our <code>data</code> array and <code>columns</code> refers to <code>["date", "close"]</code>.</p>

<p>The next line appends the table to the <code>body</code> of the web page (so it will occur just under the graph in this case). The I do something just slightly sneaky. The line <code>.attr("style", "margin-left: 250px"),</code> is actually not the code that was used to produce the table with the huge date/ time formatted info on. I deliberately used <code>.attr("style", "margin-left: 0px"),</code> for the huge date / time table since it’s job is to indent the table by a specified amount from the left hand side of the page. And since the huge date time values would have pushed the table severely to the right, I cheated and used <code>0</code> instead of <code>250</code>. For the purposes of the final example where the date / time values are formatted as expected, <code>250</code> is a good value.</p>

<p>The next two lines declare the functions we will use to add in the header cells (since they use the <code>&lt;th&gt;</code> tags for content) and the cells for the main body of the table (they use <code>&lt;td&gt;</code>).</p>

<p>The next block of code adds in the header row;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">thead</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">columns</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">column</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>Here we first append a row tag (<code>&lt;tr&gt;</code>), then we gather all the <code>columns</code> that we have in our function (remember they were <code>["date", "close"]</code> and add them to our row using header tags (<code>&lt;th&gt;</code>).</p>

<p>The next block of code assigns the <code>row</code> variable to return (append) a row tag (<code>&lt;tr&gt;</code>) whenever it’s called …</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">rows</code> <code class="o">=</code> <code class="nx">tbody</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and it is in the following block of code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">cells</code> <code class="o">=</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">row</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">columns</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code><code class="nx">column</code><code class="o">:</code> <code class="nx">column</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">row</code><code class="p">[</code><code class="nx">column</code><code class="p">]};</code>
            <code class="p">});</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"font-family: Courier"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>… where we select each row that we’ve added (<code>var cells = rows.selectAll("td")</code>). Then the following five lines works out from the intersection of the row and column which piece of data we’re looking at for each cell.</p>

<p>Then the last four lines take that piece of data (<code>d.value</code>) and wrap it in table data tags (<code>&lt;td&gt;</code>) and place it in the correct cell as HTML.</p>

<p>It’s a very neat piece of code and I struggle to get my head around it, but that doesn’t mean that I can’t appreciate the cleverness of it :-).</p>

<h4 id="leanpub-auto-wrap-up-1">Wrap up</h4>

<p>So there we have it. Hopefully enough to explain what is going on and perhaps also enough to convince ourselves that D3 is indeed more than just pretty pictures. It’s all about the Data Driven Documents.</p>

<p>This file has been saved as table-plus-graph.html and has been added into the downloads section on d3noob.org with the general examples files.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-more-table-madness-sorting-prettifying-and-adding-columns">More table madness: sorting, prettifying and adding columns</h3>

<p>When we last left our tables they were happily producing a faithful list of the data points that we had in our graph.</p>

<p>But what if we wanted more?</p>

<p>From the original contributors that bought you tables (<a href="http://jsfiddle.net/7WQjr/">Shawn Allen</a> on <a href="http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-to-a-csv-file">Google Groups</a>) and some neat additions from <a href="http://christopheviau.com/d3_tutorial/">Christophe Viau</a> comes extra coolness that I didn’t include in the previous example :-).</p>

<p>There is a copy of the code and the data file for this example at <a href="https://gist.github.com/d3noob/5d47df5374d210b6f651">github</a> and in the code samples bundled with this book (simple-graph-plus-table-plus-addins.html and data2.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/5d47df5374d210b6f651">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-add-another-column-of-information">Add another column of information:</h4>

<p>Firstly, lets add another column of data to our table. To do this we want to have something extra in our csv file to use, so let’s resurrect our old friend data2.csv that we used for the graph with two lines previously. All we have to do to make this a reality is change the reference that loads <code>data.csv</code> to <code>data2.csv</code> here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data2.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<aside class="tip blurb">
    <p>This makes the assumption that you still have the data2.csv file in place. If not, rush away and get it from the download of code samples from Leanpub.</p>

</aside>

<p>From here (and as promised in the previous chapter), it’s just a matter of adding in the extra column you want (in this case it’s the <code>open</code> column) like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">,</code> <code class="s2">"open"</code><code class="p">]);</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table03.png" alt="Table with extra column">
  <figcaption>Table with extra column</figcaption>
</figure>


<aside class="information blurb">
    <p>Yes, if you’re wondering, I have cheated slightly and changed the table indent to make it look slightly prettier.</p>

</aside>

<p>So can we go further?</p>

<p>You know we can…</p>

<p>In the section where we get our data and format it, lets add another column to our array in the form of a difference between the <code>close</code> value and the <code>open</code> value (and we’ll call it <code>diff</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data2.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code> 
        <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">d</code><code class="p">.</code><code class="nx">date1</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
                <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
                <code class="nx">d</code><code class="p">.</code><code class="nx">open</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">;</code>  <code class="c1">//  &lt;= added this for tidy house keeping</code>
                <code class="nx">d</code><code class="p">.</code><code class="nx">diff</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">round</code><code class="p">((</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">open</code> <code class="p">)</code> <code class="o">*</code> <code class="mi">100</code> <code class="p">)</code> <code class="o">/</code> <code class="mi">100</code><code class="p">;</code>
        <code class="p">});</code>
</pre></div>

</figure>

<p>(the <code>Math.round</code> function is to make sure we get a reasonable figure to display, otherwise it tends to get carried away with decimal places)</p>

<p>So now we add in our new column (<code>diff</code>) to be tabulated;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">,</code> <code class="s2">"open"</code><code class="p">,</code> <code class="s2">"diff"</code><code class="p">]);</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table04.png" alt="Table with extra extra column">
  <figcaption>Table with extra extra column</figcaption>
</figure>


<aside class="information blurb">
    <p>And yes, I changed the table indent again. I am a serial offender and will continue to change it to suit.</p>

</aside>

<h4 id="leanpub-auto-sorting-on-a-column">Sorting on a column</h4>

<p>So now with our four columns of awesome data, it turns out that we’re really interested in the ones that have the highest <code>close</code> values. So we can sort on the <code>close</code> column by adding the following lines directly after the line where we declare the <code>peopleTable</code> function (which I will include in the code snipped below for reference).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">,</code> <code class="s2">"open"</code><code class="p">,</code> <code class="s2">"diff"</code><code class="p">]);</code> 

<code class="nx">peopleTable</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"tbody tr"</code><code class="p">)</code> 
        <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">descending</code><code class="p">(</code><code class="nx">a</code><code class="p">.</code><code class="nx">close</code><code class="p">,</code> <code class="nx">b</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code>
        <code class="p">});</code>
</pre></div>

</figure>

<p>Which works magnificently;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table05.png" alt="Table sorted descending on 'close'">
  <figcaption>Table sorted descending on ‘close’</figcaption>
</figure>


<h4 id="leanpub-auto-prettifying-actually-just-capitalising-the-header-for-each-column">Prettifying (actually just capitalising the header for each column)</h4>

<p>Just a little snippet that capitalises the headers for each row to make them look slightly more authoritative.</p>

<p>Add the following lines of code directly below the block that you just added for sorting the table;</p>

<figure class="code">
<div class="highlight"><pre><code></code> <code class="nx">peopleTable</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"thead th"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">column</code><code class="p">.</code><code class="nx">charAt</code><code class="p">(</code><code class="mi">0</code><code class="p">).</code><code class="nx">toUpperCase</code><code class="p">()</code> <code class="o">+</code> <code class="nx">column</code><code class="p">.</code><code class="nx">substr</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
        <code class="p">});</code>
</pre></div>

</figure>

<p>This is quite a tidy little piece of script. You can see it selecting the headers (<code>selectAll("thead th")</code>), then the first character in each header (<code>column.charAt(0)</code>), changing it to upper-case (<code>.toUpperCase()</code>) and adding it back to the rest of the string (<code>+ column.substr(1)</code>).</p>

<p>With the ultimate result…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table06.png" alt="Table with capitalised first characters in headers">
  <figcaption>Table with capitalised first characters in headers</figcaption>
</figure>


<h4 id="leanpub-auto-add-borders">Add borders</h4>

<p>Sure our table looks nice and neatly arranged, but would a border look better? </p>

<p>Well, here’s one way to do it;</p>

<p>All we need to do is add a border style to our table by adding in this line here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 200px"</code><code class="p">)</code> <code class="c1">// &lt;= Remove the comma</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"border"</code><code class="p">,</code> <code class="s2">"2px black solid"</code><code class="p">),</code> <code class="c1">// &lt;= Add this line in</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>
</pre></div>

</figure>

<p>(don’t forget to move the comma from the end of the <code>margin-left</code> line)</p>

<p>And the result is a tidy black border.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table07.png" alt="Table with a border">
  <figcaption>Table with a border</figcaption>
</figure>


<p>OK, so what about the individual cells?</p>

<p>No problem.</p>

<p>If we remember back to our CSS that we added in, we’ll just tell each cell that we want a 1 pixel border buy amending the CSS for our table to this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">td</code><code class="o">,</code> <code class="nt">th</code> <code class="p">{</code>
    <code class="nb">padding</code><code class="o">:</code> <code class="m">1px</code> <code class="m">4px</code><code class="p">;</code>
    <code class="nb">border</code><code class="o">:</code> <code class="m">1px</code> <code class="nb">black</code> <code class="nb">solid</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>So now each cell has a slightly more subtle border like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table08.png" alt="Table with cells with individual borders">
  <figcaption>Table with cells with individual borders</figcaption>
</figure>


<p>Yikes! Not quite as subtle as I would have expected. I suppose it’s another example of the code actually doing what you asked it to do. No problem, <code>border-collapse</code> to the rescue. Add the following line into here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 200px"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"border-collapse"</code><code class="p">,</code> <code class="s2">"collapse"</code><code class="p">)</code>   <code class="c1">// &lt;= Add this line in.</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"border"</code><code class="p">,</code> <code class="s2">"2px black solid"</code><code class="p">),</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>
</pre></div>

</figure>

<p>How does that look?</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/table09.png" alt="Table with cells with collapsed borders">
  <figcaption>Table with cells with collapsed borders</figcaption>
</figure>


<p>Ahh…. Much more refined.</p>

<aside class="information blurb">
    <p>The <code>border-collapse</code> style tells the table to overlap each cell’s borders, rather than treat them as discrete entities. So in this case it looks a bit better.</p>

</aside>

<div class="page-break"></div>
<h3 id="leanpub-auto-adding-web-links-to-d3js-objects">Adding web links to d3.js objects</h3>

<p>The idea with this tip / trick is to be able to add a ‘link’ to an object so that when you click on it, it takes you to a web page that we will pre-define.</p>

<p>We are going to generate a simple rectangle with some text and look at linking from the rectangle and the text separately and with some fanciness at the end :-).</p>

<p>The end result will be something that looks a little like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/xlink-01.png" alt="Objects with links">
  <figcaption>Objects with links</figcaption>
</figure>


<p>(Notice the little pointing finger at the bottom that would indicate that there actually <em>is</em> a link there.)</p>

<p>The code that we will use as a starting point is this simple example that draws a green rectangle and overlays some text on it;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
 
<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">449</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">249</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">word</code> <code class="o">=</code> <code class="s2">"gongoozler"</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw a rectangle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>  
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightgreen"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>

<code class="c1">// draw text on the screen</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>There’s nothing too spectacular about the file. There’s a little bit of styling and tweaking of attributes, but nothing too extreme. The only slightly ‘odd’ part would be defining the word that is printed out as a variable (<code>var word = "gongoozler";</code>) and then adding it as a variable (<code>.text(word);</code>) instead of just putting the word directly in there (which we could do like this <code>.text("gongoozler");</code>). We’re going to do this deliberately to explore additional options for making our links a little more dynamic.</p>

<h4 id="leanpub-auto-its-all-about-the-a-and-the-xlink">It’s all about the ‘a’ and the ‘xlink’</h4>

<p>The <code>&lt;a&gt;</code> tag in an HTML file defines a <a href="http://www.w3schools.com/html/html_links.asp">hyperlink</a>. Items bounded by an <code>&lt;a&gt;</code> tag will become a link to another web address. So what we will do is create an <code>&lt;a&gt;</code> tag and then append our d3.js, svg object to it.</p>

<p>Of course as well as including a link, we need to tell it where to go. We do this by setting the <code>xlink:href</code> attribute for our tag to point to a specific page. Xlink is short for XML Linking Language and it is used to create hyperlinks in XML documents. In our case we will be defining the link that we will want our user to go to.</p>

<h4 id="leanpub-auto-adding-in-the-links">Adding in the links</h4>

<p>The following is the adjusted code for our rectangle that adds in the <code>&lt;a&gt;</code> tag with the <code>xlink:href</code> attribute.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"http://en.wikipedia.org"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>  
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightgreen"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
</pre></div>

</figure>

<p>It’s important to append the link before the object (otherwise it won’t work) but other than that, it’s a pretty simple job.</p>

<p>The only fly in the ointment is that while we now have a rectangle that links to Wikipedia, if we hover our mouse over the text, we lose our link (since we haven’t told the text to link anywhere).</p>

<p>We can remedy that by doing exactly the same thing with the text element;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"http://en.wikipedia.org/wiki/"</code><code class="o">+</code><code class="nx">word</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>
</pre></div>

</figure>

<p>The only slight difference here is that we have used the address for Wikipedia as our base and added the variable for our word to the end of it so that the resulting web address takes us to Wikipedia and the specific page for the word ‘gongoozler’. Hopefully this will indicate that if we had a set of variables in an array we would make our links a little more dynamic.</p>

<h4 id="leanpub-auto-making-the-mouse-pointer-ignore-an-object">Making the mouse pointer ignore an object</h4>

<p>So in theory we’re done, but in practice this has been a slightly crude method for adding what should be a <em>single</em> link to two objects when we should be able to accomplish it by defining the link once. </p>

<p>What we could do as an alternative to linking both the rectangle and the text using two separate links is to make the mouse ignore the text and have it rely solely on the rectangle. We can do this using the <code>pointer-events</code> style when drawing our text. By setting it to <code>none</code> we are instructing our mouse to ignore any potential interaction with the text when it hovers over it and instead the pointer will register the link on the rectangle below it.</p>

<p>The code for the text therefore becomes…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>
</pre></div>

</figure>

<p>And as you can see from the image below, the pointer will happily ignore the text while reading the link from the rectangle.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/xlink-02.png" alt="Objects with links">
  <figcaption>Objects with links</figcaption>
</figure>


<p>The complete code for this example is available in the appendices and a live version can be found on <a href="http://bl.ocks.org/d3noob/8150631">bl.ocks.org</a> and <a href="https://gist.github.com/d3noob/8150631">GitHub</a>. The code is also in the downloadable files available from Leanpub with the book in a file called ‘xlink-rect&amp;pointerevents.html’.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-understanding-javascript-object-notation-json">Understanding JavaScript Object Notation (JSON)</h3>

<p>One of the most useful things you might want to learn when understanding how to present your data with D3 is how to <em>structure</em> your data so that it is easy to use.</p>

<p>As explained earlier in the book, there are several different types of data that can be requested by D3 including text, Extensible Markup Language (xml), HyperText Markup Language (html), Comma Separated Values (csv), Tab Separated Values (tsv) and JavaScript Object Notation (json).</p>

<p>Comma separated values and tab separated values are fairly well understood forms of data. They are expressed as rows and columns of information that are separated using a known character. While these forms of data are simple to understand, it is not easy to incorporate a hierarchy structure to the data, and when you try, it isn’t natural and makes managing the data difficult.</p>

<p>JavaScript Object Notation (JSON) presents a different mechanism for storing data. A light weight description could read “JSON is a text-based open standard designed to present human-readable data. It is derived from the JavaScript scripting language, but it is language and platform independent.”</p>

<p>Unfortunately, when I first started using JSON, I struggled with the concept of how it was structured, in spite of some fine descriptions on the web (start with <a href="http://www.json.org/">http://www.json.org/</a> in my humble opinion). So the following is how I came to think of and understand JSON.</p>

<aside class="warning blurb">
    <p><strong>Fair Warning:</strong> This advice is no substitute for the correct explanation of the topic of data structures that I’m sure you could receive from a reputable educational site or institution. It’s just the way I like to think of it :-). It’s also just the way that I <em>started</em> to understand JSON. There is plenty to learn and understand once you grasp the basics. So this isn’t a complete guide. Just the beginnings.</p>

</aside>

<p>In the following steps we’ll go through a process that (hopefully) demonstrates that we can transform identifiers that would represent the closing price for a stock of 58.3 on 2013-03-14 into more traditional x,y coordinates.</p>

<p>I think of data as having an identifier and a value.</p>

<figure class="code">
<div class="highlight"><pre><code></code>identifier: value
</pre></div>

</figure>

<p>If a point on a graph is located at the x,y coordinates 150,25 then the identifier ‘x’ has a value 150. </p>

<figure class="code">
<div class="highlight"><pre><code></code>"x": 150
</pre></div>

</figure>

<p>If the x axis was a time-line, the true value for ‘x’ could be “2013-03-14”. </p>

<figure class="code">
<div class="highlight"><pre><code></code>"x": "2013-03-14"
</pre></div>

</figure>

<p>This example might look similar to those seen by users of d3.js, since if we’re using date / time format we can let D3 sort out the messy parts like what coordinates to provide for the screen.</p>

<p>And there’s no reason why we couldn’t give the ‘x’ identifier a more human readable label such as “date”. So our data would look like;</p>

<figure class="code">
<div class="highlight"><pre><code></code>"date": "2013-03-14"
</pre></div>

</figure>

<p>This is only one part of our original x,y = 150,25 data set. The same way that the x value represented a position on the x axis that was really a date, the y value represents a position on the y axis that is really another number. It only gets converted to 25 when we need to plot a position on a graph at 150,25. If the ‘y’ component represents the closing price of a stock we could take the same principles used to transform… </p>

<figure class="code">
<div class="highlight"><pre><code></code>"x": 150
</pre></div>

</figure>

<p>… into …</p>

<figure class="code">
<div class="highlight"><pre><code></code>"date": "2013-03-14"
</pre></div>

</figure>

<p>… to change ….</p>

<figure class="code">
<div class="highlight"><pre><code></code>"y": 25
</pre></div>

</figure>

<p>… into …</p>

<figure class="code">
<div class="highlight"><pre><code></code>"close": 58.3
</pre></div>

</figure>

<p>This might sound slightly confusing, so try to think of it this way. We want to plot a point on a graph at 150,25, but the data that this position is derived from is really “2013-03-14”, 58.3. D3 can look after all the scaling and determination of the range so that the point gets plotted at 150,25 and our originating data can now be represented as;</p>

<figure class="code">
<div class="highlight"><pre><code></code>"date": "2013-03-14", "close": 58.3
</pre></div>

</figure>

<p>This represents two separate pieces of data. Each of which has an identifier (“date” or “close”) and a value (“2013-03-14” and 58.3)</p>

<p>If we wanted to have a series of these data points that represented several days of closing prices, we would store them as an array of identifiers and values similar to this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{ "date": "2013-03-14", close: 58.13 },
{ "date": "2013-03-15", close: 53.98 },
{ "date": "2013-03-16", close: 67.00 },
{ "date": "2013-03-17", close: 89.70 },
{ "date": "2013-03-18", close: 99.00 }
</pre></div>

</figure>

<p>Each of the individual elements of the array is enclosed in curly brackets and separated by commas.</p>

<aside class="warning blurb">
    <p>I am making the assumption that you are familiar with the concept of what an ‘array’ is. If this is an unfamiliar word, in the context of data, then I strongly recommend that you do some Goggling to build up some familiarity with the principle.</p>

</aside>

<p>Now that we have an array, we can apply the same rules to it as we did the the item that had a single value. We can give it an identifier all of its own. In this case we will call it “data”. Now we can use our identifier: value analogy to use “data” as the identifier and the array as the value.</p>

<figure class="code">
<div class="highlight"><pre><code></code>{ "data": [
  { "date": "2013-03-14", close: 58.13 },
  { "date": "2013-03-15", close: 53.98 },
  { "date": "2013-03-16", close: 67.00 },
  { "date": "2013-03-17", close: 89.70 },
  { "date": "2013-03-18", close: 99.00 }
] }
</pre></div>

</figure>

<p>The array has been enclosed in square brackets to designate it as an array and the entire identifier: value sequence has been encapsulated with curly braces (much the same way that the subset “date”, “close” values were enclosed with curly braces.</p>

<p>If we try to convey the same principle in a more graphical format, we could show our initial identifier and value for the x component like so;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/iv-01.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>The we can add our additional component for the y value;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/iv-02.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>We can then add several of these combinations together in an array;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/iv-03.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>Then the array becomes a value for another identifier “data”;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/iv-04.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>More complex JSON files will have multiple levels of identifiers and values arranged in complex hierarchies which can be difficult to interpret. However, laying out the data in a logical way in a text file is an excellent way to start to make sense of the data. </p>

<div class="page-break"></div>
<h3 id="leanpub-auto-using-the-yahoo-query-language-yql-to-get-data">Using the Yahoo Query Language (YQL) to get data.</h3>

<p>One of the things that I find frustrating is difficulty getting data to play with. Often I will find myself thinking “It would be neat to see if this technique works” but then I spend a couple of hours looking for data that will be appropriate.</p>

<p>Another difficulty is that access to dynamic data is also problematic. D3.js really shines when displaying information that is changing and interactive. Finding data that is changing and which you can interact with is not easy.</p>

<p>Then, when you do come across a web site that has an interesting data set, accessing that data becomes programmatically difficult because of restrictions in accessing information that crosses domains. A solution to this problem (and there are a few) is to have a data set that is in a domain that permits <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross-Origin Resource Sharing</a> (CORS). These are not as common as you might hope as it presents security concerns that need to be addressed.</p>

<p>One resource that I have come across is particularly useful for solving the problems outlined above is the <a href="http://developer.yahoo.com/yql/">Yahoo! Developer Network</a> which operates a service where you can write a query in an SQL type fashion that will return data in json (or others) format. This query can be formed into an http request so that you can simply paste a generated URL directly into your browsers URL bar and it will return the requested data. Better than that, because it supports CORS (and because d3.js can manage a CORS request without breaking a sweat) all you need to do is put the URL into you code (as a <code>d3.json</code> call for example) and you will be up and running.</p>

<p>In the ‘Examples’ chapter there will be several examples that use YQL queries to retrieve data as is is a great resource.</p>

<h4 id="leanpub-auto-yql-by-example">YQL by example</h4>

<p>I will use an example of looking for current weather information for Wellington New Zealand from the <a href="http://www.wunderground.com/">Weather Underground</a> (wunderground).</p>

<p>In this example, we’re interested in retrieving a JSON ‘blob’ that contains data on the weather conditions (temperature, wind speed / direction, humidity etc) for a specific location.</p>

<p>Start at the page for the console (<a href="http://developer.yahoo.com/yql/console/">http://developer.yahoo.com/yql/console/</a>). On the left there is a range of data ‘topics that you can choose from. We will want to access one of the community tables, so select ‘Show Community Tables’ and scroll down the list until you find ‘wunderground’ and ‘wunderground.currentobservation’ </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/yql-01.png" alt="Select Community Tables and wunderground.currentobservation">
  <figcaption>Select Community Tables and wunderground.currentobservation</figcaption>
</figure>


<p>This will bring up a query in the console that is looking for the current weather from San Francisco International airport.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/yql-02.png" alt="Query for weather from San Francisco">
  <figcaption>Query for weather from San Francisco</figcaption>
</figure>


<p>For our example we want to be a bit more specific, so we replace the ‘SFO’ ‘location’ with ‘Wellington, New Zealand’.</p>

<p>If you then click on the ‘Test’ button the query will run and results will be presented in the box below it;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/yql-03.png" alt="JSON weather from San Francisco">
  <figcaption>JSON weather from San Francisco</figcaption>
</figure>


<p>If that looks like the results you were expecting, fantastic!</p>

<p>The next gem from YQL is the <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> query that is automatically generated at the bottom of the page;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/yql-04.png" alt="REST Query">
  <figcaption>REST Query</figcaption>
</figure>


<p>If you select this query and past it in your URL bar, you will have the JSON data returned into your browser.</p>

<p>At this point it might seem a bit confusing, and if you’re unfamiliar with how JSON based data sets are structured it will DEFINITELY be confusing (You will need to do some research to get up to speed there). My advice is to first understand a bit about JSON and then examine the output from the REST query in the developer console on your browser (this is a fairly long topic in itself, so I will not cover it here sorry). Additionally check out the ‘Examples’ chapter for real world usage.</p>

<p>If you are comfortable with understanding how the data can be encoded, it is then just a matter of including the REST query in your call when selecting data using <code>d3.json</code> and you will be away. </p>

<p>Please check out the examples I will include in the ‘Examples’ chapter for a deeper look at the use of the data with d3.js (This will also help with understanding the JSON structure). </p>

<div class="page-break"></div>
<h3 id="leanpub-auto-using-plunker-for-development-and-hosting-your-d3-creations">Using Plunker for development and hosting your D3 creations.</h3>

<p>Recently Mike Bostock recommended ‘Plunker’ (<a href="http://plnkr.co/">http://plnkr.co/</a>) as a tool for saving work online for collaboration and sharing. Although I had a quick look, I didn’t quite ‘get it’ and although it looked like something that I should be interested in, I (foolishly) moved on to other things.</p>

<p>Quite frankly I should have persevered.</p>

<p>Plunker is awesome.</p>

<p>So what can it do for you?</p>

<p>Well, in short, this gives you a place to put your graphs on the web without the hassle of needing a web server as well as allowing others to view and collaborate! There are some limitations to hosting graphs in this environment, but there’s no denying that for ease of use and visibility to the outside world, it’s outstanding!</p>

<p>Time for an example. I’ll try to go through the process of implementing the simple graph example on Plunker.</p>

<p>So it’s as simple as going to <a href="http://plnkr.co/edit/">http://plnkr.co/edit/</a></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker01.png" alt="Plunker editing page">
  <figcaption>Plunker editing page</figcaption>
</figure>


<p>What you’re seeing here is an area where you can place your entire HTML code. So let’s replace the 11 lines of the place holder code with the simple graph example (just copy and paste it in there over the top of the current 11 lines);</p>

<p>Now, there are two important things we have to do before it will work. </p>

<ol class="numeric">
  <li>We need to tell he script where to find d3.js</li>
  <li>We need to make our data accessible</li>
</ol>

<p>Helping the script find d3.js is nice and easy. Just replace this line in your plunk;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>…with this line…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>That will allow your plunk to use the version of d3.js that is hosted on d3js.org (it uses the minimised version (which is why it has the ‘min’ in it), but never fear, it’s still d3, just distilled to enhance the flavour :-)).</p>

<p>Making our data available is only slightly more difficult. </p>

<p>In experimenting with Plunker, I found that there appears to be something ‘odd’ about accessing tab separated values (in the data.tsv file), however, D3 to the rescue! We can simply use Comma Separated Values (csv) instead.</p>

<p>We will host our data.csv file on plunker as well and there is built in functionality to let us do it.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker02.png" alt="Create a new file">
  <figcaption>Create a new file</figcaption>
</figure>


<p>In the top left hand corner, beside the ‘FILES’ note, there is a ‘+NEW…’ section. Clicking on this will allow you to create another file that will exist with your plunk for its use, so let’s do that.</p>

<p>This will open a dialogue box that will ask you to name your new file. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker03.png" alt="Name your file">
  <figcaption>Name your file</figcaption>
</figure>


<p>Enter the name data.csv.</p>

<p>Now another file has appeared under the ‘Files’ heading called data.csv. Click on it.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker04.png" alt="The empty data.csv file">
  <figcaption>The empty data.csv file</figcaption>
</figure>


<p>This now shows us a blank file called data.csv, so now open up your data.csv file in whatever editor you’re using (I don’t think a spreadsheet program is going to be a good idea since I doubt that it will maintain the information in a textual form as we’re wanting it to do. So it’s Geany for me). Copy the contents of your local data.csv file and paste it into the new plunker data.csv file.</p>

<p>So now we have our data in there we need to tell our JavaScript where it is. So go back to the ‘index.html’ file (which is our simple graph code) and edit the line which finds the data.tsv file from this</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">tsv</code><code class="p">(</code><code class="s2">"data/data.tsv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>… to this …</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>Because we’re using relative addressing, and plunker stores the files for the graphing script and the data side by side, we just removed the portion of the address that told our original code to look in the ‘data’ directory and told it to look in the current directory.
And that should be that!</p>

<p>Now if you look on the right hand side of the screen, there is a little eye icon. If you click on it, it opens up a preview window of your file in action and viola!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker05.png" alt="Preview your graph">
  <figcaption>Preview your graph</figcaption>
</figure>


<p>If the graph doesn’t appear, go through the steps outlined above and just check that the edits are made correctly. Unfortunately I haven’t found a nice mechanism for troubleshooting inside Plunker yet (not like using F12 on Chrome).</p>

<p>But wait! There’s more!</p>

<p>If you now click on the ‘Save’ button at the top of the screen, you will get some new button options.</p>

<p>One of them is the orange one for showing off your work.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker06.png" alt="Show off your work">
  <figcaption>Show off your work</figcaption>
</figure>


<p>If you click on this, it will present you with several different options.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker07.png" alt="Preview your graph">
  <figcaption>Preview your graph</figcaption>
</figure>


<p>The first one is a link that will give others the option to collaborate on the script.</p>

<p>The second is a link that will allow others to preview the work;
<a href="http://embed.plnkr.co/QSCkG8Rf2qFgrCqq7Vfn">http://embed.plnkr.co/QSCkG8Rf2qFgrCqq7Vfn</a></p>

<p>The last will allow you to embed your graph in a separate web page somewhere. Which I’ve tested with blogger and seems to work really well! (see image below).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/plunker08.png" alt="Plunker iframe inserted in a blog post">
  <figcaption>Plunker iframe inserted in a blog post</figcaption>
</figure>


<p>So, I’m impressed, Nice work by Plunker and it’s creator Geoff Goodman.</p>

<h2 id="leanpub-auto-manipulating-data">Manipulating data</h2>

<h3 id="leanpub-auto-how-to-use-data-imported-from-a-csv-file-with-spaces-in-the-header">How to use data imported from a csv file with spaces in the header.</h3>

<p>When importing data from a csv file that has headers with spaces in the middle of some of the fields there is a need to address the data slightly differently in order for it to be used easily in your JavaScript.</p>

<p>For example the following csv data has a column named ‘Date Purchased’;</p>

<figure class="code">
<div class="highlight"><pre><code></code>Value,Date Purchased,Score
12345,2011-03-23,99
22345,2011-03-24,100
32345,2011-03-25,99
42345,2011-03-26,100
</pre></div>

</figure>

<p>This is not an uncommon occurrence since <a href="http://tools.ietf.org/html/rfc4180">RFC 4180</a> which specifies csv content allows for it and d3.js supports the RFC;</p>

<blockquote>
  <p>Within the header and each record, there may be one or more fields, separated by commas. Each line should contain the same number of fields throughout the file. Spaces are considered part of a field and should not be ignored.</p>
</blockquote>

<p>When we go to import the data using the d3.csv function, we need to reference the ‘Data Purchased’ column in a way that makes allowances for the space. The following piece of script (with grateful thanks to <a href="http://stackoverflow.com/questions/21715201/unable-to-reference-d3-js-data-imported-from-a-csv-file-with-spaces-in-the-heade">Stephen Thomas for answering my Stack Overflow question</a>) appears to be the most basic solution.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sample-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s1">'Date Purchased'</code><code class="p">]);</code>
    <code class="p">});</code>
<code class="p">...</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>In the example above the ‘Date Purchased’ column is re-declared as ‘date’ making working in the following script much easier.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-extracting-data-from-a-portion-of-a-string">Extracting data from a portion of a string.</h3>

<p>The example problem here would be as if we have a set of values in a string that we want to extract but which in their original form it would not be possible.</p>

<p>For example, the following csv file contains the column ‘value’ and the values of the data in that column are prefixed with a dollar sign ($). </p>

<figure class="code">
<div class="highlight"><pre><code></code>value,date,score
$1234,2011-03-23,99
$2234,2011-03-24,100
$3234,2011-03-25,99
$4235,2011-03-26,100
</pre></div>

</figure>

<p>We can use the JavaScript substring() method to easily remove the leading character from the data.</p>

<p>The following example processes our csv file after loading it and for each ‘value’ entry on each row takes a substring of the entry that removes the first character and retains the rest.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sample-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">substring</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
    <code class="p">});</code>
<code class="p">...</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>The substring() function includes a ‘start’ index (as used above) and optionally a ‘stop’ index. More on how these can be configured can be found on the <a href="http://www.w3schools.com/jsref/jsref_substring.asp">w3schools</a> site. </p>

<div class="page-break"></div>
<h3 id="leanpub-auto-grouping-and-summing-data-d3nest">Grouping and summing data (d3.nest).</h3>

<p>Often we will wish to group elements in an array into a hierarchical structure similar to the <code>GROUP BY</code> operator in SQL (but with the scope for multiple levels). This can be achieved using the <a href="https://github.com/mbostock/d3/wiki/Arrays#wiki--nest"><code>d3.nest</code></a> operator. Additionally we will sometimes wish to collapse the elements that we are grouping in a specific way (for instance to sum values). This can be achieved using the <code>rollup</code> function.</p>

<p>The example we will use is having the following csv file consisting of a column of dates and corresponding values;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,value
2011-03-23,3
2011-03-23,2
2011-03-24,3
2011-03-24,3
2011-03-24,6
2011-03-24,2
2011-03-24,7
2011-03-25,4
2011-03-25,5
2011-03-25,1
2011-03-25,4
</pre></div>

</figure>

<p>We will nest the data according to the date and sum the data for each date so that our data is in the equivalent form of;</p>

<figure class="code">
<div class="highlight"><pre><code></code>key,values
2011-03-23,5
2011-03-24,21
2011-03-25,14
</pre></div>

</figure>

<p>We will do this with the following script;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"source-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">csv_data</code><code class="p">)</code> <code class="p">{</code>
	<code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
		<code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;})</code>
		<code class="p">.</code><code class="nx">rollup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
			<code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sum</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">g</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">g</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
		<code class="p">}).</code><code class="nx">entries</code><code class="p">(</code><code class="nx">csv_data</code><code class="p">);</code>
<code class="p">...</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>We are assuming the data is in the form of our initial csv file and is named <code>source-data.csv</code>.</p>

<p>The first thing we do is load that file and assign the loaded array the variable name <code>csv_data</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"source-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">csv_data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>Then we declare our new array’s name will be <code>data</code> and we initiate the <code>nest</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
</pre></div>

</figure>

<p>We assign the <code>key</code> for our new array as <code>date</code>. A ‘key’ is like a way of saying “<em>This is the thing we will be grouping on</em>”. In other words our resultant array will have a single entry for each unique <code>date</code> value.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;})</code>
</pre></div>

</figure>

<p>Then we include the <code>rollup</code> function that takes all the individual <code>value</code> variables that are in each unique <code>date</code> field and sums them;</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">.</code><code class="nx">rollup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
			<code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sum</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">g</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">g</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>Lastly we tell the entire nest function which data array we will be using for our source of data.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">}).</code><code class="nx">entries</code><code class="p">(</code><code class="nx">csv_data</code><code class="p">);</code>
</pre></div>

</figure>

<p>What if your data turns out to be unsorted? Never fear, we can easily sort on the key value by tacking on the <code>sortKeys</code> function like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;}).</code><code class="nx">sortKeys</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">)</code>
</pre></div>

</figure>

<p>You should note that our data will have changed name from <code>date</code> and <code>value</code>. This is as a function of the <code>nest</code> and <code>rollup</code> process. But never fear, it’s a simple task to re-name them if necessary using the following function (which could include a call to parse the date, but I have omitted it for clarity);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">;</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">;</code>
<code class="p">});</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-padding-for-zero-values">Padding for zero values</h3>

<p>The ‘Padding for zero values’ question is one that I <a href="http://stackoverflow.com/questions/23227991/how-to-add-in-zero-values-into-a-time-series-in-d3-js-javascript">posted on Stack Overflow</a> in April 2014.  </p>

<p>The premiss is that I want to be able to graph points in a time series that has regular intervals but where some of those intervals are missing. For example a line graph of the following data (notice that August 2013 is missing)…</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,value
2013-01,53
2013-02,165
2013-03,269
2013-04,344
2013-05,376
2013-06,410
2013-07,421
2013-09,376
2013-10,359
2013-11,392
2013-12,433
2014-01,455
2014-02,478
</pre></div>

</figure>

<p>… would produce a graph that looked like the following </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/zero-01.png" alt="interpolated time series">
  <figcaption>interpolated time series</figcaption>
</figure>


<p>But if the reason for the missing August month was that the value would have been zero, then the graph should actually look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/zero-02.png" alt="interpolated time series">
  <figcaption>interpolated time series</figcaption>
</figure>


<p>Now, this may sound like a contrived example, but I have come across it in cases where querying for data from a MySQL database by counting (<code>COUNT(*)</code>) the number of instances of an event in a time series (number of sales of an individual item on a monthly basis for instance). The end result is that you are left with a list of months with values for those months where sales occurred, but where no sales occurred, there is no result at all. This can be overcome by some serious MySQL-fu or PHP trickery, but every solution I implemented had a ‘cracking a walnut with a sledgehammer’ feel about it.</p>

<p>Now I know that shifting the resolution of this problem from the server to the client might not sit well for everyone, but that doesn’t mean it’s not a suitable solution.</p>

<p>The solution that was provided by the user ‘explunit’ has a nice natural feel to it and in spite of introducing an additional JavaScript library to load (Lo-Dash) it’s a solution that I will be using in the future for this type of problem. You will need to bear in mind that the lodash.js library will need to be loaded to enable this solution.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code>
  <code class="s">"http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-lo-dash">Lo-Dash</h4>

<p><a href="http://lodash.com/">Lo-Dash</a> is a utility JavaScript library released under the MIT license that provides a range of useful functional programming helpers such as low level functions that can be used for iteration support for arrays, strings, objects, and <code>arguments</code> objects. It is often compared to <a href="http://underscorejs.org/">underscore.js</a> in terms of functionality.</p>

<h5 id="leanpub-auto-find">_.find</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">_</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">collection</code><code class="p">,</code> <code class="p">[</code><code class="nx">callback</code><code class="o">=</code><code class="nx">identity</code><code class="p">],</code> <code class="p">[</code><code class="nx">thisArg</code><code class="p">])</code>
</pre></div>

</figure>

<p>The ` _.find` function iterates over elements of a collection, returning the first element that the callback returns ‘truey’ for. The callback is bound to thisArg and invoked with three arguments; (value, index|key, collection).</p>

<p>If a property name is provided for callback the created “_.pluck” style callback will return the property value of the given element.</p>

<p>If an object is provided for callback the created “_.where” style callback will return true for elements that have the properties of the given object, else false.</p>

<p><strong>Arguments</strong></p>

<ol class="numeric">
  <li>collection (Array|Object|string): The collection to iterate over.</li>
  <li>
<code>[callback=identity] (Function|Object|string)</code>: The function called per iteration. If a property name or object is provided it will be used to create a “.pluck” or “.where” style callback, respectively.</li>
  <li>
<code>[thisArg] (*)</code>: The this binding of callback.</li>
</ol>

<h4 id="leanpub-auto-the-explunit-method">The explunit method</h4>

<p>The following is the layout of the critical part of the code that the explunit method uses.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">period</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">month</code><code class="p">;</code> <code class="c1">// set the time interval</code>

<code class="c1">// Scale the range of the data</code>
<code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}))</code>
     <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="nx">period</code><code class="p">);</code>
<code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code>

<code class="c1">// Populate the new array</code>
<code class="kd">var</code> <code class="nx">newData</code> <code class="o">=</code> <code class="nx">x</code><code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="nx">period</code><code class="p">)</code>
               <code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">monthBucket</code><code class="p">)</code> <code class="p">{</code> 
                   <code class="k">return</code> <code class="nx">_</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> 
                       <code class="p">{</code> <code class="nx">date</code><code class="o">:</code> <code class="nx">monthBucket</code> <code class="p">})</code> <code class="o">||</code> 
                       <code class="p">{</code> <code class="nx">date</code><code class="o">:</code> <code class="nx">monthBucket</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">0</code> <code class="p">};</code>
                <code class="p">});</code>
</pre></div>

</figure>

<p>It can be thought of as breaking the problem down into two steps. Firstly a new array is built that covers the range of values declared in the data and contains dates at a specified interval. Secondly, the script iterates over the old data and where the date matches a date in the new array it maps the value from the old array to the new array. Where there is no match, it maps the value of <code>0</code>.</p>

<h5 id="leanpub-auto-build-the-array">Build the array</h5>

<h6 id="leanpub-auto-scaletickscount"><code>scale.ticks([count])</code></h6>

<p>The domain in the x axis is set using the following line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}))</code>
     <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="nx">period</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here the extent of the domain is declared in a standard way (<code>d3.extent(data, function(d) { return d.date; })</code>) but by including the <a href="https://github.com/mbostock/d3/wiki/Time-Scales#ticks"><code>.ticks</code></a> function the domain is broken into uniformly spaced time intervals defined by the specified time interval (in this case months per the  declared variable <code>period</code> (<code>d3.time.month</code>)). This has just created an array across  the x axis with <em>all</em> the month values!</p>

<h5 id="leanpub-auto-populate-the-array">Populate the array</h5>

<p>In the next section we generate our new array (<code>newData</code>) with the values from the original <code>data</code> array and where necessary (there’s no <code>value</code>) <code>0</code> in the value field.</p>

<p>It’s all contained within the following code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">newData</code> <code class="o">=</code> <code class="nx">x</code><code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="nx">period</code><code class="p">)</code>
               <code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">monthBucket</code><code class="p">)</code> <code class="p">{</code> 
                   <code class="k">return</code> <code class="nx">_</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> 
                       <code class="p">{</code> <code class="nx">date</code><code class="o">:</code> <code class="nx">monthBucket</code> <code class="p">})</code> <code class="o">||</code> 
                       <code class="p">{</code> <code class="nx">date</code><code class="o">:</code> <code class="nx">monthBucket</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">0</code> <code class="p">};</code>
                <code class="p">});</code>
</pre></div>

</figure>

<h6 id="leanpub-auto-xticks"><code>x.ticks()</code></h6>

<p>The <code>x.ticks(period)</code> portion recalls our new padded array of months.</p>

<h6 id="leanpub-auto-mapobject"><code>.map([object])</code></h6>

<p>In a wider (JavaScript) sense the <code>map()</code> method creates a new array by copying all enumerable properties from the object into the new array. This is implemented with <a href="https://github.com/mbostock/d3/wiki/Arrays#d3_map"><code>.map</code></a> which is used here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>               <code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">monthBucket</code><code class="p">)</code> <code class="p">{</code> 
                   <code class="k">return</code> <code class="nx">_</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> 
                       <code class="p">{</code> <code class="nx">date</code><code class="o">:</code> <code class="nx">monthBucket</code> <code class="p">})</code> <code class="o">||</code> 
                       <code class="p">{</code> <code class="nx">date</code><code class="o">:</code> <code class="nx">monthBucket</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">0</code> <code class="p">};</code>
                <code class="p">});</code>
</pre></div>

</figure>

<p>In the example we are examining, the <code>[object]</code> is provided by the passing the date from the <code>x.ticks(period)</code> function as <code>monthBucket</code>. Whatever is returned by the function will get placed into <code>newData</code>. It’s within this function that we use the Lo-Dash <code>_.find</code> utility.</p>

<p>In common speak <code>_.find</code> will look over over the objects in an array (<code>data</code>) and will return the the first instance that it finds which matches its specified patten (in our case it will match whenever the <code>date</code> element in <code>data</code> equals an array element specified by our <code>x.ticks(period)</code> (<code>monthBucket</code>) values or (if no match is made) it will return the <code>date</code> element from <code>monthBucket</code> and the <code>value</code> of <code>0</code>.</p>

<p>The end result is an array called <code>newData</code> of objects containing equally spaced date elements across the range that we provided at an interval that we specify with values corresponding to our original array <code>data</code> where it matches the date in our new array and where it doesn’t, we introduce the value <code>0</code>.</p>

<h2 id="leanpub-auto-bar-charts">Bar Charts</h2>

<p>A bar chart is a visual representation using either horizontal or vertical bars to show comparisons between discrete categories. There are a number of variations of bar charts including stacked, grouped, horizontal and vertical. </p>

<p>There is a wealth of examples of bar charts on the web, but I would recommend a visit to the <a href="http://christopheviau.com/d3list/gallery.html#visualizationType=bar">D3.js gallery</a> maintained by Christophe Viau as a starting point to get some ideas.</p>

<p>We will work through a simple vertical bar chart that uses a value on the y axis and date values on the x axis.</p>

<p>The end result will look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bar-01.png" alt="Bar chart">
  <figcaption>Bar chart</figcaption>
</figure>


<h3 id="leanpub-auto-the-data">The data</h3>

<p>The data for this example will be sourced from an external csv file named <code>bar-data.csv</code>. It consists of a column of dates in year-month format and it’s contents are as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,value
2013-01,53
2013-02,165
2013-03,269
2013-04,344
2013-05,376
2013-06,410
2013-07,421
2013-08,405
2013-09,376
2013-10,359
2013-11,392
2013-12,433
2014-01,455
2014-02,478
</pre></div>

</figure>

<h3 id="leanpub-auto-the-code-4">The code</h3>

<p>The full code listing for the example we are going to work through is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
	<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

	<code class="nc">.axis</code> <code class="p">{</code>
	  <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
	<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
	  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">70</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code>	<code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">ordinal</code><code class="p">().</code><code class="nx">rangeRoundBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">],</code> <code class="p">.</code><code class="mi">05</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m"</code><code class="p">));</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"bar-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
    <code class="p">});</code>
	
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code>

  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"-.8em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"-.55em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code> <code class="p">);</code>

  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value ($)"</code><code class="p">);</code>

  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">x</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8952219">github</a>, in the appendices of this book or in the code samples bundled with <a href="https://leanpub.com/D3-Tips-and-Tricks">this book</a> (bar.html and bar-data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/8952219">bl.ocks.org</a>. </p>

</aside>

<h3 id="leanpub-auto-the-bar-chart-explained">The bar chart explained</h3>

<p>In the course of describing the operation of the file I will gloss over the aspects of the structure of an HTML file which have already been described at the start of the book. Likewise, aspects of the JavaScript functions that have already been covered will only be briefly explained.</p>

<p>The start of the file deals with setting up the document’s head and body, loading the d3.js script and setting up the css in the <code>&lt;style&gt;</code> section.</p>

<p>The css section sets styling for the axes. It sizes the font to be used and make sure the lines are formatted appropriately.</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="nc">.axis</code> <code class="p">{</code>
	  <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
	<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
	  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
	<code class="p">}</code>
</pre></div>

</figure>

<p>Then our JavaScript section starts and the first thing that happens is that we set the size of the area that we’re going to use for the chart and the margins;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">70</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>The next section of our code includes some of the functions that will be called from the main body of the code.</p>

<p>We have a familiar <code>parseDate</code> function with a slight twist. Since our source data for the date is made up of only the year and month, these are the only two portions of the date that need to be recognised;  </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code>	<code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>
</pre></div>

</figure>

<p>The next section declares the function to determine positioning in the x domain.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">ordinal</code><code class="p">().</code><code class="nx">rangeRoundBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">],</code> <code class="p">.</code><code class="mi">05</code><code class="p">);</code>
</pre></div>

</figure>

<p>The ordinal scale is used to describe a range of discrete values. In our case they are a set of monthly values. The <code>rangeRoundBands</code> operator provides the magic that arranges our bars in a graceful way across the x axis. In our example we use it to set the range that our bars will cover (in this case from 0 to the <code>width</code> of the graph) and the amount of padding between the bars (in this case we have selected <code>.05</code> which equates to approximately (depending on the number of pixels available) 5% of the bar width.</p>

<p>The function to set the scaling in the y domain is the same as most of our other graph examples; </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>The declarations for our two axes are relatively simple, with the only exception being to force the format of the labels for the x axis into a ‘year-month’ format. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m"</code><code class="p">));</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>
</pre></div>

</figure>

<p>The next block of code selects the <code>body</code> on the web page and appends an svg object to it of the size that we have set up with our <code>width</code>, <code>height</code> and <code>margin</code>’s.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>It also adds a <code>g</code> element that provides a reference point for adding our axes.</p>

<p>Then we begin the main body of our JavaScript. We load our csv file and then loop through it making sure that the dates and numerical values are recognised correctly;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"bar-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>We then then work through our x and y data and ensure that it is scaled to the domains we are working in;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>Following that we append our x axis;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"-.8em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"-.55em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code> <code class="p">);</code>
</pre></div>

</figure>

<p>This is placed in the correct position <code>.attr("transform", "translate(0," + height + ")")</code> and the text is positioned (using <code>dx</code> and <code>dy</code>) and rotated (<code>.attr("transform", "rotate(-90)" );</code>) so that it is aligned vertically.</p>

<p>Then we append our y axis in a similar way and append a label (<code>.text("Value ($)");</code>);</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value ($)"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Lastly we add the bars to our chart;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">x</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This block of code creates the bars (<code>selectAll("bar")</code>) and associates each of them with a data set (<code>.data(data)</code>).</p>

<p>We then append a rectangle (<code>.append("rect")</code>) with values for x/y position and height/width as configured in our earlier code.</p>

<p>The end result is our pretty looking bar chart;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bar-01.png" alt="Bar chart">
  <figcaption>Bar chart</figcaption>
</figure>


<h2 id="leanpub-auto-sankey-diagrams">Sankey Diagrams</h2>

<h3 id="leanpub-auto-what-is-a-sankey-diagram">What is a Sankey Diagram?</h3>

<p>A Sankey diagram is a type of flow diagram where the ‘flow’ is represented by arrows of varying thickness depending on the quantity of flow.</p>

<p>They are often used to visualize energy, material or cost transfers and are especially useful in demonstrating proportionality to a flow where different parts of the diagram represent different quantities in a system.</p>

<p>Probably the most famous example of a Sankey diagram is Charles Minard’s Map of Napoleon’s Russian Campaign of 1812.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey01.png" alt="Napoleon's Russian March">
  <figcaption>Napoleon’s Russian March</figcaption>
</figure>


<p>From Wikipedia;</p>

<p>“<em>Étienne-Jules Marey first called notice to this dramatic depiction of the fate of Napoleon’s army in the Russian campaign, saying it defies the pen of the historian in its brutal eloquence. Edward Tufte says it “may well be the best statistical graphic ever drawn” and uses it as a prime example in The Visual Display of Quantitative Information</em>.”</p>

<p>Wikipedia has a great explanation of the <a href="http://en.wikipedia.org/wiki/Sankey_diagram">diagram type</a> and there is a wealth of information dedicated to it on the inter-web. I heartily recommend http://www.sankey-diagrams.com/ for all things Sankey!</p>

<p>So it would come as little surprise that Mike Bostock has developed a plugin for Sankey diagrams (http://bost.ocks.org/mike/sankey/) so that we can all enjoy Sankey goodness with lashings of D3.</p>

<h3 id="leanpub-auto-how-d3js-sankey-diagrams-want-their-data-formatted">How d3.js Sankey Diagrams want their data formatted</h3>

<p>If we think of Sankey diagrams consisting of ‘nodes’ and ‘links’…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey02.png" alt="A simple Sankey diagram">
  <figcaption>A simple Sankey diagram</figcaption>
</figure>


<p>… the data that generates them must be formatted as nodes and links as well.</p>

<p>For instance a JSON file with appropriate data to build the diagram above could look like the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{
"nodes":[
{"node":0,"name":"node0"},
{"node":1,"name":"node1"},
{"node":2,"name":"node2"},
{"node":3,"name":"node3"},
{"node":4,"name":"node4"}
],
"links":[
{"source":0,"target":2,"value":2},
{"source":1,"target":2,"value":2},
{"source":1,"target":3,"value":2},
{"source":0,"target":4,"value":2},
{"source":2,"target":3,"value":2},
{"source":2,"target":4,"value":2},
{"source":3,"target":4,"value":4}
]}
</pre></div>

</figure>

<p>In the file above we have 6 nodes (0-5) sequentially numbered and with names appropriate to their position in the list. </p>

<p>The sequential numbering is only for the purpose of highlighting the structure of the data, since when we get D3 running, it will automatically index each of the nodes according to its position. In other words, we could have omitted the “node”:n parts since D3 will know where each node is anyway. The big deal is that WE need to know what each node is as well especially if we’re going to be building the data by hand (doing it dynamically would be cool, but let’s not get ahead of ourselves just yet).</p>

<p>The links part of the data can be broken down into individual source to target ‘links’ that have an associated value (could be a quantity or strength, but at least a numeric value).</p>

<p>The ‘source’ and target numbers are references to the list of nodes. So, “source”:1, “target”:2 means that this link is whatever node appears at position 1 going to whatever node appears at position 2. The important point to make here is that D3 will not be interested in the numerical value of the node, just it’s position in the list (starting at zero).</p>

<h3 id="leanpub-auto-description-of-the-code">Description of the code</h3>
<p>The code for the Sankey diagram is significantly different to that for a line graph although it shares the same core language and programming methodology. </p>

<p>The code we’ll go through is an adaptation of the <a href="http://bost.ocks.org/mike/sankey/">version first demonstrated by Mike Bostock</a> so it’s got a pretty good pedigree. I will begin with a version that uses data that is formatted so that it can be used directly with no manipulation, then in subsequent sections I will describe different techniques for getting data from different formats to work. </p>

<p>I found that getting data in the correct format was the biggest hurdle for getting a Sankey diagram to work. I make the assumption that this may be a similar story for others as well. We will start off assuming that the data is perfectly formatted, then where only the link data is available, then where there is just names to work with (no numeric node values) and lastly, one that can be used for people with changeable data from a MySQL database.</p>

<p>I won’t try to go over every inch of the code as I did with the previous simple graph example (I’ll skip things like the HTML header) and will focus on the style sheet (CSS) portion and the JavaScript.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/c2637e28b79fb3bfea13">github</a> or in the code samples bundled with this book (sankey-formatted-json.html, sankey.js and sankey-formatted.json). A live example can be found on <a href="http://bl.ocks.org/d3noob/c2637e28b79fb3bfea13">bl.ocks.org</a>.</p>

<p>On to the code…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">rect</code> <code class="p">{</code>
  <code class="nb">cursor</code><code class="o">:</code> <code class="n">move</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">9</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.link</code><code class="nd">:hover</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">p</code> <code class="na">id</code><code class="o">=</code><code class="s">"chart"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"sankey.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">units</code> <code class="o">=</code> <code class="s2">"Widgets"</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">10</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">700</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">formatNumber</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">",.0f"</code><code class="p">),</code>    <code class="c1">// zero decimal places</code>
    <code class="nx">format</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">formatNumber</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">units</code><code class="p">;</code> <code class="p">},</code>
    <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category20</code><code class="p">();</code>

<code class="c1">// append the svg canvas to the page</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#chart"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Set the sankey diagram properties</code>
<code class="kd">var</code> <code class="nx">sankey</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sankey</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodeWidth</code><code class="p">(</code><code class="mi">36</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">nodePadding</code><code class="p">(</code><code class="mi">40</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">link</code><code class="p">();</code>

<code class="c1">// load the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"sankey-formatted.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>

  <code class="nx">sankey</code>
      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">layout</code><code class="p">(</code><code class="mi">32</code><code class="p">);</code>

<code class="c1">// add in the links</code>
  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">b</code><code class="p">.</code><code class="nx">dy</code> <code class="o">-</code> <code class="nx">a</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">});</code>

<code class="c1">// add the link titles</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    		<code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">" ? "</code> <code class="o">+</code> 
                <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// add in the nodes</code>
  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">behavior</code><code class="p">.</code><code class="nx">drag</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">origin</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"dragstart"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> 
		  <code class="k">this</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="k">this</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"drag"</code><code class="p">,</code> <code class="nx">dragmove</code><code class="p">));</code>

<code class="c1">// add the rectangles for the nodes</code>
  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/ .*/</code><code class="p">,</code> <code class="s2">""</code><code class="p">));</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">rgb</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">).</code><code class="nx">darker</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// add in the title for the nodes</code>
  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="o">-</code><code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kc">null</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">&lt;</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">6</code> <code class="o">+</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">);</code>

<code class="c1">// the function for moving the nodes</code>
  <code class="kd">function</code> <code class="nx">dragmove</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
        <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">width</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dx</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">x</code><code class="p">))</code>
        <code class="p">)</code>
        <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">y</code><code class="p">))</code>
        <code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="nx">sankey</code><code class="p">.</code><code class="nx">relayout</code><code class="p">();</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>So, going straight to the style sheet bounded by the <code>&lt;style&gt;</code> tags;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">rect</code> <code class="p">{</code>
  <code class="nb">cursor</code><code class="o">:</code> <code class="n">move</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">9</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code><code class="nd">:hover</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The CSS in this example is mainly concerned with formatting of the mouse cursor as it moves around the diagram.</p>

<p>The first part…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">rect</code> <code class="p">{</code>
  <code class="nb">cursor</code><code class="o">:</code> <code class="n">move</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">9</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… provides the properties for the node rectangles. It changes the icon for the cursor when it moves over the rectangle to one that looks like it will move the rectangle (there is a range of different icons that can be defined here http://www.echoecho.com/csscursors.htm), sets the fill colour to mostly opaque and keeps the edges sharp.</p>

<p>The next block…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… sets the properties for the text at each node. The mouse is told to essentially ignore the text in favour of anything that’s under it (in the case of moving or highlighting something else) and a slight shadow is applied for readability).</p>

<p>The following block…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… makes sure that the link has no fill (it actually appears to be a bendy rectangle with very thick edges that make the element appear to be a solid block), colours the edges black (<code>#000</code>) and makes the edges almost transparent.</p>

<p>The last block….</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.link</code><code class="nd">:hover</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… simply changes the opacity of the link when the mouse goes over it so that it’s more visible. If so desired, we could change the colour of the highlighted link by adding in a line to this block changing the colour like this <code>stroke: red;</code>.</p>

<p>Just before we get into the JavaScript, we do something a little different for d3.js. We tells it to use a plug-in with the following line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"sankey.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The concept of a plug-in is that it is a separate piece of code that will allow additional functionality to a core block (which in this case is d3.js). There are a range of <a href="https://github.com/d3/d3-plugins">plug-ins available</a> and we will need to source the <code>sankey.js</code> file from the repository and place that somewhere where our HTML code can access it. In this case I have put it in the same directory as the main sankey web page.</p>

<p>The start of our JavaScript begins by defining a range of variables that we’ll be using. </p>

<p>Our units are set as ‘Widgets’ (<code>var units = "Widgets";</code>), which is just a convenient generic (nonsense) term to provide the impression that the flow of items in this case is widgets being passed from one person to another.</p>

<p>We then set our canvas size and margins…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">10</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">700</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>… before setting some formatting.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">formatNumber</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">",.0f"</code><code class="p">),</code>    <code class="c1">// decimal places</code>
    <code class="nx">format</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">formatNumber</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">units</code><code class="p">;</code> <code class="p">},</code>
    <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category20</code><code class="p">();</code>
</pre></div>

</figure>

<p>The <code>formatNumber</code> function acts on a number to set it to zero decimal places in this case. In the original Mike Bostock example it was to three places, but for ‘widgets’ I’m presuming we don’t divide :-).</p>

<p><code>format</code> is a function that returns a given number formatted with <code>formatNumber</code> as well as a space and our units of choice (‘Widgets’). This is used to display the values for the links and nodes later in the script.</p>

<p>The <code>color = d3.scale.category20();</code> line is really interesting and provides access to a colour scale that is <a href="https://github.com/mbostock/d3/wiki/Ordinal-Scales#wiki-category10">pre-defined for your convenience</a>! Later in the code we will see it in action.</p>

<p>Our next block of code positions our canvas onto our page in relation to the size and margins we have already defined;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#chart"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we set the variables for our sankey diagram;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">sankey</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sankey</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodeWidth</code><code class="p">(</code><code class="mi">36</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">nodePadding</code><code class="p">(</code><code class="mi">40</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>
</pre></div>

</figure>

<p>Without trying to state the obvious, this sets the width of the nodes (<code>.nodeWidth(36)</code>), the padding between the nodes (<code>.nodePadding(40)</code>) and the size of the diagram(<code>.size([width, height]);</code>).</p>

<p>The following line defines the <code>path</code> variable as a pointer to the sankey function that makes the links between the nodes do their clever thing of bending into the right places;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">link</code><code class="p">();</code>
</pre></div>

</figure>

<p>I make the presumption that this is a defined function within <code>sankey.js</code>.
Then we load the data for our sankey diagram with the following line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"sankey-formatted.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>As we have seen in previous usage of the <code>d3.json</code>, <code>d3.csv</code> and <code>d3.tsv</code> functions, this is a wrapper that acts on all the code within it bringing the data in the form of <code>graph</code> to the remaining code.</p>

<p>I think it’s a good time to take a slightly closer look at the data that we’ll be using;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{
"nodes":[
{"node":0,"name":"node0"},
{"node":1,"name":"node1"},
{"node":2,"name":"node2"},
{"node":3,"name":"node3"},
{"node":4,"name":"node4"}
],
"links":[
{"source":0,"target":2,"value":2},
{"source":1,"target":2,"value":2},
{"source":1,"target":3,"value":2},
{"source":0,"target":4,"value":2},
{"source":2,"target":3,"value":2},
{"source":2,"target":4,"value":2},
{"source":3,"target":4,"value":4}
]}
</pre></div>

</figure>

<p>I want to look at the data now, because it highlights how it is accessed throughout this portion of the code. It is split into two different blocks, ‘nodes’ and ‘links’. The subset of variables available under ‘nodes’ is ‘node’ and ‘name’. Likewise under ‘links’ we have ‘source’, ‘target’ and ‘value’. This means that when we want to act on a subset of our data we define which piece by defining the hierarchy that leads to it. For instance, if we want to define an action for all the links, we would use graph.links (they’re kind of chained together).</p>

<aside class="information blurb">
    <p>Let me take this opportunity to apologise to all those programmers who <em>actually</em> know exactly what is going on here. It’s a mystery to me, but this is how I like to tell myself it works to help me get by :-).</p>

</aside>

<p>Now that we have our data loaded, we can assign the data to the sankey function so that it knows how to deal with it behind the scenes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">sankey</code>
      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">layout</code><code class="p">(</code><code class="mi">32</code><code class="p">);</code>
</pre></div>

</figure>

<p>In keeping with our previous description of what’s going on with the data, we have told the sankey function that the nodes it will be dealing with are in <code>graph.nodes</code> of our data structure.</p>

<p>I’m not sure what the <code>.layout(32);</code> portion of the code does, but I’d be interested to hear from any more knowledgeable readers. I’ve tried changing the values to no apparent effect and googling has drawn a blank. Internally to the <code>sankey.js</code> file it seems to indicate ‘iterations’ while it establishes     computeNodeLinks, computeNodeValues, computeNodeBreadths, computeNodeDepths (iterations) and computeLinkDepths.</p>

<p>Then we add our links to the diagram with the following block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">b</code><code class="p">.</code><code class="nx">dy</code> <code class="o">-</code> <code class="nx">a</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This is an analogue of the block of code we examined way back in the section that we covered in explaining the code of our first simple graph.</p>

<p>We append svg elements for our links based on the data in <code>graph.links</code>, then add in the paths (using the appropriate CSS). We set the stroke width to the width of the value associated with each link or ‘1’. Whichever is the larger (by virtue of the Math.max function). As an interesting sideline, if we force this value to ‘10’ thusly…</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
</pre></div>

</figure>

<p>… the graph looks quite interesting.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey03.png" alt="stroke-width 10 for Sankey links">
  <figcaption>stroke-width 10 for Sankey links</figcaption>
</figure>


<p>The sort function (<code>.sort(function(a, b) { return b.dy - a.dy; });</code>) makes sure the link for which the target has the highest y coordinate departs first out of the rectangle. Meaning if you have flows of 30,40,50 out of node 1, heading towards nodes 2, 3 and 4, with node 3 located above node 2 and that above node 4, the outflow order from node 1 will be 40,50,30. This makes sure there are as least crosses of flows as possible. It’s slightly confusing and for a long time it was a mystery (big thanks and kudos to ‘napicool’ who was able to <a href="http://www.d3noob.org/2013/02/formatting-data-for-sankey-diagrams-in.html">explain it on d3noob.org</a>.</p>

<p>The next block adds the titles to the links;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">link</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">" ? "</code> <code class="o">+</code> 
                        <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This code appends a text element to each link when moused over that contains the source and target name (with a neat little arrow in between and the value) which, when applied with the <code>format</code> function, adds the units.</p>

<p>The next block appends the node objects (but not the rectangles or text) and contains the instructions to allow them to be arranged with the mouse.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">behavior</code><code class="p">.</code><code class="nx">drag</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">origin</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"dragstart"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> 
		  <code class="k">this</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="k">this</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"drag"</code><code class="p">,</code> <code class="nx">dragmove</code><code class="p">));</code>
</pre></div>

</figure>

<p>While it starts off in familiar territory with appending the node objects using the <code>graph.nodes</code> data and putting them in the appropriate place with the <code>transform</code> attribute, I can only assume that there is some trickery going on behind the scenes to make sure the mouse can do what it needs to do with the <code>d3.behaviour,drag</code> function. There is some excellent documentation on the wiki (https://github.com/mbostock/d3/wiki/Drag-behavior), but I can only presume that it knows what it’s doing :-). The <code>dragmove</code> function is laid out at the end of the code, and we will explain how that operates later.</p>

<p>I really enjoyed the next block;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/ .*/</code><code class="p">,</code> <code class="s2">""</code><code class="p">));</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">rgb</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">).</code><code class="nx">darker</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>It starts off with a fairly standard appending of a rectangle with a height generated by its value <code>{ return d.dy; }</code> and a width dictated by the <code>sankey.js</code> file to fit the canvas (<code>.attr("width", sankey.nodeWidth())</code>).</p>

<p>Then it gets interesting.</p>

<p>The colours are assigned in accordance with our earlier colour declaration and the individual colours are added to the nodes by finding the first part of the name for each node and assigning it a colour from the palate (the script looks for the first space in the name using a regular expression). For instance: ‘Widget X’, ‘Widget Y’ and ‘Widget’ will all be coloured the same even if the ‘Widget X’ and ‘Widget Y’ are inputs on the left and ‘Widget’ is a node in the middle.</p>

<p>The stroke around the outside of the rectangle is then drawn in the same shade, but <code>darker</code>.
Then we return to the basics where we add the title of the node in a tool tip type effect along with the value for the node.</p>

<p>From here we add the titles for the nodes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>   <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="o">-</code><code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kc">null</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">&lt;</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">6</code> <code class="o">+</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Again, this looks pretty familiar. We position the text titles carefully to the left of the nodes. All except for those affected by the filter function (<code>return d.x &lt; width / 2;</code>). Where if the position of the node on the x axis is less than half the width, the title is placed on the right of the node and anchored at the start of the text. Very neat.</p>

<p>The last block is also pretty neat, and contains a little surprise for those who are so inclined.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">function</code> <code class="nx">dragmove</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
       <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code>
                <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">y</code><code class="p">))</code>
            <code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="nx">sankey</code><code class="p">.</code><code class="nx">relayout</code><code class="p">();</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
</pre></div>

</figure>

<p>This declares the function that controls the movement of the nodes with the mouse.
It selects the item that it’s operating over (<code>d3.select(this)</code>) and then allows translation in the y axis while maintaining the link connection (<code>sankey.relayout(); link.attr("d", path);</code>).</p>

<p>But that’s not the cool part. A quick look at the code should reveal that if you can move a node in the y axis, there should be no reason why you can’t move it in the x axis as well!</p>

<p>Sure enough, if you replace the code above with this…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">function</code> <code class="nx">dragmove</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
        <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">width</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dx</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">x</code><code class="p">))</code>
        <code class="p">)</code>
        <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">y</code><code class="p">))</code>
        <code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="nx">sankey</code><code class="p">.</code><code class="nx">relayout</code><code class="p">();</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
</pre></div>

</figure>

<p>… you can move your nodes anywhere on the canvas. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey04.png" alt="Move your nodes in x *and* y!">
  <figcaption>Move your nodes in x <em>and</em> y!</figcaption>
</figure>


<p>I know it doesn’t seem to add anything to the diagram (in fact, it could be argued that there is a certain aspect of detraction) however, it doesn’t mean that one day the idea doesn’t come in handy :-). You can see a live version on <a href="http://bl.ocks.org/d3noob/5028304">github</a>.</p>

<h3 id="leanpub-auto-formatting-data-for-sankey-diagrams">Formatting data for Sankey diagrams</h3>

<h4 id="leanpub-auto-from-a-json-file-with-numeric-link-values">From a JSON file with numeric link values</h4>

<p>As explained in the previous section, data to form a Sankey diagram needs to be a combination of nodes and links.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
<code class="nt">"nodes"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node0"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node1"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node2"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node3"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node4"</code><code class="p">}</code>
<code class="p">],</code>
<code class="nt">"links"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">4</code><code class="p">}</code>
<code class="p">]}</code>
</pre></div>

</figure>

<p>As we also noted earlier, the <code>“node”</code> entries in the <code>”nodes”</code> section of the json file are superfluous and are really only there for our benefit since D3 will automatically index the nodes starting at zero. As a test to check this out we can change our data to the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
<code class="nt">"nodes"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">}</code>
<code class="p">],</code>
<code class="nt">"links"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">4</code><code class="p">}</code>
<code class="p">]}</code>
</pre></div>

</figure>

<p>This will produce the following graph;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey05.png" alt="Sankey graph with names">
  <figcaption>Sankey graph with names</figcaption>
</figure>


<p>As you can see, essentially the same, but with easier to understand names.</p>

<p>As you can imagine, while the end result is great, the creation of the JSON file manually would be painful at best. Doing something similar but with a greater number of nodes / links would be a nightmare.</p>

<p>Let’s see if we can make the process a bit easier and more flexible.</p>

<h4 id="leanpub-auto-from-a-json-file-with-links-as-names">From a JSON file with links as names</h4>

<p>It would make thing much easier, if you are building the data from hand, to have nodes with names, and the ‘source’ and ‘target’ links to have those same name values as identifiers.</p>

<p>In other words a list of unique names for the nodes (and perhaps some details) and a list of the links between those nodes using the names for the nodes. </p>

<p>So, something like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
<code class="nt">"nodes"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">}</code>
<code class="p">],</code>
<code class="nt">"links"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">4</code><code class="p">}</code>
<code class="p">]}</code>
</pre></div>

</figure>

<p>Once again, D3 to the rescue!</p>

<p>The little piece of code that can do this for us is here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">nodeMap</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code> <code class="p">});</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="p">{</code>
        <code class="nx">source</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">source</code><code class="p">],</code>
        <code class="nx">target</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">target</code><code class="p">],</code>
        <code class="nx">value</code><code class="o">:</code> <code class="nx">x</code><code class="p">.</code><code class="nx">value</code>
      <code class="p">};</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>This elegant solution comes from <a href="http://stackoverflow.com/questions/14629853/json-representation-for-d3-networks">Stack Overflow</a> and was provided by Chris Pettitt (nice job).</p>

<p>So if we sneak this piece of code into here… </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"data/sankey-formatted.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>

            <code class="c1">//  &lt;= Put the code here.</code>

  <code class="nx">sankey</code>
      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">layout</code><code class="p">(</code><code class="mi">32</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and this time we use our JSON file with just names (sankey-formatted-names.json) and our new html file (sankey-formatted-names.html) we find our Sankey diagram working perfectly!</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/9bd82617061e04ad9540">github</a> or in the code samples bundled with this book (sankey-formatted-names.html, sankey.js and sankey-formatted-names.json). A live example can be found on <a href="http://bl.ocks.org/d3noob/9bd82617061e04ad9540">bl.ocks.org</a>.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey06.png" alt="Sankey graph with names again">
  <figcaption>Sankey graph with names again</figcaption>
</figure>


<p>Looking at our new piece of code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">nodeMap</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>…  the first thing it does is create an object called <code>nodeMap</code> (The difference between an array and an object in JavaScript is one that is still a little blurry to me and judging from online comments, I am not alone).</p>

<p>Then for each of the <code>graph.node</code> instances (where <code>x</code> is a range of numbers from 0 to the last node), we assign each node name to a number.</p>

<p>Then in the next piece of code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="p">{</code>
        <code class="nx">source</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">source</code><code class="p">],</code>
        <code class="nx">target</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">target</code><code class="p">],</code>
        <code class="nx">value</code><code class="o">:</code> <code class="nx">x</code><code class="p">.</code><code class="nx">value</code>
      <code class="p">};</code>
</pre></div>

</figure>

<p>… we go through all the links we have and for each link, we map the appropriate number to the correct name.</p>

<p>Very clever.</p>

<h4 id="leanpub-auto-from-a-csv-with-source-target-and-value-info-only">From a CSV with ‘source’, ‘target’ and ‘value’ info only.</h4>

<p>In the first iteration of this section I had no solution to creating a Sankey diagram using a csv file as the source of the data.</p>

<p>But cometh the hour, cometh the man. Enter @timelyportfolio who, while claiming no expertise in D3 or JavaScript was able to demonstrate a <a href="http://bl.ocks.org/timelyportfolio/5052095">solution</a> to exactly the problem I was facing! Well done Sir! I salute you and name the technique the timelyportfolio csv method!</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/c9b90689c1438f57d649">github</a> or in the code samples bundled with this book (sankey-formatted-csv.html, sankey.js and sankey.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/c9b90689c1438f57d649">bl.ocks.org</a>.</p>

<p>So here’s the cleverness that @timelyportfolio demonstrated;</p>

<p>Using a csv file (in this case called <code>sankey.csv</code>) that looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>source,target,value
Barry,Elvis,2
Frodo,Elvis,2
Frodo,Sarah,2
Barry,Alice,2
Elvis,Sarah,2
Elvis,Alice,2
Sarah,Alice,4
</pre></div>

</figure>

<p>We take this single line from our original Sankey diagram code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"sankey-formatted.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>And replace it with the following block;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sankey.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">//set up graph in same style as original example but empty</code>
  <code class="nx">graph</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"nodes"</code> <code class="o">:</code> <code class="p">[],</code> <code class="s2">"links"</code> <code class="o">:</code> <code class="p">[]};</code>

    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code> <code class="p">});</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code> <code class="p">});</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"source"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">,</code>
                         <code class="s2">"target"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">,</code>
                         <code class="s2">"value"</code><code class="o">:</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="p">});</code>
     <code class="p">});</code>

     <code class="c1">// return only the distinct / unique nodes</code>
     <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
       <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
       <code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">));</code>

     <code class="c1">// loop through each link replacing the text with its index from node</code>
     <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code><code class="p">);</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code><code class="p">);</code>
     <code class="p">});</code>

     <code class="c1">//now loop through each nodes to make nodes an array of objects</code>
     <code class="c1">// rather than an array of strings</code>
     <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code> <code class="p">};</code>
     <code class="p">});</code>
</pre></div>

</figure>

<p>The comments in the code (and they are fuller in @timelyportfolio’s <a href="http://bl.ocks.org/timelyportfolio/5052095">original gist solution</a>) explain the operation;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sankey.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>… Loads the csv file from the data directory.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">graph</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"nodes"</code> <code class="o">:</code> <code class="p">[],</code> <code class="s2">"links"</code> <code class="o">:</code> <code class="p">[]};</code>
</pre></div>

</figure>

<p>… Declares <code>graph</code> to consist of two empty arrays called <code>nodes</code> and <code>links</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code> <code class="p">});</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code> <code class="p">});</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"source"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">,</code>
                         <code class="s2">"target"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">,</code>
                         <code class="s2">"value"</code><code class="o">:</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="p">});</code>
     <code class="p">});</code>
</pre></div>

</figure>

<p>… Takes the <code>data</code> loaded with the csv file and for each row loads variables for the <code>source</code> and <code>target</code> into the <code>nodes</code> array. Then for each row it loads variables for the <code>source</code> <code>target</code> and <code>value</code> into the <code>links</code> array.</p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
       <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
       <code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">));</code>
</pre></div>

</figure>

<p>… Is a routine that Mike Bostock described on <a href="https://groups.google.com/forum/#!msg/d3-js/pl297cFtIQk/Eso4q_eBu1IJ">Google Groups</a> that (as I understand it) nests each node name as a key so that it returns with only unique nodes.</p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code><code class="p">);</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code><code class="p">);</code>
     <code class="p">});</code>
</pre></div>

</figure>

<p>… Goes through each <code>link</code> entry and, for each <code>source</code> and <code>target</code>, it finds the unique index number of that name in the nodes array and assigns the link source and target an appropriate number.</p>

<p>And finally… </p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code> <code class="p">};</code>
     <code class="p">});</code>
</pre></div>

</figure>

<p>… Goes through each node and (in the words of @timelyportfolio) “<em>make nodes an array of objects rather than an array of strings</em>” (I don’t really know what that means :-(. I just know it works :-).)</p>

<p>There you have it. A Sankey diagram from a csv file. Well played @timelyportfolio!</p>

<h4 id="leanpub-auto-from-mysql-as-link-information-only-automatically">From MySQL as link information (only automatically).</h4>

<p>So, here we are. Faced with a dilemma of trying to get my csv formatted links into a Sankey diagram. In theory we need to go through our file, identify all the unique nodes and format the entire blob into JSON for use.</p>

<p>There must be a better way!</p>

<p>Well, I’m not going to claim that this is any better since it’s a little like cracking a walnut with a sledgehammer. But to a man with just a sledgehammer, everything’s a walnut.</p>

<p>So, let’s use our MySQL and PHP skills to solve our problem. In fact, let’s make it slightly harder for ourselves. Let’s imagine that we don’t even <em>have</em> a value associated with our data, just a big line of source and target links. Something like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>source,target
Barry,Elvis
Barry,Elvis
Frodo,Elvis
Frodo,Elvis
Frodo,Sarah
Frodo,Sarah
Barry,Alice
Barry,Alice
Elvis,Sarah
Elvis,Sarah
Elvis,Alice
Elvis,Alice
Sarah,Alice
Sarah,Alice
Sarah,Alice
Sarah,Alice
</pre></div>

</figure>

<p>First thing first, just as we did in the example on using MySQL, import your csv file into a MySQL table which we’ll call <code>sankey1</code> in database <code>homedb</code>.</p>

<p>Now we want to write a  query that pulls out all the DISTINCT names that appear it the ‘source’ and ‘target’ columns. This will form our ‘nodes’ portion of the JSON data.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="k">DISTINCT</code><code class="p">(</code><code class="o">`</code><code class="k">source</code><code class="o">`</code><code class="p">)</code> <code class="k">AS</code> <code class="n">name</code> <code class="k">FROM</code> <code class="o">`</code><code class="n">sankey1</code><code class="o">`</code>
<code class="k">UNION</code>
<code class="k">SELECT</code> <code class="k">DISTINCT</code><code class="p">(</code><code class="o">`</code><code class="n">target</code><code class="o">`</code><code class="p">)</code> <code class="k">AS</code> <code class="n">name</code> <code class="k">FROM</code> <code class="o">`</code><code class="n">sankey1</code><code class="o">`</code>
<code class="k">GROUP</code> <code class="k">BY</code> <code class="n">name</code>
</pre></div>

</figure>

<p>This query actually mashes two separate queries together where each returns DISTINCT instances of each <code>source</code> and <code>target</code> from the source and target columns. By default, the UNION operator eliminates duplicate rows from the result which means we have a list of each node in the table.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey07.png" alt="Sankey nodes from MySQL">
  <figcaption>Sankey nodes from MySQL</figcaption>
</figure>


<p>Exxxeellennt……. (channelling Mr Burns)</p>

<p>Now we run a separate query that pulls out each distinct ‘source’ and ‘target’ combination and the number of times (COUNT(*)) that it occurs.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="o">`</code><code class="k">source</code><code class="o">`</code> <code class="k">AS</code> <code class="k">source</code><code class="p">,</code> <code class="o">`</code><code class="n">target</code><code class="o">`</code>  <code class="k">as</code> <code class="n">target</code><code class="p">,</code> <code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code> <code class="k">as</code> <code class="n">value</code> 
<code class="k">FROM</code> <code class="o">`</code><code class="n">sankey1</code><code class="o">`</code>
<code class="k">GROUP</code> <code class="k">BY</code> <code class="k">source</code><code class="p">,</code> <code class="n">target</code> 
</pre></div>

</figure>

<p>This query gets all the sources plus all the targets and groups them by first the source and then the target. Each line is therefore unique and the <code>COUNT(*)</code> sums up the number of times that each unique combination occurs.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey08.png" alt="Sankey links from MySQL">
  <figcaption>Sankey links from MySQL</figcaption>
</figure>


<p>That was surprisingly easy wasn’t it?</p>

<p>MySQL is good for simple jobs, but we are of course a long way from finished since at this stage all we have is what looks like two tables in a spreadsheet.</p>

<p>So now we turn to PHP.</p>

<p>Remembering from the start of the book, we described PHP as the glue that could connect parts of web pages together. In this case we will use it to glue our MySQL database to our JavaScript.</p>

<p>We need to carry out our queries and return the information in a format that d3.js can understand. In this instance we will select JSON as it’s probably the most ubiquitous, and it suits the format of our original manual data.</p>

<p>Let’s cut to the chase and look at the code:</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="o">&lt;?</code><code class="nx">php</code>
    <code class="nv">$username</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code> 
    <code class="nv">$password</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code>   
    <code class="nv">$host</code> <code class="o">=</code> <code class="s2">"localhost"</code><code class="p">;</code>
    <code class="nv">$database</code><code class="o">=</code><code class="s2">"homedb"</code><code class="p">;</code>
    
    <code class="nv">$server</code> <code class="o">=</code> <code class="nb">mysql_connect</code><code class="p">(</code><code class="nv">$host</code><code class="p">,</code> <code class="nv">$username</code><code class="p">,</code> <code class="nv">$password</code><code class="p">);</code>
    <code class="nv">$connection</code> <code class="o">=</code> <code class="nb">mysql_select_db</code><code class="p">(</code><code class="nv">$database</code><code class="p">,</code> <code class="nv">$server</code><code class="p">);</code>

    <code class="nv">$myquery</code> <code class="o">=</code> <code class="s2">"</code>
<code class="s2">SELECT DISTINCT(`source`) AS name FROM `sankey1`</code>
<code class="s2">UNION</code>
<code class="s2">SELECT DISTINCT(`target`) AS name FROM `sankey1`</code>
<code class="s2">GROUP BY name</code>
<code class="s2">"</code><code class="p">;</code>
    <code class="nv">$query</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$myquery</code><code class="p">);</code>
    
    <code class="k">if</code> <code class="p">(</code> <code class="o">!</code> <code class="nv">$myquery</code> <code class="p">)</code> <code class="p">{</code>
        <code class="k">echo</code> <code class="nb">mysql_error</code><code class="p">();</code>
        <code class="k">die</code><code class="p">;</code>
    <code class="p">}</code>
    
    <code class="nv">$nodes</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>
    
    <code class="k">for</code> <code class="p">(</code><code class="nv">$x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$x</code> <code class="o">&lt;</code> <code class="nb">mysql_num_rows</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code> <code class="nv">$x</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="nv">$nodes</code><code class="p">[]</code> <code class="o">=</code> <code class="nb">mysql_fetch_assoc</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="nv">$myquery</code> <code class="o">=</code> <code class="s2">"</code>
<code class="s2">SELECT `source` AS source, `target`  as target, COUNT(*) as value </code>
<code class="s2">FROM `sankey1`</code>
<code class="s2">GROUP BY source, target </code>
<code class="s2">"</code><code class="p">;</code>
    <code class="nv">$query</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$myquery</code><code class="p">);</code>
    
    <code class="k">if</code> <code class="p">(</code> <code class="o">!</code> <code class="nv">$myquery</code> <code class="p">)</code> <code class="p">{</code>
        <code class="k">echo</code> <code class="nb">mysql_error</code><code class="p">();</code>
       <code class="k">die</code><code class="p">;</code>
    <code class="p">}</code>
    
    <code class="nv">$links</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>
    
    <code class="k">for</code> <code class="p">(</code><code class="nv">$x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$x</code> <code class="o">&lt;</code> <code class="nb">mysql_num_rows</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code> <code class="nv">$x</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="nv">$links</code><code class="p">[]</code> <code class="o">=</code> <code class="nb">mysql_fetch_assoc</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
    <code class="p">}</code>

<code class="k">echo</code> <code class="s2">"{"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s1">'"links": '</code><code class="p">,</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$links</code><code class="p">),</code> <code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s1">',"nodes": '</code><code class="p">,</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$nodes</code><code class="p">),</code> <code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s2">"}"</code><code class="p">;</code>

    <code class="nb">mysql_close</code><code class="p">(</code><code class="nv">$server</code><code class="p">);</code>
<code class="cp">?&gt;</code><code class="x"></code>
</pre></div>

</figure>

<p>Astute readers will recognise that this is very similar to the script that we used to extract data from the MySQL database for generating a simple line graph. If you haven’t checked it out, and you’re unfamiliar with PHP, you will want to read that section first.</p>

<p>We declare all the appropriate variables which we will use to connect to the database. We then connect to the database and run our query.</p>

<p>After that we store the nodes data in an array called <code>$nodes</code>.</p>

<p>Then we run our second query (we don’t close the connection to the database since we’re not finished with it yet).</p>

<p>The second query returns the link results into a second array called <code>$links</code> (pretty imaginative).</p>

<p>Now we come to a part that’s a bit different. We still need to echo out the data in the same way we did in our line graph, but in this case we need to add the data together with the associated  <code>links</code> and <code>nodes</code> identifiers. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">echo</code> <code class="s2">"{"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s1">'"links": '</code><code class="p">,</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$links</code><code class="p">),</code> <code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s1">',"nodes": '</code><code class="p">,</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$nodes</code><code class="p">),</code> <code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s2">"}"</code><code class="p">;</code>
</pre></div>

</figure>

<p>(if you look closely, the syntax will produce our JSON formatted output).</p>

<p>At last, we need to call this PHP script from our html file in the same way that we did for the line graph. So amend the html file to change the loading of the JSON data to be from our PHP file thusly;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"php/sankey.php"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>And there you have it! So many ways to get the data.</p>

<p>Both the PHP file (sankey.php) and the html file (sankey-mysql-import.html) are available as code samples bundled with this book.</p>

<h3 id="leanpub-auto-sankey-diagram-case-study">Sankey diagram case study</h3>

<p>Armed with all this new found knowledge on building Sankey diagrams, what can you do?</p>

<p>Well, I suppose it all depends on your data set, but remember, Sankey diagrams are good at flows, but they won’t do loops / cycles easily (although there has been some good work done in this direction <a href="http://bl.ocks.org/cfergus/3956043">here http://bl.ocks.org/cfergus/3956043</a> and <a href="http://bl.ocks.org/kunalb/4658510">here http://bl.ocks.org/kunalb/4658510</a>).</p>

<p>So let’s choose a flow.</p>

<p>In this case we’ll selected the flow of data that represents a view of global, anthropogenic greenhouse gas (GHG) emissions. The image is an alternative to the excellent diagram on the World Resources Institute (http://www.wri.org/chart/world-greenhouse-gas-emissions-2005) and as such my version pales in comparison to theirs.</p>

<p>However, the aim is to play with the technique, not to emulate :-).</p>

<p>So starting with the data presented in the original diagram, we have to capture the links into a csv file. I did this the hard way (since there didn’t appear to be an electronic version of the data) by reading the graph and entering the figures into a csv file. From here we import it into our MySQL database and then convert it into sankey formatted JSON by using our PHP script that we played with in the example of extracting information from a MySQL database. In this case, instead of needing to perform a <code>COUNT(*)</code> on the data, it’s slightly easier since the value is already present.</p>

<p>Because we want this diagram to be hosted on Gist and accessible on bl.ocks.org, we run the PHP file directly into the browser so that it just shows the JSON data on the screen. We save this file with the suffix <code>.json</code> and we have our data (in this case the file is named <code>sankeygreenhouse.json</code>).</p>

<p>We amend our html file to look at our new <code>.json</code> file and voila!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/sankey09.png" alt="Sankey diagram of greenhouse gas emissions in 2005">
  <figcaption>Sankey diagram of greenhouse gas emissions in 2005</figcaption>
</figure>


<p>Sankeytastic!</p>

<p>You can find this as a live example and with all the code and data on <a href="http://bl.ocks.org/d3noob/5015397">bl.ocks.org</a>.</p>

<h2 id="leanpub-auto-tree-diagrams">Tree Diagrams</h2>

<h3 id="leanpub-auto-what-is-a-tree-diagram">What is a Tree Diagram?</h3>

<p>The ‘<a href="https://github.com/mbostock/d3/wiki/Tree-Layout">Tree layout</a>’ is not a distinct type of diagram per se. Instead, it’s representative of D3’s family of hierarchical layouts. </p>

<p>It’s designed to produce a ‘node-link’ diagram that lays out the connection between nodes in a method that displays the relationship of one node to another in a parent-child fashion.</p>

<p>For example, the following diagram shows a root node (the starting position) labelled ‘Top Node’ which has two children (Bob: Child of Top Node and Sally: Child of Top Node). Subsequently, Bob:Child of Top Node has two dependant nodes (children) ‘Son of Bob’ and ‘Daughter of Bob’.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-01.png" alt="Tree layout diagram">
  <figcaption>Tree layout diagram</figcaption>
</figure>


<p>The clear advantage to this style of diagram is that describing it in text is difficult, but representing it graphically makes the relationships easy to determine.</p>

<p>The data required to produce this type of layout needs to describe the relationships, but this is not necessarily an onerous task. For example, the following is the data (in JSON form) for the diagram above and it shows the minimum information required to form the correct layout hierarchy.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  {
    "name": "Top Node",
    "children": [
      {
        "name": "Bob: Child of Top Node",
        "parent": "Top Node",
        "children": [
          {
            "name": "Son of Bob",
            "parent": "Bob: Child of Top Node"
          },
          {
            "name": "Daughter of Bob",
            "parent": "Bob: Child of Top Node"
          }
        ]
      },
      {
        "name": "Sally: Child of Top Node",
        "parent": "Top Node"
      }
    ]
  }
</pre></div>

</figure>

<p>It shows each node as having a name that identifies it on the tree and, where appropriate, the children it has (as an array) and its parent.</p>

<aside class="information blurb">
    <p>The data shown above is arranged as a hierarchy and it is not always possible to source data that is organised so nicely. As we go through use examples for this type of diagram we will look at options for importing ‘flat’ data and converting it into a hierarchical form.</p>

</aside>

<p>There is a wealth of examples of tree diagrams on the web, but I would recommend a visit to the <a href="http://christopheviau.com/d3list/gallery.html#visualizationType=tree">D3.js gallery</a> maintained by Christophe Viau as a starting point to get some ideas.</p>

<p>In this chapter we’re going to look at a very simple piece of code to generate a tree diagram before looking at different ways to adapt it. Including rotating it to be vertical, adding some dynamic styling to the nodes, importing from a flat file and from an external source. Finally we’ll look at a more complex example that is more commonly used on the web that allows a user to expand and collapse nodes interactively.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-a-simple-tree-diagram-explained">A simple Tree Diagram explained</h3>

<p>We are going to work through a simple example of the code that draws a tree diagram, This is more for the understanding of the process rather than because it is a good example of code for drawing a tree diagram. It is a very limited example that lacks any real interactivity which is one of the strengths of d3.js graphics. However, we will outline the operation of an interactive version towards the end of the chapter once we have explored some possible configuration options that we might want to make.</p>

<p>The graphic that we are going to generate will look like this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-02.png" alt="Simple tree layout diagram">
  <figcaption>Simple tree layout diagram</figcaption>
</figure>


<p>And the full code for it looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">"en"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Collapsible Tree Example<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

	<code class="nc">.node</code> <code class="nt">circle</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">3px</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>

	<code class="nc">.link</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
	<code class="p">}</code>
	
    <code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>

  <code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
	
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"null"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">}</code>
<code class="p">];</code>

<code class="c1">// ************** Generate the tree diagram	 *****************</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">120</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
	<code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">,</code>
	<code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
	
<code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">tree</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">diagonal</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">diagonal</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">];</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
  
<code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>

<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">source</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// Compute the new tree layout.</code>
  <code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">root</code><code class="p">).</code><code class="nx">reverse</code><code class="p">(),</code>
	  <code class="nx">links</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>

  <code class="c1">// Normalize for fixed-depth.</code>
  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">*</code> <code class="mi">180</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Declare the nodesâ€¦</code>
  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"g.node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nodes</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">||</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="o">++</code><code class="nx">i</code><code class="p">);</code> <code class="p">});</code>

  <code class="c1">// Enter the nodes.</code>
  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"#fff"</code><code class="p">);</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"end"</code> <code class="o">:</code> <code class="s2">"start"</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

  <code class="c1">// Declare the linksâ€¦</code>
  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path.link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">links</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Enter the links.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code> <code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">diagonal</code><code class="p">);</code>

<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
	
  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8323795">github</a>, in the appendices of this book or in the code samples bundled with this book (simple-tree-diagram.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/8323795">bl.ocks.org</a>. </p>

</aside>

<p>In the course of describing the operation of the file I will gloss over the aspects of the structure of an HTML file which have already been described at the start of the book. Likewise, aspects of the JavaScript functions that have already been covered will only be briefly explained.</p>

<p>The start of the file deals with setting up the document’s head and body loading the d3.js script and setting up the css in the <code>&lt;style&gt;</code> section.</p>

<p>The css section sets styling for the circle that represents the nodes, the text alongside them and the links between them.</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="nc">.node</code> <code class="nt">circle</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">3px</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>

	<code class="nc">.link</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
	<code class="p">}</code>
</pre></div>

</figure>

<p>Then our JavaScript section starts and the first thing that happens is that we declare our array of data in the following code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"null"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">}</code>
<code class="p">];</code>
</pre></div>

</figure>

<p>As outlined at the start of the chapter, this data is encoded hierarchically in JavaScript Object Notation (JSON). Each node must have a name and either a parent or child node(s) or both. There are many examples of hierarchical data that can be encoded in this way. From the traditional parent - offspring example to directories on a hard drive or a breakdown of materials for a complex object. Any system of encoding where there is a single outcome from multiple sources like an election or an alert encoding system dependent on multiple trigger points.</p>

<p>The next section of our code declares some of the standard features for our diagram such as the size and shape of the svg container with margins included.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">120</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
	<code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">,</code>
	<code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
	
<code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">tree</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code> 
</pre></div>

</figure>

<p>It also assigns the variable / function <code>tree</code> to the <a href="https://github.com/mbostock/d3/wiki/Tree-Layout">d3.js function</a> that is used to assign and calculate the data required for the nodes and links for our diagram. We will be calling that later. </p>

<p>The next block of code declares the function that will be used to draw the links between the nodes. This isn’t the part of the code where the links are drawn, this is just declaring the variable/function that will be used when it does happen.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">diagonal</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">diagonal</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">];</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This uses the <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-diagonal">d3.js diagonal</a> function to help draw a path between two points such that the line exhibits some nice flowing curves (cubic BÃ©zier ) to make the connection.</p>

<p>The next block of code appends our SVG working area to the body of our web page and creates a group elements (<code>&lt;g&gt;</code>) that will contain our svg objects (our nodes, text and links).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The next line is one that vexed me for a while and one that I think means there are other areas of my code that could be improved (for a short interlude on why this tried me, feel free to catch <a href="http://stackoverflow.com/questions/20940854/how-to-load-data-from-an-internal-json-array-rather-than-from-an-external-resour">this question</a> on Stack Overflow).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
</pre></div>

</figure>

<p>It might not look like much and to those familiar with JavaScript, it will be a no-brainer, but what the line is doing is defining what ‘tree’ from our data is going to be used. Because our data is an array, the first level of the array is <code>treeData</code>. The name of the first object on the first level of <code>treeData</code> is ‘Top Level’. This (being the first object) is object 0. Therefore our starting point is <code>treeData[0]</code>. We could confirm this by changing the declaration to … </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">children</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
</pre></div>

</figure>

<p>This will take the root point for our diagram as being the first child (<code>child[0]</code>) of the the first level of <code>treeData</code>. As a result, our tree diagram will look like this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-03.png" alt="Tree layout diagram using a different root point">
  <figcaption>Tree layout diagram using a different root point</figcaption>
</figure>


<p>… since ‘Level 2: A’ is the first child of ‘Top Level’.</p>

<p>Then we call the function that draws our tree diagram.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>
</pre></div>

</figure>

<p>This calls the function <code>update</code> and uses the data <code>root</code> to create our tree.</p>

<p>The last significant part of the code is the function <code>update</code>. This is the part of the code that pulls together the functions and data that we have declared and draws our tree.</p>

<p>The first step in that process is to assign our nodes and links.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">root</code><code class="p">),</code>
	  <code class="nx">links</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>
</pre></div>

</figure>

<p>This uses our previously declared <code>tree</code> function to work its d3.js magic on our data (<code>root</code>) and to determine the node details and from the node details we can determine the link details.</p>

<p>If you’re wondering how this all works, I’m afraid that I won’t be able to help much, but a starting point would be the results that the process produces which is a set of nodes, each of which has a set of characteristics. Those characteristics are;
- <code>.children</code>: Which is an array of any children that exist for that node.
- <code>.depth</code>: Which is the depth (described in a few paragraphs time).
- <code>.id</code>: Which is a unique number identifier for each node.
- <code>.name</code>: The name we have assigned from our data.
- <code>.parent</code>: The name of the parent of the node.
- <code>.x</code> and <code>.y</code>: Which are the x and y positions on the screen of the node.</p>

<p>From this node data a set of links joining the nodes is created. Each link consists of a <code>.source</code> and <code>.target</code>. Each of which is a node.</p>

<p>We then determine the horizontal spacing of the nodes.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">*</code> <code class="mi">180</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This uses the depth of the node (as determined for each node in the <code>nodes = tree.nodes(root)</code> line) to calculate the position on the y axis of the screen.</p>

<p>The <code>depth</code> refers to the position in the tree relative to the root node on the left. The following picture shows how the depth relates to the position of the node in the tree.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-05.png" alt="Depth of nodes on the tree">
  <figcaption>Depth of nodes on the tree</figcaption>
</figure>


<p>So by adjusting our ‘expansion factor’ (currently set to 180) we can adjust the spacing of the nodes. For instance, here is the spacing changed to 80.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-04.png" alt="Adjusting the depth of the tree">
  <figcaption>Adjusting the depth of the tree</figcaption>
</figure>


<p>We then declare the variable / function <code>node</code> so that when we call it later it will know to select the appropriate object (a node) with the appropriate <code>.id</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"g.node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nodes</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">||</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="o">++</code><code class="nx">i</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The next block of code assigns the variable / function <code>nodeEnter</code> to the action of appending a node to a particular position.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>Then we get to the piece of code that appends the circle that comprises the node (using <code>nodeEnter</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"#fff"</code><code class="p">);</code>
</pre></div>

</figure>

<p>(using a radius of 10 pixels and a white fill).</p>

<p>And we add in the text for each node…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"end"</code> <code class="o">:</code> <code class="s2">"start"</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
</pre></div>

</figure>

<p>This is a neat piece of code that allows the text to be placed on the left side of the node if it has children (<code>d.children</code>) or on the right if it has has no children or <code>d._children</code>. This is a slightly redundant piece of code (the <code>d._children</code> piece) for this diagram, but it becomes more useful in the interactive version towards the end of the chapter. It also aligns the text correctly and makes sure it is visible.</p>

<p>Then we declare the link variable / function and tell it to make a link based on all the links that have unique target id’s. </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path.link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">links</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This might not be obvious at first glance, but we only want to draw links between a node and it’s parent. There should be one less link than the total number of nodes since the root node (‘Top Level’) has no parent. Therefore only those links with unique target id’s in the data need to have links produced. If we were to replace the <code>.target</code> in the above code with <code>.source</code> we would have only two unique <code>.source</code> id’s. It would therefore look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-06.png" alt="Only Links from unique sources">
  <figcaption>Only Links from unique sources</figcaption>
</figure>


<p>Our final block of JavaScript adds in our link as a diagonal path (as declared early in the JavaScript portion of the code).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">link</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code> <code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">diagonal</code><code class="p">);</code>
</pre></div>

</figure>

<p>There are only a couple of lines of HTML to close off the file and we are left with our tree diagram!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-02.png" alt="Simple tree layout diagram">
  <figcaption>Simple tree layout diagram</figcaption>
</figure>


<p>Don’t forget, the full code for this example can be found on <a href="https://gist.github.com/d3noob/8323795">github</a>, in the appendices of this book or in the code samples bundled with this book (simple-tree-diagram.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/8323795">bl.ocks.org</a>. </p>

<div class="page-break"></div>
<h3 id="leanpub-auto-styling-nodes-in-a-tree-diagram">Styling nodes in a tree diagram</h3>

<p>The nodes in a tree diagram are objects that exist to provide a representation of the structure of data, but on a tree diagram they should also be viewed as an opportunity to encode additional information about the underlying data. </p>

<p>From the initial simple example that we covered at the start of the chapter we have encoded a certain amount of information already. The position of the text relative to each node is determined by whether or not the node is the parent of another node (if it’s a parent it’s on the left) or a child that is on the edge of the tree (in which case it is on the right of the node).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-02.png" alt="Node position on the tree diagram">
  <figcaption>Node position on the tree diagram</figcaption>
</figure>


<p>Now, that’s nice, but are we going to be satisfied with that??? (The answer is “No” by the way.)</p>

<p>This example is fairly simple, but it is an example of applying different styles to the nodes to convey additional information. I should be clear at this stage that I am not advocating turning your tree diagram into something that looks like it came out of a circus, because that would be a crime against style, so don’t repeat my upcoming example, but let some of the features be a trigger for developing your own subtle, yet compelling visualizations.</p>

<p>Brace yourself. Here’s a picture of the tree diagram that we’re going to generate. Those with weaker constitutions should look away and flip forward a few pages;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-07.png" alt="Tree diagram with excessive styling">
  <figcaption>Tree diagram with excessive styling</figcaption>
</figure>


<p>The changes that have been made are as a result of additional data fields that have been added to the JSON array and these fields have been applied to various style options throughout the code.</p>

<p>The types of style changes we have made are
- Variation of the diameter of nodes
- Changing the fill and stroke colour of nodes
- Changing the colour of links depending on the associated target node they connect to.</p>

<p>We’ll start by looking at the new JSON data set;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  {
    "name": "Top Level",
    "parent": "null",
    "value": 10,
    "type": "black",
    "level": "red",
    "children": [
      {
        "name": "Level 2: A",
        "parent": "Top Level",
        "value": 15,
        "type": "grey",
        "level": "red",
        "children": [
          {
            "name": "Son of A",
            "parent": "Level 2: A",
            "value": 5,
            "type": "steelblue",
            "level": "orange"
          },
          {
            "name": "Daughter of A",
            "parent": "Level 2: A",
            "value": 8,
            "type": "steelblue",
            "level": "red"
          }
        ]
      },
      {
        "name": "Level 2: B",
        "parent": "Top Level",
        "value": 10,
        "type": "grey",
        "level": "green"
      }
    ]
  }
</pre></div>

</figure>

<p>Each node now has a <code>value</code> which might represent a degree of importance (we will use this to affect the radius of the nodes), a <code>type</code> which might indicate a difference in the type of node (they might be in active, inactive or undetermined states) and a <code>level</code> which might indicate an alert level for determining problems (red = bad, orange = caution and green = normal).</p>

<p>Irrespective of the contrived nature of our styling options, they are applied to our tree in fairly similar ways with some subtle differences.</p>

<p>Remember, the full code for this example can be found on <a href="https://gist.github.com/d3noob/8324872">github</a> or in the code samples bundled with this book (simple-tree-features.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/8324872">bl.ocks.org</a>.</p>

<p>The first change is to the node radius, stroke colour and fill colour.</p>

<p>We simply change the portion of the code that appends the circle from this…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"#fff"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… to this …</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">type</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">level</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The changes return the radius attribute as a function using <code>value</code>, the stroke colour is returned using <code>type</code> and the fill colour is returned with <code>level</code>. This is nice and simple, but we do need to make a slight adjustment to the code that sets the distance that the text is from the nodes so that when the radius expands or contracts, the text distance from the edge of the node adjusts as well.</p>

<p>To do this we take the clever piece of code that adjusts the distance that the text is in the x dimension from the node that looks like this … </p>

<figure class="code">
<div class="highlight"><pre><code></code>	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
</pre></div>

</figure>

<p>… and we add in a dynamic aspect using the <code>value</code> field.</p>

<figure class="code">
<div class="highlight"><pre><code></code>	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> 
		  <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">+</code> <code class="mi">4</code><code class="p">)</code> <code class="o">*</code> <code class="o">-</code><code class="mi">1</code> <code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">+</code> <code class="mi">4</code> <code class="p">})</code>
</pre></div>

</figure>

<p>The last thing we wanted to do is to change the colour of the link based on the colour of the target node. We accomplish this by taking the code that inserts the links…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">link</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code> <code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">diagonal</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and adding in a line that styles the link colour (the stroke) based on the <code>level</code> colour of the <code>target</code> end of the link <code>d.target.level</code>). </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">link</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code> <code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">level</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">diagonal</code><code class="p">);</code>
</pre></div>

</figure>

<p>Use the concepts here wisely. I don’t want to see any heinously styled tree diagrams floating around the internet with “Thanks to the help from D3 Tips and Tricks” next to them. Be subtle, be thoughtful :-).</p>

<h4 id="leanpub-auto-changing-the-nodes-to-different-shapes">Changing the nodes to different shapes</h4>

<p>Many thanks to Josiah who <a href="http://www.d3noob.org/2014/01/tree-diagrams-in-d3js_11.html?showComment=1398062145979#c8289012474475643167">asked a question</a> on the d3noob.org blog on how the shapes of the nodes could be varied based on an associated value in the data.</p>

<p>There is more than one way to do this, but perhaps the simplest is to replace the section of the JavaScript that appends the circle with one that appends a symbol from d3’s <a href="https://github.com/mbostock/d3/wiki/SVG-Shapes#symbol">symbol generator</a>.</p>

<p>There are six pre-defined symbol types as follows;</p>

<ul>
  <li>circle - a circle.</li>
  <li>cross - a Greek cross or plus sign.</li>
  <li>diamond - a rhombus.</li>
  <li>square - an axis-aligned square.</li>
  <li>triangle-down - a downward-pointing equilateral triangle.</li>
  <li>triangle-up - an upward-pointing equilateral triangle.</li>
</ul>

<p>The following script will look at the <code>value</code> in the data and assign either a cross or a diamond depending on the <code>value</code></p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"white"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">symbol</code><code class="p">()</code>
                 <code class="p">.</code><code class="nx">size</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>
                 <code class="p">.</code><code class="nx">type</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">if</code>
                    <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">&gt;=</code> <code class="mi">9</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"cross"</code><code class="p">;</code> <code class="p">}</code> <code class="k">else</code> <code class="k">if</code>
                    <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">&lt;=</code> <code class="mi">9</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"diamond"</code><code class="p">;}</code>
                  <code class="p">}));</code> 
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-12.png" alt="Tree diagram different node shapes">
  <figcaption>Tree diagram different node shapes</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/11137963">github</a> or in the code samples bundled with this book (simple-tree-shapes.html). A working online example can be found on <a href="http://bl.ocks.org/d3noob/11137963">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-using-images-as-nodes">Using images as nodes</h4>

<p>Many thanks to nbhatta who <a href="http://www.d3noob.org/2014/01/tree-diagrams-in-d3js_11.html?showComment=1399025834455#c4911480988339223702">asked a question</a> on the d3noob.org blog on how to use images as nodes.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-13.png" alt="Tree diagram with images for nodes">
  <figcaption>Tree diagram with images for nodes</figcaption>
</figure>


<p>This was a slightly simpler change and just involved replacing the code snippet that added the circles with one that added an image;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"image"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">icon</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="s2">"-12px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="s2">"-12px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="s2">"24px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="s2">"24px"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The images I chose were all 48 x 48 pixel for the sake of consistency and in the code above I formatted them to be half that size and moved them in the x and y direction so that they were centred correctly.</p>

<p>The cool thing that you will notice is that the specific icon that is placed at each node position is set by the name of the icon which is gathered from the JSON file with the tree details;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"null"</code><code class="p">,</code>
    <code class="s2">"value"</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
    <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">,</code>
    <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>
    <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"earth.png"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
        <code class="s2">"value"</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
        <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"grey"</code><code class="p">,</code>
        <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>
       <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"cart.png"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
            <code class="s2">"value"</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
            <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"steelblue"</code><code class="p">,</code>
            <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"lettern.png"</code><code class="p">,</code>
            <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"orange"</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
            <code class="s2">"value"</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
            <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"steelblue"</code><code class="p">,</code>
            <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"vlc.png"</code><code class="p">,</code>
            <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"red"</code>
          <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
        <code class="s2">"value"</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
        <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"grey"</code><code class="p">,</code>
        <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"random.png"</code><code class="p">,</code>
        <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"green"</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">}</code>
<code class="p">];</code>
</pre></div>

</figure>

<p>It’s possible to just have a single image and to hard-code it into the script, but where’s the fun in that? </p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/9662ab6d5ac823c0e444">github</a> or in the code samples bundled with this book (simple-tree-images.html, cart.png, earth.png, lettern.png, random.png and vlc.png). A working online example can be found on <a href="http://bl.ocks.org/d3noob/9662ab6d5ac823c0e444">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-making-a-vertical-tree-diagram">Making a vertical tree diagram</h3>

<p>Changing a tree diagram from a horizontal view to a vertical one is fairly easy. There are only three things to change from the code that we used for our original simple tree diagram.</p>

<p>The first is to change the orientation of the nodes by transposing the x and y coordinates.</p>

<p>That means taking the section of code that appends the nodes…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>… and swapping the <code>d.x</code> and <code>d.y</code> designators so that it looks like this…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>Because the vertical version of the tree diagram can be a lot more compact, we can adjust our difference between the depths to a more rational value. In our example we can change the separation from 180 to 100 pixels in the following line of code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">*</code> <code class="mi">100</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The second is to do the same adjustment for the links. We take the block of code that generates the curvy diagonal paths…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">diagonal</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">diagonal</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">];</code> <code class="p">});</code>
</pre></div>

</figure>

<p>… and swap the <code>d.x</code> and <code>d.y</code> designators so that it looks like this…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">diagonal</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">diagonal</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">];</code> <code class="p">});</code>
</pre></div>

</figure>

<p>At this point we have our tree diagram ready to go except for one small detail…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-08.png" alt="Vertical tree diagram with sideways text">
  <figcaption>Vertical tree diagram with sideways text</figcaption>
</figure>


<p>The text is still aligned to the left and right of the nodes. On this example, it looks pretty good, but if we were to introduce a few more nodes, it would start to get pretty cramped, so we can place the text above and below the nodes dependent on whether the node is a parent (above) or a child on the bottom level (below).</p>

<p>To do this we take the original text appending code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"end"</code> <code class="o">:</code> <code class="s2">"start"</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and change the <code>x</code> attribute to a <code>y</code> attribute, anchor the text in the middle (which is actually a simplification of the code) and extend the distance between the node and the anchor point slightly to 18 (and -18) pixels.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">18</code> <code class="o">:</code> <code class="mi">18</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
</pre></div>

</figure>

<p>And there we have it! A vertical tree diagram.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-09.png" alt="Vertical tree diagram">
  <figcaption>Vertical tree diagram</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8326869">github</a> or in the code samples bundled with this book (simple-tree-vertical.html). A working online example can be found on <a href="http://bl.ocks.org/d3noob/8326869">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h3 id="treeFromFlat">Generating a tree diagram from ‘flat’ data</h3>

<p>Tree diagrams are a fantastic way of displaying information, but one of the drawbacks (to the examples we’ve been using so far) is the need to have your data encoded hierarchically. Most data in a raw form will be flat. That is to say, it won’t be formatted as an array with the parent - child relationships. Instead it will be a list of objects (which we will want to turn into nodes) that might describe the relationship to each other, but they won’t be encoded that way. For example, the following is the flat representation of the example data we have been using thus far.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    { "name" : "Level 2: A", "parent":"Top Level" },
    { "name" : "Top Level", "parent":"null" },
    { "name" : "Son of A", "parent":"Level 2: A" },
    { "name" : "Daughter of A", "parent":"Level 2: A" },
    { "name" : "Level 2: B", "parent":"Top Level" }
</pre></div>

</figure>

<p>It is actually fairly simple and consists of only the name of the node and the name of it’s parent node. It’s easy to see how this data could be developed into a hierarchical form, but it would take a little time and for a larger data set, that would be tiresome.</p>

<p>Luckily computers are built for shuffling data about and with kudos to ‘nrabinowitz’ for <a href="http://stackoverflow.com/questions/17847131/generate-multilevel-flare-json-data-format-from-flat-json">answering a question</a> (and Prateek Tandon for asking) on Stack Overflow (and <a href="http://stackoverflow.com/questions/20940854/how-to-load-data-from-an-internal-json-array-rather-than-from-an-external-resour">Jesus Ruiz with AmeliaBR for setting me on the right path</a>), here is how we can take our flat data and convert it for use in our tree diagram.</p>

<p>We will be using the simple example that we started with at the start of the chapter and the first change we need to make is to replace our original data…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"null"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">}</code>
<code class="p">];</code>
</pre></div>

</figure>

<p>… with our flat data array…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code><code class="s2">"Top Level"</code> <code class="p">},</code>
    <code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code><code class="s2">"null"</code> <code class="p">},</code>
    <code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code><code class="s2">"Level 2: A"</code> <code class="p">},</code>
    <code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code><code class="s2">"Level 2: A"</code> <code class="p">},</code>
    <code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code><code class="s2">"Top Level"</code> <code class="p">}</code>
    <code class="p">];</code>
</pre></div>

</figure>

<p>It’s worth noting here that we have also changed the name of the array (to <code>data</code>) since we are going to convert, then declare our newly massaged data with our original variable name <code>treeData</code> so that the remainder of our code thinks there have been no changes.</p>

<p>Then we create a name-based map for the nodes. In his answer on Stack Overflow, ‘nrabinowitz’ uses the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce">.reduce method</a>, which starts with an empty object and iterates over the data array, adding an entry for each node.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">dataMap</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">reduce</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">map</code><code class="p">,</code> <code class="nx">node</code><code class="p">)</code> <code class="p">{</code>
	<code class="nx">map</code><code class="p">[</code><code class="nx">node</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">node</code><code class="p">;</code>
	<code class="k">return</code> <code class="nx">map</code><code class="p">;</code>
<code class="p">},</code> <code class="p">{});</code>
</pre></div>

</figure>

<p>Don’t feel upset if you don’t understand exactly how it works. I struggle to understand internal combustion engines, but I’m ok at driving a car :-). Think of this in the same way.</p>

<p>Then we iteratively add each child to its parents, or to the root array if no parent is found;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[];</code>
<code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">node</code><code class="p">)</code> <code class="p">{</code>
	<code class="c1">// add to parent</code>
	<code class="kd">var</code> <code class="nx">parent</code> <code class="o">=</code> <code class="nx">dataMap</code><code class="p">[</code><code class="nx">node</code><code class="p">.</code><code class="nx">parent</code><code class="p">];</code>
	<code class="k">if</code> <code class="p">(</code><code class="nx">parent</code><code class="p">)</code> <code class="p">{</code>
		<code class="c1">// create child array if it doesn't exist</code>
		<code class="p">(</code><code class="nx">parent</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="p">(</code><code class="nx">parent</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="p">[]))</code>
			<code class="c1">// add node to child array</code>
			<code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">node</code><code class="p">);</code>
	<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
		<code class="c1">// parent is null or missing</code>
		<code class="nx">treeData</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">node</code><code class="p">);</code>
	<code class="p">}</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>The code is essentially working through each node in the array and if it has a child it adds it to the <code>children</code> sub-array and if necessary creates the array. Likewise, if the node has no parent, it simply add it as a root node.</p>

<p>That’s it! </p>

<p>The brevity of the code to do this should not detract from its elegance. It really is very clever. The end result doesn’t look any different from our original diagram…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-02.png" alt="Tree diagram (but from flat data)">
  <figcaption>Tree diagram (but from flat data)</figcaption>
</figure>


<p>… but it adds a significant capability for use of additional data.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8329404">github</a> or in the code samples bundled with this book (simple-tree-from-flat.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/8329404">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h3 id="treeFromExternal">Generating a tree diagram from external data</h3>

<p>In all the examples we have looked at so far we have used data that we have declared from within the file itself. Being able to import data from an external file is an important feature that we need to know how to implement.</p>

<p>Starting from the simple tree diagram example that we began with at the start of the chapter, the first change that we need to make is to remove the section of code that declares our data.  But don’t throw it away since we will use it to create a separate file called <code>treeData.json</code>. It’s contents will be;</p>

<figure class="code">
<div class="highlight"><pre><code></code>[
  {
    "name": "Top Level",
    "parent": "null",
    "children": [
      {
        "name": "Level 2: A",
        "parent": "Top Level",
        "children": [
          {
            "name": "Son of A",
            "parent": "Level 2: A"
          },
          {
            "name": "Daughter of A",
            "parent": "Level 2: A"
          }
        ]
      },
      {
        "name": "Level 2: B",
        "parent": "Top Level"
      }
    ]
  }
]
</pre></div>

</figure>

<p>(don’t include the <code>treeData =</code> part, or the semicolon at the end (you <em>can</em> delete those))</p>

<p>Then all we need to do is change the portion of the code that declared the <code>root</code> variable and updates the diagram;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
  
<code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>
</pre></div>

</figure>

<p>… into a small section that uses the <code>d3.json</code> accessor to load  the file <code>treeData.json</code> (Remember to correctly address the file. This one assumes that the <code>treeData.json</code> file is in the same directory as the html file we are opening). </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"treeData.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">treeData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
  <code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>It then declares the variable root in the same way and calls the update function to draw the tree diagram. Viola!</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8329447">github</a> or in the code samples bundled with this book (simple-tree-from-external.html and treeData.json). A working example can be found on <a href="http://bl.ocks.org/d3noob/8329447">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-generating-a-tree-diagram-from-a-csv-file">Generating a tree diagram from a CSV file.</h3>

<p>Creating a tree diagram from a csv file is an extension of the sections where we <a href="#treeFromFlat">create a diagram from flat data</a> and where we <a href="#treeFromExternal">create a diagram from an external file</a>.</p>

<p>By mashing these together and using a csv file something like the following…</p>

<figure class="code">
<div class="highlight"><pre><code></code>name,parent
Level 2: A,Top Level
Top Level,null
Son of A,Level 2: A
Daughter of A,Level 2: A
Level 2: B,Top Level
</pre></div>

</figure>

<p>… we can ingest the name of the nodes and their relationships and then format the data correctly.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-02.png" alt="Tree diagram (but from csv)">
  <figcaption>Tree diagram (but from csv)</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/fa0f16e271cb191ae85f">github</a> or in the code samples bundled with this book (simple-tree-from-csv.html and treedata.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/fa0f16e271cb191ae85f">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-an-interactive-tree-diagram">An interactive tree diagram</h3>

<p>The examples presented thus far have all been static in the sense that they present information on a web page, but that’s where they stop. One of the strengths of web content is the ability to involve the reader to a greater extent. Therefore the following tree diagram example includes an interactive element where the user can click on any parent node and it will collapse on itself to make more room for others or to simplify a view. Additionally, any collapsed parent node can be clicked on and it will re-grow to its previous condition.</p>

<p>The example included here is a close derivative of <a href="http://bl.ocks.org/mbostock/4339083">Mike Bostock’s example</a>. I won’t fully explain the operation of this file, but we will consider parts of it for interest’s sake.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/8375092">github</a>, in the appendices of this book or in the code samples bundled with this book (interactive-tree.html). A working online example can be found on <a href="http://bl.ocks.org/d3noob/8375092">bl.ocks.org</a>.</p>

<p>For a brief visual description of the action. The diagram will initially display the complete tree…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-02.png" alt="Tree diagram)">
  <figcaption>Tree diagram)</figcaption>
</figure>


<p>Then when clicking on the ‘Level 2: A’ node, the tree partially collapses to…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-10.png" alt="Partially collapsed tree diagram)">
  <figcaption>Partially collapsed tree diagram)</figcaption>
</figure>


<p>We could also click on the root node (`Top Level’) to fully collapse the tree…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/tree-11.png" alt="Fully collapsed tree diagram)">
  <figcaption>Fully collapsed tree diagram)</figcaption>
</figure>


<p>Then clicking on the nodes opens the diagram back up again.</p>

<p>One of the important changes to start with is to make each node responsive to the mouse pointer. This is done by including the following in the <code>&lt;style&gt;</code> section. </p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="nc">.node</code> <code class="p">{</code>
		<code class="nb">cursor</code><code class="o">:</code> <code class="nb">pointer</code><code class="p">;</code>
	<code class="p">}</code>
</pre></div>

</figure>

<p>The code then adds sections to allow the diagram to follow the d3.js model of enter - update - exit for the nodes with a suitable transition in between.</p>

<p>Nodes are coloured (“steelblue”) if they have been collapsed and at the end of the script we have a function that makes use of the <code>d._children</code> reference we have been using in most of our examples.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">click</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">)</code> <code class="p">{</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">;</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code><code class="p">;</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="nx">update</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>This allows the action of clicking on the nodes to update the data associated with the node and as a consequence change it’s properties in the script based on if statements (Such as <code>"fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; }</code> which will fill the node with “lightsteelblue” if <code>d._children</code> exists, otherwise make it white.)</p>

<p>The examples we have looked at in the previous sections in this chapter are all applicable to this interactive version, so this should provide you with the capability to generate some interesting visualizations. </p>

<p>Enjoy.</p>

<h2 id="leanpub-auto-force-layout-diagrams">Force Layout Diagrams</h2>

<h3 id="leanpub-auto-what-is-a-force-layout-diagram">What is a Force Layout Diagram?</h3>

<p>This is not a distinct type of diagram per se. Instead, it’s a way of representing data so that individual data points share relationships to other data points via forces. Those forces can then act in different ways to provide a natural structure to the data. The end result can be a wide variety of representations of connectedness and groupings.</p>

<p>Mike Bostock gave a great talk which focussed on force layout techniques in 2011 at Trulia for the Data Visualization meetup group. Check video of the presentation here: <a href="http://vimeo.com/29458354">http://vimeo.com/29458354</a> and the slides here: <a href="http://mbostock.github.com/d3/talk/20110921/#0">http://mbostock.github.com/d3/talk/20110921/#0</a>. The most memorable quote I recall from the talk describes force layout diagrams as an “<em>Implicit way to do position encoding</em>”. </p>

<p>Here’s some examples for those who need a reason to view the talk.</p>

<p><strong>Multi-Foci Force Layout</strong></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force01.png" alt="Multi-Foci Force Layout">
  <figcaption>Multi-Foci Force Layout</figcaption>
</figure>


<p>Simultaneous forces of repulsion and multiple gravitational focus points create a natural clustering of data points (Source: Mike Bostock <a href="http://bl.ocks.org/mbostock/1249681">http://bl.ocks.org/mbostock/1249681</a>). The graph is animated, so the artefacts such as overlapping circles and the purple circle that is located beside the red area are transitory.</p>

<p><strong>Force Directed Graph with Pan / Zoom</strong></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force02.png" alt="Force Directed Graph with Pan / Zoom">
  <figcaption>Force Directed Graph with Pan / Zoom</figcaption>
</figure>


<p>Multiple linked nodes show connections between related entities where those entities are labelled and encoded with relevant information. Created by David Graus and presented here: <a href="http://graus.nu/blog/force-directed-graphs-playing-around-with-d3-js/">http://graus.nu/blog/force-directed-graphs-playing-around-with-d3-js/</a>.</p>

<p><strong>Collapsible Force Layout</strong></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force03.png" alt="Collapsible Force Layout">
  <figcaption>Collapsible Force Layout</figcaption>
</figure>


<p>This force directed graph can have individual nodes expanded or collapsed by clicking on them to reveal or hide greater detail (Source: Mike Bostock <a href="http://bl.ocks.org/mbostock/1062288">http://bl.ocks.org/mbostock/1062288</a>).</p>

<p><strong>Force Directed Graph showing Directionality</strong></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force05.png" alt="Force Directed Graph showing Directionality">
  <figcaption>Force Directed Graph showing Directionality</figcaption>
</figure>


<p>This example showing mobile patent lawsuits between companies presents the direction associated with the links and encodes the links to show different types (Source: Mike Bostock <a href="http://bl.ocks.org/mbostock/1153292">http://bl.ocks.org/mbostock/1153292</a>).</p>

<p><strong>Collision Detection</strong></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force06.png" alt="Collision Detection">
  <figcaption>Collision Detection</figcaption>
</figure>


<p>In this example the mouse exerts a repulsive force on the objects as it moves on the screen (Source: Mike Bostock <a href="http://bl.ocks.org/mbostock/3231298">http://bl.ocks.org/mbostock/3231298</a>).</p>

<p><strong>Molecule Diagram</strong></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force07.png" alt="Molecule Diagram">
  <figcaption>Molecule Diagram</figcaption>
</figure>


<p>Just for fun, here is a diagram that Mike Bostock made to demonstrate drawing two parallel lines between nodes. He’s the first to admit that increasing the number of lines becomes awkward, but it serves as another example of the flexibility of force diagrams in D3  (Source: Mike Bostock <a href="http://bl.ocks.org/mbostock/3037015">http://bl.ocks.org/mbostock/3037015</a>).</p>

<p>The main forces in play in these diagrams are charge, gravity and friction. More detailed information on these forces and the other parameters associated with the force layout code can be found in the <a href="https://github.com/mbostock/d3/wiki/Force-Layout">D3 Wiki</a>. </p>

<p><strong>Charge</strong></p>

<p>Charge is a force that a node can exhibit where it can either attract (positive values) or repel (negative values). Varying this value in conjunction with other forces (such as gravity) or a link (on a node by node basis) is generally necessary to maintain stability.</p>

<p><strong>Gravity</strong></p>

<p>The gravity force isn’t actually a true representation of gravitational attraction (this can be more closely approximated using positive values of charge). Instead it approximates the action of a spring connected to a node. This has a more pleasant visual effect when the affected node is closer to its ‘great attractor’ and avoids what would otherwise be a small black hole type effect. </p>

<p><strong>Friction</strong></p>

<p>The frictional force is one designed to act on the movement of a node to reduce its speed over time. It isn’t implemented as true friction (in the physical sense) and should be thought of as a ‘velocity decay’ in the truer sense. </p>

<p>Mike makes the point in the 2011 talk at Trulia that when using gravity in a force layout diagram, it is useful to include a degree of charge repulsion to provide stability. This can be demonstrated by experimenting with varying values of the charges in a diagram and observing the effects.</p>

<h3 id="leanpub-auto-force-directed-graph-examples">Force directed graph examples.</h3>

<p>There are a large number of possible examples to use to demonstrate force directed graphs. I chose to combine two examples that Mike Bostock has demonstrated in the past. Both use the data for the ‘who’s suing who’ graph because I wanted especially to include the directionality aspect of the links. The two graphs I based the final graph on were the <a href="http://bl.ocks.org/mbostock/1153292">Mobile Patent Suits</a> graph….</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force08.png" alt="Mobile Patent Suits">
  <figcaption>Mobile Patent Suits</figcaption>
</figure>


<p>… for the directionality and link encoding and the <a href="http://bl.ocks.org/mbostock/2706022">Force-Directed Graph with Mouseover</a> graph…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force09.png" alt="Force-Directed Graph with Mouseover">
  <figcaption>Force-Directed Graph with Mouseover</figcaption>
</figure>


<p>… for the mouseover effects (note the enlarged ‘Microsoft’ circle).</p>

<p>In spite of the similarities to each other in terms of data and network linkages, the final example code was quite different, so the end result is a distinct hybrid of the two and will look something like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force10.png" alt="Force-Directed Graph with Node Highlighting and Link Value Gradients">
  <figcaption>Force-Directed Graph with Node Highlighting and Link Value Gradients</figcaption>
</figure>


<p>In this example the nodes can be clicked on once to enlarge the associated circle and text and then double clicked on to return them to normal. The links vary in opacity depending on an associated value loaded with the data. The example code for the graph above will be explained later in the chapter and can be found on <a href="http://bl.ocks.org/d3noob/5155181">bl.ocks.org</a> or in the code samples bundled with this book (force-highlight-opacity.html and force.csv).</p>

<h4 id="leanpub-auto-basic-force-directed-graph-showing-directionality">Basic force directed graph showing directionality</h4>

<p>The data for this graph has been altered from the data that was comprised of litigants in the mobile patent war to fictitious people’s names and associated values (to represent the strength of the links between the two). </p>

<p>The full code for this diagram can also be found on <a href="https://gist.github.com/d3noob/5141278">github</a> or in the code samples bundled with this book (force.html and force.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/5141278">bl.ocks.org</a>.</p>

<p>In the original examples the data was contained in the graph code. In the following example it is loaded from a csv file. The values loaded are as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>source,target,value
Harry,Sally,1.2
Harry,Mario,1.3
Sarah,Alice,0.2
Eveie,Alice,0.5
Peter,Alice,1.6
Mario,Alice,0.4
James,Alice,0.6
Harry,Carol,0.7
Harry,Nicky,0.8
Bobby,Frank,0.8
Alice,Mario,0.7
Harry,Lynne,0.5
Sarah,James,1.9
Roger,James,1.1
Maddy,James,0.3
Sonny,Roger,0.5
James,Roger,1.5
Alice,Peter,1.1
Johan,Peter,1.6
Alice,Eveie,0.5
Harry,Eveie,0.1
Eveie,Harry,2.0
Henry,Mikey,0.4
Elric,Mikey,0.6
James,Sarah,1.5
Alice,Sarah,0.6
James,Maddy,0.5
Peter,Johan,0.7
</pre></div>

</figure>

<p>The code is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code><code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1.5px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">circle</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1.5px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">text</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"force.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">links</code><code class="p">)</code> <code class="p">{</code>

<code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="p">{};</code>

<code class="c1">// Compute the distinct nodes from the links.</code>
<code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">link</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">source</code> <code class="o">=</code> <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">||</code> 
        <code class="p">(</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">});</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">target</code> <code class="o">=</code> <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">]</code> <code class="o">||</code> 
        <code class="p">(</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">});</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
<code class="p">});</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">force</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">force</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">values</code><code class="p">(</code><code class="nx">nodes</code><code class="p">))</code>
    <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">])</code>
    <code class="p">.</code><code class="nx">linkDistance</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">charge</code><code class="p">(</code><code class="o">-</code><code class="mi">300</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"tick"</code><code class="p">,</code> <code class="nx">tick</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">start</code><code class="p">();</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code>

<code class="c1">// build the arrow.</code>
<code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:defs"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"marker"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="s2">"end"</code><code class="p">])</code>      <code class="c1">// Different link/path types can be defined here</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:marker"</code><code class="p">)</code>    <code class="c1">// This section adds in the arrows</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="nb">String</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"viewBox"</code><code class="p">,</code> <code class="s2">"0 -5 10 10"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"refX"</code><code class="p">,</code> <code class="mi">15</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"refY"</code><code class="p">,</code> <code class="o">-</code><code class="mf">1.5</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"markerWidth"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"markerHeight"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"orient"</code><code class="p">,</code> <code class="s2">"auto"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="s2">"M0,-5L10,0L0,5"</code><code class="p">);</code>

<code class="c1">// add the links and the arrows</code>
<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">links</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"marker-end"</code><code class="p">,</code> <code class="s2">"url(#end)"</code><code class="p">);</code>

<code class="c1">// define the nodes</code>
<code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">nodes</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">drag</code><code class="p">);</code>

<code class="c1">// add the nodes</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>

<code class="c1">// add the text </code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">12</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">});</code>

<code class="c1">// add the curvy lines</code>
<code class="kd">function</code> <code class="nx">tick</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">path</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">dx</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="err">–</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code>
            <code class="nx">dy</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code> <code class="err">–</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code>
            <code class="nx">dr</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">dx</code> <code class="o">*</code> <code class="nx">dx</code> <code class="o">+</code> <code class="nx">dy</code> <code class="o">*</code> <code class="nx">dy</code><code class="p">);</code>
        <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">"A"</code> <code class="o">+</code> 
            <code class="nx">dr</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">dr</code> <code class="o">+</code> <code class="s2">" 0 0,1 "</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="nx">node</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		    <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
<code class="p">}</code>

<code class="p">});</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>In a similar process to the one we went through when highlighting the function of the Sankey diagram, where there are areas that we have covered before, I will gloss over some details on the understanding that you will have already seen them explained in an earlier section (most likely the basic line graph example).</p>

<p>The first block we come across is the initial html section;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The only thing slightly different with this example is that we load the d3.v3.js script earlier. This has no effect on running the code.</p>

<p>The next section loads the Cascading Style Sheets;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code><code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1.5px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">circle</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1.5px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">text</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>We set styles for three elements and all the settings laid out are familiar to us from previous work.</p>

<p>Then we move into the JavaScript. Our first line loads our csv data file (<code>force.csv</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"force.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">links</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>Then we declare an empty object (I still tend to think of these as arrays even though they’re strictly not).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="p">{};</code>
</pre></div>

</figure>

<p>This will contain our data for our nodes. We don’t have any separate node information in our data file, it’s just link information, so we will be populating this in the next section…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">link</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">source</code> <code class="o">=</code> <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">||</code> 
        <code class="p">(</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">});</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">target</code> <code class="o">=</code> <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">]</code> <code class="o">||</code> 
        <code class="p">(</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">});</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>This block of code looks through all of our data from our csv file and for each link adds it as a node if it hasn’t seen it before. It’s quite clever how it works as it employs a neat JavaScript shorthand method using the double pipe (<code>||</code>) identifier.</p>

<p>So the line (expanded)…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="o">=</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">||</code> <code class="p">(</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code><code class="o">=</code><code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">});</code>
</pre></div>

</figure>

<p>… can be thought of as saying “<em>If</em> <code>link.source</code> <em>does not equal any of the <code>nodes</code> values then create a new element in the <code>nodes</code> object with the name of the <code>link.source</code> value being considered.</em>”. It could conceivably be written as follows (this is untested);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">if</code> <code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code> <code class="o">!=</code> <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">}</code>
<code class="p">};</code>
</pre></div>

</figure>

<p>Then the block of code goes on to test the <code>link.target</code> value in the same way. Then the <code>value</code> variable is converted to a number from a string if necessary (<code>link.value = +link.value;</code>).</p>

<p>The next block sets the size of our svg area that we’ll be using;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code>
</pre></div>

</figure>

<p>The next section introduces the <code>force</code> function.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">force</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">force</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">values</code><code class="p">(</code><code class="nx">nodes</code><code class="p">))</code>
    <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">])</code>
    <code class="p">.</code><code class="nx">linkDistance</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">charge</code><code class="p">(</code><code class="o">-</code><code class="mi">300</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"tick"</code><code class="p">,</code> <code class="nx">tick</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">start</code><code class="p">();</code>
</pre></div>

</figure>

<p>Full details for this function are found on the <a href="https://github.com/mbostock/d3/wiki/Force-Layout">D3 Wiki</a>, but the following is a rough description of the individual settings.</p>

<p><code>var force = d3.layout.force()</code> makes sure we’re using the <code>force</code> function.</p>

<p><code>.nodes(d3.values(nodes))</code> sets our layout to the array of <code>nodes</code> as returned by the function <code>d3.values</code> (<a href="https://github.com/mbostock/d3/wiki/Arrays#wiki-d3_values">https://github.com/mbostock/d3/wiki/Arrays#wiki-d3_values</a>). Put simply, it sets the nodes to the <code>nodes</code> we have previously set in our object.</p>

<p><code>.links(links)</code> does for links what <code>.nodes</code> did for nodes.</p>

<p><code>.size([width, height])</code>  sets the available layout size to our predefined values. If we were using <code>gravity</code> as a force in the graph this would also set the gravitational centre. It also sets the initial random position for the elements of our graph.</p>

<p><code>.linkDistance(60)</code> sets the target distance between linked nodes.  As the graph begins and moves towards a steady state, the distance between each pair of linked nodes is computed and compared to the target distance; the links are then moved towards or away from each other, so as to converge on the set distance.</p>

<p>Setting this value (and other force values) can be something of a balancing act. For instance, here is the result of setting the <code>.linkDistance</code> to 160.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force11.png" alt="Link distance set to 160">
  <figcaption>Link distance set to 160</figcaption>
</figure>


<p>Here the charged nodes are trying to arrange themselves at an appropriate distance, but the length of the links means that their arrangement is not very pretty. Likewise if we change the value to 30 we get the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force12.png" alt="Link distance set to 30">
  <figcaption>Link distance set to 30</figcaption>
</figure>


<p>Here the link distance allows for a symmetrical layout, but the distance is too short to be practical. </p>

<p><code>.charge(-300)</code> sets the force between nodes. Negative values of <code>charge</code> results in node repulsion, while a positive value results in node attraction. In our example, if we vary the value to 150 we get this result;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force13.png" alt="Charge set to 150">
  <figcaption>Charge set to 150</figcaption>
</figure>


<p>It’s not exactly easy to spot, but the graph feels a little ‘lazy’. The nodes don’t find their equilibrium easily or at all. Setting the value higher than 300 (for our example) keeps all the nodes nice and spread out, but where there are other separate discrete linked nodes (as there are in our example) they tend to get forced away from the centre of the defined area.</p>

<p><code>.on("tick", tick)</code> runs the animation of the force layout one ‘step’. It’s this progression of steps that gives the force layout diagram it’s fluid movement.</p>

<p><code>.start();</code> Starts the simulation; this method must be called when the layout is first created.</p>

<p>The next block of our code is the standard section that sets up our svg container.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code>
</pre></div>

</figure>

<p>The next block of our code is used to create our arrowhead marker. I will be the first to admit that it has entered a realm of svg expertise that I do not have and the amount of extra memory power I would need to accumulate to understand it sufficiently to explain won’t be occurring in the near future. Please accept my apologies and as a small token of my regret, accept the following links as an invitation to learn more: <a href="http://www.w3.org/TR/SVG/coords.html#ViewBoxAttribute">http://www.w3.org/TR/SVG/coords.html#ViewBoxAttribute</a> and <a href="http://www.w3schools.com/svg/svg_reference.asp?">http://www.w3schools.com/svg/svg_reference.asp?</a>. What is useful to note here is that we define the label for our marker as <code>end</code>. We will use this in the next section to reference the marker as an object. This particular section of the code caused me some small amount of angst. The problem being when I attempted to adjust the width of the link lines in conjunction with the <code>value</code> set in the data for the link, it would also adjust the stroke-width of the arrowhead marker. Then when I attempted to adjust for the positioning of the arrow on the path, I could never get the maths right. Eventually I decided to stop struggling against it and encode the value of the line in a couple of different ways. One as opacity using discrete boundaries and the other using variable line width, but with the arrowheads a common size. We will cover both those solutions in the coming sections.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:defs"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"marker"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="s2">"end"</code><code class="p">])</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:marker"</code><code class="p">)</code>    
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="nb">String</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"viewBox"</code><code class="p">,</code> <code class="s2">"0 -5 10 10"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"refX"</code><code class="p">,</code> <code class="mi">15</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"refY"</code><code class="p">,</code> <code class="o">-</code><code class="mf">1.5</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"markerWidth"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"markerHeight"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"orient"</code><code class="p">,</code> <code class="s2">"auto"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="s2">"M0,-5L10,0L0,5"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The <code>.data(["end"]) </code> line sets our tag for a future part of the script to find this block and draw the marker.</p>

<p><code>.attr("refX", 15)</code> sets the offset of the arrow from the centre of the circle. While it is designated as the <code>X</code> offset, because the object is rotating, it doesn’t correspond to the x (left and right) axis of the screen. The same is true of the <code>.attr("refY", -1.5)</code> line.</p>

<p>The <code>.attr("markerWidth", 6)</code> and <code>.attr("markerHeight", 6)</code> lines set the bounding box for the marker. So varying these will vary the space available for the marker.</p>

<p>The next block of code adds in our links as paths and uses the <code>#end</code> marker to draw the arrowhead on the end of it.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">links</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"marker-end"</code><code class="p">,</code> <code class="s2">"url(#end)"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we define what our nodes are going to be.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">nodes</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">drag</code><code class="p">);</code>
</pre></div>

</figure>

<p>This uses the <code>nodes</code> data and adds the <code>.call(force.drag);</code> function which allows the node to be dragged by the mouse.</p>

<p>The next block adds the nodes as an svg circle.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>
</pre></div>

</figure>

<p>And then we add the name of the node with a suitable offset.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">12</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The last block of JavaScript is the <code>ticks</code> function. This block is responsible for updating the graph and most interestingly drawing the curvy lines between nodes.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tick</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">path</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">dx</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="err">–</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code>
            <code class="nx">dy</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code> <code class="err">–</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code>
            <code class="nx">dr</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">dx</code> <code class="o">*</code> <code class="nx">dx</code> <code class="o">+</code> <code class="nx">dy</code> <code class="o">*</code> <code class="nx">dy</code><code class="p">);</code>
        <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">"A"</code> <code class="o">+</code> 
            <code class="nx">dr</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">dr</code> <code class="o">+</code> <code class="s2">" 0 0,1 "</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="nx">node</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		    <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>This is another example where there are some easily recognisable parts of the code that set the x and y points for the ends of each link (<code>d.source.x</code>, <code>d.source.y</code> for the start of the curve and <code>d.target.x</code>, <code>d.target.y</code> for the end of the curve) and a transformation for the node points, but the cleverness is in the combination of the math for the radius of the curve (<code>dr = Math.sqrt(dx * dx + dy * dy);</code>) and the formatting of the svg associated with it. This is sadly beyond the scope of what I can comfortable explain, so we will have to be content with “the magic happens here”.</p>

<p>The end result should be a tidy graph that demonstrates nodes and directional links between them.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force14.png" alt="Basic Directional Force Layout Diagram">
  <figcaption>Basic Directional Force Layout Diagram</figcaption>
</figure>


<h4 id="leanpub-auto-directional-force-layout-diagram-node-highlighting">Directional Force Layout Diagram (Node Highlighting)</h4>

<p>Following on from the Basic Force Layout Diagram, our next goal is to highlight our nodes so that we can get a better view of what ones they are (the view can get a little crowded as the nodes begin to increase in number). </p>

<p>To do this we are going to use a couple more of the mouse events that we first introduced in the tooltips section.</p>

<p>For this example we are going to use the  <code>click</code> event (Triggered by a mouse click (mousedown and then mouseup over an element)) and the <code>dblclick</code> event (Triggered by two clicks within a short time over an element).</p>

<p>The single click will enlarge the node and the associated text and the double click will return the node and test to its original size. </p>

<p>The way to implement this is to first set a hook to capture when the event occurs, which calls a function which is laid out later in the script.</p>

<p>The hook is going to be part of the JavaScript where we define our nodes;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">nodes</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="nx">click</code><code class="p">)</code>        <code class="c1">// Add in this line</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"dblclick"</code><code class="p">,</code> <code class="nx">dblclick</code><code class="p">)</code>  <code class="c1">// Add in this line too</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">drag</code><code class="p">);</code>
</pre></div>

</figure>

<p>The two additional lines above tell the script that when it sees a click or a double-click on the node (since it’s part of the node set-up) to run either the <code>click</code> or <code>dblclick</code> functions.</p>

<p>The following two function blocks should be placed after the <code>tick</code> function but before the closing curly bracket and bracket as indicated;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tick</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">path</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">dx</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="err">–</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code>
            <code class="nx">dy</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code> <code class="err">–</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code>
            <code class="nx">dr</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">dx</code> <code class="o">*</code> <code class="nx">dx</code> <code class="o">+</code> <code class="nx">dy</code> <code class="o">*</code> <code class="nx">dy</code><code class="p">);</code>
        <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">"A"</code> <code class="o">+</code> 
            <code class="nx">dr</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">dr</code> <code class="o">+</code> <code class="s2">" 0 0,1 "</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="nx">node</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		    <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
<code class="p">}</code>

        <code class="c1">// &lt;= Put the functions in here!</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>The <code>click</code> function is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">click</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">22</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"lightsteelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="s2">".5px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font"</code><code class="p">,</code> <code class="s2">"20px sans-serif"</code><code class="p">);</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">16</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightsteelblue"</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The first line declares the function name (<code>click</code>). Then we select the node that we’ve clicked on and then the associated text before we begin the declaration for our transition with the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
</pre></div>

</figure>

<p>Then we define the new properties that will be in place after the transition. We move the text’s x position (<code>.attr("x", 22)</code>), make the text fill steel blue (<code>.style("fill", "steelblue")</code>), set the stroke around the edge of the text light steel blue (<code>.style("stroke", "lightsteelblue")</code>), set that stroke to half a pixel wide (<code>.style("stroke-width", ".5px")</code>) and increase the font size to 20 pixels (<code>.style("font", "20px sans-serif");</code>).</p>

<p>Then we do much the same for the circle component of the node. Select it, declare the transition, increase the radius and change the fill colour.</p>

<p>The <code>dblclick</code> function does exactly the same as the <code>click</code> function, but reverses the action to return the text and circle to the original settings.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">dblclick</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"#ccc"</code><code class="p">);</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">12</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font"</code><code class="p">,</code> <code class="s2">"10px sans-serif"</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The end result is a force layout diagram where you can click on nodes to increase their size (circle and text) and then double click to reset them if desired.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force15.png" alt="Directional Force Layout Diagram (Node Highlighting)">
  <figcaption>Directional Force Layout Diagram (Node Highlighting)</figcaption>
</figure>


<p>The full code for this diagram can be found on <a href="https://gist.github.com/d3noob/5141528">github</a> or in the code samples bundled with this book (force-highlight.html and force.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/5141528">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-directional-force-layout-diagram--varying-link-opacity">Directional Force Layout Diagram  (varying link opacity)</h4>

<p>The next variation to our force layout diagram is the addition of variation in the link to represent different values (think of the number of packets passed or the amount of money transferred).</p>

<p>There are a few different ways to do this, but by virtue of the inherent close linkages between the arrowhead marker and the link line, altering both in synchronicity proved to be beyond my meagre talents. However, I did find a couple of suitable alternatives and I will go through one here. </p>

<p>In this example we will take the value associated in the loaded data with the link and we will adjust the opacity of the link line in a staged way according to the range of values.</p>

<p>For example, in a range of link strengths from 0 to 100, the bottom 25% will be at opacity 0.25, from 25 to 50 will be 0.50, 50 to 75 will be 0.75 and above 75 will have an opacity of 1. So the final result looks a little like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force16.png" alt="Directional Force Layout Diagram  (varying link opacity)">
  <figcaption>Directional Force Layout Diagram  (varying link opacity)</figcaption>
</figure>


<p>The changes to the code to create this effect are focussed on creating an appropriate range for the values associated with the links and then applying the opacity according to that range in discrete steps.</p>

<p>The first change to the node highlighting code that we make is to the style section. The following elements are added;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code><code class="nc">.link.twofive</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">25</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code><code class="nc">.link.fivezero</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">50</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code><code class="nc">.link.sevenfive</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">75</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code><code class="nc">.link.onezerozero</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">1</code><code class="o">.</code><code class="m">0</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>This provides our four different ‘classes’ of opacity.</p>

<p>Then in a  block of code that comes just after the declaration of the <code>force</code> properties we have the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code>	<code class="nx">v</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">100</code><code class="p">]);</code>

<code class="nx">v</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">links</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code>

<code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">link</code><code class="p">)</code> <code class="p">{</code>
	<code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">25</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"twofive"</code><code class="p">;</code>
	<code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">50</code> <code class="o">&amp;&amp;</code> <code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">25</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"fivezero"</code><code class="p">;</code>
	<code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">75</code> <code class="o">&amp;&amp;</code> <code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">50</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"sevenfive"</code><code class="p">;</code>
	<code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">100</code> <code class="o">&amp;&amp;</code> <code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">75</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"onezerozero"</code><code class="p">;</code>
	<code class="p">}</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>Here we set the scale and the range for the variable <code>v</code> (<code>var v = d3.scale.linear().range([0, 100]);</code>). We then set the domain for v to go from 0 to the maximum <code>value</code> that we have in our link data.</p>

<p>The final block above uses a cascading set of if statements to assign a label to the <code>type</code> parameter of each link. This label is the linkage back to the styles we defined previously.</p>

<p>The final change is to take the line where we assigned a class of <code>link</code> to each link previously…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
</pre></div>

</figure>

<p>…and add in our <code>type</code> parameter as well;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"link "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">type</code><code class="p">;</code> <code class="p">})</code>
</pre></div>

</figure>

<p>Obviously if we wanted a greater number of opacity levels we would add in further style blocks (with the appropriate values) and modify our cascading if statements. I’m not convinced that this solution is very elegant for what I’m trying to do (it was a much better fit for the application that Mike Bostock applied it to originally where he designated different types of law suits) but I’ll take the result as a suitable way of demonstrating variation of value.</p>

<p>The full code for this diagram can be found on <a href="https://gist.github.com/d3noob/5155181">github</a> or in the code samples bundled with this book (force-highlight-opacity.html and force.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/5155181">bl.ocks.org</a>.</p>

<p>The full code for the Directional Force Layout Diagram with varying link opacity is also in the Appendix: Force Layout Diagram at the rear of the book.</p>

<h4 id="leanpub-auto-directional-force-layout-diagram--unique-node-colour">Directional Force Layout Diagram  (Unique Node Colour)</h4>

<p>The following example was put together in response to a <a href="http://www.d3noob.org/2013/03/d3js-force-directed-graph-example-basic.html?showComment=1387379478999#c289010472197093679">question on the d3noob.org</a> site from ‘Gino’. While the example isn’t precisely what Gino was wanting to achieve, it does illustrate the application of a colour palette to unique elements.</p>

<p>The end result looks like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force17.png" alt="Directional Force Layout Diagram  (Unique Node Colour)">
  <figcaption>Directional Force Layout Diagram  (Unique Node Colour)</figcaption>
</figure>


<p>Here each of the nodes has had a separate colour applied to it from one of the 20 colour palette categorical colour ranges. An excellent overview of these ranges is on the <a href="https://github.com/mbostock/d3/wiki/Ordinal-Scales#categorical-colors">d3 wiki</a>.</p>

<p>The full code for this diagram can be found on <a href="https://gist.github.com/d3noob/8043434">github</a> or in the code samples bundled with this book (force-colour-nodes.html and force.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/8043434">bl.ocks.org</a>.</p>

<p>The changes required from the previous example with the altered opacity are pretty simple.</p>

<p>Firstly we declare the colour range we’re going to use in the variable section.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category20c</code><code class="p">();</code>
</pre></div>

</figure>

<p>In this case we’ll use the <code>category20c</code> range.</p>

<p>Then we add the fill style for the circle to the code where we append the circles to our graphic.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The code applies the fill based on a function that returns a different colour based on each unique node name. So just to be clear here. We’re not setting a specific colour to a node. The colours are assigned as a function of where each name sits in the array of nodes (practically random, but in an ordered way :-)).</p>

<p>Then remove the style declarations in the <code>function click()</code> and  <code>function dblclick()</code> where the fill colour is declared for the circles. This prevents the colours from turning grey or steelblue when they are clicked / double clicked. This means that we can click on a few of our new coloured nodes and their unique colours are retained thusly…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/force18.png" alt="Directional Force Layout Diagram  ('clicked' unique node colours)">
  <figcaption>Directional Force Layout Diagram  (‘clicked’ unique node colours)</figcaption>
</figure>


<p>Good question Gino. Many thanks.</p>

<h2 id="leanpub-auto-bullet-charts">Bullet Charts</h2>

<h3 id="leanpub-auto-introduction-to-bullet-chart-structure">Introduction to bullet chart structure</h3>

<p>One of the first D3.js examples I ever came across (back when Protovis was the thing to use) was one with bullet charts (or bullet graphs). </p>

<p>It struck me straight away as an elegant way to represent data by providing direct information and context.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bullet01.png" alt="Bullet Chart">
  <figcaption>Bullet Chart</figcaption>
</figure>


<p>The <a href="http://www.perceptualedge.com/articles/misc/Bullet_Graph_Design_Spec.pdf">Bullet Graph Design Specification</a> was laid down by Stephen Frew as part of his work with <a href="http://www.perceptualedge.com/">Perceptual Edge</a>.</p>

<p>Using his specification we can break down the components of the chart as follows.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bullet02.png" alt="Bullet Chart Specification">
  <figcaption>Bullet Chart Specification</figcaption>
</figure>


<p><strong>Text label:</strong>
Identifies the performance measure being represented.</p>

<p><strong>Quantitative scale:</strong>
A scale that is an analogue of the scale on the x axis of a two dimensional xy graph.</p>

<p><strong>Performance measure:</strong>
The primary data being displayed. In this case the frequency of operation of a CPU.</p>

<p><strong>Comparative marker:</strong>
A reference symbol designating a measurement such as the previous day’s high value (or similar).</p>

<p><strong>Qualitative ranges:</strong>
These represent ranges such as low, medium and high or bad, satisfactory and good. Ideally there would be no fewer than two and no more than 5 of these (for the purposes of readability).</p>

<p>Understanding the specification for the chart is useful, because it’s also reflected in the way that the data for the chart is structured.</p>

<p>For instance, If we take the current example, the data can be presented (in JSON) as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>[
  {
    "title":"CPU 1 Load",
    "subtitle":"GHz",
    "ranges":[1500,2250,3000],
    "measures":[2200],
    "markers":[2500]
  }
]
</pre></div>

</figure>

<p>Here we an see all the components for the chart laid out and it’s these values that we will load into our D3 script to display.</p>

<h3 id="leanpub-auto-d3js-code-for-bullet-charts">D3.js code for bullet charts</h3>

<p>We’ll move through the explanation of the code in a similar process to the other examples in the book. Where there are areas that we have covered before, I will gloss over some details on the understanding that you will have already seen them explained in an earlier section (most likely the basic line graph example).</p>

<p>Here is the full code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code>
  <code class="nb">font-family</code><code class="o">:</code> <code class="s2">"Helvetica Neue"</code><code class="o">,</code> <code class="n">Helvetica</code><code class="o">,</code> <code class="n">Arial</code><code class="o">,</code> <code class="nb">sans-serif</code><code class="p">;</code>
  <code class="nb">margin</code><code class="o">:</code> <code class="nb">auto</code><code class="p">;</code>
  <code class="nb">padding-top</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">relative</code><code class="p">;</code>
  <code class="nb">width</code><code class="o">:</code> <code class="m">800px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">button</code> <code class="p">{</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
  <code class="nb">right</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
  <code class="nb">top</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.bullet</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.marker</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.tick</code> <code class="nt">line</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">.5px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#eee</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s1</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ddd</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s2</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.measure.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.title</code> <code class="p">{</code> <code class="nb">font-size</code><code class="o">:</code> <code class="m">14px</code><code class="p">;</code> <code class="nb">font-weight</code><code class="o">:</code> <code class="nb">bold</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.subtitle</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#999</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">button</code><code class="p">&gt;</code>Update<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"js/bullet.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">800</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">50</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">chart</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">bullet</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="nx">height</code><code class="p">);</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"bullet-data.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bullet"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">);</code>

  <code class="kd">var</code> <code class="nx">title</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(-6,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

  <code class="nx">title</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">title</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">title</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"subtitle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">subtitle</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"button"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">randomize</code><code class="p">).</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">));</code>
  <code class="p">});</code>
<code class="p">});</code>

<code class="kd">function</code> <code class="nx">randomize</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">)</code> <code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code> <code class="o">=</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">k</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">ranges</code><code class="p">)</code> <code class="o">*</code> <code class="p">.</code><code class="mi">2</code><code class="p">;</code>
  <code class="k">return</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d</code> <code class="o">+</code> <code class="nx">k</code> <code class="o">*</code> <code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">-</code> <code class="p">.</code><code class="mi">5</code><code class="p">));</code>
  <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This code is a derivative of one of Mike Bostock’s blocks <a href="http://bl.ocks.org/mbostock/4061961">here</a>. The full code for this graph can also be found on <a href="https://gist.github.com/d3noob/5886992">github</a> or in the code samples bundled with this book (bullet-simple.html, bullet.js and bullet-data.json). A live example can be found on <a href="http://bl.ocks.org/d3noob/5886992">bl.ocks.org</a>.</p>

<aside class="tip blurb">
    <p>It will become clearer in the process of going through the code below, but as a teaser, it is worth noting that while the code that we will modify is as presented above, we are employing a separate script <code>bullet.js</code> to enable the charts.</p>

</aside>

<p>The first block of our code is the start of the file and sets up our HTML.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This leads into our style declarations. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code>
  <code class="nb">font-family</code><code class="o">:</code> <code class="s2">"Helvetica Neue"</code><code class="o">,</code> <code class="n">Helvetica</code><code class="o">,</code> <code class="n">Arial</code><code class="o">,</code> <code class="nb">sans-serif</code><code class="p">;</code>
  <code class="nb">margin</code><code class="o">:</code> <code class="nb">auto</code><code class="p">;</code>
  <code class="nb">padding-top</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">relative</code><code class="p">;</code>
  <code class="nb">width</code><code class="o">:</code> <code class="m">800px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">button</code> <code class="p">{</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
  <code class="nb">right</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
  <code class="nb">top</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.bullet</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.marker</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.tick</code> <code class="nt">line</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">.5px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#eee</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s1</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ddd</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s2</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.measure.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.title</code> <code class="p">{</code> <code class="nb">font-size</code><code class="o">:</code> <code class="m">14px</code><code class="p">;</code> <code class="nb">font-weight</code><code class="o">:</code> <code class="nb">bold</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.subtitle</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#999</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>We declare the (general) styling for the chart page in the first instance and then the button. Then we move on to the more interesting styling for the bullet charts.</p>

<p>The first line <code>.bullet { font: 10px sans-serif; }</code> sets the font size.</p>

<p>The second line sets the colour and width of the symbol marker. So if we were to change it to…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.bullet</code> <code class="nc">.marker</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>… the result is…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bullet03.png" alt="Symbol Marker">
  <figcaption>Symbol Marker</figcaption>
</figure>


<p>The next three lines set the colours for the fill of the qualitative ranges.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.bullet</code> <code class="nc">.range.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#eee</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s1</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ddd</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s2</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>You can have more or fewer ranges set here, but to use them you also need the appropriate values in your data file. We will explore how to change this later.</p>

<p>The next line designates the colour for the value being measured.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.bullet</code> <code class="nc">.measure.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>Like the qualitative ranges, we can have more of them, but in my personal opinion, it starts to get a bit confusing.</p>

<p>The final two lines lay out the styling for the label.</p>

<p>The next block of code loads the JavaScript files.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">button</code><code class="p">&gt;</code>Update<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"bullet.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>In this case it’s d3 and <code>bullet.js</code>. We need to load <code>bullet.js</code> as a separate file since it exists outside the code base of the d3.js ‘kernel’.</p>

<p>Then we get into the JavaScript. The first thing we do is define the size of the area that we’ll be working in.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">800</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">50</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then we define the chart size using the variables that we have just set up. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">chart</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">bullet</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="nx">height</code><code class="p">);</code>
</pre></div>

</figure>

<p>The other important thing that occurs while setting up the chart is that we use the <code>d3.bullet</code> function call to do it. The <code>d3.bullet</code> function is the part that resides in the <code>bullet.js</code> file that we loaded earlier. The internal workings of <code>bullet.js</code> are a window into just how developers are able to craft extra code to allow additional functionality for d3.js.</p>

<p>Then we load our JSON data with our values that we want to display.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"bullet-data.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>The next block of code is the most important IMHO, since this is where the chart is drawn. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bullet"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">);</code>
</pre></div>

</figure>

<p>However, to look at it you can be forgiven for wondering if it’s doing anything at all.</p>

<p>We use our <code>.select</code> and <code>.selectAll</code> statements to designate where the chart will go (<code>d3.select("body").selectAll("svg")</code>) and then load the data as <code>data</code> (<code>.data(data)</code>).</p>

<p>We add in a svg element (<code>.enter().append("svg")</code>) and assign the styling from our css section (<code>.attr("class", "bullet")</code>).</p>

<p>Then we set the size of the svg container for an individual bullet chart using <code>.attr("width", width + margin.left + margin.right)</code> and <code>.attr("height", height + margin.top + margin.bottom)</code>.</p>

<p>We then group all the elements that make up each individual bullet chart with <code>.append("g")</code> before placing the group in the right place with <code>.attr("transform", "translate(" + margin.left + "," + margin.top + ")")</code>.</p>

<p>Then we wave the magic wand and call the <code>chart</code> function with <code>.call(chart);</code> which will take all the information from our data file ( like the <code>ranges</code>, <code>measures</code> and <code>markers</code> values) and use the <code>bullet.js</code> script to create a chart.</p>

<p>The reason I made the comment about the process looking like magic is that the vast majority of the heavy lifting is done by the <code>bullet.js</code> file. Because it’s abstracted away from the immediate code that we’re writing, it looks simplistic, but like all good things, there needs to be a lot of complexity to make a process look simple.</p>

<p>We then add the titles.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">title</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(-6,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

  <code class="nx">title</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">title</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">title</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"subtitle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">subtitle</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>We do this in stages. First we create a variable <code>title</code> which will append objects to the grouped element created above (<code>var title = svg.append("g")</code>). We apply a style (<code>.style("text-anchor", "end")</code>) and transform to the objects (<code>.attr("transform", "translate(-6," + height / 2 + ")");</code>).</p>

<p>Then we append the <code>title</code> and <code>subtitle</code> data (from our JSON file) to our chart with a modicum of styling and placement.</p>

<p>Then we add a button and functions which do the job of applying random data to our variables every time it’s pressed. </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"button"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">randomize</code><code class="p">).</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">));</code>
  <code class="p">});</code>
<code class="p">});</code>

<code class="kd">function</code> <code class="nx">randomize</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">)</code> <code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code> <code class="o">=</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">k</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">ranges</code><code class="p">)</code> <code class="o">*</code> <code class="p">.</code><code class="mi">2</code><code class="p">;</code>
  <code class="k">return</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d</code> <code class="o">+</code> <code class="nx">k</code> <code class="o">*</code> <code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">-</code> <code class="p">.</code><code class="mi">5</code><code class="p">));</code>
  <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>I’m not going to delve into the working of the randomize function, because it exists simply to demonstrate the dynamic nature of the chart and not really how the chart is drawn.</p>

<p>However, I will be going through a process later to ensure that we can update the data and the chart automatically which will hopefully be more orientated to practical applications.</p>

<p>That’s it! Now we’ll go through how you can use the data to change aspects of the chart and what parts of the code need to be adjusted to work with those changes.</p>

<h3 id="leanpub-auto-adapting-and-changing-bullet-chart-components">Adapting and changing bullet chart components</h3>

<p>This section explores some of the simple changes that can be made to bullet charts that may not necessarily be obvious.</p>

<h4 id="leanpub-auto-understand-your-data">Understand your data</h4>

<p>The first point to note is that understanding the data loaded from the JSON file is a key to knowing what your chart is going to do.</p>

<p>We’ll start by looking at our data in a way that hopefully makes the most sense.</p>

<p>You may be faced with data for a bullet chart that’s in a format as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>[
{"title":"CPU Load","subtitle":"GHz","ranges":[1500,2250,3000],"measures":
[2200],"markers":[2500]},
{"title":"Memory Used","subtitle":"MBytes","ranges":[256,512,1024],"measures":
[768],"markers":[900]}
]
</pre></div>

</figure>

<p>This is perfectly valid data, but we’ll find it slightly easier to understand if we show it like this…</p>

<figure class="code">
<div class="highlight"><pre><code></code>[
  {
    "title":"CPU Load",
    "subtitle":"GHz",
    "ranges":[1500,2250,3000],
    "measures":[2200],
    "markers":[2500]
  },
  {
    "title":"Memory Used",
    "subtitle":"MBytes",
    "ranges":[256,512,1024],
    "measures":[768],
    "markers":[900]
  }
]
</pre></div>

</figure>

<p>The data is exactly the same (in terms of content) but I find it a lot easier to comprehend what’s going on with the second example.</p>

<aside class="tip blurb">
    <p>I have a section in the book called ‘Understanding JavaScript Object Notation (JSON)’ in the ‘Assorted Tips and Tricks’ chapter. I found life a lot easier once I started to understand how data was structured in JSON, and if you take a bit of time to understand it, I think you’ll find life easier too.</p>

</aside>

<h4 id="leanpub-auto-add-as-many-individual-charts-as-you-want">Add as many individual charts as you want.</h4>

<p>The example data in the file is an array of two groups. Each group represents the information required to generate one bullet chart. Therefore the example data above will create the following charts;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bullet04.png" alt="Two Bullet Charts">
  <figcaption>Two Bullet Charts</figcaption>
</figure>


<p>You don’t need to make any changes to your code in order to add more individual charts. You just need to add more data groups to your JSON file. The following example uses exactly the same code, but with several extra groups of data.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bullet05.png" alt="Lots of Bullet Charts">
  <figcaption>Lots of Bullet Charts</figcaption>
</figure>


<h4 id="leanpub-auto-add-more-ranges-and-measures">Add more ranges and measures</h4>

<p>Returning to our single chart example, you can see from the JSON data that there are three specified ranges and one measure.</p>

<figure class="code">
<div class="highlight"><pre><code></code>[
  {
    "title":"CPU 1 Load",
    "subtitle":"GHz",
    "ranges":[1500,2250,3000],
    "measures":[2200],
    "markers":[2500]
  }
]
</pre></div>

</figure>

<p>The same was true for the css in the JavaScript code. Three ranges and one measure</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.bullet</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.marker</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.tick</code> <code class="nt">line</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">.5px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#eee</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s1</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ddd</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s2</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.measure.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.title</code> <code class="p">{</code> <code class="nb">font-size</code><code class="o">:</code> <code class="m">14px</code><code class="p">;</code> <code class="nb">font-weight</code><code class="o">:</code> <code class="nb">bold</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.subtitle</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#999</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>By matching the css for the <code>.bullet</code> style with the data you can add more or fewer of both. For example here’s example data, css and a chart with five ranges and two measures. </p>

<figure class="code">
<div class="highlight"><pre><code></code>[
  {
    "title":"CPU 1 Load",
    "subtitle":"GHz",
    "ranges":[500,1000,1500,2250,3000],
    "measures":[1250, 2200],
    "markers":[2650]
  }
]
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.bullet</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.marker</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="nb">lightgreen</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">5px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.tick</code> <code class="nt">line</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">.5px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">navy</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s1</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">mediumblue</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s2</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">dodgerblue</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s3</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">aqua</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s4</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">lightblue</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.measure.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.measure.s1</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">pink</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.title</code> <code class="p">{</code> <code class="nb">font-size</code><code class="o">:</code> <code class="m">14px</code><code class="p">;</code> <code class="nb">font-weight</code><code class="o">:</code> <code class="nb">bold</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.subtitle</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#999</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bullet06.png" alt="Bullet Chart with Five Ranges and Two Measures">
  <figcaption>Bullet Chart with Five Ranges and Two Measures</figcaption>
</figure>


<p>First of all. Yes, I know the colours are gaudy. Hopefully they stand out. Don’t abuse your own graphs in this hideous way.</p>

<p>More importantly though, you can now get a better idea of how to align the range and measure values in the JSON file with the <code>.range</code> and <code>.measure</code> styles in the css.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bullet07.png" alt="Bullet Chart with Five Ranges and Two Measures">
  <figcaption>Bullet Chart with Five Ranges and Two Measures</figcaption>
</figure>


<p>The diagram shows that the <code>.range</code> and <code>.measure</code> bars are numbered from the right. (for example the ‘navy’ colour showing the range up to 3000 GHz is designated <code>.range.s0</code>. At first this convention of numbering from the right confused me. I imagined that the smallest range should be <code>.range.s0</code> and this should be on the left. Then I realised that the numbering related to the <em>layer</em> of the range. So this would make <code>.range.s0</code> go from 0 to 3000. Then the second layer would be <code>.range.s1</code> which would go <em>on top of</em> <code>.range.s0</code> from 0 to 2250, thereby covering most of <code>.range.s0</code> except for the part that exceeded <code>.range.s1</code>. Which is exactly what we see with successively higher layers having higher numbers. The same is true for the <code>.measure</code> numbers and layers.</p>

<h4 id="leanpub-auto-updating-a-bullet-chart-automatically">Updating a bullet chart automatically</h4>

<p>Displaying static data is a good start for a bullet chart, but if you have data that’s changing dynamically, you need to be able to re-load the information and display it automatically.</p>

<p>To adapt our code to this purpose we will first remove the parts that added the button. </p>

<p>Remove this portion from the css section;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">button</code> <code class="p">{</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
  <code class="nb">right</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
  <code class="nb">top</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>
<code class="p">}</code> 
</pre></div>

</figure>

<p>Then remove this line that added the button in the html section;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">button</code><code class="p">&gt;</code>Update<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>All we need to do now is change the section that called the original json file from;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"bullet-data.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>… to … </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"bullet-data2.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>So that we’re dealing with a different json file (there’s no need to go messing around with our original data).</p>

<p>Change the section that used to call the function to randomise the data with the button click from…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"button"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">randomize</code><code class="p">).</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">));</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>… to … </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">setInterval</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
		<code class="nx">updateData</code><code class="p">();</code>
	<code class="p">},</code> <code class="mi">1000</code><code class="p">);</code>
</pre></div>

</figure>

<p>This new piece of code simply sets up a repeating function that calls another function (<code>updateData</code>) every 1000ms.</p>

<p>The final change is to replace the original functions that randomised the data…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">randomize</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">)</code> <code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code> <code class="o">=</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">k</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">ranges</code><code class="p">)</code> <code class="o">*</code> <code class="p">.</code><code class="mi">2</code><code class="p">;</code>
  <code class="k">return</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d</code> <code class="o">+</code> <code class="nx">k</code> <code class="o">*</code> <code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">-</code> <code class="p">.</code><code class="mi">5</code><code class="p">));</code>
  <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… with our new function that updates the data … </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">updateData</code><code class="p">()</code> <code class="p">{</code>
	<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"bullet-data2.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
			<code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
				<code class="nx">d</code><code class="p">.</code><code class="nx">ranges</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">ranges</code><code class="p">;</code>
				<code class="nx">d</code><code class="p">.</code><code class="nx">measures</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">measures</code><code class="p">;</code>
				<code class="nx">d</code><code class="p">.</code><code class="nx">markers</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">markers</code><code class="p">;</code>
				<code class="k">return</code> <code class="nx">d</code><code class="p">;</code>
			<code class="p">})</code>
			<code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">));</code>
	<code class="p">});</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>This new function (<code>updateData</code>) reads in our json file again, selects all the svg elements then updates all the <code>.ranges</code>, <code>.measures</code> and <code>.markers</code> data with whatever was in the file. Then it calls the <code>chart</code> function that updates the bullet charts.</p>

<p>All the code components for this script can be found on <a href="https://gist.github.com/d3noob/5893649">github</a> or in the code samples bundled with this book (bullet-auto.html and bullet-data2.json). A live example can be found on <a href="http://bl.ocks.org/d3noob/5893649">bl.ocks.org</a> (although it won’t update since the data file can’t be updated online).</p>

<h2 id="leanpub-auto-mapping-with-d3js">Mapping with d3.js</h2>

<p>Another string to the bow of d3.js is the addition of a set of powerful routines for handling geographical information.</p>

<p>In the same sense that a line graph is a simple representation of data on a document, a map can be regarded as a set of points with an underlying coordinate system. When you say it like that it seems obvious that it should be applied as a document for display. However, I don’t want to give the impression that this is some sort of trivial matter for either the original developers or for you, the person who wants to display a map. Behind the scenes for this type of work, the thought that must have gone into making the code usable and extensible must have been enormous.</p>

<p>Mike Bostock has lauded the work of Jason Davies in the development of the latest major version of d3.js (version 3) for his work on improving mapping capability. A visit to his <a href="http://www.jasondavies.com/">home page</a> provides a glimpse into Jason’s expertise and no visit would be complete without marvelling at his work with <a href="http://www.jasondavies.com/maps/">geographic projections</a>.</p>

<h3 id="leanpub-auto-examples">Examples</h3>

<p>I am firmly of the belief that mapping in particular has an enormous potential for adding value to data sets. The following collection of examples gives a brief taste of what has been accomplished by combining geographic information and D3 thus far. (The screen shots following have been sourced from the <a href="http://biovisualize.github.com/d3visualization/#visualizationType=map">biovisualize gallery</a> and as such provide attribution to the best of my ability. If I have incorrectly attributed the source or author please let me know and I will correct it promptly.)</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map10.png" alt="Faux D3 3d globe integrated with Mapbox / Open Street Map">
  <figcaption>Faux D3 3d globe integrated with Mapbox / Open Street Map</figcaption>
</figure>


<p>Above is an interactive visualization showing the position of the main map on a faux D3 3d globe with a Mapbox / Open Street Map main window. Source <a href="http://dev.geosprocket.com/d3/finder/">dev.geosprocket.com</a> Source Bill Morris.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map01.png" alt="Kentucky Count Population from the 2010 census">
  <figcaption>Kentucky Count Population from the 2010 census</figcaption>
</figure>


<p>This is a breakdown of population in  Kentucky Counties from the 2010 census. Source: <a href="http://ccarpenterg.github.com/blog/us-census-visualization-with-d3js/">ccarpenterg.github.com</a> by Cristian Carpenter.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map07.png" alt="Beijing air pollution">
  <figcaption>Beijing air pollution</figcaption>
</figure>


<p>This map visualizes air pollution in Beijing. Source: <a href="http://scottcheng.github.com/bj-air-vis/">scottcheng.github.com</a> by Scott Cheng.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map03.png" alt="Shuttle Radar Topography Mission tile downloading">
  <figcaption>Shuttle Radar Topography Mission tile downloading</figcaption>
</figure>


<p>This is a section of the globe that is presented on the Shuttle Radar Topography Mission tile downloading web site. This excellent site uses the interactive globe to make the selection of SRTM tiles easy. Source <a href="http://dwtkns.com/srtm/">dwtkns.com</a> by Derek Watkins.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map04.png" alt="Animated World tour">
  <figcaption>Animated World tour</figcaption>
</figure>


<p>This is a static screen-shot of an animated tour of the Worlds countries. Source <a href="http://bl.ocks.org/mbostock/4183330">bl.ocks.org</a> by Mike Bostock.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map05.png" alt="A Chicago Divided by Killings: New Your Times">
  <figcaption>A Chicago Divided by Killings: New Your Times</figcaption>
</figure>


<p>This is one of the great infographics published by the <a href="http://www.nytimes.com">New York Times</a>. Source: <a href="http://www.nytimes.com/interactive/2013/01/02/us/chicago-killings.html?_r=0">www.nytimes.com</a> by Mike Bostock, Shan Carter and Kevin Quealy.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map06.png" alt="Concentric circles emanating from glowing red dot">
  <figcaption>Concentric circles emanating from glowing red dot</figcaption>
</figure>


<p>This is an animated graphic showing a series of concentric circles emanating from glowing red dot which was styled after a <a href="http://www.theonion.com/video/breaking-news-series-of-concentric-circles-emanati,14204/">news article in The Onion</a>. Source: <a href="http://bl.ocks.org/mbostock/4503672">bl.ocks.org</a> by Mike Bostock.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map08.png" alt="Christchurch earthquakes timeline">
  <figcaption>Christchurch earthquakes timeline</figcaption>
</figure>


<p>Here we see earthquakes represented on a selectable timeline where D3 generates a svg overlay and the map layer is created using Leaflet. Source: <a href="http://bl.ocks.org/tnightingale/4718717">bl.ocks.org</a> by tnightingale.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map09.png" alt="Earthquakes in the past 24 hours">
  <figcaption>Earthquakes in the past 24 hours</figcaption>
</figure>


<p>Carrying on with the earthquake theme, this is a map of all earthquakes in the past 24 hours over magnitude 2.5. Source: <a href="http://bl.ocks.org/benelsen/4969007">bl.ocks.org</a> by benelsen.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map11.png" alt="Satellite projection">
  <figcaption>Satellite projection</figcaption>
</figure>


<p>An interactive satellite projection. Source <a href="http://dev.geosprocket.com/d3/sat/">dev.geosprocket.com</a> by Bill Morris.</p>

<h3 id="leanpub-auto-geojson-and-topojson">GeoJSON and TopoJSON</h3>

<p>Projecting countries and various geographic features onto a map can be a very data hungry exercise. By that I mean that the information required to present geographic shapes can result in data files that are quite large. GeoJSON has been the default geographic data file of choice for quite some time, and as the name would suggest it encodes the data in a JSON type hierarchy. Often these GeoJSON files include a significant amount of extraneous detail or incorporate a level of accuracy that is impractical (too detailed). </p>

<p>Enter TopoJSON. Mike Bostock has designed TopoJSON as an extension to GeoJSON in the sense that it has a similar structure, but the geometries are not encoded discretely and where they share features, they are combined. Additionally TopoJSON encodes numeric values more efficiently and can incorporate a degree of simplification.  This simplification can result in savings of file size of 80% or more depending on the area and use of compression. Although TopoJSON has only begun to be used, the advantages of it seem clear and so I will anticipate its future use by incorporating it in my example diagrams (not that the use of GeoJSON differs much if at all). A great description of TopoJSOn can be found on the TopoJSON wiki on <a href="https://github.com/mbostock/topojson/wiki">github</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-starting-with-a-simple-map">Starting with a simple map</h3>

<p>Our starting example will demonstrate the simple display of a World map. Our final result will looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map12.png" alt="The World">
  <figcaption>The World</figcaption>
</figure>


<p>The data file for the World map is one produced by Mike Bostock’s as part of his TopoJSON work.</p>

<p>We’ll move through the explanation of the code in a similar process to the one we went through when highlighting the function of the Sankey diagram. Where there are areas that we have covered before, I will gloss over some details on the understanding that you will have already seen them explained in an earlier section (most likely the basic line graph example).</p>

<p>The full code for this graphic can be found on <a href="https://gist.github.com/d3noob/5189184">github</a> or in the code samples bundled with this book (world-map.html and world-110m2). A live example can be found on <a href="http://bl.ocks.org/d3noob/5189184">bl.ocks.org</a>.</p>

<p>Here is the full code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0.25px</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/topojson.v0.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">mercator</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">center</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">5</code> <code class="p">])</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">rotate</code><code class="p">([</code><code class="o">-</code><code class="mi">180</code><code class="p">,</code><code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">);</code>

<code class="c1">// load and display the World</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"world-110m2.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">topology</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">topojson</code><code class="p">.</code><code class="nx">object</code><code class="p">(</code><code class="nx">topology</code><code class="p">,</code> <code class="nx">topology</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">geometries</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
<code class="p">});</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>One of the first things that struck me when I first saw the code to draw a map was how small it was (the amount of code, not the World).  It’s a measure of the degree of abstraction that D3 is able to provide to the process of getting data from a raw format to the screen that such a complicated task can be condensed to such an apparently small amount of code. Of course that doesn’t tell the whole story. Like a duck on a lake, above the water all is serene and calm while below the water the feet are paddling like fury. In this case, our code looks serene because D3 is doing all the hard work :-).</p>

<p>The first block of our code is the start of the file and sets up our HTML.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This leads into our style declarations. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0.25px</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>We only state the properties of the path components which will make up our countries. Obviously we will fill them with grey and have a thin (<code>0.25px</code>) line around each one.</p>

<p>The next block of code loads the JavaScript files.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/topojson.v0.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>In this case it’s d3 and topojson. We load <code>topojson.v0.min.js</code> as a separate file because it’s still fairly new. In other words it hasn’t been incorporated into the main d3.js code base (that’s an assumption on my part since it might exist in isolation or perhaps end up as a plug-in). Whatever the case, for the time being, it exists as a separate file.</p>

<p>Then we get into the JavaScript. The first thing we do is define the size of our map.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then we get into one of the simple, but cool parts of making any map. Setting up the view.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">mercator</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">center</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">5</code> <code class="p">])</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">rotate</code><code class="p">([</code><code class="o">-</code><code class="mi">180</code><code class="p">,</code><code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>The projection is the way that the geographic coordinate system is adjusted for display on our flat screen. The screen is after all a two dimensional space and we are trying to present a three dimensional object. This is a big deal to cartographers in the sense that selecting a geographic projection for a map is an exercise in compromise. You can make it look pretty, but in doing so you can grievously distort the land size / shape. On the other hand you might make it more accurate, in size / shape but people will have trouble recognising it because they’re so used to the standard Mercator projection. For example, the awesome <a href="http://bl.ocks.org/mbostock/4458497">Waterman Butterfly</a>.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map13.png" alt="The Waterman Butterfly">
  <figcaption>The Waterman Butterfly</figcaption>
</figure>


<p>There are a lot of alternatives available. Please have a browse on the <a href="https://github.com/mbostock/d3/wiki/Geo-Projections">wiki</a> where you will find a huge range of options (66 at time of writing).</p>

<p>In our case we’ve gone with the conservative Mercator option.</p>

<p>Then we define three aspects of the projection. Center, scale and rotate.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-center">center</h4>

<p>If center is specified, this sets the projection’s center to the specified location as a two-element array of longitude and latitude in degrees and returns the projection. If center is not specified the default of (0°,0°)  is used.</p>

<p>Our example is using <code>[0, 5 ]</code> which I have selected as being in the middle (I use <code>0</code>) for longitude (left to right) and <code>5</code> degrees North of the equator (for latitude, North is positive, South is negative). This was purely to make it look aesthetically pleasing. Here’s the result of setting the center to <code>[100,30]</code>.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map14.png" alt="Center set to `[100,30]`">
  <figcaption>Center set to <code>[100,30]</code></figcaption>
</figure>


<p>The map has been centered on 100 degrees West and 30 degrees North. Of course, it’s also been pushed to the left without the right hand side of the map scrolling around. We’ll get to that in a moment.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-scale">scale</h4>

<p>If scale is specified, this sets the projection’s scale factor to the specified value. If scale is not specified, it returns the current scale factor which defaults to 150. It’s important to note that scale factors are not consistent across projections. </p>

<p>Our current map uses a scale of 900. Again, this has been set for aesthetics. Keeping our center of <code>[100,30]</code>, if we increase our scale to <code>2000</code> this is the result.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map15.png" alt="Scale set to `2000`">
  <figcaption>Scale set to <code>2000</code></figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-rotate">rotate</h4>

<p>If rotation is specified, this sets the projection’s three-axis rotation to the specified angles for yaw, pitch and roll (equivalently longitude, latitude and roll) in degrees and returns the projection. If rotation is not specified, it sets the values to [0, 0, 0]. If the specified rotation has only two values, rather than three, the roll is assumed to be 0°.</p>

<p>In our map we have specified <code>[-180,0]</code> so we can assume a roll value of zero. Likewise we have rotated our map by -180 degrees in longitude. This has been done specifically to place the map with the center on the anti-meridian (The international date line in the middle of the Pacific Ocean). If we return the value to <code>[0,0]</code>(with our original values of <code>scale</code> and <code>center</code> this is the result.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map16.png" alt="Rotate set to `[0,0]`">
  <figcaption>Rotate set to <code>[0,0]</code></figcaption>
</figure>


<p>In this case the centre of the map lines up with the meridian.</p>

<p>The next block of code sets our svg window;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code>
</pre></div>

</figure>

<p>The following portion of code creates a new geographic path generator;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">);</code>
</pre></div>

</figure>

<p>The path generator (<code>d3.geo.path()</code>) is used to specify a projection type (<code>.projection</code>) which was defined earlier as a Mercator projection via the variable <code>projection</code>. (I’m not entirely sure, but it is possible that I have just set some kind of record for use of the word ‘projection’ in a sentence.)</p>

<p>We then declare <code>g</code> as our appended svg.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The last block of JavaScript draws our map.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"world-110m2.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">topology</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">topojson</code><code class="p">.</code><code class="nx">object</code><code class="p">(</code><code class="nx">topology</code><code class="p">,</code> <code class="nx">topology</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">geometries</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>We load the TopoJSON file with the coordinates for our World map (<code>world-110m2.json</code>). Then we declare that we are going to act on all the <code>path</code> elements in the graphic (<code>g.selectAll("path")</code>).</p>

<p>Then we pull the data that defines the countries from the TopoJSON file (<code>.data(topojson.object(topology, topology.objects.countries).geometries)</code>).  We add it to the data that we’re going to display (<code>.enter()</code>) and then we append that data as <code>path</code> elements (<code>.append("path")</code>).</p>

<p>The last html block closes off our tags and we have a map!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map12.png" alt="The World map centered on the Pacific">
  <figcaption>The World map centered on the Pacific</figcaption>
</figure>


<h3 id="leanpub-auto-zooming-and-panning-a-map">Zooming and panning a map</h3>

<p>With our map displayed nicely we need to be able to move it about to explore it fully
.
To do this we can provide the functionality to zoom and pan it using the mouse.</p>

<p>Towards the end of the script, just before the close off of the script at the <code>&lt;/script&gt;</code> tag we can add in the following code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">zoom</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">behavior</code><code class="p">.</code><code class="nx">zoom</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"zoom"</code><code class="p">,</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">g</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code class="s2">"translate("</code><code class="o">+</code> 
            <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">translate</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s2">","</code><code class="p">)</code><code class="o">+</code><code class="s2">")scale("</code><code class="o">+</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">scale</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
        <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>  
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">));</code> 
<code class="p">});</code>

<code class="nx">svg</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">zoom</code><code class="p">)</code>
</pre></div>

</figure>

<p>This block of code introduces the <code>behavior</code>s functions. Using the <code>d3.behavior.zoom</code> function creates event listeners (which are like hidden functions standing by to look out for a specific type of activity on the computer and in this case mouse actions) to handle zooming and panning gestures on a container element (in this case our map). More information on the range of zoom options is available on the <a href="https://github.com/mbostock/d3/wiki/Zoom-Behavior">D3 Wiki</a>. </p>

<p>We begin by declaring the <code>zoom</code> function as <code>d3.behavior.zoom</code>.</p>

<p>Then we instruct the computer that when it ‘sees’ a ‘zoom’ event to carry out another function (<code>.on("zoom",function() {</code>).</p>

<p>That function firstly gathers the (correctly formatted) <code>translate</code> and <code>scale</code> attributes in…</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">g</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code class="s2">"translate("</code><code class="o">+</code> 
            <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">translate</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s2">","</code><code class="p">)</code><code class="o">+</code><code class="s2">")scale("</code><code class="o">+</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">scale</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and then applies them to all the path elements (which are the shapes of the countries) via…</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>  
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">));</code> 
</pre></div>

</figure>

<p>Lastly we call the zoom function.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">svg</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">zoom</code><code class="p">)</code>
</pre></div>

</figure>
<p>Then we relax and explore our map!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map17.png" alt="The World map with zoom and pan">
  <figcaption>The World map with zoom and pan</figcaption>
</figure>


<p>The full code for this graphic can be found on <a href="https://gist.github.com/d3noob/5189284">github</a> or in the code samples bundled with this book (world-map-zoom-pan.html and world-110m2). A live example can be found on <a href="http://bl.ocks.org/d3noob/5189284">bl.ocks.org</a>.</p>

<h3 id="leanpub-auto-displaying-points-on-a-map">Displaying points on a map</h3>

<p>Displaying maps and exploring them is pretty entertaining, but as anyone who has participated in the improvement of our geographic understanding of our world via projects such as <a href="http://www.openstreetmap.org/">Open Street Map</a> will tell you, there’s a whole new level of cool to be attained by adding to a map.</p>

<p>With that in mind, our next task is to add some simple detail in the form of points that show the location of cities.</p>

<p>To do this we will load in a csv file with data that identifies our cities and includes latitude and longitude details. Our file is called <code>cities.csv</code> and looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>code,city,country,lat,lon
ZNZ,ZANZIBAR,TANZANIA,-6.13,39.31
TYO,TOKYO,JAPAN,35.68,139.76
AKL,AUCKLAND,NEW ZEALAND,-36.85,174.78
BKK,BANGKOK,THAILAND,13.75,100.48
DEL,DELHI,INDIA,29.01,77.38
SIN,SINGAPORE,SINGAPOR,1.36,103.75
BSB,BRASILIA,BRAZIL,-15.67,-47.43
RIO,RIO DE JANEIRO,BRAZIL,-22.90,-43.24
YTO,TORONTO,CANADA,43.64,-79.40
IPC,EASTER ISLAND,CHILE,-27.11,-109.36
SEA,SEATTLE,USA,47.61,-122.33
</pre></div>

</figure>

<p>While we’re only going to use the latitude and longitude for our current work, the additional details could just as easily be used for labelling or tooltips.</p>

<p>We need to place our code carefully in this case because while you might have some flexibility in getting the right result with a locally hosted version of a map, there is a possibility that with a version hosted in the outside World (<em>gasp</em> the internet) you could strike trouble.</p>

<p>The code to load the cities should be placed inside the function that is loading the World map as indicated below;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"world-110m2.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">topology</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">topojson</code><code class="p">.</code><code class="nx">object</code><code class="p">(</code><code class="nx">topology</code><code class="p">,</code> <code class="nx">topology</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">geometries</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
                           <code class="c1">// &lt;== Put the new code block here</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>Here’s the new code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"cities.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
           <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                   <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">0</code><code class="p">];</code>
           <code class="p">})</code>
           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                   <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">1</code><code class="p">];</code>
           <code class="p">})</code>
           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We’ll go through the code and then explain the quirky thing about it.</p>

<p>First of all we load the <code>cities.csv</code> file (<code>d3.csv("cities.csv", function(error, data) {</code>). Then we select all the circle elements (<code> g.selectAll("circle")</code>), assign our data (<code>.data(data)</code>), enter our data (<code> .enter()</code>) and then add in circles (<code>.append("circle")</code>).</p>

<p>Then we set the x and y position for the circles based on the longitude (<code>([d.lon, d.lat])[0]</code>) and latitude (<code>([d.lon, d.lat])[1]</code>) information in the csv file.</p>

<p>Finally we assign a radius of 5 pixels and fill the circles with red.</p>

<p>The quirky thing about the new code block is that we have to put it inside the code block that loads the world data (<code>d3.json("world-110m2.json", function(error, topology) {</code>). We could place the two blocks one after the others (load / draw the world data, then load / draw the circles). And this will probably work if you run the file from your local computer. But when you host the files on the internet, it takes too long to load the world data compared to the city data and the end result is that the city data gets drawn before the world data and this is the result.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map18.png" alt="The cities under the World">
  <figcaption>The cities under the World</figcaption>
</figure>


<p>To avoid the problem we place the loading of the city data <em>into</em> the code that loads the World data. That way the city data doesn’t get loaded until the World data is loaded and then the circles get drawn on top of the world instead of under it :-).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map19.png" alt="The cities on top of the World">
  <figcaption>The cities on top of the World</figcaption>
</figure>


<p>The full code for this graphic can be found on <a href="https://gist.github.com/d3noob/5193723">github</a> or in the code samples bundled with this book (world-map-cities.html, cities.csv and world-110m2). A live example can be found on <a href="http://bl.ocks.org/d3noob/5193723">bl.ocks.org</a>.</p>

<p>Additionally the full code can be found in the appendix section at the rear of the book.</p>

<p>As an added extra and in response to a question that was asked on the d3noob.org blog, the names of the cities can be placed alongside the location dots by the addition of the following block of code inside the ‘cities’ loading portion of the script;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
       <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
       <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> <code class="c1">// append text</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
               <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">0</code><code class="p">];</code>
       <code class="p">})</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
               <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">1</code><code class="p">];</code>
       <code class="p">})</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="o">-</code><code class="mi">7</code><code class="p">)</code> <code class="c1">// set y position of bottom of text</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code> <code class="c1">// fill the text with the colour black</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">city</code><code class="p">;});</code> <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>The end result shows the name of the cities placed above and centred with respect to the location.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/map20.png" alt="The cities on top of the World">
  <figcaption>The cities on top of the World</figcaption>
</figure>


<p>The full code for this graphic can be found on <a href="https://gist.github.com/d3noob/401237468c9e38cea8c7">github</a> or in the code samples bundled with this book (world-map-cities-text.html, cities.csv and world-110m2). A live example can be found on <a href="http://bl.ocks.org/d3noob/401237468c9e38cea8c7">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-making-maps-with-d3js-and-leafletjs-combined">Making maps with d3.js and leaflet.js combined</h3>

<p>If you’ve read to this point in D3 Tips and Tricks, you may be aware that I have also written another book called ‘<a href="https://leanpub.com/leaflet-tips-and-tricks">Leaflet Tips and Tricks</a>’. I haven’t written both books because they are integrated with each other or because they seem made to compliment each other. I wrote them because both libraries are the best of breed (IMHO) at what they do. It should come as little surprise that they can have a lot to offer users who want to combine the incredible scope of d3.js’s data manipulation functions and the elegance of leaflet.js’s tile map presentation capabilities. </p>

<h4 id="leanpub-auto-leafletjs-overview">leaflet.js Overview</h4>

<p><a href="http://leafletjs.com/">Leaflet.js</a> is an Open Source JavaScript library designed to make deploying maps on a web page easy. It uses a paltry 34kB (at time of writing) JavaScript file that loads with your web page and provides access to a range of  functions that will allow you to present a map. </p>

<p>Its goals are to be simple to use while focussing on performance and usability, but it’s also built to be extended using plugins that extend its functionality. It has an excellent API which is well documented, so there are no mysteries to using it successfully in a range of situations.</p>

<p>Out of the box Leaflet provides the functionality to add markers, popups, overlay lines and shapes, use multiple layers, zoom, pan and generally have a good time :-). But these are just the the <em>core</em> features of Leaflet. One of the significant strengths of Leaflet is the ability to extend the functionality of the script with plugins from third parties. At the time of writing there are over 80 separate plugins that allow features such as overlaying a heatmap, animating markers, loading csv files of data, drawing complex shapes, measuring distance, manipulating layers and displaying coordinates.</p>

<p>Leaflet is simple, elegant and functional but powerful. There’s a good chance that even if you don’t present maps with Leaflet, you’ll be using ones that someone else made with it at some stage on the Internet.</p>

<p>Why use leaflet.js when d3.js does maps too?</p>

<p>Good question. I can see you’ve been paying attention.</p>

<p>There is a significant difference between the underlying way that d3.js and leaflet.js presents mapping data. D3.js predominantly focusses on vector based graphics when drawing maps and leaflet.js leverages the huge range of bitmap based map tiles that are available for use around the world. Both bitmap and vector based solutions have strengths and weaknesses depending on the application. Combining both allows the use of the best of both worlds.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-leaflet-map-with-d3js-objects-that-scale-with-the-map">Leaflet map with d3.js objects that scale with the map</h4>

<p>The first example we’ll look at will project a leaflet.js map on the screen with a d3.js object (in this case a simple rectangle) onto the map.</p>

<p>The rectangle will be bound to a set of geographic coordinates so that as the map is panned and zoomed the rectangle will shrink and grow. For example the following diagram shows a rectangle (made with d3.js ) superimposed over a leaflet.js map; </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/leaflet-d3-01.png" alt="Rectangular d3 area on leaflet map">
  <figcaption>Rectangular d3 area on leaflet map</figcaption>
</figure>


<p>If we then zoom in…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/leaflet-d3-02.png" alt="Zoomed rectangular d3 area on leaflet map">
  <figcaption>Zoomed rectangular d3 area on leaflet map</figcaption>
</figure>


<p>…the rectangle zooms in as well.</p>

<p>This may not sound terribly exciting and if you’re familiar with Leaflet you will know that it is possible to draw polygons onto a map using only leaflet’s built in functions. However, the real strength of this application of vector data comes when making the d3.js content interactive which is more difficult with leaflet.js.</p>

<p>For an excellent example of this please visit <a href="http://bost.ocks.org/mike/leaflet/">Mike Bostock’s tutorial</a> where he demonstrates superimposing a map of the United States separated by state (which react individually to the mouse being hovered over them). My following explanation is a humble derivation of his code.</p>

<p>Speaking of code, here is a full listing of the code that we will be using;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Leaflet and D3 Map<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code> <code class="p">/&gt;</code>
    <code class="p">&lt;</code><code class="nt">link</code> 
        <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> 
        <code class="na">href</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"</code>
    <code class="p">/&gt;</code>
    
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"map"</code> <code class="na">style</code><code class="o">=</code><code class="s">"width: 600px; height: 400px"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

	<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">script</code>
        <code class="na">src</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
	
        <code class="kd">var</code> <code class="nx">map</code> <code class="o">=</code> <code class="nx">L</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="s1">'map'</code><code class="p">).</code><code class="nx">setView</code><code class="p">([</code><code class="o">-</code><code class="mf">41.2858</code><code class="p">,</code> <code class="mf">174.7868</code><code class="p">],</code> <code class="mi">13</code><code class="p">);</code>
        <code class="nx">mapLink</code> <code class="o">=</code> 
            <code class="s1">'&lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt;'</code><code class="p">;</code>
        <code class="nx">L</code><code class="p">.</code><code class="nx">tileLayer</code><code class="p">(</code>
            <code class="s1">'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'</code><code class="p">,</code> <code class="p">{</code>
            <code class="nx">attribution</code><code class="o">:</code> <code class="s1">'&amp;copy; '</code> <code class="o">+</code> <code class="nx">mapLink</code> <code class="o">+</code> <code class="s1">' Contributors'</code><code class="p">,</code>
            <code class="nx">maxZoom</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
            <code class="p">}).</code><code class="nx">addTo</code><code class="p">(</code><code class="nx">map</code><code class="p">);</code>

		<code class="c1">// Add an SVG element to Leaflet’s overlay pane</code>
		<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="nx">map</code><code class="p">.</code><code class="nx">getPanes</code><code class="p">().</code><code class="nx">overlayPane</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">),</code>
			<code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"leaflet-zoom-hide"</code><code class="p">);</code>
			
		<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"rectangle.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">geoShape</code><code class="p">)</code> <code class="p">{</code>
		
		<code class="c1">//  create a d3.geo.path to convert GeoJSON to SVG</code>
		<code class="kd">var</code> <code class="nx">transform</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">transform</code><code class="p">({</code><code class="nx">point</code><code class="o">:</code> <code class="nx">projectPoint</code><code class="p">}),</code>
            <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">().</code><code class="nx">projection</code><code class="p">(</code><code class="nx">transform</code><code class="p">);</code>
 
		<code class="c1">// create path elements for each of the features</code>
		<code class="nx">d3_features</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
			<code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">geoShape</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>
			<code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">);</code>

		<code class="nx">map</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"viewreset"</code><code class="p">,</code> <code class="nx">reset</code><code class="p">);</code>

		<code class="nx">reset</code><code class="p">();</code>

		<code class="c1">// fit the SVG element to leaflet's map layer</code>
		<code class="kd">function</code> <code class="nx">reset</code><code class="p">()</code> <code class="p">{</code>
        
			<code class="nx">bounds</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">bounds</code><code class="p">(</code><code class="nx">geoShape</code><code class="p">);</code>

			<code class="kd">var</code> <code class="nx">topLeft</code> <code class="o">=</code> <code class="nx">bounds</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code>
				<code class="nx">bottomRight</code> <code class="o">=</code> <code class="nx">bounds</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>

			<code class="nx">svg</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">bottomRight</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">-</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>
				<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">bottomRight</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">-</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>
				<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>
				<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>

			<code class="nx">g</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="o">-</code><code class="nx">topLeft</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">+</code> <code class="s2">","</code> 
			                                  <code class="o">+</code> <code class="o">-</code><code class="nx">topLeft</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

			<code class="c1">// initialize the path data	</code>
			<code class="nx">d3_features</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
				<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mf">0.7</code><code class="p">)</code>
				<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'fill'</code><code class="p">,</code><code class="s1">'blue'</code><code class="p">);</code>
		<code class="p">}</code> 

		<code class="c1">// Use Leaflet to implement a D3 geometric transformation.</code>
		<code class="kd">function</code> <code class="nx">projectPoint</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
			<code class="kd">var</code> <code class="nx">point</code> <code class="o">=</code> <code class="nx">map</code><code class="p">.</code><code class="nx">latLngToLayerPoint</code><code class="p">(</code><code class="k">new</code> <code class="nx">L</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">(</code><code class="nx">y</code><code class="p">,</code> <code class="nx">x</code><code class="p">));</code>
			<code class="k">this</code><code class="p">.</code><code class="nx">stream</code><code class="p">.</code><code class="nx">point</code><code class="p">(</code><code class="nx">point</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code> <code class="nx">point</code><code class="p">.</code><code class="nx">y</code><code class="p">);</code>
		<code class="p">}</code>

	<code class="p">})</code>
        
    <code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>There is also an associated json data file (called <code>rectangle.json</code>) that has the following contents;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{
"type": "FeatureCollection",
"features": [ { 
	"type": "Feature", 
	"geometry": { 
		"type": "Polygon", 
		"coordinates": [ [ 
		[ 174.78, -41.29 ], 
		[ 174.79, -41.29 ], 
		[ 174.79, -41.28 ], 
		[ 174.78, -41.28 ], 
		[ 174.78, -41.29 ] 
		] ] 
		}
	}	
]
}
</pre></div>

</figure>

<p>The full code and a live example are available online at <a href="http://bl.ocks.org/d3noob/9211665">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/9211665">GitHub</a>. They are also available as the files ‘leaflet-d3-combined.html’ and ‘rectangle.json’ as a separate download with D3 Tips and Tricks. A a copy of all the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/leaflet-tips-and-tricks">download the book from Leanpub</a></p>

<p>While I will explain the code below, please be aware that I will gloss over some of the simpler sections that are covered in other sections of either books and will instead focus on the portions that are important to understand the combination of d3 and leaflet.</p>

<p>Our code begins by setting up the html document in a fairly standard way.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Leaflet and D3 Map<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code> <code class="p">/&gt;</code>
    <code class="p">&lt;</code><code class="nt">link</code> 
        <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> 
        <code class="na">href</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"</code>
    <code class="p">/&gt;</code>
    
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"map"</code> <code class="na">style</code><code class="o">=</code><code class="s">"width: 600px; height: 400px"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

	<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">script</code>
        <code class="na">src</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Here we’re getting some css styling and loading our leaflet.js / d3.js libraries. The only configuration item is where we set up the size of the map (in the <code>&lt;style&gt;</code> section and as part of the <code>map</code> div).</p>

<p>Then we break into the JavaScript code. The first thing we do is to project our Leaflet map;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">map</code> <code class="o">=</code> <code class="nx">L</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="s1">'map'</code><code class="p">).</code><code class="nx">setView</code><code class="p">([</code><code class="o">-</code><code class="mf">41.2858</code><code class="p">,</code> <code class="mf">174.7868</code><code class="p">],</code> <code class="mi">13</code><code class="p">);</code>
<code class="nx">mapLink</code> <code class="o">=</code> 
	<code class="s1">'&lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt;'</code><code class="p">;</code>
<code class="nx">L</code><code class="p">.</code><code class="nx">tileLayer</code><code class="p">(</code>
	<code class="s1">'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'</code><code class="p">,</code> <code class="p">{</code>
	<code class="nx">attribution</code><code class="o">:</code> <code class="s1">'&amp;copy; '</code> <code class="o">+</code> <code class="nx">mapLink</code> <code class="o">+</code> <code class="s1">' Contributors'</code><code class="p">,</code>
	<code class="nx">maxZoom</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
	<code class="p">}).</code><code class="nx">addTo</code><code class="p">(</code><code class="nx">map</code><code class="p">);</code>
</pre></div>

</figure>

<p>This is exactly the same as we have done in any of the simple map explanations in <a href="https://leanpub.com/leaflet-tips-and-tricks/">Leaflet Tips and Tricks</a> and in this case we are using the OpenStreetMap tiles.</p>

<p>Then we start on the d3.js part of the code. </p>

<p>The first part of that involves making sure that Leaflet and D3 are synchronised in the view that they’re projecting. This synchronisation needs to occur in zooming and panning so we add an SVG element to Leaflet’s <code>overlayPlane</code></p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="nx">map</code><code class="p">.</code><code class="nx">getPanes</code><code class="p">().</code><code class="nx">overlayPane</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">),</code>
	<code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"leaflet-zoom-hide"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we add a <code>g</code> element that ensures that the SVG element and the Leaflet layer have the same common point of reference. Otherwise when they zoomed and panned it could be offset. The <code>leaflet-zoom-hide</code> affects the presentation of the map when zooming. Without it the underlying map zooms to a new size, but the d3.js elements remain as they are until the zoom effect has taken place and then they adjust. It still works fine, but it ‘looks’ wrong.</p>

<p>Then we load our  data file with the line…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"rectangle.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">geoShape</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>This is pretty standard fare for d3.js but it’s worth being mindful that while the type of data file is <code>.json</code> this is a GeoJSON file and they have particular features (literally) that allow them to do their magic. There is a good explanation of how they are structured at <a href="http://geojson.org/geojson-spec.html">geojson.org</a> for those who are unfamiliar with the differences.</p>

<p>Using our data we need to ensure that it is correctly transformed from our latitude/longitude coordinates as supplied to coordinates on the screen. We do this by implementing d3’s geographic transformation features (<a href="https://github.com/mbostock/d3/wiki/API-Reference#wiki-d3geo-geography">d3.geo</a>).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">transform</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">transform</code><code class="p">({</code><code class="nx">point</code><code class="o">:</code> <code class="nx">projectPoint</code><code class="p">}),</code>
	<code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">().</code><code class="nx">projection</code><code class="p">(</code><code class="nx">transform</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here the path that we want to create in SVG is generated from the points that are supplied from the data file which are converted by the function <code>projectPoint</code> This function (which is placed at the end of the file) takes our latitude and longitudes and <a href="http://leafletjs.com/reference.html#map-conversion-methods">transforms them to screen (layer) coordinates</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">projectPoint</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
	<code class="kd">var</code> <code class="nx">point</code> <code class="o">=</code> <code class="nx">map</code><code class="p">.</code><code class="nx">latLngToLayerPoint</code><code class="p">(</code><code class="k">new</code> <code class="nx">L</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">(</code><code class="nx">y</code><code class="p">,</code> <code class="nx">x</code><code class="p">));</code>
	<code class="k">this</code><code class="p">.</code><code class="nx">stream</code><code class="p">.</code><code class="nx">point</code><code class="p">(</code><code class="nx">point</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code> <code class="nx">point</code><code class="p">.</code><code class="nx">y</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>With the transformations now all taken care of we can generate our path in the traditional d3.js way and append it to our <code>g</code> group.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3_features</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">geoShape</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The last ‘main’ part of our JavaScript makes sure that when our view of what we’re looking at changes (we zoom or pan) that our d3 elements change as well;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="nx">map</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"viewreset"</code><code class="p">,</code> <code class="nx">reset</code><code class="p">);</code>

	<code class="nx">reset</code><code class="p">();</code>
</pre></div>

</figure>

<p>Obviously when our view changes we call the function <code>reset</code>. It’s the job of the <code>reset</code> function to ensure that whatever the leaflet layer does, the SVG (d3.js) layer follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">reset</code><code class="p">()</code> <code class="p">{</code>

    <code class="nx">bounds</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">bounds</code><code class="p">(</code><code class="nx">geoShape</code><code class="p">);</code>

    <code class="kd">var</code> <code class="nx">topLeft</code> <code class="o">=</code> <code class="nx">bounds</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code>
        <code class="nx">bottomRight</code> <code class="o">=</code> <code class="nx">bounds</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>

    <code class="nx">svg</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">bottomRight</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">-</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">bottomRight</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">-</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="nx">topLeft</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>

    <code class="nx">g</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="o">-</code><code class="nx">topLeft</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">+</code> <code class="s2">","</code> 
                                      <code class="o">+</code> <code class="o">-</code><code class="nx">topLeft</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

    <code class="c1">// initialize the path data	</code>
    <code class="nx">d3_features</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mf">0.7</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'fill'</code><code class="p">,</code><code class="s1">'blue'</code><code class="p">);</code>
<code class="p">}</code> 
</pre></div>

</figure>

<p>It does this by establishing the <code>topLeft</code> and <code>bottomRight</code>corners of the desired area and then it applies the <code>width</code>, <code>height</code>, <code>top</code> and <code>bottom</code> attributes to the svg element and translates the <code>g</code> element to the right spot. Last, but not least it redraws the path.</p>

<p>The end result being a fine combination of leaflet.js map and ds.js element;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/leaflet-d3-01.png" alt="Rectangular d3 area on leaflet map">
  <figcaption>Rectangular d3 area on leaflet map</figcaption>
</figure>


<h4 id="leanpub-auto-leaflet-map-with-d3js-elements-that-are-overlaid-on-a-map">Leaflet map with d3.js elements that are overlaid on a map</h4>

<p>The next example of a combination of d3.js and leaflet.js is one where we want to have an element  overlaid on our map at a specific location, but have it remain a specific size over the map. For example, here we will display 5 circles which are centred at specific geographic locations.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/leaflet-d3-03.png" alt="d3.js circles fixed in geographic location on leaflet map but constant size">
  <figcaption>d3.js circles fixed in geographic location on leaflet map but constant size</figcaption>
</figure>


<p>When we zoom out of the map, those circles remain over the geographic location, but the same size on the screen.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/leaflet-d3-04.png" alt="Zoomed d3.js circles fixed in geographic location on leaflet map but constant size">
  <figcaption>Zoomed d3.js circles fixed in geographic location on leaflet map but constant size</figcaption>
</figure>


<p>You may (justifiably) ask yourself why we would want to do this with d3.js when Leaflet could do the same job with a marker? The answer is that as cool as leaflet.js’s markers are, d3 elements have a wider range of features that make their use advantageous in some situations. For instance if you want to animate or rotate the icons or dynamically adjust some of their attributes, d3.js would have a greater scope for adjustments.</p>

<p>The following code draws circles at geographic locations;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>d3.js with leaflet.js<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">link</code> 
        <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> 
        <code class="na">href</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"</code>
    <code class="p">/&gt;</code>
    <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">script</code>
        <code class="na">src</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
    
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"map"</code> <code class="na">style</code><code class="o">=</code><code class="s">"width: 600px; height: 400px"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code><code class="p">&gt;</code>
	
        <code class="kd">var</code> <code class="nx">map</code> <code class="o">=</code> <code class="nx">L</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="s1">'map'</code><code class="p">).</code><code class="nx">setView</code><code class="p">([</code><code class="o">-</code><code class="mf">41.2858</code><code class="p">,</code> <code class="mf">174.7868</code><code class="p">],</code> <code class="mi">13</code><code class="p">);</code>
        <code class="nx">mapLink</code> <code class="o">=</code> 
            <code class="s1">'&lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt;'</code><code class="p">;</code>
        <code class="nx">L</code><code class="p">.</code><code class="nx">tileLayer</code><code class="p">(</code>
            <code class="s1">'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'</code><code class="p">,</code> <code class="p">{</code>
            <code class="nx">attribution</code><code class="o">:</code> <code class="s1">'&amp;copy; '</code> <code class="o">+</code> <code class="nx">mapLink</code> <code class="o">+</code> <code class="s1">' Contributors'</code><code class="p">,</code>
            <code class="nx">maxZoom</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
            <code class="p">}).</code><code class="nx">addTo</code><code class="p">(</code><code class="nx">map</code><code class="p">);</code>
 
    <code class="c1">// Initialize the SVG layer</code>
    <code class="nx">map</code><code class="p">.</code><code class="nx">_initPathRoot</code><code class="p">()</code>    

    <code class="c1">// We pick up the SVG from the map object</code>
    <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#map"</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">),</code>
    <code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">);</code>
	
    <code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"circles.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">collection</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Add a LatLng object to each item in the dataset</code>
        <code class="nx">collection</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">LatLng</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">L</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">circle</code><code class="p">.</code><code class="nx">coordinates</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code>
                                    <code class="nx">d</code><code class="p">.</code><code class="nx">circle</code><code class="p">.</code><code class="nx">coordinates</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>
        <code class="p">})</code>
		
        <code class="kd">var</code> <code class="nx">feature</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">collection</code><code class="p">.</code><code class="nx">objects</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">6</code><code class="p">)</code> 
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">);</code>  
		
        <code class="nx">map</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"viewreset"</code><code class="p">,</code> <code class="nx">update</code><code class="p">);</code>
        <code class="nx">update</code><code class="p">();</code>

        <code class="kd">function</code> <code class="nx">update</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">feature</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
            <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
                <code class="k">return</code> <code class="s2">"translate("</code><code class="o">+</code> 
                    <code class="nx">map</code><code class="p">.</code><code class="nx">latLngToLayerPoint</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">).</code><code class="nx">x</code> <code class="o">+</code><code class="s2">","</code><code class="o">+</code> 
                    <code class="nx">map</code><code class="p">.</code><code class="nx">latLngToLayerPoint</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">).</code><code class="nx">y</code> <code class="o">+</code><code class="s2">")"</code><code class="p">;</code>
                <code class="p">}</code>
            <code class="p">)</code>
        <code class="p">}</code>
    <code class="p">})</code>			 
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code> 
</pre></div>

</figure>

<p>There is also an associated json data file (called <code>circles.json</code>) that has the following contents;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{"objects":[
{"circle":{"coordinates":[-41.28,174.77]}},
{"circle":{"coordinates":[-41.29,174.76]}},
{"circle":{"coordinates":[-41.30,174.79]}},
{"circle":{"coordinates":[-41.27,174.80]}},
{"circle":{"coordinates":[-41.29,174.78]}}
]}
</pre></div>

</figure>

<p>The full code and a live example are available online at <a href="http://bl.ocks.org/d3noob/9267535">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/9267535">GitHub</a>. They are also available as the files ‘leaflet-d3-linked.html’ and ‘circles.json’ as a separate download with D3 Tips and Tricks. A a copy of all the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a></p>

<p>While I will explain the code below, as with the previous example (which is similar, but different) please be aware that I will gloss over some of the simpler sections that are covered in other sections of either books and will instead focus on the portions that are important to understand the combination of d3 and leaflet.</p>

<p>Our code begins by setting up the html document in a fairly standard way.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
	<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>d3.js with leaflet.js<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">link</code> 
        <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> 
        <code class="na">href</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"</code>
    <code class="p">/&gt;</code>
    <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">script</code>
        <code class="na">src</code><code class="o">=</code><code class="s">"http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
    
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

	<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"map"</code> <code class="na">style</code><code class="o">=</code><code class="s">"width: 600px; height: 400px"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Here we’re getting some css styling and loading our leaflet.js / d3.js libraries. The only configuration item is where we set up the size of the map (in the <code>&lt;div&gt;</code> section and as part of the <code>map</code> div).</p>

<p>Then we break into the JavaScript code. The first thing we do is to project our Leaflet map;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">map</code> <code class="o">=</code> <code class="nx">L</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="s1">'map'</code><code class="p">).</code><code class="nx">setView</code><code class="p">([</code><code class="o">-</code><code class="mf">41.2858</code><code class="p">,</code> <code class="mf">174.7868</code><code class="p">],</code> <code class="mi">13</code><code class="p">);</code>
    <code class="nx">mapLink</code> <code class="o">=</code> 
        <code class="s1">'&lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt;'</code><code class="p">;</code>
    <code class="nx">L</code><code class="p">.</code><code class="nx">tileLayer</code><code class="p">(</code>
        <code class="s1">'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">attribution</code><code class="o">:</code> <code class="s1">'&amp;copy; '</code> <code class="o">+</code> <code class="nx">mapLink</code> <code class="o">+</code> <code class="s1">' Contributors'</code><code class="p">,</code>
        <code class="nx">maxZoom</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
        <code class="p">}).</code><code class="nx">addTo</code><code class="p">(</code><code class="nx">map</code><code class="p">);</code>
</pre></div>

</figure>

<p>This is exactly the same as we have done in any of the simple map explanations in <a href="https://leanpub.com/leaflet-tips-and-tricks/">Leaflet Tips and Tricks</a> and in this case we are using the OpenStreetMap tiles.</p>

<p>Then we start on the d3.js part of the code.</p>

<p>Firstly the Leaflet map is initiated as SVG using <code>map._initPathRoot()</code>. </p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="c1">// Initialize the SVG layer</code>
	<code class="nx">map</code><code class="p">.</code><code class="nx">_initPathRoot</code><code class="p">()</code>    

	<code class="c1">// We pick up the SVG from the map object</code>
	<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#map"</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">),</code>
	<code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we select the svg layer and append a <code>g</code> element to give a common reference point <code>g = svg.append("g")</code>.</p>

<p>Then we load the json file with the coordinates for the circles;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"circles.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">collection</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>Then for each of the coordinates in the <code>objects</code> section of the json data we declare a new latitude / longitude pair from the associated <code>coordinates</code>; </p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="nx">collection</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">LatLng</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">L</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">circle</code><code class="p">.</code><code class="nx">coordinates</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code>
                                <code class="nx">d</code><code class="p">.</code><code class="nx">circle</code><code class="p">.</code><code class="nx">coordinates</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>
	<code class="p">})</code>
</pre></div>

</figure>

<p>Then we use a simple d3.js routine to add and place our circles based on the coordinates of each of our <code>objects</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="kd">var</code> <code class="nx">feature</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
			<code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">collection</code><code class="p">.</code><code class="nx">objects</code><code class="p">)</code>
			<code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
			<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  
			<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">6</code><code class="p">)</code> 
			<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
			<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">);</code> 
</pre></div>

</figure>

<p>We declare each as a <code>feature</code> and add a bit of styling just to make them stand out.</p>

<p>The last ‘main’ part of our JavaScript makes sure that when our view of what we’re looking at changes (we zoom or pan) that our d3 elements change as well;</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="nx">map</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"viewreset"</code><code class="p">,</code> <code class="nx">update</code><code class="p">);</code>
		<code class="nx">update</code><code class="p">();</code>
</pre></div>

</figure>

<p>Obviously when our view changes we call the function <code>update</code>. It’s the job of the <code>update</code> function to ensure that whenever the leaflet layer moves, the SVG layer with the d3.js elements follows and the points that designate the locations of those objects move appropriately;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="kd">function</code> <code class="nx">update</code><code class="p">()</code> <code class="p">{</code>
		<code class="nx">feature</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
		<code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
			<code class="k">return</code> <code class="s2">"translate("</code><code class="o">+</code> 
				<code class="nx">map</code><code class="p">.</code><code class="nx">latLngToLayerPoint</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">).</code><code class="nx">x</code> <code class="o">+</code><code class="s2">","</code><code class="o">+</code> 
				<code class="nx">map</code><code class="p">.</code><code class="nx">latLngToLayerPoint</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">).</code><code class="nx">y</code> <code class="o">+</code><code class="s2">")"</code><code class="p">;</code>
			<code class="p">}</code>
		<code class="p">)</code>
	<code class="p">}</code>
</pre></div>

</figure>

<p>Here we are using the <code>transform</code> function on each <code>feature</code> to adjust the coordinates on our <code>LatLng</code> coordinates. We only need to adjust our coordinates since the size, shape, rotation and any other attribute or style is dictated by the objects themselves.</p>

<p>And there we have it!  </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/leaflet-d3-03.png" alt="d3.js circles fixed in geographic location on leaflet map but constant size">
  <figcaption>d3.js circles fixed in geographic location on leaflet map but constant size</figcaption>
</figure>


<h2 id="leanpub-auto-d3js-examples-explained">D3.js Examples Explained</h2>

<p>I’ve decided to include an examples chapter because I have occasionally come across things that I wanted to do with data or a technique that didn’t necessarily fall into a specific category or where I had something that I wanted to do that went beyond an exercise that I would want to turn into a simple description.</p>

<p>In other words I think that this will be a place where I can put random graphics that I have made up that don’t necessarily fall into a logical category but which I think would be worth recording.</p>

<p>In many cases these examples will combine a range of techniques that have been explained in the book and in some cases they may include new material that perhaps I would have struggled to explain.</p>

<p>Whatever the case, I will try to explain the examples as best I can and to include a full code listing for each and a link to an electronic version wherever possible.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-dynamically-retrieve-historical-stock-records-via-yql">Dynamically retrieve historical stock records via YQL</h3>

<h4 id="leanpub-auto-purpose">Purpose</h4>

<p>This page was developed to be an attempt to integrate the ability to download time range data from the <a href="http://developer.yahoo.com/yql/">Yahoo! Developer Network</a> via a YQL query and to be able to edit that query and dynamically adjust the output graph.</p>

<p>It doesn’t hurt that the data is pretty interesting (who isn’t fascinated by the rise and fall of stock prices?).</p>

<p>The following is a picture of the resulting graph;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/example-01.png" alt="Dynamic historical stock graph">
  <figcaption>Dynamic historical stock graph</figcaption>
</figure>


<h4 id="leanpub-auto-the-code-5">The code</h4>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/9576689">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/9576689">GitHub</a>. It is also available as the file ‘yql-dynamic-stock-line.html’ as a separate download with D3 Tips and Tricks. A a copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>

<code class="nt">path</code> <code class="p">{</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">text</code><code class="nc">.shadow</code> <code class="p">{</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2.5px</code><code class="p">;</code>
    <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">9</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- set inputs for the query --&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"new_input"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    Stock: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"stock"</code> <code class="na">id</code><code class="o">=</code><code class="s">"stock"</code> <code class="na">value</code><code class="o">=</code><code class="s">"YHOO"</code>
    <code class="na">style</code><code class="o">=</code><code class="s">"width: 70px;"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    Start: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"start"</code> <code class="na">id</code><code class="o">=</code><code class="s">"start"</code> <code class="na">value</code><code class="o">=</code><code class="s">"2013-08-10"</code>
    <code class="na">style</code><code class="o">=</code><code class="s">"width: 80px;"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    End: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"end"</code> <code class="na">id</code><code class="o">=</code><code class="s">"end"</code> <code class="na">value</code><code class="o">=</code><code class="s">"2014-03-10"</code>
    <code class="na">style</code><code class="o">=</code><code class="s">"width: 80px;"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"updateButton"</code>
    <code class="na">type</code><code class="o">=</code><code class="s">"button"</code>
    <code class="na">value</code><code class="o">=</code><code class="s">"Update"</code>
    <code class="na">onclick</code><code class="o">=</code><code class="s">"updateData()"</code> <code class="p">/&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// Set the dimensions of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m-%d"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="c1">// Set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code>    <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">high</code><code class="p">);</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code>
            <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code>
            <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">stock</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'stock'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">start</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'start'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">end</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'end'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">inputURL</code> <code class="o">=</code> <code class="s2">"http://query.yahooapis.com/v1/public/yql"</code><code class="o">+</code>
    <code class="s2">"?q=select%20*%20from%20yahoo.finance.historicaldata%20"</code><code class="o">+</code>
    <code class="s2">"where%20symbol%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">stock</code><code class="o">+</code><code class="s2">"%22%20and%20startDate%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">start</code><code class="o">+</code><code class="s2">"%22%20and%20endDate%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">end</code><code class="o">+</code><code class="s2">"%22&amp;format=json&amp;env=store%3A%2F%2F"</code>
    <code class="o">+</code><code class="s2">"datatables.org%2Falltableswithkeys"</code><code class="p">;</code>

    <code class="c1">// Get the data</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">inputURL</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">){</code>

    <code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nb">Date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">high</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">High</code><code class="p">;</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">low</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">Low</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code>
        <code class="nx">d3</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">low</code><code class="p">;</code> <code class="p">}),</code>
        <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">high</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">]);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>        <code class="c1">// Add the valueline path.</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">));</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>            <code class="c1">// Add the X Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>            <code class="c1">// Add the Y Axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// Add the label</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"label"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code><code class="nx">width</code><code class="o">+</code><code class="mi">3</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code>
            <code class="o">+</code> <code class="nx">y</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">high</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"high"</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// Add the title shadow</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"shadow"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"16px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">stock</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// Add the title</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"stock"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"16px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">stock</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// ** Update data section (Called from the onclick)</code>
<code class="kd">function</code> <code class="nx">updateData</code><code class="p">()</code> <code class="p">{</code>

<code class="kd">var</code> <code class="nx">stock</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'stock'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">start</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'start'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">end</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'end'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">inputURL</code> <code class="o">=</code> <code class="s2">"http://query.yahooapis.com/v1/public/yql"</code><code class="o">+</code>
    <code class="s2">"?q=select%20*%20from%20yahoo.finance.historicaldata%20"</code><code class="o">+</code>
    <code class="s2">"where%20symbol%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">stock</code><code class="o">+</code><code class="s2">"%22%20and%20startDate%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">start</code><code class="o">+</code><code class="s2">"%22%20and%20endDate%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">end</code><code class="o">+</code><code class="s2">"%22&amp;format=json&amp;env=store%3A%2F%2F"</code>
    <code class="o">+</code><code class="s2">"datatables.org%2Falltableswithkeys"</code><code class="p">;</code>

    <code class="c1">// Get the data again</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">inputURL</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">){</code>

        <code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nb">Date</code><code class="p">);</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">high</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">High</code><code class="p">;</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">low</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">Low</code><code class="p">;</code>
        <code class="p">});</code>

        <code class="c1">// Scale the range of the data</code>
        <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
        <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code>
            <code class="nx">d3</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">low</code><code class="p">;</code> <code class="p">}),</code>
            <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">high</code><code class="p">;</code> <code class="p">})</code>
        <code class="p">]);</code>

        <code class="c1">// Select the section we want to apply our changes to</code>
        <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">transition</code><code class="p">();</code>

        <code class="c1">// Make the changes</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".line"</code><code class="p">)</code>    <code class="c1">// change the line</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">));</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".label"</code><code class="p">)</code>   <code class="c1">// change the label text</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code><code class="nx">width</code><code class="o">+</code><code class="mi">3</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code>
            <code class="o">+</code> <code class="nx">y</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">high</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".shadow"</code><code class="p">)</code> <code class="c1">// change the title shadow</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">stock</code><code class="p">);</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".stock"</code><code class="p">)</code>   <code class="c1">// change the title</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">stock</code><code class="p">);</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".x.axis"</code><code class="p">)</code> <code class="c1">// change the x axis</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".y.axis"</code><code class="p">)</code> <code class="c1">// change the y axis</code>
            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
    <code class="p">});</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-the-description">The description</h4>

<p>Firstly, I have not included any form of validation or sanitising of the input fields. If you were to build something that was being used in a serious way, that would be essential.</p>

<p>Secondly, there are limits on what the YQL query will return. I have found that there appears to be a limit on the date range allowed (although I’m not sure what that limit is) and there is of course a limit to what the Yahoo! Developer Network will support for different end use cases. If you want to use the data for <a href="http://developer.yahoo.com/yql/guide/usage_info_limits.html">commercial reasons or if your use is heavy</a>, you will need to contact them to arrange for some form of agreement to use the data appropriately.</p>

<p>To use the graph all you need to do is enter a valid <a href="http://en.wikipedia.org/wiki/Ticker_symbol">ticker symbol</a> and a start / end date range where the date is formatted as yyyy/mm/dd. As I noted earlier, there appears to be a range limit, so feel free to experiment a bit to work it out if necessary to your use.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/example-02.png" alt="The ticker symbol and start/stop dates">
  <figcaption>The ticker symbol and start/stop dates</figcaption>
</figure>


<p>The section to get the input fields was something new to me as normally I would use <a href="http://getbootstrap.com/">bootstrap.js</a> with it’s wealth of form input options. But the following section in the HTLM portion was neat enough to get the required input.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"new_input"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    Stock: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"stock"</code> <code class="na">id</code><code class="o">=</code><code class="s">"stock"</code> <code class="na">value</code><code class="o">=</code><code class="s">"YHOO"</code>
    <code class="na">style</code><code class="o">=</code><code class="s">"width: 70px;"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    Start: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"start"</code> <code class="na">id</code><code class="o">=</code><code class="s">"start"</code> <code class="na">value</code><code class="o">=</code><code class="s">"2013-08-10"</code>
    <code class="na">style</code><code class="o">=</code><code class="s">"width: 80px;"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    End: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"end"</code> <code class="na">id</code><code class="o">=</code><code class="s">"end"</code> <code class="na">value</code><code class="o">=</code><code class="s">"2014-03-10"</code>
    <code class="na">style</code><code class="o">=</code><code class="s">"width: 80px;"</code><code class="p">&gt;</code>
    <code class="err">&amp;</code>nbsp <code class="err">&amp;</code>nbsp
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"updateButton"</code>
    <code class="na">type</code><code class="o">=</code><code class="s">"button"</code>
    <code class="na">value</code><code class="o">=</code><code class="s">"Update"</code>
    <code class="na">onclick</code><code class="o">=</code><code class="s">"updateData()"</code> <code class="p">/&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Of course it needs to be coupled with a JavaScript section to allow it to use the inputted fields in the query but that was also nice and easy with the following section of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">stock</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'stock'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">start</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'start'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">end</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'end'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>
</pre></div>

</figure>

<p>The HTML portion includes the <code>onclick="updateData()"</code> code that allows the  JavaScript <code>updateData</code> function to be called that reloads new data from the  Yahoo! Developer Network and updates the d3.js objects.</p>

<p>This particular file uses the ‘load everything first’ then ‘update everything that needs updating’ model that was followed in the earlier chapter on creating a line graph that loads data dynamically.</p>

<p>The YQL query is declared as a variable in the following section;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">inputURL</code> <code class="o">=</code> <code class="s2">"http://query.yahooapis.com/v1/public/yql"</code><code class="o">+</code>
    <code class="s2">"?q=select%20*%20from%20yahoo.finance.historicaldata%20"</code><code class="o">+</code>
    <code class="s2">"where%20symbol%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">stock</code><code class="o">+</code><code class="s2">"%22%20and%20startDate%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">start</code><code class="o">+</code><code class="s2">"%22%20and%20endDate%20%3D%20%22"</code>
    <code class="o">+</code><code class="nx">end</code><code class="o">+</code><code class="s2">"%22&amp;format=json&amp;env=store%3A%2F%2F"</code>
    <code class="o">+</code><code class="s2">"datatables.org%2Falltableswithkeys"</code><code class="p">;</code>
</pre></div>

</figure>

<p>It has had line feeds deliberately introduced to make formatting on the pages of the book easier (otherwise the publishing process introduces additional characters).  In it you can see the addition of the variables that allow the query to be executed (<code>stock</code>, <code>start</code> and <code>end</code>).</p>

<p>Immediately after loading the data we run it through a <code>forEach</code> loop that goes to the location in the JSON hierarchy where the <code>High</code>, <code>Low</code> and <code>Date</code> values are stored and it ensures that the <code>high</code> and <code>low</code> values are correctly recognises as numbers and formats the date.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">data</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">quote</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nb">Date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">high</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">High</code><code class="p">;</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">low</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">Low</code><code class="p">;</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>This is quite interesting because it provides a peek at the structure of the JSON. This is a pretty important piece of information because without the structure, it is not possible to correctly address the data you want. I’m not sure what the best method would be for determining the structure of the returned data, but I simply use a <code>console.log(data)</code> call after the data is loaded while I am developing the file and this allows me to explore and note the structure.</p>

<p>The following screen-shot illustrates the method;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/example-03.png" alt="console.log(data) structure">
  <figcaption>console.log(data) structure</figcaption>
</figure>


<p>You should be able to discern the <code>.query.results.quote</code> pathway that leads to the <code>High</code>, <code>Low</code> and <code>Date</code> values.</p>

<p>The remainder of the code is a repetition of examples explained in the remainder of the book. Most especially in the simple line graph area.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-linux-processes-via-interactive-tree-diagram">Linux Processes via Interactive Tree diagram</h3>

<h4 id="leanpub-auto-purpose-1">Purpose</h4>

<p>This page was developed to play with the idea of visualizing the relationship between processes running on a Linux server. To my shame, I never twigged that since the processes were ordered in a hierarchy they would therefore make an excellent tree diagram. I am therefore indebted to a friend for pointing out the obvious (as he often needs to do :-)).</p>

<p>Ultimately I have grand visions of this type of display being used to illustrate excessive memory or CPU usage when fault conditions occur, but for the purposes of simply showing the relationships, this example is suitable.</p>

<p>There are obviously a lot of processes running on a Linux server, so it was necessary to make the diagram interactive to allow branches to collapse where required for clarity. Indeed, there are a few of the tree diagram features which are covered separately in the chapter on tree diagrams which are combined here (interactive nodes, loading from an external source and making the tree interactive). Additionally, there is a great deal of data about each node that is available when running the <code>ps</code> command. I have chosen to show some of these in a tool tip that will appear when hovered over a node.</p>

<p>The tree is fairly large, so the following is a section of the tree with tool tip in action</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/example-tree-01.png" alt="Linux processes in tree form">
  <figcaption>Linux processes in tree form</figcaption>
</figure>


<h4 id="leanpub-auto-the-code-6">The Code</h4>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/9692795">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/9692795">GitHub</a>. It is also available as the files ‘process-tree.html’ and ‘ps.csv’ as separate downloads with the book D3 Tips and Tricks. A a copy of most the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">"en"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Linux Process Tree<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

  <code class="nt">div</code><code class="nc">.tooltip</code> <code class="p">{</code>
    <code class="nb">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
    <code class="nb">text-align</code><code class="o">:</code> <code class="nb">left</code><code class="p">;</code>
    <code class="nb">width</code><code class="o">:</code> <code class="m">180px</code><code class="p">;</code>
    <code class="nb">height</code><code class="o">:</code> <code class="m">80px</code><code class="p">;</code>
    <code class="nb">padding</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
    <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code>
    <code class="nb">background</code><code class="o">:</code> <code class="nb">lightsteelblue</code><code class="p">;</code>
    <code class="nb">border</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>
    <code class="nb">border</code><code class="o">-</code><code class="n">radius</code><code class="o">:</code> <code class="m">8px</code><code class="p">;</code>
    <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nc">.node</code> <code class="nt">circle</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">3px</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>

  <code class="nc">.link</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
  <code class="p">}</code>

    <code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>

  <code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// ************** Generate the tree diagram   *****************</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">120</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
  <code class="nx">width</code> <code class="o">=</code> <code class="mi">1200</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">,</code>
  <code class="nx">height</code> <code class="o">=</code> <code class="mi">900</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="nx">duration</code> <code class="o">=</code> <code class="mi">750</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">tree</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
  <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">diagonal</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">diagonal</code><code class="p">()</code>
  <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">];</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
                                    <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// load the external data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"ps.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// *********** Convert flat data into a nice tree ***************</code>
  <code class="c1">// create a name: node map</code>
  <code class="kd">var</code> <code class="nx">dataMap</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">reduce</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">map</code><code class="p">,</code> <code class="nx">node</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">map</code><code class="p">[</code><code class="nx">node</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">node</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">map</code><code class="p">;</code>
  <code class="p">},</code> <code class="p">{});</code>

  <code class="c1">// create the tree array</code>
  <code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[];</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">node</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// add to parent</code>
    <code class="kd">var</code> <code class="nx">parent</code> <code class="o">=</code> <code class="nx">dataMap</code><code class="p">[</code><code class="nx">node</code><code class="p">.</code><code class="nx">parent</code><code class="p">];</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">parent</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// create child array if it doesn't exist</code>
      <code class="p">(</code><code class="nx">parent</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="p">(</code><code class="nx">parent</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="p">[]))</code>
        <code class="c1">// add node to child array</code>
        <code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">node</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
      <code class="c1">// parent is null or missing</code>
      <code class="nx">treeData</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">node</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">});</code>

  <code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
  <code class="nx">root</code><code class="p">.</code><code class="nx">x0</code> <code class="o">=</code> <code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>
  <code class="nx">root</code><code class="p">.</code><code class="nx">y0</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

  <code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">frameElement</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="s2">"500px"</code><code class="p">);</code>

<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">source</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// Compute the new tree layout.</code>
  <code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">root</code><code class="p">).</code><code class="nx">reverse</code><code class="p">(),</code>
    <code class="nx">links</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>

  <code class="c1">// Normalize for fixed-depth.</code>
  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">*</code> <code class="mi">180</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Update the nodesâ€¦</code>
  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"g.node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nodes</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">||</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="o">++</code><code class="nx">i</code><code class="p">);</code> <code class="p">});</code>

  <code class="c1">// Enter any new nodes at the parent's previous position.</code>
  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y0</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x0</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="nx">click</code><code class="p">)</code>
      <code class="c1">// add tool tip for ps -eo pid,ppid,pcpu,size,comm,ruser,s</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">9</code><code class="p">);</code>
        <code class="nx">div</code> <code class="p">.</code><code class="nx">html</code><code class="p">(</code>
            <code class="s2">"PID: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"Command: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">COMMAND</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"User: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">RUSER</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"%CPU: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">CPU</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"Memory: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">SIZE</code>
            <code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
        <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
        <code class="p">});</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"lightsteelblue"</code> <code class="o">:</code> <code class="s2">"#fff"</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"end"</code> <code class="o">:</code> <code class="s2">"start"</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">COMMAND</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">);</code>

<code class="c1">// add the tool tip</code>
  <code class="kd">var</code> <code class="nx">div</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"tooltip"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>

  <code class="c1">// Transition nodes to their new position.</code>
  <code class="kd">var</code> <code class="nx">nodeUpdate</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>
      <code class="p">});</code>

  <code class="nx">nodeUpdate</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
	  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"lightsteelblue"</code> <code class="o">:</code> <code class="s2">"#fff"</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">nodeUpdate</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

  <code class="c1">// Transition exiting nodes to the parent's new position.</code>
  <code class="kd">var</code> <code class="nx">nodeExit</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">exit</code><code class="p">().</code><code class="nx">transition</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code>
                                             <code class="s2">","</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">remove</code><code class="p">();</code>

  <code class="nx">nodeExit</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">);</code>

  <code class="nx">nodeExit</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">);</code>

  <code class="c1">// Update the linksâ€¦</code>
  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path.link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">links</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Enter any new links at the parent's previous position.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code> <code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">o</code> <code class="o">=</code> <code class="p">{</code><code class="nx">x</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y0</code><code class="p">};</code>
      <code class="k">return</code> <code class="nx">diagonal</code><code class="p">({</code><code class="nx">source</code><code class="o">:</code> <code class="nx">o</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="nx">o</code><code class="p">});</code>
    <code class="p">});</code>

  <code class="c1">// Transition links to their new position.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">diagonal</code><code class="p">);</code>

  <code class="c1">// Transition exiting nodes to the parent's new position.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">exit</code><code class="p">().</code><code class="nx">transition</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">o</code> <code class="o">=</code> <code class="p">{</code><code class="nx">x</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">};</code>
      <code class="k">return</code> <code class="nx">diagonal</code><code class="p">({</code><code class="nx">source</code><code class="o">:</code> <code class="nx">o</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="nx">o</code><code class="p">});</code>
    <code class="p">})</code>
    <code class="p">.</code><code class="nx">remove</code><code class="p">();</code>

  <code class="c1">// Stash the old positions for transition.</code>
  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">x0</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">y0</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
  <code class="p">});</code>
<code class="p">}</code>

<code class="c1">// Toggle children on click.</code>
<code class="kd">function</code> <code class="nx">click</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="nx">update</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-description">Description</h4>

<p>I will describe both the code for the example and the csv file that accompanies it since (in this case) the data that generates the tree is not gathered entirely automatically and has some manual intervention applied to make it suitable for purpose.</p>

<p>The csv file (<code>ps.csv</code>) was generated by running the command…</p>

<figure class="code">
<div class="highlight"><pre><code></code>ps -eo pid,ppid,pcpu,size,comm,ruser,s
</pre></div>

</figure>

<p>…and converting the resultant output to a csv file.</p>

<figure class="code">
<div class="highlight"><pre><code></code>name,parent,CPU,SIZE,COMMAND,RUSER,S
0, ,0,0,start,nul,u
1,0,0.0,1140,init,root,S
2,0,0.0,0,kthreadd,root,S
3,2,0.0,0,ksoftirqd/0,root,S
5,2,0.0,0,kworker/0:0H,root,S
6,2,0.0,0,kworker/u2:0,root,S
7,2,0.0,0,migration/0,root,S
8,2,0.0,0,rcu_bh,root,S
9,2,0.0,0,rcuob/0,root,S
10,2,0.0,0,rcu_sched,root,S
...
</pre></div>

</figure>

<p>The column names I have specifically asked for with the command are;</p>

<ul>
  <li>pid: Process ID - The unique numeric identifier assigned to the process</li>
  <li>ppid: Parent Process ID - Indicates the decimal value of the parent process ID</li>
  <li>pcpu: Percentage of CPU - Time used (total CPU time divided by length of time the process has been running)</li>
  <li>size: Size - Memory size in kilobytes</li>
  <li>comm: Command -Indicates the short name of the command being executed</li>
  <li>ruser: Real User ID - The textual user ID</li>
  <li>s: State - Process state with possible values:</li>
  <li>R Running</li>
  <li>S Sleeping (may be interrupted)</li>
  <li>D Sleeping (may not be interrupted) used to indicate process is handling input/output</li>
  <li>T Stopped or being traced</li>
  <li>Z Zombie or “hung” process</li>
</ul>

<p>I manually added the ‘start’ line (0, ,0,0,start,nul,u) to include the root node and removed the ‘%’ sign from the ‘%CPU’ label (which is produces when running ‘ps’) to reduce chance of errors.</p>

<p>In theory the process of formatting the data file could be automated (indeed, there may be a much better way to gather and include it!).</p>

<p>The code is essentially an amalgam of four components which have been covered separately in earlier sections of the book;</p>

<ol class="numeric">
  <li>Tree code where the data is loaded from an external source</li>
  <li>Tree code where the data is converted into a hierarchy from a flat file</li>
  <li>Tree code to allow the diagram to collapse and expand.</li>
  <li>Tool tips as an HTML object.</li>
</ol>

<p>The loading of the data from an external source occurs in this portion of the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// load the external data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"ps.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// *********** Convert flat data into a nice tree ***************</code>
  <code class="c1">// create a name: node map</code>
  <code class="kd">var</code> <code class="nx">dataMap</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">reduce</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">map</code><code class="p">,</code> <code class="nx">node</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">map</code><code class="p">[</code><code class="nx">node</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">node</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">map</code><code class="p">;</code>
  <code class="p">},</code> <code class="p">{});</code>

  <code class="c1">// create the tree array</code>
  <code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[];</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">node</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// add to parent</code>
    <code class="kd">var</code> <code class="nx">parent</code> <code class="o">=</code> <code class="nx">dataMap</code><code class="p">[</code><code class="nx">node</code><code class="p">.</code><code class="nx">parent</code><code class="p">];</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">parent</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// create child array if it doesn't exist</code>
      <code class="p">(</code><code class="nx">parent</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="p">(</code><code class="nx">parent</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="p">[]))</code>
        <code class="c1">// add node to child array</code>
        <code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">node</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
      <code class="c1">// parent is null or missing</code>
      <code class="nx">treeData</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">node</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">});</code>

  <code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
  <code class="nx">root</code><code class="p">.</code><code class="nx">x0</code> <code class="o">=</code> <code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>
  <code class="nx">root</code><code class="p">.</code><code class="nx">y0</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

  <code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>In reality the loading process is just the wrapping part of that code segment as the inner portion is the section that takes the flat <code>data</code> and creates the hierarchical <code>treeData</code>.</p>

<p>The function <code>update</code> is the main section that allows the tree to expand and collapse (along with the <code>click</code> function). I won’t repeat that code here as it is quite lengthy and probably unnecessary (as it appears only a few pages previously). The only difference between the <code>update</code> function here and the one that is used in the example in the tree chapter is that we include a portion of code that allows us to include some of the details of each process in a tool tip;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Enter any new nodes at the parent's previous position.</code>
  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y0</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x0</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="nx">click</code><code class="p">)</code>
      <code class="c1">// add tool tip for ps -eo pid,ppid,pcpu,size,comm,ruser,s</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">9</code><code class="p">);</code>
        <code class="nx">div</code><code class="p">.</code><code class="nx">html</code><code class="p">(</code>
            <code class="s2">"PID: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"Command: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">COMMAND</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"User: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">RUSER</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"%CPU: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">CPU</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code>
            <code class="s2">"Memory: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">SIZE</code>
            <code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
        <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
        <code class="p">});</code>
</pre></div>

</figure>

<p>We use the <code>mouseover</code> and <code>mouseout</code> calls to find out when the cursor is over a portion of a node (and this includes the text part as well as the circle) and print out the name of the process (which is the Process ID (PID)), the command name (a nice textual equivalent of the PID) the user that the process is run by along with the CPU use and memory used.</p>

<p>The tree is pretty large, so depending on your use it might want to expand or perhaps contract. It could be drawn radially perhaps and there is certainly scope for encoding information about memory and CPU usage in the associated colouring of the nodes / links.</p>

<p>I would recommend visiting the demo page on <a href="http://bl.ocks.org/d3noob/9692795">bl.ocks.org</a> to get a good look at the result, as no picture in a book will be able to capture it sufficiently :-)</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/example-tree-01.png" alt="Linux processes in tree form">
  <figcaption>Linux processes in tree form</figcaption>
</figure>


<div class="page-break"></div>
<h3 id="leanpub-auto-multi-line-graph-with-automatic-legend-and-toggling-show--hide-lines">Multi-line graph with automatic legend and toggling show / hide lines.</h3>

<h4 id="leanpub-auto-purpose-2">Purpose</h4>

<p>Creating a multi-line graph is a pretty handy thing to be able to do and we worked through an example earlier in the book as an extension of our simple graph. In that example we used a csv file that had the data arranged with each lines values in a separate column.</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,open
1-May-12,68.13,34.12
30-Apr-12,63.98,45.56
27-Apr-12,67.00,67.89
26-Apr-12,89.70,78.54
25-Apr-12,99.00,89.23
24-Apr-12,130.28,99.23
23-Apr-12,166.70,101.34
</pre></div>

</figure>

<p>This is a common way to have data stored, but if you are retrieving information from a database, you may not have the luxury of having it laid out in columns. It may be presented in a more linear fashion where each lines values are stores on a unique row with the identifier for the line on the same row. For instance, the data above could just as easily be presented as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>price,date,value
close,1-May-12,68.13
close,30-Apr-12,63.98
close,27-Apr-12,67.00
close,26-Apr-12,89.70
close,25-Apr-12,99.00
close,24-Apr-12,130.28
close,23-Apr-12,166.70
open,1-May-12,34.12
open,30-Apr-12,45.56
open,27-Apr-12,67.89
open,26-Apr-12,78.54
open,25-Apr-12,89.23
open,24-Apr-12,99.23
open,23-Apr-12,101.34
</pre></div>

</figure>

<p>In this case, we would need to ‘pivot’ the data to produce the same multi-column representation as the original format. This is not always easy, but it can be achieved using the d3 <code>nest</code> function which we will examine.</p>

<p>As well as this we will want to automatically encode the lines to make them different colours and to add a legend with the line name and the colour of the appropriate line.</p>

<p>Finally, because we will build a graph script that can cope with any number of lines (within reason), we will need to be able to show / hide the individual lines to try and clarify the graph if it gets too cluttered.</p>

<p>All of these features have been covered individually in the book, so what we’re going to do is combine them in a way that presents us with an elegant multi-line graph that looks a bit like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/super-01.png" alt="Multi-line graph with legend">
  <figcaption>Multi-line graph with legend</figcaption>
</figure>


<h4 id="leanpub-auto-the-code-7">The Code</h4>

<p>The following is the code for the initial example which is a slight derivative of the original simple graph. A live version is available online at <a href="http://bl.ocks.org/d3noob/d8be922a10cb0b148cd5">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/d8be922a10cb0b148cd5">GitHub</a>. It is also available as the files ‘super-multi-lines.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>

<code class="nt">path</code> <code class="p">{</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// Set the dimensions of the canvas / graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%b %Y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="c1">// Set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// Define the axes</code>
<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="c1">// Define the line</code>
<code class="kd">var</code> <code class="nx">priceline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">price</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// Adds the svg canvas</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"stocks.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
		<code class="nx">d</code><code class="p">.</code><code class="nx">price</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">price</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">price</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="c1">// Nest the entries by symbol</code>
    <code class="kd">var</code> <code class="nx">dataNest</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">symbol</code><code class="p">;})</code>
        <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>

    <code class="c1">// Loop through each symbol / key</code>
    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

    <code class="p">});</code>

    <code class="c1">// Add the X Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="c1">// Add the Y Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-description-1">Description</h4>

<h5 id="leanpub-auto-nesting-the-data">Nesting the data</h5>

<p>The example code above differs from the simple graph in two main ways.</p>

<p>Firstly, the script loads the file <code>stocks.csv</code> which was used by Mike Bostock in his <a href="http://bl.ocks.org/mbostock/1157787">small multiples example</a>. This means that the variable names used are different (<code>price</code> for the value of the stocks, <code>symbol</code> for the name of the stock and good old <code>date</code> for the date) and we have to adjust the <code>parseDate</code> function to parse a modified date value.</p>

<p>Secondly we add the code blocks to take the <code>stocks.csv</code> information that we load as <code>data</code> and we apply the <code>d3.nest</code> function to it and draw each line.</p>

<p>The following code nest’s the data</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">dataNest</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">symbol</code><code class="p">;})</code>
        <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
</pre></div>

</figure>

<p>We declare our new array’s name as <code>dataNest</code> and we initiate the <code>nest</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="kd">var</code> <code class="nx">dataNest</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
</pre></div>

</figure>

<p>We assign the <code>key</code> for our new array as <code>symbol</code>. A ‘key’ is like a way of saying “<em>This is the thing we will be grouping on</em>”. In other words our resultant array will have a single entry for each unique <code>symbol</code> or stock which will itself be an array of dates and values.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">symbol</code><code class="p">;})</code>
</pre></div>

</figure>

<p>Then we tell the nest function which data array we will be using for our source of data.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">}).</code><code class="nx">entries</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we use the nested data to loop through our stocks and draw the lines</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>The <code>forEach</code> function being applied to <code>dataNest</code> means that it will take each of the keys that we have just declared with the <code>d3.nest</code> (each stock) and use the values for each stock to append a line using its values.</p>

<p>The end result looks like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/super-02.png" alt="A very plain multi-line graph">
  <figcaption>A very plain multi-line graph</figcaption>
</figure>


<p>You would be justified in thinking that this is more than a little confusing. Clearly while we have been successful in making each stock draw a corresponding line, unless we can tell them apart, the graph is pretty useless.</p>

<h5 id="leanpub-auto-applying-the-colours">Applying the colours</h5>

<p>Making sure that the colours that are applied to our lines (and ultimately our legend text) is unique from line to line is actually pretty easy.</p>

<p>The code that we will implement for this change is available online at <a href="http://bl.ocks.org/d3noob/88d2a87b72ea894c285c">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/88d2a87b72ea894c285c">GitHub</a>. It is also available as the files ‘super-multi-colours.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<p>The changes that we will make to our code are captured in the following code snippet.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category10</code><code class="p">();</code>

    <code class="c1">// Loop through each symbol / key</code>
    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>Firstly we  need to declare an <a href="https://github.com/mbostock/d3/wiki/Ordinal-Scales">ordinal scale</a> for our colours with <code>var color = d3.scale.category10();</code>. This is a set of categorical colours (10 of them in this case) that can be invoked which are a nice mix of difference from each other and pleasant on the eye.</p>

<p>We then use the colour scale to assign a unique stroke (line colour) for each unique key (symbol) in our dataset.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<p>It seems easy when it’s implemented, but in all reality, it is the product of some very clever thinking behind the scenes when designing d3.js and even picking the colours that are used. The end result is a far more usable graph of the stock prices.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/super-03.png" alt="Multi-line graph with unique colours">
  <figcaption>Multi-line graph with unique colours</figcaption>
</figure>


<p>Of course now we’re faced with the problem of not knowing which line represents which stock price. Time for a legend.</p>

<h5 id="leanpub-auto-adding-the-legend">Adding the legend</h5>

<p>If we think about the process of adding a legend to our graph, what we’re trying to achieve is to take every unique data series we have (stock) and add a relevant label showing which colour relates to which stock. At the same time, we need to arrange the labels in such a way that they are presented in a manner that is not offensive to the eye. In the example I will go through I have chosen to arrange them neatly spaced along the bottom of the graph. so that the final result looks like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/super-01.png" alt="Multi-line graph with legend">
  <figcaption>Multi-line graph with legend</figcaption>
</figure>


<p>Bear in mind that the end result will align the legend completely automatically. If there are three stocks it will be equally spaced, if it is six stocks they will be equally spaced. The following is a reasonable mechanism to facilitate this, but if the labels for the data values are of radically different lengths, the final result will looks ‘odd’ likewise, if there are a LOT of data values, the legend will start to get crowded.</p>

<p>The code that we will implement for this change is available online at <a href="http://bl.ocks.org/d3noob/7cd5a74c4620db72f43f">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/7cd5a74c4620db72f43f">GitHub</a>. It is also available as the files ‘super-multi-legend.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<p>There are three broad categories of changes that we will want to make to our current code;</p>

<ol class="numeric">
  <li>Declare a style for the legend font</li>
  <li>Change the area and margins for the graph to accommodate the additional text</li>
  <li>Add the text</li>
</ol>

<p>Declaring the style for the legend text is as easy as making an appropriate entry in the <code>&lt;style&gt;</code> section of the code. For this example I have chosen the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">.</code><code class="nx">legend</code> <code class="p">{</code>
    <code class="nx">font</code><code class="o">-</code><code class="nx">size</code><code class="o">:</code> <code class="mi">16</code><code class="nx">px</code><code class="p">;</code>
    <code class="nx">font</code><code class="o">-</code><code class="nx">weight</code><code class="o">:</code> <code class="nx">bold</code><code class="p">;</code>
    <code class="nx">text</code><code class="o">-</code><code class="nx">anchor</code><code class="o">:</code> <code class="nx">middle</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>To change the area and margins of the graph we can make the following small changes to the code.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">70</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>The bottom margin is now 70 pixels high and the overall space for the area that the graph (including the margins) covers is increased to 300 pixels.</p>

<p>To add the legend text is slightly more work, but only slightly more. The following code incorporates the changes and I have placed commented out asterisks to the end of the lines that have been added</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">legendSpace</code> <code class="o">=</code> <code class="nx">width</code><code class="o">/</code><code class="nx">dataNest</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="c1">// spacing for legend // ******</code>

    <code class="c1">// Loop through each symbol / key</code>
    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                           <code class="c1">// ******</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="c1">// Add the colours dynamically</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

        <code class="c1">// Add the Legend</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>                                    <code class="c1">// *******</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">legendSpace</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="nx">i</code><code class="o">*</code><code class="nx">legendSpace</code><code class="p">)</code> <code class="c1">// spacing // ****</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code> <code class="mi">5</code><code class="p">)</code>         <code class="c1">// *******</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>    <code class="c1">// style the legend   // *******</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="c1">// dynamic colours    // *******</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>             <code class="c1">// *******</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code>                                     <code class="c1">// *******</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>The first added line finds the spacing between each legend label by dividing the width of the graph area by the number of symbols (<code>key</code>’s or stocks).</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">legendSpace</code> <code class="o">=</code> <code class="nx">width</code><code class="o">/</code><code class="nx">dataNest</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then there is a small and subtle change that might other wise go unnoticed, but is nonetheless significant. We add an <code>i</code> to the <code>forEach</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>This might not seem like much of a big deal, but declaring <code>i</code> allows us to access the index of the returned data. This means that each unique <code>key</code> (stock or symbol) has a unique number. In our example those numbers would be from 0 to 3 (MSFT = 0, AMZN = 1, IBM = 2 and AAPL = 3 (this is the order in which the stocks appear in our csv file)).</p>

<p>Now we get to adding our text. Again, this is a fairly simple exercise which is following the route that we have taken several times already in the book but using some of our prepared values.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">legendSpace</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="nx">i</code><code class="o">*</code><code class="nx">legendSpace</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code>
</pre></div>

</figure>

<p>The horizontal spacing for the labels is achieved by setting each label to the position set by the index associated with the label and the space available on the graph. To make it work out nicely we add half a <code>legendSpace</code> at the start (<code>legendSpace/2</code>) and then add the product of the index (<code>i</code>) and <code>legendSpace</code> (<code>i*legendSpace</code>).</p>

<p>We position the legend vertically so that it is in the middle of the bottom margin (<code>height + (margin.bottom/2)+ 5</code>).</p>

<p>And we apply the same colour function to the text as we did to the lines earlier;</p>

<figure class="code">
<div class="highlight"><pre><code></code>            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<p>The final result is a neat and tidy legend at the bottom of the graph;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/super-01.png" alt="Multi-line graph with legend">
  <figcaption>Multi-line graph with legend</figcaption>
</figure>


<p>If you’re looking for an exercise to test your skills you could adapt the code to show the legend to the right of the graph. And if you wanted to go one better, you could arrange the order of the legend to reflect the final numeric value on the right of the graph (I.e in this case AAPL would be on the top and MSFT on the bottom).</p>

<h5 id="leanpub-auto-making-it-interactive">Making it interactive</h5>

<p>The last step we’ll take in this example is to provide ourselves with a bit of control over how the graph looks. Even with the multiple colours, the graph could still be said to be ‘busy’. To clean it up or at least to provide the ability to more clearly display the data that a user wants to see we will add code that will allow us to click on a legend label and this will toggle the corresponding graph line on or off.</p>

<p>This is a progression from the example of how to show / hide an element by clicking on another element that was introduced in he ‘Assorted tips and tricks’ chapter.</p>

<p>The only changes to our code that need to be implemented are in the <code>forEach</code> section below. I have left some comments with asterisks in the code below to illustrate lines that are added.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="nx">i</code><code class="p">)</code> <code class="p">{</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s1">'tag'</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code> <code class="c1">// assign ID **</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

        <code class="c1">// Add the Legend</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">legendSpace</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="nx">i</code><code class="o">*</code><code class="nx">legendSpace</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(){</code>                     <code class="c1">// ************</code>
                <code class="c1">// Determine if current line is visible</code>
                <code class="kd">var</code> <code class="nx">active</code>   <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">active</code> <code class="o">?</code> <code class="kc">false</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>  <code class="c1">// ************</code>
                <code class="nx">newOpacity</code> <code class="o">=</code> <code class="nx">active</code> <code class="o">?</code> <code class="mi">0</code> <code class="o">:</code> <code class="mi">1</code><code class="p">;</code>             <code class="c1">// ************</code>
                <code class="c1">// Hide or show the elements based on the ID</code>
                <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tag"</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code> <code class="c1">// *********</code>
                    <code class="p">.</code><code class="nx">transition</code><code class="p">().</code><code class="nx">duration</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>          <code class="c1">// ************</code>
                    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>       <code class="c1">// ************</code>
                <code class="c1">// Update whether or not the elements are active</code>
                <code class="nx">d</code><code class="p">.</code><code class="nx">active</code> <code class="o">=</code> <code class="nx">active</code><code class="p">;</code>                       <code class="c1">// ************</code>
                <code class="p">})</code>                                       <code class="c1">// ************</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>The full code for the complete working example is available online at <a href="http://bl.ocks.org/d3noob/e99a762017060ce81c76">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/e99a762017060ce81c76">GitHub</a>. It is also available as the files ‘super-multi.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<p>The first piece of code that we need to add assign an <code>id</code> to each legend text label.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s1">'tag'</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code>
</pre></div>

</figure>

<p>Being able to use our <code>key</code> value as the id means that each label will have a unique identifier. “<em>What’s with adding the <code>'tag'</code> piece of text to the <code>id</code>?</em>” I hear you ask. Good question. If our key starts with a number we could strike trouble (in fact I’m sure there are plenty of other ways we could strike trouble too, but this was one I came accross). As well as that we include a little regular expression goodness to strip any spaces out of the key with <code>.replace(/\s+/g, '')</code>.</p>

<aside class="information blurb">
    <p>The <code>.replace</code> calls the regular expression action on our <code>key</code>. <code>\s</code> is the regex for “whitespace”, and <code>g</code> is the “global” flag, meaning match ALL <code>\s</code> (whitespaces). The <code>+</code> allows for any <em>contiguous</em> string of space characters to being replaced with the empty string (<code>''</code>). This was a late addition to the example and kudos go to the participants in the <a href="http://stackoverflow.com/questions/5963182/how-to-remove-spaces-from-a-string-using-javascript">Stack Overflow question here</a>.</p>

</aside>

<p>Then we use the <code>.on("click", function(){</code> call carry out some actions on the label if it is clicked on. We toggle the <code>.active</code> descriptor for our element with <code>var active = d.active ? false : true,</code>. Then we set the value of <code>newOpacity</code> to either <code>0</code> or <code>1</code> depending on whether <code>active</code> is false or true.</p>

<p>From here we can select our label using its unique id and adjust it’s opacity to either <code>0</code> (transparent) or <code>1</code> (opaque);</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tag"</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code>
            <code class="p">.</code><code class="nx">transition</code><code class="p">().</code><code class="nx">duration</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
</pre></div>

</figure>

<p>Just because we can, we also add in a <code>transition</code> statement so that the change in transparency doesn’t occur in a flash (100 milli seconds in fact (<code>.duration(100)</code>)).</p>

<p>Lastly we update our <code>d.active</code> variable to whatever the active state is so that it can toggle correctly the next time it is clicked on.</p>

<p>Since it’s kind of difficult to represent interactivity in a book, head on over to the <a href="http://bl.ocks.org/d3noob/e99a762017060ce81c76">live example on bl.ocks.org</a> to see the toggling awesomeness that could be yours!</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-my-favourite-tooltip-method-for-a-line-graph">My Favourite tooltip method for a line graph.</h3>

<h4 id="leanpub-auto-purpose-3">Purpose</h4>

<p>Tooltips are a fabulous way to include an interactive element on a graph and a great mechanism for including additional, focussed information to the user.</p>

<p>There are quite a number of different ways to implement tooltips (one of which you can find in the ‘Adding tooltips’ section of the ‘Assorted Tips and Tricks’ chapter of D3 Tips and Tricks) and I would be very hesitant about proclaiming any one better than another. However, the one we will work through here is my favourite when using a line graph as I think it brings a ‘fuzzier’ mechanism for deciding when a tooltip is highlighted (you don’t have to be over an object to get information on it) which I like.</p>

<p>I believe that the original example for this was shown by Mike Bostock <a href="http://bl.ocks.org/mbostock/3902569">here</a>, but I first came across the technique in an <a href="http://bl.ocks.org/gniemetz/4618602">example by ‘gniemetz’</a>. I liked ‘gniemetz’s example enough to adapt a similar example which I will explain below.</p>

<p>The idea with this technique is to set an area the size of the graph that will be used to determine when a tooltip will be displayed. So that when the mouse enters that area, the <code>display</code> style that allows elements to be shown or hidden. This then tells the script to show the tooltip and the location of the mouse determines which point will have the tooltip. In the example below we can see that the mouse cursor is some distance away from the point that is being highlighted, but it is in line (in the vertical axis) with the highlighted point (in fact we will use some clever maths to determine which date point (or point on the x axis) is the one that will be used to generate the tooltip.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fave-01.png" alt="More complicated favourite tooltip example">
  <figcaption>More complicated favourite tooltip example</figcaption>
</figure>


<p>To begin this explanation we’ll start with a simple example that will just project a circle on the point where the tooltip will appear. Once we’ve worked out how that works we can add whatever we want and I will explain what is going on in the more complex example.</p>

<p>As mentioned, we will start with a simple example that adds a circle on the point where we will place our tooltip. It will look a bit like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fave-02.png" alt="Simple version of the favourite tooltip example">
  <figcaption>Simple version of the favourite tooltip example</figcaption>
</figure>


<h4 id="leanpub-auto-the-code-8">The Code</h4>

<p>The full code for this simple example is available online at <a href="http://bl.ocks.org/d3noob/e5daff57a04c2639125e">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/e5daff57a04c2639125e">GitHub</a>. It is also available as the files ‘best-tooltip-simple.html’ and ‘atad.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<p>I have placed commented out asterisks besides the lines that have been added or altered from the simple graph example that we started out with at the beginning of the book so that it’s easy to see what has changed.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>

<code class="nt">path</code> <code class="p">{</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// Set the dimensions of the canvas / graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>
    <code class="nx">bisectDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">bisector</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}).</code><code class="nx">left</code><code class="p">;</code> <code class="c1">// **</code>

<code class="c1">// Set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// Define the axes</code>
<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="c1">// Define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// Adds the svg canvas</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">lineSvg</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">);</code>                             <code class="c1">// **********</code>

<code class="kd">var</code> <code class="nx">focus</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>                                <code class="c1">// **********</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>                             <code class="c1">// **********</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"atad.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>                 <code class="c1">// **********</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="c1">// Add the valueline path.</code>
    <code class="nx">lineSvg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>                                 <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>

    <code class="c1">// Add the X Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="c1">// Add the Y Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

    <code class="c1">// append the circle at the intersection               // **********</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>                                 <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y"</code><code class="p">)</code>                                <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>                             <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>                           <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">4</code><code class="p">);</code>                                     <code class="c1">// **********</code>

    <code class="c1">// append the rectangle to capture mouse               // **********</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>                                     <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>                              <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">)</code>                            <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>                             <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"all"</code><code class="p">)</code>                    <code class="c1">// **********</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="kc">null</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mousemove"</code><code class="p">,</code> <code class="nx">mousemove</code><code class="p">);</code>                       <code class="c1">// **********</code>

    <code class="kd">function</code> <code class="nx">mousemove</code><code class="p">()</code> <code class="p">{</code>                                 <code class="c1">// **********</code>
        <code class="kd">var</code> <code class="nx">x0</code> <code class="o">=</code> <code class="nx">x</code><code class="p">.</code><code class="nx">invert</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">mouse</code><code class="p">(</code><code class="k">this</code><code class="p">)[</code><code class="mi">0</code><code class="p">]),</code>              <code class="c1">// **********</code>
            <code class="nx">i</code> <code class="o">=</code> <code class="nx">bisectDate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">x0</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>                   <code class="c1">// **********</code>
            <code class="nx">d0</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code> <code class="o">-</code> <code class="mi">1</code><code class="p">],</code>                              <code class="c1">// **********</code>
            <code class="nx">d1</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">],</code>                                  <code class="c1">// **********</code>
            <code class="nx">d</code> <code class="o">=</code> <code class="nx">x0</code> <code class="o">-</code> <code class="nx">d0</code><code class="p">.</code><code class="nx">date</code> <code class="o">&gt;</code> <code class="nx">d1</code><code class="p">.</code><code class="nx">date</code> <code class="o">-</code> <code class="nx">x0</code> <code class="o">?</code> <code class="nx">d1</code> <code class="o">:</code> <code class="nx">d0</code><code class="p">;</code>     <code class="c1">// **********</code>

        <code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle.y"</code><code class="p">)</code>                           <code class="c1">// **********</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>                             <code class="c1">// **********</code>
                  <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>         <code class="c1">// **********</code>
                                 <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>        <code class="c1">// **********</code>
    <code class="p">}</code>                                                      <code class="c1">// **********</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-description-2">Description</h4>

<p>You should be able to tell from the asterisks in the code above that there aren’t too many changes and appart from a few at the start and middle, the majority are contained in a large block towards the end.</p>

<p>Starting with our first change</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">bisectDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">bisector</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}).</code><code class="nx">left</code><code class="p">;</code>
</pre></div>

</figure>

<p>This is our function that will be called later in the code that returns a value in our array of data that corresponds to the horizontal position of the mouse pointer. Specifically it returns the date that falls to the left of the mouse cursor.</p>

<p>The <a href="https://github.com/mbostock/d3/wiki/Arrays#wiki-d3_bisector"><code>d3.bisector</code></a> is an ‘array method’ that can use an <em>accessor</em> or <em>comparator</em> function to divide an array of objects. In this case our array of date values. In the code I have used the <code>d3.bisector</code> as an <em>accessor</em>, because I believe that it’s simpler to do so for the point of explanation, but the downside is that I had to have my dates ordered in ascending order which is why I load a slightly different csv file later (<code>atad.csv</code>).</p>

<p>If your eyes glazed over slightly reading the previous paragraph, don’t let that put you off. Like with so many things, just relax and let d3.js do the magic and remember that <code>d3.bisector</code> can find a value in an ordered array.</p>

<p>The next block of changes declares a couple of functions that we will use to add our elements to our graph;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">lineSvg</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">focus</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We will use <code>lineSvg</code> to add our line for the line graph and <code>focus</code> will add our tooltip elements. it is possible to avoid using lineSvg, but this way of declaring the functions means that we can control which elements are on top of which on the screen. For instance, it would be a pretty sad affair if our tooltip was appearing under the line of the line graph (hard to read).</p>

<p>As we saw earlier, our data is being sourced from a different csv file (<code>atad.csv</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"atad.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>This is because we need to have it in a compatible order (ascending) to allow our bisector function to operate correctly. So while the line may look the same as the simple graph version, the data is ordered in reverse (some may say that this is the way the original data should have been presented all along, but I suppose we can’t always second guess the data we get).</p>

<p>We then make a small change to the script that appended the line to the graph and instead of using <code>svg.append</code>… we use our newly declared <code>lineSvg</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">lineSvg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
</pre></div>

</figure>

<p>The final, larger block of code can be broken into 4 logical sections;</p>

<ol class="numeric">
  <li>Adding the circle to the graph</li>
  <li>Set the area that we use to capture our mouse movements</li>
  <li>The clever maths that determines which date will be highlighted</li>
  <li>Move the circle to the appropriate position</li>
</ol>

<aside class="information blurb">
    <p>The last two points actually occur within a separate function, but for the purposes of explanation I’m happy that this is a logical division of labour for the script.</p>

</aside>

<h5 id="leanpub-auto-adding-the-circle-to-the-graph">Adding the circle to the graph</h5>

<p>Adding the circle to the graph is actually fairly simple;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">4</code><code class="p">);</code>
</pre></div>

</figure>

<p>If you’ve followed any of the other examples in <em>D3 Tips and Tricks</em> there shouldn’t be any surprises here (well, perhaps assigning a class to the circle (<code>y</code>) could count as mildly unusual).</p>

<p>Except for one small thing….</p>

<p>We don’t place it anywhere on the graph! There is no x y coordinates and no translation of position. Nothing! Never fear. All we want to do at this stage is to create the element. In a few blocks of code time we will move the circle.</p>

<h5 id="leanpub-auto-set-the-area-to-capture-the-mouse-movements">Set the area to capture the mouse movements</h5>

<p>As we briefly covered earlier, the thing that makes this particular tooltip technique different is that we don’t hover over an element to highlight the tooltip. Instead we move the mouse into an area which is <em>relevant</em> to the tooltip and it appears.</p>

<p>And its all thanks to the following code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"all"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="kc">null</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mousemove"</code><code class="p">,</code> <code class="nx">mousemove</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here we’re adding a rectangle to the graph (<code>svg.append("rect")</code>) with the same height and width as our graph area (<code>.attr("width", width)</code> and <code>.attr("height", height)</code>) and we’re making sure that there’s no colour (fill) in it (<code>.style("fill", "none")</code>). Nothing too weird about all that.</p>

<p>Then we make sure that if any mouse events occur within the area that we capture them (<code>.style("pointer-events", "all")</code>). This is when things start to get interesting.</p>

<p>The first pointer event that we want to work with is <code>mouseover</code>;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="kc">null</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<p>This line of code tells the script that when the mouse moves over the area of the rectangle of the area of the graph the display properties of the <code>focus</code> elements (remember that we appended our circle to <code>focus</code> earlier) are set to <code>null</code>. This might sound like a bit of a strange thing to do, since what we want to do is to make sure that when the mouse moves over the graph we want the <code>focus</code> elements to be displayed. but by setting the <code>display</code> style to <code>null</code> the default value for <code>display</code> is enacted and this is <code>inline</code> which allows the elements to be rendered as normal. So why not use <code>inline</code> instead of <code>null</code>? Good question. I’ve tried it and it works without problem, but the original example that Mike Bostock used had the setting at <code>null</code> and I’ll make the assumption that Mike knows something that I don’t know about when to use <code>null</code> and when to use <code>inline</code>  for a <a href="http://www.w3schools.com/jsref/prop_style_display.asp">display style</a> (maybe some browser incompatibility issues?).</p>

<p>The reverse of making our <code>focus</code> element display display everything is being able to make it stop displaying everything. This is what happens in the next line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<p>Here, where the mouse moves off the area, the display properties for the <code>focus</code> element are turned off.</p>

<p>Lastly for this block, we need to capture the actions of the mouse as it moves on the graph area and move our tooltips as required. This is accomplished with the final line in the block…</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mousemove"</code><code class="p">,</code> <code class="nx">mousemove</code><code class="p">);</code>
</pre></div>

</figure>

<p>… where if the mouse moves we call the <code>mousemove</code> function.</p>

<h5 id="leanpub-auto-determining-which-date-will-be-highlighted">Determining which date will be highlighted</h5>

<p>Once the <code>mousemove</code> function is called is carries out the last two steps in our code. The first of which is the clever maths that determines which point in our graph has the tooltip applied to it.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="kd">var</code> <code class="nx">x0</code> <code class="o">=</code> <code class="nx">x</code><code class="p">.</code><code class="nx">invert</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">mouse</code><code class="p">(</code><code class="k">this</code><code class="p">)[</code><code class="mi">0</code><code class="p">]),</code>
		    <code class="nx">i</code> <code class="o">=</code> <code class="nx">bisectDate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">x0</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
		    <code class="nx">d0</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code> <code class="o">-</code> <code class="mi">1</code><code class="p">],</code>
		    <code class="nx">d1</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">],</code>
		    <code class="nx">d</code> <code class="o">=</code> <code class="nx">x0</code> <code class="o">-</code> <code class="nx">d0</code><code class="p">.</code><code class="nx">date</code> <code class="o">&gt;</code> <code class="nx">d1</code><code class="p">.</code><code class="nx">date</code> <code class="o">-</code> <code class="nx">x0</code> <code class="o">?</code> <code class="nx">d1</code> <code class="o">:</code> <code class="nx">d0</code><code class="p">;</code>
</pre></div>

</figure>

<p>The first line of this block is a dozy;</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="kd">var</code> <code class="nx">x0</code> <code class="o">=</code> <code class="nx">x</code><code class="p">.</code><code class="nx">invert</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">mouse</code><code class="p">(</code><code class="k">this</code><code class="p">)[</code><code class="mi">0</code><code class="p">]),</code>
</pre></div>

</figure>

<p>If we break it down the <code>d3.mouse(this)[0]</code> portion returns the x position on the screen of the mouse (<code>d3.mouse(this)[1]</code> would return the y position). Then the <code>x.invert</code> function is reversing the process that we use to map the domain (date) to range (position on screen). So it takes the position on the screen and converts it into an equivalent date!</p>

<aside class="information blurb">
    <p>For the adventurous amongst you, throw a <code>console.log(x0);</code> line into the <code>mousemove</code> function and check out the changing date/time as the cursor moves pixel by pixel (This will work for Google Chrome). Very cool.</p>

</aside>

<p>Then we use our <code>bisectDate</code> function that we declared earlier to find the index of our <code>data</code> array that is close to the mouse cursor.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		    <code class="nx">i</code> <code class="o">=</code> <code class="nx">bisectDate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">x0</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
</pre></div>

</figure>

<p>It takes our data array and the date corresponding to the position of or mouse cursor and returns the index number of the data array which has a date that is higher than the cursor position.</p>

<p>Then we declare arrays that are subsets of our data array;</p>

<figure class="code">
<div class="highlight"><pre><code></code>		    <code class="nx">d0</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code> <code class="o">-</code> <code class="mi">1</code><code class="p">],</code>
		    <code class="nx">d1</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">],</code>
</pre></div>

</figure>

<p><code>d0</code> is the combination of <code>date</code> and <code>close</code> that is in the data array at the index to the left of the cursor and <code>d1</code> is the combination of <code>date</code> and <code>close</code> that is in the data array at the index to the right of the cursor. In other words we now have two variables that know the value and date above and below the date that corresponds to the position of the cursor.</p>

<p>The final line in this segment declares a new array <code>d</code> that is represents the <code>date</code> and <code>close</code> combination that is closest to the cursor.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		    <code class="nx">d</code> <code class="o">=</code> <code class="nx">x0</code> <code class="o">-</code> <code class="nx">d0</code><code class="p">.</code><code class="nx">date</code> <code class="o">&gt;</code> <code class="nx">d1</code><code class="p">.</code><code class="nx">date</code> <code class="o">-</code> <code class="nx">x0</code> <code class="o">?</code> <code class="nx">d1</code> <code class="o">:</code> <code class="nx">d0</code><code class="p">;</code>
</pre></div>

</figure>

<p>It is using the magic JavaScript short hand for an <code>if</code> statement that is essentially saying if the distance between the mouse cursor and the <code>date</code> and <code>close</code> combination on the left is greater than the distance between the mouse cursor and the <code>date</code> and <code>close</code> combination on the right then <code>d</code> is an array of the <code>date</code> and <code>close</code> on the right of the cursor (<code>d1</code>). Otherwise <code>d</code> is an array of the <code>date</code> and <code>close</code> on the left of the cursor (<code>d0</code>).</p>

<p>This could be regarded as a fairly complicated little piece of code, but if you take the time to understand it, you will be surprised how elegant it appears. As we’ve seen before though, if you just want to believe that the d3.js magic is happening, that’s fine.</p>

<h5 id="leanpub-auto-move-the-circle-to-the-appropriate-position">Move the circle to the appropriate position</h5>

<p>The final block of code that we’ll check out takes the closest <code>date</code> / <code>close</code> combination that we’ve just worked out and moves the circle to that position;</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle.y"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>This is a pretty easy bit of code to follow. We select the circle (using the class <code>y</code> that we assigned to it earlier) and then move it using <code>translate</code> to the <code>date</code> / <code>close</code> position that we had just worked out was the closest.</p>

<p>Of course this is provision of the coordinates to the circle that we noticed was missing earlier in the code when we were appending it to the graph.</p>

<p>And there we have it. A simple circle positioned at the closest point to the mouse cursor when the cursor hovers over the graph.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fave-02.png" alt="Simple version of the favourite tooltip example">
  <figcaption>Simple version of the favourite tooltip example</figcaption>
</figure>


<p>If we hadn’t mentioned it earlier you might be thinking that this could possibly be the most complicated method for making most basic (read lame) tooltip ever. But you know there’s more right? Right….? Read on.</p>

<h4 id="leanpub-auto-complex-version">Complex version</h4>

<p>You’ve read to this point, so that’s a sign that you’re still interested. In that case, I recommend that you take a moment to check out the <a href="http://bl.ocks.org/d3noob/6eb506b129f585ce5c8a">live example</a> of the graph that I’m going to describe.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/fave-01.png" alt="More complicated favourite tooltip example">
  <figcaption>More complicated favourite tooltip example</figcaption>
</figure>


<p>Here’s a graph that when you move your mouse over it shows the closest intersection point on the graph with lines that extend the full width of the graph (great for comparing the level across the graph) and down to the x axis (to get a rough feel for the date). As well as this there is a subtle circle around the data point in question (as already explained in the previous section) and the actual date and value represented at the intersection point. As if that wasn’t enough there is a nice little drop shadow effect under the text so that no matter what the background is you can read it. Nice.</p>

<p>The full code for this example is available online at <a href="http://bl.ocks.org/d3noob/6eb506b129f585ce5c8a">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/6eb506b129f585ce5c8a">GitHub</a>. It is also available as the files ‘best-tooltip-coolio.html’ and ‘atad.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<h5 id="leanpub-auto-code--explanation">Code / Explanation</h5>

<p>Because the date at the tooltip needs to be formatted in a particular way we need to declare this appropriately;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">formatDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b"</code><code class="p">),</code>
</pre></div>

</figure>

<p>Other than that everything is pretty normal until we get to the part where we start adding elements to our <code>focus</code> group (you remember we had the circle before? Now we’re adding additional elements.).</p>

<figure class="code">
<div class="highlight"><pre><code></code>   <code class="c1">// append the x line</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="s2">"3,3"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mf">0.5</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code>

    <code class="c1">// append the y line</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="s2">"3,3"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mf">0.5</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="nx">width</code><code class="p">);</code>

    <code class="c1">// append the circle at the intersection</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">4</code><code class="p">);</code>

    <code class="c1">// place the value at the intersection</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y1"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"white"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="s2">"3.5px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mf">0.8</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"-.3em"</code><code class="p">);</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y2"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"-.3em"</code><code class="p">);</code>

    <code class="c1">// place the date at the intersection</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y3"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"white"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="s2">"3.5px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mf">0.8</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">);</code>
    <code class="nx">focus</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y4"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here you can see we’re adding the x (horizontal) line and the y (vertical) line as well as the date and text values. Notice on the text values, there is a white drop shadow added first and then the text over the top. Another thing to note is that just like the position information, we don’t actually put the text in here, this is simple a ‘placeholder’ for the element.</p>

<p>Then all we need to do is move all the new elements to the correct position and add the changing text where appropriate;</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle.y"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.y1"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code>

		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.y2"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code>

		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.y3"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">formatDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">));</code>

		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.y4"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">formatDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">));</code>

		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".x"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
		               <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">));</code>

		<code class="nx">focus</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".y"</code><code class="p">)</code>
		    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
		          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">width</code> <code class="o">*</code> <code class="o">-</code><code class="mi">1</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>
		                         <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
		               <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">width</code><code class="p">);</code>
</pre></div>

</figure>

<p>There’s no big surprises here. Just an extension of what we accomplished with the circle earlier. The only part that looks semi-interesting is some of the application of the positioning of the x and y lines and this is more because of the points at which the lines start and finish.</p>

<p>Now this is unlikely to be the end solution for most people, but at least there are plenty of examples of different elements in there to play with and experiment on.</p>

<p>Enjoy!</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-exploring-event-data-by-combination-scatter-plot-and-interactive-line-graphs">Exploring Event Data by Combination Scatter Plot and Interactive Line Graphs</h3>

<h4 id="leanpub-auto-purpose-4">Purpose</h4>

<p>In the process of implementing a method of measuring and displaying the passage of a cat through a cat-door (as described in the book ‘<a href="https://leanpub.com/RPiMRE">Raspberry Pi: Measure, Record, Explore</a>’) I built a graph that showed events indicated by both date and time on separate axes. It was then that I figured that this would be useful for exploring event data or data that exists as a series of date/time stamps that signify a particular ‘thing as having occurred. In the cat door example it was the use of the door by the cat, but this is applicable to a huge range of data sets.</p>

<p>One that I thought of straight away was the dates and times that people downloaded this book.  Leanpub has an API for accessing the history of book activity and I was able to download it and store it in a database for examination.</p>

<p>Ultimately what I developed was a scatter plot that shows the date of the events on the X axis and the time of the events on the Y axis. This was augmented by two line graphs that showed the accumulated sums of each axis on their respective sides.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scattertime-01.png" alt="Data Event Exploration">
  <figcaption>Data Event Exploration</figcaption>
</figure>


<p>The full code for this example is available online at <a href="http://bl.ocks.org/d3noob/a0cbcddc6bf0eb9569fe">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/a0cbcddc6bf0eb9569fe">GitHub</a>. It is also available as the files ‘book-downloads.html’ and ‘downloads.zip’ (which contains downloads.json (it’s zipped up because otherwise it’s a bit too large for Leanpub)) as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<p>To make the information slightly more accessible when the user hovers their mouse over the scatter plot there is an intersection of the position extrapolated to show the relationship to the other graphs and it presents the appropriate value of date, time and number downloaded by date and time.</p>

<p>This graph is a relatively complex combination of a range of different techniques presented in the book, including wrangling and nesting of data, combination of multiple graphs and the use of mouse movement to display tooltips and additional data.</p>

<h4 id="leanpub-auto-the-code-9">The Code</h4>

<p>The code is extremely lengthy, so in lieu of placing it in the book it can be found on <a href="http://bl.ocks.org/d3noob/a0cbcddc6bf0eb9569fe">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/a0cbcddc6bf0eb9569fe">Github</a>. It is liberally commented to assist readers and I will describe particular sections of the code below and hopefully that will help more where required.</p>

<h5 id="leanpub-auto-wrangling-the-data">Wrangling the data</h5>

<p>The graph uses four sets of data.</p>

<ol class="numeric">
  <li>The raw event data (an array called <code>events</code>)</li>
  <li>The scatter plot data (an array called <code>data</code>)</li>
  <li>The date graph data (an array called <code>dataDate</code>)</li>
  <li>The time graph data (an array called <code>dataTime</code>)</li>
</ol>

<p>The raw event data is ingested from an external JSON file using the standard <code>d3.json</code> call.</p>

<p>The data itself is simply a collection of dates.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 09:10:59"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 09:17:37"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 09:48:48"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 15:01:59"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 18:11:44"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 18:47:05"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 18:47:23"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 19:55:53"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-24 22:37:39"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-25 01:22:48"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-25 06:37:38"</code><code class="p">},</code>
<code class="p">{</code><code class="s2">"dtg"</code><code class="o">:</code><code class="s2">"2013-01-25 08:28:20"</code><code class="p">},</code>
</pre></div>

</figure>

<p>Each date represents the time that a book was downloaded.</p>

<p>Once loaded we run a <code>forEach</code> over the file to put it in a format for manipulation into the remaining three data sets.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="c1">// parse and format all the event data</code>
    <code class="nx">events</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">)</code><code class="o">+</code><code class="s1">'0:00'</code><code class="p">;</code> <code class="c1">// get the 10 minute block</code>
        <code class="nx">dtgSplit</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s2">" "</code><code class="p">);</code>      <code class="c1">// split on the space</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">dtgSplit</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>             <code class="c1">// get the date seperatly</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">time</code> <code class="o">=</code> <code class="nx">dtgSplit</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>             <code class="c1">// format the time</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">number_downloaded</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>          <code class="c1">// Number of downloads</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>The first thing we do is to <code>slice</code> off the last four characters of the <code>dtg</code> string and replace them with <code>0:00</code>. This leave us with a set of <code>dtg</code> values that are only represented by the 10 minute window in which they were downloaded.</p>

<p>We then <code>split</code> the <code>dtg</code> string on the space that separates the date and the time and we designate one half <code>date</code> and the other half <code>time</code>.</p>

<p>Lastly we represent the number of books downloaded for each event as 1 (this helps us sum them up later).</p>

<p>Using the <code>events</code> data we create the data-set for the scatter plot (<code>data</code>) by nesting the information on the 10 minute <code>dtg</code> value of date/time and by summing the number of downloads;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;})</code>
        <code class="p">.</code><code class="nx">rollup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sum</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">g</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">g</code><code class="p">.</code><code class="nx">number_downloaded</code><code class="p">;</code> <code class="p">});</code>
            <code class="p">})</code>
        <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">events</code><code class="p">);</code>
</pre></div>

</figure>

<p>We carry out a similar process for the date…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">dataDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;})</code>
        <code class="p">.</code><code class="nx">rollup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sum</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">g</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">g</code><code class="p">.</code><code class="nx">number_downloaded</code><code class="p">;</code> <code class="p">});</code>
            <code class="p">})</code>
        <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">events</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and the time;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">dataTime</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">time</code><code class="p">;})</code>
        <code class="p">.</code><code class="nx">sortKeys</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">rollup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sum</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="kd">function</code><code class="p">(</code><code class="nx">g</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">g</code><code class="p">.</code><code class="nx">number_downloaded</code><code class="p">;</code> <code class="p">});</code>
            <code class="p">})</code>
        <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">events</code><code class="p">);</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-sizing-everything-up">Sizing Everything Up</h5>

<p>The size of the graph is determined by a number of fixed variables which are fairly self explanatory;</p>

<ul>
  <li>
<code>scatterplotHeight</code> (which is also the height of the time graph)</li>
  <li><code>dateGraphHeight</code></li>
  <li><code>timeGraphWidth</code></li>
</ul>

<p>But we need to let the width of the scatter plot (and the date graph) be a function of the number of days that have been collected. This variable is handled by;</p>

<ul>
  <li><code>scatterplotWidth</code></li>
</ul>

<p>This set-up is handled in the following block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">oneDay</code> <code class="o">=</code> <code class="mi">24</code><code class="o">*</code><code class="mi">60</code><code class="o">*</code><code class="mi">60</code><code class="o">*</code><code class="mi">1000</code><code class="p">;</code> <code class="c1">// hours*minutes*seconds*milliseconds</code>
    <code class="kd">var</code> <code class="nx">dateStart</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">});</code>
    <code class="kd">var</code> <code class="nx">dateFinish</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">});</code>
    <code class="kd">var</code> <code class="nx">numberDays</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">abs</code><code class="p">((</code><code class="nx">dateStart</code><code class="p">.</code><code class="nx">getTime</code><code class="p">()</code> <code class="o">-</code>
                               <code class="nx">dateFinish</code><code class="p">.</code><code class="nx">getTime</code><code class="p">())</code><code class="o">/</code><code class="p">(</code><code class="nx">oneDay</code><code class="p">)));</code>

    <code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
        <code class="nx">scatterplotHeight</code> <code class="o">=</code> <code class="mi">520</code><code class="p">,</code>
        <code class="nx">scatterplotWidth</code> <code class="o">=</code> <code class="nx">numberDays</code> <code class="o">*</code> <code class="mf">1.5</code><code class="p">,</code>
        <code class="nx">dateGraphHeight</code> <code class="o">=</code> <code class="mi">220</code><code class="p">,</code>
        <code class="nx">timeGraphWidth</code> <code class="o">=</code> <code class="mi">220</code><code class="p">;</code>
</pre></div>

</figure>

<p>The overall size of the graphic (<code>height</code> and <code>width</code>) is therefore a combination of these variables;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="nx">scatterplotHeight</code> <code class="o">+</code> <code class="nx">dateGraphHeight</code><code class="p">,</code>
        <code class="nx">width</code> <code class="o">=</code> <code class="nx">scatterplotWidth</code> <code class="o">+</code> <code class="nx">timeGraphWidth</code><code class="p">;</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-the-scatter-plot">The Scatter Plot</h5>

<p>There is no real surprise with the scatter plot itself. The only thing slightly unusual is the use of a time scale for both the X and Y axes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">scatterplotWidth</code><code class="p">]);</code>
    <code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">scatterplotHeight</code><code class="p">]);</code>
</pre></div>

</figure>

<p>When the circles are drawn, the size of the circle is determined by the radius, which is the number of downloads multiplied by 1.5. I know that this is a bit of a visualization ‘no-no’ because the area of the circle should be representative of the number, not the radius, but I tried it both ways and to my simple way of viewing the data, the radius adjustment provided the best comparison.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".dot"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"dot"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">number_downloaded</code><code class="o">*</code><code class="mf">1.5</code><code class="p">;</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mf">0.3</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"#e31a1c"</code> <code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">time</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>I know that this is a topic of some academic debate, and it is fascinating, so here are both results for comparison;</p>

<div class="page-break"></div>

<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scattertime-02.png" alt="Circle Area Representing Downloads">
  <figcaption>Circle Area Representing Downloads</figcaption>
</figure>



<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/scattertime-03.png" alt="Circle Radius Representing Downloads">
  <figcaption>Circle Radius Representing Downloads</figcaption>
</figure>


<h5 id="leanpub-auto-date-and-time-graphs">Date and Time Graphs</h5>

<p>Both of these graphs are fairly routine. The time graph has the X and Y axes reversed from what would be ordinarily expected, but otherwise not much else to write home about.</p>

<h5 id="leanpub-auto-mouse-movement-information-display">Mouse Movement Information Display</h5>

<p>This portion of the graph is an expansion of the ‘Favourite tool tip’ method from the previous section in this chapter. We expand the number of elements to update dynamically to about 10. All of which are designated with their own <code>class</code>.</p>

<p>We append the rectangle to capture the mouse movement over the scatterplot;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">scatterplotWidth</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">scatterplotHeight</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"all"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="kc">null</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">focus</code><code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"display"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mousemove"</code><code class="p">,</code> <code class="nx">mousemove</code><code class="p">);</code>
</pre></div>

</figure>

<p>We capture the position of the mouse and convert it to figures we can use to compare to our data;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">function</code> <code class="nx">mousemove</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">xpos</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">mouse</code><code class="p">(</code><code class="k">this</code><code class="p">)[</code><code class="mi">0</code><code class="p">],</code>
            <code class="nx">x0</code> <code class="o">=</code> <code class="nx">x</code><code class="p">.</code><code class="nx">invert</code><code class="p">(</code><code class="nx">xpos</code><code class="p">),</code>
            <code class="nx">y0</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">mouse</code><code class="p">(</code><code class="k">this</code><code class="p">)[</code><code class="mi">1</code><code class="p">],</code>
            <code class="nx">y1</code> <code class="o">=</code> <code class="nx">y</code><code class="p">.</code><code class="nx">invert</code><code class="p">(</code><code class="nx">y0</code><code class="p">),</code>
            <code class="nx">date1</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">mouse</code><code class="p">(</code><code class="k">this</code><code class="p">)[</code><code class="mi">0</code><code class="p">];</code>
</pre></div>

</figure>

<p>And then we place our dynamic text and lines with our <code>focus.select</code> statements.</p>

<h5 id="leanpub-auto-labelling">Labelling</h5>

<p>The last order of business is to place some labels.</p>

<p>The location of labelling in this example is an interesting problem in itself. I’m personally torn between the desire to maintain simplicity and to ensure clarity. Hopefully what I have is enough to satisfy both requirements, but as always, each user and requirement will differ, so label as desired.</p>

<p>If there are additional parts of the code that you would like explained, please feel free to get in touch.</p>

<div class="page-break"></div>
<h3 id="difference">Difference Chart: Science vs Style.</h3>

<p>Dear readers, please forgive me for including this example in <em>D3 Tips and Tricks</em>. While it demonstrates a really cool graphing technique, I have chosen to apply it to a topic that has a potential to raise a couple of sets of eyebrows in the form of Messrs Roger Peng and Jeff Leek. Both work at the Johns Hopkins Bloomberg School of Public Health where  Roger is an  Associate Professor of Biostatistics, and Jeff is an Associate Professor of Biostatistics and Oncology.</p>

<p>While both are doing amazing work to improve peoples health and well-being (amongst other things), both are also authors of highly successful books published by Leanpub. In particular Roger has written <a href="https://leanpub.com/rprogramming">R Programming for Data Science</a> and <a href="https://leanpub.com/exdata">Exploratory Data Analysis with R</a> while Jeff has penned <a href="https://leanpub.com/datastyle">The Elements of Data Analytic Style</a>. As we could anticipate, there is a possibility that there is something of a <a href="https://twitter.com/d3noob/status/611227825685725184/photo/1">competitive element</a> to publishing for both gentlemen as they see the the number of downloads of their books climb ever higher.</p>

<p>While I would hate to promote an increase to these tensions, The opportunity was too attractive given that I had access to some data on the number of downloads that each of the books had been achieving and I really wanted to write about difference charts using d3.js (and the method of sourcing the data for the book <a href="https://leanpub.com/RPiMRE">Raspberry Pi: Measure, Record, Explore</a>).</p>

<p>So at the risk of providing some form of offence to these fine gentlemen or inciting an increased rivalry, I have forged ahead and hopefully the worst that will happen is that someone interested in d3.js will also find some interesting reading in <em>R Programming for Data Science</em>, <em>Exploratory Data Analysis with R</em> or <em>The Elements of Data Analytic Style</em>. Ultimately we should be left with a graph that will look something like this;</p>


<figure class="image center" style="width: 90%;">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-01.png" alt="Science vs Style - Daily Leanpub Book Sales" style="width: 100%;">
  <figcaption>Science vs Style - Daily Leanpub Book Sales</figcaption>
</figure>


<h4 id="leanpub-auto-purpose-5">Purpose</h4>

<p>A difference chart is a variation on a <a href="http://www.informit.com/articles/article.aspx?p=709139&amp;seqNum=5">bivariate area chart</a>. This is a line chart that includes two lines that are interlinked by filling the space between the lines. A difference chart as demonstrated in the example <a href="http://bl.ocks.org/mbostock/3894205">here</a> by Mike Bostock is able to highlight the differences between the lines by filling the area between them with different colours depending on which line is the greater value.</p>

<p>As Mike points out in his example, this technique harks back at least as far as <a href="https://en.wikipedia.org/wiki/William_Playfair">William Playfair</a> when he was describing the time series of exports and imports of Denmark and Norway in 1786.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/Playfair_TimeSeries-2.png" alt="William Playfair's Time Series of Exports and Imports of Denmark and Norway">
  <figcaption>William Playfair’s Time Series of Exports and Imports of Denmark and Norway</figcaption>
</figure>


<p>All that remains is for us to work out how d3.js can help us out by doing the job programmatically. The example that I use here is based on that of <a href="http://bl.ocks.org/mbostock/3894205">Mike Bostock’s</a>, with the addition of a few niceties in the form of a legend, a title, and some minor changes.</p>

<p>We will start with a simple example of the code and we will add blocks to finally arrive at the example with Legends and title.</p>

<h4 id="leanpub-auto-the-code-10">The Code</h4>

<p>The following is the code for the simple difference chart. A live version is available online at <a href="http://bl.ocks.org/d3noob/8beea1d918ff4104f9ab">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/8beea1d918ff4104f9ab">GitHub</a>. It is also available as the files ‘diff-basic.html’ and ‘downloads.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

<code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;}</code>

<code class="nt">text</code><code class="nc">.shadow</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">9</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.x.axis</code> <code class="nt">path</code> <code class="p">{</code> <code class="nb">display</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code> <code class="p">}</code>

<code class="nc">.area.above</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">rgb</code><code class="p">(</code><code class="m">252</code><code class="o">,</code><code class="m">141</code><code class="o">,</code><code class="m">89</code><code class="p">);</code> <code class="p">}</code>
<code class="nc">.area.below</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">rgb</code><code class="p">(</code><code class="m">145</code><code class="o">,</code><code class="m">207</code><code class="o">,</code><code class="m">96</code><code class="p">);</code> <code class="p">}</code>

<code class="nc">.line</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1.5px</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">title</code> <code class="o">=</code> <code class="s2">"Science vs Style - Daily Leanpub Book Sales"</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">50</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">parsedtg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m-%d"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">).</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">).</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">lineScience</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Science"</code><code class="p">]);</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">lineStyle</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Science"</code><code class="p">]);</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
        <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"downloads.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">dataNest</code><code class="p">)</code> <code class="p">{</code>

  <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code> <code class="o">=</code> <code class="nx">parsedtg</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date_entered</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">downloaded</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">downloaded</code><code class="p">;</code>
  <code class="p">});</code>

  <code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;})</code>
      <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">dataNest</code><code class="p">);</code>

  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="s1">'dtg'</code><code class="p">];</code>
      <code class="nx">d</code><code class="p">[</code><code class="s2">"Science"</code><code class="p">]</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="s1">'downloaded'</code><code class="p">];</code>
      <code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">[</code><code class="mi">1</code><code class="p">][</code><code class="s1">'downloaded'</code><code class="p">];</code>
  <code class="p">});</code>

  <code class="k">for</code><code class="p">(</code><code class="nx">i</code><code class="o">=</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="o">-</code><code class="mi">1</code><code class="p">;</code><code class="nx">i</code><code class="o">&gt;</code><code class="mi">0</code><code class="p">;</code><code class="nx">i</code><code class="o">--</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Science</code>   <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Science</code>  <code class="o">-</code><code class="nx">data</code><code class="p">[(</code><code class="nx">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)].</code><code class="nx">Science</code> <code class="p">;</code>
          <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Style</code>     <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Style</code>    <code class="o">-</code><code class="nx">data</code><code class="p">[(</code><code class="nx">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)].</code><code class="nx">Style</code> <code class="p">;</code>
   <code class="p">}</code>

  <code class="nx">data</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code> <code class="c1">// Removes the first element in the array</code>

    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code>
<code class="c1">//      d3.min(data, function(d) {</code>
<code class="c1">//          return Math.min(d["Science"], d["Style"]); }),</code>
<code class="c1">//      d3.max(data, function(d) {</code>
<code class="c1">//          return Math.max(d["Science"], d["Style"]); })</code>
      <code class="mi">0</code><code class="p">,</code><code class="mi">1400</code>
    <code class="p">]);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"clip-above"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="mi">0</code><code class="p">));</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"clip-below"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">));</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area above"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#clip-above)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">}));</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area below"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#clip-below)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">}));</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"darkgreen"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">lineScience</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">lineStyle</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>A sample of the associated csv file (downloads.csv) is formatted as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date_entered,downloaded,book_name
2015-04-19,5481,R Programming for Data Science
2015-04-19,23751,The Elements of Data Analytic Style
2015-04-20,5691,R Programming for Data Science
2015-04-20,23782,The Elements of Data Analytic Style
2015-04-21,6379,R Programming for Data Science
2015-04-21,23820,The Elements of Data Analytic Style
2015-04-22,7281,R Programming for Data Science
2015-04-22,23857,The Elements of Data Analytic Style
2015-04-23,7554,R Programming for Data Science
2015-04-23,23881,The Elements of Data Analytic Style
2015-04-24,9331,R Programming for Data Science
2015-04-24,23932,The Elements of Data Analytic Style
</pre></div>

</figure>

<h4 id="leanpub-auto-description-3">Description</h4>

<p>The graph has some portions that are common to the simple line graph example.</p>

<p>We start the HTML file, load some styling for the upcoming elements, set up the margins, time formatting scales, ranges and axes.</p>

<p>Because the graph is composed of two lines we need to declare two separate line functions;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">lineScience</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Science"</code><code class="p">]);</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">lineStyle</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>To fill an area we declare an area function using one of the lines as the baseline (<code>y1</code>) and when it comes time to fill the area later in the script we declare <code>y0</code> separately to define the area to be filled as an intersection of two paths.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">interpolate</code><code class="p">(</code><code class="s2">"basis"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Science"</code><code class="p">]);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>In this instance we are using the green ‘Science’ line as the <code>y1</code> line.</p>

<p>The svg area is then set up using the height, width and margin values and we load our csv files with our number of downloads for each book. We then carry out a standard <code>forEach</code> to ensure that the time and numerical values are formatted correctly.</p>

<h5 id="leanpub-auto-nesting-the-data-1">Nesting the data</h5>

<p>The data that we are starting with is formatted in a way that we could reasonably expect data to be available in this instance where a value is saved for distinct elements on an element by element basis. This style of recording data makes it easy to add new elements into the data stream or a database rather than relying on having them as discrete columns.</p>

<figure class="code">
<div class="highlight"><pre><code></code>date_entered,downloaded,book_name
2015-04-19,5481,R Programming for Data Science
2015-04-19,23751,The Elements of Data Analytic Style
2015-04-20,5691,R Programming for Data Science
2015-04-20,23782,The Elements of Data Analytic Style
2015-04-21,6379,R Programming for Data Science
2015-04-21,23820,The Elements of Data Analytic Style
</pre></div>

</figure>

<p>In this case, we will need to ‘pivot’ the data to produce a multi-column representation where we have a single row for each date, and the number of downloads for each book as separate columns as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date_entered,R Programming for Data Science,The Elements of Data Analytic Sty\
le
2015-04-19,5481,23751
2015-04-20,5691,23782
2015-04-21,6379,23820
</pre></div>

</figure>

<p>This can be achieved using the d3 nest function.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;})</code>
      <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">dataNest</code><code class="p">);</code>
</pre></div>

</figure>

<p>We declare our new array’s name as <code>data</code> and we initiate the <code>nest</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
</pre></div>

</figure>

<p>We assign the <code>key</code> for our new array as <code>dtg</code>. A ‘key’ is like a way of saying “<em>This is the thing we will be grouping on</em>”. In other words our resultant array will have a single entry for each unique date (<code>dtg</code>) which will have the values of the number of downloaded books associated with it.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;})</code>
</pre></div>

</figure>

<p>Then we tell the nest function which data array we will be using for our source of data.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">}).</code><code class="nx">entries</code><code class="p">(</code><code class="nx">dataNest</code><code class="p">);</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-wrangle-the-data">Wrangle the data</h5>

<p>Once we have our pivoted data we can format it in a way that will suit the code for the visualisation. This involves storing the values for the ‘Science’ and ‘Style’ variables as part of a named index.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="s1">'dtg'</code><code class="p">];</code>
      <code class="nx">d</code><code class="p">[</code><code class="s2">"Science"</code><code class="p">]</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="s1">'downloaded'</code><code class="p">];</code>
      <code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">[</code><code class="mi">1</code><code class="p">][</code><code class="s1">'downloaded'</code><code class="p">];</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>We then loop through the ‘Science’ and ‘Style’ array to convert the incrementing value of the total number of downloads into a value of the number that have been downloaded each day;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="k">for</code><code class="p">(</code><code class="nx">i</code><code class="o">=</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="o">-</code><code class="mi">1</code><code class="p">;</code><code class="nx">i</code><code class="o">&gt;</code><code class="mi">0</code><code class="p">;</code><code class="nx">i</code><code class="o">--</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Science</code>   <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Science</code>  <code class="o">-</code><code class="nx">data</code><code class="p">[(</code><code class="nx">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)].</code><code class="nx">Science</code> <code class="p">;</code>
          <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Style</code>     <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">Style</code>    <code class="o">-</code><code class="nx">data</code><code class="p">[(</code><code class="nx">i</code><code class="o">-</code><code class="mi">1</code><code class="p">)].</code><code class="nx">Style</code> <code class="p">;</code>
   <code class="p">}</code>
</pre></div>

</figure>

<p>Finally because we are adjusting from total downloaded to daily values we are left with an orphan value that we need to remove from the front of the array;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">data</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-cheating-with-the-domain">Cheating with the domain</h5>

<p>The observant d3.js reader will have noticed that the setting of the <code>y</code> domain has a large section commented out;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code>
<code class="c1">//      d3.min(data, function(d) {</code>
<code class="c1">//          return Math.min(d["Science"], d["Style"]); }),</code>
<code class="c1">//      d3.max(data, function(d) {</code>
<code class="c1">//          return Math.max(d["Science"], d["Style"]); })</code>
      <code class="mi">0</code><code class="p">,</code><code class="mi">1400</code>
    <code class="p">]);</code>
</pre></div>

</figure>

<p>That’s because I want to be able to provide an ideal way for the graph to represent the data in an appropriate range, but because we are using the <a href="#smoothing"><code>basis</code> smoothing</a> modifier, and the data is ‘peaky’, there is a tendency for the y scale to be fairy broad and the resultant graph looks a little lost;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-02.png" alt="Using automatic range">
  <figcaption>Using automatic range</figcaption>
</figure>


<p>Alternatively, we could remove the smoothing and let the true data be shown;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-03.png" alt="Using automatic range and removing the basis smoothing">
  <figcaption>Using automatic range and removing the basis smoothing</figcaption>
</figure>


<p>It should be argued that this is a truer representation of the data, but in this case I feel comfortable sacrificing accuracy for aesthetics (what have I become?).</p>

<p>Therefore, the domain for the <code>y</code> axis is set manually to between 0 and 1400, but feel free to remove that at the point when you introduce your own data :-).</p>

<h5 id="leanpub-auto-data-vs-datum">
<code>data</code> vs <code>datum</code>
</h5>

<p>One small line gets its own section. That line is;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
</pre></div>

</figure>

<p>A casual d3.js user could be forgiven for thinking that this doesn’t seem too fearsome a line, but it has hidden depths.</p>

<p>As Mike Bostock explains <a href="http://bost.ocks.org/mike/selection/#data">here</a>, if we want to bind data to elements as a group we would be <code>*.data</code>, but if we want to bind that data to individual elements, we should use <code>*.datum</code>.</p>

<p>It’s a function of how the data is stored. If there is an expectation that the data will be dynamic then <code>data</code> is the way to go since it has the feature of preparing enter and exit selections. If the data is static (it won’t be changing) then <code>datum</code> is the way to go.</p>

<p>In our case we are assigning data to individual elements and as a result we will be using <code>datum</code>.</p>

<h5 id="leanpub-auto-setting-up-the-clippaths">Setting up the <code>clipPath</code>s</h5>

<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/clipPath"><code>clipPath</code></a> operator is used to define an area that is used to create a shape by intersecting one area with another.</p>

<p>In our case we are going to set up two clip paths. One is the area above the green ‘Science’ line (which we defined earlier as being the <code>y1</code> component of an area selection);</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-04.png" alt="the 'clip-above' clip path">
  <figcaption>the ‘clip-above’ clip path</figcaption>
</figure>


<p>This is declared via this portion of the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"clip-above"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="mi">0</code><code class="p">));</code>
</pre></div>

</figure>

<p>Then we set up the clip path that will exist for the area below the green ‘Science’ line ;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-05.png" alt="The 'clip-below' clip path">
  <figcaption>The ‘clip-below’ clip path</figcaption>
</figure>


<p>This is declared via this portion of the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"clip-below"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">));</code>
</pre></div>

</figure>

<p>Each of these paths has an ‘id’ which can be subsequently used by the following code.</p>

<h5 id="leanpub-auto-clipping-and-adding-the-areas">Clipping and adding the areas</h5>

<p>Now we come to clipping our shape and filling it with the appropriate colour.</p>

<p>We do this by having a shape that represents the area between the two lines and applying our clip path for the values above and below our reference line (the green ‘Science’ line). Where the two intersect, we fill it with the appropriate colour. The code to fill the area above the reference line is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area above"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#clip-above)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">}));</code>
</pre></div>

</figure>

<p>Here we have two lines that are defining the shape between the two science and style lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">....</code>
        <code class="p">....</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">}));</code>
</pre></div>

</figure>

<p>If we were to look at the shape that this produces it would look as follows (greyed out for highlighting);</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-06.png" alt="The shape between the science and style lines">
  <figcaption>The shape between the science and style lines</figcaption>
</figure>


<p>We apply a class to the shape so that is filled with the colour that we want;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area above"</code><code class="p">)</code>
</pre></div>

</figure>

<p>.. and apply the clip path so that only the areas that intersect the two shapes are filled with the appropriate colour;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#clip-above)"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Here the intersection of those two shapes is shown as pink;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-07.png" alt="The intersection of the shapes">
  <figcaption>The intersection of the shapes</figcaption>
</figure>


<p>Then we do the same for the area below;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area below"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#clip-below)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">}));</code>
</pre></div>

</figure>

<p>With the corresponding areas showing the intersection of the two shapes coloured differently;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-08.png" alt="The intersection of the shapes">
  <figcaption>The intersection of the shapes</figcaption>
</figure>


<h5 id="leanpub-auto-draw-the-lines-and-the-axes">Draw the lines and the axes</h5>

<p>The final part of our basic difference chart is to draw in the lines over the top so that they are highlighted and to add in the axes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"darkgreen"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">lineScience</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">lineStyle</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
</pre></div>

</figure>

<p>Et viola! we have our difference chart!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-09.png" alt="The basic difference chart">
  <figcaption>The basic difference chart</figcaption>
</figure>


<p>As mentioned earlier, the code for the simple difference chart is available online at <a href="http://bl.ocks.org/d3noob/8beea1d918ff4104f9ab">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/8beea1d918ff4104f9ab">GitHub</a>. It is also available as the files ‘diff-basic.html’ and ‘downloads.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<h4 id="leanpub-auto-adding-a-bit-more-to-our-difference-chart">Adding a bit more to our difference chart.</h4>

<p>The chart itself is a thing of beauty, but given the subject matter (it’s describing two books after all) we should include a bit more information on what it is we’re looking at and provide some links so that a fascinated viewer of the graphs can read the books!</p>

<h5 id="leanpub-auto-add-a-y-axis-label">Add a Y axis label</h5>

<p>Because it’s not immediately obvious what we’re looking at on the Y axis we should add in a nice subtle label on the Y axis;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Daily Downloads from Leanpub"</code><code class="p">);</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-add-a-title">Add a title</h5>

<p>Every graph should have a title. The following code adds this to the top(ish) centre of the chart and provides a white drop-shadow for readability;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="c1">// ******* Title Block ********</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> <code class="c1">// Title shadow</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"30px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"shadow"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">title</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> <code class="c1">// Title</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"30px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">title</code><code class="p">);</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-adding-the-legend-1">Adding the legend</h5>

<p>A respectable legend in this case should provide visual context of what it is describing in relation to the graph (by way of colour) and should actually name the book. We can also go a little bit further and provide a link to the books in the legend so that potential readers can access them easily.</p>

<p>Firstly the rectangles filled with the right colour, sized appropriately and arranged just right;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">block</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>   <code class="c1">// rectangle width and position</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> <code class="c1">// Style Legend Rectangle</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">((</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">-</code><code class="p">(</code><code class="nx">block</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code><code class="o">+</code><code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">block</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="s2">"25"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area above"</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> <code class="c1">// Science Legend Rectangle</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">((</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="o">-</code><code class="p">(</code><code class="nx">block</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code><code class="o">+</code><code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">block</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="s2">"25"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area below"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we add the text (with a drop-shadow) and a link;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> <code class="c1">// Style Legend Text shadow</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">((</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code><code class="o">+</code><code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"18px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"shadow"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"The Elements of Data Analytic Style"</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> <code class="c1">// Science Legend Text shadow</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">((</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code><code class="o">+</code><code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"18px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"shadow"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"R Programming for Data Science"</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"https://leanpub.com/datastyle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> <code class="c1">// Style Legend Text</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">((</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code><code class="o">+</code><code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"18px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"The Elements of Data Analytic Style"</code><code class="p">);</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"https://leanpub.com/rprogramming"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> <code class="c1">// Science Legend Text</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">((</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code><code class="o">+</code><code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"18px"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"R Programming for Data Science"</code><code class="p">);</code>
</pre></div>

</figure>

<p>I’ll be the first to admit that this could be done more efficiently with some styling via css, but then it would leave nothing for the reader to try :-).</p>

<h5 id="leanpub-auto-link-the-areas">Link the areas</h5>

<p>As a last touch we can include the links to the respective books in the shading for the graph itself;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"https://leanpub.com/datastyle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area above"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#clip-above)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">}));</code>

    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"https://leanpub.com/rprogramming"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area below"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#clip-below)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s2">"Style"</code><code class="p">]);</code> <code class="p">}));</code>
</pre></div>

</figure>

<p>Perhaps not strictly required, but a nice touch none the less.</p>

<h5 id="leanpub-auto-the-final-result">The final result</h5>

<p>And here it is;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/difference-10.png" alt="The full difference chart">
  <figcaption>The full difference chart</figcaption>
</figure>


<p>The code for the full difference chart is available online at <a href="http://bl.ocks.org/d3noob/f6d8588a0aa3a7503f57">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/f6d8588a0aa3a7503f57">GitHub</a>. It is also available as the files ‘diff-full.html’ and ‘downloads.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/D3-Tips-and-Tricks">download the book from Leanpub</a>.</p>

<div class="page-break"></div>
<h2 id="leanpub-auto-crossfilter-dcjs-and-d3js-for-data-discovery">Crossfilter, dc.js and d3.js for Data Discovery</h2>

<p>The ability to interact with visual data is the third step on the road to data nirvana in my humble opinion. </p>

<ul>
  <li>Step 1: Raw data</li>
  <li>Step 2: Visualize data</li>
  <li>Step 3: Interact with data</li>
</ul>

<p>But I think that there might be a 4th step where data is a more fluid construct. Where the influences of interaction have a more profound impact on how information is presented and perceived. I think that the visualization tools that we’re going to explore in this chapter take that 4th step.</p>

<ul>
  <li>Step 4: Data immersion</li>
</ul>

<p>The tools we’re going to use are not the only way that we can achieve the effect of immersion, but they are simple enough for me to use and they incorporate d3.js at their core.</p>

<h3 id="leanpub-auto-introduction-to-crossfilter">Introduction to Crossfilter</h3>

<p>Crossfilter is a JavaScript library for exploring large datasets that include many variables in the browser. It supports extremely fast interactions with concurrent views and was built to power analytics for <a href="https://squareup.com/register">Square Register</a> so that online merchants can slice and dice their payment history fluidly. It was developed for <a href="https://squareup.com/">Square</a> by (amongst other people) the ever tireless Mike Bostock and was released under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache Licence</a>. </p>

<p>Crossfilter provides a map-reduce function to data using ‘dimensions’ and ‘groups’. Map-reduce is an interesting concept itself and it’s useful to understand it in a basic form to understand crossfilter better.</p>

<h4 id="leanpub-auto-map-reduce">Map-reduce</h4>

<p><a href="https://en.wikipedia.org/wiki/MapReduce">Wikipedia tells us</a> that “<em>MapReduce is a programming model for processing large data sets with a parallel, distributed algorithm on a cluster</em>”. Loosely translated into language I can understand, I think of a large data set having one dimension ‘mapped’ or loaded into memory ready to be worked on. In practical terms, this could be an individual column of data from a larger group of information. This column of data has ‘key’ values which we can define as being distinct. In the case of the data below, this could be earthquake magnitudes.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-01.png" alt="Mapping a Single Dimension of Data">
  <figcaption>Mapping a Single Dimension of Data</figcaption>
</figure>


<p>The reduce function then takes that dimension and ‘reduces’ it by grouping it according to a specific aspect. For instance in the example above we may want to group each unique value of magnitude (by counting how many occurrences of each there are) to know how many earthquakes of a specific magnitude have taken place. Leaving us with a very specific subset of our data.</p>

<figure class="code">
<div class="highlight"><pre><code></code>Magnitude Count
2.6       63
2.7       134
2.8       292
2.9       299
3.0       378
3.1       351
3.2       403
3.3       455
3.4       512
3.5       688
</pre></div>

</figure>

<aside class="warning blurb">
    <p>Please don’t think that this is the sum total of information you need to know to be the master of map-reduce. This is a ridiculously simplistic view which is only intended to supply enough information to get you familiar with the way that we will use crossfilter later :-).</p>

</aside>

<h4 id="leanpub-auto-what-can-crossfilter-do">What can crossfilter do?</h4>

<p>The best way to get a feel for the capabilities of crossfilter is to visit the <a href="http://square.github.io/crossfilter/">demo page for crossfilter</a> and to play with their example.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-02.png" alt="Crossfilter Demo Page">
  <figcaption>Crossfilter Demo Page</figcaption>
</figure>


<p>Here we are presented with five separate views of a data set that represents flight records demonstrating airline on-time performance. There are  231,083 flight records in the database being used, so getting that rendered in a web page is no small feat in itself. </p>

<p>The bottom view is a table showing data for individual flights. The top, left view is of the number of flights that occur at a specific hour of the day.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-03.png" alt="Flights at a Specific Hour of the Day">
  <figcaption>Flights at a Specific Hour of the Day</figcaption>
</figure>


<p>The top, middle graph shows the amount of delay for flights grouped in 10 minute intervals.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-04.png" alt="Flights Delay in 10 Minute Intervals">
  <figcaption>Flights Delay in 10 Minute Intervals</figcaption>
</figure>


<p>The top, right graph shows the distance covered by each flight grouped in 50 mile chunks.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-05.png" alt="Flights Delay in 10 Minute Intervals">
  <figcaption>Flights Delay in 10 Minute Intervals</figcaption>
</figure>


<p>The wider bar graph in the second row shows the number of flights per day.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-06.png" alt="Flights per Day">
  <figcaption>Flights per Day</figcaption>
</figure>


<p>This particular graph is the first to give a hint at how cool this visualization really is, because it includes a section in the middle of the graph which is selected with ‘handles’ on either side of the selection. You can move these handles with a mouse and as a result you will find all the data represented in the other graphs adjusting dynamically to follow your selection.</p>

<p>This same feature is available in all the graphs. So you are able to filter dynamically and have the results presented virtually instantaneously. This is where you can start to have fun and discover things that might not be immediately obvious.</p>

<p>For instance, if we select only the flights that arrived late, we can see a marked skew in the time of day. Does this mean that flights that are delayed will typically be in the late evening? </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-07.png" alt="Arrival Delay and Time of Day">
  <figcaption>Arrival Delay and Time of Day</figcaption>
</figure>


<p>So this is why tools like crossfilter are cool. All we need to do now is learn how to make them ourselves :-).</p>

<h3 id="leanpub-auto-introduction-to-dcjs">Introduction to dc.js</h3>

<p>Why, if we’ve just explored the benefits of crossfilter are we now introducing a completely different JavaScript library (dc.js)? </p>

<p>Well, crossfilter isn’t a library that’s designed to draw graphs. It’s designed to manipulate data. D3.js is a library that’s designed to manipulate graphical objects (and more) on a web page. The two of them will work really well together, but the barrier to getting data onto a web page can be slightly daunting because the combination of two non-trivial technologies can be difficult to achieve. </p>

<p>This is where <a href="http://nickqizhu.github.io/dc.js/">dc.js</a> comes in. It was developed by <a href="https://github.com/NickQiZhu">Nick Qi Zhu</a> and the first version was released on the 7th of July 2012. </p>

<p>Dc.js is designed to be an enabler for both libraries. Taking the power of crossfilter’s data manipulation capabilities and integrating the graphical capabilities of d3.js. </p>

<p>It is designed to provide access to a range of different chart types in a relatively easy to use fashion. It is more limited in the range of options available for graphical design in this respect than d3.js, but the simplicity that it provides for creating pages using crossfiltered data is a real benefit if you’re anything like me and need all the help you can get.</p>

<p>The different (generic) types of chart that dc.js supports are</p>

<ul>
  <li>Bar Chart</li>
  <li>Pie Chart</li>
  <li>Row Chart</li>
  <li>Line Chart</li>
  <li>Bubble Chart</li>
  <li>Geo Choropleth Chart</li>
  <li>Data Table</li>
</ul>

<p>All these examples come with a range of options which we will cover in greater depth in later sections.</p>

<p>My initial sources of information for developing the examples here came primarily from;</p>

<ul>
  <li><a href="http://nickqizhu.github.io/dc.js/">Nick Zhu’s examples</a></li>
  <li><a href="http://blog.rusty.io/2012/09/17/crossfilter-tutorial/">Rusty Klophaus’ blog post on crossfilter</a></li>
  <li><a href="https://becomingadatascientist.wordpress.com/tag/crossfilter-js/">Eamonn O’Loughlin’s blog post on dc.js</a></li>
</ul>

<h4 id="leanpub-auto-bar-chart">Bar Chart</h4>

<p>This is a standard bar chart.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-08.png" alt="Bar Chart Example">
  <figcaption>Bar Chart Example</figcaption>
</figure>


<h4 id="leanpub-auto-pie-chart">Pie Chart</h4>

<p>This is a standard pie chart. The examples below are from one of Nick Zhu’s <a href="http://nickqizhu.github.io/dc.js/">dc.js example pages</a>.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-09.png" alt="Pie Chart Examples">
  <figcaption>Pie Chart Examples</figcaption>
</figure>


<h4 id="leanpub-auto-row-chart">Row Chart</h4>

<p>The row chart is a horizontal version of a bar chart, but with the ability to represent discrete values and to select them for filtering by clicking on them.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-10.png" alt="Row Chart Example">
  <figcaption>Row Chart Example</figcaption>
</figure>


<h4 id="leanpub-auto-line-chart">Line Chart</h4>

<p>Standard line chart.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-11.png" alt="Line Chart Example">
  <figcaption>Line Chart Example</figcaption>
</figure>


<h4 id="leanpub-auto-bubble-chart">Bubble Chart</h4>

<p>The bubble chart is a derivative of a scatter plot with control over x axis position, y axis position, bubble radius and colour.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-12.png" alt="Bubble Chart Example">
  <figcaption>Bubble Chart Example</figcaption>
</figure>


<h4 id="leanpub-auto-geo-choropleth-chart">Geo Choropleth Chart</h4>

<p>A Choropleth map is one where areas are shaded or patterned in proportion to the measurement of a variable being displayed on the map, such as population density or per-capita income. The example below is from one of Nick Zhu’s <a href="http://nickqizhu.github.io/dc.js/vc/">dc.js example pages</a></p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-13.png" alt="Geo Choropleth Chart Example">
  <figcaption>Geo Choropleth Chart Example</figcaption>
</figure>


<h4 id="leanpub-auto-data-table">Data Table</h4>
<p>A data table is a simple table made up of data elements derived from the information loaded.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-14.png" alt="Data Table Example">
  <figcaption>Data Table Example</figcaption>
</figure>


<div class="page-break"></div>
<h3 id="leanpub-auto-bare-bones-structure-for-dcjs-and-crossfilter-page">Bare bones structure for dc.js and crossfilter page</h3>

<p>To learn some of the capabilities of dc.js and crossfilter we will start with a rudimentary template and build chart examples as we go.</p>

<p>The template we’ll start with will load d3.js, crossfilter.js, dc.js, jquery.js and bootstrap.js. We will be including bootstrap as it provides lots of nice capabilities for fine tuning layout and styling as laid out in the chapter on using bootstrap. Since bootstrap depends on jquery, we have to load that as well.</p>

<p>We’ll also load cascading style sheets for bootstrap and dc.js.</p>

<p>The template will load a csv file with earthquake data sourced from New Zealand’s <a href="http://geonet.org.nz/">Geonet</a> site over a date range that covers a period of reasonable activity in July 2013.  </p>

<p>In its bare bones form we will present only a data table with some values from the csv file. When we begin to add charts, we will see this table adjust dynamically.</p>

<p>We’ll move through the explanation of the code in a similar process to the other examples in the book. Where there are areas that we have covered before, I will gloss over some details on the understanding that you will have already seen them explained in other sections.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/6584483">github</a> or in the code samples bundled with this book (dcjs-examples.html, dc.js, dc.css, crossfilter.js, jquery-1.9.1.min.js, bootstrap.min.js, bootstrap.min.css and quakes.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/6584483">bl.ocks.org</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">'en'</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">'utf-8'</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>dc.js Experiment<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'crossfilter.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'dc.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'jquery-1.9.1.min.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'bootstrap.min.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">link</code> <code class="na">href</code><code class="o">=</code><code class="s">'bootstrap.min.css'</code> <code class="na">rel</code><code class="o">=</code><code class="s">'stylesheet'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/css'</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">link</code> <code class="na">href</code><code class="o">=</code><code class="s">'dc.css'</code> <code class="na">rel</code><code class="o">=</code><code class="s">'stylesheet'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/css'</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">style</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/css"</code><code class="p">&gt;&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'container'</code> <code class="na">style</code><code class="o">=</code><code class="s">'font: 12px sans-serif;'</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
	<code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span12'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">table</code> <code class="na">class</code><code class="o">=</code><code class="s">'table table-hover'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-table-graph'</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">thead</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">tr</code> <code class="na">class</code><code class="o">=</code><code class="s">'header'</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>DTG<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Lat<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Long<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Depth<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Magnitude<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Google Map<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>OSM Map<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">thead</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>
	<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// Create the dc.js chart objects &amp; link to div</code>
<code class="kd">var</code> <code class="nx">dataTable</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">dataTable</code><code class="p">(</code><code class="s2">"#dc-table-graph"</code><code class="p">);</code>

<code class="c1">// load data from a csv file</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"quakes.csv"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// format our data</code>
  <code class="kd">var</code> <code class="nx">dtgFormat</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m-%dT%H:%M:%S"</code><code class="p">);</code>
  
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
    <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code>   <code class="o">=</code> <code class="nx">dtgFormat</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">origintime</code><code class="p">.</code><code class="nx">substr</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">19</code><code class="p">));</code> 
    <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code>   <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">latitude</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="kr">long</code>  <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">longitude</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code>   <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">magnitude</code><code class="p">,</code><code class="mi">1</code><code class="p">);</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">depth</code><code class="p">,</code><code class="mi">0</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="c1">// Run the data through crossfilter and load our 'facts'</code>
  <code class="kd">var</code> <code class="nx">facts</code> <code class="o">=</code> <code class="nx">crossfilter</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>

  <code class="c1">// Create dataTable dimension</code>
  <code class="kd">var</code> <code class="nx">timeDimension</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code>
  <code class="p">});</code>

  <code class="c1">// Setup the charts</code>
  
  <code class="c1">// Table of earthquake data</code>
  <code class="nx">dataTable</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">960</code><code class="p">).</code><code class="nx">height</code><code class="p">(</code><code class="mi">800</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">timeDimension</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"Earthquake Table"</code>
	 <code class="p">})</code>
	<code class="p">.</code><code class="nx">size</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">columns</code><code class="p">([</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="kr">long</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
          <code class="k">return</code> <code class="s1">'&lt;a href=\"http://maps.google.com/maps?z=12&amp;t=m&amp;q=loc:'</code> <code class="o">+</code> 
              <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code> <code class="o">+</code> <code class="s1">'+'</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="kr">long</code> <code class="o">+</code> <code class="s2">"\" target=\"_blank\"&gt;Google Map&lt;/a&gt;"</code><code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">return</code> <code class="s1">'&lt;a href=\"http://www.openstreetmap.org/?mlat='</code> <code class="o">+</code> 
              <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code> <code class="o">+</code> <code class="s1">'&amp;mlon='</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="kr">long</code> <code class="o">+</code><code class="s1">'&amp;zoom=12'</code><code class="o">+</code> 
              <code class="s2">"\" target=\"_blank\"&gt; OSM Map&lt;/a&gt;"</code><code class="p">}</code>
    <code class="p">])</code>
    <code class="p">.</code><code class="nx">sortBy</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">order</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">);</code>

  <code class="c1">// Render the Charts</code>
  <code class="nx">dc</code><code class="p">.</code><code class="nx">renderAll</code><code class="p">();</code>
  
<code class="p">});</code>
  
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
    
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The first part of the code starts the html file and inside the <code>&lt;head&gt;</code> segment loads our JavaScript and css files</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">'en'</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">'utf-8'</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>dc.js Experiment<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'crossfilter.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'dc.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'jquery-1.9.1.min.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">'bootstrap.min.js'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/javascript'</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">link</code> <code class="na">href</code><code class="o">=</code><code class="s">'bootstrap.min.css'</code> <code class="na">rel</code><code class="o">=</code><code class="s">'stylesheet'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/css'</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">link</code> <code class="na">href</code><code class="o">=</code><code class="s">'dc.css'</code> <code class="na">rel</code><code class="o">=</code><code class="s">'stylesheet'</code> <code class="na">type</code><code class="o">=</code><code class="s">'text/css'</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">style</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/css"</code><code class="p">&gt;&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="warning blurb">
    <p>It’s worth noting that the order of loading the files is important. The <code>jquery-1.9.1.min.js</code> file must be loaded before the <code>bootstrap.min.js</code> file or it just won’t work.</p>

</aside>

<p>From here we move into the section where we set up our page to load our bootstrap grid layout for the table.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'container'</code> <code class="na">style</code><code class="o">=</code><code class="s">'font: 12px sans-serif;'</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span12'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">table</code> <code class="na">class</code><code class="o">=</code><code class="s">'table table-hover'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-table-graph'</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">thead</code><code class="p">&gt;</code>
          <code class="p">&lt;</code><code class="nt">tr</code> <code class="na">class</code><code class="o">=</code><code class="s">'header'</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>DTG<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Lat<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Long<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Depth<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Magnitude<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Google Map<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>OSM Map<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
          <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">thead</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>It might look a little complicated, but if you have a look through the bootstrap chapter (where we cover using the bootstrap grid layout), you will find it no problem at all. </p>

<p>The important features to note are that we have declared an ID selector for our table <code>id='dc-table-graph'</code> and we have set a series of headers for the table; DTG, Lat, Long, Depth, Magnitude, Google Map and OSM Map.</p>

<p>We have also included some bootstrap styling for the table by including the <code>class='table table-hover'</code> portion of the code. With that styling included our table looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-15.png" alt="Data Table *with* Bootstrap Styling">
  <figcaption>Data Table <em>with</em> Bootstrap Styling</figcaption>
</figure>


<p>Without the styling it would look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-16.png" alt="Data Table *without* Bootstrap Styling">
  <figcaption>Data Table <em>without</em> Bootstrap Styling</figcaption>
</figure>


<p>We will be adding to this grid layout section as we add in charts which will want their own allocated space on our page.</p>

<p>The next section of the file starts our JavaScript and declares our variables for our charts.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Create the dc.js chart objects &amp; link to div</code>
  <code class="kd">var</code> <code class="nx">dataTable</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">dataTable</code><code class="p">(</code><code class="s2">"#dc-table-graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The first line assigns the variable <code>dataTable</code> to the dc.js dataTable chart type (<code>var dataTable = dc.dataTable("#dc-table-graph");</code>) and assigns the chart to the ID selector <code>dc-table-graph</code>.</p>

<p>Then we get into the d3.js.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// load data from a csv file</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"quakes.csv"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// format our data</code>
  <code class="kd">var</code> <code class="nx">dtgFormat</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m-%dT%H:%M:%S"</code><code class="p">);</code>
  
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
    <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code>   <code class="o">=</code> <code class="nx">dtgFormat</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">origintime</code><code class="p">.</code><code class="nx">substr</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">19</code><code class="p">));</code> 
    <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code>   <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">latitude</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="kr">long</code>  <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">longitude</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code>   <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">magnitude</code><code class="p">,</code><code class="mi">1</code><code class="p">);</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">depth</code><code class="p">,</code><code class="mi">0</code><code class="p">);</code>
  <code class="p">});</code> 
</pre></div>

</figure>

<p>We load our csv file with the line <code>d3.csv("quakes.csv", function (data) {</code>. I have deliberately left this file in its raw form as received from Geonet. Its format looks a little like this (be warned, the formatting of the book can create word wrap issues where the text will be broken by a backslash () and this is likely to happen with the text below);</p>

<figure class="code">
<div class="highlight"><pre><code></code>FID,publicid,origintime,longitude,latitude,depth,magnitude,magnitudetype,stat\
us,phases,type,agency,updatetime,origin_geom
quake.2013p550753,2013p550753,2013-07-23T18:41:11.707,174.4298,-41.5313,7.988\
3,2.2425,M,automatic,27,,WEL(GNS_Primary),2013-07-23T18:43:15.672,POINT (174.\
42978 -41.531299)
quake.2013p550747,2013p550747,2013-07-23T18:38:02.481,174.414,-41.5181,11.679\
7,1.7892,M,automatic,11,,WEL(GNS_Primary),2013-07-23T18:39:25.37,POINT (174.4\
1398 -41.518114)
quake.2013p550725,2013p550725,2013-07-23T18:26:30.229,175.5516,-40.0264,8.75,\
3.4562,M,automatic,21,,WEL(GNS_Primary),2013-07-23T18:29:46.305,POINT (175.55\
155 -40.026412)
</pre></div>

</figure>

<p>We then declare a small function that will format our time correctly (<code>var dtgFormat = d3.time.format("%Y-%m-%dT%H:%M:%S");</code>). This follows exactly the same procedure we took when creating our very first simple line graph at the start of the book.</p>

<aside class="tip blurb">
    <p>However, there is a slight twist… Observant readers will notice that while we have a function that resolves a date/time that is formatted with year, month, day, hour, minute and second values, I don’t include an allowance for the fractions of seconds that appear in the csv file. Well spotted. The reason for this is that in spite of initially including this formatting, I found it caused some behaviour that I couldn’t explain, so I reverted to <strong><em>cheating</em></strong> and you will note that in the next section when I format the values from the csv file, I truncate the date/time value to the first 19 characters (<code>d.origintime.substr(0,19)</code>). This solved my problem by chopping off the fractions of a second (admittedly without actually solving the underlying issue) and I moved on with my life.</p>

</aside>

<p>While we’re on the subject, observant readers will have noticed that the format of the date / time that appears in the table are (how to put this kindly…….), not what came out of the csv file. </p>

<p>If you want to put this in a different format we can employ the same technique we used when formatting time figures in the section that dealt with tables. All we need to do is to assign a new variable for our ‘correctly’ formatted time in the <code>forEach</code> loop. and then call that variable when displaying the table values.</p>

<p>The following code will create a date / time string in the format yyyy-mm-dd hh:mm:ss with a variable name dtg1 (put this in the <code>forEach</code> loop).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg1</code>  <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">origintime</code><code class="p">.</code><code class="nx">substr</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">origintime</code><code class="p">.</code><code class="nx">substr</code><code class="p">(</code><code class="mi">11</code><code class="p">,</code><code class="mi">8</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then, when your code calls the values for the table, instead of the line that says;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">},</code>
</pre></div>

</figure>

<p>You rename <code>dtg</code> to <code>dtg1</code> like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg1</code><code class="p">;</code> <code class="p">},</code>
</pre></div>

</figure>

<p>The end result will look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-39.png" alt="Data Table with Formatted Date / Time">
  <figcaption>Data Table with Formatted Date / Time</figcaption>
</figure>


<p>As mentioned, the next section goes through each of the records and formats them correctly. The date/time gets formatted, the latitude and longitude are declared as numerical values (if they weren’t already) and the magnitude and depth values are rounded to make the process of grouping them simpler.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
    <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code>   <code class="o">=</code> <code class="nx">dtgFormat</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">origintime</code><code class="p">.</code><code class="nx">substr</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">19</code><code class="p">));</code> 
    <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code>   <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">latitude</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="kr">long</code>  <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">longitude</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code>   <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">magnitude</code><code class="p">,</code><code class="mi">1</code><code class="p">);</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">depth</code><code class="p">,</code><code class="mi">0</code><code class="p">);</code>
  <code class="p">});</code> 
</pre></div>

</figure>

<p>The next section in our code sets up the dimensions and groupings for the dc.js chart type and crossfilter functions.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Run the data through crossfilter and load our 'facts'</code>
  <code class="kd">var</code> <code class="nx">facts</code> <code class="o">=</code> <code class="nx">crossfilter</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>

  <code class="c1">// Create dataTable dimension</code>
  <code class="kd">var</code> <code class="nx">timeDimension</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>We load all of our data into crossfilter (<code>var facts = crossfilter(data);</code>) and give it the name <code>facts</code>.</p>

<p>Then we create a dimension from our data (<code>facts</code>) of the date/time values.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">timeDimension</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>The last major chunk of code is the piece that configures our data table.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">dataTable</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">960</code><code class="p">).</code><code class="nx">height</code><code class="p">(</code><code class="mi">800</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">timeDimension</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"Earthquake Table"</code>
	 <code class="p">})</code>
	<code class="p">.</code><code class="nx">size</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">columns</code><code class="p">([</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="kr">long</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code><code class="p">;</code> <code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
          <code class="k">return</code> <code class="s1">'&lt;a href=\"http://maps.google.com/maps?z=12&amp;t=m&amp;q=loc:'</code> <code class="o">+</code> 
              <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code> <code class="o">+</code> <code class="s1">'+'</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="kr">long</code> <code class="o">+</code><code class="s2">"\" target=\"_blank\"&gt;Google Map&lt;/a&gt;"</code><code class="p">},</code>
      <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
          <code class="k">return</code> <code class="s1">'&lt;a href=\"http://www.openstreetmap.org/?mlat='</code> <code class="o">+</code> 
              <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code> <code class="o">+</code> <code class="s1">'&amp;mlon='</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="kr">long</code> <code class="o">+</code>
              <code class="s1">'&amp;zoom=12'</code><code class="o">+</code> <code class="s2">"\" target=\"_blank\"&gt; OSM Map&lt;/a&gt;"</code><code class="p">}</code>
    <code class="p">])</code>
    <code class="p">.</code><code class="nx">sortBy</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">order</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">);</code>
</pre></div>

</figure>

<p>Firstly the width and height are declared (<code>dataTable.width(960).height(800)</code>). Then the dimension of the data that will be used is declared (<code>.dimension(timeDimension)</code>).</p>

<aside class="information blurb">
    <p>Separate sections of the table can have a header applied. In this case the entire table is given the grouping ‘Earthquake Table’ (<code>.group(function(d) { return "Earthquake Table"})</code>), but several examples online give the date.</p>

</aside>

<p>The <code>.size(10)</code> line sets the maximum number of lines of the table to be displayed to 10.</p>

<p>Then we have the block of code that sets what data appears in which columns. It should be noted that this matches up with the headers that were declared in the earlier section of the code where the divs for the table were laid out.</p>

<p>The portion of this block that has a ‘<em>little bit of fancy</em>’ are the two columns that set links that allow a user to click on the designation ‘Google Map’ or ‘OSM Map’ and have the browser open a new window containing a Google or Open Street Map (OSM) map with a marker designating the location of the quake. I won’t mention too much about how the links are made up other than to say that they are pretty much a combination of the latitude, longitude and zoom level for both. Please check out the code for more.</p>

<p>Lastly we sort by the date/time value (<code>.sortBy(function(d){ return d.dtg; })</code>) in ascending order (<code>.order(d3.ascending);</code>).</p>

<p>The final part of our JavaScript renders all our charts (<code>dc.renderAll();</code>) and then closes off the initial <code>d3.csv</code> call.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Render the Charts</code>
  <code class="nx">dc</code><code class="p">.</code><code class="nx">renderAll</code><code class="p">();</code>
  
<code class="p">});</code>
</pre></div>

</figure>

<p>The final part of our code simply closes off the <code>&lt;script&gt;</code>, <code>&lt;body&gt;</code> and <code>&lt;html&gt;</code> tags.</p>

<p>There we have it. The template for starting to play with different crossfiltered dc.js charts.  </p>

<div class="page-break"></div>
<h3 id="leanpub-auto-add-a-bar-chart">Add a Bar Chart.</h3>

<p>The ubiquitous bar chart is a smart choice if you’re starting out with crossfilter and dc.js. It’s pretty easy to implement and gives a certain degree of instant satisfaction.</p>

<p>The bar chart that we’ll create will be a representation of the magnitude of the earthquakes that we have in our dataset. In this respect, what we are expecting to see is the magnitude of the events along the x axis and the number of each such event on the y axis.</p>

<p>It should end up looking a bit like this.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-08.png" alt="Bar Chart Example">
  <figcaption>Bar Chart Example</figcaption>
</figure>


<p>We’ll work through adding the chart in stages (and this should work for subsequent charts). Firstly we’ll organise a position for our chart on the page using the bootstrap grid set-up. Then we’ll name our chart and assign it a chart type. Then we’ll create any required dimension and grouping and finally we’ll configure the parameters for the chart. Sounds simple right? </p>

<ol class="numeric">
  <li>Position the chart</li>
  <li>Assign type</li>
  <li>Dimension and Group</li>
  <li>Configure chart parameters</li>
</ol>

<h4 id="leanpub-auto-position-the-bar-chart">Position the bar chart</h4>

<p>We are going to position our bar chart above our data table and we’ll actually only make it half the width of our data table so that we can add in another one along side it later.</p>

<p>Just under the line of code that defined the main container for the layout;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'container'</code> <code class="na">style</code><code class="o">=</code><code class="s">'font: 12px sans-serif;'</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We add in a new row that has two <code>span6</code>’s in it (remembering our total is a span of 12 (see the section on bootstrap layout if it’s a bit unfamiliar)).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span6'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-magnitude-chart'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Events by Magnitude<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span6'</code> <code class="na">id</code><code class="o">=</code><code class="s">'blank'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Blank<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>    
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We’ve given the first <code>span6</code> an ID selector of <code>dc-magnitude-chart</code>. So when we we assign our chart that selector, it will automatically appear in that position. We’ve also put a simple title in place (<code>&lt;h4&gt;Events by Magnitude&lt;/h4&gt;</code>). The second <code>span6</code> is set as blank for the time being (we’ll put another bar chart in it later).</p>

<h4 id="leanpub-auto-assign-the-bar-chart-type">Assign the bar chart type</h4>

<p>Here we give our chart it’s name (<code>magnitudeChart</code>), assign it with a dc.js chart type (in this case <code>barChart</code>) and assign it to the ID selector (<code>dc-magnitude-chart</code>).</p>

<p>Under the line that assigns the <code>dataTable</code> chart type…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">dataTable</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">dataTable</code><code class="p">(</code><code class="s2">"#dc-table-graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… add in the equivalent for our bar chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">dataTable</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">dataTable</code><code class="p">(</code><code class="s2">"#dc-table-graph"</code><code class="p">);</code>
  <code class="kd">var</code> <code class="nx">magnitudeChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">barChart</code><code class="p">(</code><code class="s2">"#dc-magnitude-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<p>All done.</p>

<h4 id="leanpub-auto-dimension-and-group-the-bar-chart-data">Dimension and group the bar chart data</h4>

<p>To set our dimension for magnitude, it’s as simple as following the same format as we had previously done for the data table but in this case using the <code>.mag</code> variable.</p>

<p>This should go just before the portion of the code that created the data table dimension.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">magValue</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>This dimension (<code>magValue</code>) has been set and now has, as its index, each unique magnitude that is seen in the database. This is essentially defining the values on the x axis for our bar chart.</p>

<p>Then we want to group the data by counting the number of events of each magnitude. </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">magValueGroupCount</code> <code class="o">=</code> <code class="nx">magValue</code><code class="p">.</code><code class="nx">group</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">reduceCount</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code><code class="p">;</code> <code class="p">})</code> <code class="c1">// counts </code>
</pre></div>

</figure>

<p>This piece of code (which should go directly under the <code>magValue</code> dimension portion), groups (<code>.group()</code>) by counting (<code>.reduceCount</code>) all of the magnitude values (<code>function(d) { return d.mag; })</code>) and assigns it to the  <code>magValueGroupCount</code> variable. This has essentially defined the values for the y axis of our bar chart (the number of times each magnitude occurs).</p>

<h4 id="leanpub-auto-configure-the-bar-chart-parameters">Configure the bar chart parameters</h4>

<p>There are lots of parameters that can be configured, and if the truth be told, I haven’t explored all of them or, in some cases, worked out exactly how they work.</p>

<p>However, the best way to learn is by doing, so here is the block of code for configuring the bar chart. This should go just before the block that configures the dataTable.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">magnitudeChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">480</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">})</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">magValue</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">magValueGroupCount</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">transitionDuration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">centerBar</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>	
    <code class="p">.</code><code class="nx">gap</code><code class="p">(</code><code class="mi">65</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">filter</code><code class="p">([</code><code class="mi">3</code><code class="p">,</code> <code class="mi">5</code><code class="p">])</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="mf">0.5</code><code class="p">,</code> <code class="mf">7.5</code><code class="p">]))</code>
    <code class="p">.</code><code class="nx">elasticY</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">xAxis</code><code class="p">().</code><code class="nx">tickFormat</code><code class="p">();</code>	
</pre></div>

</figure>

<p>That should be it. With the addition of this portion of the code, you should have a functioning visualization that can be filtered dynamically. Just check to make sure that everything is working properly and we’ll go through some of the configuration options to see what they do.</p>

<p>Your web page should look a little like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-17.png" alt="Web Page with Bar Chart">
  <figcaption>Web Page with Bar Chart</figcaption>
</figure>


<p>The configuration options start by declaring the name of the chart (<code>magnitudeChart</code>) and setting the height and width of the chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">magnitudeChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">480</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
</pre></div>

</figure>

<p>In the case of our example I have selected the width based on the default size for a <code>span6</code> grid segment in bootstrap and adjusted the height to make it look suitable.</p>

<p>Then we have our margins set up.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">})</code>	
</pre></div>

</figure>

<p>Nothing too surprising there although the left margin is slightly larger to allow for larger values on the y axis to be represented without them getting clipped.</p>

<p>Then we define which dimension and grouping we will use. </p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">magValue</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">magValueGroupCount</code><code class="p">)</code>
</pre></div>

</figure>

<p>I like to think of this section as the <code>.dimension</code> declaration being the x axis and the <code>.group</code> declaration being the y axis. This just helps me get the graph straight in my head before it’s plotted.</p>

<p>The <code>.transitionDuration</code> setting defines the length of time that any change takes to be applied to the chart as it adjusts.</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="p">.</code><code class="nx">transitionDuration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
</pre></div>

</figure>

<p>Then we ensure that the bar for the bar graph is centred on the ticks on the x axis.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">centerBar</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>		
</pre></div>

</figure>

<p>Without this (<code>true</code> is not the default), the graph will look slightly odd.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-18.png" alt="Bar Chart with Bars Not Centred">
  <figcaption>Bar Chart with Bars Not Centred</figcaption>
</figure>


<p>The setting of the gap between the bars is accomplished with the following setting;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="p">.</code><code class="nx">gap</code><code class="p">(</code><code class="mi">65</code><code class="p">)</code>
</pre></div>

</figure>

<p>I will admit that I still don’t quite understand how this setting works exactly, but I can get it to do what I want with a little trial and error.</p>

<p>For instance, I would expect that <code>.gap(2)</code> would have the effect of producing a gap of 2 pixels between the bars. But this would be the result for our graph if I have that set.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-19.png" alt="Bar Chart with `gap` Set to 2">
  <figcaption>Bar Chart with <code>gap</code> Set to 2</figcaption>
</figure>


<p>If you select a portion of the graph you will see some strange things going on. That appears to be as a result of the bars being too wide for the graph. </p>

<p>Setting the gap for a bar graph is a pretty tricky thing to do (programmatically), and I can see why it would throw some strange results. The way around this and the way to find the ideal <code>.gap</code> setting is to set the <code>.gap</code> value high and then reduce it till it’s right. </p>

<p>For instance, if we set it to 100 (<code>.gap(100)</code>) we will get the following result.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-20.png" alt="Bar Chart with `gap` Set to 100">
  <figcaption>Bar Chart with <code>gap</code> Set to 100</figcaption>
</figure>


<p>Then we just keep backing the values off till we reach an acceptable chart on the screen.</p>

<p>In the case of our example, it’s <code>.gap(65)</code>.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-08.png" alt="Bar Chart Example">
  <figcaption>Bar Chart Example</figcaption>
</figure>


<p>I have added in the next setting more because I want you to know it exists, rather than wanting to use it in this example. </p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">filter</code><code class="p">([</code><code class="mi">3</code><code class="p">,</code> <code class="mi">5</code><code class="p">])</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-21.png" alt="Bar Chart with Pre-Selection Section">
  <figcaption>Bar Chart with Pre-Selection Section</figcaption>
</figure>


<p>Setting the <code>.filter</code> configuration will load the graph with a portion of it pre-selected. If you omit this parameter, the entire graph is selected by default. In most cases that I can think of, that is what I would start with.</p>

<p>We can set the range of values presented in our graph by defining the domain (in the same way as for d3.js).</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="mf">0.5</code><code class="p">,</code> <code class="mf">7.5</code><code class="p">]))</code>
</pre></div>

</figure>

<p>The next parameter sets the y axis to adjust dynamically as the filtered data is returned.</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="p">.</code><code class="nx">elasticY</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
</pre></div>

</figure>

<p>The final parameter that we set is to format the values on the x axis.</p>
<figure class="code">
<div class="highlight"><pre><code></code>	.xAxis().tickFormat();	
</pre></div>

</figure>

<p>And that’s it! A bar graph added to your visualization with full dynamic control.</p>

<h4 id="leanpub-auto-just-one-more-thing">Just one more thing…</h4>

<p>Just another snippet that could be useful. In the section where we set up our group to count the number of instances of individual magnitudes we had; </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">magValueGroupCount</code> <code class="o">=</code> <code class="nx">magValue</code><code class="p">.</code><code class="nx">group</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">reduceCount</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">mag</code><code class="p">;</code> <code class="p">})</code> <code class="c1">// counts </code>
</pre></div>

</figure>

<p>We could have just as easily summed the magnitude values instead of counting them by using <code>.reduceSum</code> instead of <code>.reduceCount</code>. This has the effect of increasing the value on the y axis (as the sum of the magnitudes would have been greater than the count) like so</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-22.png" alt="Bar Chart Counting and Summing">
  <figcaption>Bar Chart Counting and Summing</figcaption>
</figure>


<p>The reason I mention it is that <em>summing</em> the numeric value would be useful in many circumstances (file size or packet size or similar).</p>

<h4 id="leanpub-auto-just-yet-another-thing">Just yet another thing…</h4>

<p>When we initially set up our grid layout for the web page we left ourselves a blank position for another graph. If you feel so inclined, try to include another bar graph in this position that will display the depth of the earthquakes.</p>

<p>The example I came up with looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-23.png" alt="Earthquake page with Magnitude and Depth Bar Charts">
  <figcaption>Earthquake page with Magnitude and Depth Bar Charts</figcaption>
</figure>


<p>And the sections I added are as follows;</p>

<h5 id="leanpub-auto-position-the-chart">Position the chart</h5>

<p>(more of a change than an addition)</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span6'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-depth-chart'</code><code class="p">&gt;</code>
	  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Events by Depth (km)<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>  
</pre></div>

</figure>

<h5 id="leanpub-auto-assign-type">Assign type</h5>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">depthChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">barChart</code><code class="p">(</code><code class="s2">"#dc-depth-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-dimension-and-group">Dimension and Group</h5>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">depthValue</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code><code class="p">;</code>
  <code class="p">});</code>
  <code class="kd">var</code> <code class="nx">depthValueGroup</code> <code class="o">=</code> <code class="nx">depthValue</code><code class="p">.</code><code class="nx">group</code><code class="p">();</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-configure-chart-parameters">Configure chart parameters</h5>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">depthChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">480</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">})</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">depthValue</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">depthValueGroup</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">transitionDuration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">centerBar</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>	
    <code class="p">.</code><code class="nx">gap</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>  
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">100</code><code class="p">]))</code>
    <code class="p">.</code><code class="nx">elasticY</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">xAxis</code><code class="p">().</code><code class="nx">tickFormat</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">v</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">v</code><code class="p">;});</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-add-a-line-chart">Add a Line Chart.</h3>

<p>The line chart is another simple choice for implementation using crossfilter and dc.js.</p>

<p>The line chart that we’ll create will be a representation of the frequency of the occurrence of the earthquakes that we have in our dataset. In this respect, what we are expecting to see is the number of events on the y axis and the time-scale on the x axis.</p>

<p>It should end up looking a bit like this.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-24.png" alt="Line Chart Example">
  <figcaption>Line Chart Example</figcaption>
</figure>


<p>Just as with the bar chart, we’ll work through adding the chart in the following stages.</p>

<ol class="numeric">
  <li>Position the chart</li>
  <li>Assign type</li>
  <li>Dimension and Group</li>
  <li>Configure chart parameters</li>
</ol>

<h4 id="leanpub-auto-position-the-line-chart">Position the line chart</h4>

<p>We are going to position our line chart above our data table (and below the bar charts) and we’ll make it the full width of our data table so that it looks like it belongs there.</p>

<p>Just under the line of code that defined the containers for the bar graphs;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span6'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-magnitude-chart'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Events by Magnitude Counted<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span6'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-depth-chart'</code><code class="p">&gt;</code>
	  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Events by Depth (km)<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>   
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We add in a new row that has a single <code>span12</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span12'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-time-chart'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Events per hour<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We’ve given it an ID selector of <code>dc-time-chart</code>. So when we assign our chart that selector, it will automatically appear in that position. We’ve also put another simple title in place (<code>&lt;h4&gt;Events per hour&lt;/h4&gt;</code>).</p>

<h4 id="leanpub-auto-assign-the-line-chart-type">Assign the line chart type</h4>

<p>Here we give our chart it’s name (<code>timeChart</code>), assign it with a dc.js chart type (in this case <code>lineChart</code>) and assign it to the ID selector (<code>dc-time-chart</code>).</p>

<p>Under the line that assigns the <code>depthChart</code> chart type…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">depthChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">barChart</code><code class="p">(</code><code class="s2">"#dc-depth-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… add in the equivalent for our line chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">depthChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">barChart</code><code class="p">(</code><code class="s2">"#dc-depth-chart"</code><code class="p">);</code>
  <code class="kd">var</code> <code class="nx">timeChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">lineChart</code><code class="p">(</code><code class="s2">"#dc-time-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Nice.</p>

<h4 id="leanpub-auto-dimension-and-group-the-line-chart-data">Dimension and group the line chart data</h4>

<p>We’ll put the code between the dimension and group of the depth chart and the data table dimension (this is just to try and keep the code in the same order as the graphs on the page).</p>

<p>To set our dimension for our time we do something a little different.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">volumeByHour</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">hour</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>This dimension (<code>volumeByHour</code>) uses the same <code>facts</code> data, but when the key values are returned (<code>return d3.time.hour(d.dtg);</code>) we are going to return the information by hours. This is essentially defining the resolution of the values on the x axis for our line chart.</p>

<p>Then we want to group the data by counting the number of events of for each hour. </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">volumeByHourGroup</code> <code class="o">=</code> <code class="nx">volumeByHour</code><code class="p">.</code><code class="nx">group</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">reduceCount</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This piece of code (which should go directly under the <code>volumeByHour</code> dimension portion) groups (<code>.group()</code>) by counting (<code>.reduceCount</code>) all of the magnitude values (<code>function(d) { return d.dtg; })</code>) and assigns it to the  <code>volumeByHourGroup</code> variable. This has defined the values for the y axis of our line chart (the number of events we see in a given hour).</p>

<h4 id="leanpub-auto-configure-the-line-chart-parameters">Configure the line chart parameters</h4>

<p>As with the bar chart, there are lots of parameters that can be configured. The best way to learn what they do is by having a play with them. So here is the block of code for configuring the line chart. Once you are happy that it works on your system, take some time and go through the settings in conjunction with the information from the <a href="http://nickqizhu.github.io/dc.js/">demo page</a> and the <a href="https://github.com/NickQiZhu/dc.js/wiki/API">api reference</a>.</p>

<p>This should go just before the block that configures the dataTable (again, this is just to try and keep the code in the same order as the graphs on the page).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// time graph</code>
  <code class="nx">timeChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">960</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">})</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">volumeByHour</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">volumeByHourGroup</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">transitionDuration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">elasticY</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">18</code><code class="p">),</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">24</code><code class="p">)]))</code>
    <code class="p">.</code><code class="nx">xAxis</code><code class="p">();</code>
</pre></div>

</figure>

<p>That should be it. With the addition of this portion of the code, you should have a functioning visualization that can be filtered dynamically. Just check to make sure that everything is working properly and we’ll go through some of the configuration options to see what they do.</p>

<p>To start with, your page should look something like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-25.png" alt="Web Page with Line Chart">
  <figcaption>Web Page with Line Chart</figcaption>
</figure>


<p>The configuration options start by declaring the name of the chart (<code>timeChart</code>) and setting the height and width of the chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">timeChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">960</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
</pre></div>

</figure>

<p>In the case of our example I have selected the width based on the default size for a <code>span12</code> grid segment in bootstrap and adjusted the height to make it look suitable.</p>

<p>Then we have our margins set up.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">})</code>
</pre></div>

</figure>

<p>Nothing too surprising there although the left margin is slightly larger to allow for larger values on the y axis to be represented without them getting clipped (not strictly for this example, but it’s a handy default).</p>

<p>Then we define which dimension and grouping we will use. </p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">volumeByHour</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">volumeByHourGroup</code><code class="p">)</code>
</pre></div>

</figure>

<p>Think of the <code>.dimension</code> declaration being the x axis and the <code>.group</code> declaration being the y axis.</p>

<p>The <code>.transitionDuration</code> setting defines the length of time that any change takes to be applied to the chart as it adjusts.</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="p">.</code><code class="nx">transitionDuration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
</pre></div>

</figure>

<p>We can set the y axis to dynamically adjust when the number of events are filtered by selections on any of the other charts.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">elasticY</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
</pre></div>

</figure>

<p>For instance if we select only earthquakes with a magnitude between 4 and 5, our line chart will have a maximum value on the y axis of 7 events;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-26.png" alt="Line Chart y Axis Low">
  <figcaption>Line Chart y Axis Low</figcaption>
</figure>


<p>However, if we select all the earthquakes, the y axis will dynamically adjust to over 30.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-27.png" alt="Line Chart y Axis High">
  <figcaption>Line Chart y Axis High</figcaption>
</figure>


<p>Since the line chart has an x axis which is made of date/time values, we set our scale and domain using the <code>d3.time.scale</code> declaration.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">18</code><code class="p">),</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">24</code><code class="p">)]))</code>
</pre></div>

</figure>

<p>This is hard coded for our date range, but a smarter method would be to have the scale adjust to suit your range of date/time values automatically with the following line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">;</code> <code class="p">})))</code>
</pre></div>

</figure>

<p>Using the <code>d3.extent</code> function means that our line graph of time now spans the exact range of our data values on the x axis (note that the time scale now starts just before the 18th and ends when our data ends).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-28.png" alt="Line Chart with Better x Axis">
  <figcaption>Line Chart with Better x Axis</figcaption>
</figure>


<p>The final parameter that we set is to add the x axis.</p>
<figure class="code">
<div class="highlight"><pre><code></code>	.xAxis();	
</pre></div>

</figure>

<h3 id="leanpub-auto-adding-tooltips-to-a-line-chart">Adding tooltips to a line chart</h3>

<p>dc.js has a nice feature for adding tooltips to a line chart. </p>

<p>It utilises the <code>.title</code> function in the configuration of the chart to apply the tooltip, but the downside is that the ability to select the time range needs to be disabled (there are ways to compensate for this which I hope to cover in the future).</p>

<p>If we take our example line chart configuration block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// time graph</code>
  <code class="nx">timeChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">960</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">})</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">volumeByHour</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">volumeByHourGroup</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">transitionDuration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">elasticY</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">18</code><code class="p">),</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">24</code><code class="p">)]))</code>
    <code class="p">.</code><code class="nx">xAxis</code><code class="p">();</code>
</pre></div>

</figure>

<p>We need to turn off the <code>.brushOn</code> feature (<code>.brushOn(false)</code>) that allows for selection and add in the <code>.title</code> function as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// time graph</code>
  <code class="nx">timeChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">960</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">})</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">volumeByHour</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">volumeByHourGroup</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">transitionDuration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">brushOn</code><code class="p">(</code><code class="kc">false</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">title</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code>
      <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">key</code>
      <code class="o">+</code> <code class="s2">"\nNumber of Events: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
      <code class="p">})</code>
    <code class="p">.</code><code class="nx">elasticY</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">domain</code><code class="p">([</code><code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">18</code><code class="p">),</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2013</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">24</code><code class="p">)]))</code>
    <code class="p">.</code><code class="nx">xAxis</code><code class="p">();</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-46.png" alt="Line Chart with Tooltip">
  <figcaption>Line Chart with Tooltip</figcaption>
</figure>


<p>As we can see, the tooltip is using the default time format for the script from our <code>key</code> value (on the x axis), and as a result, the representation of the date / time is quite long winded. We can adapt this to a format of our choosing by calling a time formatting function similar to the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">dtgFormat2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%a %e %b %H:%M"</code><code class="p">);</code>
</pre></div>

</figure>

<p>This line could ideally go after the other time formatting function (<code>dtgFormat</code>) that occurs earlier in the script. The formatting it’s introducing can be found in the <a href="https://github.com/mbostock/d3/wiki/Time-Formatting#wiki-format">d3.js wiki</a>, but in short it returns the date / time formatted as abbreviated weekday name, day of the month as a decimal number, abbreviated month name and 24 hour clock hour:minute.  </p>

<p>With our function in place, the <code>.title.</code> call from our line chart configuration code would now look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">title</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code>
      <code class="k">return</code> <code class="nx">dtgFormat2</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">key</code><code class="p">)</code>
      <code class="o">+</code> <code class="s2">"\nNumber of Events: "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
      <code class="p">})</code>
</pre></div>

</figure>

<p>And the resulting graph looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-47.png" alt="Line Chart with Improved Tooltip">
  <figcaption>Line Chart with Improved Tooltip</figcaption>
</figure>


<p>We also add in the number of the events from the y axis (<code>d.data.value</code>), separated with a new line character (<code>\n</code>) and some appropriate text.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-add-a-row-chart">Add a Row Chart.</h3>

<p>The row chart provides an excellent mechanism for presenting and filtering on discrete values or identifiers.</p>

<p>The row chart that we’ll create will be a representation of the number of earthquake events that occur on a particular day of the week. As such it doesn’t represent any logical reason for selecting a Saturday over a Wednesday, and it is used here solely because the data makes a nice row chart :-).  In this respect, what we are expecting to see is the number of events on the x axis and the individual days on the y axis.</p>

<p>It should end up looking a bit like this.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-10.png" alt="Row Chart Example">
  <figcaption>Row Chart Example</figcaption>
</figure>


<p>Now for a super cool feature with row charts…</p>

<p>Click on one of the rows…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-33.png" alt="Selecting a Row">
  <figcaption>Selecting a Row</figcaption>
</figure>


<p>How about that!</p>

<p>You can select an individual row from your chart and all the other rows reflect the selection. Go ahead and select other combinations of more than one row if you want. Welcome to data immersion! </p>

<p>Just as with the previous chart examples, we’ll work through adding the chart in the following stages.</p>

<ol class="numeric">
  <li>Position the chart</li>
  <li>Assign type</li>
  <li>Dimension and Group</li>
  <li>Configure chart parameters</li>
</ol>

<h4 id="leanpub-auto-position-the-row-chart">Position the row chart</h4>

<p>We are going to position our row chart above our data table (and below the line chart) and we’ll divide the row that it sits in into 3 equally spaced spans of <code>span3</code>. The additional two spans we’ll leave blank for future use.</p>

<p>Just under the row of code that defined the containers for the line graph;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span12'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-time-chart'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Events per hour<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We add in a new row that has our three <code>span4</code>’s.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-dayweek-chart'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Day of the Week<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'blank1'</code><code class="p">&gt;</code>
	  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Blank 1<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>   
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'blank2'</code><code class="p">&gt;</code>
	  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Blank 2<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code> 
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We’ve given it an ID selector of <code>dc-dayweek-chart</code>. So when we assign our chart that selector, it will automatically appear in that position. We’ve also put another simple title in place (<code>&lt;h4&gt;Day of the Week&lt;/h4&gt;</code>). </p>

<p>The additional two <code>span4</code>s have been left blank.</p>

<h4 id="leanpub-auto-assign-the-row-chart-type">Assign the row chart type</h4>

<p>Here we give our chart its name (<code>dayOfWeekChart</code>), assign it with a dc.js chart type (in this case <code>rowChart</code>) and assign it to the ID selector (<code>dc-dayweek-chart</code>).</p>

<p>Under the row that assigns the <code>depthChart</code> chart…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">depthChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">barChart</code><code class="p">(</code><code class="s2">"#dc-depth-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… add in the equivalent for our row chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">dayOfWeekChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">rowChart</code><code class="p">(</code><code class="s2">"#dc-dayweek-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-dimension-and-group-the-row-chart-data">Dimension and group the row chart data</h4>

<p>We’ll put the code between the dimension and group of the line (time) chart and the data table dimension (this is just to try and keep the code in the same order as the graphs on the page).</p>

<p>When adding our dimension for our day of the week we want to provide an appropriate label so our code does something extra.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">dayOfWeek</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">day</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">.</code><code class="nx">getDay</code><code class="p">();</code>
    <code class="k">switch</code> <code class="p">(</code><code class="nx">day</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">case</code> <code class="mi">0</code><code class="o">:</code>
        <code class="k">return</code> <code class="s2">"0.Sun"</code><code class="p">;</code>
      <code class="k">case</code> <code class="mi">1</code><code class="o">:</code>
        <code class="k">return</code> <code class="s2">"1.Mon"</code><code class="p">;</code>
      <code class="k">case</code> <code class="mi">2</code><code class="o">:</code>
        <code class="k">return</code> <code class="s2">"2.Tue"</code><code class="p">;</code>
      <code class="k">case</code> <code class="mi">3</code><code class="o">:</code>
        <code class="k">return</code> <code class="s2">"3.Wed"</code><code class="p">;</code>
      <code class="k">case</code> <code class="mi">4</code><code class="o">:</code>
        <code class="k">return</code> <code class="s2">"4.Thu"</code><code class="p">;</code>
      <code class="k">case</code> <code class="mi">5</code><code class="o">:</code>
        <code class="k">return</code> <code class="s2">"5.Fri"</code><code class="p">;</code>
      <code class="k">case</code> <code class="mi">6</code><code class="o">:</code>
        <code class="k">return</code> <code class="s2">"6.Sat"</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>This dimension (<code>dayOfWeek</code>) uses the same <code>facts</code> data, but when we return our key values we are going to return them as a combination of their numerical order (0 = Sunday etc) and their abbreviation (Sun = Sunday etc). This is essentially defining the categories of the values on the y axis for our row chart.</p>

<p>The code snippet looks a little strange, but think of it as extracting the numerical representation of the day of the week from our data (<code>var day = d.dtg.getDay();</code>) and then matching each number with an appropriate label (0 = ‘0.Sun’, 1 = ‘1.Mon’ etc). It’s these labels that are now our key values in our dimension.</p>

<p>Then we want to group the data by using the default action of the <code>.group()</code> function to count the number of events for each day of the week. </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">dayOfWeekGroup</code> <code class="o">=</code> <code class="nx">dayOfWeek</code><code class="p">.</code><code class="nx">group</code><code class="p">();</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-configure-the-row-chart-parameters">Configure the row chart parameters</h4>

<p>As with the previous charts, there are plenty of parameters that can be configured. The best way to learn what they do is still to have a play with them. So here is the block of code for configuring the row chart. Once you are happy that it works on your system, take some time and go through the settings in conjunction with the information from the <a href="http://nickqizhu.github.io/dc.js/">demo page</a> and the <a href="https://github.com/NickQiZhu/dc.js/wiki/API">api reference</a>.</p>

<p>This should go just before the block that configures the dataTable (again, this is just to try and keep the code in the same order as the graphs on the page).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// row chart day of week</code>
  <code class="nx">dayOfWeekChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">300</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">220</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">})</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">dayOfWeek</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">dayOfWeekGroup</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">colors</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category10</code><code class="p">())</code>
    <code class="p">.</code><code class="nx">label</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">){</code>
       <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s2">"."</code><code class="p">)[</code><code class="mi">1</code><code class="p">];</code>
    <code class="p">})</code>
    <code class="p">.</code><code class="nx">title</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;})</code>
    <code class="p">.</code><code class="nx">elasticX</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">xAxis</code><code class="p">().</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">4</code><code class="p">);</code>
</pre></div>

</figure>

<p>That should get you working. With the addition of this portion of the code, you should have a functioning visualization that can be filtered dynamically by clicking on the appropriate day of the week in your row chart. Just check to make sure that everything is working properly and we’ll go through some of the configuration options to see what they do.</p>

<p>To start with, your page should look something like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-29.png" alt="Web Page with Row Chart">
  <figcaption>Web Page with Row Chart</figcaption>
</figure>


<p>The configuration options start by declaring the name of the chart (<code>dayOfWeekChart</code>) and setting the height and width of the chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">dayOfWeekChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">300</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">220</code><code class="p">)</code>
</pre></div>

</figure>

<p>In the case of our example I have selected the width based on the default size for a <code>span4</code> grid segment in bootstrap and adjusted the height to make it look suitable.</p>

<p>Then we have our margins set up.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">margins</code><code class="p">({</code><code class="nx">top</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">})</code>
</pre></div>

</figure>

<p>Nothing too surprising there although I did reduce the top margin slightly more than I thought I would need. You can be the judge for your own charts.</p>

<p>Then we define which dimension and grouping we will use. </p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">dayOfWeek</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">dayOfWeekGroup</code><code class="p">)</code>
</pre></div>

</figure>

<p>For a row chart, think of the <code>.dimension</code> declaration being the y axis and the <code>.group</code> declaration being the x axis (the opposite to the previous charts).</p>

<p>We can set the range of colours to use one of the <a href="http://www.schneidy.com/Tutorials/ColorTutorial.html">standard palettes</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">colors</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category10</code><code class="p">())</code>
</pre></div>

</figure>

<p>Then we add the labels to our categories by splitting the key values (remember <code>0.Sun</code>, <code>1.Mon</code> etc) at the decimal point and returning the second part of the split value (which is the <code>Sun</code>, <code>Mon</code> part) as the label.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">label</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">){</code>
       <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s2">"."</code><code class="p">)[</code><code class="mi">1</code><code class="p">];</code>
     <code class="p">})</code>
</pre></div>

</figure>

<p>A cool way to prove this is to change the variable that returns the label to use the 1st part of the split value buy using a <code>[0]</code> instead of a <code>[1]</code> with code like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">label</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">){</code>
       <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s2">"."</code><code class="p">)[</code><code class="mi">0</code><code class="p">];</code>
     <code class="p">})</code>
</pre></div>

</figure>

<p>The end result produces…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-30.png" alt="Row Chart with the First Part of the Key Value">
  <figcaption>Row Chart with the First Part of the Key Value</figcaption>
</figure>


<p>The next line in the configuration adds a tool tip to our row chart using the value when the mouse hovers over the appropriate bar.</p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="p">.</code><code class="nx">title</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;})</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-31.png" alt="Row Chart Tool Tip">
  <figcaption>Row Chart Tool Tip</figcaption>
</figure>


<p>We can set the x axis to dynamically adjust when the number of events are filtered by selections on any of the other charts using the following configuration line.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">elasticX</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code>
</pre></div>

</figure>

<p>For instance if we select a subset of the earthquakes using our time / line chart, our row chart will have a corresponding selection of the appropriate days and the x axis will alter accordingly.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-32.png" alt="Selection Effect on Row Chart and Dynamic X Axis">
  <figcaption>Selection Effect on Row Chart and Dynamic X Axis</figcaption>
</figure>


<p>Lastly we set up our x axis with 4 ticks.</p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="p">.</code><code class="nx">xAxis</code><code class="p">().</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">4</code><code class="p">);</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-add-a-pie-chart">Add a Pie Chart.</h3>

<p>The pie chart provides an useful way of presenting and filtering on discrete values or identifiers similar to a row chart.</p>

<p>The pie chart that we’ll create will be a representation of which island the earthquakes occurred in. For those of you unfamiliar with the stunning landscape of New Zealand, there are two main islands creatively named North Island and South Island (stunning <em>and</em> practical!). The determination of what constitutes the North and South Island has been decided in a completely unscientific way (by me) by designating any area South of latitude -40.555907 and West of longitude 174.590607 as the South Island and anything else is the North Island.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-34.png" alt="Determination of North and South">
  <figcaption>Determination of North and South</figcaption>
</figure>


<p>The pie graph should end up looking a bit like this.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-35.png" alt="Pie Chart Example">
  <figcaption>Pie Chart Example</figcaption>
</figure>


<p>Good news! The pie chart shares the same cool feature as the row chart…</p>

<p>Click on one of the pie segments…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-36.png" alt="Selecting a Pie Segment">
  <figcaption>Selecting a Pie Segment</figcaption>
</figure>


<p>… and everything dynamically reflects the selection.  </p>

<p>Just as with the previous chart examples, we’ll work through adding the chart in the following stages.</p>

<ol class="numeric">
  <li>Position the chart</li>
  <li>Assign type</li>
  <li>Dimension and Group</li>
  <li>Configure chart parameters</li>
</ol>

<h4 id="leanpub-auto-position-the-pie-chart">Position the pie chart</h4>

<p>We are going to position our pie chart above our data table (and below the line chart) in the same row as the row chart in one of the blank <code>span4</code>’s.</p>

<p>The code that sets up that row should now look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'row'</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-dayweek-chart'</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Day of the Week<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-island-chart'</code><code class="p">&gt;</code>
	  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>North or South Island<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>   
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'blank2'</code><code class="p">&gt;</code>
	  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Blank 2<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code> 
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We’ve given it an ID selector of <code>dc-island-chart</code>. So when we assign our chart that selector, it will automatically appear in that position. We’ve also put another simple title in place (<code>&lt;h4&gt;North or South Island&lt;/h4&gt;</code>). </p>

<p>The last <code>span4</code> is still blank.</p>

<h4 id="leanpub-auto-assign-the-pie-chart-type">Assign the pie chart type</h4>

<p>Here we give our chart its name (<code>dayOfWeekChart</code>), assign it with a dc.js chart type (in this case <code>pieChart</code>) and assign it to the ID selector (<code>dc-dayweek-chart</code>).</p>

<p>Under the row that assigns the <code>dayOfWeekChart</code> chart…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">dayOfWeekChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">rowChart</code><code class="p">(</code><code class="s2">"#dc-dayweek-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… add in the equivalent for our pie chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">islandChart</code> <code class="o">=</code> <code class="nx">dc</code><code class="p">.</code><code class="nx">pieChart</code><code class="p">(</code><code class="s2">"#dc-island-chart"</code><code class="p">);</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-dimension-and-group-the-pie-chart-data">Dimension and group the pie chart data</h4>

<p>We’ll put the code between the dimension and group of the row chart and the data table dimension (this is just to try and keep the code in the same order as the graphs on the page).</p>

<p>When adding our dimension for our islands we want to provide an appropriate label so our code does the figuring out based on the latitude and longitude that we had established as the boundary between North and South.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">islands</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">lat</code> <code class="o">&lt;=</code> <code class="o">-</code><code class="mf">40.555907</code> <code class="o">&amp;&amp;</code> <code class="nx">d</code><code class="p">.</code><code class="kr">long</code> <code class="o">&lt;=</code> <code class="mf">174.590607</code><code class="p">)</code>
      <code class="k">return</code> <code class="s2">"South"</code><code class="p">;</code>
    <code class="k">else</code>
      <code class="k">return</code> <code class="s2">"North"</code><code class="p">;</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>This dimension (<code>islands</code>) uses the same <code>facts</code> data, but when we return our key values we are going to return them as either ‘North’ or ‘South’. To do this we employ a simple <code>if</code> statement with a little logic. These are the only two ‘slices’ for our pie chart.</p>

<p>Then we want to group the data by using the default action of the <code>.group()</code> function to count the number of events for each day of the week. </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">islandsGroup</code> <code class="o">=</code> <code class="nx">islands</code><code class="p">.</code><code class="nx">group</code><code class="p">();</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-configure-the-pie-chart-parameters">Configure the pie chart parameters</h4>

<p>There are fewer parameters that can be configured for pie charts, but we’ll still take the time to go through the options used here.</p>

<p>This code should go just before the block that configures the dataTable (again, this is just to try and keep everything in the same order as the graphs on the page).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">islandChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">250</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">220</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">radius</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">innerRadius</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">islands</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">islandsGroup</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">title</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;});</code>
</pre></div>

</figure>

<p>That should get the chart working. With the addition of this portion of the code, you should have a functioning visualization that can be filtered dynamically by clicking on the appropriate island in your pie chart. Just check to make sure that everything is working properly and we’ll go through some of the configuration options to see what they do.</p>

<p>To start with, your page should look something like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-37.png" alt="Web Page with Pie Chart">
  <figcaption>Web Page with Pie Chart</figcaption>
</figure>


<p>The configuration options start by declaring the name of the chart (<code>islandChart</code>) and setting the height and width of the chart.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">islandChart</code><code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="mi">250</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="mi">220</code><code class="p">)</code>
</pre></div>

</figure>

<p>In the case of our example I have selected the width based on the default size for a <code>span4</code> grid segment in bootstrap and adjusted the height to make it look suitable alongside the row chart.</p>

<p>Then we set up our inner and outer radii for our pie.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">radius</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">innerRadius</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code>
</pre></div>

</figure>

<p>This is fairly self explanatory, but by all means adjust away to make sure the chart suits your visualization.</p>

<p>Then we define which dimension and grouping we will use. </p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">islands</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">islandsGroup</code><code class="p">)</code>
</pre></div>

</figure>

<p>For a pie chart, the <code>.dimension</code> declaration is the discrete values that make up each segment of the pie and the <code>.group</code> declaration is the size of the pie.</p>

<p>The final line in the configuration adds a tool tip to our pie chart using the value when the mouse hovers over the appropriate slice.</p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="p">.</code><code class="nx">title</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">){</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;})</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-38.png" alt="Pie Chart Tool Tip">
  <figcaption>Pie Chart Tool Tip</figcaption>
</figure>


<div class="page-break"></div>
<h3 id="leanpub-auto-resetting-filters">Resetting filters</h3>

<p>Once you have made selections on some of your data dimensions, often you will want to reset those selections to return to a stable state.</p>

<p>For example, when selecting different days to display in the row chart, if you have three days selected as so…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-40.png" alt="Selected Elements in Row Chart">
  <figcaption>Selected Elements in Row Chart</figcaption>
</figure>


<p>… to return to the default setting where all the days are selected can be a bit of a pain.</p>

<p>Instead, we can use a dc.js ‘reset’ feature where a ‘reset’ label is generated to allow us revert to the starting condition.</p>

<p>There is a simple way to enable this feature, but we’ll take an additional few steps to make it look slightly better (and to learn some new tricks).</p>

<p>In the simplest method, this feature simply involves adding in the following code to the section where we add in the <code>row</code>s and <code>span</code>s when setting out our layout.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">a</code> <code class="na">class</code><code class="o">=</code><code class="s">"reset"</code>
  <code class="na">href</code><code class="o">=</code><code class="s">"javascript:dayOfWeekChart.filterAll();dc.redrawAll();"</code>
  <code class="na">style</code><code class="o">=</code><code class="s">"display: none;"</code><code class="p">&gt;</code>
  reset
<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>In the case of our example row chart, that would then look a bit like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-dayweek-chart'</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Day of the Week<code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">a</code> <code class="na">class</code><code class="o">=</code><code class="s">"reset"</code>
    <code class="na">href</code><code class="o">=</code><code class="s">"javascript:dayOfWeekChart.filterAll();dc.redrawAll();"</code>
    <code class="na">style</code><code class="o">=</code><code class="s">"display: none;"</code><code class="p">&gt;</code>
    reset
  <code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The additional code adds in a link (that’s the <code>&lt;a&gt;</code> tags) with a specific class that designates its function (the <code>class="reset"</code> part (this is what will let dc.js know what to do)). The link action (<code>href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();"</code>) provides the instructions on what to do when the ‘reset’ link is clicked on (in this case, we remove all the filters and redraw the dayOfWeekChart chart). Then there’s a nice touch to <em>not</em> display the word reset when the page first loads (<code>style="display: none;"</code>) before finally printing the word ‘reset’ on the page.</p>

<p>The end result (when a day of the week is selected) looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-41.png" alt="Reset Link for the Row Chart">
  <figcaption>Reset Link for the Row Chart</figcaption>
</figure>


<p>You can now click on the ‘reset’ link and the chart will revert to the default setting of all days selected.</p>

<h4 id="leanpub-auto-making-the-reset-label-a-little-bit-better-behaved">Making the reset label a little bit better behaved.</h4>

<p>While we now have our reset label working well, it’s a bit poorly behaved the way that it creates a new line to put the label on. We can do better than that.</p>

<p>It would be fair to say that this is as a result of the decision to use the <code>&lt;h4&gt;</code> heading tags to make our chart headings. There are other options that could be employed to avoid using these, but I like them, so I’ll describe how I kept them and kept the reset label on the same line.</p>

<p>None of what we’re about to do is remotely d3.js or dc.js related. It’s more HTML and CSS focussed (which doesn’t mean it’s not worth learning :-)).</p>

<p>The first thing we want to do is to get the ‘reset’ label onto the same line as our ‘Day of the Week’ heading. </p>

<p>This is simply done by ensuring that the <code>&lt;a&gt;</code> section is inside the <code>&lt;h4&gt;gt;</code> section. The code should therefore look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-dayweek-chart'</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Day of the Week
    <code class="p">&lt;</code><code class="nt">a</code> <code class="na">class</code><code class="o">=</code><code class="s">"reset"</code>
      <code class="na">href</code><code class="o">=</code><code class="s">"javascript:dayOfWeekChart.filterAll();dc.redrawAll();"</code>
      <code class="na">style</code><code class="o">=</code><code class="s">"display: none;"</code><code class="p">&gt;</code>
      reset
    <code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>(Notice how the code layout shows the <code>&lt;a&gt;</code> code nested inside the <code>&lt;h4&gt;</code> section?)</p>

<p>The result on the web page now looks like this when a day is selected;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-42.png" alt="Reset Link for the Row Chart on the Same Line">
  <figcaption>Reset Link for the Row Chart on the Same Line</figcaption>
</figure>


<p>That’s a good start and certainly more acceptable, but the styling for the ‘reset’ label still looks a bit ‘<strong>bold</strong>’ and ‘<em>BIG</em>’. We can do better than that.</p>

<p>What we’ll do is place our <code>&lt;a&gt;</code> tag information inside a <code>&lt;span&gt;</code> tag (this is the type of tag to use for in-line elements). Then we’ll set a CSS style in our <code>&lt;stlye&gt;</code> area to make any text that is inside a <code>&lt;span&gt;</code> which is inside a <code>&lt;h4&gt;</code> appear with formatting that makes it not bold and smaller in size.</p>

<p>First of all we place the <code>&lt;a&gt;</code> tag into a <code>&lt;span&gt;</code> container like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">'span4'</code> <code class="na">id</code><code class="o">=</code><code class="s">'dc-dayweek-chart'</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">h4</code><code class="p">&gt;</code>Day of the Week
    <code class="p">&lt;</code><code class="nt">span</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">a</code> <code class="na">class</code><code class="o">=</code><code class="s">"reset"</code>
        <code class="na">href</code><code class="o">=</code><code class="s">"javascript:dayOfWeekChart.filterAll();dc.redrawAll();"</code>
        <code class="na">style</code><code class="o">=</code><code class="s">"display: none;"</code><code class="p">&gt;</code>
        reset
      <code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">h4</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Then we create a section at the start of our file (under the <code>&lt;style type="text/css"&gt;&lt;/style&gt;</code> line looks like the right place) that declares the styling for our h4 span text. It should look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
  <code class="nt">h4</code> <code class="nt">span</code> <code class="p">{</code>
    <code class="nb">font-size</code><code class="o">:</code><code class="m">14px</code><code class="p">;</code>
    <code class="nb">font-weight</code><code class="o">:</code><code class="nb">normal</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>That tells our web page that any <code>h4</code>, <code>span</code> labelled text should be <code>14px</code> in size and not bold (or <code>normal</code>).</p>

<p>The end result when you now have a day of the week selected looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-43.png" alt=" Nicer Looking Reset Link for the Row Chart on the Same Line">
  <figcaption> Nicer Looking Reset Link for the Row Chart on the Same Line</figcaption>
</figure>


<h3 id="leanpub-auto-reset-all-the-charts">Reset all the charts</h3>

<p>We also have the option to reset all the charts at once. This could also be accomplished by reloading the page, but that would also incur a time and bandwidth penalty because the associated data would be downloaded again. So just resetting everything in the browser is a good feature.</p>

<p>Again dc.js has got our back. </p>

<p>This feature is treated like a separate chart in itself, so it has a dimension and group and a section to draw the chart (not that it’s a chart, but I’m sure you get the idea). It’s executed slightly differently, but it’s not too tricky.</p>

<p>What we’re going to aim to do is provide our page with a title and add some nice dc.js trickery alongside that looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-44.png" alt="Reset All with Count Beside Page Title">
  <figcaption>Reset All with Count Beside Page Title</figcaption>
</figure>


<p>The trickery shows us the number of selected records accompanied with the total number of records and gives us the option to reset all the selected charts so that all the records are selected.</p>

<p>There are 4 pieces of code that we will add to accomplish this task. We won’t add them from top to bottom, because it makes slightly more sense to explain them in a different order.</p>

<p>First of all we will add the block of code that declares the variable that includes all of our data values (facts).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">all</code> <code class="o">=</code> <code class="nx">facts</code><code class="p">.</code><code class="nx">groupAll</code><code class="p">();</code>
</pre></div>

</figure>

<p>This piece of code should go soon after the line that initialises the crossfilter process (<code>var facts = crossfilter(data);</code>).</p>

<p>Then we will include a section of code that dimensions and counts all of our facts. It also anchors the values to the <code>dc-data-count</code> ID Selector that we will set up in a moment.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// count all the facts</code>
  <code class="nx">dc</code><code class="p">.</code><code class="nx">dataCount</code><code class="p">(</code><code class="s2">".dc-data-count"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">dimension</code><code class="p">(</code><code class="nx">facts</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">group</code><code class="p">(</code><code class="nx">all</code><code class="p">);</code>
</pre></div>

</figure>

<p>This block of code belongs in the section that sets up our charts, although you could be forgiven for thinking that it kind of straddles more than one section.</p>

<p>The next section we’ll add will be our title along with the count and reset information. It looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"dc-data-count"</code> <code class="na">style</code><code class="o">=</code><code class="s">"float: left;"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;</code>New Zealand Earthquakes
      <code class="p">&lt;</code><code class="nt">span</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"filter-count"</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
         selected out of 
        <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"total-count"</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
         records | 
        <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">"javascript:dc.filterAll(); dc.renderAll();"</code><code class="p">&gt;</code>Reset All<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This block needs to go at the top of our area in the file where the layout of the portions of the web page are being set out. Put it directly under the outermost <code>container</code> <code>div</code> line (<code>&lt;div class='container' style='font: 12px sans-serif;'&gt;</code>).</p>

<p>It places a <code>&lt;h2&gt;</code> heading with the text ‘New Zealand Earthquakes’ and then places, in-line with this, five additional pieces. The first is a count of the filtered <code>facts</code> via… </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"filter-count"</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Then there is the text ‘ selected out of ‘ followed by a count of the total number of <code>facts</code> via…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"total-count"</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The some more text ‘ records | ‘ and then another JavaScript call (as a link) that allows us to reset all the chart elements via…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">"javascript:dc.filterAll(); dc.renderAll();"</code><code class="p">&gt;</code>Reset All<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This is all well and good, but the formatting will look a bit strange (like the following).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-45.png" alt="Reset All with Count Beside Page Title Poorly Formatted">
  <figcaption>Reset All with Count Beside Page Title Poorly Formatted</figcaption>
</figure>


<p>This tells us that we need to apply some styling to the elements alongside the title. We can do this with the following CSS elements which can go into the <code>&lt;style&gt;</code> block with the one we added earlier for the other reset block.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    h2 {
      float: right;
	  }
    h2 span {
      font-size:14px;
      font-weight:normal;
      }
</pre></div>

</figure>

<p>These will allow the <code>&lt;h2&gt;</code> heading to be left justified and will reduce the size of the in-line span and remove the ‘bold’ formatting.</p>

<p>Et viola!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/cross-44.png" alt=" Nicer Looking Title with Count / Reset Information">
  <figcaption> Nicer Looking Title with Count / Reset Information</figcaption>
</figure>


<h2 id="leanpub-auto-using-bootstrap-with-d3js">Using Bootstrap with d3.js</h2>

<p>Visualising data on a web page is a noble pursuit in itself, but often there is a need to be able to associate the visualization with other content (I know! It came as a surprise to me as well). </p>

<p>Developing a web page has become an activity that just about anyone can accomplish for better of for worse and I’m not going to claim to demonstrate any mastery of design or artistic flair. However, I have found using Bootstrap is a great way to make structural arrangements to a web page, it’s simple to use and there is a fantastic range of features that can provide additional functionality to your pages and sometimes more importantly, a consistent ‘feel’ across <em>many</em> pages.</p>

<aside class="warning blurb">
    <p>The syntax used for the Bootstrap code in this section is compatible with version 3.x. Previous versions of this book described the process using version 2.x so if there is some degree of confusion and you think is could be because you are using an older version of Bootstrap, I recommend that you move to version 3.x.</p>

</aside>

<p>Bootstrap can be found <a href="http://getbootstrap.com/">here</a> and I thoroughly recommend working your way through the site to discover some of the cool things that it can do.</p>

<h3 id="leanpub-auto-what-is-bootstrap">What is Bootstrap?</h3>

<p>Twitter Bootstrap is a free collection of tools for creating websites and web applications. It contains HTML and CSS based design templates for typography, forms, buttons, charts, navigation and other interface components, as well as optional JavaScript extensions.</p>

<p>Bootstrap was developed by Mark Otto and Jacob Thornton at Twitter as a framework to encourage consistency across internal tools. The word ‘framework’ is probably the best descriptive term, since it’s purpose is to provide structure to content. Perhaps in a similar way that d3.js provides structure to data.</p>

<p>Some of Bootstrap’s most important features include;</p>

<ul>
  <li>A layout grid</li>
  <li>Interface components</li>
</ul>

<div class="page-break"></div>
<h4 id="leanpub-auto-layout-grid">Layout grid</h4>

<p>Bootstrap includes 4 standard pixel width grid layout schemas which allow you to quickly arrange a page structure. This allows you to plan and implement what you’re going to place on the page with a minimum of fuss. You can change any of the pre-set options if you wish and you can also implement a ‘fluid’ row option where bootstrap will dynamically size a column’s width using a percentage instead of a fixed pixel value.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-01_ngn.png" alt="Bootstrap example page">
  <figcaption>Bootstrap example page</figcaption>
</figure>


<p>It’s this feature that first attracted me to using Bootstrap and while I may be using a complex tool for a simple task, it does that task very well.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-interface-components">Interface components</h4>

<p>A large number of interface components are also provided. These include standard buttons…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-02_ngn_01.png" alt="Bootstrap Standard Buttons">
  <figcaption>Bootstrap Standard Buttons</figcaption>
</figure>


<p>… tables…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-02_ngn_02.png" alt="Bootstrap Tables">
  <figcaption>Bootstrap Tables</figcaption>
</figure>


<p>… labels…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-02_ngn_03.png" alt="Bootstrap Labels">
  <figcaption>Bootstrap Labels</figcaption>
</figure>


<div class="page-break"></div>
<p>… drop-down menus…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-02_ngn_04.png" alt="Bootstrap Drop-down menus">
  <figcaption>Bootstrap Drop-down menus</figcaption>
</figure>


<p>… navigation controls…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-02_ngn_05.png" alt="Bootstrap Navbars">
  <figcaption>Bootstrap Navbars</figcaption>
</figure>


<p>… alerts…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-02_ngn_06.png" alt="Bootstrap Alerts">
  <figcaption>Bootstrap Alerts</figcaption>
</figure>


<p>… and to be perfectly honest, the list goes on and on.</p>

<p>There is a dizzying array of options available for web designers and while I encourage you to use them, I can’t promise to explain the nuances of their use, since I’m a humble journeyman in this world :-).</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-incorporating-bootstrap-into-your-html-code">Incorporating Bootstrap into your html code.</h3>

<p>Bootstrap is a remarkably flexible product. We could be forgiven for thinking that the process of installing it would be difficult. However, in the spirit of keeping things simple, we’ll make the process crude, but effective.</p>

<p>You could easily just follow along with the instructions on the ‘<a href="http://getbootstrap.com/getting-started/">getting started</a>’ page (and I recommend you do). But the following are important points. </p>

<p>Make sure you remember that you will need to download the appropriate scripts from the ‘<a href="http://twitter.github.io/bootstrap/getting-started.html">getting started</a>’ page.;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-06_ngn.png" alt="Bootstrap Download ">
  <figcaption>Bootstrap Download </figcaption>
</figure>


<p>You will need to copy the <code>bootstrap.js</code> file (or the minimised version (<code>bootstrap.min.js</code>)) to a place where it can be reached and loaded by your script. While you’re there, you will need to include a line to load the jquery.js file (which is a dependency of Bootstrap (not that it gets talked about much)) The following two lines, included with the line that loads d3.js, would do the job nicely (assuming that you’ve copied the <code>bootstrap.min.js</code> file into the <code>js</code> directory);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://code.jquery.com/jquery.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"js/bootstrap.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>If we wanted to we could load Bootstrap the same way that we are loading jquery.js (off the Internet each time we load a page). To do this we could use;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://code.jquery.com/jquery.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code>
  <code class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This is the way we will try to form our code in the coming examples to make the scripts as location independent as possible.</p>

<aside class="tip blurb">
    <p>Make sure that the jquery line comes <strong>before</strong> the bootstrap line, because it won’t work the other way round.</p>

</aside>

<p>You will also need to copy the bootstrap.css (or the minimised version (<code>bootstrap.min.css</code>)) to a place where it can be reached and loaded by your script. The following lines show it being loaded from the css directory with the line that loads the script in the <code>&lt;head&gt;</code> section.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
	
<code class="p">&lt;</code><code class="nt">link</code> <code class="na">href</code><code class="o">=</code><code class="s">"css/bootstrap.min.css"</code> <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> <code class="na">media</code><code class="o">=</code><code class="s">"screen"</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Or again we could load it from the Internet as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
	
<code class="p">&lt;</code><code class="nt">link</code> <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> <code class="na">href</code><code class="o">=</code>
 <code class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"</code>
<code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>That should be all that’s required! Of course as I mentioned earlier, there are plenty of other plug-in scripts that could be loaded to do fancy things with your web page, but we’re going to try and keep things simple.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-arranging-more-than-one-graph-on-a-web-page">Arranging more than one graph on a web page.</h3>

<p>We’ll start with the presumption that we want to be able to display two separate graphs on the same web page. The example we will use is clearly contrived, but we should remember that it’s the process we’re interested in this case, not the content. </p>

<h4 id="leanpub-auto-first-make-a-page-with-two-graphs">First make a page <em>with</em> two graphs</h4>

<p>This is surprisingly easy. If you start with the simple graph that we initially used as our learning example at the start of the book, and duplicate the section that looks like the following, you are 99% of the way there.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// Adds the svg canvas</code>
<code class="kd">var</code>	<code class="nx">chart2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
		
<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data2.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
	<code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
		<code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
	<code class="p">});</code>

	<code class="c1">// Scale the range of the data</code>
	<code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
	<code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

	<code class="c1">// Add the valueline path.</code>
	<code class="nx">chart2</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>

	<code class="c1">// Add the X Axis</code>
	<code class="nx">chart2</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

	<code class="c1">// Add the Y Axis</code>
	<code class="nx">chart2</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
		<code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>For simplicity, the full code for this graph can also be found on <a href="https://gist.github.com/d3noob/5987480">github</a> or in the code samples bundled with this book (two-graphs-one-anchor.html, data-1.csv and data-2.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/5987480">bl.ocks.org</a>.</p>

<p>The differences from the original simple graph example are;</p>

<ul>
  <li>The graphs are slightly smaller (to make it easier to display the graphs as they move about).</li>
  <li>I have used *.csv files for the data and there are two different data files so that they look different and we can differentiate between the graphs.</li>
  <li>Most importantly, I have declared the two charts with different variable names (one as <code>chart1</code> and the other as <code>chart2</code>).</li>
</ul>

<p>The different variable names are important, because if you leave them with the same identifier, the web page decides that what you’re trying to do is to put all your drawing data into the same space. The end result is two graphs trying to occupy the same space and looks a bit like this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-02a.png" alt="Two Simple Graphs Mashed">
  <figcaption>Two Simple Graphs Mashed</figcaption>
</figure>


<p>The example with the correct (different) variable labels <em>should</em> look a little like this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-03.png" alt="Two Simple Graphs">
  <figcaption>Two Simple Graphs</figcaption>
</figure>


<h4 id="leanpub-auto-arrange-the-graphs-with-the-same-anchor">Arrange the graphs with the same anchor</h4>

<p>The first thing I want to point out about how the graphs are presented is that they are both ‘attached’ to the same point on our web page. Both of the graphs select the body of the web page and then append a svg element to it;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">chart2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
</pre></div>

</figure>

<p>This has the effect of appending the graphs to the <em>same</em> anchor point. Interestingly, if we narrow the window of our web browser to less that the width of both of our graphs side by side, the browser will automatically move one of the graphs to a position below the first in much the same way that text will wrap on a page.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-04.png" alt="Two Simple Graphs Wrapping">
  <figcaption>Two Simple Graphs Wrapping</figcaption>
</figure>


<p>For a very simple mechanism of putting two graphs (or any two d3.js generated images) on a single page, this will work, but we don’t have a lot of control over the positioning.</p>

<h4 id="leanpub-auto-arrange-the-graphs-with-separate-anchors">Arrange the graphs with separate anchors</h4>

<p>To gain a little more control over where the graphs are placed we will employ ID selectors.</p>

<p>An ID selector is a way of naming an anchor point on an HTML page. They can be defined as “<em>a unique identifier to an element</em>”. This means that we can name a position on our web page and then we can assign our graphs to those positions.</p>

<p>This can be done simply by placing <code>div</code> tags in our html file in an appropriate place (here I’ve put them in between  the <code>&lt;style&gt;</code> section and the <code>&lt;body&gt;</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"area1"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"area2"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>Remembering that the &lt;div&gt; tag defines a division or a section in an HTML document. Therefore we are labelling specific sections in our web page.</p>

</aside>

<p>Now all we need to do is to tell each graph to append itself to either of these ID selectors. We do this by replacing the selected section in our JavaScript code with the appropriate ID selector as follows; </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">chart1</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#area1"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
</pre></div>

</figure>

<p>… and …</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">chart2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#area2"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
</pre></div>

</figure>

<aside class="information blurb">
    <h4 id="leanpub-auto-a-couple-of-points-to-note">A couple of points to note:</h4>

  <p>When we reference our ID selectors in the code (other than when we we set them with <code>id="area1"</code>) we need to put a hash (<code>#</code>) in front of the selector for the HTML to recognise it. </p>

  <p>We can only use a single ID selector in a single place. This might sound like common sense, but whatever the temptation, don’t go trying to assign the same ID selector to more than one place (You can certainly assign more than one item <em>to</em> an ID selector (for instance, you could append <code>chart2</code> to <code>area1</code> (<code>var	chart2 = d3.select("#area1")</code>) but an ID selector is a <strong><em>unique</em></strong> identifier of a position.).</p>

</aside>

<p>With these divs added, when you browse to the file, you will find that it looks like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-05.png" alt="Two Simple Graphs with divs">
  <figcaption>Two Simple Graphs with divs</figcaption>
</figure>


<p>This looks the same as when the two graphs were wrapping when the browser was narrowed. However, this time the browser is wide enough to support the two side by side, but they won’t position themselves that way. This is because each div <em>di</em>vides the web page. The top graph is in the div with the ID selector <code>area1</code> and the bottom graph is in the div with the ID selector <code>area2</code>. These divs effectively extend for the width of the web page.</p>

<p>The situation that we now find ourselves in is that we have control over where the graphs will be anchored, but we don’t have much flexibility for arranging those anchors. This is where Bootstrap comes in.  </p>

<div class="page-break"></div>
<h3 id="leanpub-auto-how-does-bootstraps-grid-layout-work">How does Bootstrap’s grid layout work</h3>

<p>Bootstrap’s grid layout subdivides the page by using rows and columns. A row will extend horizontally and a web page can be thought of as being 12 columns wide. Each column is a place to put horizontally separated content.</p>

<p>In order to make the best use of variable width devices, Bootstrap employs four different types of columns;</p>

<ul>
  <li>Extra small devices (phones): With a horizontal resolution of less than 768px, Bootstrap reccomends we use <code>col-xs-</code>.</li>
  <li>Small devices (Tablets): With a horizontal resolution of greater than or equal to 768px, Bootstrap reccomends we use <code>col-sm-</code>.</li>
  <li>Medium devices (Desktops):With a horizontal resolution of greater than or equal to 992px, Bootstrap reccomends we use <code>col-md-</code>.</li>
  <li>Large devices (Desktops): With a horizontal resolution of greater than or equal to 1200px, Bootstrap reccomends we use <code>col-lg-</code>.</li>
</ul>

<p>The examples we’ll employ will use <code>col-md-</code>, but you should choose based on your anticipated needs.</p>

<p>Each column will have a width designated by a number at the end of our column designator. This will be the width in terms of the number of columns in the row.. For example <code>col-md-4</code> would be a single column 4 units wide (remember the row is a maximum of 12 possible units wide).</p>

<p>As an example, the picture below shows a single row divided into twelve individual columns.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-07_ngn.png" alt="Simple Bootstrap Layout with 12 columns">
  <figcaption>Simple Bootstrap Layout with 12 columns</figcaption>
</figure>


<p>The columns can be combined to create larger spaces for larger content. The example below has a single <code>col-md-6</code> and two <code>col-md-3</code>’s.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-08_ngn.png" alt="Simple Bootstrap Layout with one column 6 and two column 3's">
  <figcaption>Simple Bootstrap Layout with one column 6 and two column 3’s</figcaption>
</figure>


<p>The column’s will change height dynamically to fit their contents. So if there was a larger item in the <code>col-md-6</code> example given above (perhaps a graph), it would expand like so;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-09_ngn.png" alt="Simple Bootstrap Layout with Content">
  <figcaption>Simple Bootstrap Layout with Content</figcaption>
</figure>


<p>The way to set these rows and columns up is by <em>div</em>iding the screen using divs and assigning them class types that match the grid layout.</p>

<p>For example, to create our example of a single row with a <code>col-md-6</code> and two <code>col-md-3</code>’s we would use the following html code as our baseline.  </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-6"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-3"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-3"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>In this example code we can see the <code>row</code> div is enclosing the three columns. We can extend the comparison by putting the code into our graphic example.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-10_ngn.png" alt="Simple Bootstrap Layout with Content and Code">
  <figcaption>Simple Bootstrap Layout with Content and Code</figcaption>
</figure>


<p>To add content to the structure, all that is needed is to put our web page components between the <code>&lt;div class="col-md-x"&gt;</code> and <code>&lt;/div&gt;</code> tags.</p>

<p>Later we will look (briefly) at more complex configurations that might be useful. </p>

<h4 id="leanpub-auto-arrange-more-than-one-d3js-graph-with-bootstrap">Arrange more than one d3.js graph with Bootstrap</h4>

<p>In the previous sections we have seen how to assign ID selectors so that we anchor our d3.js graphs to a particular section of our web page. We have also seen how to utilise Bootstrap to divide up our web page into different sections. Now we will bring the two examples together and assign ID selectors to sections set up with Bootstrap.</p>

<p>We will start with our simple two graph example (as seen on <a href="http://bl.ocks.org/d3noob/raw/5987480/">bl.ocks.org here</a>).</p>

<p>We will need to  make sure we have our <code>bootstrap.min.js</code> and <code>bootstrap.min.css</code> files in the appropriate place.</p>

<p>Then insert the code to use <code>bootstrap.min.css</code> at the start of the file (just before the <code>&lt;style&gt;</code> tag would be good);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
	
<code class="p">&lt;</code><code class="nt">link</code> <code class="na">rel</code><code class="o">=</code><code class="s">"stylesheet"</code> <code class="na">href</code><code class="o">=</code>
 <code class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"</code>
<code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Then include the lines to load the <code>jquery.js</code> and <code>bootstrap.min.js</code> files just after the line that loads the <code>d3.js</code> file.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="o">&lt;</code><code class="nx">script</code> <code class="nx">src</code><code class="o">=</code><code class="s2">"http://code.jquery.com/jquery.js"</code><code class="o">&gt;&lt;</code><code class="err">/script&gt;</code>
<code class="o">&lt;</code><code class="nx">script</code> <code class="nx">src</code><code class="o">=</code>
  <code class="s2">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="err">/script&gt;</code>
</pre></div>

</figure>

<p>What we’ll do to make things simple is to create a Bootstrap layout that is made up of a single row with just two <code>col-md-6</code> elements in it. The following code will do this nicely and should go after the <code>&lt;/style&gt;</code> tag and before the <code>&lt;body&gt;</code> tag.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-6"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-6"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Now we add in our ID selectors in a clever way by incorporating them into the divs that we have just entered. So remembering the code for our original two selectors…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"area1"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"area2"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>… we can incorporate these into our row and columns as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-6"</code> <code class="na">id</code><code class="o">=</code><code class="s">"area1"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-6"</code> <code class="na">id</code><code class="o">=</code><code class="s">"area2"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The last thing we need to do is to change the <code>d3.select</code> from selecting the <code>body</code> of the web page to selecting our two new ID selectors <code>area1</code> and <code>area2</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">chart1</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#area1"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
</pre></div>

</figure>

<p>… and …</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">chart2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#area2"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Et viola! Our new web page has two graphs which are settled into their own specific section.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-11.png" alt="Simple Bootstrap Layout Example with Graphs">
  <figcaption>Simple Bootstrap Layout Example with Graphs</figcaption>
</figure>


<p>To provide another example of the flexibility of the layout schema, we can take our row / column layout section and adapt it so that our graphs are in two separate sections with a third, smaller, section in the middle describing the graphs.</p>

<p>If we start with our previously entered columns with their ID selectors;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-6"</code> <code class="na">id</code><code class="o">=</code><code class="s">"area1"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-6"</code> <code class="na">id</code><code class="o">=</code><code class="s">"area2"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We can change the columns to <code>col-md-5</code> and add an additional <code>col-md-2</code> in between with some text (remember, the total number of columns has to add up to 12).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-5"</code> <code class="na">id</code><code class="o">=</code><code class="s">"area1"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-2"</code><code class="p">&gt;</code> 
    To the left is a graph showing the anticipated profits
    of the 'Widget Incorporated' company.
    On the right is the anticipated cost of production as 
    the number of Widgets is increased.
    Clearly we will be RICH!
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-5"</code> <code class="na">id</code><code class="o">=</code><code class="s">"area2"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>And the end result is…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-12.png" alt="Simple Bootstrap Layout with Graphs and Text">
  <figcaption>Simple Bootstrap Layout with Graphs and Text</figcaption>
</figure>


<p>Neither of these examples is particularly elegant in terms of its layout. I am relying on you to bring the prettiness!</p>

<p>The full code for this final graph and paragraph combination can also be found on <a href="https://gist.github.com/d3noob/6a3b59149cf3ebdb3fc4">github</a> or in the code samples bundled with this book (two-graphs-bootstrap.html, data-1.csv and data-2.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/6a3b59149cf3ebdb3fc4">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-a-more-complicated-bootstrap-layout-example">A more complicated Bootstrap layout example</h4>

<p>As promised earlier, it’s worth looking at a more complex example for a layout with Bootstrap, just to get a feel for how it works or the potential it might have for you.</p>

<p>The example code layout we will design will look a bit like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-13_ngn.png" alt="More Complicated Bootstrap Layout">
  <figcaption>More Complicated Bootstrap Layout</figcaption>
</figure>


<p>It looks slightly complex with a nesting of columns and rows, and the end result is only 5 separate sections, but it’s really not too hard to put together if you start in the right place and build it up piece by piece.</p>

<p>We’ll start in the middle and work our way out. The first piece to consider is the two side-by-side <code>col-md-4</code>’s.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-14_ngn.png" alt="Two col-md-4's">
  <figcaption>Two col-md-4’s</figcaption>
</figure>


<p>The code for these is just…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Directly under that row is another with a single <code>col-md-8</code>. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-15_ngn.png" alt="A Single col-md-8">
  <figcaption>A Single col-md-8</figcaption>
</figure>


<p>The code for this section is…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<p>Both of these rows together look like this;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-16_ngn.png" alt="Two Stacked rows">
  <figcaption>Two Stacked rows</figcaption>
</figure>


<p>And the code is just one piece after the other.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-n4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<p>Because this entire block forms part of another (larger) row, we need to enclose it in its own <code>col-md-8</code> (since this is part is only <code>col-md-8</code> wide).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-17_ngn.png" alt="Enclosed Stacked rows">
  <figcaption>Enclosed Stacked rows</figcaption>
</figure>


<p>And for the code the new <code>col-md-8</code> div wraps all the current code we have.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<p>The <code>col-md-8</code> is alongside a large <code>col-md-4</code> that sits to the left.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-18_ngn.png" alt="col-md-4 plus Complex col-md-8">
  <figcaption>col-md-4 plus Complex col-md-8</figcaption>
</figure>


<p>This requires another <code>col-md-4</code> div to be placed before the <code>col-md-8</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<p>The <code>col-md-4</code> and the complex <code>col-md-8</code> need to be in their own row…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-19_ngn.png" alt="col-md-4 plus Complex col-md-8 in a `row`">
  <figcaption>col-md-4 plus Complex col-md-8 in a <code>row</code></figcaption>
</figure>


<p>So a <code>row</code> div encloses all the code we have so far.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<p>Finally we need to place another row with a <code>col-md-12</code> in it above our current work.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/bootstrap-13_ngn.png" alt="More Complicated Bootstrap Layout">
  <figcaption>More Complicated Bootstrap Layout</figcaption>
</figure>


<p>Again, we need to place the row and column before our current code so that it appears <em>above</em> the current code on the page.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-12"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-4"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"row"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"col-md-8"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>There we have it!</p>

<p>Slightly more complex, but if you needed a heading, a sidebar, a couple of graphs and some explanatory text, that might be exactly what you were looking for :-).</p>

<h2 id="leanpub-auto-mysql-tips-and-tricks-for-d3js">MySQL Tips and Tricks for d3.js</h2>

<h3 id="leanpub-auto-using-a-mysql-database-as-a-source-of-data">Using a MySQL database as a source of data.</h3>

<h4 id="leanpub-auto-php-is-our-friend">PHP is our friend</h4>

<p>As outlined at the start of the book, PHP is commonly used to make web content dynamic. We are going to use it to do exactly that by getting it to glue together our d3.js JavaScript and a MySQL Database. The end result should be a web page that will leverage the significant storage capability of a MySQL database and the ability to vary different aspects of returned data. </p>

<aside class="information blurb">
    <p>If you’re wondering what level we’re going to approach this at, let me reassure (or horrify) you that it will be in the same vein as the rest of this book. I am no expert in MySQL databases, but through a bit of trial and error I have been able to achieve a small measure of success. Hopefully the explanation is sufficient for beginners like myself and doesn’t offend any best practices :-).</p>

</aside>

<h4 id="leanpub-auto-phpmyadmin">phpMyAdmin</h4>

<p>I’m not one to dwell on the command line for too long if it can be avoided (sorry). So in this section you’ll see me delving into a really neat program for managing your MySQL database called phpMyAdmin (http://www.phpmyadmin.net/home_page/index.php). </p>

<p>As the name would suggest, it’s been written in PHP and as we know, that’s a sign that we’re talking about a web based application. In this case phpMyAdmin is intended to allow a wide range of administrative operations with MySQL databases via a web browser. You can find a huge amount of information about it on the web as it is a freely available robust platform that has been around for well over a decade.</p>

<p>If you have followed my suggestion earlier in the book to install <a href="http://www.wampserver.com/en/">WAMP</a> or you have  phpMyAdmin installed already you’re in luck. If not, I’m afraid that I won’t be able to provide any guidance on its installation. I just don’t have the experience to provide that level of support.</p>

<h4 id="leanpub-auto-create-your-database">Create your database</h4>

<p>Assuming that you do have WAMP installed, you will be able to access a subset of its functions from the icon on your system tray in the lower right hand corner of your screen.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database01.png" alt="The WAMP server icon">
  <figcaption>The WAMP server icon</figcaption>
</figure>


<p>Clicking on this icon will provide you with a range of options, including opening phpMyAdmin. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database02.png" alt="Opening phpMyAdmin">
  <figcaption>Opening phpMyAdmin</figcaption>
</figure>


<p>Go ahead and do this and the phpMyAdmin page will open in your browser.</p>

<p>The page you’re presented with has a range of tabs, and we want to select the ‘Databases’ tab.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database03.png" alt="The Databases tab">
  <figcaption>The Databases tab</figcaption>
</figure>


<p>From here we can create ourselves a new database simply by giving it a name and selecting ‘Create’.  I will create one called ‘homedb’.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database04.png" alt="Give our new database a name">
  <figcaption>Give our new database a name</figcaption>
</figure>


<p>That was simple!</p>

<p>On the panel on the left hand side of the screen is our new database. Go on and click on it.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database05.png" alt="Open the homedb database">
  <figcaption>Open the homedb database</figcaption>
</figure>


<p>Cool, now we get to create a table. What’s a table? Didn’t we create our database already?</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-databases-and-tables">Databases and Tables</h3>
  <p>Ahh yes… Think of databases as large collections of data (yes, I can smell the irony). Databases can have a wide range of different information stored in them, but sometimes the data isn’t strictly connected. For instance, a business might want to store its inventory and personnel records in a database. Trying to mash all that together would be a bit of a nightmare to manage. Instead, we can create two different tables of information. Think of a table as a spreadsheet with rows of data for specific columns. If we want to connect the data at some point we can do that via the process of querying the database.</p>

</aside>

<p>So, lets create a table called data2 with three columns.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database06.png" alt="Create a table">
  <figcaption>Create a table</figcaption>
</figure>


<p>I’ve chosen data2 as a name since we will put the same data as we have in the data2.tsv file in there. That’s why there are three columns for the date, close and open columns that we have in the data2.tsv file.</p>

<p>So, after clicking on the ‘Go’ button, I get the following screen where I get to enter all the pertinent details about what I will have in my table.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database07.png" alt="Format the table's columns">
  <figcaption>Format the table’s columns</figcaption>
</figure>


<p>I’m keeping it really simple by setting the ‘date’ column to be plain text (I make the presumption that  it could be a date format, but as it gets parsed into a date/time value when it’s ingested into D3, I’m fairly comfortable that we can get away with formatting it as ‘TEXT’), and the two numeric columns to be decimals with 8 digits overall and 2 of those places for the digits to the right of the decimal point.</p>

<aside class="information blurb">
    <p>The selection of the most efficient data type to maximise space or speed is something of an obsession (as it sometimes needs to be) where databases are large and need to have fast access times, but in this case we’re more concerned with getting a result than perfection.</p>

</aside>

<p>Once entered, you can scroll down to the bottom of that window and select the ‘Save’ button.</p>

<p>Cool, now you are presented with your table (click on the table name in the left hand panel) and the details of it in the main panel.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database08.png" alt="The details of the 'data2' table">
  <figcaption>The details of the ‘data2’ table</figcaption>
</figure>


<p>Sure it looks snazzy, but there’s something missing….. Hmm…..</p>

<p>Ah Ha! Data!</p>

<h4 id="leanpub-auto-importing-your-data-into-mysql">Importing your data into MySQL</h4>

<p>So, you’ve got a perfectly good database and an impeccably set up table looking for some data.</p>

<p>It’s time we did something about that.</p>

<p>In the vein of “Here’s one I prepared earlier”, what we will do is import a csv (Comma Separated Value) file into our database. To do this I prepared our data2.tsv file by replacing all the tabs with commas and removing the header line (with date, close and open on it), so it looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>1-May-12,58.13,34.12
30-Apr-12,53.98,45.56
27-Apr-12,67.00,67.89
26-Apr-12,89.70,78.54
25-Apr-12,99.00,89.23
24-Apr-12,130.28,99.23
23-Apr-12,166.70,101.34
20-Apr-12,234.98,122.34
19-Apr-12,345.44,134.56
18-Apr-12,443.34,160.45
17-Apr-12,543.70,180.34
16-Apr-12,580.13,210.23
13-Apr-12,605.23,223.45
12-Apr-12,622.77,201.56
11-Apr-12,626.20,212.67
10-Apr-12,628.44,310.45
9-Apr-12,636.23,350.45
5-Apr-12,633.68,410.23
4-Apr-12,624.31,430.56
3-Apr-12,629.32,460.34
2-Apr-12,618.63,510.34
30-Mar-12,599.55,534.23
29-Mar-12,609.86,578.23
28-Mar-12,617.62,590.12
27-Mar-12,614.48,560.34
26-Mar-12,606.98,580.12
</pre></div>

</figure>

<p>I know it doesn’t look quite as pretty, but csv files are pretty ubiquitous which is why so many different programs support them as an input and output file type. (To save everyone some time and trouble I have saved the data.csv file into the D3 Tips and Tricks example files folder (under data)).</p>

<p>So armed with this file, click on the ‘Import’ tab in our phpMyAdmin window and choose your file. </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database09.png" alt="Importing csv data into your table">
  <figcaption>Importing csv data into your table</figcaption>
</figure>


<p>The format should be automatically recognised and the format specific options at the bottom of the window should provide sensible defaults for the input. Let’s click on the ‘Go’ button and give it a try.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database10.png" alt="Successful import!">
  <figcaption>Successful import!</figcaption>
</figure>


<p>Woo Hoo!</p>

<p>Now if you click on the browse tab, there’s your data in your table!</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database11.png" alt="All the data successfully imported">
  <figcaption>All the data successfully imported</figcaption>
</figure>


<p>Sweet!</p>

<p>The last thing that we should do is add a user to our database so that we don’t end up accessing it as the root user (not too much of a good look).</p>

<p>So select the ‘homedb’ reference at the top of the window (between ‘localhost’ and ‘data2’).</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database12.png" alt="Select the 'homedb' database">
  <figcaption>Select the ‘homedb’ database</figcaption>
</figure>


<p>Then click on the ‘Privileges’ tab to show all the users who have access to ‘homedb’ and select ‘Add a new user’ </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database13.png" alt="The 'Privileges' tab">
  <figcaption>The ‘Privileges’ tab</figcaption>
</figure>


<p>Then on the new user create a user, use the ‘Local’ host and put in an appropriate password.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database14.png" alt="Enter the user information">
  <figcaption>Enter the user information</figcaption>
</figure>


<p>In this case, the user name is ‘homedbuser’ and the password is ‘homedbuser’ (don’t tell). </p>

<p>The other thing to do is restrict what this untrusted user can do with the database. In this case we can fairly comfortably restrict them to ‘SELECT’ only;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database15.png" alt="Restrict privileges to 'SELECT'">
  <figcaption>Restrict privileges to ‘SELECT’</figcaption>
</figure>


<p>Click on ‘Go’ and you have yourself a new user.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database16.png" alt="New user added!">
  <figcaption>New user added!</figcaption>
</figure>


<p>Yay!</p>

<p>Believe it or not, that’s pretty much it. There were a few steps involved, but they’re hopefully fairly explanatory and I don’t imagine there’s anything too confusing that a quick Googling can’t fix.</p>

<h4 id="leanpub-auto-querying-the-database">Querying the Database</h4>

<p>OK, are you starting to get excited yet? We’re just about at the point where we can actually use our MySQL database for something useful!</p>

<p>To do that we have to ask the database for some information and have it return that information in a format we can work with.</p>

<p>The process of getting information from a database is called ‘querying’ the database, or performing a ‘query’.</p>

<p>Now this is something of an art form in itself and believe me, you can dig some pretty deep holes performing queries. However, we’re going to keep it simple. All we’re going to do is query our database so that it returns the ‘date’ and the ‘close’ values. </p>

<p>We’ll start by selecting our ‘data2’ table and going to the ‘Browse’ tab.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database17.png" alt="To the 'Browse' tab">
  <figcaption>To the ‘Browse’ tab</figcaption>
</figure>


<p>We actually already have a query operating on our table. It’s the bit in the middle that looks like;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="o">*</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">data2</code><code class="o">`</code>
<code class="k">LIMIT</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">30</code>
</pre></div>

</figure>

<p>This particular query is telling the database <code>homedb</code> (since that’s where the query was run from) to <code>SELECT</code> everything (<code>*</code>) <code>FROM</code> the table <code>data2</code> and when we return the data, to <code>LIMIT</code> the returned information to those starting at record <code>0</code> and to only show <code>30</code> at a time.</p>

<p>You should also be able to see the data in the main body of the window.</p>

<p>So, let’s write our own query. We can ask our query in a couple of different ways. Either click on the ‘SQL’ tab and you can enter it there, or click on the menu link that says ‘Edit’ in the current window. I prefer the ‘Edit’ link since it opens a separate little window which let’s you look at the returned data and your query at the same time.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database18.png" alt="Enter your query">
  <figcaption>Enter your query</figcaption>
</figure>


<p>So here’s our window and in it I’ve written the query we want to run.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="o">`</code><code class="nb">date</code><code class="o">`</code><code class="p">,</code> <code class="o">`</code><code class="k">close</code><code class="o">`</code> <code class="k">FROM</code> <code class="o">`</code><code class="n">data2</code><code class="o">`</code>
</pre></div>

</figure>

<p>You will of course note that I neglected to put anything about the <code>LIMIT</code> information in there. That’s because it gets added automatically to your query anyway using phpMyAdmin unless you specify values in your query. </p>

<p>So in this case, our query is going to <code>SELECT</code> all our values of <code>date</code> and <code>close</code> <code>FROM</code> our table <code>data2</code>.</p>

<p>Click on the ‘Go’ button and let’s see what we get.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database19.png" alt="'date' and 'close' returned successfully">
  <figcaption>‘date’ and ‘close’ returned successfully</figcaption>
</figure>


<p>There we go!</p>

<p>If you’re running the query as ‘root’ you may see lots of other editing and copying and deleting type options. Don’t fiddle with them and they won’t bite.</p>

<p>Righto… That’s the query we’re going to use. If you look at the returned information with a bit of a squint, you can imagine that it’s in the same type of format as the *.tsv or *.csv files. (header at the top and ordered data underneath).</p>

<p>All that we need to do now is get our MySQL query to output data into d3.js.</p>

<p>Enter php!</p>

<h4 id="leanpub-auto-using-php-to-extract-json-from-mysql">Using php to extract json from MySQL</h4>

<p>Now’s the moment we’ve been waiting for to use php!</p>

<p>What we’re going to do is use a PHP script that performs the query that we’ve just identified to extract data out of the database and to format it in a way that we can input it into D3 really easily. The data format that we’re going to use for presenting to D3 is json (JavaScript Object Notation). You might remember it from the earlier chapter on types of data that could be ingested into D3.</p>

<p>Our PHP script is going to exist as a separate file which we will name <code>data2.php</code> and we will put it in a folder called <code>php</code> which will be in our web’s root directory (alongside the <code>data</code> directory).</p>

<p>Here’s the contents of our data.php file (This is reproduced in the appendices for those who prefer a stand alone version);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="o">&lt;?</code><code class="nx">php</code>
    <code class="nv">$username</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code> 
    <code class="nv">$password</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code>   
    <code class="nv">$host</code> <code class="o">=</code> <code class="s2">"localhost"</code><code class="p">;</code>
    <code class="nv">$database</code><code class="o">=</code><code class="s2">"homedb"</code><code class="p">;</code>
    
    <code class="nv">$server</code> <code class="o">=</code> <code class="nb">mysql_connect</code><code class="p">(</code><code class="nv">$host</code><code class="p">,</code> <code class="nv">$username</code><code class="p">,</code> <code class="nv">$password</code><code class="p">);</code>
    <code class="nv">$connection</code> <code class="o">=</code> <code class="nb">mysql_select_db</code><code class="p">(</code><code class="nv">$database</code><code class="p">,</code> <code class="nv">$server</code><code class="p">);</code>

    <code class="nv">$myquery</code> <code class="o">=</code> <code class="s2">"</code>
<code class="s2">SELECT  `date`, `close` FROM  `data2`</code>
<code class="s2">"</code><code class="p">;</code>
    <code class="nv">$query</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$myquery</code><code class="p">);</code>
    
    <code class="k">if</code> <code class="p">(</code> <code class="o">!</code> <code class="nv">$query</code> <code class="p">)</code> <code class="p">{</code>
        <code class="k">echo</code> <code class="nb">mysql_error</code><code class="p">();</code>
        <code class="k">die</code><code class="p">;</code>
    <code class="p">}</code>
    
    <code class="nv">$data</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>
    
    <code class="k">for</code> <code class="p">(</code><code class="nv">$x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$x</code> <code class="o">&lt;</code> <code class="nb">mysql_num_rows</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code> <code class="nv">$x</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="nv">$data</code><code class="p">[]</code> <code class="o">=</code> <code class="nb">mysql_fetch_assoc</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
    <code class="p">}</code>
    
    <code class="k">echo</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$data</code><code class="p">);</code>     
     
    <code class="nb">mysql_close</code><code class="p">(</code><code class="nv">$server</code><code class="p">);</code>
<code class="cp">?&gt;</code><code class="x"></code>
</pre></div>

</figure>

<p>This code can be found as the file <code>php-mysql.php</code> in the code samples bundled with this book on Leanpub.</p>

<p>It’s pretty short, but it packs a punch. Let’s go through it and see what it does.</p>

<p>The <code>&lt;?php</code> line at the start and the <code>?&gt;</code> line at the end form the wrappers that allow the requesting page to recognise the contents as php and to execute the code rather than downloading it for display.</p>

<p>The following lines set up a range of important variables;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nv">$username</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code> 
    <code class="nv">$password</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code>   
    <code class="nv">$host</code> <code class="o">=</code> <code class="s2">"localhost"</code><code class="p">;</code>
    <code class="nv">$database</code><code class="o">=</code><code class="s2">"homedb"</code><code class="p">;</code>
</pre></div>

</figure>

<p>Hopefully you will recognise that these are the configuration details for the MySQL database that we set up. There’s the user and his password (don’t worry, because the script isn’t returned to the browser, the browser doesn’t get to see the password and in this case our user has a very limited set of privileges remember). There’s the host location of our database (in this case it’s local, but if it was on a remote server, we would just include its address) and there’s the database we’re going to access.</p>

<p>Then we use those variables to connect to the server…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nv">$server</code> <code class="o">=</code> <code class="nb">mysql_connect</code><code class="p">(</code><code class="nv">$host</code><code class="p">,</code> <code class="nv">$username</code><code class="p">,</code> <code class="nv">$password</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and then we connect to the specific database;</p>

<figure class="code">
<div class="highlight"><pre><code></code> <code class="nv">$connection</code> <code class="o">=</code> <code class="nb">mysql_select_db</code><code class="p">(</code><code class="nv">$database</code><code class="p">,</code> <code class="nv">$server</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we have our query in a form that we can paste into the right spot and it’s easy to use.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nv">$myquery</code> <code class="o">=</code> <code class="s2">"</code>
<code class="s2">SELECT  `date`, `close` FROM  `data2`</code>
<code class="s2">"</code><code class="p">;</code>
</pre></div>

</figure>

<p>I have it like this so all I need to do to change the query I use is paste it into the middle line there between the speech-marks and I’m done. It’s just a convenience thing.</p>

<p>The query is then run against the database with the following command;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nv">$query</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$myquery</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and then we check to see if it was successful. If it wasn’t, we output the MySQL error code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="k">if</code> <code class="p">(</code> <code class="o">!</code> <code class="nv">$query</code> <code class="p">)</code> <code class="p">{</code>
        <code class="k">echo</code> <code class="nb">mysql_error</code><code class="p">();</code>
        <code class="k">die</code><code class="p">;</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>Then we declare the <code>$data</code> variable as an array (<code>$data = array();</code>) and feed the returned information from our query into <code>$data</code> array;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="k">for</code> <code class="p">(</code><code class="nv">$x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$x</code> <code class="o">&lt;</code> <code class="nb">mysql_num_rows</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code> <code class="nv">$x</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="nv">$data</code><code class="p">[]</code> <code class="o">=</code> <code class="nb">mysql_fetch_assoc</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>(that’s a fancy little piece of code that gets the information row by row and puts it into the array)</p>

<p>We then return (<code>echo</code>) the <code>$data</code> array in json format (<code>echo json_encode($data);</code>) into whatever ran the <code>data2.php</code> script (we’ll come back to this in a minute).</p>

<p>Then finally we close the connection to the server;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nb">mysql_close</code><code class="p">(</code><code class="nv">$server</code><code class="p">);</code>
</pre></div>

</figure>

<p>Whew!</p>

<p>That was a little fast and furious, but I want to revisit the point that we covered in the part about echoing the data back to whatever had requested it. This is because we are going to use it directly in our d3.js script, but we can actually run the script directly by opening the file in our browser.</p>

<p>So if you can navigate using your browser to this file and run it (WAMP should be your friend here again) this is what you should see printed out on your screen;</p>

<figure class="code">
<div class="highlight"><pre><code></code>[{"date":"1-May-12","close":"58.13"},
{"date":"30-Apr-12","close":"53.98"},
{"date":"27-Apr-12","close":"67.00"},
{"date":"26-Apr-12","close":"89.70"},
{"date":"25-Apr-12","close":"99.00"},
{"date":"24-Apr-12","close":"130.28"},
{"date":"23-Apr-12","close":"166.70"},
{"date":"20-Apr-12","close":"234.98"},
{"date":"19-Apr-12","close":"345.44"},
{"date":"18-Apr-12","close":"443.34"},
{"date":"17-Apr-12","close":"543.70"},
{"date":"16-Apr-12","close":"580.13"},
{"date":"13-Apr-12","close":"605.23"},
{"date":"12-Apr-12","close":"622.77"},
{"date":"11-Apr-12","close":"626.20"},
{"date":"10-Apr-12","close":"628.44"},
{"date":"9-Apr-12","close":"636.23"},
{"date":"5-Apr-12","close":"633.68"},
{"date":"4-Apr-12","close":"624.31"},
{"date":"3-Apr-12","close":"629.32"},
{"date":"2-Apr-12","close":"618.63"},
{"date":"30-Mar-12","close":"599.55"},
{"date":"29-Mar-12","close":"609.86"},
{"date":"28-Mar-12","close":"617.62"},
{"date":"27-Mar-12","close":"614.48"},
{"date":"26-Mar-12","close":"606.98"}]
</pre></div>

</figure>

<p>There it is! The data we want formatted as json!</p>

<p>It looks a bit messy on the printed page, but it’s bread and butter for JavaScript.</p>

<p>I have included the data2.php file in the examples zip file that can be downloaded from d3noob.org.</p>

<h4 id="leanpub-auto-getting-the-data-into-d3js">Getting the data into d3.js</h4>

<p>Let’s recap momentarily.</p>

<p>We have created a database, populated it with information, worked out how to extract a subset of that information and how to do it in a format that d3.js understands. Now for the final act!
And you will find it slightly deflating how simple it is.</p>

<p>All we have to do is take our simple-graph.html file and make the following change;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"php/data2.php"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
	<code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
		<code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
	<code class="p">});</code>
</pre></div>

</figure>

<p>Here we have replaced the part of the code that read in the data file as <code>data.tsv</code> with the equivalent that reads the <code>php/data2.php</code> file in as json (<code>d3,json</code>). </p>

<p>That’s it.</p>

<p>What it does is we tell d3.js to go and get a json file and when it strikes the <code>data2.php</code> file, it executes the script in the file and returns the encoded json information directly to d3.js.
How cool is that?</p>

<p>And here is the result.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/database20.png" alt="Our faithful simple line graph">
  <figcaption>Our faithful simple line graph</figcaption>
</figure>


<p>Sure, it looks kind of familiar, but it represents a significant ability for you to return data from a database and present it on a web page.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-manipulating-date--time-ranges">Manipulating Date / Time Ranges</h3>

<h4 id="leanpub-auto-whats-a-standard-format-for-a-date--time-value">What’s a standard format for a Date / Time value</h4>

<p>The <code>DATETIME</code> and <code>TIMESTAMP</code> types are used for values that contain both date and time parts. MySQL retrieves and displays <code>DATETIME</code> and <code>TIMESTAMP</code> values in <code>YYYY-MM-DD HH:MM:SS</code> format.  </p>

<p>The supported range for <code>DATETIME</code> is <code>1000-01-01 00:00:00</code> to <code>9999-12-31 23:59:59</code>.  <code>TIMESTAMP</code> has a range of <code>1970-01-01 00:00:01</code> UTC to <code>2038-01-19 03:14:07</code> UTC.</p>

<aside class="information blurb">
    <p>Coordinated Universal Time (UTC (which is a compromise between the French and English acronyms)) is the primary time standard by which the world regulates clocks and time. It took over from Greenwich Mean Time (GMT) as the standard reference since GMT is no longer precisely defined by the scientific community.</p>

</aside>

<h4 id="leanpub-auto-creating-a-standard-date--time-from-separate-columns">Creating a standard Date / Time from separate columns</h4>

<p>The original data format had separate columns for the year (<code>ORI_YEAR</code>), month (<code>ORI_MONTH</code>), day (<code>ORI_DAY</code>), hour (<code>ORI_HOUR</code>), minute (<code>ORI_MINUTE</code>) and second (<code>ORI_SECOND</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code>+--------+---------+-------+--------+----------+----------+
|ORI_YEAR|ORI_MONTH|ORI_DAY|ORI_HOUR|ORI_MINUTE|ORI_SECOND|
+--------+---------+-------+--------+----------+----------+
|    2010|        7|     12|       0|        15|   9.57643|
|    2010|        7|     12|       0|        23|  45.93486|
|    2010|        7|     12|       1|         3|  12.54922|
...
+--------+---------+-------+--------+----------+----------+
</pre></div>

</figure>

<p>If we want to generate a standard date / time unit from MySQL we can do it by grouping the separate parts together using the <code>CONCAT</code> command like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="n">CONCAT</code><code class="p">(</code><code class="o">`</code><code class="n">ORI_YEAR</code><code class="o">`</code><code class="p">,</code><code class="s1">'-'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_MONTH</code><code class="o">`</code><code class="p">,</code><code class="s1">'-'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_DAY</code><code class="o">`</code><code class="p">,</code><code class="s1">',`ORI_HOUR`,</code>
<code class="s1">'</code><code class="p">:</code><code class="s1">',`ORI_MINUTE`,'</code><code class="p">:</code><code class="err">'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_SECOND</code><code class="o">`</code><code class="p">)</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">nzeq1012</code><code class="o">`</code>
</pre></div>

</figure>

<p>Notice that as well as grouping the columns we also put in appropriate separators to follow a good practice. The output looks like so.</p>

<figure class="code">
<div class="highlight"><pre><code></code>2010-7-12 0:15:9.57643
2010-7-12 0:23:45.93486
2010-7-12 0:3:12.54922
</pre></div>

</figure>

<p>This is pretty scruffy looking and certainly doesn’t conform to the standard format that we’re looking for (<code>YYYY-MM-DD HH:MM:SS</code>). So we can do something a little tricky and tell MySQL that the value that gets returned is a date / time value and it will automatically format it correctly. This is as simple as declaring the entire selection as a <code>TIMESTAMP</code> like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="k">TIMESTAMP</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="o">`</code><code class="n">ORI_YEAR</code><code class="o">`</code><code class="p">,</code><code class="s1">'-'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_MONTH</code><code class="o">`</code><code class="p">,</code><code class="s1">'-'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_DAY</code><code class="o">`</code><code class="p">,</code>
<code class="s1">' '</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_HOUR</code><code class="o">`</code><code class="p">,</code><code class="s1">':'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_MINUTE</code><code class="o">`</code><code class="p">,</code><code class="s1">':'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_SECOND</code><code class="o">`</code><code class="p">))</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">nzeq1012</code><code class="o">`</code>
</pre></div>

</figure>

<p>The output is now…</p>

<figure class="code">
<div class="highlight"><pre><code></code>2010-7-12 00:15:09.57643
2010-7-12 00:23:45.93486
2010-7-12 00:03:12.54922
</pre></div>

</figure>

<p>This is certainly much better, but we have a seconds value that includes a decimal component. To eliminate the decimal portion we use the <code>ROUND</code> function as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="k">TIMESTAMP</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="o">`</code><code class="n">ORI_YEAR</code><code class="o">`</code><code class="p">,</code><code class="s1">'-'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_MONTH</code><code class="o">`</code><code class="p">,</code><code class="s1">'-'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_DAY</code><code class="o">`</code><code class="p">,</code>
<code class="s1">' '</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_HOUR</code><code class="o">`</code><code class="p">,</code><code class="s1">':'</code><code class="p">,</code><code class="o">`</code><code class="n">ORI_MINUTE</code><code class="o">`</code><code class="p">,</code><code class="s1">':'</code><code class="p">,</code><code class="n">ROUND</code><code class="p">(</code><code class="o">`</code><code class="n">ORI_SECOND</code><code class="o">`</code><code class="p">)))</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">nzeq1012</code><code class="o">`</code> 
</pre></div>

</figure>

<p>Which results in the following output;</p>

<figure class="code">
<div class="highlight"><pre><code></code>2010-7-12 00:15:10
2010-7-12 00:23:46
2010-7-12 00:03:13
</pre></div>

</figure>

<p>Neat.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-general-mysql-titbits">General MySQL titbits</h3>

<h4 id="leanpub-auto-group-parts-of-queries-and-text-together-with-concat">Group parts of queries (and text) together with <code>CONCAT</code>
</h4>

<p>Sometimes when returning data from a query, you will want to group parts of it together. This can be achieved with the <code>CONCAT</code> function (<code>CONCAT</code> is an abbreviation of the word ‘concatenate’).</p>

<p>This is as simple as using it in the form <code>CONCAT(foo, bar, 'text here', var)</code> where <code>foo</code>, <code>bar</code> and <code>var</code> are variables or values returned from the query process and <code>'text here'</code> is text that will be returned verbatim.</p>

<p>For example…</p>

<p>The table below represents data formatted in separate columns for the year (<code>ORI_YEAR</code>), month (<code>ORI_MONTH</code>) and day (<code>ORI_DAY</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code>+--------+---------+-------+
|ORI_YEAR|ORI_MONTH|ORI_DAY|
+--------+---------+-------+
|    2010|        7|      2|
|    2010|       10|     12|
|    2011|        3|     26|
+--------+---------+-------+
</pre></div>

</figure>

<p>If we want to generate a date (year-month-day) from MySQL we can do it by grouping the separate parts together using the <code>CONCAT</code> command like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="n">CONCAT</code><code class="p">(</code><code class="o">`</code><code class="n">ORI_YEAR</code><code class="o">`</code><code class="p">,</code> <code class="s1">'-'</code><code class="p">,</code> <code class="o">`</code><code class="n">ORI_MONTH</code><code class="o">`</code><code class="p">,</code> <code class="s1">'-'</code><code class="p">,</code> <code class="o">`</code><code class="n">ORI_DAY</code><code class="o">`</code><code class="p">)</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">nzeq1012</code><code class="o">`</code>
</pre></div>

</figure>

<p>Notice that as well as grouping the year, month and day columns we also put in appropriate separators (dashes(-)) to make it look nice. The output looks like so.</p>

<figure class="code">
<div class="highlight"><pre><code></code>2010-7-2
2010-10-12
2010-3-26
</pre></div>

</figure>

<aside class="tip blurb">
    <p>To go one step further you could enclose the entire concatenated grouping in a <code>DATE</code> command which would format the result in the standard date format YYYY-MM-DD.</p>
  <figure class="code">
<div class="highlight"><pre><code></code>SELECT DATE(CONCAT(`ORI_YEAR`, '-', `ORI_MONTH`, '-', `ORI_DAY`))
FROM `nzeq1012`
</pre></div>

  </figure>
  <p>Which produces…</p>
  <figure class="code">
<div class="highlight"><pre><code></code>2010-07-02
2010-10-12
2010-03-26
</pre></div>

  </figure>

</aside>

<h4 id="leanpub-auto-working-round-reserved-words-in-queries">Working round reserved words in queries</h4>

<p>When you name a column with a query using the <code>AS</code> operator, if you want to use a reserved word, place it in back ticks or single quote marks.</p>

<p>For example, when wanting to return a value of longitude with a column name <code>long</code>, the following query will cause an error;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code>  <code class="o">`</code><code class="n">LAT</code><code class="o">`</code> <code class="k">AS</code> <code class="n">lat</code><code class="p">,</code> <code class="o">`</code><code class="n">LONG</code><code class="o">`</code> <code class="k">AS</code> <code class="n">long</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">nzeq1012</code><code class="o">`</code>
</pre></div>

</figure>

<p>This is because ‘long’ is a word reserved for other uses in MySQL, so using it as a variable is difficult. However, enclose the <code>long</code> in quotes (as follows) and it will work fine.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code>  <code class="o">`</code><code class="n">LAT</code><code class="o">`</code> <code class="k">AS</code> <code class="n">lat</code><code class="p">,</code> <code class="o">`</code><code class="n">LONG</code><code class="o">`</code> <code class="k">AS</code> <code class="s1">'long'</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">nzeq1012</code><code class="o">`</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-rounding-numbers">Rounding numbers</h4>

<p>Rounding numbers with a fractional component is a common requirement. The <code>ROUND</code> function can be used in a couple of ways to round numbers.</p>

<p>Firstly, by stating <code>ROUND(x)</code> (where <code>x</code> is the argument) the function will round a number to only the integer component. However you can also use <code>ROUND(x,d)</code>, where <code>d</code> is the number of decimal places to round to.</p>

<p>For example, using the following data for earthquakes where ‘mag’ is the magnitude and ‘depth is the depth of the quake, we could reasonably want to massage the data so that the magnitude was represented by a number with a single decimal place and the depth was only the integer.</p>

<figure class="code">
<div class="highlight"><pre><code></code>+------+--------+
|   mag|   depth|
+------+--------+
| 2.555| 56.2691|
| 2.226|  6.2300|
| 2.055| 33.1684|
| 1.411| 12.0000|
| 1.976|  6.3498|
+------+--------+
</pre></div>

</figure>

<p>We can use the query…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="k">SELECT</code>  <code class="n">ROUND</code><code class="p">(</code><code class="o">`</code><code class="n">MAG</code><code class="o">`</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> <code class="k">AS</code> <code class="n">mag</code><code class="p">,</code> <code class="n">ROUND</code><code class="p">(</code><code class="o">`</code><code class="n">DEPTH</code><code class="o">`</code><code class="p">)</code> <code class="k">AS</code> <code class="n">depth</code>
<code class="k">FROM</code> <code class="o">`</code><code class="n">nzeq1012</code><code class="o">`</code> 
</pre></div>

</figure>

<p>…to get our desired result.</p>

<figure class="code">
<div class="highlight"><pre><code></code>+----+------+
| mag| depth|
+----+------+
| 2.6|    56|
| 2.2|     6|
| 2.1|    33|
| 1.4|    12|
| 2.0|     6|
+-----------+
</pre></div>

</figure>

<h2 id="leanpub-auto-working-with-github-gist-and-blocksorg">Working with GitHub, Gist and bl.ocks.org</h2>

<h3 id="leanpub-auto-general-stuff-about-blocksorg">General stuff about bl.ocks.org</h3>

<p>In the words of Mike Bostock on the <a href="http://bl.ocks.org/">bl.ocks.org</a> main page;</p>

<blockquote>
  <p><em>“This is a simple viewer for code examples hosted on GitHub Gist. Code up an example using Gist, and then point people here to view the example and the source code, live!”</em></p>
</blockquote>

<p>The whole idea is to take the information that you have in a gist (the pastebin area in Github) and to give it a viewer that will allow it to display in your browser.</p>

<p>The reason this works is that the files that make up a web page that can be displayed in your browser conform to a pretty well defined standard. If you can name your main web file index.html and put it in a gist, bl.ocks.org will not just render it to a browser, but since you can store your data files in the same gists, your visualization can use those as data sources as well since they shouldn’t violate any cross domain security restrictions. </p>

<p>Mike’s clever code allows a gallery type preview page to be generated (including a thumbnails if you follow the instructions in another part of this section). </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/blocks01.png" alt="Thumbnails of examples for d3noob's blocks">
  <figcaption>Thumbnails of examples for d3noob’s blocks</figcaption>
</figure>


<p>And if you include a readme file formatted using markdown you can have a nice little explanation of how your visualization works.</p>

<p>The front rendering page includes any markdown notes and the code (not the full screen) is optimised to accept visualizations of 960x500 pixels (although you can make them other sizes, it’s just that this is an ‘optimum’ size). Of course there is always the full screen mode to render your creation in its full glory if necessary.</p>

<p>If I was to pass on any advice when using bl.ocks.org, please consider others who will no doubt view your work and wonder how you achieved your magic. Help them along where possible with a few comments in the readme.md file because sharing is caring :-).</p>

<h3 id="leanpub-auto-installing-the-plug-in-for-blocksorg-for-easy-block-viewing">Installing the plug-in for bl.ocks.org for easy block viewing</h3>

<p>This might sound slightly odd at first if you’re not familiar with using Gist or bl.ocks.org, but trust me, a) you should use them, b) if you get to the point where you are using these fantastic services, there’s a good chance that you will want to be able to quickly check out what your block looks like when you update or add in a Gist. </p>

<p>Here’s the scenario. You’re slaving away getting all your data and files into Gist, and then you’re switching - in some tiresome manner - to get to the block that bl.ocks.org generates.</p>

<p>Well, throw away that tiresome technique! It’s time to move into the 21st century with some plug-in goodness.
Clever Mike Bostock has put together some handy dandy browser extensions that will add a button to your Chrome, Safari or Firefox browser to take you straight from your Gist to your block!</p>

<p>It will turn your Gist page from this…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/blocks02.png" alt="Gist page without bl.ocks.org button">
  <figcaption>Gist page without bl.ocks.org button</figcaption>
</figure>


<p>… to this …</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/blocks03.png" alt="Gist page with bl.ocks.org button!">
  <figcaption>Gist page with bl.ocks.org button!</figcaption>
</figure>


<p>Check out the button!</p>

<p>It’s really handy and works like a charm. You can download it directly from the <a href="http://bl.ocks.org/">bl.ocks.org home page</a>  or from the<a href="https://github.com/mbostock/bl.ocks.org"> Github page</a> where the code is hosted (this also includes a quick couple of lines of instructions for installation if you’re unsure).</p>

<h3 id="leanpub-auto-loading-a-thumbnail-into-gist-for-blocksorg-d3-graphs">Loading a thumbnail into Gist for bl.ocks.org d3 graphs</h3>

<p>This description will start on the assumption that the user already has a GitHub / Gist account set up and running. It’s purpose is to demonstrate how to upload an image as a file named thumbnail.png to a Gist so that when viewing the users home page on bl.ocks.org you see a nice little preview of what a visitor can anticipate, when they go to look at your work :-).
This description is a fleshed out version of the one provided by Christophe Viau on <a href="https://groups.google.com/forum/?fromgroups=#!topic/d3-js/FBosXiTB9Pc">Google Groups</a>.</p>

<h4 id="leanpub-auto-setting-the-scene">Setting the scene:</h4>

<p>There you are: a fresh faced d3.js user keen to share his/her work with the world. You set yourself up a GitHub / Gist account and put your code into a gist.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb01.png" alt="The gist web page">
  <figcaption>The gist web page</figcaption>
</figure>


<p>Your graph is a thing of rare beauty and the community needs to marvel at your brilliance. Of course this is a breeze with bl.ocks.org. Once you have all the code sorted out, and all data files made accessible, bl.ocks.org can display the graph with the code and can even open the graph in its own window. The person responsible for bl.ocks.org? Mike Bostock of course (wherever does he get the time?).</p>

<p>Clicking on the bl.ocks.org button on the gist page (load the extension available from the main page of bl.ocks.org) takes you to see your graph.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb02.png" alt="Your awesome graph ready to go">
  <figcaption>Your awesome graph ready to go</figcaption>
</figure>


<p>Wow! Impressive.</p>

<p>So you think that will make a fine addition to your collection of awesome graphs and if you click on your GitHub user name that is in the top left of the screen you go to a page that lays out all your graphs with a thumbnail giving a sneak preview of what the user can expect.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb03.png" alt="d3noob's blocks, but no thumbnail!">
  <figcaption>d3noob’s blocks, but no thumbnail!</figcaption>
</figure>


<p>Aww… Rats! There’s a nice place holder, but no pretty picture.</p>

<p>Hang on, what had Mike said on the bl.ocks.org main page?</p>

<p>“The main source code for your example should be named index.html. You can also include a README.md using Markdown, and a thumbnail.png for preview.” </p>

<p>Ahh.. you need to include a thumbnail.png file in your Gist!</p>

<p>So how to get it there? Well Gist is a repository, so what you need to do is to put the code in there somehow. Now from the Gist web page this doesn’t appear to be a nice (gui) way to do this. So from here you will need to suspend your noob status and hit the command line.</p>

<p>The good news (if you’re a windows user (and sorry, I haven’t done this in Linux or on a Mac)) is that, as part of the GitHub for windows installation, a command line tool was installed as well! Prepare yourself, you’re going to use the Git Shell.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb04.png" alt="The Windows GitHub and Git Shell icons">
  <figcaption>The Windows GitHub and Git Shell icons</figcaption>
</figure>


<h4 id="leanpub-auto-enough-of-the-scene-setting-lets-git-going--">Enough of the scene setting. Let’s git going :-).</h4>

<p>I’m going to describe the steps in a pretty verbose fashion with pretty pictures and everything else, but at the end I will put a simple set of steps in the form that Christophe Viau outlined on <a href="https://groups.google.com/forum/?fromgroups=#!topic/d3-js/FBosXiTB9Pc">Google Groups</a>.</p>

<p>First you will want to have your image ready. It needs to be a png with dimensions of 230 x 120 pixels. It should also be less than 50kB in size.</p>

<p>Go to your public Gist that you have already set up and copy the link in the “Clone this gist” box.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb05.png" alt="Copy the 'Clone this gist' link">
  <figcaption>Copy the ‘Clone this gist’ link</figcaption>
</figure>


<p>(this should look something like <a href="https://gist.github.com/441443">https://gist.github.com/441443</a>)</p>

<p>Now you’re going to clone this gist to a local repository using the Git Shell. Open it up from the desktop icon and you should see something like the following;</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb06.png" alt="The Git Shell is open for business">
  <figcaption>The Git Shell is open for business</figcaption>
</figure>


<p>You can clone the gist to a local folder with the command;</p>

<figure class="code">
<div class="highlight"><pre><code></code>git clone https://gist.github.com/4414436.git
</pre></div>

</figure>

<aside class="information blurb">
    <p>Or if you’re using OSX, the following command has been passed on by Alex Hornbake as an alternative (thanks Alex).</p>

  <p><code>git clone git@gist.github.com:4414436.git</code> </p>

</aside>

<p>(The url is the one copied from the ‘Clone this gist’ box.) </p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb07.png" alt="Running the command">
  <figcaption>Running the command</figcaption>
</figure>


<p>This will create a folder with the id (the number) of the gist in your local GitHub working directory.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb08.png" alt="A folder is created for your gist">
  <figcaption>A folder is created for your gist</figcaption>
</figure>


<p>And there it is (Ooo… Look almost New Years!).</p>

<aside class="information blurb">
    <p>Another tip for Mac users (This time from ‘Fern of the Andes’ in <a href="http://www.d3noob.org/2012/12/loading-thumbnail-into-gist-for.html">a comment from the d3noob.org</a> blog) is that at this stage you should be able to drag the generated folder into GitHub for Mac (http://mac.github.com/). Then simply drag the image file into the GitHub for Mac folder and commit. Have a crack if you’re confident enough. I can’t claim to have tried it, but Fern reckons it’s OK :-).</p>

</aside>

<p>Copy your thumbnail.png file into this directory. </p>

<p>Back to the Git Shell and change into the directory (4414436) . We can now add the thumbnail.png file to the gist with the command;</p>

<figure class="code">
<div class="highlight"><pre><code></code>git add thumbnail.png
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb09.png" alt="Running the git add command">
  <figcaption>Running the git add command</figcaption>
</figure>


<p>And now commit it to your gist with the following command in the Git Shell;</p>

<figure class="code">
<div class="highlight"><pre><code></code>git commit -m "Thumbnail image added"
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb10.png" alt="Running the git commit command">
  <figcaption>Running the git commit command</figcaption>
</figure>


<p>Now we need to push the commit to the remote gist (you may be asked for your GitHub user name and password if you haven’t done this before) with the following command;</p>

<figure class="code">
<div class="highlight"><pre><code></code>git push
</pre></div>

</figure>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb11.png" alt="Push! Push!">
  <figcaption>Push! Push!</figcaption>
</figure>


<p>OK, now you can go back to the web page for your gist and refresh it and scroll on down…</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb12.png" alt="A thumbnail is born">
  <figcaption>A thumbnail is born</figcaption>
</figure>


<p>Woo Hoo!</p>

<p>(I know it doesn’t look like much, but this is a VERY simple graph :-)).</p>

<p>Now for the real test. Go back to your home page for your blocks on bl.ocks.org and refresh the page.</p>


<figure class="image center">
  <img src="https://leanpub.com/site_images/D3-Tips-and-Tricks/thumb13.png" alt="d3noob's blocks complete with thumbnail">
  <figcaption>d3noob’s blocks complete with thumbnail</figcaption>
</figure>


<p>Oh yes. You may now bask in the sweet glow of victory. And as a little bit of extra fancy, if you move your mouse over the image it translates up slightly!</p>

<h4 id="leanpub-auto-wrap-up-2">Wrap up.</h4>

<p>The steps to get your thumbnail into the gist aren’t exactly point and click, but the steps you need to take are fairly easy to follow. As promised, here is the abridged list of steps that will avoid you going through the several previous pages.</p>

<ol class="numeric">
  <li>Create your public gist on <a href="https://gist.github.com/">https://gist.github.com/</a>
</li>
  <li>Get an image ready (230 x 120 pixels, named thumbnail.png)</li>
  <li>Under “Clone this gist”, copy the link (i.e., https://gist.github.com/4414436.git)</li>
  <li>If you have the command line git tools (Git Shell), clone this gist to a local folder:
<code>git clone https://gist.github.com/4414436.git</code> (or <code>git clone git@gist.github.com:4414436.git</code> for OSX)
It will add a folder with the gist id as a name (i.e., 4414436) under the current working directory.</li>
  <li>Navigate to this folder via the command line in Git Shell: <code>cd 4414436</code> (dir 4414436 on windows)</li>
  <li>Navigate to this folder in file explorer and add your image (i.e., thumbnail.png)</li>
  <li>Add it to git from the command line: <code>git add thumbnail.png</code>
</li>
  <li>Commit it to git: <code>git commit -m "Thumbnail added"</code>
</li>
  <li>Push this commit to your remote gist (you may need your Github user name and password): <code>git push</code>
</li>
  <li>Go back and refresh your Gist on https://gist.github.com/ to confirm that it worked</li>
  <li>Check your blocks home page and see if it’s there too. http://bl.ocks.org/&lt;<em>yourusername</em>&gt;</li>
</ol>

<p>Just to finish off. A big thanks to Christophe Viau for the hard work on finding out how it all goes together and if there are any errors in the above description I have no doubt they will be mine.</p>

<!-- begin backmatter -->
<h2 id="leanpub-auto-appendices">Appendices</h2>

<h3 id="leanpub-auto-simple-line-graph">Simple Line Graph</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>

<code class="nt">path</code> <code class="p">{</code> 
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// Set the dimensions of the canvas / graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="c1">// Set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// Define the axes</code>
<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="c1">// Define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
    
<code class="c1">// Adds the svg canvas</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data/data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="c1">// Add the valueline path.</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>

    <code class="c1">// Add the X Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="c1">// Add the Y Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-graph-with-many-features">Graph with Many Features</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

<code class="nt">body</code> <code class="p">{</code>
    <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">text</code><code class="nc">.shadow</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2.5px</code><code class="p">;</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">9</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code> <code class="p">{</code> 
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.grid</code> <code class="nc">.tick</code> <code class="p">{</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">lightgrey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">7</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.grid</code> <code class="nt">path</code> <code class="p">{</code>
          <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.area</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">lightsteelblue</code><code class="p">;</code>
      <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">35</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
    
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// function for the x grid lines</code>
<code class="kd">function</code> <code class="nx">make_x_axis</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="p">}</code>

<code class="c1">// function for the y grid lines</code>
<code class="kd">function</code> <code class="nx">make_y_axis</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="p">}</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="c1">// Add the filled area</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">);</code>

    <code class="c1">// Draw the x Grid lines</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"grid"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">make_x_axis</code><code class="p">()</code>
            <code class="p">.</code><code class="nx">tickSize</code><code class="p">(</code><code class="o">-</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="p">)</code>

    <code class="c1">// Draw the y Grid lines</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>            
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"grid"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">make_y_axis</code><code class="p">()</code>
            <code class="p">.</code><code class="nx">tickSize</code><code class="p">(</code><code class="o">-</code><code class="nx">width</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="p">)</code>

    <code class="c1">// Add the valueline path.</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>

    <code class="c1">// Add the X Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>

    <code class="c1">// Add the Y Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>

    <code class="c1">// Add the text label for the X axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code><code class="nx">width</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" ,"</code> <code class="o">+</code> 
                             <code class="p">(</code><code class="nx">height</code><code class="o">+</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Date"</code><code class="p">);</code>

    <code class="c1">// Add the white background to the y axis label for legibility</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"shadow"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Price ($)"</code><code class="p">);</code>

    <code class="c1">// Add the text label for the Y axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Price ($)"</code><code class="p">);</code>

    <code class="c1">// Add the title</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>     
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"16px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Price vs Date Graph"</code><code class="p">);</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-graph-with-area-gradient">Graph with Area Gradient</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>
<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>
<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.area</code> <code class="p">{</code>                       <code class="c">/* changed from line to area */</code>
  <code class="n">fill</code><code class="o">:</code> <code class="sx">url(#area-gradient)</code><code class="p">;</code>  <code class="c">/* url reference fill instead of stroke */</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>          <code class="c">/* removed stroke reference and any line*/</code>
<code class="p">}</code>
</pre></div>

</figure>
<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>
<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// Set the dimensions of the canvas / graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
<code class="c1">// Parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>
<code class="c1">// Set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">scale</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
<code class="c1">// Define the axes</code>
<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">().</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code> 
<code class="c1">// Define the area (remove the line definition)</code>
<code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
<code class="c1">// Adds the svg canvas</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code>
             <code class="p">);</code>
<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">tsv</code><code class="p">(</code><code class="s2">"data/data.tsv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
    <code class="p">});</code>
    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
    <code class="c1">// Set the threshold</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"linearGradient"</code><code class="p">)</code>                    
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"area-gradient"</code><code class="p">)</code>      <code class="c1">// change from line to area</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"gradientUnits"</code><code class="p">,</code> <code class="s2">"userSpaceOnUse"</code><code class="p">)</code>    
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">0</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="nx">y</code><code class="p">(</code><code class="mi">0</code><code class="p">))</code>                
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">0</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="nx">y</code><code class="p">(</code><code class="mi">1000</code><code class="p">))</code>            
    <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"stop"</code><code class="p">)</code>                                
        <code class="p">.</code><code class="nx">data</code><code class="p">([</code>                                        
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"0%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>            
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"30%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>        
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"45%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>        
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"55%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>    
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"60%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">},</code>    
            <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"100%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">}</code>    
        <code class="p">])</code>                                            
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"stop"</code><code class="p">)</code>                            
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"offset"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">offset</code><code class="p">;</code> <code class="p">})</code>        
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"stop-color"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">;</code> <code class="p">});</code>    
    <code class="c1">// Add the filled area and remove the value line block</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">);</code>
    <code class="c1">// Add the X Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>
    <code class="c1">// Add the Y Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</figure>
<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-bar-chart-1">Bar Chart</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
	<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

	<code class="nc">.axis</code> <code class="p">{</code>
	  <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
	<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
	  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">70</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code>	<code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m"</code><code class="p">).</code><code class="nx">parse</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">ordinal</code><code class="p">().</code><code class="nx">rangeRoundBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">],</code> <code class="p">.</code><code class="mi">05</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">time</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">"%Y-%m"</code><code class="p">));</code>

<code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"bar-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>

    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
    <code class="p">});</code>
	
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code>

  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"-.8em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"-.55em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code> <code class="p">);</code>

  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value ($)"</code><code class="p">);</code>

  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">x</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-linking-objects">Linking Objects</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
 
<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">449</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">249</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">word</code> <code class="o">=</code> <code class="s2">"gongoozler"</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw a rectangle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"http://en.wikipedia.org/wiki/"</code><code class="o">+</code><code class="nx">word</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>  
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightgreen"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>

<code class="c1">// draw text on the screen</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>A live version of this code can be found online on <a href="http://bl.ocks.org/d3noob/8150631">bl.ocks.org</a> and <a href="https://gist.github.com/d3noob/8150631">GitHub</a>.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-php-with-mysql-access">PHP with MySQL Access</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="o">&lt;?</code><code class="nx">php</code>
    <code class="nv">$username</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code> 
    <code class="nv">$password</code> <code class="o">=</code> <code class="s2">"homedbuser"</code><code class="p">;</code>   
    <code class="nv">$host</code> <code class="o">=</code> <code class="s2">"localhost"</code><code class="p">;</code>
    <code class="nv">$database</code><code class="o">=</code><code class="s2">"homedb"</code><code class="p">;</code>
    
    <code class="nv">$server</code> <code class="o">=</code> <code class="nb">mysql_connect</code><code class="p">(</code><code class="nv">$host</code><code class="p">,</code> <code class="nv">$username</code><code class="p">,</code> <code class="nv">$password</code><code class="p">);</code>
    <code class="nv">$connection</code> <code class="o">=</code> <code class="nb">mysql_select_db</code><code class="p">(</code><code class="nv">$database</code><code class="p">,</code> <code class="nv">$server</code><code class="p">);</code>

    <code class="nv">$myquery</code> <code class="o">=</code> <code class="s2">"</code>
<code class="s2">SELECT  `date`, `close` FROM  `data2`</code>
<code class="s2">"</code><code class="p">;</code>
    <code class="nv">$query</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$myquery</code><code class="p">);</code>
    
    <code class="k">if</code> <code class="p">(</code> <code class="o">!</code> <code class="nv">$myquery</code> <code class="p">)</code> <code class="p">{</code>
        <code class="k">echo</code> <code class="nb">mysql_error</code><code class="p">();</code>
        <code class="k">die</code><code class="p">;</code>
    <code class="p">}</code>
    
    <code class="nv">$data</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>
    
    <code class="k">for</code> <code class="p">(</code><code class="nv">$x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$x</code> <code class="o">&lt;</code> <code class="nb">mysql_num_rows</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code> <code class="nv">$x</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="nv">$data</code><code class="p">[]</code> <code class="o">=</code> <code class="nb">mysql_fetch_assoc</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
    <code class="p">}</code>
    
    <code class="k">echo</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$data</code><code class="p">);</code>     
     
    <code class="nb">mysql_close</code><code class="p">(</code><code class="nv">$server</code><code class="p">);</code>
<code class="cp">?&gt;</code><code class="x"></code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-simple-sankey-graph">Simple Sankey Graph</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>SANKEY Experiment<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">rect</code> <code class="p">{</code>
  <code class="nb">cursor</code><code class="o">:</code> <code class="n">move</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">9</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.link</code><code class="nd">:hover</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">p</code> <code class="na">id</code><code class="o">=</code><code class="s">"chart"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"js/sankey.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">units</code> <code class="o">=</code> <code class="s2">"Widgets"</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">10</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">700</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">formatNumber</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">",.0f"</code><code class="p">),</code>    <code class="c1">// zero decimal places</code>
    <code class="nx">format</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">formatNumber</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">units</code><code class="p">;</code> <code class="p">},</code>
    <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category20</code><code class="p">();</code>
<code class="c1">// append the svg canvas to the page</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#chart"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
<code class="c1">// Set the sankey diagram properties</code>
<code class="kd">var</code> <code class="nx">sankey</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sankey</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodeWidth</code><code class="p">(</code><code class="mi">36</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">nodePadding</code><code class="p">(</code><code class="mi">40</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">link</code><code class="p">();</code>
<code class="c1">// load the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"data/sankey-formatted.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">sankey</code>
      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">layout</code><code class="p">(</code><code class="mi">32</code><code class="p">);</code>
<code class="c1">// add in the links</code>
  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">b</code><code class="p">.</code><code class="nx">dy</code> <code class="o">-</code> <code class="nx">a</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">});</code>
<code class="c1">// add the link titles</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    		<code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">" ? "</code> <code class="o">+</code> 
                <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>
<code class="c1">// add in the nodes</code>
  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">behavior</code><code class="p">.</code><code class="nx">drag</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">origin</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"dragstart"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> 
		  <code class="k">this</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="k">this</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"drag"</code><code class="p">,</code> <code class="nx">dragmove</code><code class="p">));</code>
<code class="c1">// add the rectangles for the nodes</code>
  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/ .*/</code><code class="p">,</code> <code class="s2">""</code><code class="p">));</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">rgb</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">).</code><code class="nx">darker</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>
<code class="c1">// add in the title for the nodes</code>
  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="o">-</code><code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kc">null</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">&lt;</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">6</code> <code class="o">+</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">);</code>
<code class="c1">// the function for moving the nodes</code>
  <code class="kd">function</code> <code class="nx">dragmove</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
        <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">width</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dx</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">x</code><code class="p">))</code>
        <code class="p">)</code>
        <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">y</code><code class="p">))</code>
        <code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="nx">sankey</code><code class="p">.</code><code class="nx">relayout</code><code class="p">();</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-simple-tree-diagram">Simple Tree Diagram</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">"en"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Collapsible Tree Example<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

	<code class="nc">.node</code> <code class="nt">circle</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">3px</code><code class="p">;</code>
	<code class="p">}</code>

	<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>

	<code class="nc">.link</code> <code class="p">{</code>
	  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
	  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
	<code class="p">}</code>
	
    <code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>

  <code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
	
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"null"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">}</code>
<code class="p">];</code>

<code class="c1">// ************** Generate the tree diagram	 *****************</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">120</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
	<code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">,</code>
	<code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
	
<code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">tree</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">diagonal</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">diagonal</code><code class="p">()</code>
	<code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">];</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
  
<code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>

<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">source</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// Compute the new tree layout.</code>
  <code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">root</code><code class="p">).</code><code class="nx">reverse</code><code class="p">(),</code>
	  <code class="nx">links</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>

  <code class="c1">// Normalize for fixed-depth.</code>
  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">*</code> <code class="mi">180</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Declare the nodes…</code>
  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"g.node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nodes</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">||</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="o">++</code><code class="nx">i</code><code class="p">);</code> <code class="p">});</code>

  <code class="c1">// Enter the nodes.</code>
  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"#fff"</code><code class="p">);</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"end"</code> <code class="o">:</code> <code class="s2">"start"</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
	  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

  <code class="c1">// Declare the links…</code>
  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path.link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">links</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Enter the links.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code> <code class="s2">"g"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
	  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">diagonal</code><code class="p">);</code>

<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
	
  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-interactive-tree-diagram">Interactive Tree Diagram</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">"en"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Tree Example<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

    <code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
    
    <code class="nc">.node</code> <code class="p">{</code>
        <code class="nb">cursor</code><code class="o">:</code> <code class="nb">pointer</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nc">.node</code> <code class="nt">circle</code> <code class="p">{</code>
      <code class="n">fill</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
      <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
      <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">3px</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
      <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nc">.link</code> <code class="p">{</code>
      <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
      <code class="n">stroke</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
      <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
    <code class="p">}</code>
    
    <code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>

  <code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>

  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://d3js.org/d3.v3.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
    
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"null"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code>
            <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code>
          <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code>
        <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">}</code>
<code class="p">];</code>


<code class="c1">// ************** Generate the tree diagram     *****************</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">120</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
    
<code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">duration</code> <code class="o">=</code> <code class="mi">750</code><code class="p">,</code>
    <code class="nx">root</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">tree</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">diagonal</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">diagonal</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="p">[</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">];</code> <code class="p">});</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="nx">root</code> <code class="o">=</code> <code class="nx">treeData</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
<code class="nx">root</code><code class="p">.</code><code class="nx">x0</code> <code class="o">=</code> <code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>
<code class="nx">root</code><code class="p">.</code><code class="nx">y0</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  
<code class="nx">update</code><code class="p">(</code><code class="nx">root</code><code class="p">);</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">frameElement</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="s2">"500px"</code><code class="p">);</code>

<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">source</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// Compute the new tree layout.</code>
  <code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">root</code><code class="p">).</code><code class="nx">reverse</code><code class="p">(),</code>
      <code class="nx">links</code> <code class="o">=</code> <code class="nx">tree</code><code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>

  <code class="c1">// Normalize for fixed-depth.</code>
  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">depth</code> <code class="o">*</code> <code class="mi">180</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Update the nodes…</code>
  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"g.node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nodes</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">||</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="o">++</code><code class="nx">i</code><code class="p">);</code> <code class="p">});</code>

  <code class="c1">// Enter any new nodes at the parent's previous position.</code>
  <code class="kd">var</code> <code class="nx">nodeEnter</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y0</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x0</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="nx">click</code><code class="p">);</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"lightsteelblue"</code> <code class="o">:</code> <code class="s2">"#fff"</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">nodeEnter</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">||</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"end"</code> <code class="o">:</code> <code class="s2">"start"</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">);</code>

  <code class="c1">// Transition nodes to their new position.</code>
  <code class="kd">var</code> <code class="nx">nodeUpdate</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">nodeUpdate</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">?</code> <code class="s2">"lightsteelblue"</code> <code class="o">:</code> <code class="s2">"#fff"</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">nodeUpdate</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

  <code class="c1">// Transition exiting nodes to the parent's new position.</code>
  <code class="kd">var</code> <code class="nx">nodeExit</code> <code class="o">=</code> <code class="nx">node</code><code class="p">.</code><code class="nx">exit</code><code class="p">().</code><code class="nx">transition</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">remove</code><code class="p">();</code>

  <code class="nx">nodeExit</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">);</code>

  <code class="nx">nodeExit</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="mi">1</code><code class="nx">e</code><code class="o">-</code><code class="mi">6</code><code class="p">);</code>

  <code class="c1">// Update the links…</code>
  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path.link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">links</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code> <code class="p">});</code>

  <code class="c1">// Enter any new links at the parent's previous position.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">insert</code><code class="p">(</code><code class="s2">"path"</code><code class="p">,</code> <code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">o</code> <code class="o">=</code> <code class="p">{</code><code class="nx">x</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y0</code><code class="p">};</code>
        <code class="k">return</code> <code class="nx">diagonal</code><code class="p">({</code><code class="nx">source</code><code class="o">:</code> <code class="nx">o</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="nx">o</code><code class="p">});</code>
      <code class="p">});</code>

  <code class="c1">// Transition links to their new position.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">diagonal</code><code class="p">);</code>

  <code class="c1">// Transition exiting nodes to the parent's new position.</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">exit</code><code class="p">().</code><code class="nx">transition</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="nx">duration</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">o</code> <code class="o">=</code> <code class="p">{</code><code class="nx">x</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">};</code>
        <code class="k">return</code> <code class="nx">diagonal</code><code class="p">({</code><code class="nx">source</code><code class="o">:</code> <code class="nx">o</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="nx">o</code><code class="p">});</code>
      <code class="p">})</code>
      <code class="p">.</code><code class="nx">remove</code><code class="p">();</code>

  <code class="c1">// Stash the old positions for transition.</code>
  <code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">x0</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">y0</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
  <code class="p">});</code>
<code class="p">}</code>

<code class="c1">// Toggle children on click.</code>
<code class="kd">function</code> <code class="nx">click</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="nx">update</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
    
  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-force-layout-diagram">Force Layout Diagram</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code><code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1.5px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code><code class="nc">.link.twofive</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">25</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code><code class="nc">.link.fivezero</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">50</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code><code class="nc">.link.sevenfive</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">75</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">path</code><code class="nc">.link.onezerozero</code> <code class="p">{</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">1</code><code class="o">.</code><code class="m">0</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">circle</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1.5px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">text</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data/force.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">links</code><code class="p">)</code> <code class="p">{</code>

<code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="p">{};</code>

<code class="c1">// Compute the distinct nodes from the links.</code>
<code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">link</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">source</code> <code class="o">=</code> <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">||</code> 
        <code class="p">(</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">source</code><code class="p">});</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">target</code> <code class="o">=</code> <code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">]</code> <code class="o">||</code> 
        <code class="p">(</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="nx">link</code><code class="p">.</code><code class="nx">target</code><code class="p">});</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
<code class="p">});</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">force</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">force</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">values</code><code class="p">(</code><code class="nx">nodes</code><code class="p">))</code>
    <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">])</code>
    <code class="p">.</code><code class="nx">linkDistance</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">charge</code><code class="p">(</code><code class="o">-</code><code class="mi">300</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"tick"</code><code class="p">,</code> <code class="nx">tick</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">start</code><code class="p">();</code>

<code class="c1">// Set the range</code>
<code class="kd">var</code>	<code class="nx">v</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">100</code><code class="p">]);</code>

<code class="c1">// Scale the range of the data</code>
<code class="nx">v</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">links</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code>

<code class="c1">// asign a type per value to encode opacity</code>
<code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">link</code><code class="p">)</code> <code class="p">{</code>
	<code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">25</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"twofive"</code><code class="p">;</code>
	<code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">50</code> <code class="o">&amp;&amp;</code> <code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">25</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"fivezero"</code><code class="p">;</code>
	<code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">75</code> <code class="o">&amp;&amp;</code> <code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">50</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"sevenfive"</code><code class="p">;</code>
	<code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">100</code> <code class="o">&amp;&amp;</code> <code class="nx">v</code><code class="p">(</code><code class="nx">link</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">75</code><code class="p">)</code> <code class="p">{</code>
		<code class="nx">link</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s2">"onezerozero"</code><code class="p">;</code>
	<code class="p">}</code>
<code class="p">});</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code>

<code class="c1">// build the arrow.</code>
<code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:defs"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"marker"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="s2">"end"</code><code class="p">])</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:marker"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="nb">String</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"viewBox"</code><code class="p">,</code> <code class="s2">"0 -5 10 10"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"refX"</code><code class="p">,</code> <code class="mi">15</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"refY"</code><code class="p">,</code> <code class="o">-</code><code class="mf">1.5</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"markerWidth"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"markerHeight"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"orient"</code><code class="p">,</code> <code class="s2">"auto"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="s2">"M0,-5L10,0L0,5"</code><code class="p">);</code>

<code class="c1">// add the links and the arrows</code>
<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">links</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg:path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"link "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">type</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"marker-end"</code><code class="p">,</code> <code class="s2">"url(#end)"</code><code class="p">);</code>

<code class="c1">// define the nodes</code>
<code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">nodes</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="nx">click</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"dblclick"</code><code class="p">,</code> <code class="nx">dblclick</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">drag</code><code class="p">);</code>

<code class="c1">// add the nodes</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>

<code class="c1">// add the text </code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">12</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">});</code>

<code class="c1">// add the curvy lines</code>
<code class="kd">function</code> <code class="nx">tick</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">path</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">dx</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">,</code>
            <code class="nx">dy</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">,</code>
            <code class="nx">dr</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">dx</code> <code class="o">*</code> <code class="nx">dx</code> <code class="o">+</code> <code class="nx">dy</code> <code class="o">*</code> <code class="nx">dy</code><code class="p">);</code>
        <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">"A"</code> <code class="o">+</code> 
            <code class="nx">dr</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">dr</code> <code class="o">+</code> <code class="s2">" 0 0,1 "</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> 
            <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="nx">node</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		    <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
<code class="p">}</code>

<code class="c1">// action to take on mouse click</code>
<code class="kd">function</code> <code class="nx">click</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">22</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"lightsteelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="s2">".5px"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font"</code><code class="p">,</code> <code class="s2">"20px sans-serif"</code><code class="p">);</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">16</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightsteelblue"</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// action to take on mouse double click</code>
<code class="kd">function</code> <code class="nx">dblclick</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">6</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"#ccc"</code><code class="p">);</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">).</code><code class="nx">transition</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">750</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">12</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font"</code><code class="p">,</code> <code class="s2">"10px sans-serif"</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">});</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-bullet-chart">Bullet Chart</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">body</code> <code class="p">{</code>
  <code class="nb">font-family</code><code class="o">:</code> <code class="s2">"Helvetica Neue"</code><code class="o">,</code> <code class="n">Helvetica</code><code class="o">,</code> <code class="n">Arial</code><code class="o">,</code> <code class="nb">sans-serif</code><code class="p">;</code>
  <code class="nb">margin</code><code class="o">:</code> <code class="nb">auto</code><code class="p">;</code>
  <code class="nb">padding-top</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">relative</code><code class="p">;</code>
  <code class="nb">width</code><code class="o">:</code> <code class="m">800px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nt">button</code> <code class="p">{</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
  <code class="nb">right</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
  <code class="nb">top</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.bullet</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">10px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.marker</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.tick</code> <code class="nt">line</code> <code class="p">{</code> <code class="n">stroke</code><code class="o">:</code> <code class="m">#666</code><code class="p">;</code> <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">.5px</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#eee</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s1</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ddd</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.range.s2</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.measure.s0</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.title</code> <code class="p">{</code> <code class="nb">font-size</code><code class="o">:</code> <code class="m">14px</code><code class="p">;</code> <code class="nb">font-weight</code><code class="o">:</code> <code class="nb">bold</code><code class="p">;</code> <code class="p">}</code>
<code class="nc">.bullet</code> <code class="nc">.subtitle</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="m">#999</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">button</code><code class="p">&gt;</code>Update<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"js/bullet.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">120</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">800</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">50</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">chart</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">bullet</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">width</code><code class="p">(</code><code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">height</code><code class="p">(</code><code class="nx">height</code><code class="p">);</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"data/cpu1.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bullet"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">);</code>

  <code class="kd">var</code> <code class="nx">title</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(-6,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

  <code class="nx">title</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">title</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">title</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"subtitle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">subtitle</code><code class="p">;</code> <code class="p">});</code>

  <code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"button"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">datum</code><code class="p">(</code><code class="nx">randomize</code><code class="p">).</code><code class="nx">call</code><code class="p">(</code><code class="nx">chart</code><code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">));</code>
  <code class="p">});</code>
<code class="p">});</code>

<code class="kd">function</code> <code class="nx">randomize</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">)</code> <code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code> <code class="o">=</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">markers</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">measures</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">randomizer</code><code class="p">);</code>
  <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">randomizer</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">k</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">ranges</code><code class="p">)</code> <code class="o">*</code> <code class="p">.</code><code class="mi">2</code><code class="p">;</code>
  <code class="k">return</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d</code> <code class="o">+</code> <code class="nx">k</code> <code class="o">*</code> <code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">-</code> <code class="p">.</code><code class="mi">5</code><code class="p">));</code>
  <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h3 id="leanpub-auto-map-with-zoom--pan-and-cities">Map with zoom / pan and cities</h3>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">path</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0.25px</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code> <code class="na">src</code><code class="o">=</code><code class="s">"d3/d3.v3.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"js/topojson.v0.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">mercator</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">center</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">5</code> <code class="p">])</code>
    <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="mi">900</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">rotate</code><code class="p">([</code><code class="o">-</code><code class="mi">180</code><code class="p">,</code><code class="mi">0</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">);</code>

<code class="c1">// load and display the World</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"json/world-110m2.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">topology</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">topojson</code><code class="p">.</code><code class="nx">object</code><code class="p">(</code><code class="nx">topology</code><code class="p">,</code> <code class="nx">topology</code><code class="p">.</code><code class="nx">objects</code><code class="p">.</code><code class="nx">countries</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">geometries</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
      
    <code class="c1">// load and display the cities</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data/cities.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
           <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                   <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">0</code><code class="p">];</code>
           <code class="p">})</code>
           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
                   <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">1</code><code class="p">];</code>
           <code class="p">})</code>
           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>
    <code class="p">});</code>

<code class="p">});</code>

<code class="c1">// zoom and pan</code>
<code class="kd">var</code> <code class="nx">zoom</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">behavior</code><code class="p">.</code><code class="nx">zoom</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"zoom"</code><code class="p">,</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">g</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code><code class="s2">"translate("</code><code class="o">+</code> 
            <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">translate</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s2">","</code><code class="p">)</code><code class="o">+</code><code class="s2">")scale("</code><code class="o">+</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">scale</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
        <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>  
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">));</code> 
        <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">));</code>
  <code class="p">});</code>

<code class="nx">svg</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">zoom</code><code class="p">)</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>


</div>


</div>
</div>
</div>

</div>
<script>
  $(function() {
    var toc = $('#ttoc');

    function makeLi(text, href) {
      return $('<a href="' + href + '">' + text + '</a><br>');
    }

    $('h2').each(function(i) {
      var chapter = $(this), chapterNumber = i + 1;
      toc.append(
        makeLi('Chapter ' + chapterNumber + ': ' + chapter.text(), '#chapter-' + chapterNumber)
      );
      chapter.attr('id', 'chapter-' + chapterNumber);
      chapter.prepend('<p class="toc"><a title="Back to top" href="#toc">Top</a></p>');
    });

  });
</script>
