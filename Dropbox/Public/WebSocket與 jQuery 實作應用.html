<html>
<head>
<meta charset="utf-8">

<STYLE>

body {
font-family: "Times New Roman", Times, serif;
margin:10%;
background-color: #000000;
 color: #008040;
 font-size: 20px;
}
a { text-decoration: none;
  color: #28B8B8;}
a:visited { color: #389898;}
A:hover { color: yellow;}
A:focus { color: red;}
code { color: gray;}
pre { 
    font-family: "courier new", courier, monospace;
    color: gray; background-color: #001010}
.redword { color: red} 
.yellowword { color: yellow} 
.greenword { color: lightgreen} 
.limeword { color: .00ff00}
</STYLE>

<h1>WebSocket èˆ‡ jQuery æ‡‰ç”¨</h1>

<div>

<h2>ä»€éº¼æ˜¯ WebSocket? </h2>

<blockquote><p>
WebSocket æ˜¯ HTML5 é–‹å§‹æä¾›çš„ä¸€ç¨®ç€è¦½å™¨èˆ‡ä¼ºæœå™¨é–“é€²è¡Œå…¨é›™å·¥é€šè¨Šçš„ç¶²è·¯æŠ€è¡“ã€‚
åœ¨ WebSocket API ä¸­ï¼Œç€è¦½å™¨å’Œä¼ºæœå™¨åªéœ€è¦è¦åšä¸€å€‹æ¡æ‰‹çš„å‹•ä½œï¼Œç„¶å¾Œï¼Œç€è¦½å™¨å’Œä¼ºæœå™¨ä¹‹é–“å°±å½¢æˆäº†ä¸€æ¢å¿«é€Ÿé€šé“ã€‚å…©è€…ä¹‹é–“å°±ç›´æ¥å¯ä»¥è³‡æ–™äº’ç›¸å‚³é€ã€‚<br />
</p></blockquote>
<p>ç°¡å–®ä¾†èªªï¼Œå°±æ˜¯æœ‰ Client &#038; Server å…©ç«¯é€é WebSocket äº’ç›¸å‚³éèˆ‡æ¥æ”¶è³‡æ–™ï¼Œä¸¦ä¸”å³æ™‚é¡¯ç¤ºåœ¨é é¢ä¸Šã€‚</p>
<h2>WebSocket èªæ³•èªªæ˜</h2>
Exampleï¼š</p>
<pre><code class="language-javascript">&lt;!DOCTYPE html&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;title&gt;WebSocket Test&lt;/title&gt;
    &lt;script language="javascript" type="text/javascript"&gt;
        var wsUri = "ws://echo.websocket.org/";
        var output;
            function init() {
                output = document.getElementById("output");
                testWebSocket();
            }
            function testWebSocket() {
                websocket = new WebSocket(wsUri);
                websocket.onopen = function(evt) { 
                    onOpen(evt)
                    };
                websocket.onclose = function(evt) {
                    onClose(evt)
                };
                websocket.onmessage = function(evt) {
                    onMessage(evt)
                };
                websocket.onerror = function(evt) {
                    onError(evt)
                };
            }
            function onOpen(evt) {
                writeToScreen("CONNECTED"); 
                doSend("WebSocket rocks"); 
            }  
            function onClose(evt) { 
                writeToScreen("DISCONNECTED"); 
            }  
            function onMessage(evt) { 
                writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>'); 
                websocket.close(); 
            }  
            function onError(evt) { 
                writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data); 
            }  
            function doSend(message) { 
                writeToScreen("SENT: " + message);
                websocket.send(message); 
            }  
            function writeToScreen(message) { 
                var pre = document.createElement("p"); pre.style.wordWrap = "break-word"; pre.innerHTML = message; output.appendChild(pre); 
            }  
            window.addEventListener("load", init, false);  
        &lt;/script&gt;  
        &lt;h2&gt;WebSocket Test&lt;/h2&gt;  
        &lt;div id="output"&gt;&lt;/div&gt;  </code></pre>
<p>WebSocket å·²ç¶“å»ºç«‹å¥½è¨±å¤š function ï¼Œæˆ‘å€‘å¯ä»¥ç›´æ¥ç”¨ä»–çš„ functionï¼Œç•¶ç„¶ä¹Ÿä¸ä¸€å®šè¦å…¨éƒ¨ function éƒ½ç”¨åˆ°ï¼Œæˆ–æ˜¯å¯ä»¥åšé»å°ä¿®æ”¹ï¼Œåƒæˆ‘ä¸»ç®¡çµ¦æˆ‘çš„ç¯„æœ¬å°±è·Ÿå®˜ç¶²æä¾›çš„æœ‰ä¸€é»é»ä¸ä¸€æ¨£(ä½†åŸºæœ¬ä¸Šçš„å‘¼å«æ˜¯å¤§åŒå°ç•°çš„)</p>
<ul>
<li>ç¬¬ 5 è¡Œï¼šè€å¯¦èªªæˆ‘è¦ºå¾—æ‰€æœ‰èªæ³•ä¸­æœ€é‡è¦çš„å°±æ˜¯ç¬¬ 5 è¡Œçš„ <code>var wsUri = "ws://echo.websocket.org/";</code>ï¼Œå› ç‚ºå¦‚æœä¸€é–‹å§‹æ²’æœ‰æŠŠå‚³è¼¸çš„ç¶²å€å¯«æ­£ç¢ºï¼Œä¹‹å¾Œçš„æ•ˆæœæ ¹æœ¬ä¹Ÿè·‘ä¸å‡ºä¾†ã€‚<span class ="redword">è¨˜å¾—è¦æŠŠ <code>http://</code> æ”¹æˆ <code>ws://</code>ã€‚</span></li>
<li>ç¬¬ 13 è¡Œï¼š<code>websocket.onopen</code>é€™å€‹äº‹ä»¶æ˜¯ç”¨ä¾†åˆ¤æ–·å‰é¢çš„ <code>wsUri</code> æ˜¯å¦æœ‰é †åˆ©æŠ“åˆ°ï¼Œå¦‚æœæœ‰æŠ“åˆ°è¡¨ç¤º onopenï¼Œå¯ä»¥åˆ©ç”¨<code>console.log</code>æˆ–æ˜¯<code>alert</code>åšå€‹æ¨™è¨˜ï¼š<code>console.log("é€£ç·šæˆåŠŸ");</code></li>
<li>ç¬¬ 16 è¡Œï¼šè·Ÿç¬¬ 13 è¡Œçš„äº‹ä»¶å°ç…§å°±å¾ˆæ¸…æ¥šçš„çŸ¥é“ï¼Œ<code>websocket.onclose</code>æ˜¯ç”¨ä¾†è¡¨ç¤ºç•¶é€£ç·šä¸­æ–·æ™‚ï¼Œæœƒå‡ºç¾ä»€éº¼è¨Šæ¯æˆ–äº‹ä»¶ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼š<code>wescoket.onmessage</code>æ˜¯æ•´å€‹ WebSocket çš„é‡é ­æˆ²ï¼Œé€£ç·šå¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥åœ¨<code>onmessage</code>è£é¢å¯«ä¸Šä»»ä½•æƒ³è¦å‚³è¼¸çš„äº‹ä»¶å…§å®¹ã€‚</li>
<li>ç¬¬ 22 è¡Œï¼šè€Œå°æ‡‰ 19 è¡Œçš„<code>wescoket.onmessage</code>ï¼Œ<code>wescoket.onerror</code>æ˜¯ç”¨ä¾†åˆ¤æ–·é€£ç·šæˆ–äº‹ä»¶çš„æ­£ç¢ºèˆ‡å¦ï¼Œå¦‚æœæœ‰å‡ºç¾äº†ä»»ä½•éŒ¯èª¤ï¼Œå°±æœƒè§¸ç™¼<code>onerror</code>äº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥åœ¨é€™é‚Šé€²è¡Œé™¤éŒ¯ã€‚</li>
</ul>
<p>WebSocket ä¸»è¦å°±æ˜¯é€™å››å€‹äº‹ä»¶ï¼Œæ‰€ä»¥å…¶å¯¦ä¸é›£ã€‚é‚£è¦æ€éº¼åˆ©ç”¨ jQuery çµåˆ WebSocket åšå‡ºæƒ³è¦çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘å€‘åšæ³•é€šå¸¸æ˜¯å°‡ jQuery çš„ä¸»è¦ function è·Ÿ WebSocket æ‹†é–‹ä¾†ï¼Œç°¡å–®æ¶æ§‹åƒè€ƒå¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">ä¸»è³‡æ–™å¤¾
â”œ effect.js
â”œ websocket.client.js
â”œ websocket.master.js
â”œ websocket.client.html
â”œ websocket.master.html</code></pre>
<p>ç”±æ­¤å¯çœ‹å‡ºï¼Œå°‡ä¸»è¦çš„åŠŸèƒ½å¯«åœ¨ effect.js è£é ­ï¼Œ client.js(html) èˆ‡ master.js(html) åˆ†åˆ¥ç”¨ä¾†è¡¨ç¤ºå…©å€‹ä¸åŒç¶²é ï¼Œä»–å€‘å¯ä»¥æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥äº’ç›¸å‚³æ”¶è³‡æ–™ ã€‚</p>
<h2>åˆ©ç”¨ JSON å‚³é WebSocket</h2>
<h3>æ­¥é©Ÿä¸€</h3>
<p>åœ¨ effect.js å…ˆå°‡æ‰€æœ‰è¦é¡¯ç¤ºçš„è³‡æ–™å­˜åˆ°è®Šæ•¸ä¸­ï¼š</p>
<pre><code class="language-javascript">var _name = $("#name").val();
var _company = $("#company").val();</code></pre>
<h3>æ­¥é©ŸäºŒ</h3>
<p>åˆ©ç”¨ JSON å°‡è³‡æ–™é€çµ¦ WebSocketï¼š</p>
<pre><code class="language-javascript">websocket.send(JSON.stringify({
    'username': _name,
    'company': _company,
}));</code></pre>
<h3>æ­¥é©Ÿä¸‰</h3>
<p>åœ¨ client.js å°‡æ”¶åˆ°çš„è³‡æ–™å­˜åˆ°è®Šæ•¸ä¸­ä¸¦èª¿ç”¨ï¼š(è«‹å¯«åœ¨<code>websocket.onmessage</code>äº‹ä»¶è£¡ã€‚)</p>
<pre><code class="language-javascript">//è¨­ç½®ä¸€å€‹è®Šæ•¸ data, å°‡å‰›å‰› JSON çš„è³‡æ–™å­˜å…¥
var data = $.parseJSON(e.data);

//ä»¥ä¸‹å¯èª¿ç”¨è©² data
username = data.username
company = data.company</code></pre>
<p>ä»¥ä¸Šç°¡å–®å¹¾è¡Œï¼Œå°±å¯ä»¥å®Œæˆ WebSocket çš„åŸºæœ¬åŠŸèƒ½å›‰ ğŸ™‚</p>
<h2>åœ¨å…©å€‹ä¸åŒçš„ç¶²é ä¸­ (master.html, client.html) äº’å‚³è³‡æ–™</h2>
<p>å‡ä½¿æˆ‘å€‘å¸Œæœ›åœ¨ master.html åšäº†ä¸€å€‹å‹•ä½œ (æ¯”å¦‚èªªé»é¸ç‰¹å®šçš„åˆ†é æ™‚)ï¼Œclient.html å°±æœƒç§€å‡ºä¸€å€‹ DIVã€‚é‚£éº¼è¦æ€éº¼åšå‡ºé€™åŠŸèƒ½å‘¢ï¼Ÿ</p>
<p>æˆ‘å€‘åœ¨åˆ‡æ› TAB çš„æ™‚å€™ï¼Œé€šå¸¸ç¶²å€åˆ—å¾Œé¢éƒ½æœƒå¤šä¸€å€‹ã€Œ#+è‹±æ•¸å­—ã€ä½œç‚ºæ¨™è¨˜ï¼Œè€Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨é€™å€‹æ¨™è¨˜ä¾†è­˜åˆ¥ç¾åœ¨æ˜¯åˆ‡æ›åˆ°ç¬¬å¹¾å€‹åˆ†é ï¼Œç„¶å¾Œé‡å°æŒ‡å®šçš„åˆ†é ï¼Œåœ¨ client.html é¡¯ç¤ºä¸€å€‹ DIVã€‚</p>
<h3>æ­¥é©Ÿä¸€</h3>
<p>å…ˆåœ¨ master.js è¨­å®šä¸€å€‹äº‹ä»¶ï¼Œå°‡ #(hash) çµ¦æ“·å–å‡ºä¾†ï¼š</p>
<pre><code class="language-javascript">$(window).keyup('hashchange', function() {
    var tab= location.hash;
    console.log(location.hash);
    websocket.send(JSON.stringify({'tab' : tab}));
});</code></pre>
<p>æˆ‘æœ‰ç”¨<code>console.log</code>è¨˜éŒ„æ¯ä¸€æ¬¡çš„ hash è®ŠåŒ–ï¼Œç¢ºå®šä»–æœ‰æŠ“åˆ° hashï¼Œç„¶å¾Œç”¨<code>websocket.send</code>å¯«åˆ° JSON<br />
ps. é€™å€‹ keyup äº‹ä»¶ä¸ä¸€å®šè¦å¯«åœ¨<code>websocket.onmessage</code>è£¡ã€‚</p>
<h3>æ­¥é©ŸäºŒ</h3>
<p>åŒæ¨£åœ¨ client.js å°‡è³‡æ–™æŠ“å‡ºä¾†ï¼Œç„¶å¾Œåšåˆ¤æ–·ï¼š</p>
<pre data-line="5,6"><code class="language-javascript">//å¦‚æœ data.tab æœ‰è³‡æ–™
if (data.tab) {
    //å› ç‚º data.tab æŠ“åˆ°çš„è³‡æ–™æ˜¯ #1, #2, #3... é€™æ¨£çš„å€¼ï¼Œç‚ºäº†åªå–æ•¸å­—ï¼Œæ‰€ä»¥ç”¨ substring å»åšæˆªæ–·
    for(var x = 1; x &amp;lt; data.tab.substring(1,2); x ++) {
        if(x == 1){
            $("div").css("display", "block");
          }
    };        
};</code></pre>
<p>åˆ©ç”¨é€™æ¨£çš„æ¦‚å¿µèˆ‡æ–¹æ³•ï¼Œå°±å¯ä»¥ç°¡å–®åœ°åœ¨å…©ç«¯äº’å‚³è³‡æ–™å›‰</p>

<h2>æœ‰è¶£çš„ WebSocket å¯¦ä¾‹</h2>

<p><a href="http://chrome.com/supersyncsports/" target="_blank">Super Sync Sports</a> æ˜¯å€‹åˆ©ç”¨ WebSocket åšçš„é‹å‹•å°éŠæˆ²ï¼Œè«‹å…ˆç”¨ web ç«¯ç€è¦½è©²ç¶²ç«™ï¼Œç„¶å¾Œä»–æœƒè¦ä½ ä¹Ÿç”¨æ‰‹æ©Ÿé–‹å•Ÿé€™å€‹ç¶²ç«™ï¼Œå°‡ web è·Ÿæ‰‹æ©Ÿé€£ç·šä¹‹å¾Œï¼Œå°±å¯ä»¥åˆ©ç”¨æ‰‹æ©Ÿæ§åˆ¶ web ä»‹é¢ä¾†è·‘æ­¥ã€æ¸¸æ³³ï¼Œæˆ–æ˜¯é¨è…³è¸è»Šã€‚</p>
<p>è€Œä¸”é‚„å¯ä»¥å¤šäººé€£ç·šå–”ï¼Œè¶…é…·



</body>
</html>