<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width"/>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.js"></script>
<script type='text/javascript' src='../mainscript.js'></script>

<script>
$(document).ready(function(){
   $('h1, h2, h3, h4, h5, .goldword, strong,  div.title').click(function(){
   parent.history.back();
   return false;
   });
});
</script>
<style>
body{width:90%;margin-left: 5%; font-size:22px;}
strong, h1, h2 {color: gold;}
img {width:90%; display: inline-block; margin-top: 2%;margin-bottom: 1%;}
i{color:brown;}
</style>
</head>
<body onkeypress="chkKey()">
<center><h1>Scraping with Selenium</h1>
<a href="https://www.youtube.com/watch?v=zcUGla8EjjY">RSelenium Webinar JavaScript Example</a>
<br>
<a href="https://stackoverflow.com/questions/50113232/attributeerror-issue-module-selenium-webdriver-has-no-attribute-chrome">'selenium.webdriver' has no attribute 'Chrome'</a>
<br>

<div id="toc"></div></center>
<br>
<br>
<br>
<pre>

D:/R-3.4.3/library/RSelenium/

https://stackoverflow.com/questions/42468831/how-to-set-up-rselenium-for-r
Download latest version of RSelenium >= 1.7.1. Run the following:

library(RSelenium)
rD <- rsDriver() # runs a chrome browser, wait for necessary files to download
remDr <- rD$client
# no need for remDr$open() browser should already be open

https://blog.gtwang.org/r/rselenium-r-selenium-browser-web-scraping-tutorial/
RSelenium：R 使用 Selenium 操控瀏覽器下載網頁資料

D:\R-3.4.3\library\RSelenium\chromedriver.exe


https://stackoverflow.com/questions/45395849/cant-execute-rsdriver-connection-refused

rD <- rsDriver() # runs a chrome browser, wait for necessary files to download
remDr <- rD$client
# no need for remDr$open() browser should already be open



<h2>rselenium tutorial</h2>
RSelenium allows us to integrate from within R testing and manipulation of projects such as <a href="https://www.rstudio.com/shiny/">shiny</a>, <a href="https://saucelabs.com/">sauceLabs</a>.
<h2 id="installation">Installation</h2><code class="language-r">install.packages(&quot;RSelenium&quot;)
</code>

Or development version from GitHub
<code class="language-r">install.packages(&quot;devtools&quot;)
devtools::install_github(&quot;ropensci/RSelenium&quot;)
</code>
<code class="language-r">library(&quot;RSelenium&quot;)
</code>

<h2 id="usage">Usage
<h3 id="connecting-to-a-selenium-server">Connecting to a Selenium Server</h3>
<h4 id="what-is-a-selenium-server">What is a Selenium Server?</h4>
Selenium Server is  a standalone java program which allows you to run HTML test suites in a range of different browsers, plus extra options like reporting.
You may, or may not, need to run a Selenium Server, depending on how you intend to use Selenium-WebDriver (RSelenium).

<h4 id="do-i-need-to-run-a-selenium-server">Do I need to run a Selenium Server?</h4>
If you intend to drive a browser on the same machine that RSelenium is running on then you will need to have Selenium Server running on that machine.

<h4 id="how-do-i-get-the-selenium-server-stand-alone-binary">How do I get the Selenium Server stand-alone binary?</h4>
RSelenium has a built-in function that will download the stand-alone java binary and place it in the RSelenium package location in the <code>/bin/</code> directory. 
If you would like to install elsewhere the function takes a <code>dir</code> argument and can also update an existing binary.
<i>
Note: checkForServer is now defunct. 
Users in future can find the function in 
file.path(find.package("RSelenium"), "examples/serverUtils"). 
The recommended way to run a selenium server is via Docker. 
Alternatively see the RSelenium::rsDriver function.
</i>
If you would like to download the binary manually it is currently found <a href="https://selenium-release.storage.googleapis.com/">here</a>. 
Look for <code>selenium-server-standalone-x.xx.x.jar</code>.

<h4 id="how-do-i-run-the-selenium-server">How do I run the Selenium Server?</h4>
There is a utility function included in <code>RSelenium</code> to run an existing stand-alone Selenium Server binary.
<code>RSelenium::startServer()
</code>

By default it looks in the <code>RSelenium</code> package <code>/bin/</code> directory. 
It has an optional <code>dir</code> argument if your binary is elsewhere. 
Alternatively you can run the binary manually. 
Open a console in your OS and navigate to where the binary is located and run:
<code>java -jar selenium-server-standalone-x.xx.x.jar
</code>

By default the <code>Selenium Server</code> listens for connections on port 4444.

<h4 id="how-do-i-connect-to-a-running-server">How do I connect to a running server?</h4>
<code>RSelenium</code> has a main reference class named <code>remoteDriver</code>. 
To connect to a server you need to instantiate a new <code>remoteDriver</code> with appropriate options.
<code># RSelenium::startServer() if required
require(RSelenium)
remDr &lt;- remoteDriver(remoteServerAddr = &quot;localhost&quot;
                      , port = 4444
                      , browserName = &quot;firefox&quot;
                      )
</code>

It would have been sufficient to call <code>remDr &lt;- remoteDriver()</code> but the options where explicitly listed to show how one may connect to an arbitrary ip/port/browser etc. 
More detail maybe found on the <code>sauceLabs</code> vignette. 
To connect to the server use the <code>open</code> method.
<code>remDr$open()
</code>

RSelenium should now have a connection to the Selenium Server. 
You can query the status of the remote Server using the <code>status</code> method.
<code>&gt; remDr$getStatus()
$os
              arch               name            version
           &quot;amd64&quot;            &quot;Linux&quot; &quot;3.8.0-35-generic&quot;

$java
   version
&quot;1.6.0_27&quot;

$build
             revision                  time               version
            &quot;ff23eac&quot; &quot;2013-12-16 16:11:15&quot;              &quot;2.39.0&quot;

</code>

<h3 id="navigating-using-rselenium">Navigating using RSelenium</h3>
<h4 id="basic-navigation">Basic Navigation</h4>
To start with we navigate to a url.
<code>remDr$navigate(&quot;http://www.google.com&quot;)
</code>

Then we navigate to a second page.
<code>remDr$navigate(&quot;http://www.bbc.co.uk&quot;)

&gt; remDr$getCurrentUrl()
[[1]]
[1] &quot;http://www.bbc.co.uk/&quot;

</code>

We can go backwards and forwards using the methods <code>goBack</code> and <code>goForward</code>.
<code>remDr$goBack()

&gt; remDr$getCurrentUrl()
[[1]]
[1] &quot;https://www.google.com/&quot;

remDr$goForward()

&gt; remDr$getCurrentUrl()
[[1]]
[1] &quot;http://www.bbc.co.uk/&quot;

</code>

To refresh the current page you can use the `refresh method.
<code>remDr$refresh()

</code>

<h3 id="accessing-elements-in-the-dom">Accessing elements in the DOM</h3>
The DOM stands for the Document Object Model. 
It is a cross-platform and language-independent convention for representing and interacting with objects in HTML, XHTML and XML documents. 
Interacting with the DOM will be very important for us with Selenium and the webDriver provides a number of methods in which to do this.
A basic html page is
<code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;

&lt;h1&gt;My First Heading&lt;/h1&gt;

&lt;p&gt;My first paragraph.&lt;/p&gt;

&lt;/body&gt;
&lt;/html&gt;

</code>

The query box on the front page of <code>http://www.google.com</code> has html code <code>input id=&quot;gbqfq&quot; class=&quot;gbqfif&quot;</code> associated with it. 
The full html associated with the input tag is:
<code>&lt;input type=&quot;text&quot; value=&quot;&quot; autocomplete=&quot;off&quot; name=&quot;q&quot; class=&quot;gbqfif&quot; id=&quot;gbqfq&quot; style=&quot;border: medium none; padding: 0px; margin: 0px; height: auto; width: 100%; background: url(&amp;quot;data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw%3D%3D&amp;quot;) repeat scroll 0% 0% transparent; position: absolute; z-index: 6; left: 0px; outline: medium none;&quot; dir=&quot;ltr&quot; spellcheck=&quot;false&quot;&gt;

</code>

<h4 id="search-by-id">Search by id.</h4>
To find this element in the DOM a number of methods can be used. 
We can search by the id.
<code>remDr$navigate(&quot;http://www.google.com/ncr&quot;)
webElem &lt;- remDr$findElement(using = 'id', value = &quot;gbqfq&quot;)

&gt; webElem$getElementAttribute(&quot;id&quot;)
[[1]]
[1] &quot;gbqfq&quot;

&gt; webElem$getElementAttribute(&quot;class&quot;)
[[1]]
[1] &quot;gbqfif&quot;

</code>

<h4 id="search-by-class">Search by class.</h4>
We can also search by class name.
<code>webElem &lt;- remDr$findElement(using = 'class name', &quot;gbqfif&quot;)

&gt; webElem$getElementAttribute(&quot;class&quot;)
[[1]]
[1] &quot;gbqfif&quot;

&gt; webElem$getElementAttribute(&quot;type&quot;)
[[1]]
[1] &quot;text&quot;

</code>

<h4 id="search-using-css-selectors">Search using css-selectors</h4>
The class is denoted by <code>.</code> when using css selectors. 
To search on class using css selectors we would use
<code>webElem &lt;- remDr$findElement(using = 'css selector', &quot;input.gbqfif&quot;)

</code>

and to search on id using css-selectors
<code>webElem &lt;- remDr$findElement(using = 'css selector', &quot;input#gbqfq&quot;)

</code>

A good example of searching using css-selectors is given <a href="https://saucelabs.com/resources/selenium/css-selectors">here</a>.

<h4 id="search-by-name">Search by name</h4>
To search using the <code>name</code> if given of the element. 
Note that ids are unique in a given html page. 
Names are not necessarily unique.
<code>webElem &lt;- remDr$findElement(using = 'name', &quot;q&quot;)

&gt; webElem$getElementAttribute(&quot;name&quot;)
[[1]]
[1] &quot;q&quot;

&gt; webElem$getElementAttribute(&quot;id&quot;)
[[1]]
[1] &quot;gbqfq&quot;

</code>

<h4 id="search-using-xpath">Search using xpath</h4>
The final option is to search using xpath. 
Normally one would use xpath by default when searching.

Xpath using id.
<code>webElem &lt;- remDr$findElement(using = 'xpath', &quot;//*/input[@id = 'gbqfq']&quot;)
</code>

Xpath using class.
<code>webElem &lt;- remDr$findElement(using = 'xpath', &quot;//*/input[@class = 'gbqfif']&quot;)
</code>

<h3 id="sending-events-to-elements">Sending events to elements</h3>
To illustrate how to interact with elements we will again use the <code>http://www.google.com/ncr</code> as an example.

<h4 id="sending-text-to-elements">Sending text to elements</h4>
Suppose we would like to search for <code>R cran</code> on google. 
We would need to find the element for the query box and send the appropriate text to it. 
We can do this using the <code>sendKeysToElement</code> method for the <code>webElement</code> class.
<code>remDr$navigate(&quot;http://www.google.com/ncr&quot;)
webElem &lt;- remDr$findElement(using = &quot;xpath&quot;, &quot;//*/input[@id = 'gbqfq']&quot;)
webElem$sendKeysToElement(list(&quot;R Cran&quot;))

</code>

<h4 id="sending-key-presses-to-elements">Sending key presses to elements</h4>
We should see that the text <code>R Cran</code> has now been entered into the query box.
How do we press enter. 
We can simply send the enter key to query box. 
The enter key would be denoted as <code>&quot;\uE007&quot;</code>. 
So we could use:
<code>remDr$navigate(&quot;http://www.google.com/ncr&quot;)
webElem &lt;- remDr$findElement(using = &quot;xpath&quot;, &quot;//*/input[@id = 'gbqfq']&quot;)
webElem$sendKeysToElement(list(&quot;R Cran&quot;, &quot;\uE007&quot;))

</code>

It is not very easy to remember utf8 codes for appropriate keys so a mapping has been provided in <code>RSelenium</code>. 
`?selkeys&rsquo; will bring up a help page explaining the mapping. 
The utf codes given <a href="https://code.google.com/p/selenium/wiki/JsonWireProtocol#/session/:sessionId/element/:id/value">here</a> have been mapped to easy to remember names.

To use <code>selkeys</code> we would send the following
<code>remDr$navigate(&quot;http://www.google.com/ncr&quot;)
webElem &lt;- remDr$findElement(using = &quot;xpath&quot;, &quot;//*/input[@id = 'gbqfq']&quot;)
webElem$sendKeysToElement(list(&quot;R Cran&quot;, key = &quot;enter&quot;))

</code>

Typing <code>selKeys</code> into the console will bring up the list of mappings.

<h4 id="sending-mouse-events-to-elements">Sending mouse events to elements</h4>
For this example we will go back to the google frontpage and search for<code>R Cran</code> then we will click the link for the <code>The Comprehensive R Archive Network</code>.
<code>remDr$navigate(&quot;http://www.google.com/ncr&quot;)
webElem &lt;- remDr$findElement(using = &quot;xpath&quot;, &quot;//*/input[@id = 'gbqfq']&quot;)
webElem$sendKeysToElement(list(&quot;R Cran&quot;, key = &quot;enter&quot;))

</code>

<code>&lt;li class=&quot;g&quot;&gt;</code> contains the search results we can find all the search entries on the first page using the <code>findElements</code> method. 
The header for each link is contained further in with a <code>&lt;h3 class = &quot;r&quot;&gt;</code> tag. 
We will access the <code>h3</code> headers first. 
It will be succinct to find these elements using <code>css selectors</code>.
<code>webElems &lt;- remDr$findElements(using = 'css selector', &quot;li.g h3.r&quot;)
resHeaders &lt;- unlist(lapply(webElems, function(x){x$getElementText()}))
&gt; resHeaders
 [1] &quot;The Comprehensive R Archive Network&quot;
 [2] &quot;Comprehensive R Archive&quot;
 [3] &quot;Mirrors&quot;
 [4] &quot;Contributed Packages&quot;
 [5] &quot;R for Mac OS X&quot;
 [6] &quot;Download R 3.0.2&quot;
 [7] &quot;CRAN Repository Policy&quot;
 [8] &quot;The R Project for Statistical Computing&quot;
 [9] &quot;Cran - Wikipedia, the free encyclopedia&quot;
[10] &quot;Comprehensive R Archive Network (CRAN) - StatLib - Carnegie&quot;
[11] &quot;CRAN - Package R.methodsS3&quot;
[12] &quot;CRAN - Package R.cache&quot;
[13] &quot;Ubuntu - Details of package r-cran-sp in lucid&quot;

</code>

We can see that the first link is the one we want but in case googles search results change we refer to it as
<code>webElem &lt;- webElems[[which(resHeaders == &quot;The Comprehensive R Archive Network&quot;)]]
</code>

How do we click the link. 
We can use the <code>clickElement</code> method:
<code>webElem$clickElement()

&gt; remDr$getCurrentUrl()
[[1]]
[1] &quot;http://cran.r-project.org/&quot;

&gt; remDr$getTitle()
[[1]]
[1] &quot;The Comprehensive R Archive Network&quot;
</code>

<h3 id="injecting-javascript">Injecting JavaScript</h3>
Sometimes it is necessary to interact with the current url using JavaScript. 
This maybe necessary to call bespoke methods or to have more control over the page for example by adding the <code>JQuery</code> library to the page if it is missing. <code>Selenium</code> has two methods we can use to execute JavaScript namely<code>executeScript</code> and <code>executeAsyncScript</code> from the <code>remoteDriver</code> class. 
We return to the google front page to investigate these methods.

<h4 id="injecting-javascript-synchronously">Injecting JavaScript synchronously</h4>
Returning to the google homepage we can find the element for the <code>google</code> image. 
The image has <code>id = &quot;hplogo&quot;</code> and
we can use this in an xpath or search by id etc to select the element. 
In this case we use <code>css selectors</code>:
<code>remDr$navigate(&quot;http://www.google.com/ncr&quot;)
webElem &lt;- remDr$findElement(&quot;css selector&quot;, &quot;img#hplogo&quot;)

</code>

Is the image visible? Clearly it is but we can check using javascript.
<code>&gt; remDr$executeScript(&quot;return document.getElementById('hplogo').hidden;&quot;, args = list())
[[1]]
[1] FALSE

</code>

Great so the image is not hidden indicated by the <code>FALSE</code>. 
We can hide it executing some simple JavaScript.
<code>remDr$executeScript(&quot;document.getElementById('hplogo').hidden = true;&quot;, args = list())

&gt; remDr$executeScript(&quot;return document.getElementById('hplogo').hidden;&quot;, args = list())
[[1]]
[1] TRUE

</code>

So now the image is hidden. 
We used an element here given by <code>id = &quot;hplogo&quot;</code>. 
We had to use the JavaScript function<code>getElementById</code> to access it. 
It would be nicer if we could have used <code>webElem</code> which we had specified earlier.
If we pass a webElement object as an argument to either <code>executeScript</code> or <code>executeAsyncScript</code> <code>RSelenium</code> will pass it in an appropriate fashion.
<code>&gt; remDr$executeScript(script = &quot;return arguments[0].hidden = false;&quot;, args = list(webElem))
[[1]]
[1] FALSE

</code>

Notive how we passed the web element to the method <code>executeScript</code>. 
The script argument defines the script to execute in the form of a function body. 
The value returned by that function will be returned to the client. 
The function will be invoked with the provided args. 
If the function returns an element then this will be returned as an object of class webElement:
<code>test &lt;- remDr$executeScript(&quot;return document.getElementById('gbqfq');&quot;, args = list())

&gt; test[[1]]
[1] &quot;remoteDriver fields&quot;
$remoteServerAddr
[1] &quot;localhost&quot;

$port
[1] 4444

$browserName
[1] &quot;firefox&quot;

$version
[1] &quot;&quot;

$platform
[1] &quot;ANY&quot;

$javascript
[1] TRUE

$autoClose
[1] FALSE

$nativeEvents
[1] TRUE

$extraCapabilities
list()

[1] &quot;webElement fields&quot;
$elementId
[1] 1

&gt; class(test[[1]])
[1] &quot;webElement&quot;
attr(,&quot;package&quot;)
[1] &quot;RSelenium&quot;

</code>

<h4 id="injecting-javascript-asynchronously">Injecting JavaScript asynchronously</h4>
I will briefly touch on asynch versus sync calls here. 
With the current firefox and selenium server combination (firefox 26.0 sel server 2.39.0) I had issues with async javascript calls when <code>nativeEvents = TRUE</code> (the default) was used.

For the example below I switched to <code>nativeEvents = FALSE</code>
<code>
remDr &lt;- remoteDriver(nativeEvents = FALSE)
remDr$open()
remDr$navigate(&quot;http://www.google.com/ncr&quot;)
remDr$setAsyncScriptTimeout(10000)

</code>

Observe:
<code>remDr$executeAsyncScript(&quot;setTimeout(function(){ alert('Hello'); arguments[arguments.length -1]('DONE');},5000); &quot;, args = list())
</code>

versus
<code>remDr$executeScript(&quot;setTimeout(function(){ alert('Hello');},5000); return 'DONE';&quot;, args = list())

</code>

The async version waits until the callback (defined as the last argument) is called.

<h3 id="frames-and-windows">Frames and Windows</h3>
In the context of a web browser, a frame is a part of a web page or browser window which displays content independent of its container, with the ability to load content independently.

<h4 id="frames-in-selenium">Frames in Selenium</h4>
We will demonstrate interacting with frames by way of example. 
The <a href="https://www.r-project.org/">R project</a> conviently contains frames so we shall use <code>RSelenium</code> to interact with it.
Assume we have a remoteDriver opened.
<code>remDr$navigate(&quot;http://www.r-project.org/&quot;)

&gt; htmlParse(remDr$getPageSource()[[1]])
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
&lt;head&gt;
&lt;title&gt;The R Project for Statistical Computing&lt;/title&gt;
&lt;link type=&quot;image/x-icon&quot; href=&quot;favicon.ico&quot; rel=&quot;icon&quot;&gt;
&lt;link type=&quot;image/x-icon&quot; href=&quot;favicon.ico&quot; rel=&quot;shortcut icon&quot;&gt;
&lt;link href=&quot;R.css&quot; type=&quot;text/css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;/head&gt;
&lt;frameset border=&quot;0&quot; cols=&quot;1*, 4*&quot;&gt;
&lt;frameset rows=&quot;120, 1*&quot;&gt;
&lt;frame frameborder=&quot;0&quot; name=&quot;logo&quot; src=&quot;logo.html&quot;&gt;
&lt;frame frameborder=&quot;0&quot; name=&quot;contents&quot; src=&quot;navbar.html&quot;&gt;
&lt;/frameset&gt;
&lt;frame frameborder=&quot;0&quot; name=&quot;banner&quot; src=&quot;main.shtml&quot;&gt;
&lt;noframes&gt;
&amp;lt;h1&amp;gt;The R Project for Statistical Computing&amp;lt;/h1&amp;gt;

Your browser seems not to support frames,
here is the &amp;lt;A href=&quot;navbar.html&quot;&amp;gt;contents page&amp;lt;/A&amp;gt; of the R Project's
website.
&lt;/noframes&gt;
&lt;/frameset&gt;
&lt;/html&gt;

</code>

We can see the content is contained in three frames and we dont appear to have access to the content within a frame. 
Put in the browser we see all the content:
<code>remDr$maxWindowSize()
remDr$screenshot(display = TRUE)

</code>

<h6 align = center>RProject front page</h6>

<img src="https://dl.dropboxusercontent.com/u/38391057/RSelenium/basics/RProject.png"  title = "RProject front page on linux firefox 26.0"/>

To access the content we have to switch to a frame using the <code>switchToFrame</code> method of the <code>remoteDriver</code> class.
<code>webElems &lt;- remDr$findElements(using = &quot;tag name&quot;, &quot;frame&quot;)
# webElems &lt;- remDr$findElements(&quot;//frame&quot;) # using xpath

&gt; sapply(webElems, function(x){x$getElementAttribute(&quot;src&quot;)})
[[1]]
[1] &quot;http://www.r-project.org/logo.html&quot;

[[2]]
[1] &quot;http://www.r-project.org/navbar.html&quot;

[[3]]
[1] &quot;http://www.r-project.org/main.shtml&quot;

remDr$switchToFrame(webElems[[2]])

&gt; htmlParse(remDr$getPageSource()[[1]])
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
&lt;head&gt;
&lt;title&gt;R Contents&lt;/title&gt;
&lt;link href=&quot;R.css&quot; type=&quot;text/css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;em class=&quot;navigation&quot;&gt;About R&lt;/em&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;about.html&quot;&gt;What is R?&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;contributors.html&quot;&gt;Contributors&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;screenshots/screenshots.html&quot;&gt;Screenshots&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;news.html&quot;&gt;What's new?&lt;/a&gt;&lt;br&gt;&lt;p&gt;
&lt;em class=&quot;navigation&quot;&gt;Download, Packages&lt;/em&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;http://cran.r-project.org/mirrors.html&quot;&gt;CRAN&lt;/a&gt;

&lt;/p&gt;
&lt;p&gt;
&lt;em class=&quot;navigation&quot;&gt;R Project&lt;/em&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;foundation/main.html&quot;&gt;Foundation&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;foundation/memberlist.html&quot;&gt;Members &amp;amp; Donors&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;mail.html&quot;&gt;Mailing Lists&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;_top&quot; href=&quot;http://bugs.R-project.org&quot;&gt;Bug Tracking&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;_top&quot; href=&quot;http://developer.R-project.org&quot;&gt;Developer Page&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;conferences.html&quot;&gt;Conferences&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;search.html&quot;&gt;Search&lt;/a&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;
&lt;em class=&quot;navigation&quot;&gt;Documentation&lt;/em&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;http://cran.r-project.org/manuals.html&quot;&gt;Manuals&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;http://cran.r-project.org/faqs.html&quot;&gt;FAQs&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;_top&quot; href=&quot;http://journal.r-project.org&quot;&gt;The R Journal&lt;/a&gt;&lt;br&gt;&lt;!--
&lt;a href=&quot;doc/Rnews/index.html&quot; target=&quot;banner&quot;&gt;Newsletter&lt;/a&gt;&lt;br&gt;
--&gt;&lt;a target=&quot;_top&quot; href=&quot;http://wiki.r-project.org&quot;&gt;Wiki&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;doc/bib/R-books.html&quot;&gt;Books&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;certification.html&quot;&gt;Certification&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;other-docs.html&quot;&gt;Other&lt;/a&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;
&lt;em class=&quot;navigation&quot;&gt;Misc&lt;/em&gt;&lt;br&gt;&lt;a target=&quot;_top&quot; href=&quot;http://www.bioconductor.org&quot;&gt;Bioconductor&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;other-projects.html&quot;&gt;Related Projects&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;_top&quot; href=&quot;http://rwiki.sciviews.org/doku.php?id=rugs:r_user_groups&quot;&gt;User Groups&lt;/a&gt;&lt;br&gt;&lt;a target=&quot;banner&quot; href=&quot;links.html&quot;&gt;Links&lt;/a&gt;&lt;br&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

</code>

Now we see the source code of the navigation sidePanel. 
Notice how we used a webElement in the method <code>switchToFrame</code>. 
To further demonstrate we are now &ldquo;in&rdquo; this frame lets get all the <code>href</code> attributes:
<code>webElems &lt;- remDr$findElements(&quot;css selector&quot;, &quot;[href]&quot;)
sapply(webElems, function(x){x$getElementAttributes(&quot;href&quot;)})

&gt; unlist(sapply(webElems, function(x){x$getElementAttribute(&quot;href&quot;)}))
 [1] &quot;http://www.r-project.org/R.css&quot;
 [2] &quot;http://www.r-project.org/about.html&quot;
 [3] &quot;http://www.r-project.org/contributors.html&quot;
 [4] &quot;http://www.r-project.org/screenshots/screenshots.html&quot;
 [5] &quot;http://www.r-project.org/news.html&quot;
 [6] &quot;http://cran.r-project.org/mirrors.html&quot;
 [7] &quot;http://www.r-project.org/foundation/main.html&quot;
 [8] &quot;http://www.r-project.org/foundation/memberlist.html&quot;
 [9] &quot;http://www.r-project.org/mail.html&quot;
[10] &quot;http://bugs.r-project.org/&quot;
[11] &quot;http://developer.r-project.org/&quot;
[12] &quot;http://www.r-project.org/conferences.html&quot;
[13] &quot;http://www.r-project.org/search.html&quot;
[14] &quot;http://cran.r-project.org/manuals.html&quot;
[15] &quot;http://cran.r-project.org/faqs.html&quot;
[16] &quot;http://journal.r-project.org/&quot;
[17] &quot;http://wiki.r-project.org/&quot;
[18] &quot;http://www.r-project.org/doc/bib/R-books.html&quot;
[19] &quot;http://www.r-project.org/certification.html&quot;
[20] &quot;http://www.r-project.org/other-docs.html&quot;
[21] &quot;http://www.bioconductor.org/&quot;
[22] &quot;http://www.r-project.org/other-projects.html&quot;
[23] &quot;http://rwiki.sciviews.org/doku.php?id=rugs:r_user_groups&quot;
[24] &quot;http://www.r-project.org/links.html&quot;

</code>

Notice if we pass a <code>NULL</code> value to the method <code>switchToFrame</code> we move back to the default view.
<code>remDr$switchToFrame(NULL)

&gt; htmlParse(remDr$getPageSource()[[1]])
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
&lt;head&gt;
&lt;title&gt;The R Project for Statistical Computing&lt;/title&gt;
&lt;link type=&quot;image/x-icon&quot; href=&quot;favicon.ico&quot; rel=&quot;icon&quot;&gt;
&lt;link type=&quot;image/x-icon&quot; href=&quot;favicon.ico&quot; rel=&quot;shortcut icon&quot;&gt;
&lt;link href=&quot;R.css&quot; type=&quot;text/css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;/head&gt;
&lt;frameset border=&quot;0&quot; cols=&quot;1*, 4*&quot;&gt;
&lt;frameset rows=&quot;120, 1*&quot;&gt;
&lt;frame frameborder=&quot;0&quot; name=&quot;logo&quot; src=&quot;logo.html&quot;&gt;
&lt;frame frameborder=&quot;0&quot; name=&quot;contents&quot; src=&quot;navbar.html&quot;&gt;
&lt;/frameset&gt;
&lt;frame frameborder=&quot;0&quot; name=&quot;banner&quot; src=&quot;main.shtml&quot;&gt;
&lt;noframes&gt;
&amp;lt;h1&amp;gt;The R Project for Statistical Computing&amp;lt;/h1&amp;gt;

Your browser seems not to support frames,
here is the &amp;lt;A href=&quot;navbar.html&quot;&amp;gt;contents page&amp;lt;/A&amp;gt; of the R Project's
website.
&lt;/noframes&gt;
&lt;/frameset&gt;
&lt;/html&gt;

</code>

Finally we can switch to the main panel using a name
<code>remDr$switchToFrame(&quot;banner&quot;)

&gt; htmlParse(remDr$getPageSource()[[1]])
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
&lt;head&gt;
&lt;title&gt;The R Project for Statistical Computing&lt;/title&gt;
&lt;link href=&quot;R.css&quot; type=&quot;text/css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;h1 align=&quot;left&quot;&gt;The R Project for Statistical Computing&lt;/h1&gt;

&lt;p&gt;
&lt;/p&gt;
&lt;center&gt;
&lt;a href=&quot;misc/acpclust.R&quot;&gt;&lt;img border=&quot;0&quot; alt=&quot;R Graphics Demo&quot; src=&quot;hpgraphic.png&quot;&gt;&lt;/a&gt;
&lt;/center&gt;

&lt;p&gt;
&lt;/p&gt;
&lt;table width=&quot;100%&quot; border=&quot;1&quot;&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;
    &lt;h2&gt;Getting Started:&lt;/h2&gt;
    &lt;ul&gt;
&lt;li&gt;R is a free software environment for statistical
      computing and graphics. 
It compiles and runs on a wide variety
      of UNIX platforms, Windows and MacOS. 
To &lt;strong&gt;&lt;a href=&quot;http://cran.r-project.org/mirrors.html&quot;&gt;download R&lt;/a&gt;&lt;/strong&gt;, please
      choose your preferred &lt;a href=&quot;http://cran.r-project.org/mirrors.html&quot;&gt;CRAN mirror&lt;/a&gt;.
      &lt;/li&gt;
      &lt;li&gt;
      If you have questions about R like how to download and install
      the software, or what the license terms are,
      please read our &lt;a href=&quot;http://cran.R-project.org/faqs.html&quot;&gt;answers to frequently asked questions&lt;/a&gt; before you send an email.
      &lt;/li&gt;
    &lt;p&gt;
  &lt;/p&gt;
&lt;/ul&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;
    &lt;h2&gt;News:&lt;/h2&gt;

    &lt;ul&gt;
&lt;li&gt;
&lt;strong&gt;R version 3.0.2&lt;/strong&gt; (Frisbee Sailing) has been
      released on 2013-09-25.&lt;/li&gt;

      &lt;li&gt;
      &lt;strong&gt;&lt;a href=&quot;http://www.r-project.org/useR-2013&quot; target=&quot;_top&quot;&gt;
      useR! 2013&lt;/a&gt;&lt;/strong&gt;,
      took place at the University of Castilla-La Mancha,
      Albacete, Spain, July 10-12 2013.

      &lt;/li&gt;
&lt;li&gt;
  &lt;a target=&quot;_top&quot; href=&quot;http://journal.r-project.org/current.html&quot;&gt;
    &lt;strong&gt;The R Journal Vol.5/1&lt;/strong&gt;&lt;/a&gt;
  is available.
      &lt;/li&gt;
      &lt;li&gt;
&lt;strong&gt;R version 2.15.3&lt;/strong&gt; (Security Blanket) has been
      released on 2013-03-01.&lt;/li&gt;


&lt;!-- Dead stuff, for later reuse:

            &lt;li&gt;
      &lt;strong&gt;&lt;a href=&quot;http://cran.R-project.org/src/base-prerelease&quot;&gt;
      R 3.0.2 (Frisbee Sailing) prerelease versions&lt;/a&gt;&lt;/strong&gt; will
      appear starting
      September 15.
      Final release is scheduled for September 25, 2013.&lt;br&gt;
      Thanks to Erin Hodgess for the idea leading to the name.
      &lt;/li&gt;

      &lt;li&gt;
      &lt;strong&gt;&lt;a href=&quot;http://cran.R-project.org/src/base-prerelease&quot;&gt;
      R 3.0.1 prerelease versions&lt;/a&gt;&lt;/strong&gt; will appear starting
      May 6.
      Final release is scheduled for May 16, 2013.&lt;br&gt;
      &lt;/li&gt;

      &lt;li&gt;
      The R Foundation as been awarded &lt;a
      href=&quot;soc11/index.html&quot;&gt;
      fifteen slots for R projects&lt;/a&gt; in the &lt;a
      href=&quot;http://code.google.com/soc/&quot; target=&quot;_top&quot;&gt;Google Summer of Code 2011&lt;/a&gt;.

     &lt;li&gt;
      &lt;strong&gt;&lt;a target=&quot;_top&quot;
      href=&quot;http://www.r-project.org/dsc-2009&quot;&gt; DSC 2009&lt;/a&gt;&lt;/strong&gt;,
      The 6th workshop on Directions in Statistical Computing, has been
      held at the Center for Health and Society, University of
      Copenhagen, Denmark, July 13-14, 2009. 
&lt;/li&gt;
      &lt;li&gt;
      &lt;strong&gt;&lt;a target=&quot;_top&quot; href=&quot;http://www.agrocampus-rennes.fr/math/useR-2009/&quot;&gt;
      useR! 2009&lt;/a&gt;&lt;/strong&gt;, the R user conference,
      has been be held at Agrocampus Rennes, France, July 8-10, 2009.

      &lt;li&gt;
      The R Foundation as been awarded &lt;a
      href=&quot;soc09/index.html&quot;&gt;
      four slots for R projects&lt;/a&gt; in the &lt;a
      href=&quot;http://socghop.appspot.com/org/home/google/gsoc2009/rf&quot; target=&quot;_top&quot;&gt;Google Summer of Code 2009&lt;/a&gt;.
      &lt;li&gt;We have started to collect ideas for the &lt;a
      href=&quot;http://www.r-project.org/soc09&quot;&gt;Google Summer of Code 2009&lt;/a&gt;.

      &lt;/li&gt;
--&gt;
    &lt;/ul&gt;
&lt;p&gt;
  &lt;/p&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;

  This server is hosted by the &lt;a target=&quot;_top&quot; href=&quot;http://statmath.wu.ac.at&quot;&gt;Institute for Statistics and Mathematics&lt;/a&gt; of &lt;a target=&quot;_top&quot; href=&quot;http://www.wu.ac.at&quot;&gt;WU (Wirtschaftsuniversien)&lt;/a&gt;.

&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

</code>

<h4 id="windows-in-selenium">Windows in Selenium</h4>
The easiest way to illustrate Windows in RSelenium is again by way of example. 
We will use the R project website.
First we select the <code>download R</code> element in the main frame.
<code>remDr$navigate(&quot;http://www.r-project.org&quot;)
remDr$switchToFrame(&quot;banner&quot;)
webElem &lt;- remDr$findElement(&quot;partial link text&quot;, &quot;download R&quot;)

&gt; webElem$getElementText()
[[1]]
[1] &quot;download R&quot;

</code>

We now send a selection of key presses to this element to open the link it points to in a new window. 
If you did it manually you would move the mouse to the element right click on the link press the down arrow key twice then press enter. 
We will do the same
<code>loc &lt;- webElem$getElementLocation()

&gt; loc[c('x','y')]
$x
[1] 347

$y
[1] 519

remDr$mouseMoveToLocation(webElement = webElem) # move mouse to the element we selected
remDr$click(2) # 2 indicates click the right mouse button
remDr$sendKeysToActiveElement(list(key = 'down_arrow', key = 'down_arrow', key = 'enter'))

</code>

Notice now that a new windows has opened on the remote browser.
<code>&gt; remDr$getCurrentWindowHandle()
[[1]]
[1] &quot;{573d17e5-b95a-41b9-a65f-04092b6a804b}&quot;

&gt; remDr$getWindowHandles()
[[1]]
[1] &quot;{573d17e5-b95a-41b9-a65f-04092b6a804b}&quot; &quot;{3336c9b3-4c46-4a95-853e-2786a529ba29}&quot;

&gt; remDr$getTitle()
[[1]]
[1] &quot;The R Project for Statistical Computing&quot;

&gt;
&gt; remDr$switchToWindow(&quot;{3336c9b3-4c46-4a95-853e-2786a529ba29}&quot;)
&gt; remDr$getTitle()
[[1]]
[1] &quot;CRAN - Mirrors&quot;

</code>

So using the code above one can observe how to switch between different windows on the remote browser.

<h3 id="take-1-traditional-http-request">Take 1: traditional http request</h3>
When possible, it makes sense to use the simple traditional methods. 
So I first tried to extract these tickers with the popular <code>httr</code> R package

by making standard http requests.
<code class="language-r" data-lang="r">>library(&#39;httr&#39;)
url <- &#39;https://www.fidelity.com/fund-screener/evaluator.shtml#!&ft=BAL_all&ntf=N&expand=%24FundType&rsk=5&#39;
page <- GET(>url)</code>

Success…
<code class="language-r" data-lang="r">>print(http_status(page))</code>

<code class="language-text" data-lang="text">## $category
## [1] "success"
## 
## $message
## [1] "success: (200) OK"</code>

But did our http request return the information we want?
<code class="language-r" data-lang="r">page_text <- content(page, as=&#39;text&#39;)</code>

Nope – can’t find the tickers (one of them anyway). 

<code class="language-r" data-lang="r">>grepl(&#39;GMMAX&#39;, page_text, ignore.case=>T)</code>

<code class="language-text" data-lang="text">## [1] FALSE</code>

Nope – can’t even find the fund name that I see in the table from the webpage in my browser. 

<code class="language-r" data-lang="r">>grepl(&#39;Aberdeen&#39;, page_text, ignore.case=>T)</code>

<code class="language-text" data-lang="text">## [1] FALSE</code>

<i>It appears that the content of interest is being generated dynamically with Javascript and Ajax on this webpage.</i>

So the raw HTML of this page doesn’t help us much.
My plan B was to grab the url for each fund from the table, navigate to that fund’s page, and extract the ticker from there.

However these links weren’t in our http response. 
I noticed that the URLs for each fund followed a simple consistent structure. 


<a href="https://fundresearch.fidelity.com/mutual-funds/summary/72201F433" rel="nofollow" target="_blank">https://fundresearch.fidelity.com/mutual-funds/summary/72201F433</a> for example.

I thought maybe I could find 72201F433 which looks like some sort of fund ID in a list with all fund IDs in the http response.

No dice. 
Plan C – Selenium.
<h3 id="take-2-selenium">Take 2: Selenium</h3>
I used the <a href="https://www.github.com/ropensci/RSelenium/" rel="nofollow" target="_blank">RSelenium</a> R package for this mini project. 
There are also Selenium bindings for Python, Java, C#, Javascript and Ruby

which make replicating this process in your programming language of choice relatively straightforward.
<strong>Step 1: Fire up Selenium</strong>
<span class="orange">sample:
require(RSelenium)
checkForServer()
startServer()
remDr<-remoteDriver()
remDr$open()
remDr$getStatus()
remDr$navigate("http://fyed.elections.on.ca/fyed/en/form_page_en.jsp")
p.codes<-c('m1p4v4', 'n3t2y3', 'n2h3v1')
webElem<-remDr$findElement(using = 'id', value = "pcode")
webElem$sendKeysToElement(list(p.codes[1])) # send the first post code to the element
remDr$findElement("id", "en_btn_arrow")$clickElement() # find the submit button and click it	collect info using RSelenium
</span>

<code class="language-r" data-lang="r">>library(&#39;RSelenium&#39;)
checkForServer() ># search for and download Selenium Server java binary. 
Only need to run once.
startServer() ># run Selenium Server binary
remDr <- remoteDriver(browserName="firefox", port=4444) ># instantiate remote driver to connect to Selenium Server
remDr$>open(silent=>T) ># open web browser</code>


<strong>Step 2: Start scraping</strong>
To figure which DOM elements I wanted Selenium extract, I used the Chrome Developer Tools which can be invoked by right clicking a fund in the table and selecting Inspect Element. 
The HTML displayed here contains exactly what we want, what we didn’t see with our http request.
Since I want to grab all the funds at once, I tell Selenium to select the whole table. 
Going a few levels up from the individual cell in the table I’ve selected, I see that <code><tbody id="tbody"></code> is the HTML tag that contains the entire table, so I tell Selenium to find this element. 
I use the nifty <code>highlightElement</code> function to confirm graphically in the browser that this is what I think it is.
Then it’s business as usual. 
I parse the string output from Selenium into an HTML tree and use XPath to parse the table for just the fund name and ticker.
<code class="language-r" data-lang="r">>library(&#39;XML&#39;)
master <- >c()
n <- 5 ># number of pages to scrape. 
80 pages in total. 
I just scraped 5 pages for this example.
>for(i >in 1:n) {
 site <- >paste0("https://www.fidelity.com/fund-screener/evaluator.shtml#!&ntf=N&ft=BAL_all&msrV=advanced&sortBy=FUND_MST_MSTAR_CTGY_NM&pgNo=",i) ># create URL for each page to scrape
 remDr$navigate(site) ># navigates to webpage
 
 elem <- remDr$findElement(using="id", value="tbody") ># get big table in text string
 elem$highlightElement() ># just for interactive use in browser. 
not necessary.
 elemtxt <- elem$getElementAttribute("outerHTML")[[1]] ># gets us the HTML
 elemxml <- htmlTreeParse(elemtxt, useInternalNodes=>T) ># parse string into HTML tree to allow for querying with XPath
 fundList <- >unlist(xpathApply(elemxml, &#39;//input[@title]&#39;, xmlGetAttr, &#39;title&#39;)) ># parses out just the fund name and ticker using XPath
 master <- >c(master, fundList) ># append fund lists from each page together
}

>head(master)</code>

<code class="language-text" data-lang="text">## [1] "FidelityAA Global Balanced Fund (FGBLX)"                    
## [2] "FidelityAA Global Strategies Fund (FDYSX)"                  
## [3] "Fidelity FreedomA 2055 Fund (FDEEX)"                       
## [4] "Aberdeen Dynamic Allocation Fund Class A (GMMAX)"           
## [5] "Aberdeen Dynamic Allocation Fund Class C (GMMCX)"           
## [6] "AllianceBernstein Real Asset Strategy Advisor Class (AMTYX)"</code>

<strong>Step 3: Extract ticker</strong>
Nothing fancy here – just separating the ticker from the fund name.
<code class="language-r" data-lang="r">master2 <- >data.frame(>sapply(master, >function(x) >substr(x, >nchar(x)-5, >nchar(x)-1)))
master2$name <- >sapply(master, >function(x) >substr(x, 0, >nchar(x)-8))
>names(master2) <- >c(&#39;ticker&#39;, &#39;name&#39;)

>head(master2)</code>

<code class="language-text" data-lang="text">##   ticker                                                name
## 1  FGBLX                     FidelityAA Global Balanced Fund
## 2  FDYSX                   FidelityAA Global Strategies Fund
## 3  FDEEX                        Fidelity FreedomAA 2055 Fund
## 4  GMMAX            Aberdeen Dynamic Allocation Fund Class A
## 5  GMMCX            Aberdeen Dynamic Allocation Fund Class C
## 6  AMTYX AllianceBernstein Real Asset Strategy Advisor Class</code>

<h3 id="what-else-can-selenium-do">What else can Selenium do?</h3>
My little example makes use of the simple functionality provided by Selenium for web scraping – rendering HTML that is dynamically generated with Javascript or Ajax. 
Since Selenium is actually a web automation tool, one can be much more sophisticated by using it to automate a human navigating a webpage with mouse clicks and writing and submitting forms. 
This can be a huge time saver for researchers that rely on front-end interfaces on the web to extract data in chunks.
<a href="http://thiagomarzagao.com/2013/11/12/webscraping-with-selenium-part-1/" rel="nofollow" target="_blank">Here’s</a> a basic example using Python.

<a href="https://cran.r-project.org/web/packages/RSelenium/vignettes/RSelenium-basics.html" rel="nofollow" target="_blank">Here’s</a> a basic example using R.
<h3 id="getting-setup">Getting setup</h3>
On the several computers I use, I’ve found setup ranging from seamless to frustrating.
The most frustrating issue I encountered while setting up on my Mac was this error message:
<code class="language-r" data-lang="r">> remDr$>open()

[1] "Connecting to remote server"
Error:    Summary: UnknownError
	 Detail: An unknown server-side error occurred >while processing the command.
	 >class: java.lang.IllegalStateException</code>

I was able to resolve it by killing all processes running on port 4444 and trying again.
At the terminal:
<code class="language-r" data-lang="r">lsof -i :4444</code>

Kill PIDs of any processes listed. 
For example:
<code class="language-r" data-lang="r">kill 30681</code>
<br>
<h2></h2>

<h2>Python 進階爬蟲技巧 selenium + chrome</h2>

隨著網路教學資源的豐富，簡易的爬蟲稍微有點程式基礎就可以寫出來，這間接導致很多網站加上了 captcha 來避免爬蟲，由於 captcha 是由 javascript 產生，這幾乎就阻擋了大部分的簡易爬蟲 (如 requests + bs4)。

之前一直有再用 requests + bs4 來做自動簽到，但最近這網站突然加上了 captcha，導致爬圖突然不能用了，買一個進階會員需要 500 RMB，想了一下還是決定土炮弄一套進階的簽到程式，並跑在 linode (cloud server) 上，用以達到每天簽到的功能。

這邊文章會教你如何使用 selenium + chrome 模擬瀏覽器行為抓取資料，並分享我踩到的各種雷，有興趣歡迎 follow。


原始碼在 <a href="https://github.com/kcfang/python-selenium-crawler" target="_blank">https://github.com/kcfang/python-selenium-crawler</a>


<h2>系統設置</h2>這邊使用 docker ubuntu 18.04 image 作範例。


<h2>安裝 Python3 + Selenium</h2>

apt update
apt install -y python3 python3-pip
pip install selenium


<h2>安裝 Chrome + Chromedriver (selenium調用接口)</h2>

安裝 chrome
wget <a href="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb" target="_blank">https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</a>
apt install ./google-chrome-stable_current_amd64.deb

查看 chrome 版本
google-chrome --version
Google Chrome 74.0.3729.131

到<a href="http://chromedriver.chromium.org/downloads" class= target="_blank" rel="noopener nofollow">chrome driver網站下</a>載對應版本的 driver。


安裝 chrome driver (v74版)
wget <a href="https://chromedriver.storage.googleapis.com/74.0.3729.6/chromedriver_linux64.zip" class= target="_blank" rel="noopener nofollow">https://chromedriver.storage.googleapis.com/74.0.3729.6/chromedriver_linux64.zip</a>

這邊將 chromedriver 放到家目錄下 (docker image以/root為家目錄)
unzip chromedriver_linux64.zip -d /root/


<h2>Selenium 簡易教學 + 安裝測試</h2>
Selenium 的主要功能是透過程式去操作網頁 DOM，所以很多公司都拿 Selenium 來寫前端的自動化測試，我們要做的就是使用 Selenium 模擬人工的行為。


#!/usr/bin/python3
# python yahoo.py

from selenium import webdriver
from selenium.webdriver.chrome.options import Options

if __name__ == "__main__":
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    driver = webdriver.Chrome('~/chromedriver', chrome_options=options)
    driver.set_window_size(1024, 960)

    # 使用 driver 開起 <a href="https://tw.yahoo.com" class= target="_blank" rel="noopener nofollow">https://tw.yahoo.com</a>
    driver.get("<a href="https://tw.yahoo.com" class= target="_blank" rel="noopener nofollow">https://tw.yahoo.com</a>")

    # 使用 xpath 找到搜尋欄並填入 hello world
    inputs = driver.find_element_by_xpath('//*[<a href="http://twitter.com/id" class= target="_blank" rel="noopener nofollow">@id</a>="UHSearchBox"]')
    inputs.send_keys("hello world")

    # 找到送出鍵並點擊
    driver.find_element_by_xpath('//*[<a href="http://twitter.com/id" class= target="_blank" rel="noopener nofollow">@id</a>="UHSearchWeb"]').click()

    # 將目前頁面存到 yahoo.png
    driver.save_screenshot('yahoo.png')

上面的程式簡單透過 chromedrive 控制 chrome，由於我程式是跑在 cloud server 上，所以需要加上 --headless 及 --no-sandbox 選項，這樣 chromedriver 就不需要開啟 chrome。

直接執行 yahoo.py 可以看到當前資料夾出現了一張 yahoo.png。



<img src="https://miro.medium.com/max/1382/0*zaIJPLqh0CGAVPaE.png">

比較值得注意的是粗體的那行 driver.set_window_size(1024, 960)，由於 Selenium 是模擬瀏覽器行為，瀏覽器大小也會直接影響結果，我在抓取 captcha 的時候就踩到瀏覽器視窗不夠大的坑，這讓我 debug 了半小時…

<h2>疑難排解</h2>

問題 1.

selenium.common.exceptions.WebDriverException: Message: unknown error: session deleted because of page crash from tab crashed

如果遇到 Message: unknown error: session deleted because of page crash
from tab crashed，有可能的原因是你的系統資源不夠，由於我是跑在最便宜的 cloud server 上，1G 的 RAM 可能會支撐不住 Chrome 的摧殘…
如果遇到就把程式用不到的程式關一關，chrome / chromedriver 也都砍到掉，然後再重跑一次。


問題 2.

selenium.common.exceptions.WebDriverException: Message: 'chromedriver' executable needs to be in PATH. Please see <a href="https://sites.google.com/a/chromium.org/chromedriver/home" class= target="_blank" rel="noopener nofollow">https://sites.google.com/a/chromium.org/chromedriver/home</a>

這是因為 chromedriver 找不到，請確認 chromedriver 有放到 ${HOME} 下。


問題 3.

selenium.common.exceptions.WebDriverException: Message: unknown error: Chrome failed to start: crashed

這有兩個可能

chromedriver / chrome 版本對不上，請參考教學重新下載正確的 chromedriver。

與問題 1 一樣，資源不夠連開都開不起來 orz…

<h2>如何找到 DOM 的 xpath</h2>
打開<a href="https://developers.google.com/web/tools/chrome-devtools/?hl=zh-tw" class= target="_blank" rel="noopener nofollow">開發人員工具</a>，<a href="https://developers.google.com/web/tools/chrome-devtools/dom/?hl=zh-tw" class= target="_blank" rel="noopener nofollow">選取需要的 DOM</a>，右鍵→Copy→Copy XPath。


<img class= src="https://miro.medium.com/max/1078/1*EeK8JgACc2OLd_CZG0AiQg.png">


<h2>小結</h2>基本上到這邊就可以簡單使用 selenium + chrome 對網頁進行操作，



<br>
<br>
<br>

<script>
	var toc = $('#toc');
	$('h2, h3').each(function(i) {
		var topic = $(this), topicNumber = i + 1;
		toc.append('<a href="#topic-'+topicNumber+'" target="_self">'+topic.text()+'</a><br>');
		topic.attr('id', 'topic-' + topicNumber);
	});
</script>

