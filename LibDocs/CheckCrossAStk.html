
<!DOCTYPE html>
<!--meta http-equiv="refresh" content="300"-->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<html>
<head>
<title>check cross A stk</title>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src='https://williamkpchan.github.io/mainscript.js'></script>
<script src="https://williamkpchan.github.io/LibDocs/stkComments.js"></script>
<script src="https://williamkpchanhp.github.io/filterResulitLib.txt"></script>
<script src="https://code.jquery.com/mobile/1.5.0-alpha.1/jquery.mobile-1.5.0-alpha.1.min.js"></script>

<script src="https://williamkpchanhp.github.io/LibDocs/longHistList.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.core.js" ></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.line.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.drawing.yaxis.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.dynamic.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.tooltips.js"></script>
<script src="https://williamkpchanhp.github.io/codeList.js"></script>
<script src='https://cdn.plot.ly/plotly-2.34.0.min.js'></script>
<script>
  var showTopicNumber = false;
  var topicEnd = "&emsp;";
  var bookid = "check cross A stk"
  var markerName = "h2"
</script>

<style>
body {width:98%;margin-left: 1%; font-size:24px;}
#dateTime {  text-align: left;}
#cmtNote, #instruction, #message, #usstock{display:none;}
#amtLst {font-size:12px;}
#actions {font-size:12px; text-align: left; tab-size: 8; margin-left: 5%;}
select {border-radius:10px; font-size:20px;background-color:black; color:brown;}
#ohlcDiv {display:inline-block; width:85%; height:700px;}
#linechart {display:inline-block; width:85%; height:700px;}
</style>

</head>
<body onkeypress="chkKey()">

<center>
<h1><lg>check cross A stk</lg></h1>
<span class="goldword">&rarr;</span> <span id="dateAndTime" onclick="showDateAndTime()"><script>showDateAndTime();</script></span><br>
<div id="toc">
<a href="#10" target="_self">prevStat</a>
<a href="#0" target="_self">Stat</a>
 <a href="#1" target="_self">M Upcross</a>
 <a href="#2" target="_self"><gr>M Dncross</gr></a>
 <a href="#3" target="_self">H Upcross</a>
 <a href="#4" target="_self"><gr>L Dncross</gr></a>
 <a href="#5" target="_self">M Cont.Up</a>
 <a href="#6" target="_self"><gr>M Cont.Dn</gr></a>

 <a href="#9" target="_self">cross status</a> </div>
</center>
<br>
<pre>
<h2 id="10">previous statistics</h2><span class="redbut" onclick="updateStat('ChkXAstkprevStatus');")>Load Prev Stat</span>
<div id="prevstatistics"></div>

<h2 id="0">statistics</h2>
<div id="statistics"></div>

<h2 id="1">M Upcross</h2>
<div id="NewUpcross"></div>

<h2 id="2"><gr>M Dncross<gr></h2>
<div id="NewDncross"></div>

<h2 id="3">H Upcross</h2>
<div id="NewHUpcross"></div>

<h2 id="4"><gr>L Dncross<gr></h2>
<div id="NewLDncross"></div>

<h2 id="5"><r>Cont.Up<r></h2>
<div id="Cont.Up"></div>

<h2 id="6"><gr>Cont.Dn<gr></h2>
<div id="Cont.Dn"></div>



<h2 id="9">cross status</h2>
<div id="upcrossResult"></div>



</pre>

<script>
     //codetable = ['600519','601127','000977','002156','601138','002085','002475','300308','600171','300394','601899','300502','688525','300098','002594','001696','600584','300641','002384','000333','601919','300346','688256','301236','300750','603986','600036','603259','000625','300552','000021','603019','000063','000099','000858','600938','601318','600733','600895','002654','002371','300496','600150','002373','600900','300107','688981','000938','002938','300576','603993','601857','601398','601328','300284','300177','300059','600418','002869','688111','601288','601012','002902','002463','601669','002600','301091','000568','688012','600941','601020','000651','600487','601888','603501','000002','603083','002130','300429','688041','002455','601136','002028','688008','603005','002920','601088','300046','600489','001309','300398','002049','301308','300290','600309','002241','600028','000100','300643','601933','601985','002050','002229','300956','300476','000676','600809','000737','000725','600837','300411','601600','600887','300293','601166','300418','002230','300015','605117','300342','600101','600030','300139','000628','601939','600276','002281','600183','300433','301251','002155','603283','000975','000001','000400','300474','300124','601179','300538','301036','300014','601058','300455','002409','600843','300274','600690','605111','300339','002851','601658','601567','300903','600345','300719','300868','600905','300806','000338','002436','601988','601766','300475','600066','301180','002456','301392','001298','300782','600580','301306','002459','000034','600745','301339','603528','600312','000988','300457','002714','300672','601901','605358','300567','300637','301176','600031','600501','603799','002273','300975','000901','001979','688692','600406','301297','300319','002943','688777','300739','002185','002129','300760','603660','601878','002304','300604','300563','300644','600547','605258','002338','002119','300001','600754','688036','600114','601728','300184','600050','300735','000829','300083','301538','300557','601881','300573','301183','600048','600566','300115','000519','002199','301208','301099','002179','600522','301005','301550','601689','600992','300458','301221','300316','688631','600919','002916','600460','300364','688347','002405','601668','600660','300040','300373','002709','002889','601099','600601','300762','300175','600438','600256','300075','300666','300122','300498','601211','300223','688484','000807','300033','600795','601162','600711','605588','603290','300638','002590','300757','600719','600089','688766','601225','688599','300917','002296','601615','300408','002077','000630','601168','300822','300843','603087','601601','300542','300690','601208','002466','688518','300667','002970','300002','688720','000528','002837','688037','301301','301548','300212','300663','603018','300696','000793','601688','600111','600761','002027','301337','000831','603650','300413','300484','300017','002532','002142','002415','000875','688498','688693','300655','301041','601186','600129','601117','002827','300045','688609','600016','002422','601028','002558','301348','688047','688249','688271','300073','601816','600830','300738','601633','603679','002517','002460','002340','601998','300711','002555','688318','301517','002815','301368','002236','301577','600133','301591','001389','603659','600027','002625','300885','301486','000037','300162','300724','688183','300537','600789','600988','300118','301596','001314','601233','300292','000682','000801','600326','301095','600893','300133','301082','600160','300570','002648','600188','300784','000657','300151','603160','300461','603860','002252','600301','000158','300590','000560','600621','002353','300647','300925','002261','001339','300763','002138','300270','300732','300444','688223','603220','688385','600536','688343','300623','301282','600362','600383','601390','300650','688361','300446','600436','603078','300207','002008','301050','300136','600703','600497','002271','300787','301218','002074','300722','301536','003816','300360','001965','002737','603105','000932','600760','300933','603613','601456','300900','000766','600006','600019','601628','600000','603806','600600','300913','301136','601799','002222','002055','688516','002607','600011','688107','688535','601699','000423','601989','300624','600482','000049','300199','300442','601009','002922','601006','300450','600765','002579','000521','603002','601077','000596','600219','002352','688169','000933','301083','600926','301361','000677'];
     codetable = "600519 601127 000977 002156 601138 002085 002475 300308 600171 300394 601899 300502 688525 300098 002594 001696 600584 300641 002384 000333 601919 300346 688256 301236 300750 603986 600036 603259 000625 300552 000021 603019 000063 000099 000858 600938 601318 600733 600895 002654 002371 300496 600150 002373 600900 300107 688981 000938 002938 300576 603993 601857 601398 601328 300284 300177 300059 600418 002869 688111 601288 601012 002902 002463 601669 002600 301091 000568 688012 600941 601020 000651 600487 601888 603501 000002 603083 002130 300429 688041 002455 601136 002028 688008 603005 002920 601088 300046 600489 001309 300398 002049 301308 300290 600309 002241 600028 000100 300643 601933 601985 002050 002229 300956 300476 000676 600809 000737 000725 600837 300411 601600 600887 300293 601166 300418 002230 300015 605117 300342 600101 600030 300139 000628 601939 600276 002281 600183 300433 301251 002155 603283 000975 000001 000400 300474 300124 601179 300538 301036 300014 601058 300455 002409 600843 300274 600690 605111 300339 002851 601658 601567 300903 600345 300719 300868 600905 300806 000338 002436 601988 601766 300475 600066 301180 002456 301392 001298 300782 600580 301306 002459 000034 600745 301339 603528 600312 000988 300457 002714 300672 601901 605358 300567 300637 301176 600031 600501 603799 002273 300975 000901 001979 688692 600406 301297 300319 002943 688777 300739 002185 002129 300760 603660 601878 002304 300604 300563 300644 600547 605258 002338 002119 300001 600754 688036 600114 601728 300184 600050 300735 000829 300083 301538 300557 601881 300573 301183 600048 600566 300115 000519 002199 301208 301099 002179 600522 301005 301550 601689 600992 300458 301221 300316 688631 600919 002916 600460 300364 688347 002405 601668 600660 300040 300373 002709 002889 601099 600601 300762 300175 600438 600256 300075 300666 300122 300498 601211 300223 688484 000807 300033 600795 601162 600711 605588 603290 300638 002590 300757 600719 600089 688766 601225 688599 300917 002296 601615 300408 002077 000630 601168 300822 300843 603087 601601 300542 300690 601208 002466 688518 300667 002970 300002 688720 000528 002837 688037 301301 301548 300212 300663 603018 300696 000793 601688 600111 600761 002027 301337 000831 603650 300413 300484 300017 002532 002142 002415 000875 688498 688693 300655 301041 601186 600129 601117 002827 300045 688609 600016 002422 601028 002558 301348 688047 688249 688271 300073 601816 600830 300738 601633 603679 002517 002460 002340 601998 300711 002555 688318 301517 002815 301368 002236 301577 600133 301591 001389 603659 600027 002625 300885 301486 000037 300162 300724 688183 300537 600789 600988 300118 301596 001314 601233 300292 000682 000801 600326 301095 600893 300133 301082 600160 300570 002648 600188 300784 000657 300151 603160 300461 603860 002252 600301 000158 300590 000560 600621 002353 300647 300925 002261 001339 300763 002138 300270 300732 300444 688223 603220 688385 600536 688343 300623 301282 600362 600383 601390 300650 688361 300446 600436 603078 300207 002008 301050 300136 600703 600497 002271 300787 301218 002074 300722 301536 003816 300360 001965 002737 603105 000932 600760 300933 603613 601456 300900 000766 600006 600019 601628 600000 603806 600600 300913 301136 601799 002222 002055 688516 002607 600011 688107 688535 601699 000423 601989 300624 600482 000049 300199 300442 601009 002922 601006 300450 600765 002579 000521 603002 601077 000596 600219 002352 688169 000933 301083 600926 301361 000677 301314 000983 600839 300008 002157 688702 600531 688072 603979 603688 001286 000799 688110 301489 002812 688017 300775 002897 300337 603803 603357 600570 300671 000878 300786 688596 000733 002428 600855 601126 600559 300684 600732 300093 605090 603920 301508 601336 002632 601872 000422 002331 300180 002676 688052 603939 300598 601360 300776 688668 000768 300930 000960 301132 300456 000425 603773 000999 600886 601865 603345 600875 603516 601319 301076 603228 300401 002739 603556 600879 300053 300421 000680 603338 002246 300302 688288 601818 600702 300803 601966 300260 002937 603390 600026 000921 002609 002131 300896 300460 600025 300814 000792 002947 300857 000552 688122 600096 003026 300215 002850 002668 002966 600085 300872 301366 600246 688521 002984 301191 603667 600435 002567 600685 600699 300424 601595 300593 002738 688362 600777 300765 601995 600132 603068 300131 300811 301215 688327 000839 301578 601868 301421 002601 600889 000786 300905 300832 603766 600372 301269 300562 300054 001267 603383 603589 002139 603225 603863 000859 688019 002128 002886 000860 688772 601607 601231 301205 603000 301587 300142 002962 002232 002244 601001 300585 688120 301389 300347 600963 300034 300613 600737 601059 300397 000661 300036 002865 000538 000066 002670 300661 600131 002472 000564 603617 301387 300465 000636 603009 002023 600989 688522 300188 002351 002465 300265 000420 002767 601916 300793 601898 689009 300620 603129 688208 301382 600674 002708 300395 688188 600426 688530 000729 601100 601918 000426 605333 300554 688506 000617 300037 002395 002530 300602 300680 601229 300353 000957 601991 300327 301539 300834 000980 300507 002079 000157 300251 003029 603131 300706 688123 601666 601169 300751 300468 603890 300656 600199 600863 603606 600029 603712 002270 300044 300628 601800 000758 688312 603486 300548 603195 603288 688578 601838 600803 002011 000004 002603 300065 300159 300812 603496 300459 300693 002736 603108 000963 300232 688653 603663 603236 601975 601137 300594 000683 002429 002223 601921 600415 600520 600141 300988 600563 600179 300580 600266 603871 600866 300243 000702 605577 300007 300236 000166 300817 688301 002037 688728 300520 603444 600498 600862 600428 600348 601788 603267 603728 000861 300677 603605 601877 301358 600630 002361 600612 688234 300556 002318 600571 600764 600550 688027 300546 601021 605589 601579 300477 001270 601111 600763 300726 301329 600546 603132 300031 002871 002452 600985 600161 300130 300182 300500 300989 601069 000913 600549 300645 002821 002180 688126 603825 300423 688352 600718 688469 002913 300682 300745 300845 603530 600355 603179 688303 300697 300067 000736 300058 688002 000612 600505 300200 301139 300698 001896 300721 300229 002253 301182 600057 300991 002025 688472 688508 002097 000039 002355 300287 600079 002593 300579 688206 301012 301293 300769 002007 688239 301129 301395 600757 300880 603058 603063 688617 300056 300374 002407 603931 688608 300781 688536 601000 300068 300481 600258 603198 600104 600990 688676 002505 002045 600996 300042 600268 300322 300882 600667 300003 600885 003021 601155 600588 300020 002001 603885 002756 301291 002444 603960 603296 603017 688032 002096 003031 300629 002202 300081 300633 300406 300919 002533 000062 000899 002635 002747 603893 301189 600023 688691 600021 300310 600060 002126 300451 002997 000581 688390 688639 603767 600641 002602 300063 002410 600720 002832 002151 688005 002903 603477 603392 002198 688709 003043 600196 688270 600872 301248 600867 300315 603739"
     codetable = codetable.split(" ")

      // loop to collect data and chkCross, results in here
     upcrossResulttxt = "";
     NewUpcross = ""
     NewDncross = ""
     NewHUpcross = ""
     NewLDncross = ""
     HContUp = ""
     LContDn = ""
     MContUp = ""

     upcrossCnt = 0
     dncrossCnt = 0
     hupcrossCnt = 0
     ldncrossCnt = 0
     MContUpCnt = 0
     MContDnCnt = 0

     thestkdata = [];
     dateLst = [];
     openLst = [];
     highLst = [];
     lowLst = [];
     midLst = [];
     closeLst = [];
     amtLst = [];
     startIntv = 5;
     stkName = "";

      if (localStorage.getItem("daychartWidth") === null) {
        localStorage.setItem("daychartWidth", 75);
        period = 75;
      } else{
        period = localStorage.getItem("daychartWidth");
      }
      dataStatus = "M"
      intv1 = startIntv
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
      halfNum = Math.round(intv1/2)

      stkpriceDataArr = [];
      stkList = 恒指成分.split(' ');
      stkPointer = 0;
      theCode = localStorage.randomcode;
      titleText = "";
      starti = 0;
      chartColor = ['white',
                    'red','#c80','#c60','#c40',
                    '#0f4','#066','#086','#084',
                    'purple','purple']

      attentionList = ""

      var options = '';  // build the List select option
      for (var i = 0; i < allListNames.length; i++) {
         options += '<option value="' + allListNames[i]+ '">' + allListNames[i] + '</option>';
      }
      $("#selectList").html(options);

      if (localStorage.getItem("attentionList") === null) {
        localStorage.attentionList = "07500";
      } else{
        attentionList = localStorage.getItem("attentionList").split(',');
      }

      // load localStorage.savedCodeList
      if (localStorage.getItem("savedCodeList") === null) {
        quickCodeList = ["110000"];
        localStorage.savedCodeList = quickCodeList;
      } else{
        quickCodeList = localStorage.getItem("savedCodeList").split(',');
      }

      // added extra links
      bigVolHeader = "http://www.etnet.com.hk/www/tc/stocks/realtime/quote_transaction.php?code="
      shortsellHeader = "http://www.aastocks.com/tc/stocks/analysis/stock-short-selling-ratio.aspx?symbol="
      newshead = "http://www.aastocks.com/tc/stocks/analysis/stock-aafn/"
      newstail = "/0/all/1"

      // main loop
      for (var i = 0; i < codetable.length; i++) {
         collectStkData(codetable[i])
      }


      function updateStat(statname) {
      // update stat
      prevstat = localStorage.getItem(statname);
      if (prevstat === null) {
        document.getElementById("prevstatistics").innerHTML = ""
      } else{
        document.getElementById("prevstatistics").innerHTML = prevstat
      }

      localStorage.setItem(statname, 
        document.getElementById("statistics").innerHTML)
      }

      function askforCode() {
        var tempCode = prompt("Code Number:", "");
        if (tempCode != null && tempCode != ""){

            codewidth = tempCode.length
            if(codewidth <= 5){
              theCode = "00000"+tempCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }else{
              theCode = tempCode
            }

           storeCode(theCode)
           collectStkData(theCode)
        }
      }

      function collectStkData(theCode) {

        storeCode(theCode);
          if( theCode.substring(0, 2) == "us"){
              // number of day klines shold be small to avoid slow response, even drop out
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/usfqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
              imageCode = theCode
          }else{

            if(theCode == "110000"){
             theCode = "HSI"; imageCode = "110000"
            }

          codewidth = theCode.length
          if(theCode == "HSI"){
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,1000,qfq';
              imageCode = "110000"
          }else{

            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
              theStartCode = theCode
              imageCode = theCode
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,1000,qfq';
            }else{
              codewidth = theCode.length
              if((codewidth == 6) && !hsReservedCode.includes(theCode)){
                 if (theCode.charAt(0) == "6"){
                    imageCode = theCode+".sh"; // note this comes before following line
                    theCode = "sh"+theCode; 
                 }else{
                    imageCode = theCode+".sz";
                    theCode = "sz"+theCode
                 }
                 theStartCode = theCode
                 theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,1000,qfq';
              }else if(codewidth == 9){
                imageCode = theCode
                theCode = theCode.substring(7, 9) + theCode.substring(0, 6);
                theStartCode = theCode

                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,1000,qfq';
              }else{
                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,1000,qfq';
                theStartCode = theCode
                imageCode = theCode
              }
            }
          }
        }

          theStartCode = theCode;
          thedrawdata = [];
          amtLst.length = 0;

          $.get(theurl).done(function(rawJSON) { 
              rawJSON = eval(rawJSON)
              var keys = Object.keys(rawJSON); // read the structure keys ["code", "msg", "data"]

              var insideDatakey = Object.keys(rawJSON)[2] //
              // myobj[Object.keys(myobj)[0]] this is the extract method
      
              var thedata = rawJSON[Object.keys(rawJSON)[2]]
              thestkkey = Object.keys(thedata)[0] // this is the stk key name
              var tempdata = thedata[Object.keys(thedata)[0]];
              thestkdata = tempdata[Object.keys(tempdata)[0]]; // real data here, this is whole dataset

              if(thestkdata.length == 0){alert("no data in: " + thestkkey)}

              for(i=(thestkdata.length-12);i<thestkdata.length;i++){
                    thedate = thestkdata[i][0];  // date
                    if(codewidth <= 5){
                      theAmtIdx = 8;
                    }else{
                      theAmtIdx = 5;
                    }

                    theamt = Math.round(Number(thestkdata[i][theAmtIdx]));
                    if(codewidth > 5){
                      if(theCode.slice(0, 5) == "sh688"){
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/10000);
                      }else{
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/100);
                      }
                    }

                    theamt = theamt.toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",");
                    $("#turnover").prepend( theamt,"w ");
              }
      
              theNameObj = tempdata[Object.keys(tempdata)[1]];
              theNameObjName  = theNameObj[Object.keys(theNameObj)[0]];
              stkName = theNameObjName[1]

              /* data is arranged in days array, tempdata[320] is last set
              tempdata[320][0]  // date, tempdata[320][1]  // open, tempdata[320][3]  // high
              tempdata[320][4]  // low, tempdata[320][2]  // close */
      
              //period + intv1, the chartwidth + max trend interval
              starti = thestkdata.length - (parseInt(period) + parseInt(intv1)) -5; 

              if(starti <= 0){
                  console.log(theStartCode + " " + stkName +" not enough data! dataLength: " + thestkdata.length);
                  return;
              }

              dateLst = [];
              openLst = [];
              highLst = [];
              lowLst = [];
              midLst = [];
              closeLst = [];
              amtLst = [];

              for (let i = starti; i < thestkdata.length; i++) {
                  dateLst.push(thestkdata[i][0]);
                  openLst.push(Number(thestkdata[i][1]));
                  highLst.push(Number(thestkdata[i][3]));
                  lowLst.push(Number(thestkdata[i][4]));
                  midLst.push((Number(thestkdata[i][3]) + Number(thestkdata[i][4]))/2);
                  closeLst.push(Number(thestkdata[i][2]));
                  amtvalue = "&emsp;" + Math.round(Number(thestkdata[i][8])).toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",") +"w ";
                  amtLst.push(amtvalue);
              }
              // redraw();  // this line must be inside the AJAX because AJAX run last
              lastPrice = closeLst[closeLst.length-1]
              chkCross(highLst, midLst, theCode, lastPrice) // must put inside the RGraph.AJAX.getJSON
           });

           //showActivity(theCode)
           window.scrollTo(0,0);
      }

     function chkKey() {
       var testkey = getChar(event);
   console.log(testkey)
       if(testkey == '0'){ theCode = '000001.sh'; collectStkData('000001.sh');}
       else if(testkey == '3'){ theCode = '399001.sz'; collectStkData('399001.sz');}
       else if(testkey == '1'){ theCode = '110000'; collectStkData('HSI');}
       else if(testkey == '2'){ theCode = '02013'; collectStkData('02013');}
       else if(testkey == '4'){ theCode = '01766'; collectStkData('01766');}
       else if(testkey == '5'){ theCode = '02009'; collectStkData('02009');}
       else if(testkey == '6'){ theCode = '01186'; collectStkData('01186');}
       else if(testkey == '7'){ theCode = '00788'; collectStkData('00788');}
       else if(testkey == '8'){ theCode = '00308'; collectStkData('00308');}
       else if(testkey == '9'){ theCode = '00390'; collectStkData('00390');}
       else if(testkey == 'u'){ theCode = 'us.DJI'; collectStkData('us.DJI');}
       else if(testkey == 'n'){ theCode = 'us.IXIC'; collectStkData('us.IXIC');}
       else if(testkey == 'J'){ theCode = 'us.INX'; collectStkData('us.INX');}
       else if(testkey == 'U'){ $('#usstock').toggle(); window.location = '#usstock';}
       else if(testkey == 'c'){askforCode();}
       else if(testkey == '+'){addToquickCodeList();}
       else if(testkey == 'q'){updateStat("ChkXAstkprevStatus");}
       //else if(testkey == 'q'){myfavor();}
       else if(testkey == 'Q'){usequickCodeList();}
       else if(testkey == 'B'){usestkListArr();}

       // if(testkey == '+'){addToAttentionList();}
       else if(testkey == '-'){removeFmquickCodeList();}
       else if(testkey == 'X'){storeCode(theCode); window.open("Random Charts.html");}
       else if(testkey == '.'){storeCode(theCode); window.open("mlineMinutechart.html");}

       else if(testkey == 'a'){useAttentionList();}
       else if(testkey == 'f'){jpforward();}
       else if(testkey == ']'){jpforward();}
       else if(testkey == 'b'){jpback();}
       else if(testkey == '['){jpback();}
       else if(testkey == 'r'){jprandom();}
       else if(testkey == 'w'){window.scrollTo(0,0);}
       //else if(testkey == 'D'){window.location = '#image';}
       else if(testkey == 'd'){xunbao(localStorage.randomcode);}

       else if(testkey == 'l'){window.location = '#endpage';console.log("l: ");}
       else if(testkey == 'i'){chgIntv();}
       else if(testkey == 'W'){chgchartWidth();}
       else if(testkey == 'j'){period = 300; intv1 = 30; collectStkData(theCode);}
       else if(testkey == 'k'){period = 50; intv1 = 2; collectStkData(theCode);}

       else if(testkey == 'C'){chgCloseLst();}
       // else if(testkey == 'L'){askList()}
       else if(testkey == 'L'){askCodetable()}
       else if(testkey == 'z'){largeCht()}
       else if(testkey == 't'){setTabWidth()}
       else if(testkey == 'e'){window.location = '#commands';
            window.scrollTo(window.scrollX, window.scrollY + 2000);}
       else if(testkey == 's'){window.location = '#accel';
            window.scrollTo(window.scrollX, window.scrollY - 500);}
       else if(testkey == 'E'){window.location = '#filterMarkers';}
       else{chkOtherKeys(testkey)} 
     }

     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

     function xunbao(xunbaocode) {
       localStorage.setItem("randomcode", xunbaocode)
       localStorage.setItem("otherCode", xunbaocode)
       localStorage.setItem("stkCode", xunbaocode)

       locs = ["HIghLowTrend.html", "Random Charts.html", ]
         window.open("HIghLowTrend.html")
     }

	function fillLineData() {
      var dataArr = prompt("Enter data array sep by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        redraw()
      }
     }

      function addToquickCodeList() {
        codewidth = theCode.length
        if(codewidth <= 5){
          theCode = "00000"+theCode;
          codewidth = theCode.length;
          theCode = theCode.slice(codewidth-5, codewidth);
        }
        if (!quickCodeList.includes(theCode)) {
          quickCodeList.push(theCode);
          quickCodeList = Array.from(new Set(quickCodeList)); // set unique
          localStorage.savedCodeList = quickCodeList;
          alert(theCode + " added to quickCodeList")
        }else{alert(theCode + " already exist!")}
      }

    function usequickCodeList() {
        stkList = quickCodeList;
        alert("quickCodeList Total: " + quickCodeList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("quickCodeList Total: " + quickCodeList.length + "\n"+stkList);
    }

    function usestkListArr() {
      stkListArr = localStorage.getItem("stkListArr")
      if (stkListArr === null) {
         stkList = quickCodeList;
      } else{
         stkList = stkListArr;
      }
        alert("Use stkListArr, Total: " + stkListArr.length + " : "+stkListArr)
        $("#message").text("stkListArr Total: " + stkListArr.length + "\n"+stkList);
    }

	function addToAttentionList() {
            codewidth = theCode.length
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }

        attentionList.push(theCode)
        attentionList = [...new Set(attentionList)]; // set unique

        ItemIndex = attentionList.indexOf("");  // remove empty items
        if (ItemIndex > -1) { attentionList.splice(ItemIndex, 1); }

        localStorage.setItem("attentionList", attentionList);
        alert(theCode + " added to attentionList!")
     }
	function removeFmquickCodeList() {
        ItemIndex = quickCodeList.indexOf(theCode);
        if (ItemIndex > -1) { quickCodeList.splice(ItemIndex, 1); }
        quickCodeList = [...new Set(quickCodeList)]; // set unique
        localStorage.setItem("quickCodeList", quickCodeList);
        alert(theCode + " removed fm quickCodeList!")
   }

     function redraw() { // includes main chart and aux charts
        initIntvSteps()
        titleText = showDate() +" "+ showTime()+", p1: "+intv1 +" w: "+(thestkdata.length-starti) +"\n"+theStartCode + " " + stkName + " 日線 ";
        $("#amtLst").html("Amt: ".concat(amtLst.slice((amtLst.length-14),amtLst.length).join("")));

 
        RGraph.reset(document.getElementById('cvs'));

        stkpriceDataArrC = closeLst
        stkpriceDataArrL = lowLst
        stkpriceDataArrM = midLst
        stkpriceDataArrH = highLst
        stdDevH = makeStd(highLst, intv3)
        stdDevL = makeStd(lowLst, intv3)

specialBackUp = lowLst.slice();  // backup array to avoid shadow changes
        newDevadd = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a + stdDevH[i]);
        newDevminus = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a - stdDevL[i]);

        mydata = [ stkpriceDataArrM]

          mydata.push(stkpriceDataArrH)
          mydata.push(makeMovAve(stkpriceDataArrH, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrH, intv1))
          mydata.push(makeMovAve(stkpriceDataArrH, intv2))
          //mydata.push(makeMovAve(mydata[1], intv3))
          //mydata.push(makeMovAve(mydata[1], intv4))  // line 6

          mydata.push(stkpriceDataArrL) // line 6, index 5
          mydata.push(makeMovAve(stkpriceDataArrL, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrL, intv1))
          mydata.push(makeMovAve(stkpriceDataArrL, intv2))
          //mydata.push(makeMovAve(mydata[5], intv3))
          // mydata.push(makeMovAve(mydata[5], intv4))

          //mydata.push(makeMovAve(mydata[1], intv8))
          mydata.push(newDevadd)
          mydata.push(newDevminus)  // line 8
        theMax = Math.max(...[].concat(...mydata));
        theMin = Math.min(...[].concat(...mydata));

        thedrawdata = mydata
        //thedrawdata.push(makeMovAve(thedrawdata[2], intv1));  // add one line to check results

        thedrawdata[1] = thedrawdata[1].fill(null,0,0)
        thedrawdata[2] = thedrawdata[2].fill(null,0,halfNum)
        thedrawdata[3] = thedrawdata[3].fill(null,0,intv1)
        thedrawdata[4] = thedrawdata[4].fill(null,0,intv2)

        thedrawdata[5] = thedrawdata[5].fill(null,0,0)
        thedrawdata[6] = thedrawdata[6].fill(null,0,halfNum)
        thedrawdata[7] = thedrawdata[7].fill(null,0,intv1)
        thedrawdata[8] = thedrawdata[8].fill(null,0,intv2)

        thedrawdata[9] = thedrawdata[9].fill(null,0,intv3)
        thedrawdata[10] = thedrawdata[10].fill(null,0,intv3)

        //thedrawdata[11] = thedrawdata[11].fill(null,0,intv3)
        //thedrawdata[12] = thedrawdata[12].fill(null,0,intv1)  // add one line 

lowLst = specialBackUp  // recover data

statusMsg = '<br><span class="red">price '+ mydata[0].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">intvS '+ mydata[1].slice(-1)[0].toFixed(3) +
'</span>, <span class="blue">intvL '+ mydata[2].slice(-1)[0].toFixed(3) +
'</span>, <span class="purple">Top '+ mydata[3].slice(-1)[0].toFixed(3) +
'</span>, <span class="yellow">Bottom '+ mydata[4].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">IntvS '+ intv1 +
'</span>, <span class="blue">IntvL '+ intv2 +
'</span>'

$("#lastValues").text("");
$("#lastValues").append(statusMsg);

       drawchart()

		// create datalog table
		 transp = transpose(mydata);
            wAveTrendRange = [];  // this is the gap diff
		  for (var row=0; row < transp.length; row++) {
		    rowRange = transp[row].slice(1, mydata.length);
      	    rowMax = Math.max(...rowRange);
      	    rowMin = Math.min(...rowRange);
      	    var rowDiff = rowMax - rowMin;
      	    wAveTrendRange.push(rowDiff);
      	  }

		wAveTrendRange.fill(null,0,intv3);
		wAvemax = Math.max(...wAveTrendRange);
		wAvemin = Math.min(...wAveTrendRange);
		drawTrend(wAveTrendRange, wAvemax, wAvemin, 'TP');

		// find derivative
		derivative = diff(makeMovAve(mydata[0], 3));
		derivative.unshift(0);
		derivative.fill(null,0,intv1+3); //array.fill(value, start, end)

		// diffaccel
		// diffaccel = thedrawdata[baseSubIdx].map(function(item, index) { return item - thedrawdata[baseMinuIdx][index]; })
		diffaccel = []
		diffaccel.push(thedrawdata[1].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[2].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[3].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[4].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[5].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[6].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[5].fill(null,0,intv3); //array.fill(value, start, end)

		diffaccMax = Math.max(...[].concat.apply([], diffaccel));
		diffaccMin = Math.min(...[].concat.apply([], diffaccel));
		drawTrend(diffaccel, diffaccMax, diffaccMin, 'accel');

		// ddiffaccel
		ddiffaccel = []
		ddiffaccel.push(diffaccel[0].map(function(item, index) { return item - diffaccel[1][index]; }))
		ddiffaccel.push(diffaccel[1].map(function(item, index) { return item - diffaccel[2][index]; }))
		ddiffaccel.push(diffaccel[2].map(function(item, index) { return item - diffaccel[3][index]; }))
		//ddiffaccel.push(diffaccel[3].map(function(item, index) { return item - diffaccel[4][index]; }))
		//ddiffaccel.push(diffaccel[4].map(function(item, index) { return item - diffaccel[5][index]; }))
		//ddiffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)

		ddiffaccMax = Math.max(...[].concat.apply([], ddiffaccel));
		ddiffaccMin = Math.min(...[].concat.apply([], ddiffaccel));
		drawTrend(ddiffaccel, ddiffaccMax, ddiffaccMin, 'accaccel');

		// find stoch
		stoch1 = makeStoch(mydata[0], 50)
		stochmax1 = Math.max(...stoch1);
		stochmin1 = Math.min(...stoch1);
		drawTrend(stoch1, stochmax1, stochmin1, '强弱50');

        // evaluate B/S
        lastdayPtr = mydata[0].length-1
        statBegin = lastdayPtr - 29
        actionStr = ""
        for (var i = statBegin; i < (lastdayPtr+1); i++) {
          // define references
          Mvalue = mydata[0][i]
          Hvalue = mydata[1][i]
          Lvalue = mydata[5][i]
          hRefvalue = mydata[2][i]
          lRefvalue = mydata[6][i]
          h2Refvalue = mydata[3][i]
          l2Refvalue = mydata[7][i]
          acRefvalue = diffaccel[1][i]
          // compare indicators
          Hdiff = (Hvalue - hRefvalue).toFixed(2)
          Ldiff = (Lvalue - lRefvalue).toFixed(2)
          H2diff = (Hvalue - h2Refvalue).toFixed(2)
          L2diff = (Lvalue - l2Refvalue).toFixed(2)
          Mhdiff = (Mvalue - h2Refvalue).toFixed(2)
          Mldiff = (Mvalue - l2Refvalue).toFixed(2)
          acdiff = (diffaccel[0][i] - diffaccel[0][i-1]).toFixed(2)
          ac1diff = (diffaccel[0][i] - diffaccel[1][i]).toFixed(2)

          Mdiff = (mydata[0][i] - mydata[0][i-1]).toFixed(2)

          if(Hdiff >0){Hdiff = "<span class='red'>" +Hdiff + "</span>"}
          if(Ldiff >0){Ldiff = "<span class='red'>" +Ldiff + "</span>"}
          if(H2diff >0){H2diff = "<span class='red'>" +H2diff + "</span>"}
          if(L2diff >0){L2diff = "<span class='red'>" +L2diff + "</span>"}

          if(Mhdiff >0){Mhdiff = "<r>" +Mhdiff + "</r>"}
          else{Mhdiff = "<gr>" +Mhdiff + "</gr>"}
          if(Mldiff >0){Mldiff = "<r>" +Mldiff + "</r>"}
          else{Mldiff = "<gr>" +Mldiff + "</gr>"}

          if(Mdiff >0){Mdiff = "<r>" +Mdiff + "</r>"}
          else{Mdiff = "<gr>" +Mdiff + "</gr>"}

          if(acdiff >0){acdiff = "<r>" +acdiff + "</r>"}
          else{acdiff = "<gr>" +acdiff + "</gr>"}
          if(ac1diff >0){ac1diff = "<r>" +ac1diff + "</r>"}
          else{ac1diff = "<gr>" +ac1diff + "</gr>"}

          closeValue = lowLst[i]
          dateValue = dateLst[i].slice(5)

          // decision conditions
          actionStr = actionStr + dateValue + " C: " + closeValue +"\tHd: " + Hdiff + "\tLd: " + Ldiff + "\tH2d: " + H2diff + "\tL2d: " + L2diff + "\tMd: " + Mdiff + "\tacd: " + acdiff + "\tac1d: " + ac1diff + "<br>" 

          if(Hdiff>0){action = "buy"}
        }
        explanationStr = "<gr>h2d: h2 diff, l2d: L2 diff, md: M diff, acd: acc0 diff, ac1d: acc0 diff</gr>"
        actionStr = "<pre>" + actionStr + explanationStr+"</pre>"
        $("#actions").html(actionStr);

        drawOHLC()
        drawlinechart()
       }

	function makeMovAve(bigArray, intv) {
	     // the intv-1 is correct
		return bigArray.slice(0, intv-1).concat(calcMovAve(bigArray, intv));
	}
	function calcAve(aveArray) {
		add = (a, b) =>  a + b;
		return aveArray.reduce(add) / aveArray.length;
	}
	
	function calcMovAve(bigArray, intv) {
		var ma = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {ma[i] = calcWAve(bigArray.slice(i, i+intv));} // points to indicator
		return ma;
	}
	function calcWAve(aveArray) {
		var sum = 0
		for( var i = 1; i <= aveArray.length; i++ ) {
			sum += aveArray[i-1] * i;
		}
		return (sum / ((1 + aveArray.length)*aveArray.length/2))
	}

	function makeStoch(bigArray, intv) {
	     tempArr = bigArray.slice(0, intv-1).concat(calcStoch(bigArray, intv));
		return tempArr.fill(50,0,intv-1)
	}

	function calcStoch(bigArray, intv) {
		var stc = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {
			stc[i] = calc1Stoch(bigArray.slice(i, i+intv));
		}
		return stc;
	}

	function calc1Stoch(stcArray) {
			stcMax = Math.max(...stcArray)
			stcMin = Math.min(...stcArray)
			lastVal = stcArray[stcArray.length - 1]
			stcRange = stcMax - stcMin
			if(stcRange == 0){
				stcVal = 50
			}else{
				stcVal = 100*(lastVal - stcMin) / stcRange
			}
			return stcVal
	}

	function makeStd(bigArray, intv) {
	     // the intv-1 is correct
          newArray = new Array(intv-1).fill(0)
		newArray = newArray.concat(calcStd(bigArray, intv));
		return newArray
	}

	function calcStd(bigArray, intv) {
		var stdArrar = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {stdArrar[i] = Std(bigArray.slice(i, i+intv));} // points to indicator
		return stdArrar;
	}

	function Std(array) {
	  const n = array.length
	  const mean = array.reduce((a, b) => a + b) / n
	  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
	}

	function transpose(thisArr) { // Swap rows with columns of a matrix
	    return Object.keys(thisArr[0]).map(function(column) {
	        return thisArr.map(function(row) { return row[column]; });
	    });
	}

    function useAttentionList() {
        stkList = attentionList;
        alert("AttentionList Total: " + attentionList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + attentionList.length + "\n"+stkList);
    }

    function myfavor() {
        myfavorLst = mychips.split(" ");
        stkList = myfavorLst;
        alert("mychips Total: " + myfavorLst.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("mychips Total: " + myfavorLst.length + "\n"+stkList);
    }

    function askList() {
        var theList = prompt("CodeList, Number (5 digits) sep by space： ", "");
        if (theList != null && theList != "HSI" && theList != "") {
            stkList = theList.split(" ");
            alert("Supplied List Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
            $("#message").text("Supplied List Total: " + stkList.length + "\n"+stkList);
        }
        codetable = stkList
        document.getElementById("upcrossResult").innerHTML = "";

        for (var i = 0; i < codetable.length; i++) {
           collectStkData(codetable[i])
        }
    }

    function FormatNumberLength5(num) {
        var r = "" + num;
        while (r.length < 5) { r = "0" + r; }
        return r;
    }

    function jpforward() {
        if (stkPointer < stkList.length-1) {
            stkPointer = stkPointer + 1;
        } else {
            stkPointer = 0;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }

    function jpback() {
        if (stkPointer > 0) {
            stkPointer = stkPointer - 1;
        } else {
            stkPointer = stkList.length-1;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }
    function jprandom() {
        stkPointer = Math.floor(Math.random() * (stkList.length-1))
        theCode = stkList[stkPointer]
         collectStkData(theCode)
    }

    function jpTo0() {
        stkPointer = 0;
        theCode = stkList[stkPointer]
        collectStkData(theCode)
    }

    function storeCode(theCode) {
        if(typeof(Storage) !== "undefined") {
            localStorage.randomcode = theCode;
        }
    }

    function chgchartWidth() {
        newChartWidth = prompt("enter chart width:", "");
        if (newChartWidth != null && newChartWidth != "" && newChartWidth < (1000 - 2*intv1)){
          period = parseInt(newChartWidth);
          localStorage.setItem("daychartWidth", period);
          collectStkData(theCode);
        }

    }
    function chgIntv() {
        intv = prompt("intv1 value:", "");
        if (theCode != null && intv1 != ""){
          intv1 = parseInt(intv);
          initIntvSteps()
          redraw()
        }
    }
    function initIntvSteps() {
      halfNum = Math.round(intv1/2)
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
    }
    function setTabWidth() {
        tabWidth = prompt("set tab width:", "");
        if (tabWidth != null && tabWidth != ""){
          tabWidth = parseInt(tabWidth);
          document.getElementById("actions").style.tabSize = tabWidth;
        }
    }

    function chgHighList() {
        dataStatus = "H"
        redraw()
    }
    function chgLowList() {
        dataStatus = "L"
        redraw()
    }
    function chgMidList() {
        dataStatus = "M"
        redraw()
    }
    function chgCloseLst() {
        dataStatus = "C"
        redraw()
    }

    function largeCht() {
        imgHead = "http://charts.aastocks.com/servlet/Charts?fontsize=12&15MinDelay=F&lang=1&titlestyle=1&vol=1&Indicator=3&indpara1=3&indpara2=5&indpara3=10&indpara4=15&indpara5=20&subChart2=3&ref2para1=12&ref2para2=26&ref2para3=9&subChart3=12&ref3para1=0&ref3para2=0&ref3para3=0&scheme=3&com=100&chartwidth=1600&chartheight=900&stockid=";

        imgTail = "&period=2060&type=1&logoStyle=1"
        imgURL = imgHead + theCode + imgTail
        window.open(imgURL, "_blank")
    }

function assignList(){
  newList = eval(document.getElementById("selectList").value).split(" ");
  stkList = newList;
  codeList = newList;

  document.getElementById("message").focus();
  alert(" Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!\n" + newList)
        $("#message").text("Total: " + stkList.length + "\n"+stkList);
  $('#selectList').blur()

}

function showDateTime() {
    cmtCode = theCode // use another name not to interfere other parts
    var cmtcodewidth = cmtCode.length
    if(cmtcodewidth <= 5){
      cmtCode = "00000"+cmtCode;
      cmtcodewidth = cmtCode.length;
      cmtCode = cmtCode.slice(cmtcodewidth-5, cmtcodewidth);
    }
    else if(cmtcodewidth == 8){ cmtCode = cmtCode.slice(2, 8); }
    else if(cmtcodewidth == 9){ cmtCode = cmtCode.slice(0, 6); }
    commentName = "j" + cmtCode;

    CommentListNames = Object.keys(theCommentList); // extract the names from comments
    // to show comments
    if(CommentListNames.includes(commentName)){
      cmtLocation = CommentListNames.indexOf(commentName);
      commentTxt = theCommentList[Object.keys(theCommentList)[cmtLocation]]
    }else{commentTxt = "No data!";}

    document.getElementById("dateTime").innerHTML ="<span class='orange'>" + commentTxt + "</span>";
}

    function drawchart() {
      listItems = []
      if(dataStatus == "C"){ tooltips = closeLst
      }else if(dataStatus == "L"){ tooltips = lowLst
      }else if(dataStatus == "M"){ tooltips = midLst
      }else { tooltips = highLst}

      dataTooltips = tooltips.map(item => Math.round(item * 1000) / 1000)
      for (index = 0; index < dataTooltips.length; index++) {
        listItems[index] = dateLst[index] + "<br><span class='red'>" + dataStatus + "</span>: " + dataTooltips[index];
      }

      dataTooltips = dataTooltips.map(String)

      var line = new RGraph.Line({
        id:'cvs',
        data: thedrawdata,
        options: {
			title: titleText + " " + "MHL + trends",
			titleColor: 'grey',
			titleSize: 20,
               colors: chartColor,
            backgroundGrid: true, backgroundGridVlines: true,
            backgroundGridColor: '#001000', backgroundGridBorder: false,
            // backgroundGridDotted: true,
            backgroundGridDashed: true, 
            axisColor: '#864',  scaleDecimals: 2,
            xaxis: true,
            //xaxisLabels: ["a","b","c","d"],
            textColor: '#ccc',
            tickmarks: 'plus',
            ticksize: 1,
            linewidth:1,
			ymax: theMax,
			ymin: theMin,
      // labels control the number of grids
            // labels: ['2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018'],
            spline: false,
            shadow: false,
            tooltips: listItems,
            gutterLeft: 0, gutterRight: 50,
            gutterTop: 25, gutterBottom: 25
            }
          }).trace();

		yminpct = 100 - (theMax-theMin)*100/theMax,
		ymaxpct = 100,

          yaxis1 = new RGraph.Drawing.YAxis('cvs', 1200)
                .Set('colors', ['gold'])
                .Set('text.color', 'gray')
                .Set('text.size', 8)
                .Set('max', ymaxpct)
                .Set('min', yminpct)
                .Set('linewidth', 2)
                .Set('tickmarkslength', 5)
                .Set('title', '% pct')
                .Draw();

    };

    function drawTrend(therange,maxValue, minValue, chartID) {
       // dataTooltips = therange.map(item => Math.round(item * 1000) / 1000)
       // dataTooltips = dataTooltips.map(String)
       RGraph.reset(document.getElementById(chartID));
       line = new RGraph.Line({
       	id:chartID, data:therange,
       	options: {
       		title: chartID + ", "+theStartCode + " " + stkName,
    			titleColor: 'grey', 
    			titleSize: 10,
       		backgroundGrid: true, axisColor: '#864', textColor: '#ccc',
    		numxticks: 0, colors: chartColor, scaleDecimals: 2,

       		tickmarksDotLinewidth: 0,ticksize: 1, linewidth: 1, 
       		ymax: maxValue, ymin: minValue,
               tickmarks: 'plus',

       		spline: false, shadow: false,
              // tooltips: dataTooltips,
			backgroundGridVlines: true,
			backgroundGridDashed: true, 
       		backgroundGridColor: '#001000',
       		gutterLeft: 0, gutterRight: 50, gutterTop: 25, gutterBottom: 25
       	}
       }).trace();
    };
    
    function diff(arr) {
      return arr.slice(1).map(function(n, i) { return n - arr[i]; });
    }

function showActivity(thecode){
    markers = filterResult.filter(element => element.includes(thecode));
    // clean the h2 tags
    markers = markers.map(element => element.replace(/<\/h2>.*/gi, ""))
    markers = markers.map(element => element.replace(/<h2>/gi, ""))

    markers = markers.map(element => formatWeekDay(element))
    if (markers.length > 50) markers.splice(0, markers.length-80);

    $('#filterMarkers').append("<b class='red'>" + thecode + " 日线特征:</b><br>")
    $('#filterMarkers').append(markers)
}

// format WeekDay
function formatWeekDay(element) {
    dayStr = element.replace(/<.*?>/gi, "") // clean span tags
    dayStr = dayStr.substr(0,6)
    dayStr = convertWeekday(dayStr)
    return(dayStr + " " + element + "<br>")
}

// convert date string to weekday
function parse(str) {
    str = "20" + str
    var y = str.substr(0,4), m = str.substr(4,2) - 1,
        d = str.substr(6,2);
    var D = new Date(y,m,d);
    return (D.getFullYear() == y && D.getMonth() == m && D.getDate() == d) ? D : 'invalid date';
}
function convertWeekday(str) {
    return ["SUN","MON","TUE","WED","THU","FRI","SAT"][parse(str).getDay()]
}
function fetchUsCode(str) {
    theCode = str; collectStkData(str); window.location = '#cvs';
    $('#usstock').toggle();
}

function handleRight( event ){
    codeListPtr = codeListPtr +1
    theCode = codeList[codeListPtr];
    collectStkData(theCode);
}

    codeList = codeList.split(' ')
    codeListPtr = 0

    // $( "html" ).on( "swiperight", handleRight );
    // $( "html" ).on( "swipeleft", askforCode );
    window.addEventListener('click', function (evt) {
        if (evt.detail === 3) { askforCode(); }
    });

    collectStkData(theCode);

function docLoaded() {
    let script1 = document.createElement('script');
    script1.src = 'https://williamkpchan.github.io/LibDocs/readbook.js';
    document.body.appendChild(script1);
    let script = document.createElement('script');
    script.src = 'C:/R programs/!!! STKMon !!!/headerApp.js';
    document.body.appendChild(script);
    window.scrollTo(0,(document.body.scrollHeight));

}

    function drawOHLC() { // includes main chart and aux charts
      var ohlcdata = {
        close:  closeLst,
        low:  lowLst,
        open:  openLst,
        high:  highLst,
        x:  dateLst,
        line: {color: 'rgba(31,119,180,1)'}, 
        increasing: {line: {color: 'red'}},
        decreasing: {line: {color: 'green'}},
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
      };

      var data = [ohlcdata];
      var layout = {
      title: titleText,
        dragmode: 'zoom', 
        showlegend: false,
        xaxis: { rangeslider: { visible: false } }, 
        yaxis: { autorange: true,  type: 'linear' }
      };
      Plotly.newPlot('ohlcDiv', data, layout);
    }


    function chkCross(highLst, midLst, theCode, lastPrice) { // includes main chart and aux charts

      // mid data
      traceLine0 = midLst
      traceLine1 = makeMovAve(midLst, intv1)
      traceLine2 = makeMovAve(midLst, intv2)
      indexlast = traceLine0.length-1
      curS = traceLine0[indexlast]
      curL1 = traceLine1[indexlast]
      curL2 = traceLine2[indexlast]
      prevS = traceLine0[indexlast-1]
      prevL1 = traceLine1[indexlast-1]
      prevL2 = traceLine2[indexlast-1]
      pprevS = traceLine0[indexlast-2]
      pprevL1 = traceLine1[indexlast-2]
      pprevL2 = traceLine2[indexlast-2]


      // H data
      traceLine3 = highLst
      traceLine4 = makeMovAve(highLst, intv1)
      traceLine5 = makeMovAve(highLst, intv2)

      curHS = traceLine3[indexlast]
      curHL1 = traceLine4[indexlast]
      curHL2 = traceLine5[indexlast]
      prevHS = traceLine3[indexlast-1]
      prevHL1 = traceLine4[indexlast-1]
      prevHL2 = traceLine5[indexlast-1]
      pprevHS = traceLine3[indexlast-2]
      pprevHL1 = traceLine4[indexlast-2]
      pprevHL2 = traceLine5[indexlast-2]

      // L data
      traceLine6 = lowLst
      traceLine7 = makeMovAve(lowLst, intv1)
      traceLine8 = makeMovAve(lowLst, intv2)

      curLS = traceLine6[indexlast]
      curLL1 = traceLine7[indexlast]
      curLL2 = traceLine8[indexlast]
      prevLS = traceLine6[indexlast-1]
      prevLL1 = traceLine7[indexlast-1]
      prevLL2 = traceLine8[indexlast-1]
      pprevLS = traceLine6[indexlast-2]
      pprevLL1 = traceLine7[indexlast-2]
      pprevLL2 = traceLine8[indexlast-2]


      // checkX(prevL, prevS, curL, curS) check mid
      prevfirstChk = checkX(pprevL1, pprevS, prevL1, prevS)
      firstChk = checkX(prevL1, prevS, curL1, curS)
      secChk = checkX(prevL2, prevS, curL2, curS)


        prevfirstWarn = "prev 1st sig: " + prevfirstChk
        firstWarn = " 1st sig: " + firstChk
        secondWarn = " 2nd sig: " + secChk
      // checkH
      // checkX(prevL, prevS, curL, curS) 
      prevfirstHChk = checkX(pprevHL1, pprevHS, prevHL1, prevHS)
      firstHChk = checkX(prevHL1, prevHS, curHL1, curHS)
      secHChk = checkX(prevHL2, prevHS, curHL2, curHS)

        prevHfirstWarn = "prevH 1st sig: " + prevfirstHChk
        firstHWarn = " 1st sig: " + firstHChk
        secondHWarn = " 2nd sig: " + secHChk

      // checkX(prevLL, prevLS, curLL, curLS) checkL
      prevfirstLChk = checkX(pprevLL1, pprevLS, prevLL1, prevLS)
      firstLChk = checkX(prevLL1, prevLS, curLL1, curLS)
      secLChk = checkX(prevLL2, prevLS, curLL2, curLS)


      // show status
      upcrossResulttxt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " " + stkName+ '</k>' + ": " 
         + prevfirstWarn + firstWarn + secondWarn + " latest Price: " + lastPrice + "<br>"
         + "               " + prevHfirstWarn + firstHWarn + secondHWarn  + "<br><br>";

      oldmsg = document.getElementById("upcrossResult").innerHTML
      document.getElementById("upcrossResult").innerHTML = oldmsg + upcrossResulttxt;


      // show UpX 
      UpX = firstChk.match(/UpCross/gi);
      if( UpX != null){
        upcrosstxt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " <r>" + stkName+ '</r></k>&emsp;'
        upcrossCnt = upcrossCnt +1
      }else{
        upcrosstxt = ""
      }

      oldUpcrossmsg = document.getElementById("NewUpcross").innerHTML
      document.getElementById("NewUpcross").innerHTML = oldUpcrossmsg + upcrosstxt;


      // show DnX 
      DnX = firstChk.match(/DownCross/gi);
      if( DnX != null){
        dncrosstxt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " <gr>" + stkName+ '</gr></k>&emsp;'
        dncrossCnt = dncrossCnt +1
      }else{
        dncrosstxt = ""
      }

      oldDncrossmsg = document.getElementById("NewDncross").innerHTML
      document.getElementById("NewDncross").innerHTML = oldDncrossmsg + dncrosstxt;

      // show Cont.Up, MContUpCnt
      M_Cont_Up = firstChk.match(/cont.Up/gi);
      if( M_Cont_Up != null){
        M_Cont_Up_txt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " <dr>" + stkName+ '</dr></k>&emsp;'
        MContUpCnt = MContUpCnt +1
      }else{
        M_Cont_Up_txt = ""
      }

      oldM_Cont_Upmsg = document.getElementById("Cont.Up").innerHTML
      document.getElementById("Cont.Up").innerHTML = oldM_Cont_Upmsg + M_Cont_Up_txt;


      // show cont.Dn, MContDnCnt
      M_Cont_Dn = firstChk.match(/cont.Dn/gi);
      if( M_Cont_Dn != null){
        M_Cont_Dn_txt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " <gr>" + stkName+ '</gr></k>&emsp;'
        MContDnCnt = MContDnCnt +1
      }else{
        M_Cont_Dn_txt = ""
      }

      oldM_Cont_Dnmsg = document.getElementById("Cont.Dn").innerHTML
      document.getElementById("Cont.Dn").innerHTML = oldM_Cont_Dnmsg + M_Cont_Dn_txt;


      // show hUpX 
      hUpX = firstHChk.match(/UpCross/gi);
      if( hUpX != null){
        hupcrosstxt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " <r>" + stkName+ '</r></k>&emsp;'
        hupcrossCnt = hupcrossCnt +1
      }else{
        hupcrosstxt = ""
      }

      oldhUpcrossmsg = document.getElementById("NewHUpcross").innerHTML
      document.getElementById("NewHUpcross").innerHTML = oldhUpcrossmsg + hupcrosstxt;


      // show LdnX 
      LdnX = firstLChk.match(/DownCross/gi);
      if( LdnX != null){
        Ldncrosstxt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " <gr>" + stkName+ '</gr></k>&emsp;'
        ldncrossCnt = ldncrossCnt +1
      }else{
        Ldncrosstxt = ""
      }

      oldLdncrossmsg = document.getElementById("NewLDncross").innerHTML
      document.getElementById("NewLDncross").innerHTML = oldLdncrossmsg + Ldncrosstxt;


      // show stat

      document.getElementById("statistics").innerHTML =
        document.getElementById("dateAndTime").innerHTML +"<br>"+
        "MUpCross Count: <r>"+ upcrossCnt +
        "</r> MDnCross Count: <gr>"+ dncrossCnt + "</gr> " + 
        "HUpCross Count: <r>"+ hupcrossCnt +
        "</r> LDnCross Count: <gr>"+ ldncrossCnt + "</gr> " + 
        "<br>Cont.Up Count: <r>"+ MContUpCnt +
        "</r> Cont.Dn Count: <gr>"+ MContDnCnt +  "</gr> " + 
        "<br>Sample Total: " + codetable.length;

    }

    function checkX(prevL, prevS, curL, curS) {
		if (curS == curL){return "critical" }
		if (((prevL == prevS) && (curS > curL )) || ((prevL>prevS) && (curS > curL ))){return "<span class='redrose'>UpCross</span>" }
		if (((prevL == prevS) && (curS < curL )) || ((prevL<prevS) && (curS < curL ))){return "<gr>DownCross</gr>" }
		if ((prevL<prevS) && (curS > curL )){return '<span class="brownword">cont.Up</span>' } // c must > prevC, this is not correct, further check for condition
		if ((prevL>prevS) && (curS < curL )){return '<span class="limeword">cont.Dn</span>' }
	}


</script>

<script>
     function askCodetable() {
       var theCodetable = prompt("Enter stk list seperated by space:", "");
       if (theCodetable != null && theCodetable != "") {
         theCodetable = JSON.stringify(theCodetable.split(" "))
         localStorage.setItem("codetableList", theCodetable);
         codetable = JSON.parse(theCodetable);
         location.reload();
       }
     }
</script>

</body>
</html>
