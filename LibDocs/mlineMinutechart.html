<!DOCTYPE html>
<html>
<meta http-equiv="refresh" content="90">
<head>
<title>Minute Standard Deviation Chart</title>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="./rchart/RGraph.common.core.js" ></script>
<script src="./rchart/RGraph.line.js"></script>
<!--script src="./rchart/RGraph.svg.bar.js" ></script-->


<style>
</style>

</head>
<body onkeypress="chkKey()">
<center>
<canvas id="cvs" width="1300" height="600">[No canvas support]</canvas>
</center><pre>
commands:
 l loadLineData, paste data array to redraw chart with std dev
 c askforCode
 C open Random Charts.html
 f jpforward
 b jpback
 r jprandom
 L askList
 i chgIntv
 w askWidth
5 lines: data, WAve5, WAve10, sd+, sd-

</pre>
<script>

      let thestkdata = [];
      period = 60;
      let dateLst = [];
      let openLst = [];
      let highLst = [];
      let lowLst = [];
      let closeLst = [];
      let amtLst = [];
      intv5 = 60
      stkpriceDataArr = [];
      stkList = localStorage.getItem("stkListArr").split(' ');
      stkPointer = 0;

      if (localStorage.getItem("randomcode") != null) {
        theCode = localStorage.randomcode;
      }else{theCode = "HSI"}
      
      titleText = "";
      datawidth = 500;

      function askforCode() {
        theCode = prompt("Code Number:", "");
        if (theCode != null && theCode != ""){
          collectStkData(theCode)
          storeCode(theCode)
        }
      }

      function askWidth() {
          var theWidth = prompt("Chart Width:", "");
          if (theWidth != null && theWidth != "") {
              datawidth = parseInt(theWidth);
              collectStkData(theCode);
          }
      }

      function collectStkData(theCode) {
          codewidth = theCode.length
          if(theCode == "HSI"){
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?code=hk' + theCode

          }else{
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?code=hk' + theCode
            }else{
              //codewidth = theCode.length
              //theCode = theCode.slice(codewidth-9, codewidth)
              //theCode = theCode.slice(7, 9) + theCode.slice(0, 6);
              codewidth = theCode.length; //update to be used later
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?_var=fdays_data_' + theCode + '&code=' + theCode
            }
          }
      
 	theStartCode = theCode;
	thestkdata = [];
	thedrawdata = [];
	closeLst = [];
	//var theurl = theurlHead + theStartCode
	RGraph.AJAX.getJSON(theurl, function (rawJSON){
		keys = Object.keys(rawJSON); // read the structure keys ["code", "msg", "data"]
		var insideDatakey = Object.keys(rawJSON)[2] //
		// myobj[Object.keys(myobj)[0]] this is the extract method

		var thedata = rawJSON[Object.keys(rawJSON)[2]]
		thestkkey = Object.keys(thedata)[0] // this is the stk key name
		var tempdata = thedata[Object.keys(thedata)[0]]; // {data: Array(5), qt: {…}, vcm: ""} five sets of data here
		// old data at the back, new data at 0 location
		allData = tempdata.data[4].data.concat(tempdata.data[3].data).concat(tempdata.data[2].data).concat(tempdata.data[1].data).concat(tempdata.data[0].data)
		//(1599) ["0930 26834.15 375023", "0931 26858.43 469321"
		allData = allData.filter((val) => val != "");

          if(datawidth > allData.length){datawidth = allData.length};
        console.log("datawidth "+datawidth)
		allData = allData.slice(allData.length-datawidth); // get only req data

		allData.forEach(str => { closeLst.push(Number(str.split(' ')[1])); }); // split the string and select only the middle close 

		theNameObj = tempdata[Object.keys(tempdata)[1]];
		theNameObjName  = theNameObj[Object.keys(theNameObj)[0]];
		stkName = theNameObjName[1]

		thedrawdata =[closeLst]; //closeLst is already originally an array
              stkpriceDataArr = closeLst
              titleText = theStartCode + " " + stkName + " "+ showTime();
              redraw();  // this line must be inside the AJAX because AJAX run last

           });
      }

     function chkKey() {
       var testkey = getChar(event);
       if(testkey == 'l'){loadLineData();}
       if(testkey == 'c'){askforCode();}
       if(testkey == 'C'){storeCode(theCode); window.open("Random Charts.html");}
       if(testkey == 'f'){jpforward();}
       if(testkey == 'b'){jpback();}
       if(testkey == 'r'){jprandom();}
       if(testkey == 'i'){chgIntv();}
       if(testkey == 'L'){askList()}
       if(testkey == 'w'){askWidth()}
       if(testkey == '0'){storeCode('sh000001');collectStkData('sh000001');}
       if(testkey == '3'){storeCode('sz399001');collectStkData('sz399001');}
       if(testkey == '1'){storeCode('HSI');collectStkData('HSI');}
       if(testkey == '2'){storeCode('01339');collectStkData('01339');}
       if(testkey == '4'){storeCode('01766');collectStkData('01766');}
       if(testkey == '5'){storeCode('03800');collectStkData('03800');}
       if(testkey == '6'){storeCode('01508');collectStkData('01508');}
       if(testkey == '7'){storeCode('00788');collectStkData('00788');}
       if(testkey == '8'){storeCode('00308');collectStkData('00308');}
       if(testkey == '9'){storeCode('00390');collectStkData('00390');}

     }
     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

	function loadLineData() {
      var dataArr = prompt("Enter stk list seperated by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        redraw()
      }
     }
     function redraw() {
        intv10 = 2*intv5

        RGraph.reset(document.getElementById('cvs'));

        stdDev = makeStd(stkpriceDataArr, intv10)
        newDevadd = makeMovAve(stkpriceDataArr, intv10).map((a, i) => a + stdDev[i]);
        newDevminus = makeMovAve(stkpriceDataArr, intv10).map((a, i) => a - stdDev[i]);

        mydata= [
          stkpriceDataArr, 
          makeMovAve(stkpriceDataArr, intv5),
          makeMovAve(stkpriceDataArr, intv10),
          newDevadd, newDevminus,
        ];
        theMax = Math.max(...[].concat(...mydata));
        theMin = Math.min(...[].concat(...mydata));

       drawchart()
     }

	function makeMovAve(bigArray, intv) {
	     // the intv-1 is correct
		return bigArray.slice(0, intv-1).concat(calcMovAve(bigArray, intv));
	}
	function calcAve(aveArray) {
		add = (a, b) =>  a + b;
		return aveArray.reduce(add) / aveArray.length;
	}
	
	function calcMovAve(bigArray, intv) {
		var ma = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {ma[i] = calcWAve(bigArray.slice(i, i+intv));} // points to indicator
		return ma;
	}
	function calcWAve(aveArray) {
		var sum = 0
		for( var i = 1; i <= aveArray.length; i++ ) {
			sum += aveArray[i-1] * i;
		}
		return (sum / ((1 + aveArray.length)*aveArray.length/2))
	}

	function makeStd(bigArray, intv) {
	     // the intv-1 is correct
          newArray = new Array(intv-1).fill(0)
		newArray = newArray.concat(calcStd(bigArray, intv));
		return newArray
	}

	function calcStd(bigArray, intv) {
		var stdArrar = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {stdArrar[i] = Std(bigArray.slice(i, i+intv));} // points to indicator
		return stdArrar;
	}

	function Std(array) {
	  const n = array.length
	  const mean = array.reduce((a, b) => a + b) / n
	  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
	}


    function askList() {
        var theList = prompt("CodeList, Number (5 digits) sep by space： ", "");
        if (theList != null && theList != "HSI" && theList != "") {
            stkList = theList.split(" ");
        }
    }

    function FormatNumberLength5(num) {
        var r = "" + num;
        while (r.length < 5) { r = "0" + r; }
        return r;
    }

    function jpforward() {
        if (stkPointer < stkList.length-1) {
            stkPointer = stkPointer + 1;
        } else {
            stkPointer = 0;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }

    function jpback() {
        if (stkPointer > 0) {
            stkPointer = stkPointer - 1;
        } else {
            stkPointer = stkList.length-1;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }
    function jprandom() {
        stkPointer = Math.floor(Math.random() * (stkList.length-1))
        theCode = stkList[stkPointer]
         collectStkData(theCode)
    }
    function storeCode(aCode) {
        if(typeof(Storage) !== "undefined") {
            localStorage.randomcode = aCode;
        }
    }

    function chgIntv() {
        intv = prompt("intv5 value:", "");
        if (theCode != null && intv5 != ""){intv5 = parseInt(intv); redraw(theCode)}

    }

    function showTime() {
	let d = new Date();
	let secs=d.getSeconds();
	let mins=d.getMinutes();
	let hr=d.getHours();
	let timemsg=FormatNumberLength(hr) +":" + FormatNumberLength(mins) + ":"+ FormatNumberLength(secs)
	return(timemsg)
    }

    function FormatNumberLength(num) {
		let r = "" + num;
		while (r.length < 2) { r = "0" + r;}
		return r;
    }

    function drawchart() {
      console.log(intv5)
      var line = new RGraph.Line({
        id:'cvs',
        data:mydata,
        options: {
			title: titleText,
			titleColor: 'grey',
			titleSize: 20,
            // colors: ['darkgreen','blue','grey'],
            axisColor: '#864',  scaleDecimals: 2,
            textColor: '#ccc',
            //tickmarks: 'plus',
            ticksize: 1,
            linewidth:1,
			ymax: theMax,
			ymin: theMin,
      // labels control the number of grids
            // labels: ['2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018'],
            spline: false,
            backgroundGrid: true, backgroundGridVlines: false,
            backgroundGridColor: '#002010',
            shadow: false,
            gutterLeft: 50,
            gutterRight: 50,
            gutterTop: 50,
            gutterBottom: 50
            }
          }).trace();
    };

    collectStkData(theCode);
</script>
</body>
</html>