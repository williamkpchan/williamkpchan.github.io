
<!DOCTYPE html>
<html>
<head>
<title>Minute Standard Deviation Chart</title>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src='..\mainscript.js'></script>
<script src="https://williamkpchanhp.github.io/LibDocs/longHistList.js"></script>
<script src="stkComments.js"></script>
<script src="./rchart/RGraph.common.core.js" ></script>
<script src="./rchart/RGraph.line.js"></script>
<script src="./rchart/RGraph.drawing.yaxis.js"></script>

<style>
body{width:100%;margin-left: 0%; font-size:18px;  overflow-x:auto;}
#dateTime {  text-align: left;}
#cmtNote, #instruction, #message{display:none;}
select {border-radius:10px; font-size:20px;background-color:black; color:brown;}
.chart-container {
    position: relative;
    width: 100%;
    max-width: 100vw;
    height: 700px;
    margin: 0 auto;
}
.macd-container {
    position: relative;
    width: 100%;
    max-width: 100vw;
    height: 300px;
    margin: 0 auto;
}
.period-control {
    margin: 10px 0;
    color: #ccc;
    font-size: 16px;
}
.period-control input {
    width: 60px;
    background: #333;
    color: #fff;
    border: 1px solid #666;
    border-radius: 5px;
    padding: 2px 5px;
}
.period-control button {
    background: #444;
    color: #fff;
    border: 1px solid #666;
    border-radius: 5px;
    padding: 2px 10px;
    cursor: pointer;
}
.period-control button:hover {
    background: #555;
}


/* Reset any potential overflow issues */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    margin: 0;
    padding: 0;
}

/* Chart container that always fits */
.chart-container, .macd-container  {
    position: relative;
    width: 100%;
    max-width: 100%;
    height: auto;
    min-height: 300px; /* Minimum height for visibility */
    max-height: 80vh;  /* Prevents excessive height on large screens */
    margin: 0 auto;
    padding: 10px;
    overflow: visible; /* Don't add scrollbars */
}

/* Canvas element inside */
.chart-container canvas, .macd-container canvas {
    display: block;
    width: 100% !important;
    height: 100% !important;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain; /* Maintains aspect ratio */
}

</style>

</head>
<body onkeypress="chkKey()">
<center>
<div class="chart-container">
    <canvas id="cvs" width="1800" height="700">[No canvas support]</canvas>
</div>
<div class="macd-container">
    <canvas id="macdCvs" width="1800" height="300">[No canvas support]</canvas>
</div>
<div id="lastValues"></div>
<div class="period-control">
    <span>EMA Periods: </span>
    <input type="number" id="ema60" value="400" min="200" max="900" step="50""> 
    <input type="number" id="ema120" value="500" min="200" max="900" step="50"">
    <input type="number" id="ema180" value="600" min="200" max="900" step="50"">
    <input type="number" id="ema240" value="700" min="200" max="900" step="50"">
    <input type="number" id="ema300" value="800" min="200" max="900" step="50"">
    <span style="margin-left:20px;">MACD: Fast</span>
    <input type="number" id="macdFast" value="300" min="100" max="900" step="50"">
    <span>Slow</span>
    <input type="number" id="macdSlow" value="500" min="200" max="900" step="50"">
    <span>Signal</span>
    <input type="number" id="macdSignal" value="200" min="100" max="400" step="50"">
    <button onclick="updatePeriods()" style="margin-left:10px;">Update</button>
</div>
</center><span id="nextbutton" class="randomBut gold bordred1 borRad10" onclick="jpforward()">Next</span>
<span onclick="$('#instruction').toggle();">commandsüéå </span>
<a href="AStkList.txt" class="whitebut" target="_blank">AËÇ°Ê∏ÖÂçï</a>

<select id="selectList" onchange="assignList()"></select>
<span onclick="$('#message').toggle();">messagesüéå </span>
<span class="goldbut red blueblackgrad" onclick=askforCode()>Â∞ãÂØ∂</span>

<div id="dateTime" style="margin-left:5%;" class="lime"> </div>
<pre id="instruction">
commands:
 l loadLineData, paste data array to redraw chart with std dev
 c askforCode, A stk start with sh of sz, eg sh000001
 C open Random Charts.html
 f jpforward
 b jpback
 r jprandom
 L askList, enter a CodeList
 i chgIntv
 w askWidth
5 lines: data, WAve5, WAve10, sd+, sd-
</pre>
<pre id="message"></pre>

<script>
      let thestkdata = [];
      period = 320;
      let dateLst = [];
      let openLst = [];
      let highLst = [];
      let lowLst = [];
      let closeLst = [];
      let amtLst = [];
      intv5 = 330
      stkpriceDataArr = [];
      stkList = localStorage.getItem("stkListArr").split(' ');
      stkPointer = 0;
      let myChart = null;
      let macdChart = null;
      
      // EMA and MACD period variables
      let emaPeriods = [400, 500, 600, 700, 800];
      let macdFast = 300;
      let macdSlow = 500;
      let macdSignal = 200;

      if (localStorage.getItem("randomcode") != null) {
        theCode = localStorage.randomcode;
      }else{theCode = "HSI"}

      if (localStorage.getItem("minutePeriod") != null) {
        intv5 = parseInt(localStorage.minutePeriod);
      }else{intv5 = 100}
      
      titleText = "";
      if (localStorage.getItem("datawidth") != null) {
        datawidth = parseInt(localStorage.datawidth);
      }else{datawidth = 1600}

      attentionList = ""

      var options = '';  // build the List select option
      for (var i = 0; i < allListNames.length; i++) {
         options += '<option value="' + allListNames[i]+ '">' + allListNames[i] + '</option>';
      }
      $("#selectList").html(options);

      // load localStorage.savedCodeList
      if (localStorage.getItem("savedCodeList") === null) {
        quickCodeList = ["110000"];
        localStorage.savedCodeList = quickCodeList;
      } else{
        quickCodeList = localStorage.getItem("savedCodeList").split(',');
      }

      function updatePeriods() {
          emaPeriods = [
              parseInt(document.getElementById('ema60').value),
              parseInt(document.getElementById('ema120').value),
              parseInt(document.getElementById('ema180').value),
              parseInt(document.getElementById('ema240').value),
              parseInt(document.getElementById('ema300').value)
          ];
          macdFast = parseInt(document.getElementById('macdFast').value);
          macdSlow = parseInt(document.getElementById('macdSlow').value);
          macdSignal = parseInt(document.getElementById('macdSignal').value);
          redraw();
      }

      function askforCode() {
        theCode = prompt("Code Number:", "");
        if (theCode != null && theCode != ""){
          collectStkData(theCode)
          storeCode(theCode)
        }
      }

      function askWidth() {
          var theWidth = prompt("Chart Width:", "");
          if (theWidth != null && theWidth != "") {
              datawidth = parseInt(theWidth);

              if(typeof(Storage) !== "undefined") {
                localStorage.datawidth = datawidth;
              }
              collectStkData(theCode);
          }
      }

      function addToquickCodeList() {
        codewidth = theCode.length
        if(codewidth <= 5){
          theCode = "00000"+theCode;
          codewidth = theCode.length;
          theCode = theCode.slice(codewidth-5, codewidth);
        }
        if (!quickCodeList.includes(theCode)) {
          quickCodeList.push(theCode);
          quickCodeList = Array.from(new Set(quickCodeList)); // set unique
          localStorage.savedCodeList = quickCodeList;
          alert(theCode + " added to quickCodeList")
        }
      }

    function usequickCodeList() {
        stkList = quickCodeList;
        alert("quickCodeList Total: " + quickCodeList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("quickCodeList Total: " + quickCodeList.length + "\n"+stkList);
    }

      function collectStkData(theCode) {
          codewidth = theCode.length
          if((theCode == "HSI")|(theCode == "110000")){
            theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?code=hk' + theCode
          }else{
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?code=hk' + theCode
            }else{
              //codewidth = theCode.length
              //theCode = theCode.slice(codewidth-9, codewidth)
              //theCode = theCode.slice(7, 9) + theCode.slice(0, 6);
              codewidth = theCode.length; //update to be used later
              if((codewidth == 6) && !hsReservedCode.includes(theCode)){
                 if (theCode.charAt(0) == "6"){
                    theCode = "sh"+theCode; 
                 }else{
                    theCode = "sz"+theCode
                 }
                 theStartCode = theCode
                 theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?_var=fdays_data_' + theCode + '&code=' + theCode
              }else if(codewidth == 9){
                 theCode = theCode.substring(7, 9) + theCode.substring(0, 6);
                 theStartCode = theCode
                 theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?_var=fdays_data_' + theCode + '&code=' + theCode

              }else{
                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/day/query?_var=fdays_data_' + theCode + '&code=' + theCode
              }
            }
          }
      
    theStartCode = theCode;
    thestkdata = [];
    thedrawdata = [];
    closeLst = [];
    //var theurl = theurlHead + theStartCode
    RGraph.AJAX.getJSON(theurl, function (rawJSON){
        keys = Object.keys(rawJSON); // read the structure keys ["code", "msg", "data"]
        var insideDatakey = Object.keys(rawJSON)[2] //
        // myobj[Object.keys(myobj)[0]] this is the extract method

        var thedata = rawJSON[Object.keys(rawJSON)[2]]
        thestkkey = Object.keys(thedata)[0] // this is the stk key name
        var tempdata = thedata[Object.keys(thedata)[0]]; // {data: Array(5), qt: {‚Ä¶}, vcm: ""} five sets of data here
        // old data at the back, new data at 0 location
        allData = tempdata.data[4].data.concat(tempdata.data[3].data).concat(tempdata.data[2].data).concat(tempdata.data[1].data).concat(tempdata.data[0].data)
        //(1599) ["0930 26834.15 375023", "0931 26858.43 469321"
        allData = allData.filter((val) => val != "");

          if(datawidth > allData.length){datawidth = allData.length};
          //console.log("datawidth "+datawidth)
        allData = allData.slice(allData.length-datawidth); // get only req data

        allData.forEach(str => { closeLst.push(Number(str.split(' ')[1])); }); // split the string and select only the middle close 

        theNameObj = tempdata[Object.keys(tempdata)[1]];
        theNameObjName  = theNameObj[Object.keys(theNameObj)[0]];
        stkName = theNameObjName[1]

        thedrawdata =[closeLst]; //closeLst is already originally an array
          stkpriceDataArr = closeLst
          titleText = theStartCode + " " + stkName + " ÂàÜÈêòÂúñ "+ showTime() + " c: " + closeLst[closeLst.length-1];
          redraw();  // this line must be inside the AJAX because AJAX run last
           });
          $("#nextbutton").text("Item " + (stkPointer+1) + " of " + stkList.length + ", ");
          showDateTime();

      }

     function chkKey() {
       var testkey = getChar(event);
       if(testkey == 'l'){loadLineData();}
       if(testkey == 'c'){askforCode();}
       if(testkey == 'C'){storeCode(theCode); window.open("Random Charts.html");}
       if(testkey == ','){storeCode(theCode); window.open("mlinechart.html");}
       if(testkey == 'f'){jpforward();}
       if(testkey == ']'){jpforward();}
       if(testkey == 'b'){jpback();}
       if(testkey == '['){jpback();}
       if(testkey == 'r'){jprandom();}
       if(testkey == 'i'){chgIntv();}
       if(testkey == 'L'){askList()}
       if(testkey == 'w'){askWidth()}
       if(testkey == '0'){storeCode('sh000001');collectStkData('sh000001');}
       if(testkey == '3'){storeCode('sz399001');collectStkData('sz399001');}
       if(testkey == '1'){storeCode('HSI');collectStkData('HSI');}
       if(testkey == '2'){storeCode('01339');collectStkData('01339');}
       if(testkey == '4'){storeCode('01766');collectStkData('01766');}
       if(testkey == '5'){storeCode('03800');collectStkData('03800');}
       if(testkey == '6'){storeCode('00371');collectStkData('00371');}
       if(testkey == '7'){storeCode('00788');collectStkData('00788');}
       if(testkey == '8'){storeCode('00308');collectStkData('00308');}
       if(testkey == '9'){storeCode('00390');collectStkData('00390');}
       if(testkey == 'q'){myfavor();}
       if(testkey == 'X'){storeCode(theCode); window.open("Random Charts.html");}
       if(testkey == 'D'){useAHDiff();}
       if(testkey == 'a'){useAttentionList();}
       if(testkey == 'e'){useAETFList();}
       if(testkey == 'A'){useActiveList();}
       if(testkey == 'H'){useHistoryList();}
       if(testkey == 't'){jpTo0();}
       if(testkey == '+'){addToquickCodeList();}
       if(testkey == 'Q'){usequickCodeList();}

     }
     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

    function loadLineData() {
      var dataArr = prompt("Enter Line Data seperated by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        redraw()
      }
     }
     
     function calculateEMA(data, period) {
         let ema = new Array(data.length).fill(null);
         if (data.length < period) return ema;
         
         const multiplier = 2 / (period + 1);
         
         // SMA for first value
         let sum = 0;
         for (let i = 0; i < period; i++) {
             sum += data[i];
         }
         ema[period - 1] = sum / period;
         
         // Calculate EMA for remaining values
         for (let i = period; i < data.length; i++) {
             ema[i] = (data[i] - ema[i-1]) * multiplier + ema[i-1];
         }
         
         return ema;
     }
     
     function calculateMACD(data, fastPeriod, slowPeriod, signalPeriod) {
         const fastEMA = calculateEMA(data, fastPeriod);
         const slowEMA = calculateEMA(data, slowPeriod);
         
         // Calculate MACD line
         let macdLine = new Array(data.length).fill(null);
         for (let i = 0; i < data.length; i++) {
             if (fastEMA[i] !== null && slowEMA[i] !== null) {
                 macdLine[i] = fastEMA[i] - slowEMA[i];
             }
         }
         
         // Calculate signal line (EMA of MACD)
         const validMacd = macdLine.filter(v => v !== null);
         const signalValues = calculateEMA(validMacd, signalPeriod);
         
         // Reconstruct signal line with nulls at beginning
         let signalLine = new Array(data.length).fill(null);
         let validIndex = 0;
         for (let i = 0; i < data.length; i++) {
             if (macdLine[i] !== null) {
                 if (validIndex < signalValues.length) {
                     signalLine[i] = signalValues[validIndex];
                 }
                 validIndex++;
             }
         }
         
         // Calculate histogram
         let histogram = new Array(data.length).fill(null);
         for (let i = 0; i < data.length; i++) {
             if (macdLine[i] !== null && signalLine[i] !== null) {
                 histogram[i] = macdLine[i] - signalLine[i];
             }
         }
         
         return { macdLine, signalLine, histogram };
     }

     function redraw() {
        intv10 = 2*intv5
        intv15 = 3*intv5

        stdDev = makeStd(stkpriceDataArr, intv10)
        newDevadd = makeMovAve(stkpriceDataArr, intv10).map((a, i) => a + stdDev[i]);
        newDevminus = makeMovAve(stkpriceDataArr, intv10).map((a, i) => a - stdDev[i]);
        
        // Calculate EMAs
        const ema60 = calculateEMA(stkpriceDataArr, emaPeriods[0]);
        const ema120 = calculateEMA(stkpriceDataArr, emaPeriods[1]);
        const ema180 = calculateEMA(stkpriceDataArr, emaPeriods[2]);
        const ema240 = calculateEMA(stkpriceDataArr, emaPeriods[3]);
        const ema300 = calculateEMA(stkpriceDataArr, emaPeriods[4]);
        
        // Calculate MACD
        const macd = calculateMACD(stkpriceDataArr, macdFast, macdSlow, macdSignal);
        
        // Create labels for x-axis (time periods)
        const labels = Array.from({length: stkpriceDataArr.length}, (_, i) => i + 1);
        
        mydata= [
          {
            label: 'Bottom',
            data: newDevminus,
            borderColor: 'yellow',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: 'IntvS',
            data: makeMovAve(stkpriceDataArr, intv5),
            borderColor: 'green',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: 'IntvM',
            data: makeMovAve(stkpriceDataArr, intv10),
            borderColor: 'blue',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: 'IntvL',
            data: makeMovAve(stkpriceDataArr, intv15),
            borderColor: 'brown',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: 'Top',
            data: newDevadd,
            borderColor: 'purple',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: `EMA${emaPeriods[0]}`,
            data: ema60,
            borderColor: 'cyan',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: `EMA${emaPeriods[1]}`,
            data: ema120,
            borderColor: 'orange',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: `EMA${emaPeriods[2]}`,
            data: ema180,
            borderColor: 'pink',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: `EMA${emaPeriods[3]}`,
            data: ema240,
            borderColor: 'lime',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: `EMA${emaPeriods[4]}`,
            data: ema300,
            borderColor: 'magenta',
            backgroundColor: 'transparent',
            borderWidth: 1,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          },
          {
            label: 'Price',
            data: stkpriceDataArr,
            borderColor: 'red',
            backgroundColor: 'transparent',
            borderWidth: 2,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          }
        ];

        // Filter out null values for min/max calculation
        const allValues = [].concat(...mydata.map(d => d.data.filter(v => v !== null && !isNaN(v))));
        theMax = Math.max(...allValues);
        theMin = Math.min(...allValues);

        statusMsg = '<span class="red">Âè™‰ø°Ë∂®Âã¢Ôºöprice '+ mydata[10].data.slice(-1)[0].toFixed(3) +
        '</span>, <span class="lime">intvS '+ mydata[1].data.slice(-1)[0].toFixed(3) +
        '</span>, <span class="blue">intvM '+ mydata[2].data.slice(-1)[0].toFixed(3) +
        '</span>, <span class="brown">intvL '+ mydata[3].data.slice(-1)[0].toFixed(3) +
        '</span>, <span class="purple">Top '+ mydata[4].data.slice(-1)[0].toFixed(3) +
        '</span>, <span class="yellow">Bottom '+ mydata[0].data.slice(-1)[0].toFixed(3) +
        '</span>, <span class="cyan">EMA'+emaPeriods[0]+' '+ (ema60.slice(-1)[0] || 0).toFixed(3) +
        '</span>, <span class="orange">EMA'+emaPeriods[1]+' '+ (ema120.slice(-1)[0] || 0).toFixed(3) +
        '</span>, <span class="lime">IntvS '+ intv5 +
        '</span>, <span class="blue">IntvM '+ intv10 +
        '</span>, <span class="brown">IntvL '+ intv15 +
        '</span>';

        $("#lastValues").text("");
        $("#lastValues").append(statusMsg);

        drawchart(labels, mydata, theMin, theMax, titleText);
        drawMACD(labels, macd);
     }

    function drawMACD(labels, macdData) {
        const ctx = document.getElementById('macdCvs').getContext('2d');
        
        // Destroy existing chart if it exists
        if (macdChart) {
            macdChart.destroy();
        }
        
        // Prepare histogram data with colors
        const histogramColors = macdData.histogram.map(v => {
            if (v === null) return 'rgba(0,0,0,0)';
            return v >= 0 ? 'rgba(0,255,0,0.5)' : 'rgba(255,0,0,0.5)';
        });
        
        // Create MACD chart with both bar and line datasets
        macdChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Histogram',
                        data: macdData.histogram,
                        backgroundColor: histogramColors,
                        borderColor: 'transparent',
                        barPercentage: 0.8,
                        categoryPercentage: 0.9,
                        yAxisID: 'y',
                        order: 2
                    },
                    {
                        label: 'MACD Line',
                        data: macdData.macdLine,
                        type: 'line',
                        borderColor: 'blue',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        yAxisID: 'y',
                        order: 1
                    },
                    {
                        label: 'Signal Line',
                        data: macdData.signalLine,
                        type: 'line',
                        borderColor: 'red',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        yAxisID: 'y',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `MACD (${macdFast}, ${macdSlow}, ${macdSignal})`,
                        color: 'grey',
                        font: { size: 16 }
                    },
                    legend: {
                        display: true,
                        labels: { color: '#ccc' }
                    },
                    tooltip: {
                        enabled: false // Set to false to disable tooltips
                    }
                },
                scales: {
                    y: {
                        position: 'right',
                        grid: { color: '#002010' },
                        ticks: { color: '#ccc' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { 
                            display: false  // Hide x-axis labels to match main chart
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    function makeMovAve(bigArray, intv) {
         // the intv-1 is correct
        return bigArray.slice(0, intv-1).concat(calcMovAve(bigArray, intv));
    }
    function calcAve(aveArray) {
        add = (a, b) =>  a + b;
        return aveArray.reduce(add) / aveArray.length;
    }
    
    function calcMovAve(bigArray, intv) {
        var ma = [];
        for (var i =0 ; i < (bigArray.length-intv+1); i++) {ma[i] = calcWAve(bigArray.slice(i, i+intv));} // points to indicator
        return ma;
    }
    function calcWAve(aveArray) {
        var sum = 0
        for( var i = 1; i <= aveArray.length; i++ ) {
            sum += aveArray[i-1] * i;
        }
        return (sum / ((1 + aveArray.length)*aveArray.length/2))
    }

    function makeStd(bigArray, intv) {
         // the intv-1 is correct
          newArray = new Array(intv-1).fill(0)
        newArray = newArray.concat(calcStd(bigArray, intv));
        return newArray
    }

    function calcStd(bigArray, intv) {
        var stdArrar = [];
        for (var i =0 ; i < (bigArray.length-intv+1); i++) {stdArrar[i] = Std(bigArray.slice(i, i+intv));} // points to indicator
        return stdArrar;
    }

    function Std(array) {
      const n = array.length
      const mean = array.reduce((a, b) => a + b) / n
      return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
    }


    function askList() {
        var theList = prompt("enter CodeList, Numbers (5 digits) sep by spaceÔºö ", "");
        if (theList != null && theList != "HSI" && theList != "") {
            stkList = theList.split(" ");
        }
    }

    function useAttentionList() {
        stkList = attentionList;
        alert("AttentionList Total: " + attentionList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + attentionList.length + "\n"+stkList);
    }
    function useAHDiff() {
        ahDiffList = ahDiffList.split(" ");
        stkList = ahDiffList;
        alert("ahDiffList Total: " + ahDiffList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + ahDiffList.length + "\n"+stkList);
    }

    function useAETFList() {
        aETFList = aETFList.split(" ");
        stkList = aETFList;
        alert("A ETF List Total: " + aETFList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + aETFList.length + "\n"+stkList);
    }

    function useHistoryList() {
        longHistLst = longHistList.split(" ");
        stkList = longHistLst;
        alert("longHistLst Total: " + longHistLst.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("longHistLst Total: " + longHistLst.length + "\n"+stkList);
    }

    function myfavor() {
        myfavorLst = mychips.split(" ");
        stkList = myfavorLst;
        alert("mychips Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("mychips Total: " + stkList.length + "\n"+stkList);
    }

    function useActiveList() {
        activeLst = activeList.split(" ");
        stkList = activeLst;
        alert("ActiveLst Total: " + activeLst.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("myfavorList Total: " + activeLst.length + "\n"+stkList);
    }


    function FormatNumberLength5(num) {
        var r = "" + num;
        while (r.length < 5) { r = "0" + r; }
        return r;
    }

    function jpforward() {
        if (stkPointer < stkList.length-1) {
            stkPointer = stkPointer + 1;
        } else {
            stkPointer = 0;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }

    function jpback() {
        if (stkPointer > 0) {
            stkPointer = stkPointer - 1;
        } else {
            stkPointer = stkList.length-1;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }
    function jpTo0() {
        stkPointer = 0;
        theCode = stkList[stkPointer]
        collectStkData(theCode)
    }

    function jprandom() {
        stkPointer = Math.floor(Math.random() * (stkList.length-1))
        theCode = stkList[stkPointer]
         collectStkData(theCode)
    }
    function storeCode(aCode) {
        if(typeof(Storage) !== "undefined") {
            localStorage.randomcode = aCode;
        }
        theCode = aCode;
    }

    function chgIntv() {
        intv = prompt("intv5 value:", "");
        if (theCode != null && intv5 != ""){
          intv5 = parseInt(intv);
          localStorage.setItem("minutePeriod", intv5);
          redraw(theCode)
        }
    }
function assignList(){
  newList = eval(document.getElementById("selectList").value).split(" ");
  stkList = newList;
  //console.log(newList)
  alert(" Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!\n" + newList)
        $("#message").text("Total: " + stkList.length + "\n"+stkList);
  window.location.hash = '#nextbutton';
}

function showDateTime() {
    var theDateTime = showDate() +" "+ showTime();

    commentTxt = "<br>";
    document.getElementById("dateTime").innerHTML = "";
    document.getElementById("dateTime").innerHTML = theDateTime  + " <span class='orange'>" + commentTxt + "</span>";
}


    function showTime() {
    let d = new Date();
    let y=d.getFullYear().toString().substr(-2);
    let mo=d.toLocaleString('default', { month: 'short' });
    let da=d.getDate();
    let secs=d.getSeconds();
    let mins=d.getMinutes();
    let hr=d.getHours();
    let timemsg=da+mo+y+" "+FormatNumberLength(hr) +":" + FormatNumberLength(mins) + ":"+ FormatNumberLength(secs)
    return(timemsg)
    }

    function FormatNumberLength(num) {
        let r = "" + num;
        while (r.length < 2) { r = "0" + r;}
        return r;
    }

    function drawchart(labels, datasets, yMin, yMax, title) {
      const ctx = document.getElementById('cvs').getContext('2d');
      
      // Destroy existing chart if it exists
      if (myChart) {
        myChart.destroy();
      }

      // Create new chart
      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: title,
              color: 'grey',
              font: {
                size: 20
              }
            },
            legend: {
              display: true,
              labels: {
                color: '#ccc'
              }
            },
            tooltip: {
              enabled: false // Set to false to disable tooltips
            }
          },
          scales: {
            y: {
              min: yMin,
              max: yMax,
              grid: {
                color: '#002010',
                drawTicks: true
              },
              ticks: {
                color: '#ccc',
                callback: function(value, index, values) {
                  return value.toFixed(2);
                }
              },
              title: {
                display: true,
                text: 'Value',
                color: '#ccc'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                display: false  // Hide x-axis labels to avoid clutter
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });

      // Add percentage axis on the right (simulated with another y-axis)
      const yMinPct = 100 - (yMax - yMin) * 100 / yMax;
      const yMaxPct = 100;
      
      // We can add a second y-axis for percentage
      //myChart.options.scales.yPercent = {
      //  position: 'right',
      //  min: yMinPct,
      //  max: yMaxPct,
      //  grid: {
      //    drawOnChartArea: false
      //  },
      //  ticks: {
      //    color: 'gold',
      //    callback: function(value) {
      //      //return value.toFixed(1) + '%';
      //    }
      //  },
      //  title: {
      //    display: true,
      //    text: '% pct',
      //    color: 'gold'
      //  }
      //};
      
      // Update the chart with the new axis
      myChart.update();
    };

    collectStkData(theCode);
</script>
</body>
</html>
