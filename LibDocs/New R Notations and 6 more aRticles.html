<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<style>

a:hover,a:active{color:red}
table.w3-table-all{margin:20px 0}
.top {
 position:relative;
 background-color:black;
 height:68px;
 padding-top:20px;
 line-height:50px;
 overflow:hidden;
 z-index:2;
}
body {
 background-color: #000000;
 color: MediumSeaGreen;
 margin-left: 14%;
 margin-right: 14%;
 font-size: 24px;
}
a { text-decoration: none;
	color: #58D858;}
a:visited { color: #88C898;}
A:hover {	color: yellow;}
A:focus {	color: red;}
code { color: gray; background-color: #002010; font-size: 18px;}
pre { color: gray; background-color: #001010; font-size: 18px;}
h1, h2, h3, h4, h5, .goldword {
	color: gold;
}
table{
	width: 100%;
	font-size: 20px;
	border-collapse: collapse;
	border: 1px solid gray;
}
th{
	border: 1px solid gray;
	font-weight:bold;
	color: lightgreen;
}
td{
	padding:10px;
	border: 1px dotted dimgray;
}}
tr>th:first-child{
	width:40%;
}
tr>td:first-child{
	color: lime;

}
.topic{
    color: lime;
}
.left {
    position: absolute;
    left: 100px;
    color: GoldenRod;
    border: 1px solid GoldenRod;
    padding: 2px;
    font-size: 60%;
}
.bord {
    color: redpink;
    border: 1px solid GoldenRod;
    padding: 1px;
    font-size: 90%;
}
.highlight { 
    color: white;
    background-color: #002030
  }
hr {width: 50%;}
li{
	list-style-type: decimal;
}
#toc, #tang, #san, #pill {
	margin-left: 15%;
	margin-right: 15%;
	color: gold;
	padding: 1%;
	text-align: left;
	box-shadow: 5px 5px 15px silver;
	border-radius: 5px;
	border: 1px solid DarkSlateGray;
    font-size: 90%;
}
.mywords{
    color: Crimson;
}
.orangeword{
    color: orange;
}
.remarks {
	font-size: 22px;
	color: MediumSeaGreen;
}
</STYLE>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.js"></script>
<script>
$(document).ready(function(){
    $('h1, h2, h3, h4, h5, .goldword, .topic').click(function(){
    parent.history.back();
    return false;
    });
});
</script>


</head><body>

<center><h3>Some Neat New R Notations (and 6 more aRticles)</h3></center>
<div id="toc"><ul></ul></div>
<br>
<br>

<ul>
<li>
<a name="#mm">Some Neat New R Notations</a>
</li>
<li>
<a href="#m_5853171786120636607_2">How to Create an Online Choice Simulator</a>
</li>
<li>
<a href="#m_5853171786120636607_3">Understanding gender roles in movies with text mining</a>
</li>
<li>
<a href="#m_5853171786120636607_4">Tidyer BLS data with the blscarpeR package</a>
</li>
<li>
<a href="#m_5853171786120636607_5">Learning things we already know about stocks</a>
</li>
<li>
<a href="#m_5853171786120636607_6">Using regression trees for forecasting double-seasonal time series with trend in R</a>
</li>
<li>
<a href="#m_5853171786120636607_7">Free simmer hexagon stickers!</a>
</li>
</ul>

Some Neat New R Notations
<br>
<p>
<p>The first notation is an operator called the <a href="https://winvector.github.io/seplyr/articles/named_map_builder.html" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://winvector.github.io/seplyr/articles/named_map_builder.html&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNEMM5Y8UMImL_em0qV3qjDf4sNDgw">“named map builder”</a>. This is a cute notation that essentially does the job of <code>stats::setNames()</code>. It allows for code such as the following:</p>
<pre>
library(&quot;seplyr&quot;)

names &lt;- c(&#39;a&#39;, &#39;b&#39;)

names := c(&#39;x&#39;, &#39;y&#39;)
#&gt;   a   b 
#&gt; &quot;x&quot; &quot;y&quot;
</pre>
<p>This can be <em>very</em> useful when programming in <code>R</code>, as it allows indirection or abstraction on the left-hand side of inline name assignments (unlike <code>c(a = &#39;x&#39;, b = &#39;y&#39;)</code>, where all left-hand-sides are concrete values even if not quoted).</p>
<p>A nifty property of the named map builder is it <a href="https://en.wikipedia.org/wiki/Commutative_diagram" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Commutative_diagram&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNED6304CW0OxooqiyZce15i8eMDPw">commutes</a> (in the sense of algebra or category theory) with <code>R</code>‘s “<code>c()</code>” combine/concatenate function. That is: <code>c(&#39;a&#39; := &#39;x&#39;, &#39;b&#39; := &#39;y&#39;)</code> is the same as <code>c(&#39;a&#39;, &#39;b&#39;) := c(&#39;x&#39;, &#39;y&#39;)</code>. Roughly this means the two operations play well with each other.</p>
<p>The second notation is an operator called “<a href="https://winvector.github.io/seplyr/reference/makeFunction_se.html" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://winvector.github.io/seplyr/reference/makeFunction_se.html&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNHe8QOWbPACYYd_8UXUv2qvcnwxNA">anonymous function builder</a>“. For technical reasons we use the same “<code>:=</code>” notation for this (and, as is common in <code>R</code>, pick the correct behavior based on runtime types).</p>
<p>The function construction is written as: “<code>variables := { code }</code>” (the braces are required) and the semantics are roughly the same as “<code>function(variables) { code }</code>“. This is derived from some of the work of <a href="http://klmr.me/about/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://klmr.me/about/&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNFXxPJoQwY5BhhHWfxbSsPeSYvIdw">Konrad Rudolph</a> who noted that most functional languages have a more concise “lambda syntax” than “function(){}” (please see <a href="http://www.win-vector.com/blog/2016/12/the-case-for-using-in-r/comment-page-1/#comment-66399" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://www.win-vector.com/blog/2016/12/the-case-for-using-in-r/comment-page-1/%23comment-66399&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNH2baTxY_xBso9Jb90u9W_NnQGvXg">here</a> and <a href="https://github.com/klmr/functional#a-concise-lambda-syntax" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://github.com/klmr/functional%23a-concise-lambda-syntax&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNH0k7QD6hWC59HcP0ZX7xu0dp5VNQ">here</a> for some details, and be aware the <code>seplyr</code> notation is not as concise as is possible).</p>
<p>This notation allows us to write the squares of <code>1</code> through <code>4</code> as:</p>
<pre>
sapply(1:4, x:={x^2})
</pre>
<p>instead of writing:</p>
<pre>
sapply(1:4, function(x) x^2)
</pre>
<p>It is only a few characters of savings, but being able to choose notation <a href="http://dl.acm.org/citation.cfm?id=358899" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://dl.acm.org/citation.cfm?id%3D358899&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNET2PZ-yO3N6ZwP17yGiGI5wC2QeA">can be a big deal</a>. A real victory would be able to directly use <a href="https://en.wikipedia.org/wiki/Lambda_calculus" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Lambda_calculus&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNHNXX9DRhiXErbtnQrG2OnQJoZDng">lambda-calculus</a> notation such as “<code>(λx.x^2)</code>“. In the <a href="https://github.com/WinVector/seplyr" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://github.com/WinVector/seplyr&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNH3thXg2sNH5XLTw-OcUDHHjQuwqA">development version of <code>seplyr</code></a> we are experimenting with the following additional notations:</p>
<pre>
sapply(1:4, lambda(x)(x^2))
</pre>
<pre>
sapply(1:4, λ(x, x^2))
</pre>
<p>(Both of these currenlty work in the development version, though we are not sure about submitting source files with non-ASCII characters to CRAN.)</p>
<p class="m_5853171786120636607syndicated-attribution">
<hr>
<a href="https://www.r-bloggers.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNHDIOZf3cAkzg94anyTekb0i7T3nQ">R-bloggers.com</a> offers <strong><a href="https://feedburner.google.com/fb/a/mailverify?uri=RBloggers" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://feedburner.google.com/fb/a/mailverify?uri%3DRBloggers&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNEaTIOPb8rSajnmB4tSF_HXKMNhNw">daily e-mail updates</a></strong> about <a title="The R Project for Statistical Computing" href="https://www.r-project.org/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-project.org/&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNGZiQlg-7xM3obj73gqTjfXT239UQ">R</a> news and <a title="R tutorials" href="https://www.r-bloggers.com/search/tutorial" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/tutorial&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNFW66Jq6KXt98HoTqHRDDRT1aQHHg">tutorials</a> on topics such as: <a title="Data science" href="https://www.r-bloggers.com/search/data%20science" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/data%2520science&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNHIobAdN8tqDVAa_jO_qPywlJf0Rg">Data science</a>, <a title="Big Data" href="https://www.r-bloggers.com/search/Big%20Data" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Big%2520Data&amp;source=gmail&amp;ust=1509512084246000&amp;usg=AFQjCNEEdVDAvf4nlL3clzKSzgqp7wk1kw">Big Data, <a title="R jobs" href="https://www.r-users.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-users.com/&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNGhusaUUXlVajRhpQLZJq_OI2H5IQ">R jobs</a>, visualization (<a title="ggplot and ggplot2 tutorials" href="https://www.r-bloggers.com/search/ggplot2" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/ggplot2&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNGoNsOasr0Y_VNe_9z2z1mF8kEacw">ggplot2</a>, <a title="Boxplots using lattice and ggplot2 tutorials" href="https://www.r-bloggers.com/search/boxplot" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/boxplot&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFVHKgcIQGtsMIwaqzpZJS_s-GOng">Boxplots</a>, <a title="Maps and gis" href="https://www.r-bloggers.com/search/map" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/map&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFLFjjkaiTNVw_bUJzoXqaqBCsnEw">maps</a>, <a title="Animation in R" href="https://www.r-bloggers.com/search/animation" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/animation&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNF_Ntzbn5nIRK8S3IIoHM854SVYkw">animation</a>), programming (<a title="RStudio IDE for R" href="https://www.r-bloggers.com/search/RStudio" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/RStudio&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNEOfD4GZd3yhrHB9731Td5W6s_oaw">RStudio</a>, <a title="Sweave and literate programming" href="https://www.r-bloggers.com/search/sweave" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/sweave&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFyEsIr-LYPCO0afCT8KVWLPLivYg">Sweave</a>, <a title="LaTeX in R" href="https://www.r-bloggers.com/search/LaTeX" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/LaTeX&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNExxDweot8QIQ6Y8RiszHTYCJI5FQ">LaTeX</a>, <a title="SQL and databases" href="https://www.r-bloggers.com/search/SQL" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/SQL&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFIX8EwLYrKlLFZuGm_6KofDhmk5Q">SQL</a>, <a title="Eclipse IDE for R" href="https://www.r-bloggers.com/search/eclipse" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/eclipse&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNEc5Va3x0oO2WB-vNUsWf1BYqWn-A">Eclipse</a>, <a title="git and github, Version Control System" href="https://www.r-bloggers.com/search/git" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/git&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNGxm1qs3UgRRCylEJZbRQlc3hUPTg">git</a>, <a title="Large data in R using Hadoop" href="https://www.r-bloggers.com/search/hadoop" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/hadoop&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNF-h002_gn-4-AgwmUqrbBBB20ldw">hadoop</a>, <a title="Web Scraping of google, facebook, yahoo, twitter and more using R" href="https://www.r-bloggers.com/search/Web+Scraping" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Web%2BScraping&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFOQIUkNuWqVtndr2zCxNo8do9VIQ">Web Scraping</a>) statistics (<a title="Regressions and ANOVA analysis tutorials" href="https://www.r-bloggers.com/search/regression" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/regression&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNGsr2TfRogq0KTNyMhCkrSYzM427w">regression</a>, <a title="principal component analysis tutorial" href="https://www.r-bloggers.com/search/PCA" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/PCA&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNE8sC83-HqIpNEZfFKsCd0URegqzg">PCA</a>, <a title="Time series" href="https://www.r-bloggers.com/search/time+series" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/time%2Bseries&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNHQbIwedmM8otS-XtwCfcmw69H99Q">time series</a>, <a title="finance trading" href="https://www.r-bloggers.com/search/trading" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/trading&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFs9IFHr1Iy7VT0r2aw5L9ybFuTDQ">trading</a>) and more...
</a></div></p><img src="https://ci3.googleusercontent.com/proxy/ZRcrW-v0EcSF6ipizvuue_H9U7pEDfo38NR0boYveJE58Z9_VNIYhVPVTsaXh4KGxg8t3yxMh2zGqf8TAlENyg1MGCTXyej89DUH3aHsv9FClZEVqzmuhTXyvyogQdcAnypdFa9WGlG5rdMZtjv7xpsards=s0-d-e1-ft#http://feeds.feedburner.com/~r/RBloggers/~4/a4g7PBztgAs?utm_source=feedburner&amp;utm_medium=email" height="1" width="1" alt=""><p>This posting includes an audio/video/photo media file: <a>Download Now</a>
</p>
</p></div>
</td>
</tr>
<tr>
<td style="margin-bottom:0;line-height:1.4em">
<p style="margin:1em 0 3px 0">
<a name="m_5853171786120636607_2" style="font-family:Arial,Helvetica,sans-serif;font-size:19px" href="http://feedproxy.google.com/~r/RBloggers/~3/Gx7zkZQy55M/?utm_source=feedburner&amp;utm_medium=email" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://feedproxy.google.com/~r/RBloggers/~3/Gx7zkZQy55M/?utm_source%3Dfeedburner%26utm_medium%3Demail&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNGIS3P5Xy7p_KhzJuiGibau9fWseQ">How to Create an Online Choice Simulator</a>
</p>
<p><img src="https://ci4.googleusercontent.com/proxy/-XCIUXitZM8x4n44ZKlDNxe8eme5glHKofTzZOyg1t26zu0sZ7t6gvQivuWwxhDyJ7780g_rS6qpMwywcXiSrG2bIfC5D7Frl7VlqZUvxq46tVq0tmlcDL9Zag6AswjhBpA7ecsXmBN07HzKZDbN3xBZagkjdtO3opUkDSRbkeL17ypQiws=s0-d-e1-ft#https://i2.wp.com/www.displayr.com/wp-content/uploads/2017/07/ChoiceSimulator-300x173.png?resize=300%2C173&amp;ssl=1" class="m_5853171786120636607webfeedsFeaturedVisual m_5853171786120636607wp-post-image" alt="Choice Simulator" style="float:left;margin-right:20px">
<p><img class="m_5853171786120636607alignnone m_5853171786120636607wp-image-2595 m_5853171786120636607size-full" src="https://ci5.googleusercontent.com/proxy/vYfszNyN_ZcZlgQJ0Y7rlHJ9QTmegsEYj1WVNjoe8AGhjuPvGcWZWCrHJW7GwwBSkNvgKQULTJIpwh8oBUzfQzOnLmRDenctZX5TitTs6Nmb0BnsrnSHmwd4-czlK7Yc0CI2wAPTC404ixdpn4jdcov-kg=s0-d-e1-ft#https://i0.wp.com/www.displayr.com/wp-content/uploads/2017/07/ChoiceSimulator.png?w=450&amp;ssl=1" alt="Choice model simulator"></p>
<h1><span style="color:#2b2a2f">What is a choice simulator?</span></h1>
<p>A <em>choice simulator </em>is an online app or an Excel workbook that allows users to specify different scenarios and get predictions. Here is an <a href="https://app.displayr.com/Dashboard?id=21043f64-45d0-47af-9797-cd4180805849" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://app.displayr.com/Dashboard?id%3D21043f64-45d0-47af-9797-cd4180805849&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNG8GuJAKf_y739w5efSlsh-i_a_jw">example of a choice simulator</a>.</p>
<p>Choice simulators have many names: decision support systems, market simulators, preference simulators, desktop simulators, conjoint simulators, and choice model simulators.</p>
<hr>
<h1><span style="color:#2b2a2f">How to create a choice simulator</span></h1>
<p>In this post, I show how to create an online choice simulator, with the calculations done using R, and the simulator is hosted in Displayr.</p>
<hr>
<h2><span style="color:#2b2a2f">Step 1: Import the model(s) results</span></h2>
<p>First of all, choice simulators are based on models. So, the first step in building a choice simulator is to obtain the model results that are to be used in the simulator. For example, here I use respondent-level parameters from a latent class model, but there are many other types of data that could have been used (e.g., parameters from a GLM, draws from the posterior distribution, beta draws from a maximum simulated likelihood model).</p>
<p>If practical, it is usually a good idea to have model results at the case level (e.g., respondent level), as the resulting simulator can then be easily automatically weighted and/or filtered. If you have case level data, the model results should be imported into Displayr as a <a href="http://docs.displayr.com/wiki/Data_Set" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://docs.displayr.com/wiki/Data_Set&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNEuMzT4FrBjU1vmRS_R-bPUq4skPw">Data Set</a>. See <a href="https://www.displayr.com/introduction-to-displayr-2-data/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.displayr.com/introduction-to-displayr-2-data/&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFirr5sVnnH4wTR2SBHc-bXJmu7sA">Introduction to Displayr 2: Getting your data into Displayr</a> for an overview of ways of getting data into Displayr.</p>
<p>The table below shows estimated parameters of respondents from a discrete choice experiment of the market for eggs. You can work your way through the <a href="https://app.displayr.com/Try/Choice%20Utilities" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://app.displayr.com/Try/Choice%2520Utilities&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNH1g0ikSbfsNH446M0Ut4JSwfT7zg">choice simulator example used in this post here</a> (the link will first take you to a login page in Displayr and then to a document that contains the data in the <em>variable set </em>called <strong>Individual-Level Parameter Means for Segments 26-Jun-17 9:01:57 AM</strong>).</p>
<p>
</p>
<hr>
<h1><span style="color:#2b2a2f">Step 2: Simplify calculations using variable sets</span></h1>
<p>Variable sets are a novel and very useful aspect of Displayr. Variable sets are related variables that are grouped. We can simplify the calculations of a choice simulator by using the variable sets, with one variable set for each attribute.</p>
<p><img class="m_5853171786120636607alignright m_5853171786120636607wp-image-2235 m_5853171786120636607size-full" src="https://ci6.googleusercontent.com/proxy/tydGqFev3KQC0Ccrv6Q4v1mtAt-64fah2YOah2jqw5RaG3f_xOxrI-0AtMdas7zrINRNGM2YA3YkuPdYQ0bdZo1CI1pkeemSDggT8oyX54oVSxrJrj7G0K9Z0L7vgRMrRUbJlqrsPE-PfkrD8m1k1o-Qa2j8ldKFR6lQNQ64VQ=s0-d-e1-ft#https://i0.wp.com/www.displayr.com/wp-content/uploads/2017/06/TidiedAttributes.png?resize=224%2C417&amp;ssl=1" alt="Variable sets in data tree"></p>
<p>In this step, we group the variables for each attribute into separate variable sets, so that they appear as shown on the right. This is done as follows:</p>
<ol>
<li>If the variables are already grouped into a variable set, select the variable set, and select <strong>Data Manipulation &gt;</strong> Split (Variables). In the dataset that I am using, all the variables I need for my calculation are already grouped into a single variable set called <strong>Individual-Level Parameter Means for Segments 26-Jun-17 9:01:57 AM</strong>, so I click on this and split it.</li>
<li>Next, select the first attribute’s variables. In my example, this is the four variables that start with <strong>Weight:</strong>, each of which represents the respondent-level parameters for different egg weights. (The first of these contains only 0s, as <em>dummy coding</em> was used.)<img class="m_5853171786120636607alignright m_5853171786120636607wp-image-2234 m_5853171786120636607size-full" title="Variables in data tree for choice simulator" src="https://ci3.googleusercontent.com/proxy/NClM5ipUyHE0s8ITWDr10PbM22ywSbcr9DCtUTcXvJ7g_nGiqIq7I7X1cwXp85MGJz0XTLk0wuBau6mO2CGF2RSKUSz31hEIrZBwWe3SAjx4mQeP1vMuqZ5qqNVsCecaIlukEdiJQLzN9tuu-MMZjde4u7ugs_sH1w=s0-d-e1-ft#https://i0.wp.com/www.displayr.com/wp-content/uploads/2017/06/WeightsSet.png?resize=272%2C237&amp;ssl=1" alt="Variables in data tree for choice simulator"></li>
<li>Then, go to <strong>Data Manipulation &gt;</strong> Combine (Variables).</li>
<li>Next set the <strong>Label</strong> for the new variable set to something appropriate. For reasons that will become clearer below, it is preferable to set it to a single, short word. For example, <span style="font-family:&#39;Courier New&#39;">Weight</span>.</li>
<li>Set the <strong>Label </strong>field for each of the variables to whatever label you plan to show in the choice simulator. For example, if you want people to be able to choose an egg weight of 55g (about 2 ounces), set the <strong>Label </strong>to <span style="font-family:&#39;Courier New&#39;">55g.</span></li>
<li>Finally, repeat this process for all the attributes. If you have any numeric attributes, then leave these as a single variable, like <strong>Price</strong> in the example here.<br>
<hr>
</li>
</ol>
<h1><span style="color:#2b2a2f">Step 3: Create the controls</span></h1>
<p><img class="m_5853171786120636607alignright m_5853171786120636607wp-image-2237" src="https://ci5.googleusercontent.com/proxy/AVqMSnQ7fHh7KripAEvw25x2ocoRGFplKQuHQpCvrO6gxckTOps4EKe_sWSFagdek6ULdwYrhhHVKH3SlfSKy7mQuWMzQv_cCjDNo6NzaIhJTyTTKyNjtJB8bgBRBXp5meWSlER-b0TgUdoeCmEhMoCrYXlQ2Ih5i2iOYRUO8V5T=s0-d-e1-ft#https://i1.wp.com/www.displayr.com/wp-content/uploads/2017/06/ChoiceSimulatorBasic-1024x265.png?w=450&amp;ssl=1" alt="Choice model simulation inputs"></p>
<p>In my <a href="https://app.displayr.com/Dashboard?id=21043f64-45d0-47af-9797-cd4180805849" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://app.displayr.com/Dashboard?id%3D21043f64-45d0-47af-9797-cd4180805849&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNG8GuJAKf_y739w5efSlsh-i_a_jw">choice simulator</a>, I have separate columns of controls (i.e., combo boxes) for each of the brands. The fast way to do this is to first create them for the first alternative (column), and then copy and paste them:</p>
<ol>
<li><strong>Insert &gt; Control (More)</strong>.</li>
<li>Type the levels, separated by semi-colons, into the <strong>Item list</strong>. These must match, exactly, to the labels that you have entered for the <strong>Labels </strong>for the first attribute in point 5 in the previous step. For example: <span style="font-family:&#39;Courier New&#39;">55g;</span> 60g; 65g; 70g. I recommend using copy and paste because if you make some typos they will be difficult to track down. Where you have a numeric attribute, such as Price in the example, you enter the range of values that you wish the user to be able to choose from (e.g., <strong><span style="font-family:&#39;Courier New&#39;">1.50</span></strong>; 2.00; 2.50; 3.00; 3.50; 4.00; 4.50; 5.00).</li>
<li>Select the <strong>Properties </strong>tab in the <a href="http://docs.displayr.com/wiki/Object_Inspector" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://docs.displayr.com/wiki/Object_Inspector&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNFZhq2Ye0WTPIU11yPkttnJWiLEkw">Object Inspector</a> and set the <strong>Name </strong>of the control to whatever you set as the <strong>Label </strong>for the corresponding variable set with the number 1 affixed at the end. For example, <span style="font-family:&#39;Courier New&#39;">Weight.1 </span>(You can use any label, but following this convention will save you time later on.)</li>
<li>Click on the control and select the first level. For example, <strong>55g</strong>.</li>
<li>Repeat these steps until you have created controls for each of the attributes, each under each other, as shown above.</li>
<li>Select all the controls that you have created, and then select <strong>Home &gt;</strong> <strong>Copy</strong> and <strong>Home &gt; Paste</strong>, and move the new set of labels to the right of the previous labels. Repeat this for as many sets of alternatives as you wish to include. In my example, there are four alternatives.</li>
<li>Finally, add labels for the brands and attributes: <strong>Insert &gt;</strong> TextBox (Text and Images).</li>
</ol>
<p>See also <a href="https://www.displayr.com/combo-box/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.displayr.com/combo-box/&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNHWL51w1uGSfJ_6Oe_FyKe4cy6VkA">Adding a Combo Box to a Displayr Dashboard</a> for an intro to creating combo boxes.</p>
<hr>
<h1><span style="color:#2b2a2f">Step 4: Calculate preference shares</span></h1>
<ol>
<li>Insert an <strong>R Output </strong>(<strong>Insert &gt; R Output (Analysis)</strong>), setting it to <strong>Automatic </strong>with the appropriate code, and positioning it underneath the first column of combo boxes. Press the <strong>Calculate </strong>button, and it should calculate the share for the first alternative. If you paste the code below, and everything is setup properly, you will get a value of 25%.</li>
<li>Now, click on the R Output you just created, and copy-and-paste it. Position the new version immediately below the second column of combo boxes.</li>
<li>Modify the very last line of code, replacing <span style="font-family:&#39;Courier New&#39;">[1]</span> with <span style="font-family:&#39;Courier New&#39;">[2]</span>, which tells it to show the results of the second alternative.</li>
<li>Repeat steps 2 and 3 for alternatives 3 and 4.</li>
</ol>
<p>The code below can easily be modified for other models. A few key aspects of the code:</p>
<ul>
<li>It works with four alternatives and is readily modified to deal with different numbers of alternatives.</li>
<li>The formulas for the <em>utility </em>of each alternative are expressed as simple mathematical expressions. Because I was careful with the naming of the variable sets and the controls, they are easy to read. If you are using Displayr, you can hover over the various elements of the formula and you will get a preview of their data.</li>
<li>The code is already setup to deal with weights. Just click on the R Output that contains the formula and apply a weight (<strong>Home &gt; Weight</strong>).</li>
<li>It is set up to automatically deal with any filters. More about this below.</li>
</ul>
<h5><span style="color:#2b2a2f">R Code to paste:</span></h5>
<pre class="m_5853171786120636607brush: m_5853171786120636607r; m_5853171786120636607title: m_5853171786120636607; notranslate">
# Computing the utility for each alternative
u1 = Weight[, Weight.1] + Organic[, Organic.1] + Charity[, Charity.1] + Quality[, Quality.1] + Uniformity[, Uniformity.1] + Feed[, Feed.1] + Price*as.numeric(gsub(&quot;\\$&quot;, &quot;&quot;, Price.1))
u2 = Weight[, Weight.2] + Organic[, Organic.2] + Charity[, Charity.2] + Quality[, Quality.2] + Uniformity[, Uniformity.2] + Feed[, Feed.2] + Price*as.numeric(gsub(&quot;\\$&quot;, &quot;&quot;, Price.2))
u3 = Weight[, Weight.3] + Organic[, Organic.3] + Charity[, Charity.3] + Quality[, Quality.3] + Uniformity[, Uniformity.3] + Feed[, Feed.1] + Price*as.numeric(gsub(&quot;\\$&quot;, &quot;&quot;, Price.3))
u4 = Weight[, Weight.4] + Organic[, Organic.4] + Charity[, Charity.4] + Quality[, Quality.4] + Uniformity[, Uniformity.4] + Feed[, Feed.1] + Price*as.numeric(gsub(&quot;\\$&quot;, &quot;&quot;, Price.4))
# Computing preference shares
utilities = as.matrix(cbind(u1, u2, u3, u4))
eutilities = exp(utilities)
shares = prop.table(eutilities, 1)
# Filtering the shares, if a filter is applied.
shares = shares[QFilter, ]
# Filtering the weight variable, if required.
weight = if (is.null(QPopulationWeight)) rep(1, length(u1)) else QPopulationWeight
weight = weight[QFilter]
# Computing shares for the total sample
shares = sweep(shares, 1, weight, &quot;*&quot;)
shares = as.matrix(apply(shares, 2, sum))
shares = 100 * prop.table(shares, 2)[1]
</pre>
<hr>
<h1><span style="color:#2b2a2f">Step 5: Make it pretty</span></h1>
<p>If you wish, you can make your choice simulator prettier. The R Outputs and the controls all have formatting options. In my example, I got our designer, Nat, to create the pretty background screen, which she did in Photoshop, and then added using <strong>Insert &gt;</strong> <strong>Image</strong>.</p>
<hr>
<h1><span style="color:#2b2a2f">Step 6: Add filters</span></h1>
<p>If you have stored the data as variable sets, you can quickly create filters. Note that the calculations will automatically update when the viewer selects the filters.</p>
<hr>
<h1><span style="color:#2b2a2f">Step 7: Share</span></h1>
<p>To share the dashboard, go to the Export tab in the ribbon (at the top of the screen), and click on the black triangle under the <strong>Web Page </strong>button. Next, check the option for <strong>Hide page navigation on exported page</strong> and then click <strong>Export…</strong> and follow the prompts.</p>
<p>Note, the URL for the choice simulator I am using in this example is <a href="https://app.displayr.com/Dashboard?id=21043f64-45d0-47af-9797-cd4180805849" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://app.displayr.com/Dashboard?id%3D21043f64-45d0-47af-9797-cd4180805849&amp;source=gmail&amp;ust=1509512084247000&amp;usg=AFQjCNG8GuJAKf_y739w5efSlsh-i_a_jw">https://app.displayr.com/<wbr>Dashboard?id=21043f64-45d0-<wbr>47af-9797-cd4180805849</a>. This URL is <em>public.</em> You cannot guess or find this link by web-searching for security reasons. If, however, you give the URL to someone, then they can access the document. Alternatively, if you have an annual Displayr account, you can instead go into <strong>Settings </strong>for the document (the cog at the top-right of the screen) and press <strong>Disable Public URL.</strong> This will limit access to only people who are set up as users for your organization. You can set up people as users in the company’s <strong>Settings</strong>,<strong> </strong>accessible by clicking on the cog at the top-right of the screen. If you don’t see these settings, contact support@displayr.com to buy a license.</p>
<hr>
<h1><span style="color:#2b2a2f">Worked example of a choice simulator</span></h1>
<p>You can see the <a href="https://app.displayr.com/Dashboard?id=21043f64-45d0-47af-9797-cd4180805849" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://app.displayr.com/Dashboard?id%3D21043f64-45d0-47af-9797-cd4180805849&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGA2X22Ab-diUPc2q3wPsBuDVhLCA">choice simulator in View Mode </a><a href="https://app.displayr.com/Dashboard?id=21043f64-45d0-47af-9797-cd4180805849" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://app.displayr.com/Dashboard?id%3D21043f64-45d0-47af-9797-cd4180805849&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGA2X22Ab-diUPc2q3wPsBuDVhLCA">here </a>(as an end-user will see it), or you can <a href="https://app.displayr.com/Try/Choice%20Simulator" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://app.displayr.com/Try/Choice%2520Simulator&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNHzofoYc1lPk6rebEni3E7uh3TAsQ">create your own choice simulator here</a> (first log into Displayr and then edit or modify a copy of the document used to create this post).</p>
<p class="m_5853171786120636607syndicated-attribution">
<hr>
<a href="https://www.r-bloggers.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNH_ajjCnl7-Yv8WG4oKA7UH4JXfrw">R-bloggers.com</a> offers <strong><a href="https://feedburner.google.com/fb/a/mailverify?uri=RBloggers" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://feedburner.google.com/fb/a/mailverify?uri%3DRBloggers&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNEm0pojsII1yNfd1aGcYxjNcut0mQ">daily e-mail updates</a></strong> about <a title="The R Project for Statistical Computing" href="https://www.r-project.org/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-project.org/&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNF-U_ht1ZDXxXapy4-LetU2d_Bg3g">R</a> news and <a title="R tutorials" href="https://www.r-bloggers.com/search/tutorial" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/tutorial&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNHH1PuV-6sXbs75AjiE-sEEHgFcNA">tutorials</a> on topics such as: <a title="Data science" href="https://www.r-bloggers.com/search/data%20science" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/data%2520science&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNEUbZ6VLDVk_S_1J4Q5QG8Pge7Tpg">Data science</a>, <a title="Big Data" href="https://www.r-bloggers.com/search/Big%20Data" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Big%2520Data&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNG3GGZKOvVtQViXcM9XrnmABbgqJg">Big Data, <a title="R jobs" href="https://www.r-users.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-users.com/&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGIwtR9GeK366huPYL-BEIaHOCieA">R jobs</a>, visualization (<a title="ggplot and ggplot2 tutorials" href="https://www.r-bloggers.com/search/ggplot2" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/ggplot2&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNEypPJiEGTO9j50_w2KUk-uB6VgmA">ggplot2</a>, <a title="Boxplots using lattice and ggplot2 tutorials" href="https://www.r-bloggers.com/search/boxplot" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/boxplot&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNEm9WDZ-dC1T6Vo_NWG7hgH9jk7Yw">Boxplots</a>, <a title="Maps and gis" href="https://www.r-bloggers.com/search/map" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/map&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNEUg0TiDFvvNRlov2JhrR82BYexbw">maps</a>, <a title="Animation in R" href="https://www.r-bloggers.com/search/animation" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/animation&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNFrybxMJ3iSgLFbwaodklVvgoMWdQ">animation</a>), programming (<a title="RStudio IDE for R" href="https://www.r-bloggers.com/search/RStudio" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/RStudio&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNHp4Q0bZF8mt_0f3y17bQAbm1G5vA">RStudio</a>, <a title="Sweave and literate programming" href="https://www.r-bloggers.com/search/sweave" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/sweave&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGN4WCumC72ZbQbaJiCf5ugym1_dQ">Sweave</a>, <a title="LaTeX in R" href="https://www.r-bloggers.com/search/LaTeX" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/LaTeX&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNEjBaRQ7wMGEraMKVfzyGsfY0Y9TQ">LaTeX</a>, <a title="SQL and databases" href="https://www.r-bloggers.com/search/SQL" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/SQL&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNH2_liv8Yp7RvN8t80uW-d4vSx_QQ">SQL</a>, <a title="Eclipse IDE for R" href="https://www.r-bloggers.com/search/eclipse" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/eclipse&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNHpv8-urNXtSEuJ427ussnRZNXJoA">Eclipse</a>, <a title="git and github, Version Control System" href="https://www.r-bloggers.com/search/git" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/git&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNF1MCq9RMdtHWW8QK3WkpCnQS9ZNg">git</a>, <a title="Large data in R using Hadoop" href="https://www.r-bloggers.com/search/hadoop" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/hadoop&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNH3tv8UG0XzR2OnwrWfQ51dsnzBZw">hadoop</a>, <a title="Web Scraping of google, facebook, yahoo, twitter and more using R" href="https://www.r-bloggers.com/search/Web+Scraping" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Web%2BScraping&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNHMeMHnNzr-pQgJ49uPEc13sw2hCw">Web Scraping</a>) statistics (<a title="Regressions and ANOVA analysis tutorials" href="https://www.r-bloggers.com/search/regression" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/regression&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNFTYVvmrr2hm1rdCeFfvpkV5u6EpA">regression</a>, <a title="principal component analysis tutorial" href="https://www.r-bloggers.com/search/PCA" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/PCA&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGwrchCRGn23UUdw_k31zEAhqgMFA">PCA</a>, <a title="Time series" href="https://www.r-bloggers.com/search/time+series" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/time%2Bseries&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNHPrOEBOdLiNiVnqCVi242XIsrElA">time series</a>, <a title="finance trading" href="https://www.r-bloggers.com/search/trading" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/trading&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGUFbx0MPlLAzffGLm1SiCS7haopg">trading</a>) and more...
</a></div></p><img src="https://ci3.googleusercontent.com/proxy/bt-2BH7jMHEyZeZuukSe90zOGORiAk7yH5dQokvM83D2UZwhjSrIAE2AkTRpTDKig-JL-RFiX4VNh9e-KYMad1kV0q3wQN5EZ703Ux7U-zNRNOMGakDWcuAhZq6Viok3fXY1gpWF2C8eSjd3D1LQ9bxQZfM=s0-d-e1-ft#http://feeds.feedburner.com/~r/RBloggers/~4/Gx7zkZQy55M?utm_source=feedburner&amp;utm_medium=email" height="1" width="1" alt=""><p>This posting includes an audio/video/photo media file: <a>Download Now</a>
</p>
</p></div>
</td>
</tr>
<tr>
<td style="margin-bottom:0;line-height:1.4em">
<p style="margin:1em 0 3px 0">
<a name="m_5853171786120636607_3" style="font-family:Arial,Helvetica,sans-serif;font-size:19px" href="http://feedproxy.google.com/~r/RBloggers/~3/qyKoh5qluNg/?utm_source=feedburner&amp;utm_medium=email" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://feedproxy.google.com/~r/RBloggers/~3/qyKoh5qluNg/?utm_source%3Dfeedburner%26utm_medium%3Demail&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGv4c7Bo9A7kXYk0H8pXxhEAP57hw">Understanding gender roles in movies with text mining</a>
</p>
<div class="m_5853171786120636607figure">
<img src="https://ci6.googleusercontent.com/proxy/ACI28yFCD4EXbZ1fNwDF9sTY1JNm1KLAfYwbFA1g88wZgYbeGjjXKTz7OddSeMW4bOvnIvFHUWdlRucjA6v98cvzEQ_TnE_K4Rhg893py4bGMuV01NhAmD7GLiuCsjOF17MMBaIXsTa4iss=s0-d-e1-ft#https://i2.wp.com/juliasilge.com/figs/2017-08-22-women-in-film/slider.gif?w=456&amp;ssl=1">
</div>
<p>I have a new <a href="https://pudding.cool/2017/08/screen-direction/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://pudding.cool/2017/08/screen-direction/&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNGExIZSf0L0mkdNCMoH2ZWWXa4Aig">visual essay up at The Pudding</a> today, using text mining to explore how women are portrayed in film.</p>
<div class="m_5853171786120636607figure">
<img src="https://ci5.googleusercontent.com/proxy/LeSk--YSkSzg_CY_RbyjJbLn0YoOHdyN0x4yaibATCRRmD3MB6zNb_r4bB7ZpTaXcK2Q6yMbPxMahiW2v1rewrt_YUwHCFUIJzIVTCyTaUOkcrPcNNS2YPeo2kXxaSSG6ARN4mZecnRjDNw=s0-d-e1-ft#https://i2.wp.com/juliasilge.com/figs/2017-08-22-women-in-film/og-img.png?w=456&amp;ssl=1">
</div>
<p>The R code behind this analysis in <a href="https://github.com/juliasilge/women-in-film" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://github.com/juliasilge/women-in-film&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNHPjgtS0QH0eY43n1zGEIkv4hmMwQ">publicly available on GitHub</a>.</p>
<div class="m_5853171786120636607figure">
<img src="https://ci5.googleusercontent.com/proxy/37qmkkBWIfzigww9Aj2soJiL-tpclbfK68cOdwse-5WbAixRMBTFj8Zj27-Qwfu5s8jZMdAUL7Udu8TW-NQCrrPT3zZ8tDRViqJa-ME7vCYCJs1CRK5NvRtP3PLTarwRduk-MyYQ540F=s0-d-e1-ft#https://i2.wp.com/juliasilge.com/figs/2017-08-22-women-in-film/wall.gif?w=456&amp;ssl=1">
</div>
<p>I was so glad to work with the talented <a href="https://twitter.com/codenberg" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://twitter.com/codenberg&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNG3NPawumk5J79_HrrmUj3QS9WGjQ">Russell Goldenberg</a> and <a href="https://twitter.com/proquesasker" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://twitter.com/proquesasker&amp;source=gmail&amp;ust=1509512084248000&amp;usg=AFQjCNFsQJ_W_m44YeXceEYNOPuzhL8siA">Amber Thomas</a> on this project, and many thanks to <a href="https://twitter.com/matthew_daniels" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://twitter.com/matthew_daniels&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNGu473CoiqHBBHSRlfcN_QmgVvphw">Matt Daniels</a> for inviting me to contribute to <a href="https://pudding.cool/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://pudding.cool/&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFpjBAGstsk8oVxmIha1flYvBumgw">The Pudding</a>. I’ve been a big fan of their work for a long time!</p>
<p class="m_5853171786120636607syndicated-attribution">
<hr>
<a href="https://www.r-bloggers.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNHBQXaVPY7HdYbf-A4tOZVA-ETtYQ">R-bloggers.com</a> offers <strong><a href="https://feedburner.google.com/fb/a/mailverify?uri=RBloggers" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://feedburner.google.com/fb/a/mailverify?uri%3DRBloggers&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFx2rojl-C3tVszx7JytY471tCfCA">daily e-mail updates</a></strong> about <a title="The R Project for Statistical Computing" href="https://www.r-project.org/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-project.org/&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNGMtqWjCiiuB-Dbw6_CRf7iT6C4eQ">R</a> news and <a title="R tutorials" href="https://www.r-bloggers.com/search/tutorial" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/tutorial&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNGJjX6OvIaHRDGEIC7VEFmap6iOJw">tutorials</a> on topics such as: <a title="Data science" href="https://www.r-bloggers.com/search/data%20science" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/data%2520science&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNEuNewZaLU-xCfMAQI8P4QpwtEw7A">Data science</a>, <a title="Big Data" href="https://www.r-bloggers.com/search/Big%20Data" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Big%2520Data&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFSrw8I9S19xzC-CpOH2AhoTci7tg">Big Data, <a title="R jobs" href="https://www.r-users.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-users.com/&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFGXs86zLUKLb8FmonoTcjg0HNu-A">R jobs</a>, visualization (<a title="ggplot and ggplot2 tutorials" href="https://www.r-bloggers.com/search/ggplot2" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/ggplot2&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNGLDmKYyXKtCwlKROtCM84U1dASXw">ggplot2</a>, <a title="Boxplots using lattice and ggplot2 tutorials" href="https://www.r-bloggers.com/search/boxplot" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/boxplot&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNGyfLrrfpdthi5hZgZKNcUjAvuNcQ">Boxplots</a>, <a title="Maps and gis" href="https://www.r-bloggers.com/search/map" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/map&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNEJMRT0lSTS0erORWnshxdwF2ZS5Q">maps</a>, <a title="Animation in R" href="https://www.r-bloggers.com/search/animation" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/animation&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFTxucndF5m_H1_xfrz182lhGjmVQ">animation</a>), programming (<a title="RStudio IDE for R" href="https://www.r-bloggers.com/search/RStudio" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/RStudio&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNHmWfrM6FuD4LOmGxkl5LicAVEq1Q">RStudio</a>, <a title="Sweave and literate programming" href="https://www.r-bloggers.com/search/sweave" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/sweave&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNErQBxxMX5a98AKoCSyHS-vWpqJBQ">Sweave</a>, <a title="LaTeX in R" href="https://www.r-bloggers.com/search/LaTeX" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/LaTeX&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFSO2-P6p8_q5aqn6SeWsDPUPTBoQ">LaTeX</a>, <a title="SQL and databases" href="https://www.r-bloggers.com/search/SQL" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/SQL&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNExlOlpMeO35TWtVg_F4khY-VGrOw">SQL</a>, <a title="Eclipse IDE for R" href="https://www.r-bloggers.com/search/eclipse" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/eclipse&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFSkltyuQ9BNBGMBxBZZCaqx3RvWg">Eclipse</a>, <a title="git and github, Version Control System" href="https://www.r-bloggers.com/search/git" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/git&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNGVyiBY_zuOwb86sd4zA2bzNB5k8Q">git</a>, <a title="Large data in R using Hadoop" href="https://www.r-bloggers.com/search/hadoop" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/hadoop&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNGiI6gs_Im8htxFxDg5zHXpTcilLw">hadoop</a>, <a title="Web Scraping of google, facebook, yahoo, twitter and more using R" href="https://www.r-bloggers.com/search/Web+Scraping" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Web%2BScraping&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNE4dri8SXMEEH4J45ldsxgu4ZHLGw">Web Scraping</a>) statistics (<a title="Regressions and ANOVA analysis tutorials" href="https://www.r-bloggers.com/search/regression" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/regression&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNH-cLq8T2QYzG6_dhlPkXkUXT9z0w">regression</a>, <a title="principal component analysis tutorial" href="https://www.r-bloggers.com/search/PCA" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/PCA&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNEqFOTf1spgpOApBcvQA4aXb7iHpA">PCA</a>, <a title="Time series" href="https://www.r-bloggers.com/search/time+series" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/time%2Bseries&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNH3HQQ5NjTbs2sEkY4X28RcfnanRA">time series</a>, <a title="finance trading" href="https://www.r-bloggers.com/search/trading" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/trading&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNEf1bWw7UxbtV_P8A4cQh15jDNHfA">trading</a>) and more...
</a></div></p><img src="https://ci4.googleusercontent.com/proxy/Rzi3OZ8j9YV0dcpwRZWWLPR6X_pBDL9F99mWtmpcyaIqSVSGR8aFKy3bAkfXNzYSg-kUcYgzEi1-D1vi3rcOPoCVWE2cUYrluK-vPoIxAxq219AnTt0Nv0xtX05zgOHphHQaFs-g8H0kW_eo-WyTr9OY6C0=s0-d-e1-ft#http://feeds.feedburner.com/~r/RBloggers/~4/qyKoh5qluNg?utm_source=feedburner&amp;utm_medium=email" height="1" width="1" alt=""><p>This posting includes an audio/video/photo media file: <a>Download Now</a>
</p>
</div>
</td>
</tr>
<tr>
<td style="margin-bottom:0;line-height:1.4em">
<p style="margin:1em 0 3px 0">
<a name="m_5853171786120636607_4" style="font-family:Arial,Helvetica,sans-serif;font-size:19px" href="http://feedproxy.google.com/~r/RBloggers/~3/ugRsFMD1bwc/?utm_source=feedburner&amp;utm_medium=email" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://feedproxy.google.com/~r/RBloggers/~3/ugRsFMD1bwc/?utm_source%3Dfeedburner%26utm_medium%3Demail&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNH66nSIKoVcU92IASUpyCR-zAaVhg">Tidyer BLS data with the blscarpeR package</a>
</p>
<p>The recent release of the <a href="https://github.com/keberwein/blscrapeR" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://github.com/keberwein/blscrapeR&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFTozUHXbxI1vsnnBuoNigRvbDqiw">blscrapeR</a> package brings the “tidyverse” into the fold. Inspired by my recent collaboration with Kyle Walker on his excellent <a href="https://github.com/walkerke/tidycensus" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://github.com/walkerke/tidycensus&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNHdXf1LB4Vb2WA78uIBpHLmDSbu_Q">tidycensus</a> package, blscrapeR has been optimized for use within the tidyverse as of the current version 3.0.0.</p>
<h2 id="m_5853171786120636607new-things-youll-notice-right-away-include">New things you’ll notice right away include:</h2>
<ul>
<li>
<p>All data now returned as tibbles.</p>
</li>
<li>
<p>dplyr and purrr are now imported packages, along with magrittr and ggplot, which were imported from the start.</p>
</li>
<li>
<p>No need to call any packages other than tidyverse and blscrapeR.</p>
</li>
</ul>
<h2 id="m_5853171786120636607major-internal-changes">Major internal changes</h2>
<ul>
<li>
<p>Switched from base R to dplyr in instances where performance could be increased.</p>
</li>
<li>
<p>Standard apply functions replaced with purrr <code class="m_5853171786120636607highlighter-rouge">map()</code> functions where performance could be increased.</p>
</li>
</ul>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">install.packages</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;blscrapeR&quot;</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<h2 id="m_5853171786120636607the-bls-more-than-unemployment">The BLS: More than Unemployment</h2>
<p>The American Time Use Survey is one of the BLS’ more interesting data sets. Below is an API query that compares the time Americans spend watching TV on a daily basis compared to the time spent socializing and communicating.</p>
<p>It should be noted, some familiarity with BLS series id numbers is required here. The <a href="https://beta.bls.gov/dataQuery/search" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://beta.bls.gov/dataQuery/search&amp;source=gmail&amp;ust=1509512084249000&amp;usg=AFQjCNFAc0z35l-NfvPOPHnoZsgB1wRQ3w">BLS Data Finder</a> is a nice tool to find series id numbers.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">blscrapeR</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tidyverse</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">tbl</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">bls_api</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;TUU10101AA01014236&quot;</span><span class="m_5853171786120636607p"><wbr>,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;TUU10101AA01013951&quot;</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%&gt;%</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">spread</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">seriesID</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%&gt;%</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">dateCast</span><span class="m_5853171786120636607p">()</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%&gt;%</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">rename</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">watching_tv</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">TUU10101AA01014236</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">socializing_communicating</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">TUU10101AA01013951</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">tbl</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## # A tibble: 3 x 7
##    year    period periodName footnotes socializing_communicating watching_tv       date
## * <u></u>    <u></u>     <u></u>    <u></u>                     <u></u>       <u></u>     <u></u>
## 1  2014 <u></u>  <u></u> <u></u>                      0.71        2.82 2014-01-01
## 2  2015 <u></u>  <u></u> <u></u>                      0.68        2.78 2015-01-01
## 3  2016 <u></u>  <u></u> <u></u>                      0.65        2.73 2016-01-01</code></pre>
</figure>
<h2 id="m_5853171786120636607unemployment-rates">Unemployment Rates</h2>
<p>The main attraction of the BLS are the monthly employment and unemployment data. Below is an API query and plot of three of the major BLS unemployment rates.</p>
<ul>
<li>
<p>U-3: The “official unemployment rate.” Total unemployed, as a percent of the civilian labor force.</p>
</li>
<li>
<p>U-5: Total unemployed, plus discouraged workers, plus all other marginally attached workers, as a percent of the civilian labor force plus all marginally attached workers.</p>
</li>
<li>
<p>U-6: Total unemployed, plus all marginally attached workers, plus total employed part time for economic reasons, as a percent of the civilian labor force plus all marginally attached workers.</p>
</li>
</ul>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">blscrapeR</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tidyverse</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">tbl</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">bls_api</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;LNS14000000&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;LNS13327708&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;LNS13327709&quot;</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%&gt;%</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">spread</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">seriesID</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%&gt;%</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">dateCast</span><span class="m_5853171786120636607p">()</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%&gt;%</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">rename</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">u</span><span class="m_5853171786120636607m">3</span><span class="m_5853171786120636607err">_</span><span class="m_5853171786120636607n">unemployment</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">LNS14000000</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">u</span><span class="m_5853171786120636607m">5</span><span class="m_5853171786120636607err">_</span><span class="m_5853171786120636607n">unemployment</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">LNS13327708</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">u</span><span class="m_5853171786120636607m">6</span><span class="m_5853171786120636607err">_</span><span class="m_5853171786120636607n">unemployment</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">LNS13327709</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">


</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">tbl</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> 
    </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">u</span><span class="m_5853171786120636607m">3</span><span class="m_5853171786120636607err">_</span><span class="m_5853171786120636607n">unemployment</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;U-3 Unemployment&quot;</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">u</span><span class="m_5853171786120636607m">5</span><span class="m_5853171786120636607err">_</span><span class="m_5853171786120636607n">unemployment</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;U-5 Unemployment&quot;</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> 
    </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">u</span><span class="m_5853171786120636607m">6</span><span class="m_5853171786120636607err">_</span><span class="m_5853171786120636607n">unemployment</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;U-6 Unemployment&quot;</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> 
    </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Monthly Unemployment Rates&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ylab</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;value&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
    </span><span class="m_5853171786120636607n">theme</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">legend.position</span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607s2">&quot;top&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">plot.title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_text</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">hjust</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.5</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span></code></pre>
</figure>
<p><img src="https://ci4.googleusercontent.com/proxy/9gsOnSTHkAZL8Tt7vKUd3oZlbbXoIXYf0bTptxZOpGoQfMz2I8tV_AsWZvZKA24HYiqZDLhu7ExblYGdWDt0OcGZZ-xjPPR9C41fTxViGq8pxPTXtqosnt_tg6O-IpHBRUmLdowQWg=s0-d-e1-ft#https://i2.wp.com/www.datascienceriot.com/assets/Rfig/unnamed-chunk-4-1.png?w=456" alt="plot of chunk unnamed-chunk-4"></p>
<p>For more information and examples, please see the <a href="https://github.com/keberwein/blscrapeR/tree/master/vignettes" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://github.com/keberwein/blscrapeR/tree/master/vignettes&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNH-IdVP-HHze1CcXQEZa_redj3tZw">package vignettes</a>.</p>
<p><img src="https://ci6.googleusercontent.com/proxy/wRvo47-mQYUUzHSAeEDbxjjrVwYE9FvzOc02LryRCxasT79FcAQVkBE3slRjtQL2AG40nRwmc6yKl_zEYb-0VDyIYZXKoUvbXGTEZqBsy6E93NC53Ujt6S9_-JleXNTP6QNp6XpwAmpfGSOqGQrdyS5VEbP2NR99hh8w0w=s0-d-e1-ft#https://i0.wp.com/github.com/keberwein/blscrapeR/blob/master/man/figures/blscrapeR_hex.png?w=456&amp;ssl=1" alt=""></p>
<p class="m_5853171786120636607syndicated-attribution">
<hr>
<a href="https://www.r-bloggers.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNEz3KCkNPCXz5FWGkqQTNhNLzLNAw">R-bloggers.com</a> offers <strong><a href="https://feedburner.google.com/fb/a/mailverify?uri=RBloggers" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://feedburner.google.com/fb/a/mailverify?uri%3DRBloggers&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNE-B8s1Q9W0rMWtPY_kISD-fQwRsg">daily e-mail updates</a></strong> about <a title="The R Project for Statistical Computing" href="https://www.r-project.org/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-project.org/&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNGarQBq-l-4S-ZrfbcAkXSyi-rAsQ">R</a> news and <a title="R tutorials" href="https://www.r-bloggers.com/search/tutorial" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/tutorial&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNHDoof1g3inWTnXPCKJ8EcLO9RF6w">tutorials</a> on topics such as: <a title="Data science" href="https://www.r-bloggers.com/search/data%20science" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/data%2520science&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNEQw9u3q8dfblDuevpxUFnJ_Hj5Ow">Data science</a>, <a title="Big Data" href="https://www.r-bloggers.com/search/Big%20Data" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Big%2520Data&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFU_vdqqQE3GNYxB0nQdmuOaThzIQ">Big Data, <a title="R jobs" href="https://www.r-users.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-users.com/&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNHgzEMaVQm6K5p8nR9rD3aw9w38zg">R jobs</a>, visualization (<a title="ggplot and ggplot2 tutorials" href="https://www.r-bloggers.com/search/ggplot2" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/ggplot2&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNEdcHi9UzjOlhw96QUxZ-CM1BdspQ">ggplot2</a>, <a title="Boxplots using lattice and ggplot2 tutorials" href="https://www.r-bloggers.com/search/boxplot" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/boxplot&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNHsjbCqpXTpbeXHdVYSgkq4RgK60Q">Boxplots</a>, <a title="Maps and gis" href="https://www.r-bloggers.com/search/map" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/map&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFCnAbLoaSaf89LAzNObe9aGb_74Q">maps</a>, <a title="Animation in R" href="https://www.r-bloggers.com/search/animation" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/animation&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFtn2FfUnO0cEAtXQnrydJcOaOLrw">animation</a>), programming (<a title="RStudio IDE for R" href="https://www.r-bloggers.com/search/RStudio" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/RStudio&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNHY0h_apHzil45BGXCp_7sqfk_LCg">RStudio</a>, <a title="Sweave and literate programming" href="https://www.r-bloggers.com/search/sweave" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/sweave&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNGMDD_FUhEpDBJEYXSa0LQDoBTlLQ">Sweave</a>, <a title="LaTeX in R" href="https://www.r-bloggers.com/search/LaTeX" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/LaTeX&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFyNBRCuWxbO4rTscz89KD6p0CdBg">LaTeX</a>, <a title="SQL and databases" href="https://www.r-bloggers.com/search/SQL" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/SQL&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNHcWj4-df9YJWO6MkNRpcL9JZJIwg">SQL</a>, <a title="Eclipse IDE for R" href="https://www.r-bloggers.com/search/eclipse" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/eclipse&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNEq60WA7fwBEa6snp1CK8O6Yb0O0w">Eclipse</a>, <a title="git and github, Version Control System" href="https://www.r-bloggers.com/search/git" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/git&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNGFrK014rj18plvwLq2Evsj5U5K1w">git</a>, <a title="Large data in R using Hadoop" href="https://www.r-bloggers.com/search/hadoop" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/hadoop&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNGW7sfcGQ95NS4HmkEPMHJpB2cVuw">hadoop</a>, <a title="Web Scraping of google, facebook, yahoo, twitter and more using R" href="https://www.r-bloggers.com/search/Web+Scraping" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Web%2BScraping&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNGlEGdda_MbF5IuJnixenNkJsdrMw">Web Scraping</a>) statistics (<a title="Regressions and ANOVA analysis tutorials" href="https://www.r-bloggers.com/search/regression" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/regression&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNEVa3aoqXbOm09wdj06mP6bf8eOoA">regression</a>, <a title="principal component analysis tutorial" href="https://www.r-bloggers.com/search/PCA" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/PCA&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFH8RktGAEfiFAhdkLialGQE-ZMkw">PCA</a>, <a title="Time series" href="https://www.r-bloggers.com/search/time+series" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/time%2Bseries&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFsVTpYlCxAIw9deygaGqEhVAT6fg">time series</a>, <a title="finance trading" href="https://www.r-bloggers.com/search/trading" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/trading&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFtg31RMfkjETfK30yLcjBZlJ0QUQ">trading</a>) and more...
</a></div></p><img src="https://ci6.googleusercontent.com/proxy/eQ2LKc3AFk779EUpOJLrawCugzkcMfAq_23BtOOKyd7Dqbnbu3GBUtlywNLUSMIJI5FsRyrfCpyIuMSz39vCoDYAQTRcsicDMltlhz0-9PnyfnvLEmGQRpN3TIL8iXhW9qOcVxh0QQilzM77i6fufKKb068=s0-d-e1-ft#http://feeds.feedburner.com/~r/RBloggers/~4/ugRsFMD1bwc?utm_source=feedburner&amp;utm_medium=email" height="1" width="1" alt=""><p>This posting includes an audio/video/photo media file: <a>Download Now</a>
</p>
</div>
</td>
</tr>
<tr>
<td style="margin-bottom:0;line-height:1.4em">
<p style="margin:1em 0 3px 0">
<a name="m_5853171786120636607_5" style="font-family:Arial,Helvetica,sans-serif;font-size:19px" href="http://feedproxy.google.com/~r/RBloggers/~3/9wO5mygDvSg/?utm_source=feedburner&amp;utm_medium=email" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://feedproxy.google.com/~r/RBloggers/~3/9wO5mygDvSg/?utm_source%3Dfeedburner%26utm_medium%3Demail&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFyVzi08BSahqYBcd1D2z1H19uEEg">Learning things we already know about stocks</a>
</p>

<p>This example groups stocks together in a network that highlights associations within and between the groups using only historical price data. The result is far from ground-breaking; you can already guess the output. For the most part, the stocks get grouped together into pretty obvious business sectors.</p>
<p>Despite the obvious result, the process of teasing out latent groupings from historic price data is interesting. That’s the focus of this example. A central idea of the approach taken here comes from the great paper of Ledoit and Wolf, “Honey, I Shrunk the Sample Covariance Matrix” (<a href="http://www.ledoit.net/honey.pdf" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://www.ledoit.net/honey.pdf&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNFBCVxCrJP4iTAH4ylpwuqpbIpexw">http://www.ledoit.net/honey.<wbr>pdf</a>). This example employs an alternative approach based on a matrix eigenvalue decomposition, but it’s the same general idea.</p>
<p>This note follows an informal, how-to format. Rather than focus on mathematical analysis, which is well-detailed in the references, I try to spell out the hows and whys: how to do things step by step (using R), and a somewhat non-rigorous rationale for each step that’s hopefully at least convincing and intuitive.</p>
<p>For emphasis, allow me to restate the first sentence as an objective:</p>
<ul>
<li>Group stocks together in a network that highlights associations within and between the groups using only historical price data</li>
</ul>
<p>That’s what the rest of this example will do, hopefully illuminating some key ideas about regularization along the way.</p>
<div id="m_5853171786120636607software-used-in-the-example" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Software used in the example</h1>
<p>The example uses R, of course, and the following R packages, all available on CRAN (some of the packages themselves have dependencies):</p>
<ul>
<li><code>quantmod</code> (at least version 0.4-10)</li>
<li><code>igraph</code> (at least version 1.1.2)</li>
<li><code>threejs</code> (at least version 0.3.1)</li>
</ul>
</div>
<div id="m_5853171786120636607getting-data" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Getting data</h1>
<p>NOTE: You can skip ahead to the <a href="https://rviews.rstudio.com/2017/08/22/stocks/#correlation" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://rviews.rstudio.com/2017/08/22/stocks/%23correlation&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNHv3UGlftPjJEWIDrSkebG8Z9BEjw">Sample correlation</a> section by simply downloading a sample copy of processed log(return) data as follows:</p>
<pre class="m_5853171786120636607r"><code>library(quantmod)
load(url(&quot;http://illposed.net/<wbr>logreturns.rdata&quot;))</code></pre>
<p>Otherwise, follow the next two sections to download the raw stock daily price data and process those data into log(returns).</p>
<div id="m_5853171786120636607download-daily-closing-price-data-from-google-finance" class="m_5853171786120636607section m_5853171786120636607level2">
<h2>Download daily closing price data from Google Finance</h2>
<p>The <code>quantmod</code> package (Ulrich and Ryan, <a href="http://www.quantmod.com/" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://www.quantmod.com/&amp;source=gmail&amp;ust=1509512084250000&amp;usg=AFQjCNEqxOG1CmO_QPJbicpXYVUTJJ9oug">http://www.quantmod.com/</a>) makes it ridiculously easy to download (and visualize) financial time series data. The following code uses <code>quantmod</code> to download daily stock price data for about 100 companies with the largest market capitalizations listed on the Standard &amp; Poor’s 500 index at the time of this writing. The code downloads daily closing prices from 2012 until the present. Modify the code to experiment with different time periods or stocks as desired!</p>
<p>Because stock symbol names may change and companies my come and go, it’s possible that some of the data for some time periods are not available. The <code>tryCatch()</code> block in the code checks for a download error and flags problems by returning <code>NA</code>, later removed from the result. The upshot is that the output number of columns of stock price time series may be smaller than the input list of stock symbols.</p>
<p>The output of the following code is an xts time series matrix of stock prices called <code>prices</code>, whose rows correspond to days and columns to stock symbols.</p>
<pre class="m_5853171786120636607r"><code>library(quantmod)
from=&quot;2012-05-17&quot;
sym = c(&quot;AAPL&quot;, &quot;ABBV&quot;, &quot;ABT&quot;, &quot;ACN&quot;, &quot;AGN&quot;, &quot;AIG&quot;, &quot;ALL&quot;, &quot;AMGN&quot;, &quot;AMZN&quot;, &quot;AXP&quot;,
        &quot;BA&quot;, &quot;BAC&quot;, &quot;BIIB&quot;, &quot;BK&quot;, &quot;BLK&quot;, &quot;BMY&quot;, &quot;BRK.B&quot;, &quot;C&quot;, &quot;CAT&quot;, &quot;CELG&quot;, &quot;CL&quot;,
        &quot;CMCSA&quot;, &quot;COF&quot;, &quot;COP&quot;, &quot;COST&quot;, &quot;CSCO&quot;, &quot;CVS&quot;, &quot;CVX&quot;, &quot;DD&quot;, &quot;DHR&quot;, &quot;DIS&quot;, &quot;DOW&quot;,
        &quot;DUK&quot;, &quot;EMR&quot;, &quot;EXC&quot;, &quot;F&quot;, &quot;FB&quot;, &quot;FDX&quot;, &quot;FOX&quot;, &quot;FOXA&quot;, &quot;GD&quot;, &quot;GE&quot;, &quot;GILD&quot;, &quot;GM&quot;,
        &quot;GOOG&quot;, &quot;GOOGL&quot;, &quot;GS&quot;, &quot;HAL&quot;, &quot;HD&quot;, &quot;HON&quot;, &quot;IBM&quot;, &quot;INTC&quot;, &quot;JNJ&quot;, &quot;JPM&quot;, &quot;KHC&quot;,
        &quot;KMI&quot;, &quot;KO&quot;, &quot;LLY&quot;, &quot;LMT&quot;, &quot;LOW&quot;, &quot;MA&quot;, &quot;MCD&quot;, &quot;MDLZ&quot;, &quot;MDT&quot;, &quot;MET&quot;, &quot;MMM&quot;,
        &quot;MO&quot;, &quot;MON&quot;, &quot;MRK&quot;, &quot;MS&quot;, &quot;MSFT&quot;, &quot;NEE&quot;, &quot;NKE&quot;, &quot;ORCL&quot;, &quot;OXY&quot;, &quot;PCLN&quot;, &quot;PEP&quot;,
        &quot;PFE&quot;, &quot;PG&quot;, &quot;PM&quot;, &quot;PYPL&quot;, &quot;QCOM&quot;, &quot;RTN&quot;, &quot;SBUX&quot;, &quot;SLB&quot;, &quot;SO&quot;, &quot;SPG&quot;, &quot;T&quot;,
        &quot;TGT&quot;, &quot;TWX&quot;, &quot;TXN&quot;, &quot;UNH&quot;, &quot;UNP&quot;, &quot;UPS&quot;, &quot;USB&quot;, &quot;UTX&quot;, &quot;V&quot;, &quot;VZ&quot;, &quot;WBA&quot;,
        &quot;WFC&quot;, &quot;WMT&quot;, &quot;XOM&quot;)

prices = Map(function(n)
             {
               print(n)
               tryCatch(getSymbols(n, src=&quot;google&quot;, env=NULL, from=from)[, 4], error = function(e) NA)
             }, sym)
N = length(prices)
# identify symbols returning valid data
i = ! unlist(Map(function(i) is.na(prices[i]), seq(N)))
# combine returned prices list into a matrix, one column for each symbol with valid data
prices = Reduce(cbind, prices[i])
colnames(prices) = sym[i]</code></pre>
</div>
<div id="m_5853171786120636607clean-up-and-transform-data" class="m_5853171786120636607section m_5853171786120636607level2">
<h2>Clean up and transform data</h2>
<p>Not every stock symbol may have prices available for every day. Trading can be suspended for some reason, companies get acquired or go private, new companies form, etc.</p>
<p>Let’s fill in missing values going forward in time using the last reported price (piecewise constant interpolation) – a reasonable approach for stock price time series. After that, if there are still missing values, just remove those symbols that contain them, possibly further reducing the universe of stock symbols we’re working with.</p>
<pre class="m_5853171786120636607r"><code>for(j in 1:ncol(prices)) prices[, j] = na.locf(prices[, j])       # fill in
prices = prices[, apply(prices, 2, function(x) ! any(is.na(x)))]  # omit stocks with missing data</code></pre>
<p>Now that we have a universe of stocks with valid price data, convert those prices to log(returns) for the remaining analysis (by returns I mean simply the ratio of prices relative to the first price).</p>
<p>Why log(returns) instead of prices?</p>
<p>The log(returns) are closer to normally distributed than prices especially in the long run. Pat Burns wrote a note about this (with a Tom Waits soundtrack): <a href="http://www.portfolioprobe.com/2012/01/23/the-distribution-of-financial-returns-made-simple/" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://www.portfolioprobe.com/2012/01/23/the-distribution-of-financial-returns-made-simple/&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNGq_QgvglAGPNmu3Ov9XcJzETVHFQ">http://www.portfolioprobe.com/<wbr>2012/01/23/the-distribution-<wbr>of-financial-returns-made-<wbr>simple/</a>.</p>
<p>But why care about getting data closer to normally distributed?</p>
<p>That turns out to be important to us because later we’ll use a technique called partial correlation. That technique generally works better for normally distributed data than otherwise, see for example a nice technical discussion about this by Baba, Shibata, and Sibuya here: <a href="https://doi.org/10.1111%2Fj.1467-842X.2004.00360.x" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://doi.org/10.1111%252Fj.1467-842X.2004.00360.x&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNFtKWhhuoJjdRW2R-ZUAa_ZqzSsqA">https://doi.org/10.1111%2Fj.<wbr>1467-842X.2004.00360.x</a></p>
<p>The following simple code converts our <code>prices</code> matrix into a matrix of log(returns):</p>
<pre class="m_5853171786120636607r"><code>log_returns = apply(prices, 2, function(x) diff(log(x)))</code></pre>
</div>
</div>
<div id="m_5853171786120636607sample-correlation-matrix" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Sample correlation matrix</h1>
<p>It’s easy to convert the downloaded log(returns) data into a Pearson’s sample correlation matrix <code>X</code>:</p>
<pre class="m_5853171786120636607r"><code>X = cor(log_returns)</code></pre>
<p>The (i, j)th entry of the sample correlation matrix <code>X</code> above is a measurement of the degree of linear dependence between the log(return) series for the stocks in columns i and j.</p>
<p>There exist at least two issues that can lead to serious problems with the interpretation of the sample correlation values:</p>
<ol style="list-style-type:decimal">
<li>As Ledoit and Wolf point out, it’s well known that empirical correlation estimates may contain lots of error.</li>
<li>Correlation estimates between two stock log(return) series can be misleading for many reasons, including spurious correlation or existence of confounding variables related to both series (<a href="http://www.tylervigen.com/spurious-correlations" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://www.tylervigen.com/spurious-correlations&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNEkoLHlyNO-vPiNm7T7PQjHNOmpOw">http://www.tylervigen.com/<wbr>spurious-correlations</a>).</li>
</ol>
<p>A <a href="http://www.nobelprize.org/nobel_prizes/economic-sciences/laureates/2003/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://www.nobelprize.org/nobel_prizes/economic-sciences/laureates/2003/&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNGRlsFTUWrsZqznzttBjuja-6B06A">Nobel-prize winning</a> approach to dealing with the second problem considers cointegration between series instead of correlation; see for example notes by Eric Zivot (<a href="https://faculty.washington.edu/ezivot/econ584/notes/cointegrationslides.pdf" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://faculty.washington.edu/ezivot/econ584/notes/cointegrationslides.pdf&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNHIbEqMX0y7c_CgbK0gdG0t9MasRQ">https://faculty.washington.<wbr>edu/ezivot/econ584/notes/<wbr>cointegrationslides.pdf</a>), Bernhard Pfaff’s lovely book “Analysis of Integrated and Cointegrated Time Series with R” (<a href="http://www.springer.com/us/book/9780387759661" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://www.springer.com/us/book/9780387759661&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNG2DrcvpC02ma9v8LyARyZpb7JAEQ">http://www.springer.com/us/<wbr>book/9780387759661</a>), or Wikipedia (<a href="https://en.wikipedia.org/wiki/Cointegration" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Cointegration&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNHUMV3foRPhvYOcWfaoP7aYwDoWjQ">https://en.wikipedia.org/<wbr>wiki/Cointegration</a>). (I also have some weird technical notes on the numerics of cointegration at <a href="http://illposed.net/cointegration.html" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://illposed.net/cointegration.html&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNExXkpDwriPJn_llKrtLQCwq_je4w">http://illposed.net/<wbr>cointegration.html</a>.)</p>
<p>Cointegration is a wonderful but fairly technical topic. Instead, let’s try a simpler approach.</p>
<p>We can try to address issue 2 above by controlling for confounding variables, at least partially. One approach considers <em>partial correlation</em> instead of correlation (see for example the nice description in Wikipedia <a href="https://en.wikipedia.org/wiki/Partial_correlation" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Partial_correlation&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNFodiNAWSN5Y54F3HUpNVt9cPKFiw">https://en.wikipedia.org/wiki/<wbr>Partial_correlation</a>). That approach works best in practice with approximately normal data – one reason for the switch to log(returns) instead of prices. We will treat the entries of the precision matrix as measures of association in a network of stocks below.</p>
<p>It’s worth stating that our simple approach basically treats the log(returns) series as a bunch of vectors and not so much bona fide time series, and can’t handle as many pathologies that might occur as well as cointegration can. But as we will see, this simple technique is still pretty effective at finding structure in our data. (And, indeed, related methods as discussed by Ledoit and Wolf and elsewhere are widely used in portfolio and risk analyses in practice.)</p>
<p>The partial correlation coefficients between all stock log(returns) series are the entries of the inverse of the sample correlation matrix (<a href="https://www.statlect.com/glossary/precision-matrix" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.statlect.com/glossary/precision-matrix&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNFvCGkwJ2XBYD86FIX8LXOvLDTgpA">https://www.statlect.com/<wbr>glossary/precision-matrix</a>).</p>
<p>Market trading of our universe of companies, with myriad known and unknown associations between them and the larger economy, produced the stock prices we downloaded. Our objective is a kind of inverse problem: given a bunch of historical stock prices, produce a network of associations.</p>
<p>You may recall from some long ago class that, numerically speaking, inverting matrices is generally a bad idea. Even worse, issue 1 above says that our estimated correlation coefficients contain error (noise). Even a tiny amount noise can be hugely amplified if we invert the matrix. That’s because, as we will soon see, the sample correlation matrix contains tiny eigenvalues, and matrix inversion effectively divides the noise by those tiny values. Simply stated, dividing by a tiny number returns a big number; that is, matrix inversion tends to blow the noise up. This is a fundamental issue (in a sense, <em>the</em> fundamental issue) common to many inverse problems.</p>
<p>Ledoit and Wolf’s sensible answer to reducing the influence of noise is <em>regularization</em>. Regularization replaces models with <em>different, but related</em>, models designed to reduce the influence of noise on their output. LW use a form of regularization related to ridge regression (a.k.a., Tikhonov regularization) with a peculiar regularization operator based on a highly structured estimate of the covariance. We will use a simpler kind of regularization based on an eigenvalue decomposition of the sample correlation matrix <code>X</code>.</p>
</div>
<div id="m_5853171786120636607regularization" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Regularization</h1>
<p>Here is an eigenvalue decomposition of the sample correlation matrix:</p>
<pre class="m_5853171786120636607r"><code>L = eigen(X, symmetric=TRUE)</code></pre>
<p>Note that R’s <code>eigen()</code> function takes care to return the (real-valued) eigenvalues of a symmetric matrix in decreasing order for us. (Technically, the correlation matrix is symmetric positive semi-definite, and will have only non-negative real eigenvalues.)</p>
<p>Each eigenvector represents an orthogonal projection of the sample correlation matrix into a line (a 1-d shadow of the data). The first two eigenvectors define a projection of the sample correlation matrix into a plane (2-d), and so on. The eigenvalues estimate the proportion of information (or variability, if you prefer) from the original sample correlation matrix contained in each eigenvector. Because the eigenvectors are orthogonal, these measurements of projected information are additive.</p>
<p>Here is a plot of all the sample correlation matrix eigenvalues (along with a vertical line that will be explained in a moment):</p>
<pre class="m_5853171786120636607r"><code>plot(L$values, ylab=&quot;eigenvalues&quot;)
abline(v=10)</code></pre>
<p><img src="https://ci5.googleusercontent.com/proxy/9wbQ2WQ_PP25-YJXtmDfd4K3U5OqccALsGQnQJ7oXfuHIczKDHEdDqNKFKbLY6e4q873hC7NVOo3QS8zBqo-R8O3ykxJTUMve2oQbmpmFGdg0zh5Q-7BvqZ89S425JTdfFlXL5_RSuMyugVbm3vxSqVIz9aekECBF7ijuLIahh90XgyVrA=s0-d-e1-ft#https://i2.wp.com/rviews.rstudio.com/post/2017-08-21-stocks_files/figure-html/unnamed-chunk-8-1.png?w=450&amp;ssl=1"></p>
<p>The eigenvalues fall off rather quickly in our example! That means that a lot of the information in the sample correlation matrix is contained in the first few eigenvectors.</p>
<p>Let’s assume, perhaps unreasonably, that the errors in our estimate of the correlation matrix are equally likely to occur in any direction (that the errors are white noise, basically). As we can see above, most of the information is concentrated in the subspace corresponding to the first few eigenvectors. But white noise will have information content in all the dimensions more or less equally.</p>
<p>One regularization technique replaces the sample correlation matrix with an approximation defined by only its first few eigenvectors. Because they represent a large amount of the information content, the approximation can be pretty good. More importantly, because we assumed noise to be more or less equally represented across the eigenvector directions and we’re cutting most of those off, this approximation tends to damp the noise more than the underlying information. Most importantly, we’re cutting off the subspace associated with tiny eigenvalues, avoiding the problem of division by tiny values and significantly reducing amplified noise in the inverse of the sample correlation matrix (the precision matrix).</p>
<p>The upshot is, we regularize the sample correlation matrix by approximating it by a low-rank matrix that substantially reduces the influence of noise on the precision matrix. See Per Christian Hansen’s classic paperback, “Rank-Deficient and Discrete Ill-Posed Problems” (<a href="http://epubs.siam.org/doi/book/10.1137/1.9780898719697" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://epubs.siam.org/doi/book/10.1137/1.9780898719697&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNEwqA13RHCKWhAk73PCZwsiY6SaWA">http://epubs.siam.org/doi/<wbr>book/10.1137/1.9780898719697</a>), for insight into related topics.</p>
<div id="m_5853171786120636607but-how-to-choose-a-cut-off-rank" class="m_5853171786120636607section m_5853171786120636607level2">
<h2>But how to choose a cut-off rank?</h2>
<p>There is substantial mathematical literature for just this topic (regularization parameter choice selection), complete with deep theory as well as lots of heuristics. Let’s keep things simple for this example and form our approximation by cutting off eigenvectors beyond where the eigenvalue plot starts to flatten out – close to the vertical line in the above plot.</p>
<p>Alternatively, consider the lovely short 2004 paper by Chris Ding and Xiaofeng He (<a href="http://dl.acm.org/citation.cfm?id=1015408" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://dl.acm.org/citation.cfm?id%3D1015408&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNERH8PY-7u4Qhkxq8xQpK3sApOFdg">http://dl.acm.org/citation.<wbr>cfm?id=1015408</a>) that illuminates connections (that I happen to find fascinating) between k-means clustering and projections like truncated eigenvalue expansions. Although we aren’t interested in k-means clustering per se, our objective <em>is</em> connected to clustering. Ding and He show that we can find at least k (k-means) clusters using the first k – 1 eigenvectors above. This gives us another heuristic way to choose a projection dimension, at least if we have an idea about the number of clusters to look for.</p>
</div>
<div id="m_5853171786120636607a-precision-matrix-finally" class="m_5853171786120636607section m_5853171786120636607level2">
<h2>A precision matrix, finally</h2>
<p>Finally, we form the precision matrix <code>P</code> from the regularized sample correlation matrix. The inversion is less numerically problematic now because of regularization. Feel free to experiment with the projected rank <code>N</code> below!</p>
<pre class="m_5853171786120636607r"><code>N = 10  # (use 1st 10 eigenvectors, set N larger to reduce regularization)
P = L$vectors[, 1:N] %*% ((1 / L$values[1:N]) * t(L$vectors[, 1:N]))</code></pre>
</div>
<div id="m_5853171786120636607other-approaches" class="m_5853171786120636607section m_5853171786120636607level2">
<h2>Other approaches</h2>
<p>I’m not qualified to write about them, but you should be aware that Bayesian approaches to solving problems like this are also effectively (and effective!) regularization methods. I hope to someday better understand the connections between classical inverse problem solution methods that I know a little bit about, and Bayesian methods that I know substantially less about.</p>
</div>
</div>
<div id="m_5853171786120636607put-a-package-on-it" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Put a package on it</h1>
<p>There is a carefully written R package to construct regularized correlation and precision matrices: the <code>corpcor</code> package (<a href="https://cran.r-project.org/package=corpcor" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://cran.r-project.org/package%3Dcorpcor&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNEQlzk6b-bxJN65jMPKo-4mAjXUIA">https://cran.r-project.org/<wbr>package=corpcor</a>; also see <a href="http://strimmerlab.org/software/corpcor/" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://strimmerlab.org/software/corpcor/&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNEQmGkzOLTJzNmWoYh_X72ggyhxdg">http://strimmerlab.org/<wbr>software/corpcor/</a>) by Juliane Schafer, Rainer Opgen-Rhein, Verena Zuber, Miika Ahdesmaki, A. Pedro Duarte Silva, and Korbinian Strimmer. Their package includes the original Ledoit-Wolf-like regularization method, as well as refinements to it and many other methods. The <code>corpcor</code> package, like Ledoit Wolf, includes ways to use sophisticated regularization operators, and can apply more broadly than the simple approach taken in this post.</p>
<p>You can use the <code>corpcor</code> package to form a Ledoit-Wolf-like regularized precision matrix <code>P</code>, and you should try it! The result is pretty similar to what we get from our simple truncated eigenvalue decomposition regularization in this example.</p>
</div>
<div id="m_5853171786120636607networks-and-clustering" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Networks and clustering</h1>
<p>The (i, j)th entry of the precision matrix <code>P</code> is a measure of association between the log(return) time series for the stocks in columns i and j, with larger values corresponding to more association.</p>
<p>An interesting way to group related stocks together is to think of the precision matrix as an adjacency matrix defining a weighted, undirected network of stock associations. Thresholding entries of the precision matrix to include, say, only the top 10% results in a network of only the most strongly associated stocks.</p>
<p>Thinking in terms of networks opens up a huge and useful toolbox: graph theory. We gain access to all kinds of nifty ways to analyze and visualize data, including methods for clustering and community detection.</p>
<p>R’s comprehensive <code>igraph</code> package by Gábor Csárdi (<a href="https://cran.r-project.org/package=igraph" class="m_5853171786120636607uri" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://cran.r-project.org/package%3Digraph&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNErnwOuWhaVXnfr5cBPV4bY0P2ksw">https://cran.r-project.org/<wbr>package=igraph</a>) includes many network cluster detection algorithms. The example below uses Blondel and co-authors’ fast community detection algorithm implemented by <code>igraph</code>’s <code>cluster_louvain()</code> function to segment the thresholded precision matrix of stocks into groups. The code produces an <code>igraph</code> graph object <code>g</code>, with vertices colored by group membership.</p>
<pre class="m_5853171786120636607r"><code>suppressMessages(library(<wbr>igraph))

threshold = 0.90
Q = P * (P &gt; quantile(P, probs=threshold))                           # thresholded precision matrix
g = graph.adjacency(Q, mode=&quot;undirected&quot;, weighted=TRUE, diag=FALSE) # ...expressed as a graph

# The rest of the code lumps any singletons lacking edges into a single &#39;unassociated&#39; group shown in gray
# (also assigning distinct colors to the other groups).
x = groups(cluster_louvain(g))
i = unlist(lapply(x, length))
d = order(i, decreasing=TRUE)
x = x[d]
i = i[d]
j = i &gt; 1
s = sum(j)
names(x)[j] = seq(1, s)
names(x)[! j] = s + 1
grp = as.integer(rep(names(x), i))
clrs = c(rainbow(s), &quot;gray&quot;)[grp[order(unlist(x))]]
g = set_vertex_attr(g, &quot;color&quot;, value=clrs)</code></pre>
<p>Use the latest <code>threejs</code> package to make a nice interactive visualization of the network (you can use your mouse/trackpad to rotate, zoom and pan the visualization).</p>
<pre class="m_5853171786120636607r"><code>library(threejs)
graphjs(g, vertex.size=0.2, vertex.shape=colnames(X), edge.alpha=0.5)</code></pre>
<div id="m_5853171786120636607htmlwidget-1" style="width:816px;height:672px" class="m_5853171786120636607scatterplotThree m_5853171786120636607html-widget"></div>
<p></p>
<p>The stock groups identified by this method are uncanny, but hardly all that surprising really. Look closely and you will see clusters made up of bank-like companies (AIG, BAC, BK, C, COF, GS, JPM, MET, MS, USB, WFC), pharmaceutical companies (ABT, AMGN, BIIB, BMY, CELG, GILD, JNJ, LLY, MRK, PFE), computer/technology-driven companies (AAPL, ACN, CSCO, IBM, INTC, MSFT, ORCL, QCOM, T, TXN, VZ – except oddly, the inclusion of CAT in this list), and so on. With the threshold value of 0.9 above, a few stocks aren’t connected to any others; they appear in gray.</p>
<p>The groups more or less correspond to what we already know!</p>
<p>The group that includes FB, GOOG, and AMZN (Facebook, Alphabet/Google, and Amazon) is interesting and a bit mysterious. It includes credit card companies V (Visa), MA (Mastercard) and American Express (AXP). Perhaps the returns of FB, GOOG and AMZN are more closely connected to consumer spending than technology! But oddly, this group also includes a few energy companies (DUK, EXC, NEE), and I’m not sure what to make of that…</p>
<p>This way of looking at things also nicely highlights connections between groups. For instance, we see that a group containing consumer products companies (PEP, KO, PG, CL, etc.) is connected to both the Pharma group, and the credit card company group. And see the appendix below for a visualization that explores different precision matrix threshold values, including lower values with far greater network connectivity.</p>
</div>
<div id="m_5853171786120636607review" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Review</h1>
<p>We downloaded daily closing stock prices for 100 stocks from the S&amp;P 500, and, using basic tools of statistics and analysis like correlation and regularization, we grouped the stocks together in a network that highlights associations within and between the groups. The structure teased out of the stock price data is reasonably intuitive.</p>
<hr>
</div>
<div id="m_5853171786120636607appendix-threejs-tricks" class="m_5853171786120636607section m_5853171786120636607level1">
<h1>Appendix: <code>threejs</code> tricks</h1>
<p>The following self-contained example shows how the network changes with threshold value. It performs the same steps as we did above, but uses some tricks in <code>threejs</code> and an experimental extension to the <code>crosstalk</code> package and a few additional R packages to present an interactive animation. Enjoy!</p>
<pre class="m_5853171786120636607r"><code>suppressMessages({
library(quantmod)
library(igraph)
library(threejs)
library(crosstalk)
library(htmltools)
# using an experimental extension to crosstalk:
library(crosstool) # devtools::install_github(&#39;<wbr>bwlewis/crosstool&#39;)
})

# Download the processed log(returns) data:
suppressMessages(load(url(&quot;<wbr>http://illposed.net/<wbr>logreturns.rdata&quot;)))

X = cor(log_returns)
L = eigen(X, symmetric=TRUE)
N = 10  # (use 1st 10 eigenvectors, set N larger to reduce regularization)
P = L$vectors[, 1:N] %*% ((1 / L$values[1:N]) * t(L$vectors[, 1:N]))
colnames(P) = colnames(X)

# A function that creates a network for a given threshold and precision matrix
f = function(threshold, P)
{
  Q = P * (P &gt; quantile(P, probs=threshold))                           # thresholded precision matrix
  g = graph.adjacency(Q, mode=&quot;undirected&quot;, weighted=TRUE, diag=FALSE) # ...expressed as a graph

  x = groups(cluster_louvain(g))
  i = unlist(lapply(x, length))
  d = order(i, decreasing=TRUE)
  x = x[d]
  i = i[d]
  j = i &gt; 1
  s = sum(j)
  names(x)[j] = seq(1, s)
  names(x)[! j] = s + 1
  grp = as.integer(rep(names(x), i))
  clrs = c(rainbow(s), &quot;gray&quot;)[grp[order(unlist(x))]]
  g = set_vertex_attr(g, &quot;color&quot;, value=clrs)
  set_vertex_attr(g, &quot;shape&quot;, value=colnames(P))
}

threshold = c(0.99, 0.95, 0.90, 0.85, 0.8)
g = Map(f, threshold, MoreArgs=list(P=P)) # list of graphs, one for each threshold

# Compute force-directed network layouts for each threshold value
# A bit expensive to compute, so run in parallel!
library(parallel)
l = mcMap(function(x) layout_with_fr(x, dim=3, niter=150), g, mc.cores=detectCores())

sdf = SharedData$new(data.frame(key=<wbr>paste(seq(0, length(threshold) - 1))), key=~key)
slider = crosstool(sdf, &quot;transmitter&quot;,
                sprintf(&quot;<input type="&#39;range&#39;" value="&#39;0&#39;/">&quot;,
                length(threshold) - 1), width=&quot;100%&quot;, height=20, channel=&quot;filter&quot;)
vis = graphjs(g, l, vertex.size=0.2, main=as.list(threshold), defer=TRUE, edge.alpha=0.5, deferfps=30,
        crosstalk=sdf, width=&quot;100%&quot;, height=900)

browsable(div(list(HTML(&quot;<center>&quot;), tags$h3(&quot;Precision matrix quantile threshold (adjust slider to change)&quot;), slider, vis)))</center></code></pre>
<div>
<center>
<h3>Precision matrix quantile threshold (adjust slider to change)</h3>
<div id="m_5853171786120636607htmlwidget-2" style="width:100%;height:20px" class="m_5853171786120636607transmitter m_5853171786120636607html-widget"></div>
<p></p>
<div id="m_5853171786120636607htmlwidget-3" style="width:100%;height:900px" class="m_5853171786120636607scatterplotThree m_5853171786120636607html-widget"></div>
<p>
</p></center></div>
</div>
<p> </p>
<p class="m_5853171786120636607syndicated-attribution">
<hr>
<a href="https://www.r-bloggers.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNFdDb1kTrqxbPs9PItJlk7qsq9c2g">R-bloggers.com</a> offers <strong><a href="https://feedburner.google.com/fb/a/mailverify?uri=RBloggers" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://feedburner.google.com/fb/a/mailverify?uri%3DRBloggers&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNGaMo0MGo9TJOQ8bFD5AvL3mqGRHw">daily e-mail updates</a></strong> about <a title="The R Project for Statistical Computing" href="https://www.r-project.org/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-project.org/&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNG3yENJR1UflK4efH9pac6iTSg9qQ">R</a> news and <a title="R tutorials" href="https://www.r-bloggers.com/search/tutorial" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/tutorial&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNHjYTwqka14pCIEBVELExhjBx_liA">tutorials</a> on topics such as: <a title="Data science" href="https://www.r-bloggers.com/search/data%20science" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/data%2520science&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNGVXr1ADUQZtLAs6adhI0Yszj6SWA">Data science</a>, <a title="Big Data" href="https://www.r-bloggers.com/search/Big%20Data" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Big%2520Data&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNFrt3QPxtFnUcTqwwNdezY98rn2xA">Big Data, <a title="R jobs" href="https://www.r-users.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-users.com/&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNFgDEQQnuYEzqMVHJMPy7rQvL-bsw">R jobs</a>, visualization (<a title="ggplot and ggplot2 tutorials" href="https://www.r-bloggers.com/search/ggplot2" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/ggplot2&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNHDr253NCpJuO47N3m9kW0yKz1vdQ">ggplot2</a>, <a title="Boxplots using lattice and ggplot2 tutorials" href="https://www.r-bloggers.com/search/boxplot" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/boxplot&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNEcbIERIQek01kq6vwjz1OizepByg">Boxplots</a>, <a title="Maps and gis" href="https://www.r-bloggers.com/search/map" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/map&amp;source=gmail&amp;ust=1509512084251000&amp;usg=AFQjCNFHQKmzV_V-ExfeRbjAxegDLhxqwA">maps</a>, <a title="Animation in R" href="https://www.r-bloggers.com/search/animation" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/animation&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNHDRBVZfiSdyPnlC9qaBz49eGbBsw">animation</a>), programming (<a title="RStudio IDE for R" href="https://www.r-bloggers.com/search/RStudio" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/RStudio&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNFrQS0SThrNOqXXbDGtSJl-TDragg">RStudio</a>, <a title="Sweave and literate programming" href="https://www.r-bloggers.com/search/sweave" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/sweave&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNFHkukSKB7fdjpHnh_c4Y_OCBcXfA">Sweave</a>, <a title="LaTeX in R" href="https://www.r-bloggers.com/search/LaTeX" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/LaTeX&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNEM0yZ7PhlsSw0nRQ3Pj5HbVHtO1g">LaTeX</a>, <a title="SQL and databases" href="https://www.r-bloggers.com/search/SQL" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/SQL&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNEXmn0R_iG_mIYp7NRTl6LdBR7fug">SQL</a>, <a title="Eclipse IDE for R" href="https://www.r-bloggers.com/search/eclipse" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/eclipse&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNELM49JLIlexY2DFc2K9rY1CigXkQ">Eclipse</a>, <a title="git and github, Version Control System" href="https://www.r-bloggers.com/search/git" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/git&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNHfyZhMqJ3BQfGBenKZTVQJf0nVUw">git</a>, <a title="Large data in R using Hadoop" href="https://www.r-bloggers.com/search/hadoop" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/hadoop&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNEf2FMuu-n9Hljzxki3BHo1hYbWFA">hadoop</a>, <a title="Web Scraping of google, facebook, yahoo, twitter and more using R" href="https://www.r-bloggers.com/search/Web+Scraping" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Web%2BScraping&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNGPtQgcSalVYYdih1nWaQGhg-2oTg">Web Scraping</a>) statistics (<a title="Regressions and ANOVA analysis tutorials" href="https://www.r-bloggers.com/search/regression" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/regression&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNFN-1hGAOhIGGJtzdM3-tr4eraO_g">regression</a>, <a title="principal component analysis tutorial" href="https://www.r-bloggers.com/search/PCA" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/PCA&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNG7TliJQI6mxZkxDJLxpdQEApdOAQ">PCA</a>, <a title="Time series" href="https://www.r-bloggers.com/search/time+series" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/time%2Bseries&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNFH_bBKujhPJubclxXZ9vtl3P2N5w">time series</a>, <a title="finance trading" href="https://www.r-bloggers.com/search/trading" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/trading&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNHQsU62lPdSaQ0xqAwrEPBv_WZo5w">trading</a>) and more...
</a></div></p><img src="https://ci3.googleusercontent.com/proxy/rN7Ik3nLuWFXgHuYa1lSMHuLIbCx6k5Cf9QTVepRstZJzD6cCABa5_VPqeUxuQJYv_Gg32B7zFQoVx-1aZYpb2UXGnZ7ex803-pYkejVE2CjFHqLuoMrVVIZQHM9ulQjj8o6kD3qzSCk-SaVrdyWvEvWBqc=s0-d-e1-ft#http://feeds.feedburner.com/~r/RBloggers/~4/9wO5mygDvSg?utm_source=feedburner&amp;utm_medium=email" height="1" width="1" alt=""><p>This posting includes an audio/video/photo media file: <a>Download Now</a>
</p>
</div>
</td>
</tr>
<tr>
<td style="margin-bottom:0;line-height:1.4em">
<p style="margin:1em 0 3px 0">
<a name="m_5853171786120636607_6" style="font-family:Arial,Helvetica,sans-serif;font-size:19px" href="http://feedproxy.google.com/~r/RBloggers/~3/n22byVOjaos/?utm_source=feedburner&amp;utm_medium=email" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://feedproxy.google.com/~r/RBloggers/~3/n22byVOjaos/?utm_source%3Dfeedburner%26utm_medium%3Demail&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNH2Wz0h4Yu7bg8x6D94hXgx4tTOag">Using regression trees for forecasting double-seasonal time series with trend in R</a>
</p>
<p>After blogging break caused by writing research papers, I managed to secure time to write something new about time series forecasting. This time I want to share with you my experiences with seasonal-trend time series forecasting using simple regression trees. Classification and <strong>regression tree</strong> (or <a href="https://en.wikipedia.org/wiki/Decision_tree_learning" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Decision_tree_learning&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNGD-J0B9SCNwMZyGv6jPvie2yIdwg">decision tree</a>) is broadly used <strong>machine learning</strong> method for modeling. They are favorite because of these factors:</p>
<ul>
<li>simple to understand (white box)</li>
<li>from a tree we can extract interpretable results and make simple decisions</li>
<li>they are helpful for exploratory analysis as binary structure of tree is simple to visualize</li>
<li>very good prediction accuracy performance</li>
<li>very fast</li>
<li>they can be simply tuned by ensemble learning techniques</li>
</ul>
<p>But! There is always some “but”, they poorly adapt when new unexpected situations (values) appears. In other words, they can not detect and adapt to change or <a href="https://en.wikipedia.org/wiki/Concept_drift" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Concept_drift&amp;source=gmail&amp;ust=1509512084252000&amp;usg=AFQjCNEfKGRpebArCLG9Ti5aboB-P0UhVA">concept drift</a> well (absolutely not). This is due to the fact that tree creates during learning just simple rules based on training data. Simple decision tree does not compute any regression coefficients like linear regression, so trend modeling is not possible. You would ask now, so why we are talking about time series forecasting with regression tree together, right? I will explain how to deal with it in more detail further in this post.</p>
<p>You will learn in this post how to:</p>
<ul>
<li>decompose double-seasonal time series</li>
<li>detrend time series</li>
<li>model and forecast <strong>double-seasonal time series</strong> with trend</li>
<li>use two types of simple <strong>regression trees</strong></li>
<li>set important hyperparameters related to regression tree</li>
</ul>
<h2 id="m_5853171786120636607exploring-time-series-data-of-electricity-consumption">Exploring time series data of electricity consumption</h2>
<p>As in previous posts, I will use smart meter data of electricity consumption for demonstrating forecasting of seasonal time series. I created a new dataset of aggregated electricity load of consumers from an anonymous area. Time series data have the length of 17 weeks.</p>
<p>Firstly, let’s scan all of the needed packages for data analysis, modeling and visualizing.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">feather</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># data import
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># data handle
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">rpart</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># decision tree method
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">rpart.plot</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># tree plot
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">party</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># decision tree method
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">forecast</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># forecasting methods
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">ggplot2</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># visualizations
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">ggforce</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># visualization tools
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">plotly</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># interactive visualizations
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">grid</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># visualizations
</span><span class="m_5853171786120636607n">library</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">animation</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607err">#</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">gif</span></code></pre>
</figure>
<p>Now read the mentioned time series data by <code class="m_5853171786120636607highlighter-rouge">read_feather</code> to one <code class="m_5853171786120636607highlighter-rouge">data.table</code>.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">DT</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">as.data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">read_feather</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;<wbr>DT_load_17weeks&quot;</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<p>And store information of the date and period of time series that is 48.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">n_date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">unique</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">DT</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607p">])</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">48</span></code></pre>
</figure>
<p>For data visualization needs, store my favorite ggplot theme settings by function <code class="m_5853171786120636607highlighter-rouge">theme</code>.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">theme_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">theme</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">panel.border</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_rect</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fill</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607kc">NA</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> 
                                              </span><span class="m_5853171786120636607n">colour</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;grey10&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">panel.background</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_blank</span><span class="m_5853171786120636607p">(),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">panel.grid.minor</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">colour</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;grey85&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">panel.grid.major</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">colour</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;grey85&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">panel.grid.major.x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">colour</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;grey85&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">axis.text</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_text</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">13</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">face</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;bold&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">axis.title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_text</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">15</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">face</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;bold&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">plot.title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_text</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">16</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">face</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;bold&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">strip.text</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_text</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">16</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">face</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;bold&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">strip.background</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_rect</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">colour</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;black&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">legend.text</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_text</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">15</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">legend.title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_text</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">16</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">face</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;bold&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">legend.background</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_rect</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fill</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;white&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">legend.key</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">element_rect</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fill</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;white&quot;</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<p>Now, pick some dates of the length 3 weeks from dataset to split data on the train and test part. Test set has the length of only one day because we will perform one day ahead forecast of electricity consumption.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">DT</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%in%</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">n_date</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607m">43</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607m">63</span><span class="m_5853171786120636607p">]]</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">DT</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%in%</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">n_date</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607m">64</span><span class="m_5853171786120636607p">]]</span></code></pre>
</figure>
<p>Let’s plot the train set and corresponding average weekly values of electricity load.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">averages</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">sapply</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">0</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607k">function</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">i</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
                        </span><span class="m_5853171786120636607n">mean</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">[((</span><span class="m_5853171786120636607n">i</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607m">+<wbr>1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607p">((</span><span class="m_5853171786120636607n">i</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">])),</span><span class="m_5853171786120636607w">
                        </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                       </span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">()</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">averages</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
            </span><span class="m_5853171786120636607n">linetype</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">5</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.75</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1.2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;firebrick2&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Date&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Load (kW)&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci6.googleusercontent.com/proxy/oOyHzIUYj-grbzFxmK048tSq1Hb0pMKLuFKCuGUQvh37GP-Oe5Tlgn3IBDh7wYTvTE55c7V3tbfUAIRqc2wQg3WA7mLtLaNWX6EDZYMasqlxIyMMTpnJFkYaJPm5r50uirZZXBDfca91=s0-d-e1-ft#https://i1.wp.com/petolau.github.io/images/post_5/unnamed-chunk-7-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-7"></p>
<p>We can see some trend increasing over time, maybe air conditioning is more used when gets hotter in summer. The double-seasonal (daily and weekly) character of time series is obvious.</p>
<p>A very useful method for visualization and analysis of time series is <a href="https://www.otexts.org/fpp/6/5" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.otexts.org/fpp/6/5&amp;source=gmail&amp;ust=1509512084253000&amp;usg=AFQjCNEz2ubefck6ejgCcGJMkgoivhHfPA">STL decomposition</a>.<br>
STL decomposition is based on Loess regression, and it decomposes time series to three parts: seasonal, trend and remainder.<br>
We will use results from the STL decomposition to model our data as well.<br>
I am using <code class="m_5853171786120636607highlighter-rouge">stl()</code> from <code class="m_5853171786120636607highlighter-rouge">stats</code> package and before computation we must define weekly seasonality to our time series object. Let’s look on results:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">freq</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">stl</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">s.window</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;periodic&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">robust</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607kc">TRUE</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">decomp_stl</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">as.numeric</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                         </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">],</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ncol</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                         </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">factor</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;original data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">colnames</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                       </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                       </span><span class="m_5853171786120636607n">levels</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;original data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">colnames</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">))))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_stl</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">()</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> 
  </span><span class="m_5853171786120636607n">facet_grid</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">scales</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;free_y&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">switch</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;y&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Date&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607kc">NULL</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
       </span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Time Series Decomposition by STL&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci3.googleusercontent.com/proxy/z5nT0MqwgaUpEf_LpV7TpJzEJBeQOKkOIG0-Gj3YhD2REHmgPNz67MyMTw8Ri86LIUGZV2IN5fONJH4bUHykadShcgWDowfNI3jjnewjWP9hQyQLh5MU0TGq2_3s0NR0tSWPEX7gNaam=s0-d-e1-ft#https://i2.wp.com/petolau.github.io/images/post_5/unnamed-chunk-8-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-8"></p>
<p>As was expected from the previous picture, we can see that there is “slight” trend increasing and decreasing (by around 100 kW so slightly large <img src="https://ci5.googleusercontent.com/proxy/lT4X5MAk-LYh_rABJUAEglE5wL3Asu-7u4MBNrYG3X1k5uLpcXKPECd3WeZDApqc92ApeLqrIRFleRpcfy3ZUnmoiGDMUJhJlg=s0-d-e1-ft#https://s.w.org/images/core/emoji/2/72x72/1f609.png" alt="😉" class="m_5853171786120636607wp-smiley" style="height:1em;max-height:1em"> ).<br>
Remainder part (noise) is very fluctuate and not seems like classical <a href="https://en.wikipedia.org/wiki/White_noise" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/White_noise&amp;source=gmail&amp;ust=1509512084253000&amp;usg=AFQjCNFksq99KyU4pX189Gp_8Ql9vVsqXw">white noise</a> (we obviously missing additional information like weather and other unexpected situations).</p>
<h2 id="m_5853171786120636607constructing-features-to-model">Constructing features to model</h2>
<p>In this section I will do <strong>feature engineering</strong> for modeling double-seasonal <strong>time series</strong> with trend best as possible by just available historical values.</p>
<p>Classical way to handle seasonality is to add seasonal features to a model as vectors of form \( (1, \dots, DailyPeriod, 1, …, DailyPeriod,…) \) for daily season or \( (1, \dots, 1, 2, \dots, 2, \dots , 7, 1, \dots) \) for weekly season. I used it this way in my previous <a href="https://petolau.github.io/Analyzing-double-seasonal-time-series-with-GAM-in-R/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://petolau.github.io/Analyzing-double-seasonal-time-series-with-GAM-in-R/&amp;source=gmail&amp;ust=1509512084253000&amp;usg=AFQjCNFR2D_cDS7_vjm5ymgust5mEfFzQA">post about GAM</a> and somehow similar also with <a href="https://petolau.github.io/Forecast-double-seasonal-time-series-with-multiple-linear-regression-in-R/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://petolau.github.io/Forecast-double-seasonal-time-series-with-multiple-linear-regression-in-R/&amp;source=gmail&amp;ust=1509512084253000&amp;usg=AFQjCNGGXR0wjGRTuWh8X7_MnHcyKQmWHQ">multiple linear regression</a>.</p>
<p>A better way to model seasonal variables (features) with <strong>nonlinear regression</strong> methods like <strong>tree</strong> is to transform it to <a href="https://en.wikipedia.org/wiki/Fourier_transform" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Fourier_transform&amp;source=gmail&amp;ust=1509512084253000&amp;usg=AFQjCNETs9otfDQIm1117yfe7cLZPxDsYg">Fourier terms</a> (sinus and cosine). It is more effective to tree models and also other nonlinear machine learning methods. I will explain why it is like that further of this post.</p>
<p>Fourier daily signals (terms) are defined as:</p>
<p></p>
<p>where \( ds \) is number of daily seasonality Fourier pairs and Fourier weekly terms are defines as:</p>
<p></p>
<p>where \( ws \) is a number of weekly seasonality Fourier pairs.</p>
<p>Another great feature (most of the times most powerful) is a lag of original time series. We can use lag by one day, one week, etc…<br>
The lag of time series can be preprocessed by removing noise or trend for example by STL decomposition method to ensure stability.</p>
<p>As was earlier mentioned, regression trees can’t predict trend because they logically make rules and predict future values only by rules made by training set.<br>
Therefore original time series that inputs to regression tree as dependent variable must be <a href="https://en.wiktionary.org/wiki/detrending" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wiktionary.org/wiki/detrending&amp;source=gmail&amp;ust=1509512084253000&amp;usg=AFQjCNETxNoa_ZEXeX_wPdXA4eDbMqqgFA">detrended</a> (removing the trend part of the time series). The acquired trend part then can be forecasted by for example <a href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average&amp;source=gmail&amp;ust=1509512084253000&amp;usg=AFQjCNGdz6OVp74-uBT_cyI9_xTTCquRlQ">ARIMA</a> model.</p>
<p>Let’s go to constructing mentioned features and trend forecasting.</p>
<p>Double-seasonal Fourier terms can be simply extracted by <code class="m_5853171786120636607highlighter-rouge">fourier</code> function from <code class="m_5853171786120636607highlighter-rouge">forecast</code> package.<br>
Firstly, we must create multiple seasonal object with function <code class="m_5853171786120636607highlighter-rouge">msts</code>.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">data_msts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">msts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">seasonal.periods</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<p>Now use <code class="m_5853171786120636607highlighter-rouge">fourier</code> function using two conditions for a number of K terms.<br>
Set K for example just to 2.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">fourier</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_msts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<p>It made 2 pairs (sine and cosine) of daily and weekly seasonal signals.<br>
If we compare it with approach described in previous posts, so simple periodic vectors, it looks like this:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">Daily</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">21</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># simple daily vector
</span><span class="m_5853171786120636607n">Weekly</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">week_num</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># simple weekly vector
</span><span class="m_5853171786120636607w"> 
</span><span class="m_5853171786120636607n">data_fuur_simple</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">scale</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Daily</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">],</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">scale</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Weekly</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607m">6</span><span class="m_5853171786120636607p">]),</span><span class="m_5853171786120636607w">
                               </span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">4</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                               </span><span class="m_5853171786120636607n">method</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;simple-daily&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;four-daily&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                              </span><span class="m_5853171786120636607s2">&quot;simple-weekly&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;four-weekly&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                                            </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                               </span><span class="m_5853171786120636607n">type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Daily season&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Weekly season&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                                          </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_fuur_simple</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">method</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1.2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.7</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> 
  </span><span class="m_5853171786120636607n">facet_grid</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">scales</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;free_y&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">switch</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;y&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Date&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607kc">NULL</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
       </span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Features Comparison&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci4.googleusercontent.com/proxy/FFScVzKGhj31iFPHk3bDfMXohKNzHuFyoXJCPayjPA06HXGm_cNJuL8nlm6RkRomDdUtaerUkGuiSG1iMV4lm1Lr3Uf82h75oz58qlfF32nYzb3dmkJU5jqe6gJXORt3lg7pJzEKZFqbzA=s0-d-e1-ft#https://i2.wp.com/petolau.github.io/images/post_5/unnamed-chunk-11-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-11"></p>
<p>where <em>four-daily</em> is the Fourier term for daily season, <em>simple-daily</em> is the simple feature for daily season, <em>four-weekly</em> is the Fourier term for weekly season, and <em>simple-weekly</em> is the simple feature for weekly season. The <strong>advantage</strong> of <strong>Fourier terms</strong> is that there is much more closeness between ending and starting of a day or a week, which is more natural.</p>
<p>Now, let’s use data from STL decomposition to forecast trend part of time series. I will use <code class="m_5853171786120636607highlighter-rouge">auto.arima</code> procedure from the <code class="m_5853171786120636607highlighter-rouge">forecast</code> package to perform this.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">trend_part</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">])</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">trend_fit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">auto.arima</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_part</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">trend_for</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">forecast</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_fit</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">mean</span></code></pre>
</figure>
<p>Let’s plot it:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">trend_data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">],</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">trend_for</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                         </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                         </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Real&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Forecast&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                                                     </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">))))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_data</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1.2</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">paste</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_fit</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci4.googleusercontent.com/proxy/mxsUXS3F08ixdd_MQeKuDlPcQjHzgk2WiMKcOOxTLhg3Q13mam_tadbJdW8MsNjBJRjsftWGAIuyex3PrKk9SWb4d6wiiVK7B1MJl2722Oqal64jAh3yi_ipm24193QsVmqijVhidAVFKw=s0-d-e1-ft#https://i2.wp.com/petolau.github.io/images/post_5/unnamed-chunk-13-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-13"></p>
<p>Function <code class="m_5853171786120636607highlighter-rouge">auto.arima</code> chose ARIMA(0,2,0) model as best for trend forecasting.</p>
<p>Next, make the final feature to the model (lag) and construct train matrix (model matrix).<br>
I am creating lag by one day and just taking seasonal part from STL decomposition (for having smooth lag time series feature).</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">/</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># number of days in train set minus lag
</span><span class="m_5853171786120636607w"> 
</span><span class="m_5853171786120636607n">new_load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rowSums</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">3</span><span class="m_5853171786120636607p">)])</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># detrended load
</span><span class="m_5853171786120636607n">lag_seas</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># seasonal part of time series as lag feature
</span><span class="m_5853171786120636607w"> 
</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">tail</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">new_load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                           </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">[(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607p">,],</span><span class="m_5853171786120636607w">
                           </span><span class="m_5853171786120636607n">Lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">lag_seas</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<p>The accuracy of forecast (or fitted values of a model) will be measured by MAPE, let’s defined it:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607k">function</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">real</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">pred</span><span class="m_5853171786120636607p">){</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607nf">return</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">100</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">mean</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">abs</span><span class="m_5853171786120636607p">((</span><span class="m_5853171786120636607n">real</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">pred</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">/</span><span class="m_5853171786120636607n">real</span><span class="m_5853171786120636607p">)))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607c1"># MAPE - Mean Absolute Percentage Error
</span><span class="m_5853171786120636607p">}</span></code></pre>
</figure>
<h2 id="m_5853171786120636607rpart-cart-tree">RPART (CART) tree</h2>
<p>In the next two sections, I will describe two <strong>regression tree</strong> methods. The first is <strong>RPART</strong>, or CART (Classification and Regression Trees), the second will be CTREE. RPART is recursive partitioning type of binary tree for classification or regression tasks. It performs a search over all possible splits by maximizing an information measure of node impurity, selecting the covariate showing the best split.</p>
<p>I’m using <code class="m_5853171786120636607highlighter-rouge">rpart</code> implementation from the same named package. Let’s go forward to modeling and try default settings of <code class="m_5853171786120636607highlighter-rouge">rpart</code> function:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rpart</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<p>It makes many interesting outputs to check, for example we can see a table of nodes and corresponding errors by <code class="m_5853171786120636607highlighter-rouge">printcp(tree_1)</code> or see a detailed summary of created nodes by <code class="m_5853171786120636607highlighter-rouge">summary(tree_1)</code>. We will check variable importance and number of created splits:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">variable.importance</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">##       Lag     C2-48    C1-336     S1-48     C1-48    S1-336    C2-336 
## 100504751  45918330  44310331  36245736  32359598  27831258  25385506 
##    S2-336     S2-48 
##  15156041   7595266</code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">paste</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Number of splits: &quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">cptable</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607nf">dim</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">cpta<wbr>ble</span><span class="m_5853171786120636607p">)[</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">],</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;nsplit&quot;</span><span class="m_5853171786120636607p">])</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] &quot;Number of splits:  10&quot;</code></pre>
</figure>
<p>We can see that most important variables are Lag and cosine forms of the daily and weekly season. The number of splits is 10, ehm, is it enough for time series of length 1008 values?</p>
<p>Let’s plot created rules with fancy <code class="m_5853171786120636607highlighter-rouge">rpart.plot</code> function from the same named package:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">rpart.plot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">digits</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> 
           </span><span class="m_5853171786120636607n">box.palette</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">viridis</span><span class="m_5853171786120636607o">::</span><span class="m_5853171786120636607n">viridis</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">10</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">option</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;D&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">begin</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.85</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">end</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> 
           </span><span class="m_5853171786120636607n">shadow.col</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;grey65&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">col</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;grey99&quot;</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<p><img src="https://ci3.googleusercontent.com/proxy/tVuuVx-cmSJVMiWBJJtIk9BMcE5fAtcr0klzWZX6U-ZuD3OfenGZ5XcWH4Dk6G2vFp_pg09ktx4CSY_UcShVujbf2bmWE8cyT7RGOElcSlkPElU_aiNyKu3WL7oZb3MszsZ_IOrKFIlZqQ=s0-d-e1-ft#https://i1.wp.com/petolau.github.io/images/post_5/unnamed-chunk-18-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-18"></p>
<p>We can see values, rules, and percentage of values split each time. Pretty simple and interpretable.</p>
<p>Now plot fitted values to see results of the <code class="m_5853171786120636607highlighter-rouge">tree_1</code> model.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p"><wbr>),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Real&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;RPART&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">)))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.8</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.75</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Detrended load&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Fitted values from RPART tree&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci6.googleusercontent.com/proxy/l8OhNmVOt6uUU5aLIqXKKzIhncV7_PuSDnCxPo6gMtsdiTL9FOO--8JxWzUnnHC9aeKz_cBGESuKA7w-376udhn4opAl7NWVPCr12XI-ctBTJD3OMSPh0ATDE2v3erm8hjE-GavgtEFgzw=s0-d-e1-ft#https://i2.wp.com/petolau.github.io/images/post_5/unnamed-chunk-19-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-19"></p>
<p>And see the error of fitted values against real values.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 180.6669</code></pre>
</figure>
<p>Whups. It’s a little bit simple (rectangular) and not really accurate, but it’s logical result from a simple tree model.<br>
The key to achieving better results and have more accurate fit is to set manually control hyperparameters of rpart.<br>
Check <code class="m_5853171786120636607highlighter-rouge">?rpart.control</code> to get more information.<br>
The “hack” is to change cp (complexity) parameter to very low to produce more splits (nodes). The <code class="m_5853171786120636607highlighter-rouge">cp</code> is a threshold deciding if each branch fulfills conditions for further processing, so only nodes with fitness larger than factor cp are processed. Other important parameters are the minimum number of observations in needed in a node to split (<code class="m_5853171786120636607highlighter-rouge">minsplit</code>) and the maximal depth of a tree (<code class="m_5853171786120636607highlighter-rouge">maxdepth</code>).<br>
Set the <code class="m_5853171786120636607highlighter-rouge">minsplit</code> to 2 and set the <code class="m_5853171786120636607highlighter-rouge">maxdepth</code> to its maximal value – 30.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rpart</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                </span><span class="m_5853171786120636607n">control</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rpart.control</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">minsplit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                        </span><span class="m_5853171786120636607n">maxdepth</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">30</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                        </span><span class="m_5853171786120636607n">cp</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.000001</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<p>Now make simple plot to see depth of the created tree…</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">plot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">compress</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607kc">TRUE</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<p><img src="https://ci6.googleusercontent.com/proxy/jhqlEyRHSZZmdHku6jS52JC331MmavQtjwWTG32kScEYsz2vlZBp7NyJHgsS3uWsW-ErATNE4Qg2fh40uoWk1MALEOltdixGjOo9D71fzw4Dnf7A4IPEhD_UkmKEJBojD1TmrSnGCo9wOA=s0-d-e1-ft#https://i1.wp.com/petolau.github.io/images/post_5/unnamed-chunk-22-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-22"></p>
<p>That’s little bit impressive difference than previous one, isn’t it?<br>
Check also number of splits.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">cptable</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607nf">dim</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">cpta<wbr>ble</span><span class="m_5853171786120636607p">)[</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">],</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;nsplit&quot;</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607err">#</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Number</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">of</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">splits</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 600</code></pre>
</figure>
<p>600 is higher than 10 <img src="https://ci6.googleusercontent.com/proxy/509TM3bMxJBkmsgei18x13amZF33y4d94XZ-WxFVnwN2OfupRRs7R43mpw4j7FPWaefXNk-DswpzLBuy0LMKPvtZ-g20yxHZpg=s0-d-e1-ft#https://s.w.org/images/core/emoji/2/72x72/1f642.png" alt="🙂" class="m_5853171786120636607wp-smiley" style="height:1em;max-height:1em"></p>
<p>Let’s plot fitted values from the model <code class="m_5853171786120636607highlighter-rouge">tree_2</code>:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p"><wbr>),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Real&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;RPART&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">)))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.8</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.75</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Detrended load&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Fitted values from RPART&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci3.googleusercontent.com/proxy/aVsH0UKf2O5NMsCWAcgmuwtbEMmQwNrezE24qPrz0d6aTMTifmI3GyKXCt3jG4VYwM9cc0lO1wMsxBW5AB3EUw1kyI9d8aLB05Fdm7e4OTdbcx-swq4GWqhYCWOsVCclV95CnVRS3DtePQ=s0-d-e1-ft#https://i1.wp.com/petolau.github.io/images/post_5/unnamed-chunk-24-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-24"></p>
<p>And see the error of fitted values against real values.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 16.0639</code></pre>
</figure>
<p>Much better, but obviously the model can be overfitted now.</p>
<p>Add together everything that we got till now, so forecast load one day ahead.<br>
Let’s create testing data matrix:</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">test_lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607p">[((</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n"><wbr>N</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607n">fuur_test</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">fourier</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_msts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">h</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fuur_test</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                          </span><span class="m_5853171786120636607n">Lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">test_lag</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<p>Predict detrended time series part with <code class="m_5853171786120636607highlighter-rouge">tree_2</code> model + add the trend part of time series forecasted by ARIMA model.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">for_rpart</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">trend_for</span></code></pre>
</figure>
<p>Let’s plot the results and compare it with real values from <code class="m_5853171786120636607highlighter-rouge">data_test</code>.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">data_for</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_rpart</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                       </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                       </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Train data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Test data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Forecast&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">))))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_for</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.8</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.75</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">facet_zoom</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%in%</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">zoom.size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1.2</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Forecast from RPART&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci3.googleusercontent.com/proxy/bou3s7JIFrCOR-ofhbHpFA41en6X4UhJXUVyaz3jVEpbTN3rNzF82SNri5huqunnRlyTZB1V0YoNpKZExnH2CZybqHCThThy_xYGExWjAS48LxF7LfQX6kCQ9K6f6eDcdIXSD4tgm84DSg=s0-d-e1-ft#https://i0.wp.com/petolau.github.io/images/post_5/unnamed-chunk-28-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-28"></p>
<p>Not bad. For clarity, compare forecasting results with model without separate trend forecasting and detrending.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">matrix_train_sim</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">tail</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                           </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">[(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607p">,],</span><span class="m_5853171786120636607w">
                           </span><span class="m_5853171786120636607n">Lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">lag_seas</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">tree_sim</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rpart</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_train_sim</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">control</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rpart.control</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">minsplit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                          </span><span class="m_5853171786120636607n">maxdepth</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">30</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                          </span><span class="m_5853171786120636607n">cp</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.000001</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">for_rpart_sim</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_sim</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">data_for</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_rpart</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_rpart_sim</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                       </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">3</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                       </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Train data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Test data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Forecast with trend&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Forecast simple&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">))))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_for</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">linetype</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.8</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.7</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">facet_zoom</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%in%</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">zoom.size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1.2</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Forecasts from RPARTs with and without trend forecasting&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">scale_linetype_manual</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">values</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">5</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">6</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci4.googleusercontent.com/proxy/IWSnhUqBXcCyAiJ5mch9onNnBeniQ0aLVtnnuDgx-HNhZ5cRduVOpE7pXVvEaEM4U8d0hy289w8JgOeB8k1Pq4D_JRJxna5vHQx8HIkkdnXXw7IqbBHwvbpg3cE_HgDUOiUdEz4zAB2-CQ=s0-d-e1-ft#https://i0.wp.com/petolau.github.io/images/post_5/unnamed-chunk-29-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-29"></p>
<p>We can see that RPART model without trend manipulation has higher values of the forecast.<br>
Evaluate results with MAPE forecasting measure.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_rpart</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 3.727473</code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_rpart_sim</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 6.976259</code></pre>
</figure>
<p>We can see the large difference in MAPE. So detrending original time series and forecasting separately trend part really works, but not generalize the result now. You can read more about RPART method in its great <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf&amp;source=gmail&amp;ust=1509512084255000&amp;usg=AFQjCNEt2jJ9tb7waAp8FviOEpmLMnoDMw">package vignette</a>.</p>
<h2 id="m_5853171786120636607ctree">CTREE</h2>
<p>The second simple regression tree method that will be used is <strong>CTREE</strong>. Conditional inference trees (CTREE) is a statistical approach to recursive partitioning, which takes into account the distributional properties of the data. CTREE performs multiple test procedures that are applied to determine whether no significant association between any of the feature and the response (load in the our case) can be stated and the recursion needs to stop.<br>
In <strong>R</strong> CTREE is implemented in the package <code class="m_5853171786120636607highlighter-rouge">party</code> in the function <code class="m_5853171786120636607highlighter-rouge">ctree</code>.</p>
<p>Let’s try fit simple <code class="m_5853171786120636607highlighter-rouge">ctree</code> with a default values.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">ctree_1</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ctree</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<p>Constructed tree can be again simply plotted by <code class="m_5853171786120636607highlighter-rouge">plot</code> function, but it made many splits so it’s disarranged.</p>
<p>Let’s plot fitted values from <code class="m_5853171786120636607highlighter-rouge">ctree_1</code> model.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">ctree_1</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p"><wbr>),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Real&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;CTREE&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">)))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.8</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.75</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Detrended load&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Fitted values from CTREE&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci3.googleusercontent.com/proxy/GMQUcv7RPLAjBRqWl-ckdsh2T95wZ8qER0630Dde_0PqrLQ0tJszML8a3SvrUaSCeXNbSiEq9UZXJxPW20zNI48G5h27WwTcImc4OWSDbUOq5VdIoZM5YICEF0DxDgangLQjHIy-H1k1Og=s0-d-e1-ft#https://i1.wp.com/petolau.github.io/images/post_5/unnamed-chunk-32-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-32"></p>
<p>And see the error of fitted values against real values.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">ctree_1</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 87.85983</code></pre>
</figure>
<p>Actually, this is pretty nice, but again, it can be tuned.</p>
<p>For available hyperparameters tuning check <code class="m_5853171786120636607highlighter-rouge">?ctree_control</code>. I changed hyperparameters <code class="m_5853171786120636607highlighter-rouge">minsplit</code> and <code class="m_5853171786120636607highlighter-rouge">minbucket</code> that have similar meaning like the cp parameter in RPART. The <code class="m_5853171786120636607highlighter-rouge">mincriterion</code> can be tuned also, and it is significance level (1 – p-value) that must be exceeded in order to implement a split. Let’s plot results.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">ctree_2</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ctree</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                        </span><span class="m_5853171786120636607n">controls</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">party</span><span class="m_5853171786120636607o">::</span><span class="m_5853171786120636607n">ctree_control</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">teststat</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;quad&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> 
                                                        </span><span class="m_5853171786120636607n">testtype</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Teststatistic&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> 
                                                        </span><span class="m_5853171786120636607n">mincriterion</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.925</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                                        </span><span class="m_5853171786120636607n">minsplit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                                        </span><span class="m_5853171786120636607n">minbucket</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">ctree_2</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p"><wbr>),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                    </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Real&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;CTREE&quot;</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">each</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">length</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">)))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">datas</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.8</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.75</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">y</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Detrended load&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Fitted values from CTREE&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci4.googleusercontent.com/proxy/OH-ZSUMG_IKoeqzPJisykhu9o0J180McQG4ekyqsVxMJG_uRczUgw9bpFGBghAPeEQIpnxolhgPqrFWiUD-vveJ3YvSZnj9XyNiQ15SjZy2S3n5rOoSvFbHnza3HupDtQqLEE1ynDj5h1g=s0-d-e1-ft#https://i1.wp.com/petolau.github.io/images/post_5/unnamed-chunk-34-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-34"></p>
<p>And see the error of fitted values against real values.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">ctree_2</span><span class="m_5853171786120636607p">))</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 39.70532</code></pre>
</figure>
<p>It’s better. Now forecast values with <code class="m_5853171786120636607highlighter-rouge">ctree_2</code> model.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">for_ctree</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">ctree_2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">trend_for</span></code></pre>
</figure>
<p>And compare CTREE with RPART model.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">data_for</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_rpart</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_ctree</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                       </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">3</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                       </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Train data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;Test data&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;RPART&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">)),</span><span class="m_5853171786120636607w">
                                </span><span class="m_5853171786120636607nf">rep</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607s2">&quot;CTREE&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607p">))))</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">ggplot</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_for</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">aes</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">color</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">linetype</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Type</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">geom_line</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.8</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">alpha</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.7</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">facet_zoom</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">x</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">Date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%in%</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">date_time</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">zoom.size</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1.2</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">labs</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">title</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Forecasts from RPART and CTREE models&quot;</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">scale_linetype_manual</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">values</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">5</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">6</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">theme_ts</span></code></pre>
</figure>
<p><img src="https://ci6.googleusercontent.com/proxy/pc5yWQ1_b7S0RMv3i04qprwpGmBIvMH6p7Wa4PGQyIDeB5OY_Gpa2neUrIiVSK5-dyq92yp6jIUoXwS0B1ZjtnPEmrxnFQqI7w7OTgQJPcvvHE8hbxVaycxywJ3f3BBgCsMzGXNvC-d1-w=s0-d-e1-ft#https://i0.wp.com/petolau.github.io/images/post_5/unnamed-chunk-37-1.png?w=456&amp;ssl=1" alt="plot of chunk unnamed-chunk-37"></p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_rpart</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 3.727473</code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">mape</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_test</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">for_ctree</span><span class="m_5853171786120636607p">)</span></code></pre>
</figure>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-text">## [1] 4.020834</code></pre>
</figure>
<p>Slightly better MAPE value with RPART, but again now it can not be anything to generalize. You can read more about CTREE method in its great <a href="https://cran.r-project.org/web/packages/party/vignettes/party.pdf" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://cran.r-project.org/web/packages/party/vignettes/party.pdf&amp;source=gmail&amp;ust=1509512084255000&amp;usg=AFQjCNEuTc8Zbl8DdEUfMOc2zb7Q3kuceQ">package vignette</a>.<br>
Try to forecast future values with all available electricity load data with sliding window approach (window of the length of three weeks) for a period of more than three months (98 days).</p>
<h2 id="m_5853171786120636607comparison">Comparison</h2>
<p>Define functions that produce forecasts, so add up everything that we learned so far.</p>
<figure class="m_5853171786120636607highlight">
<pre><code class="m_5853171786120636607language-r"><span class="m_5853171786120636607n">RpartTrend</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607k">function</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">set_of_date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">48</span><span class="m_5853171786120636607p">){</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%in%</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">set_of_date</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">/</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">msts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">seasonal.periods</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">fourier</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">fuur_test</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">as.data.frame</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fourier</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">h</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">freq</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">stl</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">s.window</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;periodic&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">robust</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607kc">TRUE</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">new_load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rowSums</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[<wbr>,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">3</span><span class="m_5853171786120636607p">)])</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">trend_part</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">])</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">trend_fit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">auto.arima</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_part</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">trend_for</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">as.vector</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">forecast</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_fit</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">mean</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">lag_seas</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">perio<wbr>d</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">tail</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">new_load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">[(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607p">,],</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">Lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">lag_seas</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rpart</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                  </span><span class="m_5853171786120636607n">control</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rpart.control</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">minsplit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                          </span><span class="m_5853171786120636607n">maxdepth</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">30</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                          </span><span class="m_5853171786120636607n">cp</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.000001</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">test_lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[((</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o"><wbr>*</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fuur_test</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                            </span><span class="m_5853171786120636607n">Lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">test_lag</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607c1"># prediction
</span><span class="m_5853171786120636607w">  </span><span class="m_5853171786120636607n">pred_tree</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">trend_for</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607nf">return</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">as.vector</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">pred_tree</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607p">}</span><span class="m_5853171786120636607w">
 
</span><span class="m_5853171786120636607n">CtreeTrend</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607k">function</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">set_of_date</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">48</span><span class="m_5853171786120636607p">){</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607c1"># subsetting the dataset by dates
</span><span class="m_5853171786120636607w">  </span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607n">date</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">%in%</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">set_of_date</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w">
 
  </span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">nrow</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">/</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">msts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">seasonal.periods</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">fourier</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">fuur_test</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">as.data.frame</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fourier</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">K</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">h</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_train</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">value</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">freq</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607m">7</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">stl</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">data_ts</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">s.window</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;periodic&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">robust</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607kc">TRUE</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">new_load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">rowSums</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[<wbr>,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607nf">c</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607m">3</span><span class="m_5853171786120636607p">)])</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">trend_part</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">ts</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[,</span><span class="m_5853171786120636607m">2</span><span class="m_5853171786120636607p">])</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">trend_fit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">auto.arima</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_part</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  </span><span class="m_5853171786120636607n">trend_for</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">as.vector</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">forecast</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">trend_fit</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">mean</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">lag_seas</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[</span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">perio<wbr>d</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">tail</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">new_load</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607o">*</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607p">),</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">fuur</span><span class="m_5853171786120636607p">[(</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607p">,],</span><span class="m_5853171786120636607w">
                             </span><span class="m_5853171786120636607n">Lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">lag_seas</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">party</span><span class="m_5853171786120636607o">::</span><span class="m_5853171786120636607n">ctree</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">Load</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">~</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">.</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_train</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                         </span><span class="m_5853171786120636607n">controls</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">party</span><span class="m_5853171786120636607o">::</span><span class="m_5853171786120636607n">ctree_control</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">teststat</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;quad&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                                         </span><span class="m_5853171786120636607n">testtype</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607s2">&quot;Teststatistic&quot;</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                                         </span><span class="m_5853171786120636607n">mincriterion</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">0.925</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                                         </span><span class="m_5853171786120636607n">minsplit</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                                                         </span><span class="m_5853171786120636607n">minbucket</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">test_lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">decomp_ts</span><span class="m_5853171786120636607o">$</span><span class="m_5853171786120636607n">time.series</span><span class="m_5853171786120636607p">[((</span><span class="m_5853171786120636607n">period</span><span class="m_5853171786120636607o"><wbr>*</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">window</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607m">+1</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607o">:</span><span class="m_5853171786120636607n">N</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607m">1</span><span class="m_5853171786120636607p">]</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">data.table</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">fuur_test</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w">
                            </span><span class="m_5853171786120636607n">Lag</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">=</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">test_lag</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607n">pred_tree</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">&lt;-</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">predict</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">tree_2</span><span class="m_5853171786120636607p">,</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">matrix_test</span><span class="m_5853171786120636607p">)</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607o">+</span><span class="m_5853171786120636607w"> </span><span class="m_5853171786120636607n">trend_for</span><span class="m_5853171786120636607w">
  
  </span><span class="m_5853171786120636607nf">return</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">as.vector</span><span class="m_5853171786120636607p">(</span><span class="m_5853171786120636607n">pred_tree</span><span class="m_5853171786120636607p">))</span><span class="m_5853171786120636607w">
</span><span class="m_5853171786120636607p">}</span></code></pre>
</figure>
<p>I created <code class="m_5853171786120636607highlighter-rouge">plotly</code> boxplots graph of MAPE values from four models – CTREE simple, CTREE with detrending, RPART simple and RPART with detrending. Whole evaluation can be seen in the script that is stored in <a href="https://github.com/PetoLau/petolau.github.io/tree/master/_Rscripts" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://github.com/PetoLau/petolau.github.io/tree/master/_Rscripts&amp;source=gmail&amp;ust=1509512084256000&amp;usg=AFQjCNFOtEYSctwvrkUhaPes6faxTR4tGw">my GitHub repository</a>.</p>
<p></p>
<p>We can see that <strong>detrending time series</strong> of electricity consumption improves the accuracy of the forecast with the combination of both <strong>regression tree</strong> methods – <strong>RPART</strong> and <strong>CTREE</strong>. My approach works as expected.</p>
<p>The habit of my posts is that animation must appear. So, I prepared for you two animations (animated dashboards) using <code class="m_5853171786120636607highlighter-rouge">animation</code>, <code class="m_5853171786120636607highlighter-rouge">grid</code>, <code class="m_5853171786120636607highlighter-rouge">ggplot</code> and <code class="m_5853171786120636607highlighter-rouge">ggforce</code> (for zooming) packages that visualize results of forecasting.</p>
<p><img src="https://ci3.googleusercontent.com/proxy/PqRnMBBUB6xdQ8OQuoEEisb0h5sV93knhpruTSWFS3AmfJeAuOtb7rCXAbaglPlkaiwxESPLgZZnXVWu0O7RubL9Zr_qqI_JXT_sMM7cgZGVnAysUgeVhZSnxSBe0ZX_B3U=s0-d-e1-ft#https://i0.wp.com/petolau.github.io/images/post_5/trendRPART.gif?w=456&amp;ssl=1" alt=""></p>
<p><img src="https://ci3.googleusercontent.com/proxy/niCc4LQrhX-eZRzS6UNkKr2pp5yXQ-P50ZlZ9SA2XWODQDwYcOloYVrbgl_ZfjApXvQ7YBbZojDmIT8jlUpyYUQ8eRvnPktwAVf-4ySnKVPxtGusTJSf5UFDpqGcioHaIOg=s0-d-e1-ft#https://i1.wp.com/petolau.github.io/images/post_5/trendCtree.gif?w=456&amp;ssl=1" alt=""></p>
<p>We can see that in many days it is almost perfect forecast, but on some days it has some potential for improving.</p>
<h2 id="m_5853171786120636607conclusion">Conclusion</h2>
<p>In this post, I showed you how to solve <strong>trend</strong> appearance in <strong>seasonal time series</strong> with using a <strong>regression tree</strong> model. <strong>Detrending time series</strong> for regression tree methods is a important (must) procedure due to the character of decision trees. The trend part of a time series was acquired by STL decomposition and separately forecasted by a simple ARIMA model. I evaluated this approach on the dataset from smart meters measurements of electricity consumption. The regression (decision) tree is a great technique for getting simple and interpretable results in very fast computational time.</p>
<p>In the future post, I will focus on enhancing the predictive performance of simple regression tree methods by ensemble learning methods like Bagging, Random Forest, and similar.</p>
<p class="m_5853171786120636607syndicated-attribution">
<hr>
<a href="https://www.r-bloggers.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/&amp;source=gmail&amp;ust=1509512084256000&amp;usg=AFQjCNEpQVCdpTiU4MwC8R_ZDF8OofDlGg">R-bloggers.com</a> offers <strong><a href="https://feedburner.google.com/fb/a/mailverify?uri=RBloggers" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://feedburner.google.com/fb/a/mailverify?uri%3DRBloggers&amp;source=gmail&amp;ust=1509512084256000&amp;usg=AFQjCNEl7xOhfjQcT99hYT8JJz-2E4OrVA">daily e-mail updates</a></strong> about <a title="The R Project for Statistical Computing" href="https://www.r-project.org/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-project.org/&amp;source=gmail&amp;ust=1509512084256000&amp;usg=AFQjCNH48W9-ovENdSpnymy9vxLAdmAM9Q">R</a> news and <a title="R tutorials" href="https://www.r-bloggers.com/search/tutorial" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/tutorial&amp;source=gmail&amp;ust=1509512084256000&amp;usg=AFQjCNGbAgKWMesEhqp67wMi5hRv3oGzRA">tutorials</a> on topics such as: <a title="Data science" href="https://www.r-bloggers.com/search/data%20science" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/data%2520science&amp;source=gmail&amp;ust=1509512084256000&amp;usg=AFQjCNF5hqthUkvJ65X_Ms7TZagsPCPjtw">Data science</a>, <a title="Big Data" href="https://www.r-bloggers.com/search/Big%20Data" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Big%2520Data&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNF-0hiupiKf2bwj4ZC1Kb1-h86jyQ">Big Data, <a title="R jobs" href="https://www.r-users.com/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-users.com/&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNF3HHeKzAllSD7B6TYIxJidJeWzew">R jobs</a>, visualization (<a title="ggplot and ggplot2 tutorials" href="https://www.r-bloggers.com/search/ggplot2" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/ggplot2&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNFUapzZ2kE1hC44dz8rbzMg3ZAmSA">ggplot2</a>, <a title="Boxplots using lattice and ggplot2 tutorials" href="https://www.r-bloggers.com/search/boxplot" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/boxplot&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNFE02IUvXuca2BOorArDi-gE3VzWw">Boxplots</a>, <a title="Maps and gis" href="https://www.r-bloggers.com/search/map" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/map&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNGYzdUokeNVjtOxPrQP3hxY0QUDNQ">maps</a>, <a title="Animation in R" href="https://www.r-bloggers.com/search/animation" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/animation&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNH8sQRefY1mKYvIGRyN5Dasac9PPA">animation</a>), programming (<a title="RStudio IDE for R" href="https://www.r-bloggers.com/search/RStudio" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/RStudio&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNFkPVH6mqOxOoNgV228oBZcTl2Lcw">RStudio</a>, <a title="Sweave and literate programming" href="https://www.r-bloggers.com/search/sweave" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/sweave&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNHEiZIgbmULUPWae2hwFnPOSs4tMg">Sweave</a>, <a title="LaTeX in R" href="https://www.r-bloggers.com/search/LaTeX" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/LaTeX&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNHcz477tUDxocUfHlt9d-ABTPKBLA">LaTeX</a>, <a title="SQL and databases" href="https://www.r-bloggers.com/search/SQL" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/SQL&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNH0eXGGR95bk7H2tHnYSzXMoyhq1A">SQL</a>, <a title="Eclipse IDE for R" href="https://www.r-bloggers.com/search/eclipse" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/eclipse&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNEPWGVkxuXau7CPT4KQe0Uul9gSgQ">Eclipse</a>, <a title="git and github, Version Control System" href="https://www.r-bloggers.com/search/git" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/git&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNHgVoLArMcW2LuLekITwsCUB7tlJQ">git</a>, <a title="Large data in R using Hadoop" href="https://www.r-bloggers.com/search/hadoop" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/hadoop&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNFNM9ZfiQEDXTMMDv3JSu4nYB64Rw">hadoop</a>, <a title="Web Scraping of google, facebook, yahoo, twitter and more using R" href="https://www.r-bloggers.com/search/Web+Scraping" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/Web%2BScraping&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNGUEbOX5C810m-XZF9DHJ0zzlAr_w">Web Scraping</a>) statistics (<a title="Regressions and ANOVA analysis tutorials" href="https://www.r-bloggers.com/search/regression" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/regression&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNHqaaUyqL0IvcOmqrhM3xhRgAObXg">regression</a>, <a title="principal component analysis tutorial" href="https://www.r-bloggers.com/search/PCA" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/PCA&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNEsR8d9rT3lSqwtgzSIHCX0aLSs4A">PCA</a>, <a title="Time series" href="https://www.r-bloggers.com/search/time+series" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/time%2Bseries&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNFCsA0e39trVE0dZ60spGK_rT6EHw">time series</a>, <a title="finance trading" href="https://www.r-bloggers.com/search/trading" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://www.r-bloggers.com/search/trading&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNGKclsVCpI2G9woN6ca1AYAXjwV8w">trading</a>) and more...
</a></div></p><img src="https://ci4.googleusercontent.com/proxy/02ld0lYPWuts4T0fBAQG3r2VlFjXrepytjQAACs6vzLpzGEqoQsAA-thGGzv78D9YVP0cwJ__Qcr3cX3ld7X-FlsFWpw58rgCxODfnq3HNPki2iAtMxolonuy0549W6Cvf1uh9VYdacPLf25vV8nxSapYTw=s0-d-e1-ft#http://feeds.feedburner.com/~r/RBloggers/~4/n22byVOjaos?utm_source=feedburner&amp;utm_medium=email" height="1" width="1" alt=""><p>This posting includes an audio/video/photo media file: <a>Download Now</a>
</p>
</div>
</td>
</tr>
<tr>
<td style="margin-bottom:0;line-height:1.4em">
<p style="margin:1em 0 3px 0">
<a name="m_5853171786120636607_7" style="font-family:Arial,Helvetica,sans-serif;font-size:19px" href="http://feedproxy.google.com/~r/RBloggers/~3/qGxkzA07DLY/?utm_source=feedburner&amp;utm_medium=email" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://feedproxy.google.com/~r/RBloggers/~3/qGxkzA07DLY/?utm_source%3Dfeedburner%26utm_medium%3Demail&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNFY-jAwW1-FPU1Ms9ntYa6q7pYlfg">Free simmer hexagon stickers!</a>
</p>
<p><img src="https://ci3.googleusercontent.com/proxy/9Wftl_92zVoWLp20nm9Thvw5AtNcwYrnVtkhSFV8IzY8QvsPNQFxWu1Yr8uXKnpFuyuKoukBuFzFj7hiApBCayWx=s0-d-e1-ft#http://r-simmer.org/images/simmer-hex-01.svg" alt="design1" style="width:200px"><br>
<img src="https://ci6.googleusercontent.com/proxy/GdB--cH7QndpBc3VFbB-t6ghZcHQRgxBFbcrlgiXf-Z0oqmYPDpfXUtBQhaTdCgg0q_C7ApW6DyinAvjUQl8o3fr=s0-d-e1-ft#http://r-simmer.org/images/simmer-hex-02.svg" alt="design2" style="width:200px"></p>
<p>Do you want to get your own <code class="m_5853171786120636607highlighter-rouge">simmer</code> hexagon sticker? Just fill in <a href="https://docs.google.com/forms/d/19mrtbQAuCODcKMWpubreSGboF4Dyi2HSEnV545AXqLM/" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://docs.google.com/forms/d/19mrtbQAuCODcKMWpubreSGboF4Dyi2HSEnV545AXqLM/&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNHH1P3dDXptTpC9ZJOG77qpOZxtgg">this form</a> and get one send to you for free.</p>
<p>Check out <a href="http://fishyoperations.com/2017/08/21/r-simmer.org" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=http://fishyoperations.com/2017/08/21/r-simmer.org&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNGKks13bCxOTrYswENIMfAk1JriQQ">r-simmer.org</a> or <a href="https://cran.r-project.org/web/packages/simmer/index.html" rel="nofollow" target="_blank" data-saferedirecturl="https://www.google.com/url?hl=en&amp;q=https://cran.r-project.org/web/packages/simmer/index.html&amp;source=gmail&amp;ust=1509512084257000&amp;usg=AFQjCNHpMEemwda_w6Z9xOSK-SDMCktrIQ">CRAN</a> for more information on <code class="m_5853171786120636607highlighter-rouge">simmer</code>, a discrete-event simulation package for R.</p>
<br><br><br><br><br>
<script>
  $(function() {
    var toc = $('#toc>ul');

    function makeLi(text, href) {
      return $('<li><a href="' + href + '" target="_self">' + text + '</a></li>');
    }

    $('a[name]').each(function(i) {
      var chapter = $(this), chapterNumber = i + 1;
      toc.append(
        makeLi(chapter.text(), '#chapter-' + chapterNumber)
      );
      chapter.attr('id', 'chapter-' + chapterNumber);
    });

  });
</script>
</body>
</html>
