<base target="_blank"><html><head><title>成交金额排序表</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!--script src="https://code.jquery.com/jquery-3.6.0.min.js"></script-->
<script src="https://williamkpchan.github.io/lazyload.min.js"></script>
<script src='https://williamkpchan.github.io/mainscript.js'></script>
<script src="https://williamkpchan.github.io/commonfunctions.js"></script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
<script src="measuretrend.js"></script>
<script type="module" src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
<script> var showTopicNumber = false; var topicEnd = "<br>"; var bookid = "pppp"; var markerName = "h3, h4, pk" </script>
<style>
body{width:80%;margin-left: 10%; font-size:24px;}
img {max-width:100%; display: inline-block; margin-top: 2%;margin-bottom: 1%; border-radius:3px; background-color:#149;}
</style></head><body onkeypress="chkKey()"><center>

<h2>成交金额排序表</h2>
<center>
<span id="dateAndTime" class="imp"><script>showDateAndTime();</script></span>
<table id="stockTable">
  <thead>
    <tr>
      <th>编号</th>
      <th>股名</th>
      <th>价格变化 %</th>
      <th>成交金额变化 %</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows will be inserted here -->
  </tbody>
</table>
</center><br><br>

<script>
const codetable = ['02800','00700','09988','03690','00883','02828','01810','01024','00857','00939','02318','09926','01299','03033','03968','00941','01398','00522','09618','00388','00386','00005','01211','02899','03988','09999','01088','09888','00016','01288','02015','02269','09868','09961','01816','02382','00992','01919','01109','00981','00836','00001','09633','01093','02601','01910','00027','00669','06690','02020','00011','02388','00916','01928','00020','00175','02628','00291','01833','01378','00728','02359','09626','00002','02331','06862','01113','00780','00006','01801','01171','00762','09901','02688','03993','06618','01548','02618','09992','00288','06160','02319','01766','00285','01972','01800','00003','00960','06030','01658','00966','01138','02057','00688','06881','01336','03908','02313','01898','00968','02333','03692','03328','01347','01038','03888','09987','01339','01177','02018','02328','01099','02883','00135','01193','01876','06865','02338','01209','03800','00316','01818','00358','02600','01071','01913','00241','00019','01997','03067','02380','00868','03998','02202','00322','02588','00819','00998','00384','00763','01787','02099','00101','00425','00914','03898','00570','01797','00390','00257','00267','00012','00066','06186','00270','00881','03320','02400','00136','02013','03618','01066','01908','01030','00683','06823','01798','03323','01208','03759','01952','06088','01918','01772','00467','01186','03969','01302','00921','01357','06110','09969','01929','02666','00772','06078','00696','03311','00293','00371','03900','00956','02162','02607','00991','06855','02238','00083','01776','02386','06818','00220','00576','06060','01157','00017','06830','03808','01044','02357','00142','03347','01359','06098','01415','00354','01179','00014','03110','02196','01128','00189','03032','00123','01896','02343','00934','00867','01368','00995','00177','00552','01883','00639','00151','09922','00489','00152','00148','00586','01381','01530','00853','02208','01882','00813','03360','00799','00598','02096','00667','09698','01610','01618','02888','01821','03738','06066','02186','06699','00880','02128','00884','01072','06886','00874','01070','01516','00551','06049','02669','02257','01513','09995','02255','00694','01681','01999','01508','00631','01478','01951','01385','00777','01448','00302','01055','00525','01199','02039','01060','03613','00004','00579','00338','00817','02869','02638','00856','00548','01963','06869','00081','00363','00590','00303','01958','00200','03377','00317','03709','01579','01316','00656','01119','01811','00341','06099','00909','02689','03319','00087','03958','02233','00297','01907','02145','02276','01888','01313','00861','01310','00038','06185','09668','09959','02777','00345','00010','03899','01666','02005','09966','00460','02877','00023','01238','00440','06808','00179','00855','00596','02866','02285','00347','06666','01995','01877','02362','06127','01428','01691','02158','01515','02155','03983','01600','00165','02801','00710','09911','00708','00670','02611','00357','02252','00308','00823','01613','02009','02823','02822','07226','07299','02840','01858','01860','07200','07288','03037','00412','00751','02727','02356','02342','06178','03188','00778','00636','07568','07522','07552','00182','07500','03606','06969','00268','00144','00564','03668','00300','06181','01698','02556','01164','01468'];
const BaseObj = {};
const allResults = {};

  // prepare basic materials
  const baseurl = "http://sqt.gtimg.cn/?q=";
  const chunkSize = 64;
  const chunks = [];
  const urlReqStr = [];

  for (let i = 0; i < codetable.length; i += chunkSize) {
    chunks.push(codetable.slice(i, i + chunkSize));
  }

  for (let i = 0; i < chunks.length; i++) {
    urlReqStr.push(baseurl + chunks[i].map(element => "r_hk" + element).join(","));
  }


// Function to collect data for all stock codes
async function collectAllData() {
  const promises = codetable.map(stknum => collectdata(stknum));
  await Promise.all(promises);
  console.log("All data collected:");
}

// Function to collect data for a single stock code
async function collectdata(stknum) {
  const stkcode = "hk" + stknum;
  const url = "https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=" + stkcode + ",day,,,10,qfq";

  try {
    const responseText = await $.get(url);
    const jsonString = responseText.split("=")[1];
    const jsonData = JSON.parse(jsonString);
    const stockName = jsonData.data[stkcode].qt[stkcode][1];

    // Check if qfqday or day exists
    const stockData = jsonData.data[stkcode].qfqday || jsonData.data[stkcode].day;

    if (!stockData || !Array.isArray(stockData)) {
      throw new Error(`Invalid/missing stock data for ${stkcode} ${url}`);
    }

    // Get the array
    const amtArray = stockData.map(row => Number(row[8]));
    const highArray = stockData.map(row => Number(row[3]));
    const lowArray = stockData.map(row => Number(row[4]));

    const avgAmt = Math.round(averageOfLastTen(amtArray));
    const maxH = Math.max(...highArray);
    const minL = Math.min(...lowArray);

    // Store the result in BaseObj
    BaseObj[stknum] = { stockName, avgAmt, maxH, minL };
  } catch (error) {
    console.error(`Error ${stknum}:`, error);
  }
}

// Function to calculate the average of the last 10 elements
function averageOfLastTen(arr) {
  if (arr.length < 10) {
    throw new Error("Array must have at least 10 elements");
  }
  const lastTen = arr.slice(-10);
  const sum = lastTen.reduce((acc, val) => acc + val, 0);
  return sum / 10;
}

// Function to calculate the current amount position
function calcCurAmtPosition(amtArray) {
  const amtavg = averageOfLastTen(amtArray);
  const lastAmt = amtArray[amtArray.length - 1];
  let curAmtPosition = Math.round((lastAmt / amtavg) * 100);

  return curAmtPosition;
}

// Function to fetch data chunks
async function fetchDataChunks(url) {
  try {
    const response = await fetch(url);
    const data = await response.text();
    const rows = data.split(";");

    rows.forEach(row => {
      const columns = row.split("~");
      if (columns.length > 1) {
        const stockCode = columns[2]; // e.g., "s_hk00700"
        const stknum = stockCode.replace("s_hk", ""); // Extract stock code (e.g., "00700")

        // Check if BaseObj has data for this stock code
        if (BaseObj[stknum] && BaseObj[stknum].avgAmt) {
          const currentAmt = parseFloat(columns[37]); // Current amount from the API
          const avgAmt = BaseObj[stknum].avgAmt; // Average amount from BaseObj
          const stkname = BaseObj[stknum].stockName
          const codeStr = `<r onclick="xunbao('` + columns[2] + `')">`+ columns[2] + "</r>"

          // Calculate the percentage
          const amtPercentage = Math.round((currentAmt / avgAmt)/100); // unit size diff
            // console.log("stknum ",stknum,"name",stkname,"pct",columns[31]," avgAmt ",avgAmt,'currentAmt',currentAmt," amtPercentage",amtPercentage)

          // Store the result in allResults
          allResults[stknum] = {
            code: codeStr,
            name: stkname,
            pct: columns[32],
            amt: amtPercentage, // Replace amt with the calculated percentage
          };

        } else {
          console.warn(`No BaseObj data found for stock code: ${stknum}`);
        }
      }
    });
  } catch (error) {
    console.error("Error fetching data:", error);
  }
}

// Function to update the HTML page with sorted data
function updateHTML() {
  const sortedResults = Object.keys(allResults).sort((a, b) => {
    return allResults[b].amt - allResults[a].amt;
  });

  const tableBody = document.getElementById('stockTable').getElementsByTagName('tbody')[0];
  tableBody.innerHTML = '';

  sortedResults.forEach(stockCode => {
    const row = tableBody.insertRow();
    const cell1 = row.insertCell(0);
    const cell2 = row.insertCell(1);
    const cell3 = row.insertCell(2);
    const cell4 = row.insertCell(3);

    cell1.innerHTML  = allResults[stockCode].code;
    cell2.textContent = allResults[stockCode].name;
    cell3.textContent = allResults[stockCode].pct;
    cell4.textContent = allResults[stockCode].amt;
  });
}

function xunbao(xunbaocode) {
       localStorage.setItem("randomcode", xunbaocode)
       localStorage.setItem("otherCode", xunbaocode)
       localStorage.setItem("stkCode", xunbaocode)

       window.open("Random Charts.html");
       // locs = ["HIghLowTrend.html", "Random Charts.html", ]
       //  window.open("HIghLowTrend.html")
}


// Main function to run the data collection and update process
async function main() {
  await collectAllData();
  await updateInfo();
}

async function updateChanges() {
  const timearr = showTime().split(':')
  const timestr = timearr[0]+timearr[1]
  if(!(Number(timestr)>929 && Number(timestr)<1201 || 
       Number(timestr)>1259 && Number(timestr)<1601)){
    document.getElementById("dateAndTime").innerHTML ="<lg>"+showDate() +"</lg> "+ showTime() + "<o> Market Closed</o>";
    return
  }
  await updateInfo()
}

async function updateInfo() {
  for (let i = 0; i < urlReqStr.length; i++) {
    await fetchDataChunks(urlReqStr[i]);
    // console.log(urlReqStr[i])
  }
  updateHTML();
  $("#dateAndTime").html("<y>"+showDate() +"</y> "+ showTime())
}

// Start the main process
main();
setInterval(updateChanges, 60000);

</script>







<script src='https://williamkpchan.github.io/LibDocs/readbook.js'></script>
<script>
var lazyLoadInstance = new LazyLoad({
 elements_selector: ".lazy"
});

</script>
</center></bodpk>
</html>
