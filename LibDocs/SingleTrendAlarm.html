<base target="_blank"><html><head><title>SingleTrendAlarm</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.js"></script>
<script src="https://williamkpchan.github.io/lazyload.min.js"></script>
<script src='https://williamkpchan.github.io/mainscript.js'></script>
<script src="https://williamkpchan.github.io/commonfunctions.js"></script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
<script src="https://williamkpchanhp.github.io/LibDocs/longHistList.js"></script>
<script src="https://williamkpchanhp.github.io/codeList.js"></script>
<script src="measuretrend.js"></script>
<script src='https://cdn.plot.ly/plotly-2.35.2.min.js'></script>

<script>  var showTopicNumber = false; var topicEnd = "<br>"; var bookid = "pppp"; var markerName = "h3" </script>
<style>
body{width:80%;margin-left: 10%; font-size:24px;}
img {max-width:100%; display: inline-block; margin-top: 2%;margin-bottom: 1%; border-radius:3px; background-color:#149;}
#checkdata {font-size:16px;}
#RptMsg {font-size:16px;}
#trendChart {height:500px;}
#priceChart {height:500px;}

</style></head><body onkeypress="chkKey()"><center>
<h2>Single Stock Trend Alarm</h2>

<div id='dateTime'></div>
<div id='stkNum'></div>
<br>
AmtWeight
<br>
<div id='trendChart'></div>
<div id='checkdata'></div>
<br>
trend
<br>
<div id='priceChart'></div>
<div id='RptMsg'></div>

<script>
 // init parameters
  codetable = [];
  if(sessionStorage.getItem("codeNum")!== null){
    codeNum = sessionStorage.getItem("codeNum")
  }else{
    codeNum = prompt("Enter Code Number:", "深证：399001 上证：sh000001 恒指：HSI");
  }

  codeNumWidth = codeNum.length

  //toneBeep.mp3 lowBeep.mp3
  var uXSound = new Audio('./mp3/toneBeep.mp3'); 
  var dXSound = new Audio('./mp3/lowBeep.mp3'); 

  if(codeNum == "sh000001"){codeNumWidth = 6}

  codetable.push(codeNum)
  //mustAdd = mustAdd.split(" ")
  //codetable = codetable.concat(mustAdd)
  codetable = [...new Set(codetable)]
  document.getElementById("stkNum").innerHTML = "<o>"+codeNum + "</o>" + " <u>Total stks</u>: "+ codetable.length

  fraudSTK = fraudSTK.split(" ")
  ignoreSTK = ignoreSTK.split(" ")
  fraudSTK = fraudSTK.concat(ignoreSTK)
  fraudSTK = [...new Set(fraudSTK)]

  codetable = codetable.filter(val => !fraudSTK.includes(val));
  codetableLen = codetable.length
  allmtweight = 0
  amtweightArr = []
  priceArr = []
  priceDiffrec = 0
     period = 5;
     stkList = 恒指成分.split(' ');
  //SampInterval = Number(prompt("Enter Sampling Interval in sec:", ""));
  //startIntv = SampInterval*60/5;
  SampInterval = 15;
  startIntv = 16;
  // amtratio = prompt("Enter amt ratio (1:1000):", "");
  // if(amtratio !=""){
  //   amtratio = Number(amtratio)
  // }else{
  // }
    amtratio = 1
  document.getElementById("dateTime").innerHTML ="<lg>"+showDate() +"</lg> "+ showTime();

  timerloop()
  setInterval(timerloop, SampInterval*1000); // try again in 1 minute

    function timerloop() {
      // loop to collect data and chkCross, results in here
      timestr = showTime()
      timestr = timestr.split(':')
      timestr = timestr[0]+timestr[1]

      if(codeNumWidth == 6){
        if(!(Number(timestr)>929 && Number(timestr)<1131 || 
           Number(timestr)>1259 && Number(timestr)<1501)){
          document.getElementById("dateTime").innerHTML ="<lg>"+showDate() +"</lg> "+ showTime() + "<r> Closed</r>";
          return
        }
      }else{
        if(!(Number(timestr)>929 && Number(timestr)<1201 || 
           Number(timestr)>1259 && Number(timestr)<1601)){
          document.getElementById("dateTime").innerHTML ="<lg>"+showDate() +"</lg> "+ showTime() + "<r> Closed</r>";
          return
        }
      }

     thestkdata = [];
     dateLst = [];
     openLst = [];
     highLst = [];
     lowLst = [];
     midLst = [];
     closeLst = [];
     amtLst = [];
     stkName = "";
      dataStatus = "M"
      intv1 = startIntv
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
      halfNum = Math.round(intv1/2)

      stkpriceDataArr = [];
      stkPointer = 0;
      starti = 0;

      // main loop
      allweight = 0
      for (var i = 0; i < codetable.length; i++) {
         collectStkData(codetable[i])
      }
      allmtweight = Math.round(allmtweight)
      priceArr.push(Math.round(priceDiffrec*1000)/10)
        //console.log("afterloop allmtweight ", allmtweight)
        amtweightArr.push(allmtweight)
        if(amtweightArr.length ==1 && amtweightArr[0]==0){
           amtweightArr.pop()
           return
        }
        //document.getElementById("checkdata").innerHTML = JSON.stringify(amtweightArr);

        allmtweight = 0
        // draw the chart
        amtweightArr1 = amtweightArr

        amtweightArr2 = makeMovAve(amtweightArr, halfNum)
        amtweightArr3 = makeMovAve(amtweightArr, intv1)
        amtweightArr4 = makeMovAve(amtweightArr, intv2)
        amtweightArr5 = makeMovAve(amtweightArr, intv3)
        amtweightArr6 = makeMovAve(amtweightArr, intv4)

        amtweightArr2 = amtweightArr2.fill(null,0,halfNum)
        amtweightArr3 = amtweightArr3.fill(null,0,intv1)
        amtweightArr4 = amtweightArr4.fill(null,0,intv2)
        amtweightArr5 = amtweightArr5.fill(null,0,intv3)
        amtweightArr6 = amtweightArr6.fill(null,0,intv4)

        stdDev = makeStd(amtweightArr1, intv3)
        Devadd = amtweightArr3.map((a, i) => a + stdDev[i]);
        Devminus = amtweightArr3.map((a, i) => a - stdDev[i]);
        Devadd = Devadd.fill(null,0,intv3)
        Devminus = Devminus.fill(null,0,intv3)

        stdDev4 = makeStd(amtweightArr1, intv4)
        Devadd4 = amtweightArr4.map((a, i) => a + stdDev4[i]);
        Devminus4 = amtweightArr4.map((a, i) => a - stdDev4[i]);
        Devadd4 = Devadd4.fill(null,0,intv4)
        Devminus4 = Devminus4.fill(null,0,intv4)

        stdDev5 = makeStd(amtweightArr1, intv5)
        Devadd5 = amtweightArr5.map((a, i) => a + stdDev5[i]);
        Devminus5 = amtweightArr5.map((a, i) => a - stdDev5[i]);
        Devadd5 = Devadd5.fill(null,0,intv5)
        Devminus5 = Devminus5.fill(null,0,intv5)

        drawPlotlychart()


        // draw the pricechart
        priceArr1 = priceArr

        priceArr2 = makeMovAve(priceArr, halfNum)
        priceArr3 = makeMovAve(priceArr, intv1)
        priceArr4 = makeMovAve(priceArr, intv2)
        priceArr5 = makeMovAve(priceArr, intv3)
        priceArr6 = makeMovAve(priceArr, intv4)

        priceArr2 = priceArr2.fill(null,0,halfNum)
        priceArr3 = priceArr3.fill(null,0,intv1)
        priceArr4 = priceArr4.fill(null,0,intv2)
        priceArr5 = priceArr5.fill(null,0,intv3)
        priceArr6 = priceArr6.fill(null,0,intv4)

        pricestdpriceDev = makeStd(priceArr1, intv3)
        priceDevadd = priceArr3.map((a, i) => a + pricestdpriceDev[i]);
        priceDevminus = priceArr3.map((a, i) => a - pricestdpriceDev[i]);
        priceDevadd = priceDevadd.fill(null,0,intv3)
        priceDevminus = priceDevminus.fill(null,0,intv3)

        pricestdpriceDev4 = makeStd(priceArr1, intv4)
        priceDevadd4 = priceArr4.map((a, i) => a + pricestdpriceDev4[i]);
        priceDevminus4 = priceArr4.map((a, i) => a - pricestdpriceDev4[i]);
        priceDevadd4 = priceDevadd4.fill(null,0,intv4)
        priceDevminus4 = priceDevminus4.fill(null,0,intv4)

        pricestdpriceDev5 = makeStd(priceArr1, intv5)
        priceDevadd5 = priceArr5.map((a, i) => a + pricestdpriceDev5[i]);
        priceDevminus5 = priceArr5.map((a, i) => a - pricestdpriceDev5[i]);
        priceDevadd5 = priceDevadd5.fill(null,0,intv5)
        priceDevminus5 = priceDevminus5.fill(null,0,intv5)

        drawPricechart()
        document.getElementById("dateTime").innerHTML =showDate() +" "+ showTime();

        $("#RptMsg").html("");
        checkRptMsg(priceArr1, priceArr3, 1, 2)
        checkRptMsg(priceArr2, priceArr3, 2, 3)
        checkRptMsg(priceArr2, priceArr4, 2, 4)
        checkRptMsg(priceArr2, priceArr5, 3, 4)
        checkRptMsg(priceArr3, priceArr4, 3, 5)
        checkRptMsg(priceArr3, priceArr5, 4, 5)
        checkRptMsg(priceArr4, priceArr6, 4, 6)

        $("#RptMsg").append("<br>");
        checkUpDn(priceArr1, 1)
        checkUpDn(priceArr2, 2)
        checkUpDn(priceArr3, 3)
        checkUpDn(priceArr4, 4)
        checkUpDn(priceArr5, 5)
        checkUpDn(priceArr6, 6)
    }


      // drawPlotlychart
      function drawPlotlychart() {
        traceLine1 = { type: 'scatter', y: amtweightArr1, name: 'L1',
                      line: { color: '#f00', width: 1 } };
        traceLine2 = { type: 'scatter', y: amtweightArr2, name: 'L2',
                      line: { color: '#c00', width: 1 } };
        traceLine3 = { type: 'scatter', y: amtweightArr5, name: 'L5',
                      line: { color: '#a80', width: 2 } };

        traceLineLA = { type: 'scatter', y: Devadd, name: 'LA',
                      line: { color: '#000', width: 1 } };
        traceLineLM = { type: 'scatter', y: Devminus, name: 'LM',
                      line: { color: '#000', width: 1 } };
        traceLineA4 = { type: 'scatter', y: Devadd4, name: 'LA4',
                      line: { color: '#000', width: 2 } };
        traceLineM4 = { type: 'scatter', y: Devminus4, name: 'LM4',
                      line: { color: '#000', width: 2 } };
        traceLineA5 = { type: 'scatter', y: Devadd5, name: 'LA5',
                      line: { color: '#f00', width: 2 } };
        traceLineM5 = { type: 'scatter', y: Devminus5, name: 'LM5',
                      line: { color: '#f00', width: 2 } };

        plotdata = [traceLine1,traceLine2,traceLine3,traceLineLA,traceLineLM,traceLineA4,traceLineM4,traceLineA5,traceLineM5];
        layout = { title: theStartCode + " " + stkName,
                   // plot_bgcolor:'black',
                   // gridcolor:'#ccc',
                   //paper_bgcolor:"rgb(20,20,20,0)",
                 };


        Plotly.newPlot('trendChart', plotdata, layout);
      }

      function drawPricechart() {
        traceLine1 = { type: 'scatter', y: priceArr1, name: 'L1',
                      line: { color: '#f00', width: 1 } };
        traceLine2 = { type: 'scatter', y: priceArr2, name: 'L2',
                      line: { color: '#c00', width: 1 } };
        traceLine3 = { type: 'scatter', y: priceArr3, name: 'L3',
                      line: { color: '#a00', width: 1 } };

        traceLineLA = { type: 'scatter', y: priceDevadd, name: 'LA',
                      line: { color: '#000', width: 1 } };
        traceLineLM = { type: 'scatter', y: priceDevminus, name: 'LM',
                      line: { color: '#000', width: 1 } };
        traceLineA4 = { type: 'scatter', y: priceDevadd4, name: 'LA4',
                      line: { color: '#000', width: 2 } };
        traceLineM4 = { type: 'scatter', y: priceDevminus4, name: 'LM4',
                      line: { color: '#000', width: 2 } };
        traceLineA5 = { type: 'scatter', y: priceDevadd5, name: 'LA5',
                      line: { color: '#f00', width: 2 } };
        traceLineM5 = { type: 'scatter', y: priceDevminus5, name: 'LM5',
                      line: { color: '#f00', width: 2 } };

        plotdata = [traceLine1,traceLine2,traceLine3,traceLineLA,traceLineLM,traceLineA4,traceLineM4,traceLineA5,traceLineM5];
        layout = { title: theStartCode + " " + stkName,
                   // plot_bgcolor:'black',
                   // gridcolor:'#ccc',
                   //paper_bgcolor:'#000',
                 };
        Plotly.newPlot('priceChart', plotdata, layout);
      }


      function updateStat(statname) {
      // update stat
        prevstat = localStorage.getItem(statname);
        if (prevstat === null) { prevstat = "" }

        currentStat = document.getElementById("currentstatistics").innerHTML
        document.getElementById("prevstatistics").innerHTML = prevstat +",<br>"+ currentStat
        localStorage.setItem(statname, 
        document.getElementById("prevstatistics").innerHTML)
        window.location = '#currentstatistics';
        window.scrollTo(window.scrollX, window.scrollY - 400);
      }

      function removerec(statname) {
        currentStat = document.getElementById("prevstatistics").innerHTML
        currentStat = currentStat.split(',<br>')
        currentStat.shift();
        //currentStat.pop();
        localStorage.setItem(statname, currentStat)
        document.getElementById("prevstatistics").innerHTML = currentStat
      }

      function askforCode() {
        var tempCode = prompt("Code Number:", "");
        if (tempCode != null && tempCode != ""){

            codewidth = tempCode.length
            if(codewidth <= 5){
              theCode = "00000"+tempCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }else{
              theCode = tempCode
            }

           storeCode(theCode)
           collectStkData(theCode)
        }
      }

      function collectStkData(theCode) {
          if( theCode.substring(0, 2) == "us"){
              // number of day klines shold be small to avoid slow response, even drop out
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/usfqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,30,qfq';
              imageCode = theCode
          }else{

            if(theCode == "110000"){
             theCode = "HSI"; imageCode = "110000"
            }

          codewidth = theCode.length
          if(theCode == "HSI"){
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,30,qfq';
              imageCode = "110000"
          }else if(theCode == "sh000001"){
              codewidth = 6
              imageCode = theCode+".sh"; // note this comes before following line
              theStartCode = theCode
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,30,qfq';
          }else{
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
              theStartCode = theCode
              imageCode = theCode
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,30,qfq';
            }else{
              codewidth = theCode.length
              if((codewidth == 6) && !hsReservedCode.includes(theCode)){
                 if (theCode.charAt(0) == "6"){
                    imageCode = theCode+".sh"; // note this comes before following line
                    theCode = "sh"+theCode; 
                 }else{
                    imageCode = theCode+".sz";
                    theCode = "sz"+theCode
                 }
                 theStartCode = theCode
                 theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,30,qfq';
              }else if(codewidth == 9){
                imageCode = theCode
                theCode = theCode.substring(7, 9) + theCode.substring(0, 6);
                theStartCode = theCode

                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,30,qfq';
              }else{
                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,30,qfq';
                theStartCode = theCode
                imageCode = theCode
              }
            }
          }
        }

          theStartCode = theCode;
          thedrawdata = [];
          mtweight = 0
          amtLst.length = 0;

          $.get(theurl).done(function(rawJSON) { 
              rawJSON = eval(rawJSON)
              var keys = Object.keys(rawJSON); // read the structure keys ["code", "msg", "data"]

              var insideDatakey = Object.keys(rawJSON)[2] //
              // myobj[Object.keys(myobj)[0]] this is the extract method
      
              var thedata = rawJSON[Object.keys(rawJSON)[2]]
              thestkkey = Object.keys(thedata)[0] // this is the stk key name
              var tempdata = thedata[Object.keys(thedata)[0]];
              thestkdata = tempdata[Object.keys(tempdata)[0]]; // real data here, this is whole dataset

              if(thestkdata.length == 0){alert("no data in: " + thestkkey)}

              for(i=(thestkdata.length-12);i<thestkdata.length;i++){
                    thedate = thestkdata[i][0];  // date
                    if(codewidth <= 5){
                      theAmtIdx = 8;
                    }else{
                      theAmtIdx = 5;
                    }

                    theamt = Math.round(Number(thestkdata[i][theAmtIdx]));
                    if(codewidth > 5){
                      if(theCode.slice(0, 5) == "sh688"){
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/10000);
                      }else{
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/100);
                      }
                    }

                    theamt = theamt.toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",");
                    $("#turnover").prepend( theamt,"w ");
              }
      
              theNameObj = tempdata[Object.keys(tempdata)[1]];
              theNameObjName  = theNameObj[Object.keys(theNameObj)[0]];
              stkName = theNameObjName[1]

              /* data is arranged in days array, tempdata[320] is last set
              tempdata[320][0]  // date, tempdata[320][1]  // open, tempdata[320][3]  // high
              tempdata[320][4]  // low, tempdata[320][2]  // close */
      
              //period + intv1, the chartwidth + max trend interval
              starti = thestkdata.length - (parseInt(period) + parseInt(intv1)) -5; 
              if(starti <= 0){
                  $('#notEnoughData').append(theStartCode + " " + stkName +" dataLength: " + thestkdata.length+ " ")
                  return;
              }

              dateLst = [];
              openLst = [];
              highLst = [];
              lowLst = [];
              midLst = [];
              closeLst = [];
              amtLst = [];

              for (let i = starti; i < thestkdata.length; i++) {
                  dateLst.push(thestkdata[i][0]);
                  openLst.push(Number(thestkdata[i][1]));
                  highLst.push(Number(thestkdata[i][3]));
                  lowLst.push(Number(thestkdata[i][4]));
                  midLst.push((Number(thestkdata[i][3]) + Number(thestkdata[i][4]))/2);
                  closeLst.push(Number(thestkdata[i][2]));

                  if(codewidth == 6){
                  amtvalue = Math.round(Number(thestkdata[i][5]));
                  }else{
                  amtvalue = Math.round(Number(thestkdata[i][8]));
                  }

                  amtLst.push(amtvalue);

              }
              // redraw();  // this line must be inside the AJAX because AJAX run last

              lastPrice = closeLst[closeLst.length-1]
              prevPrice = closeLst[closeLst.length-2]
              priceDiff = (lastPrice - prevPrice)/lastPrice
              priceDiffrec = priceDiff
              lastamt = amtLst[amtLst.length-1]
              //if(codewidth == 6){
              //  lastamt = Number(lastamt)
              //}else{
              //  lastamt = Number(lastamt.replace(/^.*?;|w.*/g, "").replace(/,/g, ""))
              //}

              mtweight = priceDiff * lastamt/amtratio // calc the mtweight for final summation

              if(lastamt > 0){
                allmtweight = allmtweight + mtweight // sum the allmtweight
              }else{
                console.log("lastamt = 0")
              }
           });
      }

     function chkKey() {
       var testkey = getChar(event);
       if(testkey == 't'){window.location = '#dateTime';
        window.scrollTo(window.scrollX, window.scrollY - 100);}
       else if(testkey == 'a'){window.location = '#trendChart';}
       else if(testkey == 's'){window.location = '#priceChart';}
       else if(testkey == 'S'){window.open("SingleTrendAlarm.html");}

       else if(testkey == 'X'){storeCode(codetable[0]); window.open("Random Charts.html");}
       //else if(testkey == '.'){storeCode(codetable[0]); window.open("mlineMinutechart.html");}
       else if(testkey == '.'){storeCode(codetable[0]); window.open("modminuteLayersAcc.html");}
       else{chkOtherKeys(testkey)} 
     }

     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

     function xunbao(xunbaocode) {
       localStorage.setItem("randomcode", xunbaocode)
       localStorage.setItem("otherCode", xunbaocode)
       localStorage.setItem("stkCode", xunbaocode)

       window.open("Random Charts.html");
       // locs = ["HIghLowTrend.html", "Random Charts.html", ]
       //  window.open("HIghLowTrend.html")
     }

	function fillLineData() {
      var dataArr = prompt("Enter data array sep by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        redraw()
      }
     }

      function addToquickCodeList() {
        codewidth = theCode.length
        if(codewidth <= 5){
          theCode = "00000"+theCode;
          codewidth = theCode.length;
          theCode = theCode.slice(codewidth-5, codewidth);
        }
        if (!quickCodeList.includes(theCode)) {
          quickCodeList.push(theCode);
          quickCodeList = Array.from(new Set(quickCodeList)); // set unique
          localStorage.savedCodeList = quickCodeList;
          alert(theCode + " added to quickCodeList")
        }else{alert(theCode + " already exist!")}
      }

    function usequickCodeList() {
        stkList = quickCodeList;
        alert("quickCodeList Total: " + quickCodeList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("quickCodeList Total: " + quickCodeList.length + "\n"+stkList);
    }

    function usestkListArr() {
      stkListArr = localStorage.getItem("stkListArr")
      if (stkListArr === null) {
         stkList = quickCodeList;
      } else{
         stkList = stkListArr;
      }
        alert("Use stkListArr, Total: " + stkListArr.length + " : "+stkListArr)
        $("#message").text("stkListArr Total: " + stkListArr.length + "\n"+stkList);
    }

	function addToAttentionList() {
            codewidth = theCode.length
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }

        attentionList.push(theCode)
        attentionList = [...new Set(attentionList)]; // set unique

        ItemIndex = attentionList.indexOf("");  // remove empty items
        if (ItemIndex > -1) { attentionList.splice(ItemIndex, 1); }

        localStorage.setItem("attentionList", attentionList);
        alert(theCode + " added to attentionList!")
     }
	function removeFmquickCodeList() {
        ItemIndex = quickCodeList.indexOf(theCode);
        if (ItemIndex > -1) { quickCodeList.splice(ItemIndex, 1); }
        quickCodeList = [...new Set(quickCodeList)]; // set unique
        localStorage.setItem("quickCodeList", quickCodeList);
        alert(theCode + " removed fm quickCodeList!")
   }

     function redraw() { // includes main chart and aux charts
        initIntvSteps()
        titleText = showDate() +" "+ showTime()+", p1: "+intv1 +" w: "+(thestkdata.length-starti) +"\n"+theStartCode + " " + stkName + " 日線 ";
        $("#amtLst").html("Amt: ".concat(amtLst.slice((amtLst.length-14),amtLst.length).join("")));

 
        RGraph.reset(document.getElementById('cvs'));

        stkpriceDataArrC = closeLst
        stkpriceDataArrL = lowLst
        stkpriceDataArrM = midLst
        stkpriceDataArrH = highLst
        stdDevH = makeStd(highLst, intv3)
        stdDevL = makeStd(lowLst, intv3)

specialBackUp = lowLst.slice();  // backup array to avoid shadow changes
        newDevadd = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a + stdDevH[i]);
        newDevminus = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a - stdDevL[i]);

        mydata = [ stkpriceDataArrM]

          mydata.push(stkpriceDataArrH)
          mydata.push(makeMovAve(stkpriceDataArrH, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrH, intv1))
          mydata.push(makeMovAve(stkpriceDataArrH, intv2))
          //mydata.push(makeMovAve(mydata[1], intv3))
          //mydata.push(makeMovAve(mydata[1], intv4))  // line 6

          mydata.push(stkpriceDataArrL) // line 6, index 5
          mydata.push(makeMovAve(stkpriceDataArrL, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrL, intv1))
          mydata.push(makeMovAve(stkpriceDataArrL, intv2))
          //mydata.push(makeMovAve(mydata[5], intv3))
          // mydata.push(makeMovAve(mydata[5], intv4))

          //mydata.push(makeMovAve(mydata[1], intv8))
          mydata.push(newDevadd)
          mydata.push(newDevminus)  // line 8
        theMax = Math.max(...[].concat(...mydata));
        theMin = Math.min(...[].concat(...mydata));

        thedrawdata = mydata
        //thedrawdata.push(makeMovAve(thedrawdata[2], intv1));  // add one line to check results

        thedrawdata[1] = thedrawdata[1].fill(null,0,0)
        thedrawdata[2] = thedrawdata[2].fill(null,0,halfNum)
        thedrawdata[3] = thedrawdata[3].fill(null,0,intv1)
        thedrawdata[4] = thedrawdata[4].fill(null,0,intv2)

        thedrawdata[5] = thedrawdata[5].fill(null,0,0)
        thedrawdata[6] = thedrawdata[6].fill(null,0,halfNum)
        thedrawdata[7] = thedrawdata[7].fill(null,0,intv1)
        thedrawdata[8] = thedrawdata[8].fill(null,0,intv2)

        thedrawdata[9] = thedrawdata[9].fill(null,0,intv3)
        thedrawdata[10] = thedrawdata[10].fill(null,0,intv3)

        //thedrawdata[11] = thedrawdata[11].fill(null,0,intv3)
        //thedrawdata[12] = thedrawdata[12].fill(null,0,intv1)  // add one line 

lowLst = specialBackUp  // recover data

statusMsg = '<br><span class="red">price '+ mydata[0].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">intvS '+ mydata[1].slice(-1)[0].toFixed(3) +
'</span>, <span class="blue">intvL '+ mydata[2].slice(-1)[0].toFixed(3) +
'</span>, <span class="purple">Top '+ mydata[3].slice(-1)[0].toFixed(3) +
'</span>, <span class="yellow">Bottom '+ mydata[4].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">IntvS '+ intv1 +
'</span>, <span class="blue">IntvL '+ intv2 +
'</span>'

$("#lastValues").text("");
$("#lastValues").append(statusMsg);

       drawchart()

		// create datalog table
		 transp = transpose(mydata);
            wAveTrendRange = [];  // this is the gap diff
		  for (var row=0; row < transp.length; row++) {
		    rowRange = transp[row].slice(1, mydata.length);
      	    rowMax = Math.max(...rowRange);
      	    rowMin = Math.min(...rowRange);
      	    var rowDiff = rowMax - rowMin;
      	    wAveTrendRange.push(rowDiff);
      	  }

		wAveTrendRange.fill(null,0,intv3);
		wAvemax = Math.max(...wAveTrendRange);
		wAvemin = Math.min(...wAveTrendRange);
		drawTrend(wAveTrendRange, wAvemax, wAvemin, 'TP');

		// find derivative
		derivative = diff(makeMovAve(mydata[0], 3));
		derivative.unshift(0);
		derivative.fill(null,0,intv1+3); //array.fill(value, start, end)

		// diffaccel
		// diffaccel = thedrawdata[baseSubIdx].map(function(item, index) { return item - thedrawdata[baseMinuIdx][index]; })
		diffaccel = []
		diffaccel.push(thedrawdata[1].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[2].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[3].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[4].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[5].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[6].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[5].fill(null,0,intv3); //array.fill(value, start, end)

		diffaccMax = Math.max(...[].concat.apply([], diffaccel));
		diffaccMin = Math.min(...[].concat.apply([], diffaccel));
		drawTrend(diffaccel, diffaccMax, diffaccMin, 'accel');

		// ddiffaccel
		ddiffaccel = []
		ddiffaccel.push(diffaccel[0].map(function(item, index) { return item - diffaccel[1][index]; }))
		ddiffaccel.push(diffaccel[1].map(function(item, index) { return item - diffaccel[2][index]; }))
		ddiffaccel.push(diffaccel[2].map(function(item, index) { return item - diffaccel[3][index]; }))
		//ddiffaccel.push(diffaccel[3].map(function(item, index) { return item - diffaccel[4][index]; }))
		//ddiffaccel.push(diffaccel[4].map(function(item, index) { return item - diffaccel[5][index]; }))
		//ddiffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)

		ddiffaccMax = Math.max(...[].concat.apply([], ddiffaccel));
		ddiffaccMin = Math.min(...[].concat.apply([], ddiffaccel));
		drawTrend(ddiffaccel, ddiffaccMax, ddiffaccMin, 'accaccel');

		// find stoch
		stoch1 = makeStoch(mydata[0], 50)
		stochmax1 = Math.max(...stoch1);
		stochmin1 = Math.min(...stoch1);
		drawTrend(stoch1, stochmax1, stochmin1, '强弱50');

        // evaluate B/S
        lastdayPtr = mydata[0].length-1
        statBegin = lastdayPtr - 29
        actionStr = ""
        for (var i = statBegin; i < (lastdayPtr+1); i++) {
          // define references
          Mvalue = mydata[0][i]
          Hvalue = mydata[1][i]
          Lvalue = mydata[5][i]
          hRefvalue = mydata[2][i]
          lRefvalue = mydata[6][i]
          h2Refvalue = mydata[3][i]
          l2Refvalue = mydata[7][i]
          acRefvalue = diffaccel[1][i]
          // compare indicators
          Hdiff = (Hvalue - hRefvalue).toFixed(2)
          Ldiff = (Lvalue - lRefvalue).toFixed(2)
          H2diff = (Hvalue - h2Refvalue).toFixed(2)
          L2diff = (Lvalue - l2Refvalue).toFixed(2)
          Mhdiff = (Mvalue - h2Refvalue).toFixed(2)
          Mldiff = (Mvalue - l2Refvalue).toFixed(2)
          acdiff = (diffaccel[0][i] - diffaccel[0][i-1]).toFixed(2)
          ac1diff = (diffaccel[0][i] - diffaccel[1][i]).toFixed(2)

          Mdiff = (mydata[0][i] - mydata[0][i-1]).toFixed(2)

          if(Hdiff >0){Hdiff = "<span class='red'>" +Hdiff + "</span>"}
          if(Ldiff >0){Ldiff = "<span class='red'>" +Ldiff + "</span>"}
          if(H2diff >0){H2diff = "<span class='red'>" +H2diff + "</span>"}
          if(L2diff >0){L2diff = "<span class='red'>" +L2diff + "</span>"}

          if(Mhdiff >0){Mhdiff = "<r>" +Mhdiff + "</r>"}
          else{Mhdiff = "<gr>" +Mhdiff + "</gr>"}
          if(Mldiff >0){Mldiff = "<r>" +Mldiff + "</r>"}
          else{Mldiff = "<gr>" +Mldiff + "</gr>"}

          if(Mdiff >0){Mdiff = "<r>" +Mdiff + "</r>"}
          else{Mdiff = "<gr>" +Mdiff + "</gr>"}

          if(acdiff >0){acdiff = "<r>" +acdiff + "</r>"}
          else{acdiff = "<gr>" +acdiff + "</gr>"}
          if(ac1diff >0){ac1diff = "<r>" +ac1diff + "</r>"}
          else{ac1diff = "<gr>" +ac1diff + "</gr>"}

          closeValue = lowLst[i]
          dateValue = dateLst[i].slice(5)

          // decision conditions
          actionStr = actionStr + dateValue + " C: " + closeValue +"\tHd: " + Hdiff + "\tLd: " + Ldiff + "\tH2d: " + H2diff + "\tL2d: " + L2diff + "\tMd: " + Mdiff + "\tacd: " + acdiff + "\tac1d: " + ac1diff + "<br>" 

          if(Hdiff>0){action = "buy"}
        }
        explanationStr = "<gr>h2d: h2 diff, l2d: L2 diff, md: M diff, acd: acc0 diff, ac1d: acc0 diff</gr>"
        actionStr = "<pre>" + actionStr + explanationStr+"</pre>"
        $("#actions").html(actionStr);

        drawOHLC()
        drawlinechart()
       }

    function useAttentionList() {
        stkList = attentionList;
        alert("AttentionList Total: " + attentionList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + attentionList.length + "\n"+stkList);
    }

    function myfavor() {
        myfavorLst = mychips.split(" ");
        stkList = myfavorLst;
        alert("mychips Total: " + myfavorLst.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("mychips Total: " + myfavorLst.length + "\n"+stkList);
    }

    function askList() {
        var theList = prompt("CodeList, Number (5 digits) sep by space： ", "");
        if (theList != null && theList != "HSI" && theList != "") {
            stkList = theList.split(" ");
            alert("Supplied List Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
            $("#message").text("Supplied List Total: " + stkList.length + "\n"+stkList);
        }
        codetable = stkList
        document.getElementById("upcrossResult").innerHTML = "";

        for (var i = 0; i < codetable.length; i++) {
           collectStkData(codetable[i])
        }
    }



    function chgchartWidth() {
        newChartWidth = prompt("enter chart width:", "");
        if (newChartWidth != null && newChartWidth != "" && newChartWidth < (1000 - 2*intv1)){
          period = parseInt(newChartWidth);
          localStorage.setItem("daychartWidth", period);
          collectStkData(theCode);
        }

    }
    function chgIntv() {
        intv = prompt("intv1 value:", "");
        if (theCode != null && intv1 != ""){
          intv1 = parseInt(intv);
          initIntvSteps()
          redraw()
        }
    }
    function initIntvSteps() {
      halfNum = Math.round(intv1/2)
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
    }
    function setTabWidth() {
        tabWidth = prompt("set tab width:", "");
        if (tabWidth != null && tabWidth != ""){
          tabWidth = parseInt(tabWidth);
          document.getElementById("actions").style.tabSize = tabWidth;
        }
    }

    function chgHighList() {
        dataStatus = "H"
        redraw()
    }
    function chgLowList() {
        dataStatus = "L"
        redraw()
    }
    function chgMidList() {
        dataStatus = "M"
        redraw()
    }
    function chgCloseLst() {
        dataStatus = "C"
        redraw()
    }

    function largeCht() {
        imgHead = "http://charts.aastocks.com/servlet/Charts?fontsize=12&15MinDelay=F&lang=1&titlestyle=1&vol=1&Indicator=3&indpara1=3&indpara2=5&indpara3=10&indpara4=15&indpara5=20&subChart2=3&ref2para1=12&ref2para2=26&ref2para3=9&subChart3=12&ref3para1=0&ref3para2=0&ref3para3=0&scheme=3&com=100&chartwidth=1600&chartheight=900&stockid=";

        imgTail = "&period=2060&type=1&logoStyle=1"
        imgURL = imgHead + theCode + imgTail
        window.open(imgURL, "_blank")
    }

function assignList(){
  newList = eval(document.getElementById("selectList").value).split(" ");
  stkList = newList;
  codeList = newList;

  document.getElementById("message").focus();
  alert(" Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!\n" + newList)
        $("#message").text("Total: " + stkList.length + "\n"+stkList);
  $('#selectList').blur()

}

function showDateTime() {
    cmtCode = theCode // use another name not to interfere other parts
    var cmtcodewidth = cmtCode.length
    if(cmtcodewidth <= 5){
      cmtCode = "00000"+cmtCode;
      cmtcodewidth = cmtCode.length;
      cmtCode = cmtCode.slice(cmtcodewidth-5, cmtcodewidth);
    }
    else if(cmtcodewidth == 8){ cmtCode = cmtCode.slice(2, 8); }
    else if(cmtcodewidth == 9){ cmtCode = cmtCode.slice(0, 6); }
    commentName = "j" + cmtCode;

    CommentListNames = Object.keys(theCommentList); // extract the names from comments
    // to show comments
    if(CommentListNames.includes(commentName)){
      cmtLocation = CommentListNames.indexOf(commentName);
      commentTxt = theCommentList[Object.keys(theCommentList)[cmtLocation]]
    }else{commentTxt = "No data!";}

    document.getElementById("dateTime").innerHTML =showDate() +" "+ showTime()
}

    function drawchart() {
      listItems = []
      if(dataStatus == "C"){ tooltips = closeLst
      }else if(dataStatus == "L"){ tooltips = lowLst
      }else if(dataStatus == "M"){ tooltips = midLst
      }else { tooltips = highLst}

      dataTooltips = tooltips.map(item => Math.round(item * 1000) / 1000)
      for (index = 0; index < dataTooltips.length; index++) {
        listItems[index] = dateLst[index] + "<br><span class='red'>" + dataStatus + "</span>: " + dataTooltips[index];
      }

      dataTooltips = dataTooltips.map(String)

      var line = new RGraph.Line({
        id:'cvs',
        data: thedrawdata,
        options: {
			title: titleText + " " + "MHL + trends",
			titleColor: 'grey',
			titleSize: 20,
               colors: chartColor,
            backgroundGrid: true, backgroundGridVlines: true,
            backgroundGridColor: '#001000', backgroundGridBorder: false,
            // backgroundGridDotted: true,
            backgroundGridDashed: true, 
            axisColor: '#864',  scaleDecimals: 2,
            xaxis: true,
            //xaxisLabels: ["a","b","c","d"],
            textColor: '#ccc',
            tickmarks: 'plus',
            ticksize: 1,
            linewidth:1,
			ymax: theMax,
			ymin: theMin,
      // labels control the number of grids
            // labels: ['2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018'],
            spline: false,
            shadow: false,
            tooltips: listItems,
            gutterLeft: 0, gutterRight: 50,
            gutterTop: 25, gutterBottom: 25
            }
          }).trace();

		yminpct = 100 - (theMax-theMin)*100/theMax,
		ymaxpct = 100,

          yaxis1 = new RGraph.Drawing.YAxis('cvs', 1200)
                .Set('colors', ['gold'])
                .Set('text.color', 'gray')
                .Set('text.size', 8)
                .Set('max', ymaxpct)
                .Set('min', yminpct)
                .Set('linewidth', 2)
                .Set('tickmarkslength', 5)
                .Set('title', '% pct')
                .Draw();

    };

    function drawTrend(therange,maxValue, minValue, chartID) {
       // dataTooltips = therange.map(item => Math.round(item * 1000) / 1000)
       // dataTooltips = dataTooltips.map(String)
       RGraph.reset(document.getElementById(chartID));
       line = new RGraph.Line({
       	id:chartID, data:therange,
       	options: {
       		title: chartID + ", "+theStartCode + " " + stkName,
    			titleColor: 'grey', 
    			titleSize: 10,
       		backgroundGrid: true, axisColor: '#864', textColor: '#ccc',
    		numxticks: 0, colors: chartColor, scaleDecimals: 2,

       		tickmarksDotLinewidth: 0,ticksize: 1, linewidth: 1, 
       		ymax: maxValue, ymin: minValue,
               tickmarks: 'plus',

       		spline: false, shadow: false,
              // tooltips: dataTooltips,
			backgroundGridVlines: true,
			backgroundGridDashed: true, 
       		backgroundGridColor: '#001000',
       		gutterLeft: 0, gutterRight: 50, gutterTop: 25, gutterBottom: 25
       	}
       }).trace();
    };
    

function showActivity(thecode){
    markers = filterResult.filter(element => element.includes(thecode));
    // clean the h2 tags
    markers = markers.map(element => element.replace(/<\/h2>.*/gi, ""))
    markers = markers.map(element => element.replace(/<h2>/gi, ""))

    markers = markers.map(element => formatWeekDay(element))
    if (markers.length > 50) markers.splice(0, markers.length-80);

    $('#filterMarkers').append("<b class='red'>" + thecode + " 日线特征:</b><br>")
    $('#filterMarkers').append(markers)
}

function fetchUsCode(str) {
    theCode = str; collectStkData(str); window.location = '#cvs';
    $('#usstock').toggle();
}

function handleRight( event ){
    codeListPtr = codeListPtr +1
    theCode = codeList[codeListPtr];
    collectStkData(theCode);
}

    codeList = codeList.split(' ')
    codeListPtr = 0

    // $( "html" ).on( "swiperight", handleRight );
    // $( "html" ).on( "swipeleft", askforCode );
    window.addEventListener('click', function (evt) {
        if (evt.detail === 3) { askforCode(); }
    });

    //collectStkData(theCode);

function docLoaded() {
    let script1 = document.createElement('script');
    script1.src = 'https://williamkpchan.github.io/LibDocs/readbook.js';
    document.body.appendChild(script1);
    let script = document.createElement('script');
    script.src = 'C:/R programs/!!! STKMon !!!/headerApp.js';
    document.body.appendChild(script);
    window.scrollTo(0,(document.body.scrollHeight));

}

    function drawOHLC() { // includes main chart and aux charts
      var ohlcdata = {
        close:  closeLst,
        low:  lowLst,
        open:  openLst,
        high:  highLst,
        x:  dateLst,
        line: {color: '#f3ce'}, 
        increasing: {line: {color: 'red'}},
        decreasing: {line: {color: 'green'}},
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
      };

      var data = [ohlcdata];
      var layout = {
      title: titleText,
        dragmode: 'zoom', 
        showlegend: false,
        xaxis: { rangeslider: { visible: false } }, 
        yaxis: { autorange: true,  type: 'linear' }
      };
      Plotly.newPlot('ohlcDiv', data, layout);
    }


    function chkCross(stkName, highLst, midLst, thisCode, lastPrice) { // includes main chart and aux charts
      contUCnt = 0
        statustxt = `<k onclick="xunbao('` + thisCode + `')">`+ thisCode + " <dr>" + stkName+ '</dr></k>&emsp;'
        $("#StkStatus").append( "<br>" +statustxt);

      // mid data
      dLineM0 = midLst
      dLineM1 = makeMovAve(midLst, intv1)
      dLineM2 = makeMovAve(midLst, intv2)
      dLineM3 = makeMovAve(midLst, intv3)
      dLineM4 = makeMovAve(midLst, intv4)

      indexlast = dLineM0.length-1

      curM0 = dLineM0[indexlast]
      prevM0 = dLineM0[indexlast-1]

      curM1 = dLineM1[indexlast]
      prevM1 = dLineM1[indexlast-1]

      curM2 = dLineM2[indexlast]
      prevM2 = dLineM2[indexlast-1]

      curM3 = dLineM3[indexlast]
      prevM3 = dLineM3[indexlast-1]

      curM4 = dLineM4[indexlast]
      prevM4 = dLineM4[indexlast-1]


      // H data
      dLineH0 = highLst
      dLineH1 = makeMovAve(highLst, intv1)
      dLineH2 = makeMovAve(highLst, intv2)

      curH0 = dLineH0[indexlast]
      prevH0 = dLineH0[indexlast-1]

      curH1 = dLineH1[indexlast]
      prevH1 = dLineH1[indexlast-1]

      curH2 = dLineH2[indexlast]
      prevH2 = dLineH2[indexlast-1]

      // Lo data
      dLineLo0 = lowLst
      dLineLo1 = makeMovAve(lowLst, intv1)
      dLineLo2 = makeMovAve(lowLst, intv2)

      curLo0 = dLineLo0[indexlast]
      prevLo0 = dLineLo0[indexlast-1]

      curLo1 = dLineLo1[indexlast]
      prevLo1 = dLineLo1[indexlast-1]

      curLo2 = dLineLo2[indexlast]
      prevLo2 = dLineLo2[indexlast-1]


      // checkX(prevL, prevS, curL, curS) check mid

      curS = curM0
      prevS = prevM0
      curL = curM1
      prevL = prevM1
      checkXMsg = "<k> M0XM1 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}


      // check if upCross
      result = /UpCross/.test(checkXMsg);
      if(result){
        uptxt = statustxt.replace(/dr>/g, "o>");
        $("#M0uXM1").append(uptxt);
        M0uXM1Count = M0uXM1Count +1
      }

      // check if cont.Up
      result = /cont.Up/.test(checkXMsg);
      if(result){
        uptxt = statustxt.replace(/dr>/g, "o>");
        $("#M0ContUpM1").append(uptxt);
        M0ContUpM1Count = M0ContUpM1Count +1
      }

      // check if DownCross
      result = /DownCross/.test(checkXMsg);
      if(result){
        downtxt = statustxt.replace(/dr>/g, "gr>");
        $("#M0dXM1").append(downtxt);
        M0dXM1Count = M0dXM1Count +1
      }

      // check if cont.Dn
      result = /cont.Dn/.test(checkXMsg);
      if(result){
        downtxt = statustxt.replace(/dr>/g, "gr>");
        $("#M0ContDnM1").append(downtxt);
        M0ContDnM1Count = M0ContDnM1Count +1
      }



      curL = curM2
      prevL = prevM2
      checkXMsg = "<k> M0XM2 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      curL = curM3
      prevL = prevM3
      checkXMsg = "<k> M0XM3 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      curL = curM4
      prevL = prevM4
      checkXMsg = "<k> M0XM4 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 4){
        $("#M0XM4").append(statustxt);
        M0XM4Count++;
      }

      curS = curM1
      prevS = prevM1
      curL = curM2
      prevL = prevM2
      checkXMsg = "<dr> M1XM2 </dr>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 5){
        $("#M1XM2").append(statustxt);
        M1XM2Count++;
      }

      curS = curM2
      prevS = prevM2
      curL = curM3
      prevL = prevM3
      checkXMsg = "<k> M2XM3 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 6){
        $("#M2XM3").append(statustxt);
        M2XM3Count++;
      }

      curS = curM3
      prevS = prevM3
      curL = curM4
      prevL = prevM4
      checkXMsg = "<k> M3XM4 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 7){
        $("#M3XM4").append(statustxt);
        M3XM4Count++;
      }
    }

      function alertStat() {
        prevStat = document.getElementById("prevstatistics").innerHTML
        console.log("prevStat: ",prevStat)
        alert("check console to copy prev Stat")
      }



</script>

<script src='createTOC.js'></script>

</body>
</html>
