<!DOCTYPE html>
<html>
<head>
<title>Stk Line Borr chart</title>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src='..\mainscript.js'></script>
<script src="stkComments.js"></script>
<script src="./rchart/RGraph.common.core.js" ></script>
<script src="./rchart/RGraph.line.js"></script>
<!--script src="./rchart/RGraph.svg.bar.js" ></script-->


<style>
dateTime {  text-align: left;}
</style>

</head>
<body onkeypress="chkKey()">
<center>
<canvas id="cvs" width="1350" height="600">[No canvas support]</canvas>
<br><span id="turnover"></span>
<span id="lastValues"></span>
</center>
<div id="dateTime" style="margin-left:5%;" class="lime"> </div>

<pre id="message">

commands:
d fillLineData, paste one set data to redraw with std dev
c askforCode

R Random Charts.html
m mlineMinutechart.html

f jpforward
b jpback
r jprandom

h chgHighList
l chgLowList
C chgCloseLst
a useAttentionList
q defaultLst
i chgIntv
L askList
5 lines: data, WAve5, WAve10, sd+, sd-
A stk code sample: 000001.sh, 399001.sz
</pre>
<script>
      let thestkdata = [];
      period = 75;
      let dateLst = [];
      let openLst = [];
      let highLst = [];
      let lowLst = [];
      let closeLst = [];
      let amtLst = [];

      dataStatus = "C"
      intv5 = 5
      stkpriceDataArr = [];
      stkList = localStorage.getItem("stkListArr").split(' ');
      stkPointer = 0;
      theCode = localStorage.randomcode;
      titleText = "";

      attentionList = ""
      if (localStorage.getItem("attentionList") === null) {
        localStorage.attentionList = "07500";
      } else{
        attentionList = localStorage.getItem("attentionList").split(',');
      }
      //console.log(attentionList)

      // added extra links
      bigVolHeader = "http://www.etnet.com.hk/www/tc/stocks/realtime/quote_transaction.php?code="
      shortsellHeader = "http://www.aastocks.com/tc/stocks/analysis/stock-short-selling-ratio.aspx?symbol="
      newshead = "http://www.aastocks.com/tc/stocks/analysis/stock-aafn/"
      newstail = "/0/all/1"

      function askforCode() {
        var tempCode = prompt("Code Number:", "");
        if (tempCode != null && tempCode != ""){

            codewidth = tempCode.length
            if(codewidth <= 5){
              theCode = "00000"+tempCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }else{
              theCode = tempCode
            }

           storeCode(theCode)
           collectStkData(theCode)  // show turnover and draw
        }
      }

      function collectStkData(theCode) {
      $("#turnover").html(
       '<span class="randomBut gold bordred1 borRad10" onclick="askforCode()">号码</span> ' +
       '<span class="randomBut gold bordred1 borRad10" onclick="jpforward()">Next</span> ' +
      '<a href="' + bigVolHeader + theCode +'" target="_blank" class="white bordred1 borRad10">大戶</a>' +
      '<a href="' + newshead + theCode + newstail +'" target="_blank" class="white bordred1 borRad10">資料</a>' +
      '<a href="' + shortsellHeader + theCode + '" target="_blank" class="white bordred1 borRad10">沽空</a> '
      );

          codewidth = theCode.length
          if(theCode == "HSI"){
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,1000,qfq';
          }else{
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,1000,qfq';
            }else{
              codewidth = theCode.length
              theCode = theCode.slice(codewidth-9, codewidth)
              theCode = theCode.slice(7, 9) + theCode.slice(0, 6);
              codewidth = theCode.length; //update to be used later
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,320,qfq';
            }
          }
      
          theStartCode = theCode;
          thestkdata = [];
          thedrawdata = [];
          dateLst = [];
          openLst = [];
          highLst = [];
          lowLst = [];
          closeLst = [];
          amtLst.length = 0;
      
          RGraph.AJAX.getJSON(theurl, function (rawJSON){
              var keys = Object.keys(rawJSON); // read the structure keys ["code", "msg", "data"]
              var insideDatakey = Object.keys(rawJSON)[2] //
              // myobj[Object.keys(myobj)[0]] this is the extract method
      
              var thedata = rawJSON[Object.keys(rawJSON)[2]]
              thestkkey = Object.keys(thedata)[0] // this is the stk key name
              var tempdata = thedata[Object.keys(thedata)[0]];
              thestkdata = tempdata[Object.keys(tempdata)[0]]; // real data here, this is whole dataset
    for(i=(thestkdata.length-12);i<thestkdata.length;i++){
      thedate = thestkdata[i][0];  // date
      if(codewidth <= 5){
        theAmtIdx = 8;
      }else{
        theAmtIdx = 5;
      }
      theamt = Math.round(Number(thestkdata[i][theAmtIdx]));
      if(codewidth > 5){
        if(theCode.slice(0, 5) == "sh688"){
          theamt = Math.round(theamt * Number(thestkdata[i][2])/10000);
        }else{
          theamt = Math.round(theamt * Number(thestkdata[i][2])/100);
        }
      }
      theamt = theamt.toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",");
      $("#turnover").append( theamt,"w ");
    }
      
              theNameObj = tempdata[Object.keys(tempdata)[1]];
              theNameObjName  = theNameObj[Object.keys(theNameObj)[0]];
              stkName = theNameObjName[1]
      
              /* data is arranged in days array, tempdata[320] is last set
              tempdata[320][0]  // date
              tempdata[320][1]  // open
              tempdata[320][3]  // high
              tempdata[320][4]  // low
              tempdata[320][2]  // close */
      
                //period + intv5, the chartwidth + max trend interval
              starti = thestkdata.length - (parseInt(period) + parseInt(intv5)) -5; 
              if(starti <= 0){
                  alert("not enough data! Selet short chartwidth and trend period!");
                  return;
              }

              for (let i = starti; i < thestkdata.length; i++) {
                  dateLst.push(thestkdata[i][0]);
                  openLst.push(Number(thestkdata[i][1]));
                  highLst.push(Number(thestkdata[i][3]));
                  lowLst.push(Number(thestkdata[i][4]));
                  closeLst.push(Number(thestkdata[i][2]));
                  amtvalue = "&emsp;" + Math.round(Number(thestkdata[i][8])).toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",") +"w ";
                  amtLst.push(amtvalue);
              }
              stkpriceDataArr = closeLst
              dataStatus = "C"
              titleText = theStartCode + " " + stkName + " 日線保力加";
              redraw();  // this line must be inside the AJAX because AJAX run last
              // return  thedrawdata =[highLst, lowLst, closeLst];
           });

           showDateTime();

      }

     function chkKey() {
       var testkey = getChar(event);
       if(testkey == '0'){collectStkData('000001.sh');}
       if(testkey == '3'){collectStkData('399001.sz');}
       if(testkey == '1'){collectStkData('HSI');}
       if(testkey == '2'){collectStkData('01339');}
       if(testkey == '4'){collectStkData('01766');}
       if(testkey == '5'){collectStkData('03800');}
       if(testkey == '6'){collectStkData('01088');}
       if(testkey == '7'){collectStkData('00788');}
       if(testkey == '8'){collectStkData('00308');}
       if(testkey == '9'){collectStkData('00390');}
       if(testkey == 'd'){fillLineData();}
       if(testkey == 'c'){askforCode();}
       if(testkey == '+'){addToAttentionList();}
       if(testkey == '-'){removeFmAttentionList();}
       if(testkey == 'R'){storeCode(theCode); window.open("Random Charts.html");}
       if(testkey == 'm'){storeCode(theCode); window.open("mlineMinutechart.html");}

       if(testkey == 'a'){useAttentionList();}
       if(testkey == 'f'){jpforward();}
       if(testkey == 'b'){jpback();}
       if(testkey == 'r'){jprandom();}
       if(testkey == 'h'){chgHighList();}
       if(testkey == 'l'){chgLowList();}
       if(testkey == 'i'){chgIntv();}
       if(testkey == 'w'){chgchartWidth();}
       if(testkey == 'C'){chgCloseLst();}
       if(testkey == 'q'){defaultLst();}
       if(testkey == 'L'){askList()}
     }
     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

	function fillLineData() {
      var dataArr = prompt("Enter data array sep by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        redraw()
      }
     }
	function addToAttentionList() {
            codewidth = theCode.length
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }

        attentionList.push(theCode)
        attentionList = [...new Set(attentionList)]; // set unique

        ItemIndex = attentionList.indexOf("");  // remove empty items
        if (ItemIndex > -1) { attentionList.splice(ItemIndex, 1); }

        localStorage.setItem("attentionList", attentionList);
        alert(theCode + " added to attentionList!")
     }
	function removeFmAttentionList() {
        ItemIndex = attentionList.indexOf(theCode);
        if (ItemIndex > -1) { attentionList.splice(ItemIndex, 1); }
        attentionList = [...new Set(attentionList)]; // set unique
        localStorage.setItem("attentionList", attentionList);
        alert(theCode + " removed to attentionList!")
   }

     function redraw() {
        intv10 = 2*intv5

        RGraph.reset(document.getElementById('cvs'));

        stdDevH = makeStd(highLst, intv10)
        stdDevL = makeStd(lowLst, intv10)
        newDevadd = makeMovAve(stkpriceDataArr, intv10).map((a, i) => a + stdDevH[i]);
        newDevminus = makeMovAve(stkpriceDataArr, intv10).map((a, i) => a - stdDevL[i]);

        mydata= [
          stkpriceDataArr, 
          makeMovAve(stkpriceDataArr, intv5),
          makeMovAve(stkpriceDataArr, intv10),
          newDevadd, newDevminus,
        ];
        theMax = Math.max(...[].concat(...mydata));
        theMin = Math.min(...[].concat(...mydata));

statusMsg = '<br><span class="red">只信趨勢：price '+ mydata[0].slice(-1)[0].toFixed(3) +
'</span>, <span class="lime">intvS '+ mydata[1].slice(-1)[0].toFixed(3) +
'</span>, <span class="blue">intvL '+ mydata[2].slice(-1)[0].toFixed(3) +
'</span>, <span class="purple">Top '+ mydata[3].slice(-1)[0].toFixed(3) +
'</span>, <span class="yellow">Bottom '+ mydata[4].slice(-1)[0].toFixed(3) +
'</span>, <span class="lime">IntvS '+ intv5 +
'</span>, <span class="blue">IntvL '+ intv10 +
'</span>'

$("#lastValues").text("");
$("#lastValues").append(statusMsg);

       drawchart()
     }

	function makeMovAve(bigArray, intv) {
	     // the intv-1 is correct
		return bigArray.slice(0, intv-1).concat(calcMovAve(bigArray, intv));
	}
	function calcAve(aveArray) {
		add = (a, b) =>  a + b;
		return aveArray.reduce(add) / aveArray.length;
	}
	
	function calcMovAve(bigArray, intv) {
		var ma = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {ma[i] = calcWAve(bigArray.slice(i, i+intv));} // points to indicator
		return ma;
	}
	function calcWAve(aveArray) {
		var sum = 0
		for( var i = 1; i <= aveArray.length; i++ ) {
			sum += aveArray[i-1] * i;
		}
		return (sum / ((1 + aveArray.length)*aveArray.length/2))
	}

	function makeStd(bigArray, intv) {
	     // the intv-1 is correct
          newArray = new Array(intv-1).fill(0)
		newArray = newArray.concat(calcStd(bigArray, intv));
		return newArray
	}

	function calcStd(bigArray, intv) {
		var stdArrar = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {stdArrar[i] = Std(bigArray.slice(i, i+intv));} // points to indicator
		return stdArrar;
	}

	function Std(array) {
	  const n = array.length
	  const mean = array.reduce((a, b) => a + b) / n
	  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
	}

    function useAttentionList() {
        stkList = attentionList;
        alert("Total: " + attentionList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + attentionList.length + "\n"+stkList);

    }
    function defaultLst() {
        defaultStkLst = "03983 02016 00241 01882 02357 00670 00788 01186 01766 00390 00308 01339 02380 03800 00371 02009 01613 02208 09977 01193 00305 00303 01999 00992 01801 00004 00451 02331 02382 01250 00486 00388"
        stkList = defaultStkLst.split(" ");
        alert(stkList)
    }
    function askList() {
        var theList = prompt("CodeList, Number (5 digits) sep by space： ", "");
        if (theList != null && theList != "HSI" && theList != "") {
            stkList = theList.split(" ");
        }
    }

    function FormatNumberLength5(num) {
        var r = "" + num;
        while (r.length < 5) { r = "0" + r; }
        return r;
    }

    function jpforward() {
        if (stkPointer < stkList.length-1) {
            stkPointer = stkPointer + 1;
        } else {
            stkPointer = 0;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }

    function jpback() {
        if (stkPointer > 0) {
            stkPointer = stkPointer - 1;
        } else {
            stkPointer = stkList.length-1;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }
    function jprandom() {
        stkPointer = Math.floor(Math.random() * (stkList.length-1))
        theCode = stkList[stkPointer]
         collectStkData(theCode)
    }
    function storeCode(theCode) {
        if(typeof(Storage) !== "undefined") {
            localStorage.randomcode = theCode;
        }
    }


    function chgchartWidth() {
        newChartWidth = prompt("enter chart width:", "");
        if (newChartWidth != null && newChartWidth != "" && newChartWidth < (1000 - 2*intv5)){period = parseInt(newChartWidth); collectStkData(theCode)}
    }
    function chgIntv() {
        intv = prompt("intv5 value:", "");
        if (theCode != null && intv5 != ""){intv5 = parseInt(intv); redraw()}
    }
    function chgHighList() {
        stkpriceDataArr = highLst
        dataStatus = "H"
        redraw()
    }
    function chgLowList() {
        stkpriceDataArr = lowLst
        dataStatus = "L"
        redraw()
    }
    function chgCloseLst() {
        stkpriceDataArr = closeLst
        dataStatus = "C"
        redraw()
    }

function showDateTime() {
    var theDateTime = showDate() +" "+ showTime();
    var CommentListNames = Object.keys(theCommentList); // extract the names from comments
    // to show comments
    cmtCode = theCode // use another name not to interfere other parts
    var cmtcodewidth = cmtCode.length
    if(cmtcodewidth <= 5){
      cmtCode = "00000"+cmtCode;
      cmtcodewidth = cmtCode.length;
      cmtCode = cmtCode.slice(cmtcodewidth-5, cmtcodewidth);
    }

    commentName = "j" + cmtCode;

    if(CommentListNames.includes(commentName)){
      cmtLocation = CommentListNames.indexOf(commentName);
      commentTxt = theCommentList[Object.keys(theCommentList)[cmtLocation]]
    }else{commentTxt = "";}

    document.getElementById("dateTime").innerHTML = theDateTime  + " <span class='orange'>" + commentTxt + "</span>";
}


    function drawchart() {
      // console.log(intv5)
      var line = new RGraph.Line({
        id:'cvs',
        data:mydata,
        options: {
			title: titleText + " " + dataStatus,
			titleColor: 'grey',
			titleSize: 20,
            // colors: ['darkgreen','blue','grey'],
            backgroundGrid: true, backgroundGridVlines: true,
            backgroundGridColor: '#002010',
            axisColor: '#864',  scaleDecimals: 2,
            textColor: '#ccc',
            tickmarks: 'plus',
            ticksize: 1,
            linewidth:1,
			ymax: theMax,
			ymin: theMin,
      // labels control the number of grids
            // labels: ['2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018'],
            spline: false,
            shadow: false,
            gutterLeft: 50,
            gutterRight: 50,
            gutterTop: 50,
            gutterBottom: 50
            }
          }).trace();
    };

    collectStkData(theCode);
</script>
</body>
</html>