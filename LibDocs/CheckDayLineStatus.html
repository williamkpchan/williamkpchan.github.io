<!DOCTYPE html>
<!--meta http-equiv="refresh" content="300"-->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<html>
<head>
<title>CheckDayLineStatus</title>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src='https://williamkpchan.github.io/mainscript.js'></script>
<script src="https://williamkpchan.github.io/LibDocs/stkComments.js"></script>
<script src="https://williamkpchanhp.github.io/filterResulitLib.txt"></script>
<script src="https://code.jquery.com/mobile/1.5.0-alpha.1/jquery.mobile-1.5.0-alpha.1.min.js"></script>

<script src="https://williamkpchanhp.github.io/LibDocs/longHistList.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.core.js" ></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.line.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.drawing.yaxis.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.dynamic.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.tooltips.js"></script>
<script src="https://williamkpchanhp.github.io/codeList.js"></script>
<script src='https://cdn.plot.ly/plotly-2.34.0.min.js'></script>
<script>
  var showTopicNumber = false;
  var topicEnd = "&emsp;";
  var bookid = "CheckDayLineStatus"
  var markerName = "h2"
</script>

<style>
body {width:98%;margin-left: 1%; font-size:24px;}
#dateTime {  text-align: left;}
#cmtNote, #instruction, #message, #usstock{display:none;}
#amtLst {font-size:12px;}
#actions {font-size:12px; text-align: left; tab-size: 8; margin-left: 5%;}
select {border-radius:10px; font-size:20px;background-color:black; color:brown;}
#ohlcDiv {display:inline-block; width:85%; height:700px;}
#linechart {display:inline-block; width:85%; height:700px;}
#StkStatus {font-size:20px;}
</style>

</head>
<body onkeypress="chkKey()">

<center>
<h1>CheckDayLineStatus</h1>
<span class="goldword">&rarr;</span> <span id="dateAndTime" onclick="showDateAndTime()"><script>showDateAndTime();</script></span><br>
<div id="toc"></div>
</center>
<br>
<pre>
<h2 id="10">previous statistics</h2><span class="redbut" onclick="updateStat('ChkXAprevStatus');")>Load Prev Stat</span>
<div id="prevstatistics"></div>
<h2>Stk Status</h2>
<div id="StkStatus"></div>


<h2><r>watchUp</r></h2>
<div id="watchUp"></div>

<h2><r>already up<r></h2>
<div id="alreadyup"></div>

<h2>Second Cross</h2>
<div id="SecondCross"></div>

<h2><gr>Third Cross<gr></h2>
<div id="ThirdCross"></div>


<h2>cross status</h2>
<div id="upcrossResult"></div>



</pre>

<script>
  codetable = ['00700', '00388', '09988', '09888', '00788', '00308', '00390', '03988', '01810', '03690', '06618', '02388', '00175', '00291', '02333', '00136', '01171', '01610', '00001', '00002', '00003', '00005', '00006', '00011', '00012', '00016', '00017', '00027', '00066', '00101', '00241', '00267', '00288', '00316', '00322', '00386', '00669', '00688', '00762', '00823', '00857', '00868', '00881', '00883', '00939', '00941', '00960', '00981', '00992', '01038', '01044', '01088', '01093', '01109', '01113', '01177', '01209', '01211', '01299', '01378', '01398', '01876', '01928', '01929', '01997', '02020', '02269', '02313', '02318', '02319', '02331', '02382', '02628', '02688', '03692', '03968', '06098', '06690', '06862', '09618', '09633', '09999', '01613', '02013', '01186', '02009', '01766', '01288', '02600', '02899', '01339', '00285', '01833', '02823', '00358', '03808', '00956', '00819', '03993', '02822', '03067', '03998', '02099', '01618', '07226', '02039', '06818', '02362', '07299', '03033', '00148', '09911', '02840', '03969', '00855', '03319', '03032', '01208', '00694', '02618', '01858', '01179', '01860', '00884', '00799', '02778', '01910', '00880', '00873', '02800', '00363', '00123', '02828', '07200', '02128', '01234', '02883', '07288', '00586', '02666', '02777', '02285', '03037', '02256', '09961', '02208', '03983', '02015', '00412', '00135', '00020', '00909', '01811', '00751', '02727', '00425', '02839', '01060', '02338', '02356', '00861', '01313', '01357', '00998', '01336', '82822', '00440', '01070', '01958', '01821', '00598', '01359', '02328', '00023', '03899', '01963', '00489', '00200', '01787', '06088', '01428', '00317', '01478', '02869', '06078', '01024', '00813', '00081', '03383', '00467', '00165', '01238', '01112', '00083', '02342', '06699', '02888', '00836', '01666', '06049', '01972', '03160', '00856', '06837', '03323', '00576', '00916', '01801', '00142', '00270', '00772', '00371', '01579', '00345', '09868', '00119', '01302', '02708', '01918', '06886', '01415', '02057', '01099', '02669', '02186', '00656', '06110', '00667', '06185', '00683', '01913', '00038', '01193', '03900', '06178', '06855', '03188', '00302', '09698', '01772', '00934', '02359', '00570', '00152', '01030', '00639', '00151', '09987', '00257', '01066', '06186', '02276', '01368', '02386', '00778', '01508', '00636', '00087', '03311', '07248', '06160', '01513', '02638', '00069', '03110', '02858', '02500', '03320', '02400', '02255', '01600', '07568', '07522', '07552', '03613', '01516', '00014', '00548', '01548', '03360', '02202', '00435', '03377', '01898', '01877', '01072', '09969', '00579', '00297', '03337', '02096', '00177', '02233', '02588', '03328', '09966', '00867', '00995', '01798', '02607', '09926', '01919', '02601', '03898', '01882', '02018', '02357', '09995', '01385', '00966', '02343', '00522', '01818', '01138', '09901', '03709', '00874', '00991', '00004', '00010', '00019', '00116', '00182', '00220', '00293', '00303', '00323', '00341', '00347', '00354', '00357', '00384', '00511', '00525', '00551', '00552', '00590', '00670', '00696', '00728', '00763', '00777', '00780', '00817', '00853', '01052', '01055', '01119', '01128', '01157', '01199', '01310', '01316', '01381', '01448', '01477', '01515', '01530', '01658', '01681', '01725', '01776', '01797', '01800', '01816', '01883', '01888', '01896', '01908', '01951', '01952', '01999', '02196', '02238', '02252', '02611', '02689', '02866', '03115', '03175', '03339', '03347', '03396', '03618', '03738', '03759', '03800', '03888', '03908', '06030', '06060', '06099', '06616', '06666', '06806', '06823', '06830', '06869', '06881', '09626', '09668', '09992', '02005', '02155', '01907', '07500', '02162', '02145', '02215', '02380', '00189', '00520', '00535', '00631', '00914', '00921', '01057', '01071', '01347', '01812', '02192', '02806', '06066', '09922', '09959', '00451', '03606', '06969', '00268', '01337', '07221', '00144', '00564', '00757'];
  mustAdd = mustAdd.split(" ")
  codetable = codetable.concat(mustAdd)
  codetable = [...new Set(codetable)]

  fraudSTK = fraudSTK.split(" ")
  ignoreSTK = ignoreSTK.split(" ")
  fraudSTK = fraudSTK.concat(ignoreSTK)
  fraudSTK = [...new Set(fraudSTK)]

  codetable = codetable.filter(val => !fraudSTK.includes(val));
  codetableLen = codetable.length

      // loop to collect data and chkCross, results in here
     upcrossResulttxt = "";
     NewUpcross = ""
     NewDncross = ""
     NewHUpcross = ""
     NewLDncross = ""
     HContUp = ""
     LContDn = ""
     MContUp = ""

     upcrossCnt = 0
     dncrossCnt = 0
     hupcrossCnt = 0
     ldncrossCnt = 0
     MContUpCnt = 0
     MContDnCnt = 0

     thestkdata = [];
     dateLst = [];
     openLst = [];
     highLst = [];
     lowLst = [];
     midLst = [];
     closeLst = [];
     amtLst = [];
     startIntv = 5;
     stkName = "";
     period = 75;

      dataStatus = "M"
      intv1 = startIntv
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
      halfNum = Math.round(intv1/2)

      stkpriceDataArr = [];
      stkList = 恒指成分.split(' ');
      stkPointer = 0;
      titleText = "";
      starti = 0;
      chartColor = ['white',
                    'red','#c80','#c60','#c40',
                    '#0f4','#066','#086','#084',
                    'purple','purple']

      attentionList = ""

      var options = '';  // build the List select option
      for (var i = 0; i < allListNames.length; i++) {
         options += '<option value="' + allListNames[i]+ '">' + allListNames[i] + '</option>';
      }
      $("#selectList").html(options);

      if (localStorage.getItem("attentionList") === null) {
        localStorage.attentionList = "07500";
      } else{
        attentionList = localStorage.getItem("attentionList").split(',');
      }

      // load localStorage.savedCodeList
      if (localStorage.getItem("savedCodeList") === null) {
        quickCodeList = ["110000"];
        localStorage.savedCodeList = quickCodeList;
      } else{
        quickCodeList = localStorage.getItem("savedCodeList").split(',');
      }

      // added extra links
      bigVolHeader = "http://www.etnet.com.hk/www/tc/stocks/realtime/quote_transaction.php?code="
      shortsellHeader = "http://www.aastocks.com/tc/stocks/analysis/stock-short-selling-ratio.aspx?symbol="
      newshead = "http://www.aastocks.com/tc/stocks/analysis/stock-aafn/"
      newstail = "/0/all/1"

      // main loop
      for (var i = 0; i < codetable.length; i++) {
         collectStkData(codetable[i])
      }


      function updateStat(statname) {
      // update stat
      prevstat = localStorage.getItem(statname);
      if (prevstat === null) {
        document.getElementById("prevstatistics").innerHTML = ""
      } else{
        document.getElementById("prevstatistics").innerHTML = prevstat
      }

      localStorage.setItem(statname, 
        document.getElementById("statistics").innerHTML)
      }

      function askforCode() {
        var tempCode = prompt("Code Number:", "");
        if (tempCode != null && tempCode != ""){

            codewidth = tempCode.length
            if(codewidth <= 5){
              theCode = "00000"+tempCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }else{
              theCode = tempCode
            }

           storeCode(theCode)
           collectStkData(theCode)
        }
      }

      function collectStkData(theCode) {

        storeCode(theCode);
          if( theCode.substring(0, 2) == "us"){
              // number of day klines shold be small to avoid slow response, even drop out
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/usfqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
              imageCode = theCode
          }else{

            if(theCode == "110000"){
             theCode = "HSI"; imageCode = "110000"
            }

          codewidth = theCode.length
          if(theCode == "HSI"){
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,100,qfq';
              imageCode = "110000"
          }else{

            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
              theStartCode = theCode
              imageCode = theCode
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,100,qfq';
            }else{
              codewidth = theCode.length
              if((codewidth == 6) && !hsReservedCode.includes(theCode)){
                 if (theCode.charAt(0) == "6"){
                    imageCode = theCode+".sh"; // note this comes before following line
                    theCode = "sh"+theCode; 
                 }else{
                    imageCode = theCode+".sz";
                    theCode = "sz"+theCode
                 }
                 theStartCode = theCode
                 theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
              }else if(codewidth == 9){
                imageCode = theCode
                theCode = theCode.substring(7, 9) + theCode.substring(0, 6);
                theStartCode = theCode

                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
              }else{
                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
                theStartCode = theCode
                imageCode = theCode
              }
            }
          }
        }

          theStartCode = theCode;
          thedrawdata = [];
          amtLst.length = 0;

          $.get(theurl).done(function(rawJSON) { 
              rawJSON = eval(rawJSON)
              var keys = Object.keys(rawJSON); // read the structure keys ["code", "msg", "data"]

              var insideDatakey = Object.keys(rawJSON)[2] //
              // myobj[Object.keys(myobj)[0]] this is the extract method
      
              var thedata = rawJSON[Object.keys(rawJSON)[2]]
              thestkkey = Object.keys(thedata)[0] // this is the stk key name
              var tempdata = thedata[Object.keys(thedata)[0]];
              thestkdata = tempdata[Object.keys(tempdata)[0]]; // real data here, this is whole dataset

              if(thestkdata.length == 0){alert("no data in: " + thestkkey)}

              for(i=(thestkdata.length-12);i<thestkdata.length;i++){
                    thedate = thestkdata[i][0];  // date
                    if(codewidth <= 5){
                      theAmtIdx = 8;
                    }else{
                      theAmtIdx = 5;
                    }

                    theamt = Math.round(Number(thestkdata[i][theAmtIdx]));
                    if(codewidth > 5){
                      if(theCode.slice(0, 5) == "sh688"){
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/10000);
                      }else{
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/100);
                      }
                    }

                    theamt = theamt.toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",");
                    $("#turnover").prepend( theamt,"w ");
              }
      
              theNameObj = tempdata[Object.keys(tempdata)[1]];
              theNameObjName  = theNameObj[Object.keys(theNameObj)[0]];
              stkName = theNameObjName[1]

              /* data is arranged in days array, tempdata[320] is last set
              tempdata[320][0]  // date, tempdata[320][1]  // open, tempdata[320][3]  // high
              tempdata[320][4]  // low, tempdata[320][2]  // close */
      
              //period + intv1, the chartwidth + max trend interval
              starti = thestkdata.length - (parseInt(period) + parseInt(intv1)) -5; 

              if(starti <= 0){
                  console.log(theStartCode + " " + stkName +" not enough data! dataLength: " + thestkdata.length);
                  return;
              }

              dateLst = [];
              openLst = [];
              highLst = [];
              lowLst = [];
              midLst = [];
              closeLst = [];
              amtLst = [];

              for (let i = starti; i < thestkdata.length; i++) {
                  dateLst.push(thestkdata[i][0]);
                  openLst.push(Number(thestkdata[i][1]));
                  highLst.push(Number(thestkdata[i][3]));
                  lowLst.push(Number(thestkdata[i][4]));
                  midLst.push((Number(thestkdata[i][3]) + Number(thestkdata[i][4]))/2);
                  closeLst.push(Number(thestkdata[i][2]));
                  amtvalue = "&emsp;" + Math.round(Number(thestkdata[i][8])).toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",") +"w ";
                  amtLst.push(amtvalue);
              }
              // redraw();  // this line must be inside the AJAX because AJAX run last
              lastPrice = closeLst[closeLst.length-1]
              chkCross(stkName, highLst, midLst, theCode, lastPrice) // must put inside the RGraph.AJAX.getJSON
           });

           //showActivity(theCode)
           window.scrollTo(0,0);
      }

     function chkKey() {
       var testkey = getChar(event);
   console.log(testkey)
       if(testkey == '0'){ theCode = '000001.sh'; collectStkData('000001.sh');}
       else if(testkey == '3'){ theCode = '399001.sz'; collectStkData('399001.sz');}
       else if(testkey == '1'){ theCode = '110000'; collectStkData('HSI');}
       else if(testkey == '2'){ theCode = '02013'; collectStkData('02013');}
       else if(testkey == '4'){ theCode = '01766'; collectStkData('01766');}
       else if(testkey == '5'){ theCode = '02009'; collectStkData('02009');}
       else if(testkey == '6'){ theCode = '01186'; collectStkData('01186');}
       else if(testkey == '7'){ theCode = '00788'; collectStkData('00788');}
       else if(testkey == '8'){ theCode = '00308'; collectStkData('00308');}
       else if(testkey == '9'){ theCode = '00390'; collectStkData('00390');}
       else if(testkey == 'u'){ theCode = 'us.DJI'; collectStkData('us.DJI');}
       else if(testkey == 'n'){ theCode = 'us.IXIC'; collectStkData('us.IXIC');}
       else if(testkey == 'J'){ theCode = 'us.INX'; collectStkData('us.INX');}
       else if(testkey == 'U'){ $('#usstock').toggle(); window.location = '#usstock';}
       else if(testkey == 'c'){askforCode();}
       else if(testkey == '+'){addToquickCodeList();}
       else if(testkey == 'q'){updateStat("ChkXAprevStatus");}
       //else if(testkey == 'q'){myfavor();}
       else if(testkey == 'Q'){usequickCodeList();}
       else if(testkey == 'B'){usestkListArr();}

       // if(testkey == '+'){addToAttentionList();}
       else if(testkey == '-'){removeFmquickCodeList();}
       else if(testkey == 'X'){storeCode(theCode); window.open("Random Charts.html");}
       else if(testkey == '.'){storeCode(theCode); window.open("mlineMinutechart.html");}

       else if(testkey == 'a'){useAttentionList();}
       else if(testkey == 'f'){jpforward();}
       else if(testkey == ']'){jpforward();}
       else if(testkey == 'b'){jpback();}
       else if(testkey == '['){jpback();}
       else if(testkey == 'r'){jprandom();}
       else if(testkey == 'w'){window.scrollTo(0,0);}
       //else if(testkey == 'D'){window.location = '#image';}
       else if(testkey == 'd'){xunbao(localStorage.randomcode);}

       else if(testkey == 'l'){window.location = '#endpage';console.log("l: ");}
       else if(testkey == 'i'){chgIntv();}
       else if(testkey == 'W'){chgchartWidth();}
       else if(testkey == 'j'){period = 300; intv1 = 30; collectStkData(theCode);}
       else if(testkey == 'k'){period = 50; intv1 = 2; collectStkData(theCode);}

       else if(testkey == 'C'){chgCloseLst();}
       // else if(testkey == 'L'){askList()}
       else if(testkey == 'L'){askCodetable()}
       else if(testkey == 'z'){largeCht()}
       else if(testkey == 't'){setTabWidth()}
       else if(testkey == 'e'){window.location = '#commands';
            window.scrollTo(window.scrollX, window.scrollY + 2000);}
       else if(testkey == 's'){window.location = '#accel';
            window.scrollTo(window.scrollX, window.scrollY - 500);}
       else if(testkey == 'E'){window.location = '#filterMarkers';}
       else{chkOtherKeys(testkey)} 
     }

     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

     function xunbao(xunbaocode) {
       localStorage.setItem("randomcode", xunbaocode)
       localStorage.setItem("otherCode", xunbaocode)
       localStorage.setItem("stkCode", xunbaocode)

       locs = ["HIghLowTrend.html", "Random Charts.html", ]
         window.open("HIghLowTrend.html")
     }

	function fillLineData() {
      var dataArr = prompt("Enter data array sep by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        redraw()
      }
     }

      function addToquickCodeList() {
        codewidth = theCode.length
        if(codewidth <= 5){
          theCode = "00000"+theCode;
          codewidth = theCode.length;
          theCode = theCode.slice(codewidth-5, codewidth);
        }
        if (!quickCodeList.includes(theCode)) {
          quickCodeList.push(theCode);
          quickCodeList = Array.from(new Set(quickCodeList)); // set unique
          localStorage.savedCodeList = quickCodeList;
          alert(theCode + " added to quickCodeList")
        }else{alert(theCode + " already exist!")}
      }

    function usequickCodeList() {
        stkList = quickCodeList;
        alert("quickCodeList Total: " + quickCodeList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("quickCodeList Total: " + quickCodeList.length + "\n"+stkList);
    }

    function usestkListArr() {
      stkListArr = localStorage.getItem("stkListArr")
      if (stkListArr === null) {
         stkList = quickCodeList;
      } else{
         stkList = stkListArr;
      }
        alert("Use stkListArr, Total: " + stkListArr.length + " : "+stkListArr)
        $("#message").text("stkListArr Total: " + stkListArr.length + "\n"+stkList);
    }

	function addToAttentionList() {
            codewidth = theCode.length
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }

        attentionList.push(theCode)
        attentionList = [...new Set(attentionList)]; // set unique

        ItemIndex = attentionList.indexOf("");  // remove empty items
        if (ItemIndex > -1) { attentionList.splice(ItemIndex, 1); }

        localStorage.setItem("attentionList", attentionList);
        alert(theCode + " added to attentionList!")
     }
	function removeFmquickCodeList() {
        ItemIndex = quickCodeList.indexOf(theCode);
        if (ItemIndex > -1) { quickCodeList.splice(ItemIndex, 1); }
        quickCodeList = [...new Set(quickCodeList)]; // set unique
        localStorage.setItem("quickCodeList", quickCodeList);
        alert(theCode + " removed fm quickCodeList!")
   }

     function redraw() { // includes main chart and aux charts
        initIntvSteps()
        titleText = showDate() +" "+ showTime()+", p1: "+intv1 +" w: "+(thestkdata.length-starti) +"\n"+theStartCode + " " + stkName + " 日線 ";
        $("#amtLst").html("Amt: ".concat(amtLst.slice((amtLst.length-14),amtLst.length).join("")));

 
        RGraph.reset(document.getElementById('cvs'));

        stkpriceDataArrC = closeLst
        stkpriceDataArrL = lowLst
        stkpriceDataArrM = midLst
        stkpriceDataArrH = highLst
        stdDevH = makeStd(highLst, intv3)
        stdDevL = makeStd(lowLst, intv3)

specialBackUp = lowLst.slice();  // backup array to avoid shadow changes
        newDevadd = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a + stdDevH[i]);
        newDevminus = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a - stdDevL[i]);

        mydata = [ stkpriceDataArrM]

          mydata.push(stkpriceDataArrH)
          mydata.push(makeMovAve(stkpriceDataArrH, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrH, intv1))
          mydata.push(makeMovAve(stkpriceDataArrH, intv2))
          //mydata.push(makeMovAve(mydata[1], intv3))
          //mydata.push(makeMovAve(mydata[1], intv4))  // line 6

          mydata.push(stkpriceDataArrL) // line 6, index 5
          mydata.push(makeMovAve(stkpriceDataArrL, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrL, intv1))
          mydata.push(makeMovAve(stkpriceDataArrL, intv2))
          //mydata.push(makeMovAve(mydata[5], intv3))
          // mydata.push(makeMovAve(mydata[5], intv4))

          //mydata.push(makeMovAve(mydata[1], intv8))
          mydata.push(newDevadd)
          mydata.push(newDevminus)  // line 8
        theMax = Math.max(...[].concat(...mydata));
        theMin = Math.min(...[].concat(...mydata));

        thedrawdata = mydata
        //thedrawdata.push(makeMovAve(thedrawdata[2], intv1));  // add one line to check results

        thedrawdata[1] = thedrawdata[1].fill(null,0,0)
        thedrawdata[2] = thedrawdata[2].fill(null,0,halfNum)
        thedrawdata[3] = thedrawdata[3].fill(null,0,intv1)
        thedrawdata[4] = thedrawdata[4].fill(null,0,intv2)

        thedrawdata[5] = thedrawdata[5].fill(null,0,0)
        thedrawdata[6] = thedrawdata[6].fill(null,0,halfNum)
        thedrawdata[7] = thedrawdata[7].fill(null,0,intv1)
        thedrawdata[8] = thedrawdata[8].fill(null,0,intv2)

        thedrawdata[9] = thedrawdata[9].fill(null,0,intv3)
        thedrawdata[10] = thedrawdata[10].fill(null,0,intv3)

        //thedrawdata[11] = thedrawdata[11].fill(null,0,intv3)
        //thedrawdata[12] = thedrawdata[12].fill(null,0,intv1)  // add one line 

lowLst = specialBackUp  // recover data

statusMsg = '<br><span class="red">price '+ mydata[0].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">intvS '+ mydata[1].slice(-1)[0].toFixed(3) +
'</span>, <span class="blue">intvL '+ mydata[2].slice(-1)[0].toFixed(3) +
'</span>, <span class="purple">Top '+ mydata[3].slice(-1)[0].toFixed(3) +
'</span>, <span class="yellow">Bottom '+ mydata[4].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">IntvS '+ intv1 +
'</span>, <span class="blue">IntvL '+ intv2 +
'</span>'

$("#lastValues").text("");
$("#lastValues").append(statusMsg);

       drawchart()

		// create datalog table
		 transp = transpose(mydata);
            wAveTrendRange = [];  // this is the gap diff
		  for (var row=0; row < transp.length; row++) {
		    rowRange = transp[row].slice(1, mydata.length);
      	    rowMax = Math.max(...rowRange);
      	    rowMin = Math.min(...rowRange);
      	    var rowDiff = rowMax - rowMin;
      	    wAveTrendRange.push(rowDiff);
      	  }

		wAveTrendRange.fill(null,0,intv3);
		wAvemax = Math.max(...wAveTrendRange);
		wAvemin = Math.min(...wAveTrendRange);
		drawTrend(wAveTrendRange, wAvemax, wAvemin, 'TP');

		// find derivative
		derivative = diff(makeMovAve(mydata[0], 3));
		derivative.unshift(0);
		derivative.fill(null,0,intv1+3); //array.fill(value, start, end)

		// diffaccel
		// diffaccel = thedrawdata[baseSubIdx].map(function(item, index) { return item - thedrawdata[baseMinuIdx][index]; })
		diffaccel = []
		diffaccel.push(thedrawdata[1].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[2].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[3].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[4].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[5].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[6].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[5].fill(null,0,intv3); //array.fill(value, start, end)

		diffaccMax = Math.max(...[].concat.apply([], diffaccel));
		diffaccMin = Math.min(...[].concat.apply([], diffaccel));
		drawTrend(diffaccel, diffaccMax, diffaccMin, 'accel');

		// ddiffaccel
		ddiffaccel = []
		ddiffaccel.push(diffaccel[0].map(function(item, index) { return item - diffaccel[1][index]; }))
		ddiffaccel.push(diffaccel[1].map(function(item, index) { return item - diffaccel[2][index]; }))
		ddiffaccel.push(diffaccel[2].map(function(item, index) { return item - diffaccel[3][index]; }))
		//ddiffaccel.push(diffaccel[3].map(function(item, index) { return item - diffaccel[4][index]; }))
		//ddiffaccel.push(diffaccel[4].map(function(item, index) { return item - diffaccel[5][index]; }))
		//ddiffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)

		ddiffaccMax = Math.max(...[].concat.apply([], ddiffaccel));
		ddiffaccMin = Math.min(...[].concat.apply([], ddiffaccel));
		drawTrend(ddiffaccel, ddiffaccMax, ddiffaccMin, 'accaccel');

		// find stoch
		stoch1 = makeStoch(mydata[0], 50)
		stochmax1 = Math.max(...stoch1);
		stochmin1 = Math.min(...stoch1);
		drawTrend(stoch1, stochmax1, stochmin1, '强弱50');

        // evaluate B/S
        lastdayPtr = mydata[0].length-1
        statBegin = lastdayPtr - 29
        actionStr = ""
        for (var i = statBegin; i < (lastdayPtr+1); i++) {
          // define references
          Mvalue = mydata[0][i]
          Hvalue = mydata[1][i]
          Lvalue = mydata[5][i]
          hRefvalue = mydata[2][i]
          lRefvalue = mydata[6][i]
          h2Refvalue = mydata[3][i]
          l2Refvalue = mydata[7][i]
          acRefvalue = diffaccel[1][i]
          // compare indicators
          Hdiff = (Hvalue - hRefvalue).toFixed(2)
          Ldiff = (Lvalue - lRefvalue).toFixed(2)
          H2diff = (Hvalue - h2Refvalue).toFixed(2)
          L2diff = (Lvalue - l2Refvalue).toFixed(2)
          Mhdiff = (Mvalue - h2Refvalue).toFixed(2)
          Mldiff = (Mvalue - l2Refvalue).toFixed(2)
          acdiff = (diffaccel[0][i] - diffaccel[0][i-1]).toFixed(2)
          ac1diff = (diffaccel[0][i] - diffaccel[1][i]).toFixed(2)

          Mdiff = (mydata[0][i] - mydata[0][i-1]).toFixed(2)

          if(Hdiff >0){Hdiff = "<span class='red'>" +Hdiff + "</span>"}
          if(Ldiff >0){Ldiff = "<span class='red'>" +Ldiff + "</span>"}
          if(H2diff >0){H2diff = "<span class='red'>" +H2diff + "</span>"}
          if(L2diff >0){L2diff = "<span class='red'>" +L2diff + "</span>"}

          if(Mhdiff >0){Mhdiff = "<r>" +Mhdiff + "</r>"}
          else{Mhdiff = "<gr>" +Mhdiff + "</gr>"}
          if(Mldiff >0){Mldiff = "<r>" +Mldiff + "</r>"}
          else{Mldiff = "<gr>" +Mldiff + "</gr>"}

          if(Mdiff >0){Mdiff = "<r>" +Mdiff + "</r>"}
          else{Mdiff = "<gr>" +Mdiff + "</gr>"}

          if(acdiff >0){acdiff = "<r>" +acdiff + "</r>"}
          else{acdiff = "<gr>" +acdiff + "</gr>"}
          if(ac1diff >0){ac1diff = "<r>" +ac1diff + "</r>"}
          else{ac1diff = "<gr>" +ac1diff + "</gr>"}

          closeValue = lowLst[i]
          dateValue = dateLst[i].slice(5)

          // decision conditions
          actionStr = actionStr + dateValue + " C: " + closeValue +"\tHd: " + Hdiff + "\tLd: " + Ldiff + "\tH2d: " + H2diff + "\tL2d: " + L2diff + "\tMd: " + Mdiff + "\tacd: " + acdiff + "\tac1d: " + ac1diff + "<br>" 

          if(Hdiff>0){action = "buy"}
        }
        explanationStr = "<gr>h2d: h2 diff, l2d: L2 diff, md: M diff, acd: acc0 diff, ac1d: acc0 diff</gr>"
        actionStr = "<pre>" + actionStr + explanationStr+"</pre>"
        $("#actions").html(actionStr);

        drawOHLC()
        drawlinechart()
       }

	function makeMovAve(bigArray, intv) {
	     // the intv-1 is correct
		return bigArray.slice(0, intv-1).concat(calcMovAve(bigArray, intv));
	}
	function calcAve(aveArray) {
		add = (a, b) =>  a + b;
		return aveArray.reduce(add) / aveArray.length;
	}
	
	function calcMovAve(bigArray, intv) {
		var ma = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {ma[i] = calcWAve(bigArray.slice(i, i+intv));} // points to indicator
		return ma;
	}
	function calcWAve(aveArray) {
		var sum = 0
		for( var i = 1; i <= aveArray.length; i++ ) {
			sum += aveArray[i-1] * i;
		}
		return (sum / ((1 + aveArray.length)*aveArray.length/2))
	}

	function makeStoch(bigArray, intv) {
	     tempArr = bigArray.slice(0, intv-1).concat(calcStoch(bigArray, intv));
		return tempArr.fill(50,0,intv-1)
	}

	function calcStoch(bigArray, intv) {
		var stc = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {
			stc[i] = calc1Stoch(bigArray.slice(i, i+intv));
		}
		return stc;
	}

	function calc1Stoch(stcArray) {
			stcMax = Math.max(...stcArray)
			stcMin = Math.min(...stcArray)
			lastVal = stcArray[stcArray.length - 1]
			stcRange = stcMax - stcMin
			if(stcRange == 0){
				stcVal = 50
			}else{
				stcVal = 100*(lastVal - stcMin) / stcRange
			}
			return stcVal
	}

	function makeStd(bigArray, intv) {
	     // the intv-1 is correct
          newArray = new Array(intv-1).fill(0)
		newArray = newArray.concat(calcStd(bigArray, intv));
		return newArray
	}

	function calcStd(bigArray, intv) {
		var stdArrar = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {stdArrar[i] = Std(bigArray.slice(i, i+intv));} // points to indicator
		return stdArrar;
	}

	function Std(array) {
	  const n = array.length
	  const mean = array.reduce((a, b) => a + b) / n
	  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
	}

	function transpose(thisArr) { // Swap rows with columns of a matrix
	    return Object.keys(thisArr[0]).map(function(column) {
	        return thisArr.map(function(row) { return row[column]; });
	    });
	}

    function useAttentionList() {
        stkList = attentionList;
        alert("AttentionList Total: " + attentionList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + attentionList.length + "\n"+stkList);
    }

    function myfavor() {
        myfavorLst = mychips.split(" ");
        stkList = myfavorLst;
        alert("mychips Total: " + myfavorLst.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("mychips Total: " + myfavorLst.length + "\n"+stkList);
    }

    function askList() {
        var theList = prompt("CodeList, Number (5 digits) sep by space： ", "");
        if (theList != null && theList != "HSI" && theList != "") {
            stkList = theList.split(" ");
            alert("Supplied List Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
            $("#message").text("Supplied List Total: " + stkList.length + "\n"+stkList);
        }
        codetable = stkList
        document.getElementById("upcrossResult").innerHTML = "";

        for (var i = 0; i < codetable.length; i++) {
           collectStkData(codetable[i])
        }
    }

    function FormatNumberLength5(num) {
        var r = "" + num;
        while (r.length < 5) { r = "0" + r; }
        return r;
    }

    function jpforward() {
        if (stkPointer < stkList.length-1) {
            stkPointer = stkPointer + 1;
        } else {
            stkPointer = 0;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }

    function jpback() {
        if (stkPointer > 0) {
            stkPointer = stkPointer - 1;
        } else {
            stkPointer = stkList.length-1;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }
    function jprandom() {
        stkPointer = Math.floor(Math.random() * (stkList.length-1))
        theCode = stkList[stkPointer]
         collectStkData(theCode)
    }

    function jpTo0() {
        stkPointer = 0;
        theCode = stkList[stkPointer]
        collectStkData(theCode)
    }

    function storeCode(theCode) {
        if(typeof(Storage) !== "undefined") {
            localStorage.randomcode = theCode;
        }
    }

    function chgchartWidth() {
        newChartWidth = prompt("enter chart width:", "");
        if (newChartWidth != null && newChartWidth != "" && newChartWidth < (1000 - 2*intv1)){
          period = parseInt(newChartWidth);
          localStorage.setItem("daychartWidth", period);
          collectStkData(theCode);
        }

    }
    function chgIntv() {
        intv = prompt("intv1 value:", "");
        if (theCode != null && intv1 != ""){
          intv1 = parseInt(intv);
          initIntvSteps()
          redraw()
        }
    }
    function initIntvSteps() {
      halfNum = Math.round(intv1/2)
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
    }
    function setTabWidth() {
        tabWidth = prompt("set tab width:", "");
        if (tabWidth != null && tabWidth != ""){
          tabWidth = parseInt(tabWidth);
          document.getElementById("actions").style.tabSize = tabWidth;
        }
    }

    function chgHighList() {
        dataStatus = "H"
        redraw()
    }
    function chgLowList() {
        dataStatus = "L"
        redraw()
    }
    function chgMidList() {
        dataStatus = "M"
        redraw()
    }
    function chgCloseLst() {
        dataStatus = "C"
        redraw()
    }

    function largeCht() {
        imgHead = "http://charts.aastocks.com/servlet/Charts?fontsize=12&15MinDelay=F&lang=1&titlestyle=1&vol=1&Indicator=3&indpara1=3&indpara2=5&indpara3=10&indpara4=15&indpara5=20&subChart2=3&ref2para1=12&ref2para2=26&ref2para3=9&subChart3=12&ref3para1=0&ref3para2=0&ref3para3=0&scheme=3&com=100&chartwidth=1600&chartheight=900&stockid=";

        imgTail = "&period=2060&type=1&logoStyle=1"
        imgURL = imgHead + theCode + imgTail
        window.open(imgURL, "_blank")
    }

function assignList(){
  newList = eval(document.getElementById("selectList").value).split(" ");
  stkList = newList;
  codeList = newList;

  document.getElementById("message").focus();
  alert(" Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!\n" + newList)
        $("#message").text("Total: " + stkList.length + "\n"+stkList);
  $('#selectList').blur()

}

function showDateTime() {
    cmtCode = theCode // use another name not to interfere other parts
    var cmtcodewidth = cmtCode.length
    if(cmtcodewidth <= 5){
      cmtCode = "00000"+cmtCode;
      cmtcodewidth = cmtCode.length;
      cmtCode = cmtCode.slice(cmtcodewidth-5, cmtcodewidth);
    }
    else if(cmtcodewidth == 8){ cmtCode = cmtCode.slice(2, 8); }
    else if(cmtcodewidth == 9){ cmtCode = cmtCode.slice(0, 6); }
    commentName = "j" + cmtCode;

    CommentListNames = Object.keys(theCommentList); // extract the names from comments
    // to show comments
    if(CommentListNames.includes(commentName)){
      cmtLocation = CommentListNames.indexOf(commentName);
      commentTxt = theCommentList[Object.keys(theCommentList)[cmtLocation]]
    }else{commentTxt = "No data!";}

    document.getElementById("dateTime").innerHTML ="<span class='orange'>" + commentTxt + "</span>";
}

    function drawchart() {
      listItems = []
      if(dataStatus == "C"){ tooltips = closeLst
      }else if(dataStatus == "L"){ tooltips = lowLst
      }else if(dataStatus == "M"){ tooltips = midLst
      }else { tooltips = highLst}

      dataTooltips = tooltips.map(item => Math.round(item * 1000) / 1000)
      for (index = 0; index < dataTooltips.length; index++) {
        listItems[index] = dateLst[index] + "<br><span class='red'>" + dataStatus + "</span>: " + dataTooltips[index];
      }

      dataTooltips = dataTooltips.map(String)

      var line = new RGraph.Line({
        id:'cvs',
        data: thedrawdata,
        options: {
			title: titleText + " " + "MHL + trends",
			titleColor: 'grey',
			titleSize: 20,
               colors: chartColor,
            backgroundGrid: true, backgroundGridVlines: true,
            backgroundGridColor: '#001000', backgroundGridBorder: false,
            // backgroundGridDotted: true,
            backgroundGridDashed: true, 
            axisColor: '#864',  scaleDecimals: 2,
            xaxis: true,
            //xaxisLabels: ["a","b","c","d"],
            textColor: '#ccc',
            tickmarks: 'plus',
            ticksize: 1,
            linewidth:1,
			ymax: theMax,
			ymin: theMin,
      // labels control the number of grids
            // labels: ['2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018'],
            spline: false,
            shadow: false,
            tooltips: listItems,
            gutterLeft: 0, gutterRight: 50,
            gutterTop: 25, gutterBottom: 25
            }
          }).trace();

		yminpct = 100 - (theMax-theMin)*100/theMax,
		ymaxpct = 100,

          yaxis1 = new RGraph.Drawing.YAxis('cvs', 1200)
                .Set('colors', ['gold'])
                .Set('text.color', 'gray')
                .Set('text.size', 8)
                .Set('max', ymaxpct)
                .Set('min', yminpct)
                .Set('linewidth', 2)
                .Set('tickmarkslength', 5)
                .Set('title', '% pct')
                .Draw();

    };

    function drawTrend(therange,maxValue, minValue, chartID) {
       // dataTooltips = therange.map(item => Math.round(item * 1000) / 1000)
       // dataTooltips = dataTooltips.map(String)
       RGraph.reset(document.getElementById(chartID));
       line = new RGraph.Line({
       	id:chartID, data:therange,
       	options: {
       		title: chartID + ", "+theStartCode + " " + stkName,
    			titleColor: 'grey', 
    			titleSize: 10,
       		backgroundGrid: true, axisColor: '#864', textColor: '#ccc',
    		numxticks: 0, colors: chartColor, scaleDecimals: 2,

       		tickmarksDotLinewidth: 0,ticksize: 1, linewidth: 1, 
       		ymax: maxValue, ymin: minValue,
               tickmarks: 'plus',

       		spline: false, shadow: false,
              // tooltips: dataTooltips,
			backgroundGridVlines: true,
			backgroundGridDashed: true, 
       		backgroundGridColor: '#001000',
       		gutterLeft: 0, gutterRight: 50, gutterTop: 25, gutterBottom: 25
       	}
       }).trace();
    };
    
    function diff(arr) {
      return arr.slice(1).map(function(n, i) { return n - arr[i]; });
    }

function showActivity(thecode){
    markers = filterResult.filter(element => element.includes(thecode));
    // clean the h2 tags
    markers = markers.map(element => element.replace(/<\/h2>.*/gi, ""))
    markers = markers.map(element => element.replace(/<h2>/gi, ""))

    markers = markers.map(element => formatWeekDay(element))
    if (markers.length > 50) markers.splice(0, markers.length-80);

    $('#filterMarkers').append("<b class='red'>" + thecode + " 日线特征:</b><br>")
    $('#filterMarkers').append(markers)
}

// format WeekDay
function formatWeekDay(element) {
    dayStr = element.replace(/<.*?>/gi, "") // clean span tags
    dayStr = dayStr.substr(0,6)
    dayStr = convertWeekday(dayStr)
    return(dayStr + " " + element + "<br>")
}

// convert date string to weekday
function parse(str) {
    str = "20" + str
    var y = str.substr(0,4), m = str.substr(4,2) - 1,
        d = str.substr(6,2);
    var D = new Date(y,m,d);
    return (D.getFullYear() == y && D.getMonth() == m && D.getDate() == d) ? D : 'invalid date';
}
function convertWeekday(str) {
    return ["SUN","MON","TUE","WED","THU","FRI","SAT"][parse(str).getDay()]
}
function fetchUsCode(str) {
    theCode = str; collectStkData(str); window.location = '#cvs';
    $('#usstock').toggle();
}

function handleRight( event ){
    codeListPtr = codeListPtr +1
    theCode = codeList[codeListPtr];
    collectStkData(theCode);
}

    codeList = codeList.split(' ')
    codeListPtr = 0

    // $( "html" ).on( "swiperight", handleRight );
    // $( "html" ).on( "swipeleft", askforCode );
    window.addEventListener('click', function (evt) {
        if (evt.detail === 3) { askforCode(); }
    });

    collectStkData(theCode);

function docLoaded() {
    let script1 = document.createElement('script');
    script1.src = 'https://williamkpchan.github.io/LibDocs/readbook.js';
    document.body.appendChild(script1);
    let script = document.createElement('script');
    script.src = 'C:/R programs/!!! STKMon !!!/headerApp.js';
    document.body.appendChild(script);
    window.scrollTo(0,(document.body.scrollHeight));

}

    function drawOHLC() { // includes main chart and aux charts
      var ohlcdata = {
        close:  closeLst,
        low:  lowLst,
        open:  openLst,
        high:  highLst,
        x:  dateLst,
        line: {color: 'rgba(31,119,180,1)'}, 
        increasing: {line: {color: 'red'}},
        decreasing: {line: {color: 'green'}},
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
      };

      var data = [ohlcdata];
      var layout = {
      title: titleText,
        dragmode: 'zoom', 
        showlegend: false,
        xaxis: { rangeslider: { visible: false } }, 
        yaxis: { autorange: true,  type: 'linear' }
      };
      Plotly.newPlot('ohlcDiv', data, layout);
    }


    function chkCross(stkName, highLst, midLst, thisCode, lastPrice) { // includes main chart and aux charts
      contUCnt = 0
        statustxt = `<k onclick="xunbao('` + thisCode + `')">`+ thisCode + " <r>" + stkName+ '</r></k>&emsp;'
        $("#StkStatus").append( "<br>" +statustxt);

      // mid data
      dLineM0 = midLst
      dLineM1 = makeMovAve(midLst, intv1)
      dLineM2 = makeMovAve(midLst, intv2)
      dLineM3 = makeMovAve(midLst, intv3)
      dLineM4 = makeMovAve(midLst, intv4)

      indexlast = dLineM0.length-1

      curM0 = dLineM0[indexlast]
      prevM0 = dLineM0[indexlast-1]

      curM1 = dLineM1[indexlast]
      prevM1 = dLineM1[indexlast-1]

      curM2 = dLineM2[indexlast]
      prevM2 = dLineM2[indexlast-1]

      curM3 = dLineM3[indexlast]
      prevM3 = dLineM3[indexlast-1]

      curM4 = dLineM4[indexlast]
      prevM4 = dLineM4[indexlast-1]


      // H data
      dLineH0 = highLst
      dLineH1 = makeMovAve(highLst, intv1)
      dLineH2 = makeMovAve(highLst, intv2)

      curH0 = dLineH0[indexlast]
      prevH0 = dLineH0[indexlast-1]

      curH1 = dLineH1[indexlast]
      prevH1 = dLineH1[indexlast-1]

      curH2 = dLineH2[indexlast]
      prevH2 = dLineH2[indexlast-1]

      // Lo data
      dLineLo0 = lowLst
      dLineLo1 = makeMovAve(lowLst, intv1)
      dLineLo2 = makeMovAve(lowLst, intv2)

      curLo0 = dLineLo0[indexlast]
      prevLo0 = dLineLo0[indexlast-1]

      curLo1 = dLineLo1[indexlast]
      prevLo1 = dLineLo1[indexlast-1]

      curLo2 = dLineLo2[indexlast]
      prevLo2 = dLineLo2[indexlast-1]


      // checkX(prevL, prevS, curL, curS) check mid

      curS = curM0
      prevS = prevM0
      curL = curM1
      prevL = prevM1
      checkXMsg = "<k> M0XM1 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      curL = curM2
      prevL = prevM2
      checkXMsg = "<k> M0XM2 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      curL = curM3
      prevL = prevM3
      checkXMsg = "<k> M0XM3 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      curL = curM4
      prevL = prevM4
      checkXMsg = "<k> M0XM4 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 4){
        $("#alreadyup").append(statustxt);
      }

      curS = curM1
      prevS = prevM1
      curL = curM2
      prevL = prevM2
      checkXMsg = "<dr> M1XM2 </dr>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 5){
        $("#SecondCross").append(statustxt);
      }

      curS = curM2
      prevS = prevM2
      curL = curM3
      prevL = prevM3
      checkXMsg = "<k> M2XM3 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 6){
        $("#ThirdCross").append(statustxt);
      }



      // show status
      upcrossResulttxt = `<k onclick="xunbao('` + theCode + `')">`+ theCode + " " + stkName+ '</k>' + ": " 
         + " latest Price: " + lastPrice + "<br>"
         + "<br><br>";

      oldmsg = document.getElementById("upcrossResult").innerHTML
      document.getElementById("upcrossResult").innerHTML = oldmsg + upcrossResulttxt;


    }

    function checkX(prevL, prevS, curL, curS) {
		if (curS == curL){return "critical" }
		if (((prevL == prevS) && (curS > curL )) || ((prevL>prevS) && (curS > curL ))){return "<span class='redrose'>UpCross</span>" }
		if (((prevL == prevS) && (curS < curL )) || ((prevL<prevS) && (curS < curL ))){return "<gr>DownCross</gr>" }
		if ((prevL<prevS) && (curS > curL )){return '<span class="brownword">cont.Up</span>' } // c must > prevC, this is not correct, further check for condition
		if ((prevL>prevS) && (curS < curL )){return '<span class="limeword">cont.Dn</span>' }
	}


</script>

<script>
     function askCodetable() {
       var theCodetable = prompt("Enter stk list seperated by space:", "");
       if (theCodetable != null && theCodetable != "") {
         theCodetable = JSON.stringify(theCodetable.split(" "))
         localStorage.setItem("codetableList", theCodetable);
         codetable = JSON.parse(theCodetable);
         location.reload();
       }
     }
</script>

</body>
</html>
