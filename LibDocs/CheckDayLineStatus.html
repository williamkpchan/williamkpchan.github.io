<!DOCTYPE html>
<!--meta http-equiv="refresh" content="300"-->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<html>
<head>
<title>CheckDayLineStatus</title>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src='https://williamkpchan.github.io/mainscript.js'></script>
<script src="https://williamkpchan.github.io/LibDocs/stkComments.js"></script>
<script src="https://williamkpchanhp.github.io/filterResulitLib.txt"></script>
<script src="https://code.jquery.com/mobile/1.5.0-alpha.1/jquery.mobile-1.5.0-alpha.1.min.js"></script>

<script src="https://williamkpchanhp.github.io/LibDocs/longHistList.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.core.js" ></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.line.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.drawing.yaxis.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.dynamic.js"></script>
<script src="https://williamkpchan.github.io/LibDocs/rchart/RGraph.common.tooltips.js"></script>
<script src="https://williamkpchanhp.github.io/codeList.js"></script>
<script src='https://cdn.plot.ly/plotly-2.34.0.min.js'></script>
<script>
  var showTopicNumber = false;
  var topicEnd = "&emsp;";
  var bookid = "CheckDayLineStatus"
  var markerName = "h2"
</script>

<style>
body {width:98%;margin-left: 1%; font-size:24px;}
#dateTime {  text-align: left;}
#cmtNote, #instruction, #message, #usstock{display:none;}
#amtLst {font-size:12px;}
#actions {font-size:12px; text-align: left; tab-size: 8; margin-left: 5%;}
select {border-radius:10px; font-size:20px;background-color:black; color:brown;}
#ohlcDiv {display:inline-block; width:85%; height:700px;}
#linechart {display:inline-block; width:85%; height:700px;}
#StkStatus {font-size:20px;}
</style>

</head>
<body onkeypress="chkKey()">

<center>
<h1>CheckDayLineStatus</h1>
<span class="goldword">&rarr;</span> <span id="dateAndTime" onclick="showDateAndTime()"><script>showDateAndTime();</script></span><br>
<div id="toc"></div>
</center>
<br>
<pre>
<h2>statistics</h2><span class="redbut" onclick="updateStat('CheckDayLineStatus');")>Load stat history</span> <span class="greenbut" onclick="removerec('CheckDayLineStatus');")>Remove first stat record</span><span class="yellowbut" onclick="alertStat();")>copy stat</span><span class="redbut" onclick="alertM0uXM1();")>copy M0uXM1</span><span id="stkNum"></span>
<k>statistics history</k>
<div id="prevstatistics"></div>

<pk>current statistics</pk>
<div id="currentstatistics"></div>

<h2><dr>M3XM4<dr></h2>
<div id="M3XM4"></div>
<div id="M3XM4Count"></div>

<h2><dr>M2XM3<dr></h2>
<div id="M2XM3"></div>
<div id="M2XM3Count"></div>

<h2>M1XM2</h2>
<div id="M1XM2"></div>
<div id="M1XM2Count"></div>

<h2><r>M0XM4<r></h2>
<div id="M0XM4"></div>
<div id="M0XM4Count"></div>

<h2><o>M0 Cont Up M1<o></h2>
<div id="M0ContUpM1"></div>
<div id="M0ContUpM1Count"></div>

<h2><o>M0 upCross M1<o><br></h2>
<div id="M0uXM1"></div>
<div id="M0uXM1Count"></div>

<h2><gr>M0 downCross M1<gr></h2>
<div id="M0dXM1"></div>
<div id="M0dXM1Count"></div>

<h2><gr>M0 Cont Dn M1<gr></h2>
<div id="M0ContDnM1"></div>
<div id="M0ContDnM1Count"></div>

<h2>StkStatus</h2>
<div id="StkStatus"></div>

<h2>notEnoughData</h2>
<div id="notEnoughData"></div>

</pre>

<script>
  codetable = ['02800','00700','09988','03690','00883','02828','01810','01024','00857','00939','02318','09926','01299','03033','03968','00941','01398','00522','09618','00388','00386','00005','01211','02899','03988','09999','01088','09888','00016','01288','02015','02269','09868','09961','01816','02382','00992','01919','01109','00981','00836','00001','09633','01093','02601','01910','00027','00669','06690','02020','00011','02388','00916','01928','00020','00175','02628','00291','01833','01378','00728','02359','09626','00002','02331','06862','01113','00780','00006','01801','01171','00762','09901','02688','03993','06618','01548','02618','09992','00288','06160','02319','01766','00285','01972','01800','00003','00960','06030','01658','00966','01138','02057','00688','06881','01336','03908','02313','01898','00968','02333','03692','03328','01347','01038','00788','03888','09987','01339','01177','02018','02328','01099','02883','00135','01193','01876','06865','02338','01209','03800','00316','01818','00358','02600','01071','01913','00241','00019','01997','03067','02380','00868','03998','02202','00322','02588','00819','00998','00384','00763','01787','02099','00101','00425','00914','03898','00570','01797','00390','00257','00267','00012','00066','06186','00270','00881','03320','02400','00136','02013','03618','01066','01908','01030','00683','06823','01798','03323','01208','03759','01952','06088','01918','01772','00467','01186','03969','01302','00921','01357','06110','09969','01929','02666','00772','06078','00696','03311','00293','00371','03900','00956','02162','02607','00991','06855','02238','00083','01776','02386','06818','00220','00576','06060','01157','00017','06830','03808','01044','02357','00142','03347','01359','06098','01415','00354','01179','00014','03110','02196','01128','00189','03032','00123','01896','02343','00934','00867','01368','00995','00177','00552','01883','00639','00151','09922','00489','00152','00148','00586','01381','01530','00853','02208','01882','00813','03360','00799','00598','02096','00667','09698','01610','01618','02888','01821','03738','06066','02186','06699','00880','02128','00884','01072','06886','00874','01070','01516','00551','06049','02669','02257','01513','09995','02255','00694','01681','01999','01508','00631','01478','01951','01385','00777','01448','00302','01055','00525','01199','02039','01060','03613','00004','00579','00338','00817','02869','02638','00856','00548','01963','06869','00081','00363','00590','00303','01958','00200','03377','00317','03709','01579','01316','00656','01119','01811','00341','06099','00909','02689','03319','00087','03958','02233','00297','01907','02145','02276','01888','01313','00861','01310','00038','06185','09668','09959','02777','00345','00010','03899','01666','02005','09966','00460','02877','00023','01238','00440','06808','00179','00855','00596','02866','02285','00347','06666','01995','01877','02362','06127','01428','01691','02158','01515','02155','03983','01600','00165','02801','00710','09911','00708','00670','02611','06837','00357','02252','00308','00823','01613','02009','02823','02822','07226','07299','02840','01858','01860','07200','07288','03037','00412','00751','02727','02356','02342','06178','03188','00778','00636','02500','07568','07522','07552','00182','07500','03606','06969','00268','00144','00564','03668','00300'];
  mustAdd = mustAdd.split(" ")
  codetable = codetable.concat(mustAdd)
  codetable = [...new Set(codetable)]
  document.getElementById("stkNum").innerHTML = " <u>Total stks</u>: "+ codetable.length

  fraudSTK = fraudSTK.split(" ")
  ignoreSTK = ignoreSTK.split(" ")
  fraudSTK = fraudSTK.concat(ignoreSTK)
  fraudSTK = [...new Set(fraudSTK)]

  codetable = codetable.filter(val => !fraudSTK.includes(val));
  codetableLen = codetable.length

      // loop to collect data and chkCross, results in here
     upcrossResulttxt = "";
     NewUpcross = ""
     NewDncross = ""
     NewHUpcross = ""
     NewLDncross = ""
     HContUp = ""
     LContDn = ""
     MContUp = ""

     upcrossCnt = 0
     dncrossCnt = 0
     hupcrossCnt = 0
     ldncrossCnt = 0
     MContUpCnt = 0
     MContDnCnt = 0

     thestkdata = [];
     dateLst = [];
     openLst = [];
     highLst = [];
     lowLst = [];
     midLst = [];
     closeLst = [];
     amtLst = [];
     startIntv = 5;
     stkName = "";
     period = 75;

      dataStatus = "M"
      intv1 = startIntv
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
      halfNum = Math.round(intv1/2)

      stkpriceDataArr = [];
      stkList = 恒指成分.split(' ');
      stkPointer = 0;
      titleText = "";
      starti = 0;
      chartColor = ['white',
                    'red','#c80','#c60','#c40',
                    '#0f4','#066','#086','#084',
                    'purple','purple']

      attentionList = ""

      var options = '';  // build the List select option
      for (var i = 0; i < allListNames.length; i++) {
         options += '<option value="' + allListNames[i]+ '">' + allListNames[i] + '</option>';
      }
      $("#selectList").html(options);

      if (localStorage.getItem("attentionList") === null) {
        localStorage.attentionList = "07500";
      } else{
        attentionList = localStorage.getItem("attentionList").split(',');
      }

      // load localStorage.savedCodeList
      if (localStorage.getItem("savedCodeList") === null) {
        quickCodeList = ["110000"];
        localStorage.savedCodeList = quickCodeList;
      } else{
        quickCodeList = localStorage.getItem("savedCodeList").split(',');
      }

      // added extra links
      bigVolHeader = "http://www.etnet.com.hk/www/tc/stocks/realtime/quote_transaction.php?code="
      shortsellHeader = "http://www.aastocks.com/tc/stocks/analysis/stock-short-selling-ratio.aspx?symbol="
      newshead = "http://www.aastocks.com/tc/stocks/analysis/stock-aafn/"
      newstail = "/0/all/1"

      // main loop
      M3XM4Count = 0
      M2XM3Count = 0
      M1XM2Count = 0
      M0XM4Count = 0
      M0uXM1Count = 0
      M0ContUpM1Count = 0

      M0dXM1Count = 0
      M0ContDnM1Count = 0
      totalmtweight = 0

      for (var i = 0; i < codetable.length; i++) {
         collectStkData(codetable[i])
      }

      function updateStat(statname) {
      // update stat
        prevstat = localStorage.getItem(statname);
        if (prevstat === null) { prevstat = "" }

        currentStat = document.getElementById("currentstatistics").innerHTML
        document.getElementById("prevstatistics").innerHTML = prevstat +",<br>"+ currentStat
        localStorage.setItem(statname, 
        document.getElementById("prevstatistics").innerHTML)
        window.location = '#currentstatistics';
        window.scrollTo(window.scrollX, window.scrollY - 400);
      }

      function removerec(statname) {
        currentStat = document.getElementById("prevstatistics").innerHTML
        currentStat = currentStat.split(',<br>')
        currentStat.shift();
        //currentStat.pop();
        localStorage.setItem(statname, currentStat)
        document.getElementById("prevstatistics").innerHTML = currentStat
      }

      function askforCode() {
        var tempCode = prompt("Code Number:", "");
        if (tempCode != null && tempCode != ""){

            codewidth = tempCode.length
            if(codewidth <= 5){
              theCode = "00000"+tempCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }else{
              theCode = tempCode
            }

           storeCode(theCode)
           collectStkData(theCode)
        }
      }

      function collectStkData(theCode) {

        storeCode(theCode);
          if( theCode.substring(0, 2) == "us"){
              // number of day klines shold be small to avoid slow response, even drop out
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/usfqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
              imageCode = theCode
          }else{

            if(theCode == "110000"){
             theCode = "HSI"; imageCode = "110000"
            }

          codewidth = theCode.length
          if(theCode == "HSI"){
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,100,qfq';
              imageCode = "110000"
          }else{

            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
              theStartCode = theCode
              imageCode = theCode
              theurl = 'https://web.ifzq.gtimg.cn/appstock/app/hkfqkline/get?_var=kline_dayqfq&param=hk' + theCode + ',day,,,100,qfq';
            }else{
              codewidth = theCode.length
              if((codewidth == 6) && !hsReservedCode.includes(theCode)){
                 if (theCode.charAt(0) == "6"){
                    imageCode = theCode+".sh"; // note this comes before following line
                    theCode = "sh"+theCode; 
                 }else{
                    imageCode = theCode+".sz";
                    theCode = "sz"+theCode
                 }
                 theStartCode = theCode
                 theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
              }else if(codewidth == 9){
                imageCode = theCode
                theCode = theCode.substring(7, 9) + theCode.substring(0, 6);
                theStartCode = theCode

                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
              }else{
                theurl = 'https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?_var=kline_dayqfq&param=' + theCode + ',day,,,100,qfq';
                theStartCode = theCode
                imageCode = theCode
              }
            }
          }
        }

          theStartCode = theCode;
          thedrawdata = [];
          amtLst.length = 0;

          $.get(theurl).done(function(rawJSON) { 
              rawJSON = eval(rawJSON)
              var keys = Object.keys(rawJSON); // read the structure keys ["code", "msg", "data"]

              var insideDatakey = Object.keys(rawJSON)[2] //
              // myobj[Object.keys(myobj)[0]] this is the extract method
      
              var thedata = rawJSON[Object.keys(rawJSON)[2]]
              thestkkey = Object.keys(thedata)[0] // this is the stk key name
              var tempdata = thedata[Object.keys(thedata)[0]];
              thestkdata = tempdata[Object.keys(tempdata)[0]]; // real data here, this is whole dataset

              if(thestkdata.length == 0){alert("no data in: " + thestkkey)}

              for(i=(thestkdata.length-12);i<thestkdata.length;i++){
                    thedate = thestkdata[i][0];  // date
                    if(codewidth <= 5){
                      theAmtIdx = 8;
                    }else{
                      theAmtIdx = 5;
                    }

                    theamt = Math.round(Number(thestkdata[i][theAmtIdx]));
                    if(codewidth > 5){
                      if(theCode.slice(0, 5) == "sh688"){
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/10000);
                      }else{
                        theamt = Math.round(theamt * Number(thestkdata[i][2])/100);
                      }
                    }

                    theamt = theamt.toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",");
                    $("#turnover").prepend( theamt,"w ");
              }
      
              theNameObj = tempdata[Object.keys(tempdata)[1]];
              theNameObjName  = theNameObj[Object.keys(theNameObj)[0]];
              stkName = theNameObjName[1]

              /* data is arranged in days array, tempdata[320] is last set
              tempdata[320][0]  // date, tempdata[320][1]  // open, tempdata[320][3]  // high
              tempdata[320][4]  // low, tempdata[320][2]  // close */
      
              //period + intv1, the chartwidth + max trend interval
              starti = thestkdata.length - (parseInt(period) + parseInt(intv1)) -5; 

              if(starti <= 0){
                  $('#notEnoughData').append(theStartCode + " " + stkName +" dataLength: " + thestkdata.length+ " ")
                  return;
              }

              dateLst = [];
              openLst = [];
              highLst = [];
              lowLst = [];
              midLst = [];
              closeLst = [];
              amtLst = [];

              for (let i = starti; i < thestkdata.length; i++) {
                  dateLst.push(thestkdata[i][0]);
                  openLst.push(Number(thestkdata[i][1]));
                  highLst.push(Number(thestkdata[i][3]));
                  lowLst.push(Number(thestkdata[i][4]));
                  midLst.push((Number(thestkdata[i][3]) + Number(thestkdata[i][4]))/2);
                  closeLst.push(Number(thestkdata[i][2]));
                  amtvalue = "&emsp;" + Math.round(Number(thestkdata[i][8])).toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",") +"w ";
                  amtLst.push(amtvalue);
              }
              // redraw();  // this line must be inside the AJAX because AJAX run last

              lastPrice = closeLst[closeLst.length-1]
              prevPrice = closeLst[closeLst.length-2]
              priceDiff = (lastPrice - prevPrice)/lastPrice

              lastamt = amtLst[amtLst.length-1]
              lastamt = Number(lastamt.replace(/^.*?;|w.*/g, "").replace(/,/g, ""))

              mtweight = priceDiff * lastamt/10000 // calc the mtweight for final summation

              if(lastamt > 0){
                totalmtweight = totalmtweight + mtweight // sum the totalmtweight
  
                chkCross(stkName, highLst, midLst, theCode, lastPrice) // must put inside the RGraph.AJAX.getJSON
                $("#M3XM4Count").html("<k>Total M3XM4Count: </k><bo>"+ M3XM4Count +"</bo>");
                $("#M2XM3Count").html("<k>Total M2XM3Count: </k><bo>"+ M2XM3Count +"</bo>");
                $("#M1XM2Count").html("<k>Total M1XM2Count: </k><bo>"+ M1XM2Count +"</bo>");
                $("#M0XM4Count").html("<k>Total M0XM4Count: </k><bo>"+ M0XM4Count +"</bo>");

                $("#M0uXM1Count").html("<k>Total M0uXM1Count: "+ M0uXM1Count +"</k>");
                $("#M0ContUpM1Count").html("<k>Total M0ContUpM1Count: </k><bo>"+ M0ContUpM1Count +"</bo>");

                $("#M0dXM1Count").html("<gr>Total M0dXM1Count: </gr><blg>"+ M0dXM1Count +"</blg>");
                $("#M0ContDnM1Count").html("<gr>Total M0ContDnM1Count: </gr><blg>"+ M0ContDnM1Count +"</blg>");

                $("#currentstatistics").html("<y>"+showDate() +"</y> "+ showTime() + "<br>" +
                  "<k> Total M3XM4Count: </k><bo>"+ M3XM4Count +"</bo>" +
                  "<k> Total M2XM3Count: </k><bo>"+ M2XM3Count +"</bo>" +
                  "<k> Total M1XM2Count: </k><bo>"+ M1XM2Count +"</bo>" +
                  "<k> Total M0XM4Count: </k><bo>"+ M0XM4Count +"</bo>" + 

                  "<br><mpk>Total M0uXM1Count: </mpk><o>"+ M0uXM1Count +"</o>" + 
                  "<mpk> Total M0ContUpM1Count: </mpk><o>"+ M0ContUpM1Count +"</o>" +

                  "<gr> Total M0dXM1Count: </gr><blg>"+ M0dXM1Count +"</blg>" + 
                  "<gr> Total M0ContDnM1Count: </gr><blg>"+ M0ContDnM1Count +"</blg>" +
                  "<gr> mtw: </gr><mlg>"+ Math.round(totalmtweight) +"</mlg>,<br>"
                );

              }
           });

           //showActivity(theCode)
           window.scrollTo(0,0);
      }

     function chkKey() {
       var testkey = getChar(event);
       if(testkey == 't'){window.location = '#toc';}
       else if(testkey == 'q'){updateStat("CheckDayLineStatus");}

       // if(testkey == '+'){addToAttentionList();}
       else if(testkey == '-'){removeFmquickCodeList();}
       else if(testkey == 'X'){window.open("Random Charts.html");}
       else if(testkey == '.'){window.open("mlineMinutechart.html");}

       //else if(testkey == 'D'){window.location = '#image';}

       else if(testkey == 'l'){window.location = '#endpage';console.log("l: ");}
       else if(testkey == 'e'){window.location = '#commands';
            window.scrollTo(window.scrollX, window.scrollY + 2000);}
       else if(testkey == 's'){window.location = '#accel';
            window.scrollTo(window.scrollX, window.scrollY - 500);}
       else if(testkey == 'E'){window.location = '#filterMarkers';}
       else if(testkey == 'X'){storeCode(theCode); window.open("Random Charts.html");}
       else if(testkey == '.'){storeCode(theCode); window.open("mlineMinutechart.html");}
       else{chkOtherKeys(testkey)} 
     }

     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

     function xunbao(xunbaocode) {
       localStorage.setItem("randomcode", xunbaocode)
       localStorage.setItem("otherCode", xunbaocode)
       localStorage.setItem("stkCode", xunbaocode)

       window.open("Random Charts.html");
       // locs = ["HIghLowTrend.html", "Random Charts.html", ]
       //  window.open("HIghLowTrend.html")
     }

	function fillLineData() {
      var dataArr = prompt("Enter data array sep by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        redraw()
      }
     }

      function addToquickCodeList() {
        codewidth = theCode.length
        if(codewidth <= 5){
          theCode = "00000"+theCode;
          codewidth = theCode.length;
          theCode = theCode.slice(codewidth-5, codewidth);
        }
        if (!quickCodeList.includes(theCode)) {
          quickCodeList.push(theCode);
          quickCodeList = Array.from(new Set(quickCodeList)); // set unique
          localStorage.savedCodeList = quickCodeList;
          alert(theCode + " added to quickCodeList")
        }else{alert(theCode + " already exist!")}
      }

    function usequickCodeList() {
        stkList = quickCodeList;
        alert("quickCodeList Total: " + quickCodeList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("quickCodeList Total: " + quickCodeList.length + "\n"+stkList);
    }

    function usestkListArr() {
      stkListArr = localStorage.getItem("stkListArr")
      if (stkListArr === null) {
         stkList = quickCodeList;
      } else{
         stkList = stkListArr;
      }
        alert("Use stkListArr, Total: " + stkListArr.length + " : "+stkListArr)
        $("#message").text("stkListArr Total: " + stkListArr.length + "\n"+stkList);
    }

	function addToAttentionList() {
            codewidth = theCode.length
            if(codewidth <= 5){
              theCode = "00000"+theCode;
              codewidth = theCode.length;
              theCode = theCode.slice(codewidth-5, codewidth);
              codewidth = theCode.length; //update to be used later
            }

        attentionList.push(theCode)
        attentionList = [...new Set(attentionList)]; // set unique

        ItemIndex = attentionList.indexOf("");  // remove empty items
        if (ItemIndex > -1) { attentionList.splice(ItemIndex, 1); }

        localStorage.setItem("attentionList", attentionList);
        alert(theCode + " added to attentionList!")
     }
	function removeFmquickCodeList() {
        ItemIndex = quickCodeList.indexOf(theCode);
        if (ItemIndex > -1) { quickCodeList.splice(ItemIndex, 1); }
        quickCodeList = [...new Set(quickCodeList)]; // set unique
        localStorage.setItem("quickCodeList", quickCodeList);
        alert(theCode + " removed fm quickCodeList!")
   }

     function redraw() { // includes main chart and aux charts
        initIntvSteps()
        titleText = showDate() +" "+ showTime()+", p1: "+intv1 +" w: "+(thestkdata.length-starti) +"\n"+theStartCode + " " + stkName + " 日線 ";
        $("#amtLst").html("Amt: ".concat(amtLst.slice((amtLst.length-14),amtLst.length).join("")));

 
        RGraph.reset(document.getElementById('cvs'));

        stkpriceDataArrC = closeLst
        stkpriceDataArrL = lowLst
        stkpriceDataArrM = midLst
        stkpriceDataArrH = highLst
        stdDevH = makeStd(highLst, intv3)
        stdDevL = makeStd(lowLst, intv3)

specialBackUp = lowLst.slice();  // backup array to avoid shadow changes
        newDevadd = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a + stdDevH[i]);
        newDevminus = makeMovAve(stkpriceDataArrM, intv3).map((a, i) => a - stdDevL[i]);

        mydata = [ stkpriceDataArrM]

          mydata.push(stkpriceDataArrH)
          mydata.push(makeMovAve(stkpriceDataArrH, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrH, intv1))
          mydata.push(makeMovAve(stkpriceDataArrH, intv2))
          //mydata.push(makeMovAve(mydata[1], intv3))
          //mydata.push(makeMovAve(mydata[1], intv4))  // line 6

          mydata.push(stkpriceDataArrL) // line 6, index 5
          mydata.push(makeMovAve(stkpriceDataArrL, halfNum))
          mydata.push(makeMovAve(stkpriceDataArrL, intv1))
          mydata.push(makeMovAve(stkpriceDataArrL, intv2))
          //mydata.push(makeMovAve(mydata[5], intv3))
          // mydata.push(makeMovAve(mydata[5], intv4))

          //mydata.push(makeMovAve(mydata[1], intv8))
          mydata.push(newDevadd)
          mydata.push(newDevminus)  // line 8
        theMax = Math.max(...[].concat(...mydata));
        theMin = Math.min(...[].concat(...mydata));

        thedrawdata = mydata
        //thedrawdata.push(makeMovAve(thedrawdata[2], intv1));  // add one line to check results

        thedrawdata[1] = thedrawdata[1].fill(null,0,0)
        thedrawdata[2] = thedrawdata[2].fill(null,0,halfNum)
        thedrawdata[3] = thedrawdata[3].fill(null,0,intv1)
        thedrawdata[4] = thedrawdata[4].fill(null,0,intv2)

        thedrawdata[5] = thedrawdata[5].fill(null,0,0)
        thedrawdata[6] = thedrawdata[6].fill(null,0,halfNum)
        thedrawdata[7] = thedrawdata[7].fill(null,0,intv1)
        thedrawdata[8] = thedrawdata[8].fill(null,0,intv2)

        thedrawdata[9] = thedrawdata[9].fill(null,0,intv3)
        thedrawdata[10] = thedrawdata[10].fill(null,0,intv3)

        //thedrawdata[11] = thedrawdata[11].fill(null,0,intv3)
        //thedrawdata[12] = thedrawdata[12].fill(null,0,intv1)  // add one line 

lowLst = specialBackUp  // recover data

statusMsg = '<br><span class="red">price '+ mydata[0].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">intvS '+ mydata[1].slice(-1)[0].toFixed(3) +
'</span>, <span class="blue">intvL '+ mydata[2].slice(-1)[0].toFixed(3) +
'</span>, <span class="purple">Top '+ mydata[3].slice(-1)[0].toFixed(3) +
'</span>, <span class="yellow">Bottom '+ mydata[4].slice(-1)[0].toFixed(3) +
'</span>, <span class="darkgreen">IntvS '+ intv1 +
'</span>, <span class="blue">IntvL '+ intv2 +
'</span>'

$("#lastValues").text("");
$("#lastValues").append(statusMsg);

       drawchart()

		// create datalog table
		 transp = transpose(mydata);
            wAveTrendRange = [];  // this is the gap diff
		  for (var row=0; row < transp.length; row++) {
		    rowRange = transp[row].slice(1, mydata.length);
      	    rowMax = Math.max(...rowRange);
      	    rowMin = Math.min(...rowRange);
      	    var rowDiff = rowMax - rowMin;
      	    wAveTrendRange.push(rowDiff);
      	  }

		wAveTrendRange.fill(null,0,intv3);
		wAvemax = Math.max(...wAveTrendRange);
		wAvemin = Math.min(...wAveTrendRange);
		drawTrend(wAveTrendRange, wAvemax, wAvemin, 'TP');

		// find derivative
		derivative = diff(makeMovAve(mydata[0], 3));
		derivative.unshift(0);
		derivative.fill(null,0,intv1+3); //array.fill(value, start, end)

		// diffaccel
		// diffaccel = thedrawdata[baseSubIdx].map(function(item, index) { return item - thedrawdata[baseMinuIdx][index]; })
		diffaccel = []
		diffaccel.push(thedrawdata[1].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[2].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[3].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[4].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[5].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel.push(thedrawdata[6].map(function(item, index) { return item - thedrawdata[9][index]; }))
		diffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)
		diffaccel[5].fill(null,0,intv3); //array.fill(value, start, end)

		diffaccMax = Math.max(...[].concat.apply([], diffaccel));
		diffaccMin = Math.min(...[].concat.apply([], diffaccel));
		drawTrend(diffaccel, diffaccMax, diffaccMin, 'accel');

		// ddiffaccel
		ddiffaccel = []
		ddiffaccel.push(diffaccel[0].map(function(item, index) { return item - diffaccel[1][index]; }))
		ddiffaccel.push(diffaccel[1].map(function(item, index) { return item - diffaccel[2][index]; }))
		ddiffaccel.push(diffaccel[2].map(function(item, index) { return item - diffaccel[3][index]; }))
		//ddiffaccel.push(diffaccel[3].map(function(item, index) { return item - diffaccel[4][index]; }))
		//ddiffaccel.push(diffaccel[4].map(function(item, index) { return item - diffaccel[5][index]; }))
		//ddiffaccel[0].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[1].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[2].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[3].fill(null,0,intv3); //array.fill(value, start, end)
		//ddiffaccel[4].fill(null,0,intv3); //array.fill(value, start, end)

		ddiffaccMax = Math.max(...[].concat.apply([], ddiffaccel));
		ddiffaccMin = Math.min(...[].concat.apply([], ddiffaccel));
		drawTrend(ddiffaccel, ddiffaccMax, ddiffaccMin, 'accaccel');

		// find stoch
		stoch1 = makeStoch(mydata[0], 50)
		stochmax1 = Math.max(...stoch1);
		stochmin1 = Math.min(...stoch1);
		drawTrend(stoch1, stochmax1, stochmin1, '强弱50');

        // evaluate B/S
        lastdayPtr = mydata[0].length-1
        statBegin = lastdayPtr - 29
        actionStr = ""
        for (var i = statBegin; i < (lastdayPtr+1); i++) {
          // define references
          Mvalue = mydata[0][i]
          Hvalue = mydata[1][i]
          Lvalue = mydata[5][i]
          hRefvalue = mydata[2][i]
          lRefvalue = mydata[6][i]
          h2Refvalue = mydata[3][i]
          l2Refvalue = mydata[7][i]
          acRefvalue = diffaccel[1][i]
          // compare indicators
          Hdiff = (Hvalue - hRefvalue).toFixed(2)
          Ldiff = (Lvalue - lRefvalue).toFixed(2)
          H2diff = (Hvalue - h2Refvalue).toFixed(2)
          L2diff = (Lvalue - l2Refvalue).toFixed(2)
          Mhdiff = (Mvalue - h2Refvalue).toFixed(2)
          Mldiff = (Mvalue - l2Refvalue).toFixed(2)
          acdiff = (diffaccel[0][i] - diffaccel[0][i-1]).toFixed(2)
          ac1diff = (diffaccel[0][i] - diffaccel[1][i]).toFixed(2)

          Mdiff = (mydata[0][i] - mydata[0][i-1]).toFixed(2)

          if(Hdiff >0){Hdiff = "<span class='red'>" +Hdiff + "</span>"}
          if(Ldiff >0){Ldiff = "<span class='red'>" +Ldiff + "</span>"}
          if(H2diff >0){H2diff = "<span class='red'>" +H2diff + "</span>"}
          if(L2diff >0){L2diff = "<span class='red'>" +L2diff + "</span>"}

          if(Mhdiff >0){Mhdiff = "<r>" +Mhdiff + "</r>"}
          else{Mhdiff = "<gr>" +Mhdiff + "</gr>"}
          if(Mldiff >0){Mldiff = "<r>" +Mldiff + "</r>"}
          else{Mldiff = "<gr>" +Mldiff + "</gr>"}

          if(Mdiff >0){Mdiff = "<r>" +Mdiff + "</r>"}
          else{Mdiff = "<gr>" +Mdiff + "</gr>"}

          if(acdiff >0){acdiff = "<r>" +acdiff + "</r>"}
          else{acdiff = "<gr>" +acdiff + "</gr>"}
          if(ac1diff >0){ac1diff = "<r>" +ac1diff + "</r>"}
          else{ac1diff = "<gr>" +ac1diff + "</gr>"}

          closeValue = lowLst[i]
          dateValue = dateLst[i].slice(5)

          // decision conditions
          actionStr = actionStr + dateValue + " C: " + closeValue +"\tHd: " + Hdiff + "\tLd: " + Ldiff + "\tH2d: " + H2diff + "\tL2d: " + L2diff + "\tMd: " + Mdiff + "\tacd: " + acdiff + "\tac1d: " + ac1diff + "<br>" 

          if(Hdiff>0){action = "buy"}
        }
        explanationStr = "<gr>h2d: h2 diff, l2d: L2 diff, md: M diff, acd: acc0 diff, ac1d: acc0 diff</gr>"
        actionStr = "<pre>" + actionStr + explanationStr+"</pre>"
        $("#actions").html(actionStr);

        drawOHLC()
        drawlinechart()
       }

	function makeMovAve(bigArray, intv) {
	     // the intv-1 is correct
		return bigArray.slice(0, intv-1).concat(calcMovAve(bigArray, intv));
	}
	function calcAve(aveArray) {
		add = (a, b) =>  a + b;
		return aveArray.reduce(add) / aveArray.length;
	}
	
	function calcMovAve(bigArray, intv) {
		var ma = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {ma[i] = calcWAve(bigArray.slice(i, i+intv));} // points to indicator
		return ma;
	}
	function calcWAve(aveArray) {
		var sum = 0
		for( var i = 1; i <= aveArray.length; i++ ) {
			sum += aveArray[i-1] * i;
		}
		return (sum / ((1 + aveArray.length)*aveArray.length/2))
	}

	function makeStoch(bigArray, intv) {
	     tempArr = bigArray.slice(0, intv-1).concat(calcStoch(bigArray, intv));
		return tempArr.fill(50,0,intv-1)
	}

	function calcStoch(bigArray, intv) {
		var stc = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {
			stc[i] = calc1Stoch(bigArray.slice(i, i+intv));
		}
		return stc;
	}

	function calc1Stoch(stcArray) {
			stcMax = Math.max(...stcArray)
			stcMin = Math.min(...stcArray)
			lastVal = stcArray[stcArray.length - 1]
			stcRange = stcMax - stcMin
			if(stcRange == 0){
				stcVal = 50
			}else{
				stcVal = 100*(lastVal - stcMin) / stcRange
			}
			return stcVal
	}

	function makeStd(bigArray, intv) {
	     // the intv-1 is correct
          newArray = new Array(intv-1).fill(0)
		newArray = newArray.concat(calcStd(bigArray, intv));
		return newArray
	}

	function calcStd(bigArray, intv) {
		var stdArrar = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {stdArrar[i] = Std(bigArray.slice(i, i+intv));} // points to indicator
		return stdArrar;
	}

	function Std(array) {
	  const n = array.length
	  const mean = array.reduce((a, b) => a + b) / n
	  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
	}

	function transpose(thisArr) { // Swap rows with columns of a matrix
	    return Object.keys(thisArr[0]).map(function(column) {
	        return thisArr.map(function(row) { return row[column]; });
	    });
	}

    function useAttentionList() {
        stkList = attentionList;
        alert("AttentionList Total: " + attentionList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("Total: " + attentionList.length + "\n"+stkList);
    }

    function myfavor() {
        myfavorLst = mychips.split(" ");
        stkList = myfavorLst;
        alert("mychips Total: " + myfavorLst.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
        $("#message").text("mychips Total: " + myfavorLst.length + "\n"+stkList);
    }

    function askList() {
        var theList = prompt("CodeList, Number (5 digits) sep by space： ", "");
        if (theList != null && theList != "HSI" && theList != "") {
            stkList = theList.split(" ");
            alert("Supplied List Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!")
            $("#message").text("Supplied List Total: " + stkList.length + "\n"+stkList);
        }
        codetable = stkList
        document.getElementById("upcrossResult").innerHTML = "";

        for (var i = 0; i < codetable.length; i++) {
           collectStkData(codetable[i])
        }
    }

    function FormatNumberLength5(num) {
        var r = "" + num;
        while (r.length < 5) { r = "0" + r; }
        return r;
    }

    function jpforward() {
        if (stkPointer < stkList.length-1) {
            stkPointer = stkPointer + 1;
        } else {
            stkPointer = 0;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }

    function jpback() {
        if (stkPointer > 0) {
            stkPointer = stkPointer - 1;
        } else {
            stkPointer = stkList.length-1;
        }
        theCode = stkList[stkPointer];
         collectStkData(theCode)
    }
    function jprandom() {
        stkPointer = Math.floor(Math.random() * (stkList.length-1))
        theCode = stkList[stkPointer]
         collectStkData(theCode)
    }

    function jpTo0() {
        stkPointer = 0;
        theCode = stkList[stkPointer]
        collectStkData(theCode)
    }

    function storeCode(theCode) {
        if(typeof(Storage) !== "undefined") {
            localStorage.randomcode = theCode;
        }
    }

    function chgchartWidth() {
        newChartWidth = prompt("enter chart width:", "");
        if (newChartWidth != null && newChartWidth != "" && newChartWidth < (1000 - 2*intv1)){
          period = parseInt(newChartWidth);
          localStorage.setItem("daychartWidth", period);
          collectStkData(theCode);
        }

    }
    function chgIntv() {
        intv = prompt("intv1 value:", "");
        if (theCode != null && intv1 != ""){
          intv1 = parseInt(intv);
          initIntvSteps()
          redraw()
        }
    }
    function initIntvSteps() {
      halfNum = Math.round(intv1/2)
      intv2 = 2*intv1
      intv3 = 4*intv1
      intv4 = 6*intv1
      intv5 = 8*intv1
      intv6 = 9*intv1
      intv7 = 10*intv1
      intv8 = 11*intv1
      intv9 = 12*intv1
    }
    function setTabWidth() {
        tabWidth = prompt("set tab width:", "");
        if (tabWidth != null && tabWidth != ""){
          tabWidth = parseInt(tabWidth);
          document.getElementById("actions").style.tabSize = tabWidth;
        }
    }

    function chgHighList() {
        dataStatus = "H"
        redraw()
    }
    function chgLowList() {
        dataStatus = "L"
        redraw()
    }
    function chgMidList() {
        dataStatus = "M"
        redraw()
    }
    function chgCloseLst() {
        dataStatus = "C"
        redraw()
    }

    function largeCht() {
        imgHead = "http://charts.aastocks.com/servlet/Charts?fontsize=12&15MinDelay=F&lang=1&titlestyle=1&vol=1&Indicator=3&indpara1=3&indpara2=5&indpara3=10&indpara4=15&indpara5=20&subChart2=3&ref2para1=12&ref2para2=26&ref2para3=9&subChart3=12&ref3para1=0&ref3para2=0&ref3para3=0&scheme=3&com=100&chartwidth=1600&chartheight=900&stockid=";

        imgTail = "&period=2060&type=1&logoStyle=1"
        imgURL = imgHead + theCode + imgTail
        window.open(imgURL, "_blank")
    }

function assignList(){
  newList = eval(document.getElementById("selectList").value).split(" ");
  stkList = newList;
  codeList = newList;

  document.getElementById("message").focus();
  alert(" Total: " + stkList.length + "\ndetails see end of this page.\nremember to modify mustadd list!\n" + newList)
        $("#message").text("Total: " + stkList.length + "\n"+stkList);
  $('#selectList').blur()

}

function showDateTime() {
    cmtCode = theCode // use another name not to interfere other parts
    var cmtcodewidth = cmtCode.length
    if(cmtcodewidth <= 5){
      cmtCode = "00000"+cmtCode;
      cmtcodewidth = cmtCode.length;
      cmtCode = cmtCode.slice(cmtcodewidth-5, cmtcodewidth);
    }
    else if(cmtcodewidth == 8){ cmtCode = cmtCode.slice(2, 8); }
    else if(cmtcodewidth == 9){ cmtCode = cmtCode.slice(0, 6); }
    commentName = "j" + cmtCode;

    CommentListNames = Object.keys(theCommentList); // extract the names from comments
    // to show comments
    if(CommentListNames.includes(commentName)){
      cmtLocation = CommentListNames.indexOf(commentName);
      commentTxt = theCommentList[Object.keys(theCommentList)[cmtLocation]]
    }else{commentTxt = "No data!";}

    document.getElementById("dateTime").innerHTML ="<span class='orange'>" + commentTxt + "</span>";
}

    function drawchart() {
      listItems = []
      if(dataStatus == "C"){ tooltips = closeLst
      }else if(dataStatus == "L"){ tooltips = lowLst
      }else if(dataStatus == "M"){ tooltips = midLst
      }else { tooltips = highLst}

      dataTooltips = tooltips.map(item => Math.round(item * 1000) / 1000)
      for (index = 0; index < dataTooltips.length; index++) {
        listItems[index] = dateLst[index] + "<br><span class='red'>" + dataStatus + "</span>: " + dataTooltips[index];
      }

      dataTooltips = dataTooltips.map(String)

      var line = new RGraph.Line({
        id:'cvs',
        data: thedrawdata,
        options: {
			title: titleText + " " + "MHL + trends",
			titleColor: 'grey',
			titleSize: 20,
               colors: chartColor,
            backgroundGrid: true, backgroundGridVlines: true,
            backgroundGridColor: '#001000', backgroundGridBorder: false,
            // backgroundGridDotted: true,
            backgroundGridDashed: true, 
            axisColor: '#864',  scaleDecimals: 2,
            xaxis: true,
            //xaxisLabels: ["a","b","c","d"],
            textColor: '#ccc',
            tickmarks: 'plus',
            ticksize: 1,
            linewidth:1,
			ymax: theMax,
			ymin: theMin,
      // labels control the number of grids
            // labels: ['2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018'],
            spline: false,
            shadow: false,
            tooltips: listItems,
            gutterLeft: 0, gutterRight: 50,
            gutterTop: 25, gutterBottom: 25
            }
          }).trace();

		yminpct = 100 - (theMax-theMin)*100/theMax,
		ymaxpct = 100,

          yaxis1 = new RGraph.Drawing.YAxis('cvs', 1200)
                .Set('colors', ['gold'])
                .Set('text.color', 'gray')
                .Set('text.size', 8)
                .Set('max', ymaxpct)
                .Set('min', yminpct)
                .Set('linewidth', 2)
                .Set('tickmarkslength', 5)
                .Set('title', '% pct')
                .Draw();

    };

    function drawTrend(therange,maxValue, minValue, chartID) {
       // dataTooltips = therange.map(item => Math.round(item * 1000) / 1000)
       // dataTooltips = dataTooltips.map(String)
       RGraph.reset(document.getElementById(chartID));
       line = new RGraph.Line({
       	id:chartID, data:therange,
       	options: {
       		title: chartID + ", "+theStartCode + " " + stkName,
    			titleColor: 'grey', 
    			titleSize: 10,
       		backgroundGrid: true, axisColor: '#864', textColor: '#ccc',
    		numxticks: 0, colors: chartColor, scaleDecimals: 2,

       		tickmarksDotLinewidth: 0,ticksize: 1, linewidth: 1, 
       		ymax: maxValue, ymin: minValue,
               tickmarks: 'plus',

       		spline: false, shadow: false,
              // tooltips: dataTooltips,
			backgroundGridVlines: true,
			backgroundGridDashed: true, 
       		backgroundGridColor: '#001000',
       		gutterLeft: 0, gutterRight: 50, gutterTop: 25, gutterBottom: 25
       	}
       }).trace();
    };
    
    function diff(arr) {
      return arr.slice(1).map(function(n, i) { return n - arr[i]; });
    }

function showActivity(thecode){
    markers = filterResult.filter(element => element.includes(thecode));
    // clean the h2 tags
    markers = markers.map(element => element.replace(/<\/h2>.*/gi, ""))
    markers = markers.map(element => element.replace(/<h2>/gi, ""))

    markers = markers.map(element => formatWeekDay(element))
    if (markers.length > 50) markers.splice(0, markers.length-80);

    $('#filterMarkers').append("<b class='red'>" + thecode + " 日线特征:</b><br>")
    $('#filterMarkers').append(markers)
}

// format WeekDay
function formatWeekDay(element) {
    dayStr = element.replace(/<.*?>/gi, "") // clean span tags
    dayStr = dayStr.substr(0,6)
    dayStr = convertWeekday(dayStr)
    return(dayStr + " " + element + "<br>")
}

// convert date string to weekday
function parse(str) {
    str = "20" + str
    var y = str.substr(0,4), m = str.substr(4,2) - 1,
        d = str.substr(6,2);
    var D = new Date(y,m,d);
    return (D.getFullYear() == y && D.getMonth() == m && D.getDate() == d) ? D : 'invalid date';
}
function convertWeekday(str) {
    return ["SUN","MON","TUE","WED","THU","FRI","SAT"][parse(str).getDay()]
}
function fetchUsCode(str) {
    theCode = str; collectStkData(str); window.location = '#cvs';
    $('#usstock').toggle();
}

function handleRight( event ){
    codeListPtr = codeListPtr +1
    theCode = codeList[codeListPtr];
    collectStkData(theCode);
}

    codeList = codeList.split(' ')
    codeListPtr = 0

    // $( "html" ).on( "swiperight", handleRight );
    // $( "html" ).on( "swipeleft", askforCode );
    window.addEventListener('click', function (evt) {
        if (evt.detail === 3) { askforCode(); }
    });

    //collectStkData(theCode);

function docLoaded() {
    let script1 = document.createElement('script');
    script1.src = 'https://williamkpchan.github.io/LibDocs/readbook.js';
    document.body.appendChild(script1);
    let script = document.createElement('script');
    script.src = 'C:/R programs/!!! STKMon !!!/headerApp.js';
    document.body.appendChild(script);
    window.scrollTo(0,(document.body.scrollHeight));

}

    function drawOHLC() { // includes main chart and aux charts
      var ohlcdata = {
        close:  closeLst,
        low:  lowLst,
        open:  openLst,
        high:  highLst,
        x:  dateLst,
        line: {color: 'rgba(31,119,180,1)'}, 
        increasing: {line: {color: 'red'}},
        decreasing: {line: {color: 'green'}},
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
      };

      var data = [ohlcdata];
      var layout = {
      title: titleText,
        dragmode: 'zoom', 
        showlegend: false,
        xaxis: { rangeslider: { visible: false } }, 
        yaxis: { autorange: true,  type: 'linear' }
      };
      Plotly.newPlot('ohlcDiv', data, layout);
    }


    function chkCross(stkName, highLst, midLst, thisCode, lastPrice) { // includes main chart and aux charts
      contUCnt = 0
        statustxt = `<k onclick="xunbao('` + thisCode + `')">`+ thisCode + " <dr>" + stkName+ '</dr></k>&emsp;'
        $("#StkStatus").append( "<br>" +statustxt);

      // mid data
      dLineM0 = midLst
      dLineM1 = makeMovAve(midLst, intv1)
      dLineM2 = makeMovAve(midLst, intv2)
      dLineM3 = makeMovAve(midLst, intv3)
      dLineM4 = makeMovAve(midLst, intv4)

      indexlast = dLineM0.length-1

      curM0 = dLineM0[indexlast]
      prevM0 = dLineM0[indexlast-1]

      curM1 = dLineM1[indexlast]
      prevM1 = dLineM1[indexlast-1]

      curM2 = dLineM2[indexlast]
      prevM2 = dLineM2[indexlast-1]

      curM3 = dLineM3[indexlast]
      prevM3 = dLineM3[indexlast-1]

      curM4 = dLineM4[indexlast]
      prevM4 = dLineM4[indexlast-1]


      // H data
      dLineH0 = highLst
      dLineH1 = makeMovAve(highLst, intv1)
      dLineH2 = makeMovAve(highLst, intv2)

      curH0 = dLineH0[indexlast]
      prevH0 = dLineH0[indexlast-1]

      curH1 = dLineH1[indexlast]
      prevH1 = dLineH1[indexlast-1]

      curH2 = dLineH2[indexlast]
      prevH2 = dLineH2[indexlast-1]

      // Lo data
      dLineLo0 = lowLst
      dLineLo1 = makeMovAve(lowLst, intv1)
      dLineLo2 = makeMovAve(lowLst, intv2)

      curLo0 = dLineLo0[indexlast]
      prevLo0 = dLineLo0[indexlast-1]

      curLo1 = dLineLo1[indexlast]
      prevLo1 = dLineLo1[indexlast-1]

      curLo2 = dLineLo2[indexlast]
      prevLo2 = dLineLo2[indexlast-1]


      // checkX(prevL, prevS, curL, curS) check mid

      curS = curM0
      prevS = prevM0
      curL = curM1
      prevL = prevM1
      checkXMsg = "<k> M0XM1 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}


      // check if upCross
      result = /UpCross/.test(checkXMsg);
      if(result){
        uptxt = statustxt.replace(/dr>/g, "o>");
        $("#M0uXM1").append(uptxt);
        M0uXM1Count = M0uXM1Count +1
      }

      // check if cont.Up
      result = /cont.Up/.test(checkXMsg);
      if(result){
        uptxt = statustxt.replace(/dr>/g, "o>");
        $("#M0ContUpM1").append(uptxt);
        M0ContUpM1Count = M0ContUpM1Count +1
      }

      // check if DownCross
      result = /DownCross/.test(checkXMsg);
      if(result){
        downtxt = statustxt.replace(/dr>/g, "gr>");
        $("#M0dXM1").append(downtxt);
        M0dXM1Count = M0dXM1Count +1
      }

      // check if cont.Dn
      result = /cont.Dn/.test(checkXMsg);
      if(result){
        downtxt = statustxt.replace(/dr>/g, "gr>");
        $("#M0ContDnM1").append(downtxt);
        M0ContDnM1Count = M0ContDnM1Count +1
      }



      curL = curM2
      prevL = prevM2
      checkXMsg = "<k> M0XM2 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      curL = curM3
      prevL = prevM3
      checkXMsg = "<k> M0XM3 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      curL = curM4
      prevL = prevM4
      checkXMsg = "<k> M0XM4 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 4){
        $("#M0XM4").append(statustxt);
        M0XM4Count++;
      }

      curS = curM1
      prevS = prevM1
      curL = curM2
      prevL = prevM2
      checkXMsg = "<dr> M1XM2 </dr>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 5){
        $("#M1XM2").append(statustxt);
        M1XM2Count++;
      }

      curS = curM2
      prevS = prevM2
      curL = curM3
      prevL = prevM3
      checkXMsg = "<k> M2XM3 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 6){
        $("#M2XM3").append(statustxt);
        M2XM3Count++;
      }

      curS = curM3
      prevS = prevM3
      curL = curM4
      prevL = prevM4
      checkXMsg = "<k> M3XM4 </k>"+checkX(prevL, prevS, curL, curS)
      $("#StkStatus").append(checkXMsg);
      if(checkXMsg.includes('cont.Up')){contUCnt = contUCnt +1}

      if(contUCnt == 7){
        $("#M3XM4").append(statustxt);
        M3XM4Count++;
      }
    }

    function checkX(prevL, prevS, curL, curS) {
		if (curS == curL){return "critical" }
		if (((prevL == prevS) && (curS > curL )) || ((prevL>prevS) && (curS > curL ))){return "<span class='redrose'>UpCross</span>" }
		if (((prevL == prevS) && (curS < curL )) || ((prevL<prevS) && (curS < curL ))){return "<gr>DownCross</gr>" }
		if ((prevL<prevS) && (curS > curL )){return '<span class="brownword">cont.Up</span>' } // c must > prevC, this is not correct, further check for condition
		if ((prevL>prevS) && (curS < curL )){return '<span class="limeword">cont.Dn</span>' }
	}

      function alertStat() {
        prevStat = document.getElementById("prevstatistics").innerHTML
        console.log("prevStat: ",prevStat)
        alert("check console to copy prev Stat")
      }

      function alertM0uXM1() {
        M0uXM1txt = document.getElementById("M0uXM1").innerHTML
        console.log("M0uXM1: ",M0uXM1txt)
        alert("check console to copy M0uXM1")
      }


     function askCodetable() {
       var theCodetable = prompt("Enter stk list seperated by space:", "");
       if (theCodetable != null && theCodetable != "") {
         theCodetable = JSON.stringify(theCodetable.split(" "))
         localStorage.setItem("codetableList", theCodetable);
         codetable = JSON.parse(theCodetable);
         location.reload();
       }
     }
</script>

<script src='createTOC.js'></script>

</body>
</html>
