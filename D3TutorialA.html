<base target="_blank"><html><head><title>pppp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.js"></script>
<script src="https://williamkpchan.github.io/lazyload.min.js"></script>
<script src='https://williamkpchan.github.io/mainscript.js'></script>
<script src="https://williamkpchan.github.io/commonfunctions.js"></script>
<script>
  var showTopicNumber = true;
  var bookid = "pppp"
  var markerName = "h1,h2"
</script>
<style>
body{width:80%;margin-left: 10%; font-size:24px;}
h1, h2 {color: gold;}
strong {color: orange;}
img {max-width:90%; display: inline-block; margin-top: 2%;margin-bottom: 1%; border-radius:3px;}
</style></head><body onkeypress="chkKey()"><center>
<a href="#mustWatch" class="red goldbs" target="_self">Must Watch!</a>
<br><br>
<div id="toc"></div></center>
<br><br>
<div id="mustWatch"><center><span class="red">MustWatch</span></center><br>
</div>
<pre>
<br>
<br>

<h1><span class="orange">Chapter 1. Introduction</span></h1>

<h2>Why Data Visualization?</h2>
Our information age more often feels like an era of information overload. 
Excess amounts of information are overwhelming; raw data becomes useful only when we apply methods of deriving insight from it.

Fortunately, we humans are intensely visual creatures. 
Few of us can detect patterns among rows of numbers, but even young children can interpret bar charts, extracting meaning from those numbers’ visual representations. 
For that reason, data visualization is a powerful exercise. 
Visualizing data is the fastest way to communicate it to others.

Of course, visualizations, like words, can be used to lie, mislead, or distort the truth. 
But when practiced honestly and with care, the process of visualization can help us see the world in a new way, revealing unexpected patterns and trends in the otherwise hidden information around us. 
At its best, data visualization is expert storytelling.

More literally, visualization is a process of

<em>mapping</em> information to visuals. 
We craft rules that interpret data and express its values as visual properties. 
For example, the humble bar chart in

<a class="xref" href="#data_values_mapped_to_visuals" title="Figure 1-1. Data values mapped to visuals">Figure 1-1</a> is generated from a very simple rule: larger values are

<em>mapped</em> as taller bars.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0101.png" alt="Data values mapped to visuals">
Figure 1-1. Data values mapped to visuals 
More complex visualizations are generated from datasets more complex than the sequence of numbers shown in

<a class="xref" href="#data_values_mapped_to_visuals" title="Figure 1-1. Data values mapped to visuals">Figure 1-1</a> and more complex sets of mapping rules.

<h2>Why Write Code?</h2>
Mapping data by hand can be satisfying, yet is slow and tedious. 
So we usually employ the power of computation to speed things up. 
The increased speed enables us to work with much larger datasets of thousands or millions of values; what would have taken years of effort by hand can be mapped in a moment. 
Just as important, we can rapidly experiment with

<em>alternate mappings</em>, tweaking our rules and seeing their output re-rendered immediately. 
This loop of write/render/evaluate is critical to the iterative process of refining a design.

Sets of mapping rules function as

<em>design systems</em>. 
The human hand no longer executes the visual output; the computer does. 
Our human role is to conceptualize, craft, and write out the rules of the system, which is then finally executed by software.

Unfortunately, software (and computation generally) is extremely bad at understanding what, exactly, people want. 
(To be fair, many humans are also not good at this challenging task.) Because computers are binary systems, everything is either on or off, yes or no, this or that, there or not there. 
Humans are mushier, softer creatures, and the computers are not willing to meet us halfway—we must go to them. 
Hence the inevitable struggle of learning to write software, in which we train ourselves to communicate in the very limited and precise syntax that the computer can understand.

Yet we continue to write code because seeing our visual creations come to life is so rewarding. 
We practice data visualization because it is exciting to see what has never before been seen. 
It is like summoning a magical, visual genie out of an inscrutable data bottle.


<h2>Why Interactive?</h2>
Static visualizations can offer only precomposed “views” of data, so multiple static views are often needed to present a variety of perspectives on the same information. 
The number of dimensions of data are limited, too, when all visual elements must be present on the same surface at the same time. 
Representing multidimensional datasets fairly in static images is notoriously difficult. 
A fixed image is ideal when alternate views are neither needed nor desired, and required when publishing to a static medium, such as print.

Dynamic, interactive visualizations can empower people to explore the data for themselves. 
The basic functions of most interactive visualization tools have changed little since 1996, when Ben Shneiderman of the University of Maryland first proposed a “Visual Information-Seeking Mantra”:

<em>overview first, zoom and filter, then details-on-demand.</em>

This design pattern is found in most interactive visualizations today. 
The combination of functions is successful, because it makes the data accessible to different audiences, from those who are merely browsing or exploring the dataset to those who approach the visualization with a specific question in search of an answer. 
An interactive visualization that offers an overview of the data alongside tools for “drilling down” into the details may successfully fulfill many roles at once, addressing the different concerns of different audiences, from those new to the subject matter to those already deeply familiar with the data.

Of course, interactivity can also encourage engagement with the data in ways that static images cannot. 
With animated transitions and well-crafted interfaces, some visualizations can make exploring data feel more like playing a game. 
Interactive visualization can be a great medium for engaging an audience who might not otherwise care about the topic or data at hand.

<h2>Why on the Web?</h2>
Visualizations aren’t truly visual unless they are

<em>seen</em>. 
Getting your work out there for others to see is critical, and publishing on the Web is the quickest way to reach a global audience. 
 Working with web-standard technologies means that your work can be seen and experienced by anyone using a recent web browser, regardless of the operating system (Windows, Mac, Linux) and device type (laptop, desktop, smartphone, tablet).

Best of all, everything covered in this book can be done with freely accessible tools, so the only investment required is your time. 
And everything we’ll talk about uses open source, web-standard technologies.

By avoiding proprietary software and plug-ins, you can ensure that your projects are accessible on the widest possible range of devices, from typical desktop computers to tablets and even phones. 
The more accessible your visualization, the greater your audience and your impact.

<h2>What This Book Is</h2>
This book is a practical introduction to merging three practices—data visualization, interactive design, and web development—using D3, a powerful tool for custom, web-based visualization.

These chapters grew out of my own process of learning how to use D3. 
Many people, including myself, come to D3 with backgrounds in design, mapping, and data visualization, but not programming and computer science.

D3 has a bit of an unfair reputation for being hard to learn. 
D3 itself is not so complicated, but it operates in the domain of the Web, and the Web

<em>is</em> complicated. 
Using D3 comfortably requires some prior knowledge of the web technologies with which it interacts, such as HTML, CSS, JavaScript, and SVG. 
Many people (myself included) are self-taught when it comes to web skills. 
This is great, because the barrier to entry is so low, but problematic because it means we probably didn’t learn each of these technologies from the ground up—more often, we just hack something together until it seems to work, and call it a day. 
Yet successful use of D3 requires understanding some of these technologies in a fundamental way.

Because D3 is written in JavaScript, learning to use D3 often means learning a lot about JavaScript. 
For many datavis folks, D3

<em>is</em> their introduction to JavaScript (or even web development generally). 
It’s hard enough to learn a new programming language, let alone a new tool built on that language. 
D3 will enable you to do great things with JavaScript that you never would have even attempted. 
The time you spend learning both the language and the tool will provide an incredible payoff.

My goal is to reduce that learning time, so you can start creating awesome stuff sooner. 
We’ll take a ground-up approach, starting with the fundamental concepts and gradually adding complexity. 
I don’t intend to show you how to make specific kinds of visualizations so much as to help you understand the workings of D3 well enough to take those building blocks and generate designs of your own creation.

<h2>Who You Are</h2>
You may be an absolute beginner, someone new to datavis, web development, or both. 
(Welcome!) Perhaps you are a journalist interested in new ways to communicate the data you collect during reporting. 
Or maybe you’re a designer, comfortable drawing static infographics but ready to make the leap to interactive projects on the Web. 
You could be an artist, interested in generative, data-based art. 
Or a programmer, already familiar with JavaScript and the Web, but excited to learn a new tool and pick up some visual design experience along the way.

Whoever you are, I hope that you:

 Have heard of this new thing called the “World Wide Web”  Are a bit familiar with HTML, the DOM, and CSS  Might even have a little programming experience already  Have heard of jQuery or written some JavaScript before  Aren’t scared by unknown initialisms like CSV, SVG, or JSON  Want to make useful, interactive visualizations  
If any of those things are unknown or unclear, don’t fear. 
You might just want to spend more time with

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>, which covers what you really need to know before diving into D3.

<h2>What This Book Is Not</h2>
That said, this is definitely not a computer science textbook, and it is not intended to teach the intricacies of any one web technology (HTML, CSS, JavaScript, SVG) in depth.

In that spirit, I might gloss over some technical points, grossly oversimplifying important concepts fundamental to computer science in ways that will make true software engineers recoil. 
That’s fine, because I’m writing for artists and designers here, not engineers. 
We’ll cover the basics, and then you can dive into the more complex pieces once you’re comfortable.

I will deliberately

<em>not</em> address every possible approach to a given problem, but will typically present what I feel is the simplest solution, or, if not the simplest, then the most understandable.

My goal is to teach you the fundamental concepts and methods of D3. 
 As such, this book is decidedly

<em>not</em> organized around specific example projects. 
 Everyone’s data and design needs will be different. 
 It’s up to you to integrate these concepts in the way best suited to your particular project.

<h2>Using Sample Code</h2>
If you are a mad genius, then you can probably learn to use D3 without ever looking at any sample code files, in which case you can skip the rest of this section.

If you’re still with me, you are probably still very bright but not mad, in which case you should undertake this book with the full set of accompanying code samples in hand. 
 Before you go any further, please download the sample files from

<a class="ulink" href="http://bit.ly/V25Xw6" target="_top">GitHub</a>.

Normal people will want to click the ZIP link to download a compressed ZIP archive with all the files. 
 Hardcore geeksters will want to clone the repository using Git. 
If that last sentence sounds like total gibberish, please use the first option.

Within the download, you’ll notice there is a folder for each chapter that has code to go with it:

chapter_04 chapter_05 chapter_06 chapter_07 chapter_08 …
Files are organized by chapter, so in

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a> when I reference

<em>01_bar_chart.html</em>, know that you can find that file in the corresponding location:

<em>d3-book/chapter_9/01_bar_chart.html</em>.

You are welcome to copy, adapt, modify, and reuse the example code in these tutorials for any noncommercial purpose.

<h2>Thank You</h2>
Finally, this book has been handcrafted, carefully written, and pedagogically fine-tuned for maximum effect. 
Thank you for reading it. 
I hope you learn a great deal, and even have some fun along the way.

<h1><span class="orange">Chapter 2. Introducing D3</span></h1>
D3—also referred to as D
<sup>3</sup> or d3.js—is a JavaScript library for creating data visualizations. 
But that kind of undersells it.

The abbreviation D3 references the tool’s full name,

<em>Data-Driven Documents</em>. 
The

<em>data</em> is provided by you, and the

<em>documents</em> are web-based documents, meaning anything that can be rendered by a web browser, such as HTML and SVG. 
D3 does the

<em>driving</em>, in the sense that it connects the data to the documents.

Of course, the name also functions as a clever allusion to the network of technologies underlying the tool itself: the W3, or World Wide Web, or, today, simply “the Web.”

D3’s primary author is the brilliant

<a class="ulink" href="http://bost.ocks.org/mike/" target="_top">Mike Bostock</a>, although there are a few other dedicated contributors. 
The project is entirely open source and freely available on

<a class="ulink" href="https://github.com/mbostock/d3/" target="_top">GitHub</a>.

D3 is released under a BSD license, so you may use, modify, and adapt the code for noncommercial or commercial use at no cost.

D3’s official home on the Web is

<a class="ulink" href="http://www.d3js.org/" target="_top">

<em>d3js.org</em></a>.

<h2>What It Does</h2>
Fundamentally, D3 is an elegant piece of software that facilitates

 generation and manipulation of web documents with data. 
It does this by:

<em>Loading</em> data into the browser’s memory 

<em>Binding</em> data to elements within the document, creating new elements as needed  

<em>Transforming</em> those elements by interpreting each element’s bound datum and setting its visual properties accordingly 

<em>Transitioning</em> elements between states in response to user input  
Learning to use D3 is simply a process of learning the syntax used to tell it how you want it to load and bind data, and transform and transition elements.

The

<em>transformation</em> step is most important, as this is where the

<em>mapping</em> happens. 
D3 provides a structure for applying these transformations, but, as we’ll see, you define the mapping rules. 
Should larger values make taller bars or brighter circles? Will clusters be sorted on the x-axis by age or category? What color palette is used to fill in countries on your world map? All of the visual design decisions are up to you. 
You provide the concept, you craft the rules, and D3 executes it—without telling you what to do. 
(Yes, it’s like the opposite of Excel’s pushy “Chart Wizard.”)


<h2>What It Doesn’t Do</h2>
Here is a list of things D3 does not do:

 D3 doesn’t generate predefined or “canned” visualizations for you. 
This is on purpose. 
 D3 is intended primarily for

<em>explanatory</em> visualization work, as opposed to

<em>exploratory</em> visualizations. 
 Exploratory tools help you discover significant, meaningful patterns in data. 
 These are tools like

<a class="ulink" href="http://bit.ly/13KrhFH" target="_top">Tableau</a> and

<a class="ulink" href="http://ggplot2.org/" target="_top">ggplot2</a>, which help you quickly generate multiple views on the same data set. 
 That’s an essential step, but different from generating an

<em>explanatory</em> presentation of the data, a view of the data that highlights what you’ve already discovered. 
 Explanatory views are more constrained and limited, but also focused, and designed to communicate only the important points. 
 D3 excels at this latter step, but is not ideal for the former. 
 (For ideas on other tools, see the section

<a class="xref" href="#alternatives_2" title="Alternatives">“Alternatives”</a> later in this chapter.)

  D3 doesn’t even try to support older browsers. 
This helps keep the D3 codebase clean and free of hacks to support old versions of Internet Explorer, for example. 
The philosophy is that by creating more compelling tools and refusing to support older browsers, we encourage more people to upgrade (rather than forestall the process, thereby requiring us to continue to support those browsers, and so on—a vicious cycle). 
D3 wants us to move forward.

  D3’s core functionality doesn’t handle bitmap map tiles, such as those provided by Google Maps or Cloudmade. 
D3 is great with anything vector—SVG images or GeoJSON data—but wasn’t originally intended to work with traditional map tiles. 
(

<em>Bitmap</em> images are made up of pixels, so resizing them larger or smaller is difficult without a loss in quality. 

<em>Vector</em> images are defined by points, lines, and curves—mathematical equations, really—and can be scaled up or down without a loss in quality.)  This is starting to change, with the introduction of the

<a class="ulink" href="http://bit.ly/W8L18u" target="_top">d3.geo.tile plug-in</a>. 
 Prior to this plug-in, geomapping with D3 meant either going all-SVG and avoiding tiles or using D3 to create SVG visuals

<em>on top of</em> a base layer of map tiles (which would be managed by another library, like Leaflet or Polymaps—see the section

<a class="xref" href="#alternatives_2" title="Alternatives">“Alternatives”</a> later in this chapter). 
 This question of how to integrate bitmap tiles and vector graphics comes up a lot in the D3 community. 
 As of today, there is no super-simple and perfect answer, but I think you can expect to see lots of work done in this area, and possibly the new tile-handling methods integrated into the D3 core at some point in the future.

  D3 doesn’t hide your original data. 
Because D3 code is executed on the client side (meaning, in the user’s web browser, as opposed to on the web server), the data you want visualized must be sent to the client. 
If your data can’t be shared, then don’t use D3. 
Alternatives include using proprietary tools (like Flash) or prerendering visualizations as static images and sending those to the browser. 
(If you’re not interested in sharing your data, though, why would you bother visualizing it? The purpose of visualization is to communicate the data, so you might sleep better at night by choosing openness and transparency, rather than having nightmares about

<a class="ulink" href="http://www.datathief.org/" target="_top">data thieves</a>.)

  </ul> 

<h2>Origins and Context</h2>
The first web browsers rendered static pages; interactivity was limited to clicking links. 
In 1996, Netscape introduced the first browser with JavaScript, a new scripting language that could be interpreted

<em>by the browser while the page was being viewed</em>.

This doesn’t sound as groundbreaking as it turned out to be, but this enabled web browsers to evolve from merely passive

<em>browsers</em> to dynamic frames for interactive, networked experiences. 
This shift ultimately enabled every intrapage interaction we have on the Web today. 
Without JavaScript, D3 would never exist, and web-based data visualizations would be limited to prerendered, noninteractive GIFs. 
(Yuck. 
Thank you, Netscape!)

Jump ahead to 2005, when Jeffrey Heer, Stuart Card, and James Landay introduced

<a class="ulink" href="http://prefuse.org/" target="_top">prefuse</a>, a toolkit for bringing data visualization to the Web. 
prefuse (spelled with all lowercase letters) was written in Java, a compiled language, with programs that could run in web browsers via a Java plug-in. 
 (Note that

<em>Java</em> is a completely different programming language than

<em>JavaScript</em>, despite their similar names.)

prefuse was a breakthrough application—the first to make web-based visualization accessible to less-than-expert programmers. 
Until prefuse came along, any datavis on the Web was very much a custom affair.

Two years later, Jeff Heer introduced

<a class="ulink" href="http://flare.prefuse.org/" target="_top">Flare</a>, a similar toolkit, but written in ActionScript, so its visualizations could be viewed on the Web through Adobe’s Flash Player. 
Flare, like prefuse, relied on a browser plug-in. 
 Flare was a huge improvement, but as web browsers continued to evolve, it was clear that visualizations could be created with native browser technology, no plug-ins required.

By 2009, Jeff Heer had moved to Stanford, where he was advising a graduate student named Michael Bostock. 
Together, in Stanford’s Vis Group, they created

<a class="ulink" href="http://mbostock.github.com/protovis/" target="_top">Protovis</a>, a JavaScript-based visualization toolkit that relied
exclusively on native browser technologies. 
(If you have used Protovis, be sure to reference Mike’s

<a class="ulink" href="http://bit.ly/XxebvX" target="_top">introduction to D3 for Protovis users</a>.)

Protovis made generating visualizations simple, even for users without prior programming experience. 
Yet to achieve this, it created an abstract representation layer. 
The designer could address this layer using Protovis syntax, but it wasn’t accessible through standard methods, so debugging was difficult.

In 2011, Mike Bostock, Vadim Ogievetsky, and Jeff Heer

<a class="ulink" href="http://vis.stanford.edu/papers/d3" target="_top">officially announced D3</a>, the next evolution in web visualization tools. 
Unlike Protovis, D3 operates directly on the web document itself. 
This means easier debugging, easier experimentation, and more visual possibilities. 
 The only downside to this approach is a potentially steeper learning curve, but this book will make that as painless as possible. 
 Plus, all the skills you gain while learning about D3 will prove useful even beyond the realm of datavis.

If you’re familiar with any of these groundbreaking tools, you’ll appreciate that D3 descends from a prestigious lineage. 
And if you have any interest in the philosophy underlying D3’s elegant technical design, I highly recommend Mike, Vadim, and Jeff’s

<a class="ulink" href="http://vis.stanford.edu/files/2011-D3-InfoVis.pdf" target="_top">InfoVis paper</a>, which clearly articulates the need for this kind of tool. 
The paper encapsulates years’ worth of learning and insights made while developing visualization tools.


<h2>Alternatives</h2>
D3 might not be perfect for every project. 
Sometimes you just need a quick chart and you don’t have time to code it from scratch. 
Or you might need to support older browsers and can’t rely on recent technologies like SVG.

For those situations, it’s good to know what other tools are out there. 
Here is a brief, noncomprehensive list of D3 alternatives, all of which use web-standard technologies (mostly JavaScript) and are free to download and use.

<h3>Easy Charts</h3>

<dl class="variablelist">
<dt>

<a class="ulink" href="http://datawrapper.de" target="_top">DataWrapper</a> </dt>
<dd> A beautiful web service that lets you upload your data and quickly generate a chart that you can republish elsewhere or embed on your site. 
This service was originally intended for journalists, but it is helpful for everyone. 
 DataWrapper displays interactive charts in current browsers and static images for old ones. 
 (Brilliant!)  You can also download all the code and run it on your own server instead of using theirs.

 </dd>
<dt>

<a class="ulink" href="http://www.flotcharts.org/" target="_top">Flot</a> </dt>
<dd> A plotting library for jQuery that uses the HTML canvas element and supports older browsers, even all the way back to Internet Explorer 6. 
It supports limited visual forms (lines, points, bars, areas), but it is easy to use. 
</dd>
<dt>

<a class="ulink" href="https://developers.google.com/chart/" target="_top">Google Chart Tools</a> </dt>
<dd> Having evolved from their earlier

<a class="ulink" href="https://developers.google.com/chart/image/" target="_top">Image Charts API</a>, Google’s Chart Tools can be used to generate several standard chart types, with support for old versions of IE. 
</dd>
<dt>

<a class="ulink" href="http://g.raphaeljs.com/" target="_top">gRaphaël</a> </dt>
<dd> A charting library based on Raphaël (see later in this chapter) that supports older browsers, including IE6. 
 It has more visual flexibility than Flot, and—some might say—it is prettier. 
</dd>
<dt>

<a class="ulink" href="http://www.highcharts.com/" target="_top">Highcharts JS</a> </dt>
<dd> A JavaScript-based charting library with several predesigned themes and chart types. 
It uses SVG for modern browsers and

<a class="ulink" href="http://www.highcharts.com/documentation/compatibility" target="_top">falls back on VML</a> for old versions of IE, including IE6 and later. 
The tool is free only for noncommercial use. 
</dd>
<dt>

<a class="ulink" href="http://thejit.org/" target="_top">JavaScript InfoVis Toolkit</a> </dt>
<dd> The JIT provides several preset visualization styles for your data. 
 It includes lots of examples, but the documentation is pretty technical. 
 The toolkit is great if you like one of the preset styles, but browser support is unclear. 
</dd>
<dt>

<a class="ulink" href="http://www.jqplot.com/" target="_top">jqPlot</a> </dt>
<dd> A plug-in for charting with jQuery. 
This supports very simple charts and is great if you are okay with the predefined styles. 
 jqPlot supports IE7 and newer. 
</dd>
<dt>

<a class="ulink" href="http://omnipotent.net/jquery.sparkline/" target="_top">jQuery Sparklines</a> </dt>
<dd> A jQuery plug-in for generating sparklines, typically small bar, line, or area charts used inline with text. 
Supports most browsers, even back to IE6. 
</dd>
<dt>

<a class="ulink" href="http://benpickles.github.com/peity/" target="_top">Peity</a> </dt>
<dd> A jQuery plug-in for very simple and very

<em>tiny</em> bar, line, and pie charts that supports only recent browsers. 
 Did I mention that this makes only very

<em>tiny</em> visualizations? +10 cuteness points. 
</dd>
<dt>

<a class="ulink" href="http://timeline.verite.co/" target="_top">Timeline.js</a> </dt>
<dd> A library specifically for generating interactive timelines. 
 No coding is required; just use the code generator. 
 There is not much room for customization, but hey, timelines are really hard to do well. 
 Timeline.js supports only IE8 and newer. 
</dd>
<dt>

<a class="ulink" href="http://yuilibrary.com/yui/docs/charts/" target="_top">YUI Charts</a> </dt>
<dd> The Charts module for the Yahoo! User Interface Library enables creation of simple charts with a goal of wide browser support. 
</dd> </dl> 

<h3>Graph Visualizations</h3>
A “graph” is just data with a networked structure (for example, B is connected to A, and A is connected to C).

<dl class="variablelist">
<dt>

<a class="ulink" href="http://arborjs.org/" target="_top">Arbor.js</a> </dt>
<dd> A library for graph visualization using jQuery. 
 Even if you never use this, you should check out how the documentation is presented as a graph, using the tool itself. 
 (It’s so

<em>meta</em>.)  It uses the HTML canvas, so it works only in IE9 or current browsers, although some workarounds are available. 
</dd>
<dt>

<a class="ulink" href="http://sigmajs.org/" target="_top">Sigma.js</a> </dt>
<dd> A very lightweight library for graph visualization. 
 You have to visit this website, move your mouse over the header graphic, and then play with the demos. 
 Sigma.js is beautiful and fast, and it also uses canvas. 
</dd> </dl> 

<h3>Geomapping</h3>
I distinguish between

<em>mapping</em> (all visualizations are maps) and

<em>geomapping</em> (visualizations that include geographic data, or geodata, such as traditional maps). 
D3 has a lot of geomapping functionality, but you should know about these other tools.

<dl class="variablelist">
<dt>

<a class="ulink" href="http://kartograph.org/" target="_top">Kartograph</a> </dt>
<dd> A JavaScript-and-Python combo for gorgeous, entirely vector-based mapping by Gregor Aisch with must-see demos. 
 Please go look at them now. 
 I promise you’ve never seen online maps this beautiful. 
 Kartograph works with IE7 and newer. 
</dd>
<dt>

<a class="ulink" href="http://leaflet.cloudmade.com/" target="_top">Leaflet</a> </dt>
<dd> A library for tiled maps, designed for smooth interaction on both desktop and mobile devices. 
It includes some support for displaying data layers of SVG on top </dd> </dl>
of the map tiles. 
(See Mike’s demo

<a class="ulink" href="http://bost.ocks.org/mike/leaflet/" target="_top">“Using D3 with Leaflet”</a>.)  Leaflet works with IE6 (barely) or IE7 (better!) and of course all current browsers.

<dl class="variablelist">
<dt>

<a class="ulink" href="http://modestmaps.com/" target="_top">Modest Maps</a> </dt>
<dd> The granddaddy of tiled map libraries, Modest Maps has been succeeded by Polymaps, but lots of people still love it, as it is lightweight and works with old versions of IE and other browsers. 
 Modest Maps has been adapted for ActionScript, Processing, Python, PHP, Cinder, openFrameworks…yeah, basically everything. 
 File this under “oldie, but goodie.” </dd>
<dt>

<a class="ulink" href="http://polymaps.org/" target="_top">Polymaps</a> </dt>
<dd> A library for displaying tiled maps, with layers of data on top of the tiles. 
 Polymaps relies on SVG and thus works best with current browsers. 
</dd> </dl> 

<h3>Almost from Scratch</h3>
These tools, like D3, provide methods of drawing visual forms, but without predesigned visual templates. 
If you enjoy the creative freedom of starting from scratch, you might enjoy these.

<dl class="variablelist">
<dt>

<a class="ulink" href="http://processingjs.org/" target="_top">Processing.js</a> </dt>
<dd> A native JavaScript implementation of

<a class="ulink" href="http://processing.org/" target="_top">Processing</a>, the fantastic programming language for artists and designers new to programming. 
Processing is written in Java, so exporting Processing sketches to the Web traditionally involved clunky Java applets. 
Thanks to Processing.js, regular Processing code can run natively, in the browser. 
It renders using canvas, so only modern browsers are supported. 
</dd>
<dt>

<a class="ulink" href="http://paperjs.org/" target="_top">Paper.js</a> </dt>
<dd> A framework for rendering vector graphics to canvas. 
Also, its website is one of the most beautiful on the Internet, and their demos are unbelievable. 
(Go play with them now.) </dd>
<dt>

<a class="ulink" href="http://raphaeljs.com/" target="_top">Raphaël</a> </dt>
<dd> Another library for drawing vector graphics, popular due to its friendly syntax and support for older browsers. 
</dd> </dl> 

<h3>Three-Dimensional</h3>
D3 is not the best at 3D, simply because web browsers are historically two-dimensional beasts. 
But with increased support for WebGL, there are now more opportunities for 3D web experiences.

<dl class="variablelist">
<dt>

<a class="ulink" href="http://www.senchalabs.org/philogl/" target="_top">PhiloGL</a> </dt>
<dd> A WebGL framework specifically for 3D visualization. 
</dd>
<dt>

<a class="ulink" href="http://mrdoob.github.com/three.js/" target="_top">Three.js</a> </dt>
<dd> A library for generating any sort of 3D scene you could imagine, produced by Google’s Data Arts team. 
You could spend all day exploring the mind-blowing demos on their site. 
</dd> </dl> 

<h3>Tools Built with D3</h3>
When you want to use D3 without actually writing any D3 code, you can choose one of the many tools built on top of D3!

<dl class="variablelist">
<dt>

<a class="ulink" href="http://square.github.com/crossfilter/" target="_top">Crossfilter</a> </dt>
<dd> A library for working with large, multivariate datasets, written primarily by Mike Bostock. 
 This is useful for trying to squeeze your “big data” into a relatively small web browser. 
</dd>
<dt>

<a class="ulink" href="http://square.github.com/cubism/" target="_top">Cubism</a> </dt>
<dd> A D3 plug-in for visualizing time series data, also written by Mike Bostock. 
(One of my favorite demos.) </dd>
<dt>

<a class="ulink" href="https://dashku.com/" target="_top">Dashku</a> </dt>
<dd> An online tool for data dashboards and widgets updated in real time, by Paul Jensen. 
</dd>
<dt>

<a class="ulink" href="http://nickqizhu.github.com/dc.js/" target="_top">dc.js</a> </dt>
<dd> The “dc” is short for

<em>dimensional charting</em>, as this library is optimized for exploring large, multidimensional datasets. 
</dd>
<dt>

<a class="ulink" href="http://nvd3.org" target="_top">NVD3</a> </dt>
<dd> Reusable charts with D3. 
 NVD3 offers lots of beautiful examples, with room for visual customizations without requiring as much code as D3 alone. 
</dd>
<dt>

<a class="ulink" href="http://polychart.com/" target="_top">Polychart.js</a> </dt>
<dd> More reusable charts, with a range of chart types available. 
 Polychart.js is free only for noncommercial use. 
</dd>
<dt>

<a class="ulink" href="http://code.shutterstock.com/rickshaw/" target="_top">Rickshaw</a> </dt>
<dd> A toolkit for displaying time series data that is also very customizable. 
</dd>
<dt>

<a class="ulink" href="http://enjalot.com/" target="_top">Tributary</a> </dt>
<dd> A great tool for experimenting with live coding using D3, by Ian Johnson.

 </dd> </dl>

<h1><span class="orange">Chapter 3. Technology Fundamentals</span></h1>
Solid familiarity with the following concepts will make your time with D3 a lot less frustrating and a lot more rewarding. 
Consider this a brief refresher course on Web-Making 101.

Beware! This is a pretty dense chapter, packed with years’ worth of web development knowledge, and nothing in here is specific to D3. 
 I recommend skimming just the sections on information that is new to you, and skipping the rest. 
 You can always reference this chapter later as questions arise.

<h2>The Web</h2>
If you’re brand new to making web pages, you will now have to think about things that regular people blissfully disregard every day, such as this: How does the Web actually work?

We think of the Web as a bunch of interlinked pages, but it’s really a collection of conversations between web servers and web clients (browsers).

The following scene is a dramatization of a typical such conversation that happens whenever you or anyone else clicks a link or types an address into your browser (meaning, this brief conversation is had about 88 zillion times every day):

<blockquote class="blockquote">
CLIENT: I’d really like to know what’s going on over at

<em>somewebsite.com</em>. 
I better call over there to get the latest info. 
[Silent sound of Internet connection being established.]

SERVER: Hello, unknown web client! I am the server hosting

<em>somewebsite.com</em>. 
What page would you like?

CLIENT: This morning, I am interested in the page at

<em>somewebsite.com/news/</em>.

SERVER: Of course, one moment.

<em>Code is transmitted from SERVER to CLIENT.</em>

CLIENT: I have received it. 
Thank you!

SERVER: You’re welcome! Would love to stay on the line and chat, but I have other requests to process. 
Bye!
 </blockquote>
Clients contact servers with

<em>requests</em>, and servers respond with data. 
But what is a server and what is a client?

<em>Web servers</em> are Internet-connected computers running server software, so called because they

<em>serve</em> web documents as requested. 
Servers are typically always on and always connected, but web developers often also run

<em>local</em> servers, meaning they run on the same computer that you’re working on.

<em>Local</em> means here;

<em>remote</em> means somewhere else, on any computer but the one right in front of you.

There are lots of different server software packages, but Apache is the most common. 
Web server software is not pretty, and no one ever wants to look at it.

In contrast, web

<em>browsers</em> can be very pretty, and we spend a lot of time looking at them. 
Regular people recognize names like Firefox, Safari, Chrome, and Internet Explorer, all of which are browsers or

<em>web clients</em>.

Every web page, in theory, can be identified by its URL (Uniform Resource Locator) or URI (Uniform Resource Identifier). 
Most people don’t know what

<em>URL</em> stands for, but they recognize one when they see it. 
By obsolete convention, URLs commonly begin with

<em>www</em>, as in

<a class="ulink" href="http://www.calmingmanatee.com" target="_top">http://www.calmingmanatee.com</a>, but with a properly configured server, the

<em>www</em> part is wholly unnecessary.

Complete URLs consist of four parts:

 An indication of the

<em>communication protocol</em>, such as HTTP or HTTPS  The

<em>domain name</em> of the resource, such as

<em>calmingmanatee.com</em>  The

<em>port number</em>, indicating over which port the connection to the server should be attempted  Any additional locating information, such as the path of the requested file, or any query parameters

  
A complete URL, then, might look like this:

<a class="ulink" href="http://alignedleft.com:80/tutorials/d3/" target="_top">http://alignedleft.com:80/tutorials/d3/</a>.

Typically, the port number is excluded, as web browsers will try to connect over port 80 by default. 
 So the preceding URL is functionally the same as the following:

<a class="ulink" href="http://alignedleft.com/tutorials/d3/" target="_top">http://alignedleft.com/tutorials/d3/</a>

Note that the protocol is separated from the domain name by a colon and two forward (regular) slashes. 
Why two slashes? No reason. 
The inventor of the Web

<a class="ulink" href="http://nyti.ms/Xaol4j" target="_top">regrets the error</a>.

HTTP stands for Hypertext Transfer Protocol, and it’s the most common protocol for transferring web content from server to client. 
The “S” on the end of HTTPS stands for

<em>Secure</em>. 
HTTPS connections are used whenever information should be encrypted in transit, such as for online banking or e-commerce.

Let’s briefly step through the process of what happens when a person goes to visit a website.

<ol class="orderedlist" type="1">
 User runs the web browser of her choice, then types a URL into the address bar, such as

<em>alignedleft.com/tutorials/d3/</em>. 
Because she did not specify a protocol, HTTP is assumed, and “http://” is prepended to the URL. 
 The browser then attempts to connect to the server behind

<em>alignedleft.com</em> across the network, via port 80, the default port for HTTP. 
 The server associated with

<em>alignedleft.com</em> acknowledges the connection and is taking requests. 
(“I’ll be here all night.”)  The browser sends a request for the page that lives at

<em>/tutorials/d3/</em>. 
 The server sends back the HTML content for that page. 
 As the client browser receives the HTML, it discovers references to

<em>other files</em> needed to assemble and display the entire page, including CSS stylesheets and image files. 
So it contacts the same server again, once per file, requesting the additional information. 
 The server responds, dispatching each file as needed. 
 Finally, all the web documents have been transferred over. 
Now the client performs its most arduous task, which is to

<em>render</em> the content. 
It first parses through the HTML to understand the structure of the content. 
Then it reviews the CSS selectors, applying any properties to matched elements. 
Finally, it plugs in any image files and executes any JavaScript code. 
 </ol>
Can you believe that all that happens every time you click a link? It’s a lot more complicated than most people realize, but it’s important to understand that client/server conversations are fundamental to the Web.

<h2>HTML</h2>
Hypertext Markup Language is used to structure content for web browsers. 
HTML is stored in plain text files with the

<em>.html</em> suffix. 
A simple

 HTML document looks like this:

<code class="cp">&lt;!DOCTYPE html></code> <code class="nt">&lt;html></code>     <code class="nt">&lt;head></code>         <code class="nt">&lt;title></code>Page Title<code class="nt">&lt;/title></code>     <code class="nt">&lt;/head></code>     <code class="nt">&lt;body></code>         <code class="nt">&lt;h1></code>Page Title<code class="nt">&lt;/h1></code>         <code class="nt">&lt;p></code>This is a really interesting paragraph.<code class="nt">&lt;/p></code>     <code class="nt">&lt;/body></code> <code class="nt">&lt;/html></code>
HTML is a complex language with a rich history. 
This overview will address only the current iteration of HTML (formerly known as HTML5) and will touch on only what is immediately relevant for our practice with D3.

<h3>Content Plus Structure</h3>
The core function of HTML is to enable you to “mark up” content, thereby

 giving it structure. 
Take, for example, this raw text:

Amazing Visualization Tool Cures All Ills A new open-source tool designed for visualization of data turns out to have an unexpected, positive side effect: it heals any ailments of the viewer. 
Leading scientists report that the tool, called D3000, can cure even the following symptoms: fevers chills general malaise It achieves this end with a patented, three-step process. 
Load in data. 
Generate a visual representation. 
Activate magic healing function.
Reading between the lines, we can infer that this is a very exciting news story. 
But as unstructured content, it is very hard to read. 
By adding structure, we can differentiate between the headline, for example, and the body of the story.

<blockquote class="blockquote">

<strong>Amazing Visualization Tool Cures All Ills</strong>

A new open-source tool designed for visualization of data turns out to have an unexpected, positive side effect: it heals any ailments of the viewer. 
Leading scientists report that the tool, called D3000, can cure even the following symptoms:

 fevers  chills  general malaise  
It achieves this end with a patented, three-step process.

<ol class="orderedlist" type="1">
 Load in data. 
 Generate a visual representation. 
 Activate magic healing function. 
 </ol> </blockquote>
That has the same raw text content, but with a

<em>visual structure</em> that makes the content more accessible.

HTML is a tool for specifying

<em>semantic structure</em>, or attaching hierarchy, relationships, and

<em>meaning</em> to content. 
(HTML doesn’t address the visual representation of a
document’s structure—that’s CSS’ job.) Here is our story with each chunk of content replaced by a

<em>semantic description</em> of what that content is.

<blockquote class="blockquote">

<strong>Headline</strong>

Paragraph text

 Unordered list item  Unordered list item  Unordered list item  
Paragraph text

<ol class="orderedlist" type="1">
 Numbered list item  Numbered list item  Numbered list item  </ol> </blockquote>
This is the kind of structure we specify with HTML markup.

<h3>Adding Structure with Elements</h3>
“Marking up” is the process of adding

<em>tags</em> to create

<em>elements</em>. 
HTML tags begin with <code class="literal">&lt;</code> and end with <code class="literal">></code>, as in <code class="literal">&lt;p></code>, which is the tag indicating a paragraph of text. 
 Tags usually occur in pairs, in which case adding an opening and closing pair of tags creates a new

<em>element</em> in the document structure.

Closing tags are indicated with a slash that closes or ends the element, as in <code class="literal">&lt;/p></code>. 
Thus, a paragraph of text may be marked up like the following:

<code class="nt">&lt;p></code>This is a really interesting paragraph.<code class="nt">&lt;/p></code>
Some elements can be

<em>nested</em>. 
For example, here we use the <code class="literal">em</code> element to add

<em>emphasis</em>.

<code class="nt">&lt;p></code>This is a <code class="nt">&lt;em></code>really<code class="nt">&lt;/em></code> interesting paragraph.<code class="nt">&lt;/p></code>
Nesting elements introduces hierarchy to the document. 
In this case, <code class="literal">em</code> is a child of <code class="literal">p</code> because it is contained by <code class="literal">p</code>. 
(Conversely, <code class="literal">p</code> is <code class="literal">em</code>’s parent.)

When elements are nested, they cannot overlap closures of their parent elements, as doing so would disrupt the hierarchy. 
For example:

<code class="nt">&lt;p></code>This could cause <code class="nt">&lt;em></code>unexpected<code class="nt">&lt;/p></code> <code class="nt">&lt;p></code>results<code class="nt">&lt;/em></code>, and is best avoided.<code class="nt">&lt;/p></code>
Some tags never occur in pairs, such as the <code class="literal">img</code> element, which references an image file. 
Although HTML no longer requires it, you will sometimes see such tags written in

<em>self-closing</em> fashion, with a trailing slash before the closing bracket:

<code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"photo.jpg"</code> <code class="nt">/></code>
As of HTML5, the self-closing slash is optional, so the following code is equivalent to the preceding code:

<code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"photo.jpg"</code><code class="nt">></code> 

<h3>Common Elements</h3>
There are hundreds of different HTML elements. 
Here are some of the most common. 
We’ll cover additional elements in later chapters. 
(Reference the excellent

<a class="ulink" href="https://developer.mozilla.org/en/HTML/Element" target="_top">Mozilla Developer Network documentation</a> for a complete listing.)

<dl class="variablelist">
<dt>
 <code class="literal">&lt;!DOCTYPE html></code> </dt>
<dd> The standard document type declaration. 
Must be the first thing in the document. 
</dd>
<dt>
 <code class="literal">html</code> </dt>
<dd> Surrounds all HTML content in a document. 
</dd>
<dt>
 <code class="literal">head</code> </dt>
<dd> The document <code class="literal">head</code> contains all metadata about the document, such as its <code class="literal">title</code> and any references to external stylesheets and scripts. 
</dd>
<dt>
 <code class="literal">title</code> </dt>
<dd> The title of the document. 
Browsers typically display this at the top of the browser window and use this title when bookmarking a page. 
</dd>
<dt>
 <code class="literal">body</code> </dt>
<dd> Everything not in the <code class="literal">head</code> should go in the <code class="literal">body</code>. 
This is the primary visible content of the page. 
</dd>
<dt>
 <code class="literal">h1</code>, <code class="literal">h2</code>, <code class="literal">h3</code>, <code class="literal">h4</code> </dt>
<dd> These let you specify headings of different levels. 
<code class="literal">h1</code> is a top-level heading, <code class="literal">h2</code> is below that, and so on. 
</dd>
<dt>
 <code class="literal">p</code> </dt>
<dd> A paragraph! </dd>
<dt>
 <code class="literal">ul</code>, <code class="literal">ol</code>, <code class="literal">li</code> </dt>
<dd> Unordered lists are specified with <code class="literal">ul</code>, most often used for bulleted lists. 
Ordered lists (<code class="literal">ol</code>) are often numbered. 
Both <code class="literal">ul</code> and <code class="literal">ol</code> should include <code class="literal">li</code> elements to specify list items. 
</dd>
<dt>
 <code class="literal">em</code> </dt>
<dd> Indicates emphasis. 
Typically rendered in

<em>italics</em>. 
</dd>
<dt>
 <code class="literal">strong</code> </dt>
<dd> Indicates additional emphasis. 
Typically rendered in

<strong>boldface</strong>. 
</dd>
<dt>
 <code class="literal">a</code> </dt>
<dd> A link. 
Typically rendered as underlined, blue text, unless otherwise specified. 
</dd>
<dt>
 <code class="literal">span</code> </dt>
<dd> An arbitrary <code class="literal">span</code> of text, typically within a larger containing element like <code class="literal">p</code>. 
</dd>
<dt>
 <code class="literal">div</code> </dt>
<dd> An arbitrary

<em>division</em> within the document. 
Used for grouping and containing related elements. 
</dd> </dl>
Our earlier example could be given semantic structure by marking it up using some of these element’s tags:

<code class="nt">&lt;h1></code>Amazing Visualization Tool Cures All Ills<code class="nt">&lt;/h1></code> <code class="nt">&lt;p></code>A new open-source tool designed for visualization of data turns out to have an unexpected, positive side effect: it heals any ailments of the viewer. 
Leading scientists report that the tool, called D3000, can cure even the following symptoms:<code class="nt">&lt;/p></code> <code class="nt">&lt;ul></code>     <code class="nt">&lt;li></code>fevers<code class="nt">&lt;/li></code>     <code class="nt">&lt;li></code>chills<code class="nt">&lt;/li></code>     <code class="nt">&lt;li></code>general malaise<code class="nt">&lt;/li></code> <code class="nt">&lt;/ul></code> <code class="nt">&lt;p></code>It achieves this end with a patented, three-step process.<code class="nt">&lt;/p></code> <code class="nt">&lt;ol></code>     <code class="nt">&lt;li></code>Load in data.<code class="nt">&lt;/li></code>     <code class="nt">&lt;li></code>Generate a visual representation.<code class="nt">&lt;/li></code>     <code class="nt">&lt;li></code>Activate magic healing function.<code class="nt">&lt;/li></code> <code class="nt">&lt;/ol></code>
When viewed in a web browser, that markup is rendered as shown in

<a class="xref" href="#Typical_default_rendering_of_simple_HTML" title="Figure 3-1. Typical default rendering of simple HTML">Figure 3-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0301.png" alt="Typical default rendering of simple HTML">
Figure 3-1. Typical default rendering of simple HTML 
Notice that we specified only the

<em>semantic</em> structure of the content; we didn’t specify any visual properties, such as color, type size, indents, or line spacing. 
Without such instructions, the browser falls back on its

<em>default styles</em>, which, frankly, are not too
exciting.

<h3>Attributes</h3>
All HTML elements can be assigned

<em>attributes</em> by including property/value pairs in the opening tag.

<code class="nt">&lt;tagname</code> <code class="na">property=</code><code class="s">"value"</code><code class="nt">>&lt;/tagname></code>
The name of the property is followed by an equals sign, and the value is enclosed within double quotation marks.

Different kinds of elements can be assigned different attributes. 
For example, the <code class="literal">a</code> link tag can be given an <code class="literal">href</code> attribute, whose value specifies the URL for that link. 
(<code class="literal">href</code> is short for “HTTP reference.”)

<code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://d3js.org/"</code><code class="nt">></code>The D3 website<code class="nt">&lt;/a></code>
Some attributes can be assigned to

<em>any</em> type of element, such as <code class="literal">class</code> and <code class="literal">id</code>.

<h3>Classes and IDs</h3>
Classes and IDs are extremely useful attributes, as they can be

 referenced later to identify specific pieces of content. 
Your CSS and JavaScript code will rely heavily on classes and IDs to identify elements. 
For example:

<code class="nt">&lt;p></code>Brilliant paragraph<code class="nt">&lt;/p></code> <code class="nt">&lt;p></code>Insightful paragraph<code class="nt">&lt;/p></code> <code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"awesome"</code><code class="nt">></code>Awe-inspiring paragraph<code class="nt">&lt;/p></code>
These are three very uplifting paragraphs, but only one of them is truly awesome, as I’ve indicated with <code class="literal">class="awesome"</code>. 
The third paragraph becomes part of a

<em>class</em> of

<em>awesome</em> elements, and it can be selected and manipulated along with other class members. 
(We’ll get to that in a moment.)

Elements can be assigned multiple classes, simply by separating them with a space:

<code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"uplifting"</code><code class="nt">></code>Brilliant paragraph<code class="nt">&lt;/p></code> <code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"uplifting"</code><code class="nt">></code>Insightful paragraph<code class="nt">&lt;/p></code> <code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"uplifting awesome"</code><code class="nt">></code>Awe-inspiring paragraph<code class="nt">&lt;/p></code>
Now, all three paragraphs are <code class="literal">uplifting</code>, but only the last one is both <code class="literal">uplifting</code>

<em>and</em> <code class="literal">awesome</code>.

IDs are used in much the same way, but there can be only one ID per

 element, and each ID value can be used only once on the page. 
For example:

<code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"content"</code><code class="nt">></code>     <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"visualization"</code><code class="nt">>&lt;/div></code>     <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"button"</code><code class="nt">>&lt;/div></code> <code class="nt">&lt;/div></code>
IDs are useful when a single element has some special quality, like a <code class="literal">div</code> that functions as a button or as a container for other content on the page.

As a general rule, if there will be only

<em>one</em> such element on the page, you can use an <code class="literal">id</code>. 
Otherwise, use a <code class="literal">class</code>.

Class and ID names cannot begin with numerals; they must begin with alphabetic characters. 
So <code class="literal">id="1"</code> won’t work, but <code class="literal">id="item1"</code> will. 
The browser will not give you any errors; your code simply won’t work, and you will go crazy trying to figure out why.

<h3>Comments</h3>
As code grows in size and complexity, it is good practice to include comments. 
These are friendly notes that you leave for yourself to remind you why you wrote the code the way you did. 
If you are like me, you will revisit projects only weeks later and have lost all recollections of it. 
Commenting is an easy way to reach out and provide guidance and solace to your future (and very confused) self.

In HTML, comments are written in the following format:

<code class="c">&lt;!-- Your comment here --></code>
Anything between the <code class="literal">&lt;!--</code> and <code class="literal">--></code> will be ignored by the web browser.

  

<h2>DOM</h2>
The term Document Object Model refers to the hierarchical structure of

 HTML. 
Each pair of bracketed tags (or, in some cases, a single tag) is an

<em>element</em>, and we refer to elements’ relative relationships to each other in human terms: parent, child, sibling, ancestor, and descendant. 
For example, in this HTML:

<code class="nt">&lt;html></code>     <code class="nt">&lt;body></code>         <code class="nt">&lt;h1></code>Breaking News<code class="nt">&lt;/h1></code>         <code class="nt">&lt;p>&lt;/p></code>     <code class="nt">&lt;/body></code> <code class="nt">&lt;/html></code>
<code class="literal">body</code> is the parent element to both of its children, <code class="literal">h1</code> and <code class="literal">p</code> (which are siblings to each other). 
All elements on the page are descendants of <code class="literal">html</code>.

Web browsers parse the DOM to make sense of a page’s content. 
As coders building visualizations, we care about the DOM, because our code must navigate its hierarchy to apply styles and actions to its elements. 
We don’t want to make

<em>all</em> the <code class="literal">div</code> elements blue; we need to know how to select just the <code class="literal">div</code>s of the class <code class="literal">sky</code> and make

<em>them</em> blue.

<h2>Developer Tools</h2>
In the olden days, the web development process went like this:

<ol class="orderedlist" type="1">
 Write some code in a text editor.

  Save the files. 
 Switch to a browser window. 
 Reload the page, and see if your code worked. 
 If it didn’t work, take a guess at what went wrong inside the magical black box of the web browser, then go back to step 1. 
 </ol>
Browsers were notoriously secretive about what went on

<em>inside</em> the rendering engine, which made debugging a total nightmare. 
 (Seriously, in the late 1990s and early 2000s, I literally had nightmares about this.)  Fortunately, we live in a more enlightened age, and every modern-day browser has built-in

<em>developer tools</em> that expose the inner workings of the beast and enable us to poke around under the hood (to mix incompatible metaphors).

All this is to say that developer tools are a big deal and you will rely on them heavily to both test your code and, when something breaks, figure out what went wrong.

Let’s start with the simplest possible use of the developer tools: viewing the raw

 source code of an HTML page (see

<a class="xref" href="#plain_source_view_window" title="Figure 3-2. Looking at the source code in a new window">Figure 3-2</a>).

Every browser supports this, although different browsers hide this option in different places. 
 In Chrome 23.0, it’s under View→Developer→View Source. 
 In Firefox 17.0, look under Tools→Web Developer→Page Source. 
 In Safari 6.0, it’s under Develop→Show Page Source (although you must first set the “Develop” menu to display under Safari→Preferences→Advanced). 
 Going forward, I’m going to assume that you’re using the newest version of whatever browser you choose.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0302.png" alt="Looking at the source code in a new window">
Figure 3-2. Looking at the source code in a new window 
That gets you the raw HTML, but if any D3 or JavaScript code has been executed, the current DOM may be vastly different.

Fortunately, your browser’s developer tools enable you to see the current state of the DOM. 
 And, again, the developer tools are different in every browser. 
 In Chrome, find them under View→Developer→Developer Tools. 
 In Firefox, try Tools→Web Developer. 
 In Safari, first enable the developer tools (in Safari→Preferences→Advanced). 
 Then, in the Develop menu, choose Show Web Inspector. 
 In any browser, you can also use the corresponding keyboard shortcut (as shown adjacent to the menu item) or right-click and choose “inspect element” or something similar.

Until recently, Safari and Chrome shared the same developer tools, but with Safari 6.0, Apple completely redesigned their dev tools, much to the dismay of many web-developing Safari fans. 
 (The new tools are very hard to navigate, and I don’t think I’m the only one who feels that way.)  Whichever browser you use might look a bit different from my screenshots, but the functionality will be very similar.

<a class="xref" href="#Safari_web_inspector" title="Figure 3-3. Chrome’s web inspector">Figure 3-3</a> shows the Elements tab of Chrome’s web inspector. 
 Here we can see the current state of the DOM. 
This is useful because your code will modify DOM elements dynamically. 
 In the web inspector, you can watch elements as they change.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0303.png" alt="Chrome’s web inspector">
Figure 3-3. Chrome’s web inspector 
If you look closely, you’ll already see some differences between the raw HTML and the DOM, including the fact that Chrome generated the required <code class="literal">html</code>, <code class="literal">head</code>, and <code class="literal">body</code> elements. 
(I was lazy and didn’t include them in my original HTML.)

One more thing: why am I focusing on Chrome, Firefox, and Safari? Why not Internet Explorer, Opera, or the many other browsers out there? For one, it’s best to develop your projects using a browser with the broadest support for web standards. 
Internet Explorer made huge progress with versions 9 and 10, but Chrome, Firefox, and Safari are understood to have the broadest standards support, and they are updated more frequently.

Second, you’re going to spend a lot of time using the developer tools, so you should develop with a browser that has tools you enjoy using. 
 I was pretty devoted to Safari until the 6.0 update changed everything. 
 Now I’m going back and forth between Chrome and Firefox’s new dev tools. 
 I recommend you try them all and decide what works best for you.


<h2>Rendering and the Box Model</h2>

<em>Rendering</em> is the process by which browsers, after parsing the HTML and generating the DOM, apply visual rules to the DOM contents and draw those pixels to the screen.

The most important thing to keep in mind when considering how browsers render content is this: to a browser, everything is a box.

Paragraphs, <code class="literal">div</code>s, <code class="literal">span</code>s—all are boxes in the sense that they are two-dimensional rectangles, with properties that any rectangle can have, such as width, height, and positions in space. 
Even if something looks curved or irregularly shaped, rest assured, to the browser, it is merely another rectangular box.

You can see these boxes with the help of the web inspector. 
Just mouse over any element, and the box associated with that element is highlighted in blue, as shown in

<a class="xref" href="#Inspector_with_element_box_highlighted" title="Figure 3-4. Inspector with element box highlighted">Figure 3-4</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0304.png" alt="Inspector with element box highlighted">
Figure 3-4. Inspector with element box highlighted 
There’s a lot of information about the <code class="literal">ul</code> unordered list here. 
Note that the list’s total dimensions (width and height) are shown in the yellow box at the element’s lower-left corner. 
Also, the list’s position in the DOM hierarchy is indicated in the lower-left corner of the inspector: <code class="literal">html > body > ul</code>.

The box for the <code class="literal">ul</code> expands to fill the width of the entire window because it is a

<em>block-level</em> element. 
(Note how under “Computed Style” is listed <code class="literal">display: block</code>.) This is in contrast to

<em>inline</em> elements, which rest

<em>in line</em> with each other, not stacked on top of each other like blocks. 
Common inline elements include <code class="literal">strong</code>, <code class="literal">em</code>, <code class="literal">a</code>, and <code class="literal">span</code>.

By default, block-level elements expand to fill their container elements and force any subsequent sibling elements further down the page. 
Inline elements do not expand to fill extra space, and happily exist side by side, next to their fellow inline neighbors. 
(Discussion question: what kind of element would you rather be?)

<h2>CSS</h2>
Cascading Style Sheets are used to style the visual presentation of DOM

 elements. 
A simple CSS stylesheet looks like the following:

<code class="nt">body</code> <code class="p">{</code>     <code class="k">background-color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code> <code class="p">}</code>
CSS styles consist of

<em>selectors</em> and

<em>properties</em>. 
Selectors are

 followed by properties, grouped in curly brackets. 
A property and its value are separated by a colon, and the line is terminated with a semicolon, like the following:

<code class="nt">selector</code> <code class="p">{</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code> <code class="p">}</code>
The same properties can be applied to multiple selectors at once by separating the selectors with a comma, as in the following:

<code class="nt">selectorA</code><code class="o">,</code> <code class="nt">selectorB</code><code class="o">,</code> <code class="nt">selectorC</code> <code class="p">{</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code>     <code class="n">property</code><code class="o">:</code> <code class="n">value</code><code class="p">;</code> <code class="p">}</code>
For example, you might want to specify that both <code class="literal">p</code> paragraphs and <code class="literal">li</code> list items should use the same font size, line height, and color.

<code class="nt">p</code><code class="o">,</code> <code class="nt">li</code> <code class="p">{</code>     <code class="k">font-size</code><code class="o">:</code> <code class="m">12px</code><code class="p">;</code>     <code class="k">line-height</code><code class="o">:</code> <code class="m">14px</code><code class="p">;</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">orange</code><code class="p">;</code> <code class="p">}</code>
Collectively, this whole chunk of code (selectors and bracketed properties) is called a

<em>CSS rule</em>.

<h3>Selectors</h3>
D3 uses CSS-style selectors to identify elements on which to operate, so it’s important to understand how to use them.

Selectors identify specific elements to which styles will be applied. 
There are several different kinds of selectors. 
We’ll use only the simplest ones in this book.

<dl class="variablelist">
<dt>
 Type selectors </dt>
<dd> These are the simplest. 
They match DOM elements with the same

 name: </dd> </dl>
<code class="n">h1</code>          <code class="c">/* Selects all level 1 headings           */</code> <code class="n">p</code>           <code class="c">/* Selects all paragraphs                 */</code> <code class="n">strong</code>      <code class="c">/* Selects all strong elements            */</code> <code class="n">em</code>          <code class="c">/* Selects all em elements                */</code> <code class="n">div</code>         <code class="c">/* Selects all divs                       */</code>

<dl class="variablelist">
<dt>
 Descendant selectors </dt>
<dd> These match elements that are contained by (or “descended from”) another element. 
We will rely heavily on descendant

 selectors to apply styles: </dd> </dl>
<code class="n">h1</code> <code class="n">em</code>       <code class="c">/* Selects em elements contained in an h1 */</code> <code class="n">div</code> <code class="n">p</code>       <code class="c">/* Selects p elements contained in a div  */</code>

<dl class="variablelist">
<dt>
 Class selectors </dt>
<dd> These match elements of any type that have been assigned a

 specific class. 
Class names are preceded with a period, as shown here: </dd> </dl>
<code class="o">.</code><code class="n">caption</code>    <code class="c">/* Selects elements with class "caption"  */</code> <code class="o">.</code><code class="n">label</code>      <code class="c">/* Selects elements with class "label"    */</code> <code class="o">.</code><code class="n">axis</code>       <code class="c">/* Selects elements with class "axis"     */</code>
Because elements can have more than one class, you can target elements with multiple classes by stringing the classes together, as in the following:

<code class="o">.</code><code class="n">bar</code><code class="o">.</code><code class="n">highlight</code>  <code class="c">/* Could target highlighted bars      */</code> <code class="o">.</code><code class="n">axis</code><code class="o">.</code><code class="n">x</code>         <code class="c">/* Could target an x-axis             */</code> <code class="o">.</code><code class="n">axis</code><code class="o">.</code><code class="n">y</code>         <code class="c">/* Could target a y-axis              */</code>
<code class="literal">.axis</code> could be used to apply styles to both axes, for example, whereas <code class="literal">.axis.x</code> would apply only to the x-axis.

<dl class="variablelist">
<dt>
 ID selectors </dt>
<dd> These match the single element with a given ID. 
(Remember, IDs can be

 used only once each in the DOM.) IDs are preceded with a hash mark. 
</dd> </dl>
<code class="m">#header</code>     <code class="c">/* Selects element with ID "header"       */</code> <code class="m">#nav</code>        <code class="c">/* Selects element with ID "nav"          */</code> <code class="m">#export</code>     <code class="c">/* Selects element with ID "export"       */</code>
Selectors get progressively more useful as you combine them in different ways to target specific elements. 
You can string selectors together to get very specific results. 
For
example:

<code class="n">div</code><code class="o">.</code><code class="n">sidebar</code> <code class="c">/* Selects divs with class "sidebar", but</code> <code class="c">               not other elements with that class     */</code> <code class="m">#button</code><code class="o">.</code><code class="n">on</code>  <code class="c">/* Selects element with ID "button", but</code> <code class="c">               only when the class "on" is applied    */</code>
Remember, because the DOM is dynamic, classes and IDs can be added and removed, so you might have CSS rules that apply only in certain scenarios.

For details on additional selectors, see the

<a class="ulink" href="http://mzl.la/V27Mcr" target="_top">Mozilla Developer Network</a>.

<h3>Properties and Values</h3>
Groups of property/value pairs cumulatively form the

 styles:

<code class="k">margin</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code> <code class="k">padding</code><code class="o">:</code> <code class="m">25px</code><code class="p">;</code> <code class="k">background-color</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code> <code class="k">color</code><code class="o">:</code> <code class="nb">pink</code><code class="p">;</code> <code class="k">font-family</code><code class="o">:</code> <code class="n">Helvetica</code><code class="o">,</code> <code class="n">Arial</code><code class="o">,</code> <code class="nb">sans-serif</code><code class="p">;</code>
At the risk of stating the obvious, notice that each property expects a different kind of information. 
<code class="literal">color</code> wants a color, <code class="literal">margin</code> requires a measurement (here in <code class="literal">px</code> or pixels), and so on.

By the way, colors can be specified in several different formats:

 Named colors: <code class="literal">orange</code>  Hex values: <code class="literal">#3388aa</code> or <code class="literal">#38a</code>  RGB values: <code class="literal">rgb(10, 150, 20)</code>  RGB with alpha transparency: <code class="literal">rgba(10, 150, 20, 0.5)</code>  
You can find

<a class="ulink" href="https://developer.mozilla.org/en/CSS/CSS_Reference" target="_top">exhaustive lists of properties online</a>; I won’t try to list them here. 
Instead, I’ll just introduce relevant properties as we go.


<h3>Comments</h3>
<code class="c">/* By the way, this is what a comment looks like</code> <code class="c">   in CSS. 
 They start with a slash-asterisk pair,</code> <code class="c">   and end with an asterisk-slash pair. 
 Anything</code> <code class="c">   in between will be ignored. 
*/</code> 

<h3>Referencing Styles</h3>
There are three common ways to apply CSS style rules to your HTML document.

<h4>Embed the CSS in your HTML.</h4>
If you embed the CSS rules in your HTML document, you can keep everything in one file. 
In the document <code class="literal">head</code>, include all CSS code within a <code class="literal">style</code> element.

<code class="nt">&lt;html></code>     <code class="nt">&lt;head></code>         <code class="nt">&lt;style </code><code class="na">type=</code><code class="s">"text/css"</code><code class="nt">></code>              <code class="nt">p</code> <code class="p">{</code>                 <code class="k">font-size</code><code class="o">:</code> <code class="m">24px</code><code class="p">;</code>                 <code class="k">font-weight</code><code class="o">:</code> <code class="k">bold</code><code class="p">;</code>                 <code class="k">background-color</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code>                 <code class="k">color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>             <code class="p">}</code>          <code class="nt">&lt;/style></code>     <code class="nt">&lt;/head></code>     <code class="nt">&lt;body></code>         <code class="nt">&lt;p></code>If I were to ask you, as a mere paragraph, would you say that I         have style?<code class="nt">&lt;/p></code>     <code class="nt">&lt;/body></code> <code class="nt">&lt;/html></code>
That HTML page with CSS renders as shown in

<a class="xref" href="#Rendering_of_an_embedded_CSS_rule" title="Figure 3-5. Rendering of an embedded CSS rule">Figure 3-5</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0305.png" alt="Rendering of an embedded CSS rule">
Figure 3-5. Rendering of an embedded CSS rule 
Embedding is the simplest option, but I generally prefer to keep different kinds of code (for example, HTML, CSS, JavaScript) in separate documents.

<h4>Reference an external stylesheet from the HTML.</h4>
To store CSS outside of your HTML, save it in a plain-text file with a

<em>.css</em> suffix, such as

<em>style.css</em>. 
Then use a <code class="literal">link</code> element in the document <code class="literal">head</code> to reference the external CSS file, like so:

<code class="nt">&lt;html></code>     <code class="nt">&lt;head></code>         <code class="nt">&lt;link</code> <code class="na">rel=</code><code class="s">"stylesheet"</code> <code class="na">href=</code><code class="s">"style.css"</code><code class="nt">></code>     <code class="nt">&lt;/head></code>     <code class="nt">&lt;body></code>         <code class="nt">&lt;p></code>If I were to ask you, as a mere paragraph, would you say that         I have style?<code class="nt">&lt;/p></code>     <code class="nt">&lt;/body></code> <code class="nt">&lt;/html></code>
This example renders exactly the same as the prior example.

<h4>Attach inline styles.</h4>
A third method is to attach style rules

<em>inline</em> directly to elements in

 the HTML. 
You can do this by adding a <code class="literal">style</code> attribute to any element. 
Then include the CSS rules within the double quotation marks. 
The result is shown in

<a class="xref" href="#Rendering_of_an_inline_CSS_rule" title="Figure 3-6. Rendering of an inline CSS rule">Figure 3-6</a>.

<code class="nt">&lt;p</code> <code class="na">style=</code><code class="s">"color: blue; font-size: 48px; font-style: italic;"</code><code class="nt">></code>Inline styles are kind of a hassle<code class="nt">&lt;/p></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0306.png" alt="Rendering of an inline CSS rule">
Figure 3-6. Rendering of an inline CSS rule 
Because inline styles are attached directly to elements, there is no need for selectors.

Inline styles are messy and hard to read, but they are useful for giving special treatment to a single element, when that style information doesn’t make sense in a larger stylesheet. 
We’ll learn how to apply inline styles programmatically with D3 (which is much easier than typing them in by hand, one at a time).
  

<h3>Inheritance, Cascading, and Specificity</h3>
Many style properties are

<em>inherited</em> by an element’s descendants unless otherwise specified. 
For example, this document’s style rule applies to

 the <code class="literal">div</code>:

<code class="nt">&lt;html></code>     <code class="nt">&lt;head></code>         <code class="nt">&lt;title>&lt;/title></code>         <code class="nt">&lt;style </code><code class="na">type=</code><code class="s">"text/css"</code><code class="nt">></code>              <code class="nt">div</code> <code class="p">{</code>                 <code class="k">background-color</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code>                 <code class="k">font-size</code><code class="o">:</code> <code class="m">24px</code><code class="p">;</code>                 <code class="k">font-weight</code><code class="o">:</code> <code class="k">bold</code><code class="p">;</code>                 <code class="k">color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>             <code class="p">}</code>          <code class="nt">&lt;/style></code>     <code class="nt">&lt;/head></code>     <code class="nt">&lt;body></code>         <code class="nt">&lt;p></code>I am a sibling to the div.<code class="nt">&lt;/p></code>         <code class="nt">&lt;div></code>             <code class="nt">&lt;p></code>I am a descendant and child of the div.<code class="nt">&lt;/p></code>         <code class="nt">&lt;/div></code>     <code class="nt">&lt;/body></code> <code class="nt">&lt;/html></code>
Yet when this page renders, the styles intended for the <code class="literal">div</code> (red background, bold text, and so on) are

<em>inherited</em> by the second paragraph, as shown in

<a class="xref" href="#Inherited_style" title="Figure 3-7. Inherited style">Figure 3-7</a>, because that <code class="literal">p</code> is a descendant of the styled <code class="literal">div</code>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0307.png" alt="Inherited style">
Figure 3-7. Inherited style 
Inheritance is a great feature of CSS, as children adopt the styles of their parents. 
(There’s a metaphor in there somewhere.)

Finally, an answer to the most pressing question of the day: why are they called Cascading Style Sheets? It’s because selector matches cascade from the top down. 
When more than one selector applies to an element, the later rule generally overrides the earlier one. 
For

 example, the following rules set the text of all paragraph elements in the document to be blue

<em>except</em> for those with the class of <code class="literal">highlight</code> applied, which will be black

<em>and</em> have a yellow background, as shown in

<a class="xref" href="#CSS_cascading_and_inheritance_at_work" title="Figure 3-8. CSS cascading and inheritance at work">Figure 3-8</a>. 
The rules for <code class="literal">p</code> are applied first, but then the rules for <code class="literal">p.highlight</code> override the less specific <code class="literal">p</code> rules.

<code class="nt">p</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">blue</code><code class="p">;</code> <code class="p">}</code>  <code class="nt">p</code><code class="nc">.highlight</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>     <code class="k">background-color</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code> <code class="p">}</code>

Try It Now!
Try modifying the CSS rules on the left, and see the effect on the Web page rendering on the right.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0308.png" alt="CSS cascading and inheritance at work">
Figure 3-8. CSS cascading and inheritance at work 
Later rules generally override earlier ones, but not always. 
The true logic has to do with the

<em>specificity</em> of each selector. 
The <code class="literal">p.highlight</code> selector would override the <code class="literal">p</code> rule even if it were listed first, simply because it is a more specific selector. 
If two selectors have the same specificity, then the later one will be applied.

This is one of the main causes of confusion with CSS. 
The rules for calculating specificity are inscrutable, and I won’t cover them here. 
To save yourself headaches later, keep your selectors clear and easy to read. 
Start with general selectors on top, and work your way down to more specific ones, and you’ll be all right.

  

<h2>JavaScript</h2>
JavaScript is the scripting language that can make pages dynamic by manipulating the DOM after a page has already loaded in the browser. 
As I mentioned earlier, getting to know D3 is also a process of getting to know JavaScript. 
We’ll dig in deeper as we go, but here is a taste to get you started.

<h3>Hello, Console</h3>
Normally, we write JavaScript code (or, a “script”) in a text file, and then load that file to the browser in a web page. 
But you can also just type JavaScript code directly into your browser. 
This is an easy and quick way to get your feet wet and test out code. 
 We’ll also use the JavaScript console for debugging, as it’s an essential tool for seeing what’s going on with your code.

In Chrome, select View→Developer→JavaScript Console. 
 In Firefox, choose Tools→Web Developer→Web Console. 
 In Safari, go to Develop→Show Error Console (see

<a class="xref" href="#A_fresh_JavaScript_console" title="Figure 3-9. A fresh JavaScript console… delicious!">Figure 3-9</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0309.png" alt="A fresh JavaScript console… delicious!">
Figure 3-9. A fresh JavaScript console… delicious! 
The console accepts one line of code at a time, and it always spits back the result of whatever you input. 
For example, if you enter the number <code class="literal">7</code>, the console returns the mind-numbingly obvious result of <code class="literal">7</code>. 
Brilliant.

Other times, you’ll want your script to print values out to the console automatically, so you can keep an eye on what’s going on. 
As you’ll see in some examples that follow, you can use <code class="literal">console.log("something");</code> to do that.

Type the following examples into the console to see how it works.


<h3>Variables</h3>
Variables are containers for data. 
A simple variable holds one value:

<code class="kd">var</code> <code class="nx">number</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code>
In that statement, <code class="literal">var</code> indicates you are declaring a new variable, the name of which is <code class="literal">number</code>. 
The equals sign is an

<em>assignment operator</em> because it takes the value on the right (<code class="literal">5</code>) and

<em>assigns</em> it to the variable on the left (<code class="literal">number</code>). 
So when you see something such as:

<code class="nx">defaultColor</code> <code class="o">=</code> <code class="s2">"hot pink"</code><code class="p">;</code>
try to read the equals sign not as “equals” but as “is set to.” So that statement could be stated in plain English as “The variable <code class="literal">defaultColor</code>

<em>is set to</em> hot pink.”

As you’ve just seen, variables can store numeric values as well as strings of text, so called because they are formed by stringing together individual characters of text. 
Strings must be enclosed by quotation marks. 
True or false (Boolean) values can also be stored:

<code class="kd">var</code> <code class="nx">thisMakesSenseSoFar</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
Also note that in JavaScript, statements are concluded with a semicolon.

You can try making some variables yourself in the console. 
For example, type <code class="literal">var amount = 200</code>, then press Enter, then on a new line just enter <code class="literal">amount</code> and press Enter. 
You should see <code class="literal">200</code> returned to you in the console—proof that JavaScript remembered the value you assigned to <code class="literal">amount</code>!

Try It Now!
Enter the following commands into the console below in sequence (hit Enter after each command):

 <code class="literal">var amount = 200</code>  <code class="literal">amount</code>  

<h3>Other Variable Types</h3>
A variable is a datum, the smallest building block of data. 
The variable is the foundation of all other data structures, which are simply different configurations of variables.

Now we’ll address some of these more complex forms of data, including arrays, objects, and arrays of objects. 
You might want to skip this section for now, but reference it later, once you’re ready to load your own data into D3.

<h3>Arrays</h3>
An array is a sequence of values, conveniently stored in a single variable.

Keeping track of related values in separate variables is inefficient:

<code class="kd">var</code> <code class="nx">numberA</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberB</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberC</code> <code class="o">=</code> <code class="mi">15</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberD</code> <code class="o">=</code> <code class="mi">20</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">numberE</code> <code class="o">=</code> <code class="mi">25</code><code class="p">;</code>
Rewritten as an array, those values are much simpler. 
Hard brackets <code class="literal">[]</code> indicate an array, and each value is separated by a comma:

<code class="kd">var</code> <code class="nx">numbers</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>
Arrays are ubiquitous in data visualization, so you will become very comfortable with them. 
You can access (retrieve) a value in an array by using

<em>bracket notation</em>:

<code class="nx">numbers</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code>  <code class="c1">//Returns 15</code>
The numeral in the bracket refers to a corresponding position in the array. 
Remember, array positions begin counting at zero, so the first position is 0, the second position is 1, and so on:

<code class="nx">numbers</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>  <code class="c1">//Returns 5</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>  <code class="c1">//Returns 10</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code>  <code class="c1">//Returns 15</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">3</code><code class="p">]</code>  <code class="c1">//Returns 20</code> <code class="nx">numbers</code><code class="p">[</code><code class="mi">4</code><code class="p">]</code>  <code class="c1">//Returns 25</code>
Some people find it helpful to think of arrays in spatial terms, as though they have rows and columns, like in a spreadsheet:

<table style="width: 50%; border-collapse: collapse;">
<colgroup>
<col class="col_1">
<col class="col_2"> </colgroup>
<thead>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">Position </td>
<td style="border-bottom: 0.5pt solid ; "> Value</td> </tr></thead>
<tbody>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
0
</td>
<td style="border-bottom: 0.5pt solid ; ">
5
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
1
</td>
<td style="border-bottom: 0.5pt solid ; ">
10
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
2
</td>
<td style="border-bottom: 0.5pt solid ; ">
15
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
3
</td>
<td style="border-bottom: 0.5pt solid ; ">
20
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; ">
4
</td>
<td>
25
</td> </tr> </tbody> </table>
Arrays can contain any type of data, not just integers:

<code class="kd">var</code> <code class="nx">percentages</code> <code class="o">=</code> <code class="p">[</code> <code class="mf">0.55</code><code class="p">,</code> <code class="mf">0.32</code><code class="p">,</code> <code class="mf">0.91</code> <code class="p">];</code> <code class="kd">var</code> <code class="nx">names</code> <code class="o">=</code> <code class="p">[</code> <code class="s2">"Ernie"</code><code class="p">,</code> <code class="s2">"Bert"</code><code class="p">,</code> <code class="s2">"Oscar"</code> <code class="p">];</code>  <code class="nx">percentages</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>  <code class="c1">//Returns 0.32</code> <code class="nx">names</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>        <code class="c1">//Returns "Bert"</code>
Although I don’t recommend it, different types of values can even be stored within the same array:

<code class="kd">var</code> <code class="nx">mishmash</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mf">4.5</code><code class="p">,</code> <code class="mf">5.6</code><code class="p">,</code> <code class="s2">"oh boy"</code><code class="p">,</code> <code class="s2">"say it isn't"</code><code class="p">,</code> <code class="kc">true</code> <code class="p">];</code> 

<h3>Objects</h3>
Arrays are great for simple lists of values, but with more complex datasets, you’ll want to put your data into an object. 
For our purposes, think of a JavaScript object as a custom data structure. 
We use curly brackets <code class="literal">{}</code> to indicate an object. 
In between the brackets, we include

<em>properties</em> and

<em>values</em>. 
A colon <code class="literal">:</code> separates each property and its value, and a comma separates each property/value pair:

<code class="kd">var</code> <code class="nx">fruit</code> <code class="o">=</code> <code class="p">{</code>     <code class="nx">kind</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>     <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>     <code class="nx">quantity</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>     <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
To reference each value, we use

<em>dot notation</em>, specifying the name of the property:

<code class="nx">fruit</code><code class="p">.</code><code class="nx">kind</code>      <code class="c1">//Returns "grape"</code> <code class="nx">fruit</code><code class="p">.</code><code class="nx">color</code>     <code class="c1">//Returns "red"</code> <code class="nx">fruit</code><code class="p">.</code><code class="nx">quantity</code>  <code class="c1">//Returns 12</code> <code class="nx">fruit</code><code class="p">.</code><code class="nx">tasty</code>     <code class="c1">//Returns true</code>
Think of the value as “belonging” to the object. 
Oh, look, some fruit. 
“What kind of fruit is that?” you might ask. 
As it turns out, <code class="literal">fruit.kind</code> is <code class="literal">"grape"</code>. 
“Are they tasty?” Oh, definitely, because <code class="literal">fruit.tasty</code> is <code class="literal">true</code>.

<h3>Objects and Arrays</h3>
You can combine these two structures to create arrays of objects, or objects of arrays, or objects of objects or, well, basically whatever structure makes sense for your dataset.

Let’s say we have acquired a couple more pieces of fruit, and we want to expand our catalog accordingly. 
We use hard brackets <code class="literal">[]</code> on the outside, to indicate an array, followed by curly brackets <code class="literal">{}</code> and object notation on the inside, with each object separated by a comma:

<code class="kd">var</code> <code class="nx">fruits</code> <code class="o">=</code> <code class="p">[</code>     <code class="p">{</code>         <code class="nx">kind</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>         <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>         <code class="nx">quantity</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>         <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code>     <code class="p">},</code>     <code class="p">{</code>         <code class="nx">kind</code><code class="o">:</code> <code class="s2">"kiwi"</code><code class="p">,</code>         <code class="nx">color</code><code class="o">:</code> <code class="s2">"brown"</code><code class="p">,</code>         <code class="nx">quantity</code><code class="o">:</code> <code class="mi">98</code><code class="p">,</code>         <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code>     <code class="p">},</code>     <code class="p">{</code>         <code class="nx">kind</code><code class="o">:</code> <code class="s2">"banana"</code><code class="p">,</code>         <code class="nx">color</code><code class="o">:</code> <code class="s2">"yellow"</code><code class="p">,</code>         <code class="nx">quantity</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>         <code class="nx">tasty</code><code class="o">:</code> <code class="kc">true</code>     <code class="p">}</code> <code class="p">];</code>
To access this data, we just follow the trail of properties down to the values we want. 
Remember, <code class="literal">[]</code> means array, and <code class="literal">{}</code> means object. 
<code class="literal">fruits</code> is an array, so first we use bracket notation to specify an array index:

<code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>
Next, each array element is an object, so just tack on a dot and a property:

<code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">quantity</code>   <code class="c1">//Returns 98</code>
Here’s a map of how to access every value in the <code class="literal">fruits</code> array of objects:

<code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">kind</code>      <code class="o">==</code>  <code class="s2">"grape"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">color</code>     <code class="o">==</code>  <code class="s2">"red"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">quantity</code>  <code class="o">==</code>  <code class="mi">12</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">tasty</code>     <code class="o">==</code>  <code class="kc">true</code>  <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">kind</code>      <code class="o">==</code>  <code class="s2">"kiwi"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">color</code>     <code class="o">==</code>  <code class="s2">"brown"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">quantity</code>  <code class="o">==</code>  <code class="mi">98</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">tasty</code>     <code class="o">==</code>  <code class="kc">true</code>  <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">kind</code>      <code class="o">==</code>  <code class="s2">"banana"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">color</code>     <code class="o">==</code>  <code class="s2">"yellow"</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">quantity</code>  <code class="o">==</code>  <code class="mi">0</code> <code class="nx">fruits</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">tasty</code>     <code class="o">==</code>  <code class="kc">true</code>
Yes, that’s right, we have <code class="literal">fruits[2].quantity</code> bananas.

<h4>JSON</h4>
At some point in your D3 career, you will encounter JavaScript Object Notation. 
You can

<a class="ulink" href="http://en.wikipedia.org/wiki/Json" target="_top">read up on the details</a>, but JSON is basically a specific syntax for organizing data as JavaScript objects. 
The syntax is optimized for use with JavaScript (obviously) and AJAX requests, which is why you’ll see a lot of
web-based application programming interfaces (APIs) that return data formatted as JSON. 
It’s faster and easier to parse with JavaScript than XML, and of course D3 works well with it.

All that, and it doesn’t look much weirder than what we’ve already seen:

<code class="p">{</code>     <code class="s2">"kind"</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>     <code class="s2">"color"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>     <code class="s2">"quantity"</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>     <code class="s2">"tasty"</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
The only difference here is that our property names are now surrounded by double quotation marks <code class="literal">""</code>, making them string values.

JSON objects, like all other JavaScript objects, can of course be stored in variables like so:

<code class="kd">var</code> <code class="nx">jsonFruit</code> <code class="o">=</code> <code class="p">{</code>     <code class="s2">"kind"</code><code class="o">:</code> <code class="s2">"grape"</code><code class="p">,</code>     <code class="s2">"color"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>     <code class="s2">"quantity"</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>     <code class="s2">"tasty"</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code> 

<h4>GeoJSON</h4>
Just as JSON is just a formalization of existing JavaScript object syntax,
GeoJSON is a formalized syntax of JSON objects, optimized for storing geodata. 
All GeoJSON object are JSON objects, and all JSON objects are JavaScript objects.

<a class="ulink" href="http://geojson.org/geojson-spec.html" target="_top">GeoJSON</a> can store points in geographical space (typically as longitude/latitude coordinates), but also shapes (such as lines and polygons) and other spatial features. 
If you have a lot of geodata, it’s worth it to parse it into GeoJSON format for best use with D3.

We’ll get into the details of GeoJSON when we talk about geomaps, but for now, just know that this is what simple GeoJSON data could look like the following:

<code class="p">{</code>     <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"FeatureCollection"</code><code class="p">,</code>     <code class="s2">"features"</code><code class="o">:</code> <code class="p">[</code>         <code class="p">{</code>             <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code>             <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code>                 <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Point"</code><code class="p">,</code>                 <code class="s2">"coordinates"</code><code class="o">:</code> <code class="p">[</code> <code class="mf">150.1282427</code><code class="p">,</code> <code class="o">-</code><code class="mf">24.471803</code> <code class="p">]</code>             <code class="p">},</code>             <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code>                 <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"town"</code>             <code class="p">}</code>         <code class="p">}</code>     <code class="p">]</code> <code class="p">}</code>
Confusingly, longitude is always listed before latitude. 
Get used to thinking in terms of lon/lat instead of lat/lon.
  

<h3>Mathematical Operators</h3>
You can add, subtract, multiply, and divide values using the following

 operators,
respectively:

+   //Add -   //Subtract *   //Multiply /   //Divide
For example, type <code class="literal">8 * 2</code> into the console, press Enter, and you should see <code class="literal">16</code>. 
More examples:

<code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code>       <code class="c1">//Returns 3</code> <code class="mi">10</code> <code class="o">-</code> <code class="mf">0.5</code>    <code class="c1">//Retuns 9.5</code> <code class="mi">33</code> <code class="o">*</code> <code class="mi">3</code>      <code class="c1">//Returns 99</code> <code class="mi">3</code> <code class="o">/</code> <code class="mi">4</code>       <code class="c1">//Returns 0.75</code> 

<h3>Comparison Operators</h3>
You can compare values against each other using the following

 operators:

<code class="o">==</code>  <code class="c1">//Equal to</code> <code class="o">!=</code>  <code class="c1">//Not equal to</code> <code class="o">&lt;</code>   <code class="c1">//Less than</code> <code class="o">></code>   <code class="c1">//Greater than</code> <code class="o">&lt;=</code>  <code class="c1">//Less than or equal to</code> <code class="o">>=</code>  <code class="c1">//Greater than or equal to</code>
These all compare some value on the left to some value on the right. 
If the result is true, then <code class="literal">true</code> is returned. 
If the result is false, <code class="literal">false</code> is returned.

Try it! Type each of the following into the console and see what you get:

<code class="mi">3</code> <code class="o">==</code> <code class="mi">3</code> <code class="mi">3</code> <code class="o">==</code> <code class="mi">5</code> <code class="mi">3</code> <code class="o">>=</code> <code class="mi">3</code> <code class="mi">3</code> <code class="o">>=</code> <code class="mi">2</code> <code class="mi">100</code> <code class="o">&lt;</code> <code class="mi">2</code> <code class="mi">298</code> <code class="o">!=</code> <code class="mi">298</code>

Try It Now!
Type the following commands into the console below, and hit Enter to see the results

 <code class="literal">3 == 3</code>  <code class="literal">3 == 5</code>  <code class="literal">3 >= 3</code>  <code class="literal">3 >= 2</code>  <code class="literal">100 &lt; 2</code>  <code class="literal">298 != 298</code>  

(JavaScript also offers the <code class="literal">===</code> and <code class="literal">!==</code> operators, which perform equality comparisons without type coercion, but I won’t be addressing that distinction in this book.)

<h3>Control Structures</h3>
Whenever your code needs to make a decision or repeat something, you need a control structure. 
There are lots to choose from, but we are primarily interested in <code class="literal">if</code> statements and <code class="literal">for</code> loops.

<h4>if() only</h4>
An <code class="literal">if</code> statement uses comparison operators to determine if a statement is true or false:

<code class="k">if</code> <code class="p">(</code><code class="nx">test</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Code to run if true</code> <code class="p">}</code>
If the test between parentheses is <code class="literal">true</code>, then the code between the curly brackets is run. 
If the test turns up <code class="literal">false</code>, then the bracketed code is ignored, and life goes on. 
(Technically, life goes on either way.)

<code class="k">if</code> <code class="p">(</code><code class="mi">3</code> <code class="o">&lt;</code> <code class="mi">5</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Eureka! Three is less than five!"</code><code class="p">);</code> <code class="p">}</code>
In the preceding example, the bracketed code will always be executed, because <code class="literal">3 &lt; 5</code> is always true. 
<code class="literal">if</code> statements are more useful when comparing variables or other conditions that change.

<code class="k">if</code> <code class="p">(</code><code class="nx">someValue</code> <code class="o">&lt;</code> <code class="nx">anotherValue</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Set someValue to anotherValue, thereby restoring</code>     <code class="c1">//a sense of balance and equilibrium to the world.</code>     <code class="nx">someValue</code> <code class="o">=</code> <code class="nx">anotherValue</code><code class="p">;</code> <code class="p">}</code> 

<h4>for() now</h4>
You can use <code class="literal">for</code> loops to repeatedly execute the same code, with slight

 variations. 
A <code class="literal">for</code> loop uses this syntax:

<code class="k">for</code> <code class="p">(</code><code class="nx">initialization</code><code class="p">;</code> <code class="nx">test</code><code class="p">;</code> <code class="nx">update</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Code to run each time through the loop</code> <code class="p">}</code>
They are so-called because they loop through the code

<em>for</em> as many times as specified. 
First, the initialization statement is run. 
Then, the test is evaluated, like a mini <code class="literal">if</code> statement. 
If the test is true, then the bracketed code is run. 
Finally, the <code class="literal">update</code> statement is run, and the test is reevaluated.

The most common application of a <code class="literal">for</code> loop is to increase some variable by 1 each time through the loop. 
The test statement can then control how many times the loop is run by referencing that value. 
(The variable is often named <code class="literal">i</code>, purely by convention, because it is short and easy to type.)

<code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">5</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>  <code class="c1">//Prints value to console</code> <code class="p">}</code>
The preceding <code class="literal">for</code> loop prints the following to the console:

0 1 2 3 4
The first time through, a variable named <code class="literal">i</code> is declared and set to zero. 
<code class="literal">i</code> is less than five, so the bracketed code is run, printing the current value of <code class="literal">i</code> (zero) to the console. 
Finally, the value of <code class="literal">i</code> is increased by one. 
(<code class="literal">i++</code> is shorthand for <code class="literal">i = i + 1</code>.) So now <code class="literal">i</code> is <code class="literal">1</code>, so the test again evaluates as true, the bracketed code is run again, but this time the value printed to the console is 1.

As you can see, reading prose descriptions of loops is about as interesting as executing them by hand yourself. 
This is why we invented computers. 
So I’ll skip to the end and point out that after the final iteration, <code class="literal">i</code> is increased to 5, after which the test returns false, and the loop is over.

It’s important to note that counting began at zero, and not one. 
That is, the “first” value of <code class="literal">i</code> was <code class="literal">0</code>. 
Why not <code class="literal">1</code>? This is another arbitrary convention, but it nicely parallels how computers count arrays of values.

<h4>What arrays are made for()</h4>
Code-based data visualization would not be possible without arrays and the mighty <code class="literal">for()</code> loop. 
Together, they form a data geek’s dynamic duo. 
(If you do not consider yourself a “data geek,” then may I remind you that you are reading a book titled

<em>Interactive Data Visualization for the Web</em>?)

An array organizes lots of data values in one convenient place. 
Then <code class="literal">for()</code> can quickly “loop” through every value in an array and perform some action with it—such as, express the value as a visual form. 
D3 often manages this looping for us, such as with its magical <code class="literal">data()</code> method.

Note this example, which loops through each of the values in an array called <code class="literal">numbers</code>:

<code class="kd">var</code> <code class="nx">numbers</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">100</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">98</code><code class="p">,</code> <code class="mi">99</code><code class="p">,</code> <code class="mi">45</code> <code class="p">];</code>  <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numbers</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">numbers</code><code class="p">[</code><code class="nx">i</code><code class="p">]);</code>  <code class="c1">//Print value to console</code> <code class="p">}</code>
See that <code class="literal">numbers.length</code>? That’s the beautiful part. 
<code class="literal">length</code> is a property of every array. 
In this case, <code class="literal">numbers</code> contains six values, so <code class="literal">numbers.length</code> resolves to <code class="literal">6</code>, and the loop runs six times. 
If <code class="literal">numbers</code> were 10 positions long, the loop would run 10 times. 
If it were 10 million positions long … yeah, you get it. 
This is what computers are good at: taking a set of instructions and executing them over and over. 
And this is at the heart of why data visualization can be so rewarding—you design and code the visualization system, and the system will respond appropriately, even as you feed it different data. 
The system’s mapping rules are consistent, even when the data is not.
  

<h3>Functions</h3>
Functions are chunks of code that do things.

More specifically, functions are special because they can take arguments or parameters as input, and then return values as output. 
Parentheses are used to

<em>call</em> (execute) a function. 
If that function requires any arguments (input values), then they are

<em>passed</em> to the function by including them in the parentheses.

Whenever you see something like the following code, you know it’s a function:

<code class="nx">calculateGratuity</code><code class="p">(</code><code class="mi">38</code><code class="p">);</code>
In fact, you’ve already seen functions at work with <code class="literal">console.log</code>, as in the following:

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Look at me. 
I can do stuff!"</code><code class="p">);</code>
But the best part about functions is that you can define your own. 
There are several ways to define functions in JavaScript, but here’s the simplest, which I’ll use throughout this book:

<code class="kd">var</code> <code class="nx">calculateGratuity</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">bill</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">bill</code> <code class="o">*</code> <code class="mf">0.2</code><code class="p">;</code> <code class="p">};</code>
This declares a new variable named <code class="literal">calculateGratuity</code>. 
Then, instead of assigning a simple number or string, we store an entire function in the variable. 
In the parentheses, we name <code class="literal">bill</code>, another variable to be used only by the function itself. 
<code class="literal">bill</code> is the expected input. 
When called, the function will take that input, multiply it by <code class="literal">0.2</code>, and

<em>return</em> the result as its output.

So now if we call:

<code class="nx">calculateGratuity</code><code class="p">(</code><code class="mi">38</code><code class="p">);</code>
the function returns 7.6. 
Not bad—a 20 percent tip!

Of course, you could store the output to use it elsewhere later, as in:

<code class="kd">var</code> <code class="nx">tip</code> <code class="o">=</code> <code class="nx">calculateGratuity</code><code class="p">(</code><code class="mi">38</code><code class="p">);</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tip</code><code class="p">);</code>  <code class="c1">//Prints 7.6 to the console</code>
There are also

<em>anonymous</em> functions that, unlike <code class="literal">calculateGratuity</code>, don’t have names. 
Anonymous functions are used all the time with D3, but I’ll introduce them later.


<h3>Comments</h3>
<code class="cm">/* JavaScript supports CSS-style comments like this. 
*/</code>  <code class="c1">// But double-slashes can be used as well.</code> <code class="c1">// Anything following // on the same line will be ignored.</code> <code class="c1">// This is helpful for including brief notes to yourself</code> <code class="c1">// as to what each line of code does, as in:</code>  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Brilliant"</code><code class="p">);</code>  <code class="c1">//Prints "Brilliant" to the console</code> 

<h3>Referencing Scripts</h3>
Scripts can be included directly in HTML, between two <code class="literal">script</code> tags, as

in:

<code class="nt">&lt;body></code>     <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">></code>         <code class="nx">alert</code><code class="p">(</code><code class="s2">"Hello, world!"</code><code class="p">);</code>     <code class="nt">&lt;/script></code> <code class="nt">&lt;/body></code>
or stored in a separate file with a

<em>.js</em> suffix, and then referenced somewhere in the HTML (could be in the <code class="literal">head</code>, as shown here, or also just before the end of the closing <code class="literal">body</code> tag):

<code class="nt">&lt;head></code>     <code class="nt">&lt;title></code>Page Title<code class="nt">&lt;/title></code>     <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code> <code class="na">src=</code><code class="s">"myscript.js"</code><code class="nt">>&lt;/script></code> <code class="nt">&lt;/head></code> 

<h3>JavaScript Gotchas</h3>
As a bonus, and at no extra charge, I would like to share with you my top four JavaScript gotchas: things that, had I known earlier, would have saved me many hours of late-night debugging sessions, anxiety-induced panic, and increased cortisol levels. 
You might want to come back and reference this section later.

<h4>Dynamic typing</h4>
I do love how your fingers flutter across the keyboard, but that’s not what I’m talking about. 
No, JavaScript is a

<em>loosely typed</em> language, meaning you don’t have to specify what

<em>type</em> of information will be stored in a variable in advance. 
Many other languages, like Java (which is completely different from Java

<em>Script</em>), require you to declare a variable’s type, such as <code class="literal">int</code>, <code class="literal">float</code>, <code class="literal">boolean</code>, or <code class="literal">String</code>:

<code class="c1">//Declaring variables in Java</code> <code class="kt">int</code> <code class="n">number</code> <code class="o">=</code> <code class="mi">5</code><code class="o">;</code> <code class="kt">float</code> <code class="n">value</code> <code class="o">=</code> <code class="mf">12.3467</code><code class="o">;</code> <code class="kt">boolean</code> <code class="n">active</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code> <code class="n">String</code> <code class="n">text</code> <code class="o">=</code> <code class="s">"Crystal clear"</code><code class="o">;</code>
JavaScript, however, automatically

<em>types</em> a variable based on what kind of information you assign to it. 
(Note that <code class="literal">''</code> or <code class="literal">""</code> indicate string values. 
I prefer double quotation marks <code class="literal">""</code>, but some people like singles <code class="literal">''</code>.)

<code class="c1">//Declaring variables in JavaScript</code> <code class="kd">var</code> <code class="nx">number</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">value</code> <code class="o">=</code> <code class="mf">12.3467</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">active</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">text</code> <code class="o">=</code> <code class="s2">"Crystal clear"</code><code class="p">;</code>
How boring—<code class="literal">var</code>, <code class="literal">var</code>, <code class="literal">var</code>, <code class="literal">var</code>!—yet handy, as we can declare and name variables before we even know what type of data will go into them. 
You can even change a variable’s type on-the-fly without JavaScript freaking out on you:

<code class="kd">var</code> <code class="nx">value</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="mf">99.9999</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="s2">"This can't possibly work."</code><code class="p">;</code> <code class="nx">value</code> <code class="o">=</code> <code class="s2">"Argh, it does work! No errorzzzz!"</code><code class="p">;</code>
I mention this because one day a numeric value will be accidentally stored as a string, and it will cause some part of your code to behave strangely, and basically I don’t want you to come crying to me when that happens. 
Thus, know that whenever a variable’s type is in doubt, you can

 employ the <code class="literal">typeof</code> operator:

<code class="k">typeof</code> <code class="mi">67</code><code class="p">;</code>              <code class="c1">//Returns "number"</code> <code class="kd">var</code> <code class="nx">myName</code> <code class="o">=</code> <code class="s2">"Scott"</code><code class="p">;</code> <code class="k">typeof</code> <code class="nx">myName</code><code class="p">;</code>          <code class="c1">//Returns "string"</code> <code class="nx">myName</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code> <code class="k">typeof</code> <code class="nx">myName</code><code class="p">;</code>          <code class="c1">//Returns "boolean"</code> 

<h4>Variable hoisting</h4>
Contrary to what you would expect, JavaScript code is usually, but not always, executed in linear, top-to-bottom order. 
For example, in this code, when would you expect the variable <code class="literal">i</code> to be established?

<code class="kd">var</code> <code class="nx">numLoops</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numLoops</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code> <code class="p">}</code>
In many other languages, <code class="literal">i</code> would be declared right when the <code class="literal">for</code> loop begins, as you’d expect. 
But thanks to a phenomenon known as

<em>variable hoisting</em>, in JavaScript, variable declarations are

<em>hoisted</em> up to the top of the function context in which they reside. 
So in our example, <code class="literal">i</code> is actually declared

<em>before</em> the <code class="literal">for</code> loop even begins. 
The following is equivalent:

<code class="kd">var</code> <code class="nx">numLoops</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">i</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numLoops</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code> <code class="p">}</code>
This can be problematic when you have conflicting variable names, as a variable that you thought existed only later in the code is actually present right at the beginning.

<h4>Function-level scope</h4>
In programming, the concept of

<em>variable scope</em> helps us identify which variables are accessible in which contexts. 
Generally, it is a bad idea to have every value accessible from everywhere else because you’d end up with so many conflicts and accidental value changes that you would just go crazy.

Many languages use

<em>block-level scope</em>, in which variables exist only within the current “block” of code, usually indicated by curly braces. 
With block-level scope, our <code class="literal">i</code> would exist only within the context of the <code class="literal">for</code> loop, for example, so any attempts to read the value of <code class="literal">i</code> or change <code class="literal">i</code> outside of the loop would fail. 
This is nice because you could establish other variables from within your loop and know that they wouldn’t conflict with variables that exist elsewhere.

In JavaScript, however, variables are scoped at the function level, meaning they are accessible anywhere within the

<em>function</em> (not block) in which they reside.

This is primarily something to be aware of if you’re used to other languages. 
Bottom line: You can keep values contained by wrapping them within functions.

<h4>Global namespace</h4>
Speaking of variable conflicts, please do me a favor: open any web page, activate the JavaScript console, type

<strong><code class="literal">window</code></strong>, and click the gray disclosure triangle to view its
contents.

I know it feels like you just entered the matrix, but this is actually called “the global namespace,” which might sound even cooler (see

<a class="xref" href="#The_global_namespace" title="Figure 3-10. The global namespace">Figure 3-10</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0310.png" alt="The global namespace">
Figure 3-10. The global namespace 
<code class="literal">window</code> is the topmost object in the browser’s hierarchy of JavaScript elements, and all of these objects and values you see beneath <code class="literal">window</code> exist at the

<em>global</em> level. 
What this means is that every time you declare a new variable, you are adding a new value to <code class="literal">window</code>. 
Or, as righteous JavaScript coders like to say, you are polluting the global
namespace. 
(Surprisingly, most people who write things like this in online forums are actually quite friendly in person.)

For example, try typing this into the console:

<strong><code class="literal">var zebras = "amazing"</code></strong>.

Then type

<strong><code class="literal">window</code></strong> again, and scroll all the way down to the bottom, where you should now see <code class="literal">zebras</code>, as shown in

<a class="xref" href="#The_global_namespace_now_with_zebras" title="Figure 3-11. The global namespace, now with zebras">Figure 3-11</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0311.png" alt="The global namespace, now with zebras">
Figure 3-11. The global namespace, now with zebras 
(Confusingly, it is also possible to define new variables in JavaScript without using the standard <code class="literal">var</code> declaration, so typing simply

<strong><code class="literal">zebras = "amazing"</code></strong> would have the same effect as that shown.)

What’s so wrong with adding values to <code class="literal">window</code>? As you get started, nothing at all. 
But as your projects grow in complexity, and especially if you begin to incorporate other non-D3 JavaScript code (such as jQuery, Facebook “Like” buttons, or Google Analytics tracking code), at some point you’re bound to run into a conflict because you’re using the variable <code class="literal">zebras</code> for your project, but zebraTracker.js is

<em>also</em> using a variable with the same name! The result: chaos. 
Or at least some bad data, which could lead to unexpected behavior or errors.

There are two easy workarounds (and, to clarify, you probably don’t have to worry about this until later):

 Declare variables only within other functions. 
This is not usually feasible, but the function-level scope will prevent local variables from conflicting with others. 
 Declare a single global object, and attach all of your would-be global variables to that object. 
For example:  
<code class="kd">var</code> <code class="nx">Vis</code> <code class="o">=</code> <code class="p">{};</code>  <code class="c1">//Declare empty global object</code> <code class="nx">Vis</code><code class="p">.</code><code class="nx">zebras</code> <code class="o">=</code> <code class="s2">"still pretty amazing"</code><code class="p">;</code> <code class="nx">Vis</code><code class="p">.</code><code class="nx">monkeys</code> <code class="o">=</code> <code class="s2">"too funny LOL"</code><code class="p">;</code> <code class="nx">Vis</code><code class="p">.</code><code class="nx">fish</code> <code class="o">=</code> <code class="s2">"you know, not bad"</code><code class="p">;</code>
All of your weird animal-related variables are no longer polluting the global namespace, but instead they all exist as values stored within your single, global object, <code class="literal">Vis</code>. 
Of course, <code class="literal">Vis</code> could be named whatever you like, but <code class="literal">Menagerie</code> is harder to type. 
Regardless, the only naming conflict you’ll have with other scripts is if one of them

<em>also</em> wants to have a global object with the same name (<code class="literal">Vis</code>), which is far less likely.

   

<h2>SVG</h2>
D3 is most useful when used to generate and manipulate visuals as Scalable Vector Graphics (SVG). 
Drawing with <code class="literal">div</code>s and other native HTML elements is possible, but a bit clunky and subject to the usual inconsistencies across different browsers. 
Using SVG is more reliable, visually consistent, and faster.

<a class="xref" href="#A_small_SVG_circle" title="Figure 3-12. A small SVG circle">Figure 3-12</a> shows a small circle, and its SVG code follows.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0312.png" alt="A small SVG circle">
Figure 3-12. A small SVG circle 
<code class="nt">&lt;svg</code> <code class="na">width=</code><code class="s">"50"</code> <code class="na">height=</code><code class="s">"50"</code><code class="nt">></code>     <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"22"</code> <code class="na">fill=</code><code class="s">"blue"</code> <code class="na">stroke=</code><code class="s">"gray"</code> <code class="na">stroke-width=</code><code class="s">"2"</code><code class="nt">/></code> <code class="nt">&lt;/svg></code>
Vector drawing software like Illustrator can be used to generate SVG files, but we need to learn how to generate them with code.

<h3>The SVG Element</h3>
SVG is a text-based image format. 
Each SVG image is defined using markup code similar to HTML, and SVG code can be included directly within any HTML document, or inserted dynamically into the DOM. 
Every web browser supports SVG

<em>except</em>

<a class="ulink" href="http://caniuse.com/#feat=svg" target="_top">Internet Explorer versions 8 and earlier</a>. 
SVG is XML-based, so you’ll notice that elements

 that don’t have a closing tag must be self-closing. 
For example:

<code class="nt">&lt;element>&lt;/element></code> <code class="c">&lt;!-- Uses closing tag --></code> <code class="nt">&lt;element/></code>          <code class="c">&lt;!-- Self-closing tag --></code>
Before you can draw anything, you must create an SVG element. 
Think of the SVG element as a canvas on which your visuals are rendered. 
(In that respect, SVG is conceptually similar to HTML’s <code class="literal">canvas</code> element.) At a minimum, it’s good to specify <code class="literal">width</code> and <code class="literal">height</code> values. 
If you don’t specify these, the SVG will behave like a typically greedy, block-level HTML element and take up as much room as it can within its enclosing element:

<code class="nt">&lt;svg</code> <code class="na">width=</code><code class="s">"500"</code> <code class="na">height=</code><code class="s">"50"</code><code class="nt">></code> <code class="nt">&lt;/svg></code>
Note that

<em>pixels</em> are the default measurement units, so we can specify dimensions of <code class="literal">500</code> and <code class="literal">50</code>, not <code class="literal">500px</code> and <code class="literal">50px</code>. 
We could have specified <code class="literal">px</code> explicitly, or any number of other supported units, including <code class="literal">em</code>, <code class="literal">pt</code>, <code class="literal">in</code>, <code class="literal">cm</code>, and <code class="literal">mm</code>.

<h3>Simple Shapes</h3>
There are a number of visual elements that you can include between those <code class="literal">svg</code> tags, including <code class="literal">rect</code>, <code class="literal">circle</code>, <code class="literal">ellipse</code>, <code class="literal">line</code>, <code class="literal">text</code>, and <code class="literal">path</code>. 
(Sorry, <code class="literal">zebras</code> is not valid in this context.)

If you’re familiar with computer graphics programming, you’ll recognize the usual pixel-based coordinates system in which <code class="literal">0,0</code> is the top-left corner of the drawing space. 
Increasing <code class="literal">x</code> values move to the right,

 while increasing <code class="literal">y</code> values move down (see

<a class="xref" href="#The_SVG_coordinates_system" title="Figure 3-13. The SVG coordinates system">Figure 3-13</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0313.png" alt="The SVG coordinates system">
Figure 3-13. The SVG coordinates system 
<code class="literal">rect</code> draws a rectangle. 
Use <code class="literal">x</code> and <code class="literal">y</code> to specify the coordinates of the upper-left corner, and <code class="literal">width</code> and <code class="literal">height</code> to specify the dimensions. 
This rectangle fills the entire space of our SVG, as shown in

<a class="xref" href="#An_SVG_rect" title="Figure 3-14. An SVG rect">Figure 3-14</a>:

<code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"0"</code> <code class="na">y=</code><code class="s">"0"</code> <code class="na">width=</code><code class="s">"500"</code> <code class="na">height=</code><code class="s">"50"</code><code class="nt">/></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0314.png" alt="An SVG rect">
Figure 3-14. An SVG rect 
<code class="literal">circle</code> draws a circle. 
Use <code class="literal">cx</code> and <code class="literal">cy</code> to specify the coordinates of the

<em>center</em>, and <code class="literal">r</code> to specify the radius. 
This circle is centered in the middle of our 500-pixel-wide SVG because its <code class="literal">cx</code> (“center-x”) value is 250 (see

<a class="xref" href="#An_SVG_circle" title="Figure 3-15. An SVG circle">Figure 3-15</a>):

<code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"250"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"25"</code><code class="nt">/></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0315.png" alt="An SVG circle">
Figure 3-15. An SVG circle 
<code class="literal">ellipse</code> is similar, but expects separate radius values for each axis. 
Instead of <code class="literal">r</code>, use <code class="literal">rx</code> and <code class="literal">ry</code> to obtain the result shown in

<a class="xref" href="#An_SVG_ellipse" title="Figure 3-16. An SVG ellipse">Figure 3-16</a>:

<code class="nt">&lt;ellipse</code> <code class="na">cx=</code><code class="s">"250"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">rx=</code><code class="s">"100"</code> <code class="na">ry=</code><code class="s">"25"</code><code class="nt">/></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0316.png" alt="An SVG ellipse">
Figure 3-16. An SVG ellipse 
<code class="literal">line</code> draws a line, as shown in

<a class="xref" href="#An_SVG_line" title="Figure 3-17. An SVG line">Figure 3-17</a>. 
Use <code class="literal">x1</code> and <code class="literal">y1</code> to specify the coordinates of one end of the line, and <code class="literal">x2</code> and <code class="literal">y2</code> to specify the coordinates of the other end. 
A <code class="literal">stroke</code> color must be specified for the line to be visible:

<code class="nt">&lt;line</code> <code class="na">x1=</code><code class="s">"0"</code> <code class="na">y1=</code><code class="s">"0"</code> <code class="na">x2=</code><code class="s">"500"</code> <code class="na">y2=</code><code class="s">"50"</code> <code class="na">stroke=</code><code class="s">"black"</code><code class="nt">/></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0317.png" alt="An SVG line">
Figure 3-17. An SVG line 
<code class="literal">text</code> renders text. 
Use <code class="literal">x</code> to specify the position of the left edge, and <code class="literal">y</code> to specify the vertical position of the type’s

<em>baseline</em>. 
(Baseline is a typographical term for the invisible line on which the letters appear to rest. 
Portions of letters such as “p” and “y” that extend below the baseline are called descenders.) The result of the following code is displayed in

<a class="xref" href="#SVG_text" title="Figure 3-18. SVG text">Figure 3-18</a>:

<code class="nt">&lt;text</code> <code class="na">x=</code><code class="s">"250"</code> <code class="na">y=</code><code class="s">"25"</code><code class="nt">></code>Easy-peasy<code class="nt">&lt;/text></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0318.png" alt="SVG text">
Figure 3-18. SVG text 
<code class="literal">text</code> will inherit the CSS-specified font styles of its parent element unless specified otherwise. 
(More on styling text in a moment.) We could override that formatting as follows and obtain the result shown in

<a class="xref" href="#More_SVG_text" title="Figure 3-19. More SVG text">Figure 3-19</a>:

<code class="nt">&lt;text</code> <code class="na">x=</code><code class="s">"250"</code> <code class="na">y=</code><code class="s">"25"</code> <code class="na">font-family=</code><code class="s">"serif"</code> <code class="na">font-size=</code><code class="s">"25"</code>  <code class="na">fill=</code><code class="s">"gray"</code><code class="nt">></code>Easy-peasy<code class="nt">&lt;/text></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0319.png" alt="More SVG text">
Figure 3-19. More SVG text 
Also note that when any visual element runs up against the edge of the SVG, it will be clipped. 
Be careful when using <code class="literal">text</code> so your descenders don’t get cut off (ouch!). 
You can see this happen in

<a class="xref" href="#Even_More_SVG_text" title="Figure 3-20. More SVG text">Figure 3-20</a> when we set the baseline (<code class="literal">y</code>) to 50, the same as the height of our SVG:

<code class="nt">&lt;text</code> <code class="na">x=</code><code class="s">"250"</code> <code class="na">y=</code><code class="s">"50"</code> <code class="na">font-family=</code><code class="s">"serif"</code> <code class="na">font-size=</code><code class="s">"25"</code>  <code class="na">fill=</code><code class="s">"gray"</code><code class="nt">></code>Easy-peasy<code class="nt">&lt;/text></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0320.png" alt="More SVG text">
Figure 3-20. More SVG text 
<code class="literal">path</code> is for drawing anything more complex than the preceding shapes (like country outlines for geomaps), and will be explained separately. 
For now, we’ll work with simple shapes.

<h3>Styling SVG Elements</h3>
SVG’s default style is a black fill with no stroke. 
If you want anything else, you’ll have to apply styles to your elements. 
Common SVG

 properties are as follows:

<dl class="variablelist">
<dt>
 <code class="literal">fill</code> </dt>
<dd> A color value. 
Just as with CSS, colors can be specified as named colors, hex values, or RGB or RGBA values. 
</dd>
<dt>
 <code class="literal">stroke</code> </dt>
<dd> A color value. 
</dd>
<dt>
 <code class="literal">stroke-width</code> </dt>
<dd> A numeric measurement (typically in pixels). 
</dd>
<dt>
 <code class="literal">opacity</code> </dt>
<dd> A numeric value between 0.0 (completely transparent) and 1.0 (completely
opaque). 
</dd> </dl>
With <code class="literal">text</code>, you can also use these properties, which work just like in CSS:

 <code class="literal">font-family</code>  <code class="literal">font-size</code>  
In another parallel to CSS, there are two ways to apply styles to an SVG element: either directly (inline) as an attribute of the element, or with a CSS style rule.

Here are some style properties applied directly to a <code class="literal">circle</code> as attributes, with the result shown in

<a class="xref" href="#An_SVG_circle2" title="Figure 3-21. An SVG circle">Figure 3-21</a>:

<code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"22"</code>  <code class="na">fill=</code><code class="s">"yellow"</code> <code class="na">stroke=</code><code class="s">"orange"</code> <code class="na">stroke-width=</code><code class="s">"5"</code><code class="nt">/></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0321.png" alt="An SVG circle">
Figure 3-21. An SVG circle 
Alternatively, we could strip the style attributes and assign the <code class="literal">circle</code> a class (just as if it were a normal HTML element):

<code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"22"</code> <code class="na">class=</code><code class="s">"pumpkin"</code><code class="nt">/></code>
and then put the <code class="literal">fill</code>, <code class="literal">stroke</code>, and <code class="literal">stroke-width</code> rules into a CSS style that targets the new class:

<code class="nc">.pumpkin</code> <code class="p">{</code>     <code class="n">fill</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code>     <code class="n">stroke</code><code class="o">:</code> <code class="nb">orange</code><code class="p">;</code>     <code class="n">stroke</code><code class="o">-</code><code class="n">width</code><code class="o">:</code> <code class="m">5</code><code class="p">;</code>  <code class="p">}</code>
The CSS approach has a few obvious benefits:

 You can specify a style once and have it applied to multiple elements. 
 CSS code is easier to read than inline attributes. 
 For those reasons, the CSS approach might be more maintainable and make design changes faster to implement. 
 
Using CSS to apply SVG styles, however, can be disconcerting for some. 
<code class="literal">fill</code>, <code class="literal">stroke</code>, and <code class="literal">stroke-width</code>, after all, are

<em>not</em> CSS properties. 
(The nearest CSS equivalents are <code class="literal">background-color</code> and <code class="literal">border</code>.) It’s just that we are using CSS selectors to apply SVG-specific properties. 
If it helps you remember which rules in your stylesheet are SVG-specific, consider including <code class="literal">svg</code> in those selectors:

<code class="nt">svg</code> <code class="nt">.pumpkin</code> <code class="p">{</code>     <code class="c">/* ... 
*/</code>  <code class="p">}</code> 

<h3>Layering and Drawing Order</h3>
There are no “layers” in SVG and no real concept of depth. 
SVG does not support CSS’s <code class="literal">z-index</code> property, so shapes can be arranged only within the two-dimensional x/y plane.

And yet, if we draw multiple shapes, they overlap:

<code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"0"</code> <code class="na">y=</code><code class="s">"0"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"purple"</code><code class="nt">/></code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"20"</code> <code class="na">y=</code><code class="s">"5"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"blue"</code><code class="nt">/></code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"40"</code> <code class="na">y=</code><code class="s">"10"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"green"</code><code class="nt">/></code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"60"</code> <code class="na">y=</code><code class="s">"15"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"yellow"</code><code class="nt">/></code> <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"80"</code> <code class="na">y=</code><code class="s">"20"</code> <code class="na">width=</code><code class="s">"30"</code> <code class="na">height=</code><code class="s">"30"</code> <code class="na">fill=</code><code class="s">"red"</code><code class="nt">/></code>
The order in which elements are coded determines their depth order. 
In

<a class="xref" href="#Overlapping_SVG_elements" title="Figure 3-22. Overlapping SVG elements">Figure 3-22</a>, the purple square appears first in the code, so it is rendered first. 
Then, the blue square is rendered “on top” of the purple one, then the green square on top of that, and so on.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0322.png" alt="Overlapping SVG elements">
Figure 3-22. Overlapping SVG elements 
Think of SVG shapes as being rendered like paint on a canvas. 
The pixel-paint that is applied later obscures any earlier paint, and thus appears to be “in front.”

Exercise
Modify the SVG markup in the left panel to reverse how the squares are stacked (i.e, purple on top of blue, blue on top of green, and so on), and check your results in the output at right:

This aspect of drawing order becomes important when you have some visual elements that should not be obscured by others. 
For example, you might have axes or value labels that appear on a scatterplot. 
The axes and labels should be added to the SVG last, so they appear in front of any other elements.


<h3>Transparency</h3>
Transparency can be useful when elements in your visualization overlap but must remain visible, or you want to deemphasize some elements while highlighting others, as shown in

<a class="xref" href="#RGBA_SVG_shapes" title="Figure 3-23. RGBA SVG shapes">Figure 3-23</a>.

There are two ways to apply transparency: use an RGB color with alpha, or set an <code class="literal">opacity</code> value.

You can use <code class="literal">rgba()</code> anywhere you specify a color, such as with <code class="literal">fill</code> or <code class="literal">stroke</code>. 
<code class="literal">rgba()</code> expects three values between 0 and 255 for red, green, and blue, plus an alpha (transparency) value between 0.0 and 1.0:

<code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 1.0)"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"50"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(0, 0, 255, 0.75)"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"75"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(0, 255, 0, 0.5)"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"100"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(255, 255, 0, 0.25)"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"125"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(255, 0, 0, 0.1)"</code><code class="nt">/></code>

<img style="width: 189; " src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0323.png" alt="RGBA SVG shapes">
Figure 3-23. RGBA SVG shapes 
Note that with <code class="literal">rgba()</code>, transparency is applied to the <code class="literal">fill</code> and <code class="literal">stroke</code> colors independently. 
The following circles’ <code class="literal">fill</code> is 75 percent opaque, and their <code class="literal">stroke</code>s are only 25 percent opaque:

<code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"75"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(0, 255, 0, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 0, 255, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"125"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(255, 255, 0, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(255, 0, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/></code>
With this transparency applied, and the result shown in

<a class="xref" href="#More_RGBA_SVG_shapes" title="Figure 3-24. More RGBA SVG shapes">Figure 3-24</a>, we can see that strokes are aligned to the center of each shape’s edge. 
 That is, the stroke is neither fully inside nor outside the object, but is both half in and half out. 
 As a result of this transparency, these individual <code class="literal">10px</code> strokes look more like two separate <code class="literal">5px</code> strokes.

<img style="width: 189; " src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0324.png" alt="More RGBA SVG shapes">
Figure 3-24. More RGBA SVG shapes 
To apply transparency to an entire element, set an <code class="literal">opacity</code> attribute.

<a class="xref" href="#Opaque_circles" title="Figure 3-25. Opaque circles">Figure 3-25</a> illustrates some completely opaque circles.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0325.png" alt="Opaque circles">
Figure 3-25. Opaque circles 

<a class="xref" href="#Semiopaque_circles" title="Figure 3-26. Semiopaque circles">Figure 3-26</a> shows the same circles, with <code class="literal">opacity</code> values:

<code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"purple"</code> <code class="na">stroke=</code><code class="s">"green"</code> <code class="na">stroke-width=</code><code class="s">"10"</code>         <code class="na">opacity=</code><code class="s">"0.9"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"65"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"green"</code> <code class="na">stroke=</code><code class="s">"blue"</code> <code class="na">stroke-width=</code><code class="s">"10"</code>         <code class="na">opacity=</code><code class="s">"0.5"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"105"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"yellow"</code> <code class="na">stroke=</code><code class="s">"red"</code> <code class="na">stroke-width=</code><code class="s">"10"</code>         <code class="na">opacity=</code><code class="s">"0.1"</code><code class="nt">/></code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0326.png" alt="Semiopaque circles">
Figure 3-26. Semiopaque circles 
You can employ <code class="literal">opacity</code> on an element that also has colors set with <code class="literal">rgba()</code>. 
When doing so, the transparencies are multiplied. 
The circles in

<a class="xref" href="#More_opaque_circles" title="Figure 3-27. More opaque circles">Figure 3-27</a> use the same RGBA values for <code class="literal">fill</code> and <code class="literal">stroke</code>. 
The first circle has no element <code class="literal">opacity</code> set, but the other two do:

<code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"25"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"65"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code> <code class="na">opacity=</code><code class="s">"0.5"</code><code class="nt">/></code> <code class="nt">&lt;circle</code> <code class="na">cx=</code><code class="s">"105"</code> <code class="na">cy=</code><code class="s">"25"</code> <code class="na">r=</code><code class="s">"20"</code> <code class="na">fill=</code><code class="s">"rgba(128, 0, 128, 0.75)"</code>         <code class="na">stroke=</code><code class="s">"rgba(0, 255, 0, 0.25)"</code> <code class="na">stroke-width=</code><code class="s">"10"</code> <code class="na">opacity=</code><code class="s">"0.2"</code><code class="nt">/></code>

<img style="width: 189; " src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0327.png" alt="More opaque circles">
Figure 3-27. More opaque circles 
Notice how the third circle’s <code class="literal">opacity</code> is <code class="literal">0.2</code>, or 20 percent. 
Yet its purple fill already has an alpha value of <code class="literal">0.75</code>, or 75 percent. 
The purple area, then, has a final transparency of 0.2 times 0.75 = 0.15, or 15 percent.

  

<h2>A Note on Compatibility</h2>
Older browsers don’t support SVG. 
 So, generally speaking, Internet Explorer version 8 and older will not display SVG images at all. 
 This is a little annoying because people could visit your page only to see emptiness in place of a gorgeous visualization. 
 On the other hand, D3 also does not work with older browsers (again, meaning IE8 and older), so it never would have worked in the first place.

D3

<em>can</em> be made to work with IE8 by employing the

<a class="ulink" href="https://github.com/shawnbot/aight" target="_top">Aight</a> compatibility library, but that doesn’t help with older versions of IE. 

<a class="ulink" href="https://github.com/mhemesath/r2d3/" target="_top">r2d3</a> is an adaptation of D3 that integrates

<a class="ulink" href="http://raphaeljs.com" target="_top">Raphaël</a> for drawing visuals, which should get you as far back as IE7.

In general, your best bet is to encourage people to upgrade and use a web browser that has been built in the last few years. 
 The more people move to modern browsers, the better their web experiences will be, and the larger our potential audiences.

That said, it’s polite to notify users of older browsers why the piece isn’t working. 
 I recommend using

<a class="ulink" href="http://modernizr.com" target="_top">Modernizr</a> or a similar JavaScript tool to detect whether or not the browser supports SVG. 
 If it does, then you can load your D3 code and proceed as normal. 
 If SVG is

<em>not</em> supported, then you can display a static, noninteractive version of your visualization alongside a message explaining that a current browser is needed. 
 (Be nice and provide links to the

<a class="ulink" href="http://www.google.com/chrome" target="_top">Chrome</a> and

<a class="ulink" href="http://www.mozilla.org/en-US/firefox/new/" target="_top">Firefox</a> download pages. 
 I used to link to

<a class="ulink" href="http://www.apple.com/safari/" target="_top">Safari</a> as well, but Apple now distributes it as part of the Mac OS, so it’s no longer available as a separate download.)

For example, you can use <code class="literal">Modernizr.load()</code> to check the results of Modernizr’s tests. 
 Then, if the tests pass (for example, because SVG support

<em>is</em> detected), then tell Modernizr to go ahead and load D3 and your custom JavaScript code. 
 I’d typically have something like this in the <code class="literal">&lt;head></code> of my document:

<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"js/modernizr.js"</code><code class="nt">>&lt;/script></code>  <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">></code>         <code class="nx">Modernizr</code><code class="p">.</code><code class="nx">load</code><code class="p">({</code>                 <code class="nx">test</code><code class="o">:</code> <code class="nx">Modernizr</code><code class="p">.</code><code class="nx">svg</code> <code class="o">&amp;&amp;</code> <code class="nx">Modernizr</code><code class="p">.</code><code class="nx">inlinesvg</code><code class="p">,</code>                 <code class="nx">yep</code> <code class="o">:</code> <code class="p">[</code> <code class="s1">'js/d3.v3.min.js'</code><code class="p">,</code>                         <code class="s1">'js/script.js'</code> <code class="p">]</code>         <code class="p">});</code> <code class="nt">&lt;/script></code>
This loads Modernizr in, performs the tests, and then bothers loading the other code only if the tests succeed. 
 (That’s the “<code class="literal">yep</code>” part.)  You can use CSS or more JavaScript to define what shows up to the user when the test

<em>fails</em>, such as a static image of your visualization or a message encouraging the user to try a newer browser. 
 Learn more about how to do this in the

<a class="ulink" href="http://modernizr.com/docs/#load" target="_top">Modernizr documentation</a>.

<em>caniuse.com</em> is a fantastic resource for supported browser features. 
 See their list of

<a class="ulink" href="http://caniuse.com/#search=svg" target="_top">browsers with SVG support</a>.

People have tried to get D3 working in older browsers, sometimes by mashing it up with Raphaël to render to canvas, or other hacky means. 
It is technically possible, but I don’t recommend it.

<h1 id="ch04">Chapter 4. Setup</h1>
Getting set up with D3 is pretty straightforward—a simple matter of downloading the latest version, creating an empty page in which to write your code, and finally setting up a local web server.

<h2>Downloading D3</h2>
Start by creating a new folder for your project. 
Call it whatever you like, but maybe something like

<em>project-folder</em>.

Within that folder, I recommend creating a subfolder called

<em>d3</em>. 
Then download the latest version of D3 into that subfolder.

<a class="ulink" href="http://d3js.org/d3.v3.zip" target="_top">Download the latest version of D3 as a ZIP file</a>, and then decompress the ZIP file. 
 As of this writing, the current version of D3 is 3.0.6.

D3 is also provided in a “minified” version,

<a class="ulink" href="http://d3js.org/d3.v3.min.js" target="_top">

<em>d3.v3.min.js</em></a>, from which whitespace has been removed for smaller file sizes and faster load times. 
The functionality is the same, but typically you’d use the regular version while working on a project (for friendlier debugging), and then switch to the minified version once you’ve launched the project publicly (for optimized load times). 
The choice is up to you, but in this book, I use the standard version.

A third option is to download the entire D3 repository, which gives you not just the JavaScript files, but also all of the component source code. 
You can

<a class="ulink" href="https://github.com/mbostock/d3" target="_top">browse the repository contents</a> first, or just

<a class="ulink" href="https://github.com/mbostock/d3/zipball/master" target="_top">download the whole thing as a compressed ZIP file</a>. 
Of course, once you’ve downloaded everything, make a copy of the file

<em>d3.v3.js</em> and move that into

<em>project-folder/d3/</em>.

<h2>Referencing D3</h2>
Now create a simple HTML page within your project folder named

<em>index.html</em>. 
Remember, HTML documents are just plain text files, so you can use the text editor of your choice. 
Free editors like TextEdit and Notepad are fine, but your life might be easier if you use an editor designed specifically for working with code, like Coda, Espresso, or Sublime Text (among many, many others).

If your editor gives you the option to set the file encoding, choose Unicode (UTF-8).

Your folder structure should now look something like this:

project-folder/     d3/         d3.v3.js         d3.v3.min.js (optional)     index.html
Paste the following into your new HTML file:

<code class="cp">&lt;!DOCTYPE html></code> <code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">></code>     <code class="nt">&lt;head></code>         <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"utf-8"</code><code class="nt">></code>         <code class="nt">&lt;title></code>D3 Page Template<code class="nt">&lt;/title></code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code> <code class="na">src=</code><code class="s">"d3/d3.v3.js"</code><code class="nt">>&lt;/script></code>     <code class="nt">&lt;/head></code>     <code class="nt">&lt;body></code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">></code>             <code class="c1">// Your beautiful D3 code will go here</code>         <code class="nt">&lt;/script></code>     <code class="nt">&lt;/body></code> <code class="nt">&lt;/html></code>
Or, rather than go through all that manual labor, you could just download the sample code files (see

<a class="xref" href="" title="Chapter 1. Introduction">Chapter 1</a> for instructions), and take a look at

<em>01_empty_page_template.html</em>, which contains almost exactly the same code. 
 (The <code class="literal">src</code> path to D3 is different in my version.)

Here are a few things to note about this template:

 The <code class="literal">meta</code> tag identifies the encoding for this file as <code class="literal">utf-8</code>, which is needed to ensure that the browser can parse D3’s functions and data properly. 
 The first <code class="literal">script</code> tag sets the reference to

<em>d3.v3.js</em>. 
You should edit this file path as needed if you’re using the minified version of D3 or decided to locate

<em>d3.v3.js</em> somewhere other than the

<em>d3</em> directory. 
 The second <code class="literal">script</code> tag, in the <code class="literal">body</code>, is where you will soon key in all your beautiful code. 
And it will be beautiful. 
 
Done! Your D3 template files and folders are all set up. 
You might want to make a copy of this template for each new project down the line.


<h2>Setting Up a Web Server</h2>
In some cases, you can view local HTML files directly in your web browser. 
However, some browsers have restrictions that prevent them from loading local files via JavaScript, for security reasons. 
That means if your D3 code is trying to pull in any external datafiles (like CSVs or JSON), it will fail with no good explanation. 
This isn’t D3’s fault; it’s a browser feature that prevents loading of scripts and other external files from third-party, untrusted websites.

For this reason, it is much more reliable to load your page via a web server. 
Although you

<em>could</em> use a remote web server, it is much, much faster to store and host everything locally (meaning, on the same computer, the one right in front of you). 
It is a strange idea, to use your local computer to host and serve files to itself, but you can think about it as the different programs talking to each other: the browser program requests files from the server program, which responds by serving them back.

The good news is that it’s quite easy to get a local server up and running. 
Here are a couple of ways to do that.

<h3>Terminal with Python</h3>
If you’re using Mac OS X or Linux, then you already have Python installed. 
 As long as you’re comfortable entering commands in the terminal, then running a miniserver with Python is definitely the quickest option. 
 (If you’re on Windows, you’ll need to install Python first.)

To use Python, you’ll need to open up a terminal window on your system. 
 On a Mac, open the Terminal application. 
 You can find it in the Utilities folder, or by typing

<strong><code class="literal">Terminal</code></strong> into Spotlight (the magnifying glass menu item in the upper-right corner of your screen). 
 Linux users are born knowing how to open a terminal window, so I won’t waste your time explaining it here.

To run a Python web server:

<ol class="orderedlist" type="1">
 Open up a new terminal window. 
 Via the command line, navigate into the directory that you want served. 
 For example, if your project folder is in your Desktop folder on your Mac, you could type:

<strong><code class="literal">cd ~/Desktop/project-folder</code></strong>. 
 Enter

<strong><code class="literal">python -m SimpleHTTPServer 8888 &amp;</code></strong>. 
 </ol>
(This will work with Python version 2.x, but in Python versions 3.0 and newer,
<code class="literal">SimpleHTTPServer</code> has been removed. 
 For Python 3.x, just replace <code class="literal">SimpleHTTPServer</code> with <code class="literal">http.server</code> in the command.)

This will activate the server on port <code class="literal">8888</code>. 
Switch back to your web browser and visit the following URL:

<a class="ulink" href="http://localhost:8888/" target="_top">http://localhost:8888/</a>. 
Yes, instead of

<em>www.something.com</em>, you just use

<em>localhost</em>, which tells the browser to request a page from

<em>this machine</em>.

You should see the blank “D3 Page Template” page. 
Given that <code class="literal">body</code> of the page is empty, it won’t look like much. 
Select View source, and you should see the contents of our HTML template page.

<h3>MAMP, WAMP, and LAMP</h3>
This option takes longer, but is best if you like dragging and dropping to install things, and want to avoid scary things like the terminal.

All of the AMPs in this section stand for Apache (the web server software), MySQL (popular database software), and PHP (a popular web scripting language). 
We are really interested only in Apache, the web server, but it usually comes bundled with the other two, as they all work well together.

On a Mac, you can download and install

<a class="ulink" href="http://mamp.info/en/" target="_top">MAMP</a> or

<a class="ulink" href="http://bit.ly/W8RQa6" target="_top">XAMPP for Mac</a>.

The Windows equivalents are

<a class="ulink" href="http://www.wampserver.com/en/" target="_top">WampServer</a> and

<a class="ulink" href="http://bit.ly/ZEGJq1" target="_top">XAMPP for Windows</a>.

If you use Linux, then all of this is probably already installed on your machine, but you could still download

<a class="ulink" href="http://bit.ly/126txfk" target="_top">XAMPP for Linux</a>.

Installation for each of these packages varies somewhat, so follow the documentation carefully. 
(I’ve found MAMP to be the easiest to install.)

Each package will designate one folder as the web server directory, so only the files

<em>within that folder</em> will be served. 
You should find out what that folder is, and move your D3

<em>project-folder</em> into it.

Once the local server is up and running, you can view any pages within the server directory by opening a browser (on the same computer, of course) and pointing it to

<em>localhost</em>, as in the following:

<a class="ulink" href="http://localhost/" target="_top">http://localhost/</a>. 
Depending on your AMP configuration, you might need to append a port number to the URL, as in the following:

<a class="ulink" href="http://localhost:8888/" target="_top">http://localhost:8888/</a>.

If the server’s port number is <code class="literal">8888</code> and your project folder is called

<em>project-folder</em>, then you could view your D3 template page by going to

<a class="ulink" href="http://localhost:8888/project-folder/" target="_top">http://localhost:8888/project-folder/</a>.

<h3>Diving In</h3>
All set? Great! Let’s start working with data.

<h1><span class="orange">Chapter 5. Data</span></h1>

<em>Data</em> is an extremely broad term, only slightly less vague than the nearly all-encompassing

<em>information</em>. 
What is data? (What

<em>isn’t</em> data?) What kinds of data are there, and what can we use with D3?

Broadly speaking, data is structured information with potential for meaning.

In the context of programming for visualization, data is stored in a digital file, typically in either text or binary form. 
Of course, potentially every piece of digital ephemera may be considered “data”—not just text, but bits and bytes representing images, audio, video, databases, streams, models, archives, and anything else.

Within the scope of D3 and browser-based visualization, however, we will limit ourselves to

<em>text-based data</em>. 
That is, anything that can be represented as numbers and strings of alpha characters. 
If you can get your data into a

<em>.txt</em> plain text file, a

<em>.csv</em> comma-separated value file, or a

<em>.json</em> JSON document, then you can use it with D3.

Whatever your data, it can’t be made useful and visual until it is

<em>attached</em> to something. 
In D3 lingo, the data must be

<em>bound</em> to elements within the page. 
Let’s address how to create new page elements first. 
Then attaching data to those elements will be a cinch.

<h2>Generating Page Elements</h2>
Typically, when using D3 to generate new DOM elements, the new elements will be circles, rectangles, or other visual forms that represent your data. 
But to avoid confusing matters, we’ll start with a simple example and create a lowly <code class="literal">p</code> paragraph element.

Begin by creating a new document with our simple HTML template from the last chapter. 
 You can find it in the sample code files as

<em>01_empty_page_template.html</em>, and it looks like the following code. 
 (Eagle-eyed viewers will notice that I’ve modified the <code class="literal">src</code> path here due to work with the directory structure of the code samples. 
 If that doesn’t mean anything to you, don’t worry about it.)

<code class="cp">&lt;!DOCTYPE html></code> <code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">></code>     <code class="nt">&lt;head></code>         <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"utf-8"</code><code class="nt">></code>         <code class="nt">&lt;title></code>D3 Page Template<code class="nt">&lt;/title></code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code> <code class="na">src=</code><code class="s">"../d3/d3.v3.js"</code><code class="nt">>&lt;/script></code>     <code class="nt">&lt;/head></code>     <code class="nt">&lt;body></code>         <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">></code>             <code class="c1">// Your beautiful D3 code will go here</code>         <code class="nt">&lt;/script></code>     <code class="nt">&lt;/body></code> <code class="nt">&lt;/html></code>
Open that page in your web browser. 
 Make sure you’re accessing the page via your local web server, as we discussed in

<a class="xref" href="ch04" title="Chapter 4. Setup">Chapter 4</a>. 
 So the URL in your browser’s location bar should look something like this:

http://localhost:8888/d3-book/chapter_05/01_empty_page_template.html
If not viewed through a web server, the URL path will start with

<em>file:///</em> instead of

<em>http://</em>. 
 Confirm that the URL does

<em>not</em> look like this:

file:///…/d3-book/chapter_05/01_empty_page_template.html
Once you’re viewing the page, pop open the web inspector. 
 (As a reminder, see

<a class="xref" href="#developer_tools_3" title="Developer Tools">“Developer Tools”</a> on how to do that.) You should see an empty web page, with the DOM contents shown in

<a class="xref" href="#Web_inspector" title="Figure 5-1. Web inspector">Figure 5-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0501.png" alt="Web inspector">
Figure 5-1. Web inspector 
Back in your text editor, replace the comment between the <code class="literal">script</code> tags with:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code>
Save and refresh, and voilà! There is text in the formerly empty browser window, and the web inspector will look like

<a class="xref" href="#Web_inspector_again" title="Figure 5-2. Web inspector, again">Figure 5-2</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0502.png" alt="Web inspector, again">
Figure 5-2. Web inspector, again 
See the difference? Now in the DOM, there is a new paragraph element that was generated on the fly! This might not be exciting yet, but you will soon use a similar technique to dynamically generate tens or hundreds of elements, each one corresponding to a piece of your dataset.

Let’s walk through what just happened. 
(You can follow along with

<em>02_new_element.html</em>.)  To understand that first line of D3 code, you must first meet your new best friend,

<em>chain syntax</em>.

<h3>Chaining Methods</h3>
D3 smartly employs a technique called

<em>chain syntax</em>, which you might recognize from jQuery. 
By “chaining” methods together with periods, you can perform several actions in a single line of code. 
It can be fast and easy, but it’s important to understand how it works, to save yourself hours of debugging headaches later.

By the way,

<em>functions</em> and

<em>methods</em> are just two different words for the same concept: a chunk of code that accepts an argument as input, performs some action, and returns some other information as output.

The following code:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code>
might look like a big mess, especially if you’re new to programming. 
So the first thing to know is that JavaScript, like HTML, doesn’t care about whitespace and line breaks, so you can put each method on its own

 line for legibility:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code>
Both I and your optometrist highly recommend putting each method on its own indented line. 
But programmers have their own coding style; use whatever indents, line breaks, and whitespace (tabs or spaces) are most legible for you.


<h3>One Link at a Time</h3>
Let’s deconstruct each line in this chain of code:

<dl class="variablelist">
<dt>
 <code class="literal">d3</code> </dt>
<dd> References the D3 object, so we can access its methods. 
Our D3 adventure begins here. 
</dd>
<dt>
 <code class="literal">.select("body")</code> </dt>
<dd> Give the

<a class="ulink" href="http://bit.ly/12h4SF1" target="_top"><code class="literal">select()</code></a> method a CSS selector as input, and it will return a reference to the first element in the DOM that matches. 
(Use

<a class="ulink" href="http://bit.ly/WwINKs" target="_top"><code class="literal">selectAll()</code></a> when you need more than one element.) In this case, we just want the <code class="literal">body</code> of the document, so a reference to <code class="literal">body</code> is handed off to the next method in our chain. 
</dd>
<dt>
 <code class="literal">.append("p")</code> </dt>
<dd>

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-append" target="_top"><code class="literal">append()</code></a> creates whatever new DOM element you specify and appends it to the end (but

<em>just inside</em>) of whatever selection it’s acting on. 
In our case, we want to create a new <code class="literal">p</code> within the <code class="literal">body</code>. 
We specified <code class="literal">"p"</code> as the input argument, but this method also sees the reference to <code class="literal">body</code> that was passed down the chain from the <code class="literal">select()</code> method. 
So an empty <code class="literal">p</code> paragraph is

<em>appended</em> to the <code class="literal">body</code>. 
Finally, <code class="literal">append()</code> hands off a reference to the new element it just created. 
</dd>
<dt>
 <code class="literal">.text("New paragraph!")</code> </dt>
<dd>

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-text" target="_top"><code class="literal">text()</code></a> takes a string and inserts it between the opening and closing tags of the current selection. 
Because the previous method passed down a reference to our new <code class="literal">p</code>, this code just inserts the new text between <code class="literal">&lt;p></code> and <code class="literal">&lt;/p></code>. 
(In cases where there is existing content, it will be overwritten.) </dd>
<dt>
 <code class="literal">;</code> </dt>
<dd> The all-important semicolon indicates the end of this line of code. 
Chain over. 
</dd> </dl> 

<h3>The Hand-off</h3>
Many, but not all, D3 methods return a selection (actually, a reference to a selection), which enables this handy technique of method chaining. 
Typically, a method returns a reference to the element that it just acted on, but not always.

So remember this: when chaining methods, order matters. 
The output type of one method has to match the input type expected by the next method in the chain. 
If adjacent inputs and outputs are mismatched, the hand-off will function more like a dropped baton in a middle-school relay race.

When sussing out what each function expects and returns,

<a class="ulink" href="https://github.com/mbostock/d3/wiki/API-Reference" target="_top">the API reference</a> is your friend. 
It contains detailed information on each method, including whether or not it returns a selection.


<h3>Going Chainless</h3>
Our sample code could be rewritten without chain syntax:

<code class="kd">var</code> <code class="nx">body</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">);</code> <code class="kd">var</code> <code class="nx">p</code> <code class="o">=</code> <code class="nx">body</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">);</code> <code class="nx">p</code><code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code>
Ugh! What a mess. 
Yet there will be times you need to break the chain, such as when you are calling so many functions that it doesn’t make sense to string them all together. 
Or just because you want to organize your code in a way that makes more sense to you.

Now that you know how to generate new page elements with D3, it’s time to attach data to them.

  

<h2>Binding Data</h2>
What is binding, and why would I want to do it to my data?

Data visualization is a process of

<em>mapping</em> data to visuals. 
Data in, visual properties out. 
Maybe bigger numbers make taller bars, or special categories trigger brighter colors. 
The mapping rules are up to you.

With D3, we

<em>bind</em> our data input values to elements in the DOM. 
Binding is like “attaching” or associating data to specific elements, so that later you can reference those values to apply mapping rules. 
Without the binding step, we have a bunch of data-less, unmappable DOM elements. 
No one wants that.

<h3>In a Bind</h3>
We use D3’s

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-data" target="_top"><code class="literal">selection.data()</code></a> method to bind data to DOM elements. 
But there are two things we need in place first, before we can bind data:

 The data  A selection of DOM elements  
Let’s tackle these one at a time.

<h3>Data</h3>
D3 is smart about handling different kinds of data, so it will accept practically any array of numbers, strings, or objects (themselves containing other arrays or key/value pairs). 
It can handle JSON (and GeoJSON) gracefully, and even has a built-in method to help you load in CSV files.

But to keep things simple, for now we will start with a boring array of five numbers. 
Here is our sample dataset:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>
If you’re feeling adventurous, or already have some data in CSV or JSON format that you want to play with, here’s how to do that. 
Otherwise, just skip ahead to

<a class="xref" href="#please_make_your_selection_5" title="Please Make Your Selection">“Please Make Your Selection”</a>.

<h4>Loading CSV data</h4>
CSV stands for comma-separated values. 
A CSV data file might look something like this:

Food,Deliciousness Apples,9 Green Beans,5 Egg Salad Sandwich,4 Cookies,10 Vegemite,0.2 Burrito,7
Each line in the file has the same number of values (two, in this case), and values are separated by a comma. 
The first line in the file often serves as a header, providing names for each of the “columns” of data.

If you have data in an Excel file, it probably follows a similar structure of rows and columns. 
 To get that data into D3, open it in Excel, then choose Save as… and select CSV as the file type.

If we saved the preceding CSV data into a file called

<em>food.csv</em>, then we could load the file into D3 by using the <code class="literal">d3.csv()</code> method:

<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code> <code class="p">});</code>
<code class="literal">csv()</code> takes two arguments: a string representing the path of the CSV file to load in, and an anonymous function, to be used as a

<em>callback function</em>. 
The callback function is “called” only

<em>after</em> the CSV file has been loaded into memory. 
So you can be sure that, by the time the callback is called, <code class="literal">d3.csv()</code> is done executing.

When called, the anonymous function is handed the result of the CSV loading and parsing process; that is, the data. 
Here I’m naming it <code class="literal">data</code>, but this could be called whatever you like. 
You should use this callback function to do all the things you can do only

<em>after</em> the data has been loaded. 
In the preceding example, we are just logging the value of the <code class="literal">data</code> array to the console, to verify it, as shown in

<a class="xref" href="#Array_logged_to_console" title="Figure 5-3. Array logged to console">Figure 5-3</a>. 
(See

<em>03_csv_loading_example.html</em> in the example code.)

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0503.png" alt="Array logged to console">
Figure 5-3. Array logged to console 
You can see that <code class="literal">data</code> is an array (because of the hard brackets <code class="literal">[]</code> on either end) with six elements, each of which is an object. 
By toggling the disclosure triangles next to each object, we can see their

 values (see

<a class="xref" href="#Array_elements_expanded" title="Figure 5-4. Array elements expanded">Figure 5-4</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0504.png" alt="Array elements expanded">
Figure 5-4. Array elements expanded 
Aha! Each object has both a <code class="literal">Food</code> property and a <code class="literal">Deliciousness</code> property, the values of which correspond to the values in our CSV! (There is also a third property, <code class="literal">__proto__</code>, but that has to do with how JavaScript handles objects, and you can ignore it for now.) D3 has employed the first row of the CSV for property names, and subsequent rows for values. 
You might not realize it, but this just saved you a

<em>lot</em> of time.

One more thing to note is that each value from the CSV is stored as a string, even the numbers. 
(You can tell because 9 is surrounded by quotation marks, as in <code class="literal">"9"</code> and not simply <code class="literal">9</code>.) This could cause unexpected behavior later, if you try to reference your data as a numeric value but it is still typed as a string.

Handling Data Loading Errors
Note that <code class="literal">d3.csv()</code> is an

<em>asynchronous</em> method, meaning that the rest of your code is executed even while JavaScript is simultaneously waiting for the file to finish downloading into the browser. 
 (The same is true of D3’s other functions that load external resources, such as <code class="literal">d3.json()</code>.)

This can potentially be

<em>very</em> confusing, because you—as a reasonable human person—might assume that the CSV file’s data is available, when in fact it hasn’t finished loading yet. 
 A common mistake is to include references to the external data

<em>outside of</em> the callback function. 
 Save yourself some headaches and make sure to reference your data only from

<em>within</em> the callback function (or from within other functions that you call within the callback function).

Personally, I like to declare a global variable first, then call <code class="literal">d3.csv()</code> to load the data. 
 Within the callback function, I copy the data into my global variable (so it’s available to all of my subsequent functions), and finally I call any functions that rely on that data being present. 
 For example:

<code class="kd">var</code> <code class="nx">dataset</code><code class="p">;</code>  <code class="c1">//Global variable</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">dataset</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>    <code class="c1">//Once loaded, copy to dataset.</code>     <code class="nx">generateVis</code><code class="p">();</code>     <code class="c1">//Then call other functions that</code>     <code class="nx">hideLoadingMsg</code><code class="p">();</code>  <code class="c1">//depend on data being present.</code> <code class="p">});</code>
To further confuse matters, the callback function is executed

<em>whether or not the datafile was loaded successfully</em>. 
 That’s right, if the network connection fails, or the filename is misspelled, or for some reason an error occurs on the web server end, the callback function will

<em>still</em> be executed. 
 When the data fails to load, and you call functions that rely on that data being present, you will probably see an error in the console, and the visualization won’t be created. 
 This scenario might happen only rarely, but it’s useful to know how to handle it.

Fortunately, you can include an optional <code class="literal">error</code> parameter in the callback function definition. 
 If there is a problem loading the file, then <code class="literal">error</code> will be set to the error message returned by the web server, and <code class="literal">data</code> will be <code class="literal">undefined</code>. 
 If the file loads successfully and there is no error, then <code class="literal">error</code> will be <code class="literal">null</code>, and the <code class="literal">data</code> array will be populated as expected. 
 Note that <code class="literal">error</code> must be the first parameter, and <code class="literal">data</code> the second:

<code class="kd">var</code> <code class="nx">dataset</code><code class="p">;</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>          <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">//If error is not null, something went wrong.</code>           <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>  <code class="c1">//Log the error.</code>         <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>      <code class="c1">//If no error, the file loaded correctly. 
Yay!</code>           <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>   <code class="c1">//Log the data.</code>        <code class="c1">//Include other code to execute after successful file load here</code>       <code class="nx">dataset</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>       <code class="nx">generateVis</code><code class="p">();</code>       <code class="nx">hideLoadingMsg</code><code class="p">();</code>         <code class="p">}</code>  <code class="p">});</code> 
Verifying your data is a great use of the <code class="literal">csv()</code> callback function, but typically this is where you’d call other functions that construct the visualization, now that the data is available, as in:

<code class="kd">var</code> <code class="nx">dataset</code><code class="p">;</code>  <code class="c1">//Declare global var</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"food.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>      <code class="c1">//Hand CSV data off to global var,</code>     <code class="c1">//so it's accessible later.</code>     <code class="nx">dataset</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>      <code class="c1">//Call some other functions that</code>     <code class="c1">//generate your visualization, e.g.:</code>     <code class="nx">generateVisualization</code><code class="p">();</code>     <code class="nx">makeAwesomeCharts</code><code class="p">();</code>     <code class="nx">makeEvenAwesomerCharts</code><code class="p">();</code>     <code class="nx">thankAwardsCommittee</code><code class="p">();</code>  <code class="p">});</code>
One more tip: if you have

<em>tab</em>-separated data in a TSV file, try the <code class="literal">d3.tsv()</code> method, which otherwise behaves exactly as the preceding method.


<h4>Loading JSON data</h4>
We’ll spend more time talking about JSON later, but for now, all you need

 to know is that the <code class="literal">d3.json()</code> method works the same way as <code class="literal">csv()</code>. 
Load your JSON data in this way:

<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"waterfallVelocities.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">json</code><code class="p">);</code>  <code class="c1">//Log output to console</code> <code class="p">});</code>
Here, I’ve named the parsed output <code class="literal">json</code>, but it could be called <code class="literal">data</code> or whatever you like.
  

<h3>Please Make Your Selection</h3>
The data is ready to go. 
As a reminder, we are working with this simple array:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>
Now you need to decide what to select. 
That is, what elements will your data be associated with? Again, let’s keep it super simple and say that we want to make a new paragraph for each value in the dataset. 
So you might imagine something like this would be helpful:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>
and you’d be right, but there’s a catch: the paragraphs we want to select

<em>don’t exist yet</em>. 
And this gets at one of the most common points of confusion with D3: how can we select elements that don’t yet exist? Bear with me, as the answer might require bending your mind a bit.

The answer lies with <code class="literal">enter()</code>, a truly magical method. 
See this code,

 which I’ll explain:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code>
View the example code

<em>04_creating_paragraphs.html</em> and you should see five new paragraphs, each with the same content, as shown in

<a class="xref" href="#Dynamic_paragraphs" title="Figure 5-5. Dynamic paragraphs">Figure 5-5</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0505.png" alt="Dynamic paragraphs">
Figure 5-5. Dynamic paragraphs 
Here’s what’s happening:

<dl class="variablelist">
<dt>
 <code class="literal">d3.select("body")</code> </dt>
<dd> Finds the <code class="literal">body</code> in the DOM and hands off a reference to the next step in the chain. 
</dd>
<dt>
 <code class="literal">.selectAll("p")</code> </dt>
<dd> Selects all paragraphs in the DOM. 
Because none exist yet, this returns an empty selection. 
Think of this empty selection as representing the paragraphs that

<em>will soon exist</em>. 
</dd>
<dt>
 <code class="literal">.data(dataset)</code> </dt>
<dd> Counts and parses our data values. 
There are five values in our array called <code class="literal">dataset</code>, so everything past this point is executed five times, once for each value. 
</dd>
<dt>
 <code class="literal">.enter()</code> </dt>
<dd> To create new, data-bound elements, you must use <code class="literal">enter()</code>. 
This method looks at the current DOM selection, and then at the data being handed to it. 
If there are more data values than corresponding DOM elements, then <code class="literal">enter()</code>

<em>creates a new placeholder element</em> on which you can work your magic. 
It then hands off a reference to this new placeholder to the next step in the chain. 
</dd>
<dt>
 <code class="literal">.append("p")</code> </dt>
<dd> Takes the empty placeholder selection created by <code class="literal">enter()</code> and appends a <code class="literal">p</code> element into the DOM. 
Hooray! Then it hands off a reference to the element it just created to the next step in the chain. 
</dd>
<dt>
 <code class="literal">.text("New paragraph!")</code> </dt>
<dd> Takes the reference to the newly created <code class="literal">p</code> and inserts a text value. 
</dd> </dl> 

<h3>Bound and Determined</h3>
All right! Our data has been read, parsed, and bound to new <code class="literal">p</code> elements that we created in the DOM. 
Don’t believe me? Take another look at

<em>04_creating_paragraphs.html</em> and whip out your web inspector, shown in

<a class="xref" href="#new_p_elements_in_the_inspector" title="Figure 5-6. New p elements in the web inspector">Figure 5-6</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0506.png" alt="New p elements in the web inspector">
Figure 5-6. New <code class="literal">p</code> elements in the web inspector 
Okay, I see five paragraphs, but where’s the data? Switch to the JavaScript console, type in the following code, and click Enter. 
The results are shown in

<a class="xref" href="#logging_to_from_console" title="Figure 5-7. Logging to the console, from the console">Figure 5-7</a>:

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">))</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0507.png" alt="Logging to the console, from the console">
Figure 5-7. Logging to the console, from the console 
An array! Or, really, an array containing another array. 
Click the gray disclosure triangle to reveal its contents, shown in

<a class="xref" href="#array_of_arrays" title="Figure 5-8. Array of arrays, expanded">Figure 5-8</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0508.png" alt="Array of arrays, expanded">
Figure 5-8. Array of arrays, expanded 
You’ll notice the five <code class="literal">p</code>s, numbered 0 through 4. 
Click the disclosure triangle next to the first one (number zero), which results in the view shown in

<a class="xref" href="#the_p_element_expanded" title="Figure 5-9. The p element, expanded">Figure 5-9</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0509.png" alt="The p element, expanded">
Figure 5-9. The p element, expanded 
See it? Do you see it? I can barely contain myself. 
There it is (

<a class="xref" href="#finally_bound_data" title="Figure 5-10. Finally, bound data">Figure 5-10</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0510.png" alt="Finally, bound data">
Figure 5-10. Finally, bound data 
Our first data value, the number <code class="literal">5</code>, is showing up under the first paragraph’s
<code class="literal">__data__</code> attribute. 
Click into the other paragraph elements, and you’ll see they also contain <code class="literal">__data__</code> values: 10, 15, 20, and 25, just as we specified.

You see, when D3 binds data to an element, that data doesn’t exist in the DOM, but it does exist in memory as a <code class="literal">__data__</code> attribute of that element. 
And the console is where you can go to confirm whether or not your data was bound as expected.

The data is ready. 
Let’s do something with it.


<h3>Using Your Data</h3>
We can see that the data has been loaded into the page and is bound to

 our newly created elements in the DOM, but can we

<em>use</em> it? Here’s our code so far:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"New paragraph!"</code><code class="p">);</code>
Let’s change the last line to:

    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code>
Now test out that new code in

<em>05_creating_paragraphs_text.html</em>. 
You should see the result shown in

<a class="xref" href="#more_dynamic_paragraphs" title="Figure 5-11. More dynamic paragraphs">Figure 5-11</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0511.png" alt="More dynamic paragraphs">
Figure 5-11. More dynamic paragraphs 

Try It Now!
Change the last line of the D3 code below from <code class="literal">.text("New paragraph!");</code> to <code class="literal">.text(function(d) { return d; });</code> and see the results change to match

<a class="xref" href="#more_dynamic_paragraphs" title="Figure 5-11. More dynamic paragraphs">Figure 5-11</a>.

<a href="http://examples.oreilly.com/0636920026938/chapter_05/04_creating_paragraphs.html" target="_blank">04_creating_paragraphs</a>

Whoa! We used our data to populate the contents of each paragraph, all thanks to the magic of the <code class="literal">data()</code> method. 
You see, when chaining methods together, anytime after you call <code class="literal">data()</code>, you can create an anonymous function that accepts <code class="literal">d</code> as input. 
The magical <code class="literal">data()</code> method ensures that <code class="literal">d</code> is set to the corresponding value in your original dataset, given the current element at hand.

The value of “the current element” changes over time as D3 loops through each element. 
For example, when looping through the third time, our code creates the third <code class="literal">p</code> tag, and <code class="literal">d</code> will correspond to the third value in our dataset (or <code class="literal">dataset[2]</code>). 
So the third paragraph gets text content of “15”.

<h3>High-Functioning</h3>
In case you’re new to writing your own functions (a.k.a. 
methods), the

 basic structure of a function definition is:

<code class="kd">function</code><code class="p">(</code><code class="nx">input_value</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Calculate something here</code>     <code class="k">return</code> <code class="nx">output_value</code><code class="p">;</code> <code class="p">}</code>
The function we used earlier is dead simple, nothing fancy:

<code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">}</code>
This is called an

<em>anonymous function</em>, because it doesn’t have a name. 
 Contrast that with a function that’s stored in a variable, which is a

<em>named function</em>:

<code class="kd">var</code> <code class="nx">doSomething</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>     <code class="c1">//Code to do something here</code> <code class="p">};</code>
We’ll write lots of anonymous functions when using D3. 
 They are the key to accessing individual data values and calculating dynamic properties.

This particular anonymous function is wrapped within D3’s <code class="literal">text()</code> function. 
 So our anonymous function is executed first. 
Then its result is handed off to <code class="literal">text()</code>. 
Then <code class="literal">text()</code> finally works its magic (by inserting its input argument as text within the selected DOM element):

<code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code>
But we can (and will) get much fancier because you can customize these functions any way you like. 
Yes, this is both the pleasure and pain of writing your own JavaScript. 
 Maybe you’d like to add some extra text, as in:

<code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="s2">"I can count up to "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code>
which produces the result shown in

<a class="xref" href="#Still_more_dynamic_paragraphs" title="Figure 5-12. Still more dynamic paragraphs">Figure 5-12</a>, as seen in example file

<em>06_creating_paragraphs_counting.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0512.png" alt="Still more dynamic paragraphs">
Figure 5-12. Still more dynamic paragraphs 

Try It Now!
Change the last line of the D3 code below from <code class="literal">return d;</code> to <code class="literal">return "I can count up to " + d;</code> and see the results change to match

<a class="xref" href="#Still_more_dynamic_paragraphs" title="Figure 5-12. Still more dynamic paragraphs">Figure 5-12</a>.

<a href="http://examples.oreilly.com/0636920026938/chapter_05/05_creating_paragraphs_text.html" target="_blank">05_creating_paragraphs_text</a>

<h3>Data Wants to Be Held</h3>
You might be wondering why you have to write out <code class="literal">function(d) { … }</code> instead of just <code class="literal">d</code> on its own. 
For example, this won’t work:

<code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"I can count up to "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">);</code>
In this context, without wrapping <code class="literal">d</code> in an anonymous function, <code class="literal">d</code> has

 no value. 
Think of <code class="literal">d</code> as a lonely little placeholder value that just needs a warm, containing hug from a kind, caring function’s parentheses. 
(Extending this metaphor further, yes, it is creepy that the hug is being given by an

<em>anonymous</em> function, but that only confuses matters.)

Here is <code class="literal">d</code> being held gently and appropriately by a function:

<code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">// &lt;-- Note tender embrace at left</code>     <code class="k">return</code> <code class="s2">"I can count up to "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code>
The reason for this syntax is that <code class="literal">.text()</code>, <code class="literal">attr()</code>, and many other D3 methods can take a

<em>function</em> as an argument. 
For example, <code class="literal">text()</code> can

 take either simply a static string of text as an argument:

<code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"someString"</code><code class="p">)</code>

<em>or</em> the result of a function:

<code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">someFunction</code><code class="p">())</code>  <code class="c1">// Presumably, someFunction() would return a string</code>

<em>or</em> an anonymous function itself can be the argument, such as when you write:

<code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">})</code>
Here, you are defining an anonymous function. 
If D3 sees a function there, it will

<em>call</em> that function, while handing off the current datum <code class="literal">d</code> as the function’s argument. 
 Here, I’ve named the argument <code class="literal">d</code> just by convention. 
 You could call it <code class="literal">datum</code> or <code class="literal">info</code> or whatever you like. 
 All D3 is looking for is

<em>any</em> argument name, into which it can pass the current datum. 
 Throughout this book, we’ll use <code class="literal">d</code> because it is concise and familiar from many of the other D3 examples found online.

In any case, without that function in place, D3 couldn’t relay the current data value. 
 Without an anonymous function and its argument there to receive the value of <code class="literal">d</code>, D3 could get confused and even start crying. 
(D3 is more emotional than you’d expect.)

At first, this might seem silly and like a lot of extra work to just get at <code class="literal">d</code>, but the value of this approach will become clear as we work on more complex pieces.

<h3>Beyond Text</h3>
Things get a lot more interesting when we explore D3’s other methods,

 like <code class="literal">attr()</code> and <code class="literal">style()</code>, which allow us to set HTML attributes and

 CSS properties on selections,
respectively.

For example, adding one more line to our code:

<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"color"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>
produces the result shown in

<a class="xref" href="#Red_paragraphs" title="Figure 5-13. Red paragraphs">Figure 5-13</a>, as seen in

<em>07_creating_paragraphs_with_style.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0513.png" alt="Red paragraphs">
Figure 5-13. Red paragraphs 
All the text is now red; big deal. 
But we could use a custom function to make the text red only if the current datum exceeds a certain threshold. 
So we revise that last line to use a function instead of a string:

<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"color"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">d</code> <code class="o">></code> <code class="mi">15</code><code class="p">)</code> <code class="p">{</code>   <code class="c1">//Threshold of 15</code>         <code class="k">return</code> <code class="s2">"red"</code><code class="p">;</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"black"</code><code class="p">;</code>     <code class="p">}</code> <code class="p">});</code>
See the resulting change, displayed in

<a class="xref" href="#Dynamically_styled_paragraphs" title="Figure 5-14. Dynamically styled paragraphs">Figure 5-14</a>, in

<em>08_creating_paragraphs_with_style_functions.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0514.png" alt="Dynamically styled paragraphs">
Figure 5-14. Dynamically styled paragraphs 
Notice how the first three lines are black, but once <code class="literal">d</code> exceeds the arbitrary threshold of 15, the text turns red.

Okay, we’ve got data loaded in, and dynamically created DOM elements bound to that data. 
I’d say we’re ready to start drawing with data!

Exercise
Modify the code on the left from

<em>08_creating_paragraphs_with_style_functions.html</em> to highlight even-number data values in red and odd-number data values in black, and check the results in the output on the right

<a href="http://examples.oreilly.com/0636920026938/chapter_05/08_creating_paragraphs_with_style_functions.html" target="_blank">08_creating_paragraphs_with_style_functions</a>

<h1><span class="orange">Chapter 6. Drawing with Data</span></h1>
It’s time to start drawing with data.

Let’s continue working with our simple dataset for now:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>

<h2>Drawing divs</h2>
We’ll use this to generate a super-simple bar chart. 
Bar charts are essentially just rectangles, and an HTML <code class="literal">div</code> is the easiest way to draw a rectangle. 
(Then again, to a web browser,

<em>everything</em> is a rectangle, so you could easily adapt this example to use <code class="literal">span</code>s or whatever element you prefer.)

Formally, a chart with vertically oriented rectangles is a

<em>column</em> chart, and one with horizontal rectangles is a

<em>bar</em> chart. 
In practice, most people just call them all bar charts, as I’ll do from now on.

This <code class="literal">div</code> could work well as a data bar, shown in

<a class="xref" href="#A_humble_div" title="Figure 6-1. A humble div">Figure 6-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0601.png" alt="A humble div">
Figure 6-1. A humble div 
<code class="nt">&lt;div</code> <code class="na">style=</code><code class="s">"display: inline-block;</code> <code class="s">            width: 20px;</code> <code class="s">            height: 75px;</code> <code class="s">            background-color: teal;"</code><code class="nt">>&lt;/div></code>
Among web standards folks, this is a semantic no-no. 
Normally, one shouldn’t use an empty <code class="literal">div</code> for purely visual effect, but I am making an exception for the sake of this example.

Because this is a <code class="literal">div</code>, its <code class="literal">width</code> and <code class="literal">height</code> are set with CSS styles. 
Except for <code class="literal">height</code>, each bar in our chart will share the same display properties, so I’ll put those shared styles into a class called <code class="literal">bar</code>, as an embedded style up in the <code class="literal">head</code> of the document:

<code class="nt">div</code><code class="nc">.bar</code> <code class="p">{</code>     <code class="k">display</code><code class="o">:</code> <code class="nb">inline</code><code class="o">-</code><code class="nb">block</code><code class="p">;</code>     <code class="k">width</code><code class="o">:</code> <code class="m">20px</code><code class="p">;</code>     <code class="k">height</code><code class="o">:</code> <code class="m">75px</code><code class="p">;</code>   <code class="c">/* We'll override height later */</code>     <code class="k">background-color</code><code class="o">:</code> <code class="nb">teal</code><code class="p">;</code> <code class="p">}</code>
Now each <code class="literal">div</code> needs to be assigned the <code class="literal">bar</code> class, so our new CSS rule will apply. 
If you were writing the HTML code by hand, you would write the following:

<code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"bar"</code><code class="nt">>&lt;/div></code>
Using D3, to add a class to an element, we use the <code class="literal">selection.attr()</code> method. 
It’s important to understand the difference between <code class="literal">attr()</code> and its close cousin, <code class="literal">style()</code>. 
<code class="literal">attr()</code> sets DOM attribute values, whereas <code class="literal">style()</code> applies CSS styles directly to an element.

<h3>Setting Attributes</h3>

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-attr" target="_top"><code class="literal">attr()</code></a> is used to set an HTML attribute and its value on an element. 
An HTML attribute is any property/value pair that you could include between an

 element’s <code class="literal">&lt;></code> brackets. 
For example, these HTML elements:

<code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"caption"</code><code class="nt">></code> <code class="nt">&lt;select</code> <code class="na">id=</code><code class="s">"country"</code><code class="nt">></code> <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"logo.png"</code> <code class="na">width=</code><code class="s">"100px"</code> <code class="na">alt=</code><code class="s">"Logo"</code> <code class="nt">/></code>
contain a total of five attributes (and corresponding values), all of which could be set with <code class="literal">attr()</code>:

<table style="width: 50%; border-collapse: collapse;">
<colgroup>
<col class="col_1">
<col class="col_2"> </colgroup>
<thead>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "> Attribute     </td>
<td style="border-bottom: 0.5pt solid ; "> Value</td> </tr></thead>
<tbody>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<code class="literal">class</code>
</td>
<td style="border-bottom: 0.5pt solid ; ">
<code class="literal">caption</code>
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<code class="literal">id</code>
</td>
<td style="border-bottom: 0.5pt solid ; ">
<code class="literal">country</code>
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<code class="literal">src</code>
</td>
<td style="border-bottom: 0.5pt solid ; ">
<code class="literal">logo.png</code>
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; ">
<code class="literal">width</code>
</td>
<td style="border-bottom: 0.5pt solid ; ">
<code class="literal">100px</code>
</td> </tr>
<tr>
<td style="border-right: 0.5pt solid ; ">
<code class="literal">alt</code>
</td>
<td>
<code class="literal">Logo</code>
</td> </tr> </tbody> </table>
To assign a class of <code class="literal">bar</code>, we can use:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code> 

<h3>A Note on Classes</h3>
Note that an element’s

<em>class</em> is stored as an HTML attribute. 
The class, in turn, is used to reference a CSS style rule. 
This could cause some confusion because there is a difference between setting a

<em>class</em> (from which styles are inferred) and applying a

<em>style</em> directly to an element. 
You can do both with D3. 
Although you should use whatever approach makes the most sense to you, I recommend using

<em>classes</em> for properties that are shared by multiple elements, and applying

<em>style</em> rules directly only when deviating from the norm. 
(In fact, that’s what we’ll do in just a moment.)

I also want to briefly mention another D3 method, <code class="literal">classed()</code>, which can be used to quickly apply or remove classes from elements. 
The preceding line of

 code could be rewritten as the following:

<code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">,</code> <code class="kc">true</code><code class="p">)</code>
This line simply takes whatever selection is passed to it and applies the class <code class="literal">bar</code>. 
If <code class="literal">false</code> were specified, it would do the opposite, removing the class of <code class="literal">bar</code> from any elements in the selection:

<code class="p">.</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"bar"</code><code class="p">,</code> <code class="kc">false</code><code class="p">)</code> 

<h3>Back to the Bars</h3>
Putting it all together with our dataset, here is the complete D3 code so far:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">);</code>
To see what’s going on, look at

<em>01_drawing_divs.html</em> in your browser, view the source, and open your web inspector. 
You should see five vertical <code class="literal">div</code> bars, one generated for each point in our dataset. 
However, with no space between them, they look like one big rectangle, as seen in Figures

<a class="xref" href="#Five_divs_masquerading_as_one" title="Figure 6-2. Five divs masquerading as one">6-2</a> and

<a class="xref" href="#Five_divs_masquerading_as_one_inspector" title="Figure 6-3. Five divs masquerading as one, as seen through the web inspector">6-3</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0602.png" alt="Five divs masquerading as one">
Figure 6-2. Five <code class="literal">div</code>s masquerading as one 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0603.png" alt="Five divs masquerading as one, as seen through the web inspector">
Figure 6-3. Five <code class="literal">div</code>s masquerading as one, as seen through the web inspector  

<h3>Setting Styles</h3>
The

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-style" target="_top"><code class="literal">style()</code></a> method is used to apply a CSS property and value directly to an HTML

 element. 
This is the equivalent of including CSS rules within a <code class="literal">style</code> attribute right in your HTML, as in:

<code class="nt">&lt;div</code> <code class="na">style=</code><code class="s">"height: 75px;"</code><code class="nt">>&lt;/div></code>
To make a bar chart, the height of each bar must be a function of its corresponding data value. 
So let’s add this to the end of our D3 code (taking care to keep the final semicolon at the very end of the chain):

<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code> <code class="p">});</code>
See that code in

<em>02_drawing_divs_height.html</em>. 
You should see a very small bar chart, like the one in

<a class="xref" href="#A_small_bar_chart" title="Figure 6-4. A small bar chart">Figure 6-4</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0604.png" alt="A small bar chart">
Figure 6-4. A small bar chart 
When D3 loops through each data point, the value of <code class="literal">d</code> will be set to that of the corresponding value. 
So we are setting a <code class="literal">height</code> value of <code class="literal">d</code> (the current data value) while appending the text <code class="literal">px</code> (to specify the units are pixels). 
The resulting heights are <code class="literal">5px</code>, <code class="literal">10px</code>, <code class="literal">15px</code>, <code class="literal">20px</code>, and <code class="literal">25px</code>.

This looks a little bit silly, so let’s make those bars taller:

<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="kd">var</code> <code class="nx">barHeight</code> <code class="o">=</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">5</code><code class="p">;</code>  <code class="c1">//Scale up by factor of 5</code>     <code class="k">return</code> <code class="nx">barHeight</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code> <code class="p">});</code>
Add some space to the right of each bar (in the embedded CSS style, in the document <code class="literal">head</code>), to space things out:

<code class="k">margin-right</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
Nice! We could go to

<a class="ulink" href="https://www.siggraph.org" target="_top">SIGGRAPH</a> with that chart (

<a class="xref" href="#A_taller_bar_chart" title="Figure 6-5. A taller bar chart">Figure 6-5</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0605.png" alt="A taller bar chart">
Figure 6-5. A taller bar chart 
Try out the sample code

<em>03_drawing_divs_spaced.html</em>. 
Again, view the source and use the web inspector to contrast the original HTML against the final DOM.

  

<h2>The Power of data()</h2>
This is exciting, but real-world data is never this clean:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>
Let’s make our data a bit messier, as in

<em>04_power_of_data.html</em>:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">26</code><code class="p">,</code> <code class="mi">11</code> <code class="p">];</code>
That change in data results in the bars shown in

<a class="xref" href="#New_data_values" title="Figure 6-6. New data values">Figure 6-6</a>. 
We’re not limited to five data points, of course. 
Let’s add many more! (See

<em>05_power_of_data_more_points.html</em>.)

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">26</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">14</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code>                 <code class="mi">14</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">29</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code>                 <code class="mi">24</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">3</code> <code class="p">];</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0606.png" alt="New data values">
Figure 6-6. New data values 
Twenty-five data points instead of five (see

<a class="xref" href="#Lots_more_data_values" title="Figure 6-7. Lots more data values">Figure 6-7</a>)!

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0607.png" alt="Lots more data values">
Figure 6-7. Lots more data values 
How does D3 automatically expand our chart as needed?

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>  <code class="c1">// &lt;-- The answer is here!</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="kd">var</code> <code class="nx">barHeight</code> <code class="o">=</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">5</code><code class="p">;</code>         <code class="k">return</code> <code class="nx">barHeight</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code>     <code class="p">});</code>
Give <code class="literal">data()</code> 10 values, and it will loop through 10 times. 
Give it one million values, and it will loop through one million times. 
(Just be patient.)

That is the power of <code class="literal">data()</code>—being smart enough to loop through the full length of whatever dataset you throw at it, executing each method beneath it in the chain, while updating the context in which each method operates, so <code class="literal">d</code> always refers to the current datum at that point in the loop.

That might be a mouthful, and if it all doesn’t make sense yet, it will soon. 
I encourage you to make a copy of

<em>05_power_of_data_more_points.html</em>, tweak the <code class="literal">dataset</code> values, and note how the bar chart changes.

Try It Now!
Tweak the <code class="literal">dataset</code> values in the code below at left, and note how the bar chart changes at right.

<a href="http://examples.oreilly.com/0636920026938/chapter_06/05_power_of_data_more_points.html" target="_blank">05_power_of_data_more_points</a>

Remember, the

<em>data</em> is driving the visualization—not the other way around.

<h3>Random Data</h3>
Sometimes it’s fun to generate random data values, whether for testing

 purposes or just pure geekiness. 
That’s just what I’ve done in

<em>06_power_of_data_random.html</em>. 
Notice that each time you reload the page, the bars render differently, as shown in

<a class="xref" href="#Bar_charts_with_random_values" title="Figure 6-8. Bar charts with random values">Figure 6-8</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0608.png" alt="Bar charts with random values">
Figure 6-8. Bar charts with random values 

Try It Now!
Try it out right here in your browser. 
Hover over the bar graph and click the "Run with JS" button, and see the bars render differently as new random numbers are generated.

<a href="http://examples.oreilly.com/0636920026938/chapter_06/06_power_of_data_random.html" target="_blank">06_power_of_data_random</a>

View the source, and you’ll see this code:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[];</code>                         <code class="c1">//Initialize empty array</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">25</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>            <code class="c1">//Loop 25 times</code>     <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">30</code><code class="p">;</code>   <code class="c1">//New random number (0-30)</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">newNumber</code><code class="p">);</code>              <code class="c1">//Add new number to array</code> <code class="p">}</code>
That code doesn’t use any D3 methods; it’s just JavaScript. 
Without going into too much detail, this code does the following:

<ol class="orderedlist" type="1">
 Creates an empty array called <code class="literal">dataset</code>. 
 Initiates a <code class="literal">for</code> loop, which is executed 25 times. 
 Each time, it generates a new random number with a value between 0 and 30. 
 (Well, technically,

<em>almost</em> 30. 
 <code class="literal">Math.random()</code> returns values as low as 0.0 all the way up to, but not including, 1.0. 
 So if <code class="literal">Math.random()</code> returned 0.99999, then the result would be 0.99999 times 30, which is 29.9997, or the teensiest bit less than 30.)  That new number is appended to the <code class="literal">dataset</code> array. 
(<code class="literal">push()</code> is an array method that appends a new value to the end of an array.)  </ol>
Just for kicks, open up the JavaScript console and enter <code class="literal">console.log(dataset)</code>. 
You should see the full array of 25 randomized data values, as shown in

<a class="xref" href="#Random_values_in_console" title="Figure 6-9. Random values in console">Figure 6-9</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0609.png" alt="Random values in console">
Figure 6-9. Random values in console 
Notice that they are all decimal or floating point values (such as 14.793717765714973), not whole numbers or integers (such as 14) like we used initially. 
For this example, decimal values are fine, but if you ever need whole numbers, you could use JavaScript’s <code class="literal">Math.round()</code> or <code class="literal">Math.floor()</code> methods. 
 <code class="literal">Math.round()</code> rounds any number to the nearest integer, whereas <code class="literal">Math.floor()</code> always rounds down, for greater control over the result. 
 For example, you could wrap the random number generator from this line:

    <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">30</code><code class="p">;</code>
as follows:

    <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">30</code><code class="p">);</code>
Using this code, <code class="literal">newNumber</code> would always be either 0 or 29, or any integer in between. 
 Why not 30?  Because <code class="literal">Math.random()</code> always returns values

<em>less than</em> 1.0, and <code class="literal">Math.floor()</code> will always

<em>round down</em>, so 29 is the highest possible return value.

Try it out in

<em>07_power_of_data_rounded.html</em>, and use the console to verify that the numbers have indeed been rounded to integers, as displayed in

<a class="xref" href="#Random_integer_values_in_console" title="Figure 6-10. Random integer values in console">Figure 6-10</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0610.png" alt="Random integer values in console">
Figure 6-10. Random integer values in console 
That’s about all we can do visually with <code class="literal">div</code>s. 
Let’s expand our visual possibilities with SVG.
  

<h2>Drawing SVGs</h2>
For a quick refresher on SVG syntax, see

<a class="xref" href="#SVG_3" title="SVG">“SVG”</a>.

One thing you might notice about SVG elements is that all of their properties are specified as

<em>attributes</em>. 
That is, they are included as

 property/value pairs within each element tag, like this:

<code class="nt">&lt;element</code> <code class="na">property=</code><code class="s">"value"</code><code class="nt">>&lt;/element></code>
Hmm, that looks strangely like HTML!

<code class="nt">&lt;p</code> <code class="na">class=</code><code class="s">"eureka"</code><code class="nt">></code>Eureka!<code class="nt">&lt;/p></code>
We have already used D3’s handy <code class="literal">append()</code> and <code class="literal">attr()</code> methods to create new HTML elements and set their attributes. 
Because SVG elements exist in the DOM, just as HTML elements do, we can use <code class="literal">append()</code> and <code class="literal">attr()</code> in exactly the same way to generate SVG images.

<h3>Create the SVG</h3>
First, we need to create the SVG element in which to place all our shapes:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">);</code>
That will find the document’s <code class="literal">body</code> and append a new <code class="literal">svg</code> element just before the closing <code class="literal">&lt;/body></code> tag. 
That code will work, but I’d like to suggest a slight modification:

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">);</code>
Remember how most D3 methods return a reference to the DOM element on which they act? By creating a new variable <code class="literal">svg</code>, we are able to capture the reference handed back by <code class="literal">append()</code>. 
Think of <code class="literal">svg</code> not as a variable but as a reference pointing to the SVG object that we just created. 
This reference will save us a lot of code later. 
Instead of having to search for that SVG each time—as in <code class="literal">d3.select("svg")</code>—we just say <code class="literal">svg</code>:

<code class="nx">svg</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>
Alternatively, that could all be written as one line of code:

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>
See

<em>08_drawing_svgs.html</em> for that code. 
Inspect the DOM and notice that there is, indeed, an empty SVG element.

To simplify your life, I recommend putting the width and height values

 into variables at the top of your code, as in

<em>09_drawing_svgs_size.html</em>. 
View the source, and you’ll see the following code:

<code class="c1">//Width and height</code> <code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">50</code><code class="p">;</code>
I’ll be doing that with all future examples. 
By

<em>variabalizing</em> the size values, they can be easily referenced throughout your code, as in the following:

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>   <code class="c1">// &lt;-- Here</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code> <code class="c1">// &lt;-- and here!</code>
Also, if you send me a petition to make “variabalize” a real word, I will gladly sign it.

<h3>Data-Driven Shapes</h3>
Time to add some shapes. 
I’ll bring back our trusty old dataset:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>
and then use <code class="literal">data()</code> to iterate through each data point, creating a <code class="literal">circle</code> for each one:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">);</code>
Remember, <code class="literal">selectAll()</code> will return empty references to all <code class="literal">circle</code>s (which don’t exist yet), <code class="literal">data()</code> binds our data to the elements we’re about to create, <code class="literal">enter()</code> returns a placeholder reference to the new element, and <code class="literal">append()</code> finally adds a <code class="literal">circle</code> to the DOM. 
In this case, it appends those <code class="literal">circle</code>s to the end of the SVG element, as our initial selection is our reference <code class="literal">svg</code> (as opposed to the document <code class="literal">body</code>, for example).

To make it easy to reference all of the <code class="literal">circle</code>s later, we can create a new variable to store references to them all:

<code class="kd">var</code> <code class="nx">circles</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>                  <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>                  <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>                  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">);</code>
Great, but all these circles still need positions and sizes, displayed in

<a class="xref" href="#Row_of_data_circles" title="Figure 6-11. Row of data circles">Figure 6-11</a>. 
Be warned, the following code might blow your mind:

<code class="nx">circles</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>             <code class="k">return</code> <code class="p">(</code><code class="nx">i</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code><code class="p">;</code>         <code class="p">})</code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>             <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>        <code class="p">});</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0611.png" alt="Row of data circles">
Figure 6-11. Row of data circles 
Feast your eyes on the demo

<em>10_drawing_svgs_circles.html</em>. 
Let’s step through the code, one line at a time:

<code class="nx">circles</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>             <code class="k">return</code> <code class="p">(</code><code class="nx">i</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code><code class="p">;</code>         <code class="p">})</code>
This takes the reference to all <code class="literal">circle</code>s and sets the <code class="literal">cx</code> attribute for each one. 
(Remember that, in SVG lingo, <code class="literal">cx</code> is the x position value of the

<em>center</em> of the circle.) Our data has already been bound to the <code class="literal">circle</code> elements, so for each <code class="literal">circle</code>, the value <code class="literal">d</code> matches the corresponding value in our original dataset (5, 10, 15, 20, or 25).

Another value, <code class="literal">i</code>, is also automatically populated for us. 
(Thanks, D3!)  Just as with <code class="literal">d</code>, the name <code class="literal">i</code> here is arbitrary and could be set to whatever you like, such as <code class="literal">counter</code> or <code class="literal">elementID</code>. 
 I prefer to use <code class="literal">i</code> because it is concise, it alludes to the convention of using <code class="literal">i</code> in <code class="literal">for</code> loops, and it is very common, as you’ll see it in all the online examples.

So, <code class="literal">i</code> is a numeric index value of the current element. 
Counting starts at zero, so for our “first” circle <code class="literal">i == 0</code>, the second circle’s <code class="literal">i == 1</code>, and so on. 
We’re using <code class="literal">i</code> to push each subsequent circle over to the right, because each subsequent loop through, the value of <code class="literal">i</code> increases by one:

<code class="p">(</code><code class="mi">0</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 25</code> <code class="p">(</code><code class="mi">1</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 75</code> <code class="p">(</code><code class="mi">2</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 125</code> <code class="p">(</code><code class="mi">3</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 175</code> <code class="p">(</code><code class="mi">4</code> <code class="o">*</code> <code class="mi">50</code><code class="p">)</code> <code class="o">+</code> <code class="mi">25</code>   <code class="c1">//Returns 225</code>
To make sure <code class="literal">i</code> is available to your custom function, you must include it as an argument in the function definition, <code class="literal">function(d, i)</code>. 
You must also include <code class="literal">d</code>, even if you don’t use <code class="literal">d</code> within your function (as in the preceding case). 
 This is because, again, the actual names used for these arguments are not important, but the total number of arguments (one or two) is.

Also, in case you’re feeling a surge of parameter anxiety, don’t worry. 
 You’ll only ever have to worry about <code class="literal">d</code> and <code class="literal">i</code>. 
 There are no additional anonymous function parameters to learn about later.

On to the next line:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code>
<code class="literal">cy</code> is the y position value of the center of each circle. 
We’re setting <code class="literal">cy</code> to <code class="literal">h</code> divided by two, or one-half of <code class="literal">h</code>. 
You’ll recall that <code class="literal">h</code> stores the height of the entire SVG, so <code class="literal">h/2</code> has the effect of aligning all <code class="literal">circle</code>s in the vertical center of the image:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code>
Finally, the radius <code class="literal">r</code> of each <code class="literal">circle</code> is simply set to <code class="literal">d</code>, the corresponding data value.

<h3>Pretty Colors, Oooh!</h3>
Color fills and strokes are just other attributes that you can set using

 the same methods. 
Simply by appending this code:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"yellow"</code><code class="p">)</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"orange"</code><code class="p">)</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="o">/</code><code class="mi">2</code><code class="p">;</code> <code class="p">});</code>
we get the colorful circles shown in

<a class="xref" href="#Colorful_data_circles" title="Figure 6-12. Colorful data circles">Figure 6-12</a>, as seen in

<em>11_drawing_svgs_color.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0612.png" alt="Colorful data circles">
Figure 6-12. Colorful data circles 

Try It Now!
Try modifying the values in <code class="literal">dataset</code> and the <code class="literal">fill</code> and <code class="literal">stroke</code> attribute values for <code class="literal">circles</code> at left to see how they affect the rendering of the circles at right:

<a href="http://examples.oreilly.com/0636920026938/chapter_06/11_drawing_svgs_color.html" target="_blank">11_drawing_svgs_color</a>

Of course, you can mix and match attributes and custom functions to apply any combination of properties. 
The trick with data visualization, of course, is choosing appropriate

<em>mappings</em>, so the visual expression of your data is understandable and useful for the viewer.

  

<h2>Making a Bar Chart</h2>
Now we’ll integrate everything we’ve learned so far to generate a simple bar chart as an SVG image.

We’ll start by adapting the <code class="literal">div</code> bar chart code to draw its bars with SVG instead, giving us more flexibility over the visual presentation. 
Then we’ll add labels, so we can see the data values clearly.

<h3>The Old Chart</h3>
See the <code class="literal">div</code> chart, updated with some new data, in

<em>12_making_a_bar_chart_divs.html</em>:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code>                 <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="kd">var</code> <code class="nx">barHeight</code> <code class="o">=</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">5</code><code class="p">;</code>         <code class="k">return</code> <code class="nx">barHeight</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">;</code>     <code class="p">});</code>
It might be hard to imagine, but we can definitely improve on the simple bar chart in

<a class="xref" href="#Bar_chart_with_divs" title="Figure 6-13. Bar chart with divs">Figure 6-13</a> made of <code class="literal">div</code>s.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0613.png" alt="Bar chart with divs">
Figure 6-13. Bar chart with <code class="literal">div</code>s  

<h3>The New Chart</h3>
First, we need to decide on the size of the new SVG:

<code class="c1">//Width and height</code> <code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code>
Of course, you could name <code class="literal">w</code> and <code class="literal">h</code> something else, like <code class="literal">svgWidth</code> and <code class="literal">svgHeight</code>. 
Use whatever is most clear to you. 
JavaScript programmers, as a group, are fixated on efficiency, so you’ll often see single-character variable names, code written with no spaces, and other hard-to-read, yet programmatically efficient, syntax.

Then, we tell D3 to create an empty SVG element and add it to the DOM:

<code class="c1">//Create SVG element</code> <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code>
To recap, this inserts a new <code class="literal">&lt;svg></code> element just before the closing <code class="literal">&lt;/body></code> tag, and assigns the SVG a width and height of 500 by 100 pixels. 
This statement also puts the result into our new variable called <code class="literal">svg</code>, so we can easily reference the new SVG without having to reselect it later using something like <code class="literal">d3.select("svg")</code>.

Next, instead of creating <code class="literal">div</code>s, we generate <code class="literal">rect</code>s and add them to <code class="literal">svg</code>:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>
This code selects all <code class="literal">rect</code>s inside of <code class="literal">svg</code>. 
Of course, there aren’t any yet, so an empty selection is returned. 
(Weird, yes, but stay with me. 
With D3, you always have to first select whatever it is you’re about to act on, even if that selection is momentarily empty.)

Then, <code class="literal">data(dataset)</code> sees that we have 20 values in the dataset, and those values are handed off to <code class="literal">enter()</code> for processing. 
 <code class="literal">enter()</code>, in turn, returns a placeholder selection for each data point that does not yet have a corresponding <code class="literal">rect</code>—which is to say, all of them.

For each of the 20 placeholders, <code class="literal">append("rect")</code> inserts a <code class="literal">rect</code> into the DOM. 
As we learned in

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>, every <code class="literal">rect</code> must have <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, and <code class="literal">height</code> values. 
We use <code class="literal">attr()</code> to add those attributes onto each newly created <code class="literal">rect</code>.

Beautiful, no? Okay, maybe not. 
All of the bars are there (check the DOM of

<em>13_making_a_bar_chart_rects.html</em> with your web inspector), but they all share the same <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, and <code class="literal">height</code> values, with the result that they all overlap (see

<a class="xref" href="#One_lonely_bar" title="Figure 6-14. One lonely bar">Figure 6-14</a>). 
This isn’t a visualization of data yet.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0614.png" alt="One lonely bar">
Figure 6-14. One lonely bar 
Let’s fix the overlap issue first. 
Instead of an <code class="literal">x</code> of <code class="literal">0</code>, we’ll assign a dynamic value that corresponds to <code class="literal">i</code>, or each value’s position in the dataset. 
So the first bar will be at <code class="literal">0</code>, but subsequent bars will be at <code class="literal">21</code>, then <code class="literal">42</code>, and so on. 
 (In a later chapter, we’ll learn about D3’s

<em>scales</em>, which offer a better, more flexible way to accomplish this same feat.)

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="mi">21</code><code class="p">;</code>  <code class="c1">//Bar width of 20 plus 1 for padding</code> <code class="p">})</code>
See that code in action with

<em>14_making_a_bar_chart_offset.html</em> and the result in

<a class="xref" href="#Twenty_bars" title="Figure 6-15. Twenty bars">Figure 6-15</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0615.png" alt="Twenty bars">
Figure 6-15. Twenty bars 
That works, but it’s not particularly flexible. 
If our dataset were longer, then the bars would just run off to the right, past the end of the SVG! Because each bar is 20 pixels wide, plus 1 pixel of padding, a 500-pixel wide SVG can only accommodate 23 data points. 
Note how the 24th bar gets clipped in

<a class="xref" href="#Twentyfour_bars" title="Figure 6-16. Twenty-four bars">Figure 6-16</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0616.png" alt="Twenty-four bars">
Figure 6-16. Twenty-four bars 
It’s good practice to use flexible, dynamic coordinates—heights, widths, x values, and y values—so your visualization can scale appropriately along with your data.

As with anything else in programming, there are a thousand ways to achieve that end. 
I’ll use a simple one. 
First, I’ll amend the line where we set each bar’s <code class="literal">x</code> position:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="p">})</code>
Notice how the <code class="literal">x</code> value is now tied directly to the width of the SVG (<code class="literal">w</code>) and the number of values in the dataset (<code class="literal">dataset.length</code>). 
This is exciting because now our bars will be evenly spaced, whether we have 20 data values, as in

<a class="xref" href="#Twenty_evenly_spaced_bars" title="Figure 6-17. Twenty evenly spaced bars">Figure 6-17</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0617.png" alt="Twenty evenly spaced bars">
Figure 6-17. Twenty evenly spaced bars 
Or only five, as in

<a class="xref" href="#Five_evenly_spaced_bars" title="Figure 6-18. Five evenly spaced bars">Figure 6-18</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0618.png" alt="Five evenly spaced bars">
Figure 6-18. Five evenly spaced bars 
See that code so far in

<em>15_making_a_bar_chart_even.html</em>.

Now we should set the bar

<em>widths</em> to be proportional, too, so they get narrower as more data is added, or wider when there are fewer values. 
I’ll add a new variable near where we set the SVG’s width and height:

<code class="c1">//Width and height</code> <code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">barPadding</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>  <code class="c1">// &lt;-- New!</code>
and then reference that variable in the line where we set each bar’s <code class="literal">width</code>. 
Instead of a static value of <code class="literal">20</code>, the width will now be set as a fraction of the SVG width and number of data points, minus a padding value:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">)</code>
It works! (See

<a class="xref" href="#Twenty_evenly_spaced_bars_with_dynamic_widths" title="Figure 6-19. Twenty evenly spaced bars with dynamic widths">Figure 6-19</a> and

<em>16_making_a_bar_chart_widths.html</em>.)

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0619.png" alt="Twenty evenly spaced bars with dynamic widths">
Figure 6-19. Twenty evenly spaced bars with dynamic widths 
The bar widths and x positions scale correctly whether there are 20 points, only 5 (see

<a class="xref" href="#Five_evenly_spaced_bars_with_dynamic_widths" title="Figure 6-20. Five evenly spaced bars with dynamic widths">Figure 6-20</a>), or even 100 (see

<a class="xref" href="#One_hundred_evenly_spaced_bars_with_dynamic_widths" title="Figure 6-21. One hundred evenly spaced bars with dynamic widths">Figure 6-21</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0620.png" alt="Five evenly spaced bars with dynamic widths">
Figure 6-20. Five evenly spaced bars with dynamic widths 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0621.png" alt="One hundred evenly spaced bars with dynamic widths">
Figure 6-21. One hundred evenly spaced bars with dynamic widths 
Finally, we encode our data as the

<em>height</em> of each bar. 
You would hope it were as easy as referencing the <code class="literal">d</code> data value when setting each bar’s <code class="literal">height</code>:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">});</code>
Hmm, the chart in

<a class="xref" href="#Dynamic_heights" title="Figure 6-22. Dynamic heights">Figure 6-22</a> looks funky. 
Maybe we can just scale up our numbers a bit?

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">;</code>  <code class="c1">// &lt;-- Times four!</code> <code class="p">});</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0622.png" alt="Dynamic heights">
Figure 6-22. Dynamic heights 
Alas, it is not that easy! We want our bars to grow upward from the bottom edge, not down from the top, as in

<a class="xref" href="#Dynamic_heights_magnified" title="Figure 6-23. Dynamic heights, magnified">Figure 6-23</a>—but don’t blame D3, blame SVG.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0623.png" alt="Dynamic heights, magnified">
Figure 6-23. Dynamic heights, magnified 
You’ll recall that, when drawing SVG <code class="literal">rect</code>s, the <code class="literal">x</code> and <code class="literal">y</code> values specify the coordinates of the

<em>upper-left corner</em>. 
That is, the origin or reference point for every <code class="literal">rect</code> is its top-left. 
For our purposes, it would be soooooo much easier to set the origin point as the bottom-left corner, but that’s just not how SVG does it, and frankly, SVG is pretty indifferent about our feelings on the matter.

Given that our bars do have to “grow down from the top,” then where is “the top” of each bar in relationship to the top of the SVG? Well, the top of each bar could be
expressed as a relationship between the height of the SVG and the corresponding data value, as in:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">d</code><code class="p">;</code>  <code class="c1">//Height minus data value</code> <code class="p">})</code>
Then, to put the “bottom” of the bar on the bottom of the SVG (see

<a class="xref" href="#Growing_down_from_above" title="Figure 6-24. Growing down from above">Figure 6-24</a>), each <code class="literal">rect</code>’s height can be just the data value itself:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>  <code class="c1">//Just the data value</code> <code class="p">});</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0624.png" alt="Growing down from above">
Figure 6-24. Growing down from above 
Let’s scale things up a bit by changing <code class="literal">d</code> to <code class="literal">d * 4</code>, with the result shown in

<a class="xref" href="#Growing_bigger_from_above" title="Figure 6-25. Growing bigger from above">Figure 6-25</a>. 
(Just as with the bar placements, this can be done more properly using D3 scales, but we’re not there yet.)

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0625.png" alt="Growing bigger from above">
Figure 6-25. Growing bigger from above 
The working code for our growing-down-from-above, SVG bar chart is in

<em>17_making_a_bar_chart_heights.html</em>.

Try It Now!
Try adding or deleting data points from <code class="literal">dataset</code> at left and see how the width of the bars adjusts at right. 
Then try adjusting the values of the data points and see the changes reflected in the height of the bars.

<a href="http://examples.oreilly.com/0636920026938/chapter_06/17_making_a_bar_chart_heights.html" target="_blank">17_making_a_bar_chart_heights</a>

<h3>Color</h3>
Adding color is easy. 
Just use <code class="literal">attr()</code> to set

 a <code class="literal">fill</code>:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"teal"</code><code class="p">);</code>
Find the all-teal bar chart shown in

<a class="xref" href="#Teal_bars" title="Figure 6-26. Teal bars">Figure 6-26</a> in

<em>18_making_a_bar_chart_teal.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0626.png" alt="Teal bars">
Figure 6-26. Teal bars 
Teal is nice, but you’ll often want a shape’s color to reflect some quality of the data. 
That is, you might want to

<em>encode</em> the data values as color. 
(In the case of our bar chart, that makes a

<em>dual encoding</em>, in which the same data value is encoded in two different visual properties: both height and color.)

Using data to drive color is as easy as writing a custom function that again references <code class="literal">d</code>. 
Here, we replace <code class="literal">"teal"</code> with a custom function, resulting in the chart in

<a class="xref" href="#Datadriven_blue_bars" title="Figure 6-27. Data-driven blue bars">Figure 6-27</a>:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0627.png" alt="Data-driven blue bars">
Figure 6-27. Data-driven blue bars 
See the code in

<em>19_making_a_bar_chart_blues.html</em>. 
This is not a particularly useful visual encoding, but you can get the idea of how to translate data into color. 
Here, <code class="literal">d</code> is multiplied by 10, and then used as the blue value in an <code class="literal">rgb()</code> color definition. 
So the greater values of <code class="literal">d</code> (taller bars) will be more blue. 
Smaller values of <code class="literal">d</code> (shorter bars) will be less blue (closer to black). 
The red and green components of the color are fixed at zero.

Multivalue Maps
You might have noticed we now have a total of

<em>five</em> different calls to <code class="literal">attr()</code> in the chain, one each to specify the bars’ <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, <code class="literal">height</code>, and <code class="literal">fill</code> values.

If you get tired of typing <code class="literal">attr()</code> over and over again, you might appreciate D3’s support for

<a class="ulink" href="http://bl.ocks.org/3305515" target="_top">

<em>multivalue maps</em></a>, with which you can set multiple
attribute values using a single <code class="literal">attr()</code> statement. 
 For example, to move a circle to the top-left corner of the SVG and make it red, I could use separate <code class="literal">attr()</code> statements:

<code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>
or I could define all three of these attributes and their values within a single object, which is then relayed to a single <code class="literal">attr()</code> statement:

<code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">({</code>         <code class="nx">cx</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>         <code class="nx">cy</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>         <code class="nx">fill</code><code class="o">:</code> <code class="nx">red</code>    <code class="p">});</code>
The resulting code is more concise, and if you’ve used jQuery, this syntax of tucking property/value pairs into objects might already be familiar. 
 The

<em>value</em> portion of each pair can include anonymous functions, referencing <code class="literal">d</code> and <code class="literal">i</code> to generate dynamic values, per usual. 
 We could rewrite our bar-creation code thus far using multivalue maps as:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">({</code>         <code class="nx">x</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="p">},</code>         <code class="nx">y</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">);</code> <code class="p">},</code>         <code class="nx">width</code><code class="o">:</code> <code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">,</code>         <code class="nx">height</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">;</code> <code class="p">},</code>         <code class="nx">fill</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">}</code>    <code class="p">});</code>
If you like this sort of thing, you’ll be happy to know it also works with <code class="literal">style()</code> and

<a class="ulink" href="http://bl.ocks.org/3305515" target="_top">a few other methods</a>. 
 Throughout this book, I’ve used the more verbose structure of individual attribute statements, but it’s always good to know you have options.
  

<h3>Labels</h3>
Visuals are great, but sometimes you need to show the actual data values as text within the visualization. 
Here’s where value labels come in, and they are very, very easy to generate with D3.

You’ll recall from the SVG primer that you can add <code class="literal">text</code> elements to an SVG element. 
Let’s start with:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
Look familiar? Just as we did for the <code class="literal">rect</code>s, here we do for the <code class="literal">text</code>s. 
First, select what you want, bring in the data, enter the new elements (which are just placeholders at this point), and finally append the new <code class="literal">text</code> elements to the DOM.

We’ll extend that code to include a data value within each <code class="literal">text</code> element by using the <code class="literal">text()</code> method:

   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">})</code>
and then extend it further, by including <code class="literal">x</code> and <code class="literal">y</code> values to position the text. 
It’s easiest if I just copy and paste the same x/y code we previously used for the bars:

   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">);</code>    <code class="p">});</code>
Aha! Value labels! But some are getting cut off at the top (see

<a class="xref" href="#Baby_value_labels" title="Figure 6-28. Baby value labels!">Figure 6-28</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0628.png" alt="Baby value labels!">
Figure 6-28. Baby value labels! 
Let’s try moving them down, inside the bars, by adding a small amount to the <code class="literal">x</code> and <code class="literal">y</code> calculations:

   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="o">+</code> <code class="mi">5</code><code class="p">;</code>  <code class="c1">// +5</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">)</code> <code class="o">+</code> <code class="mi">15</code><code class="p">;</code>              <code class="c1">// +15</code>    <code class="p">});</code>
The chart in

<a class="xref" href="#Inbar_value_labels" title="Figure 6-29. In-bar value labels">Figure 6-29</a> is better, but not legible.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0629.png" alt="In-bar value labels">
Figure 6-29. In-bar value labels 
Fortunately, we can fix that:

   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-family"</code><code class="p">,</code> <code class="s2">"sans-serif"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"11px"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"white"</code><code class="p">);</code>
Fantasti-code! See

<em>20_making_a_bar_chart_labels.html</em> for the brilliant visualization shown in

<a class="xref" href="#Really_nice_value_labels" title="Figure 6-30. Really nice value labels">Figure 6-30</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0630.png" alt="Really nice value labels">
Figure 6-30. Really nice value labels 
If you are not typographically obsessive, then you’re all done. 
If, however, you are like me, you’ll notice that the value labels aren’t perfectly aligned within their bars. 
(For example, note the “5” in the first column.) That’s easy enough to fix. 
Let’s use the SVG <code class="literal">text-anchor</code> attribute to center the text horizontally at the assigned <code class="literal">x</code> value:

    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
Then, let’s change the way we calculate the <code class="literal">x</code> position by setting it to the left edge of each bar

<em>plus</em> half the bar width:

    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="o">+</code> <code class="p">(</code><code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>     <code class="p">})</code>
And I’ll also bring the labels up one pixel for perfect spacing, as you can see in

<a class="xref" href="#Centered_labels" title="Figure 6-31. Centered labels">Figure 6-31</a> and

<em>21_making_a_bar_chart_aligned.html</em>:

    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">4</code><code class="p">)</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code>  <code class="c1">//15 is now 14</code>     <code class="p">})</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0631.png" alt="Centered labels">
Figure 6-31. Centered labels 

Try It Now!
Experiment with the code for the final bar chart below. 
Adjust the code at left and see the chart output at right.

<a href="http://examples.oreilly.com/0636920026938/chapter_06/21_making_a_bar_chart_aligned.html" target="_blank">21_making_a_bar_chart_aligned</a>

<h2>Making a Scatterplot</h2>
So far, we’ve drawn only bar charts with simple data—just one-dimensional sets of numbers.

But when you have two sets of values to plot against each other, you need a second dimension. 
The scatterplot is a common type of visualization that represents two sets of corresponding values on two different axes: horizontal and vertical, x and y.

<h3>The Data</h3>
As you saw in

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>, you have a lot of flexibility around how to structure a dataset. 
For our scatterplot, I’m going to use an array of arrays. 
The primary array will contain one element for each data “point.” Each of those “point” elements will be another array, with just two values: one for the x value, and one for y:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                 <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">20</code><code class="p">],</code> <code class="p">[</code><code class="mi">480</code><code class="p">,</code> <code class="mi">90</code><code class="p">],</code> <code class="p">[</code><code class="mi">250</code><code class="p">,</code> <code class="mi">50</code><code class="p">],</code> <code class="p">[</code><code class="mi">100</code><code class="p">,</code> <code class="mi">33</code><code class="p">],</code> <code class="p">[</code><code class="mi">330</code><code class="p">,</code> <code class="mi">95</code><code class="p">],</code>                 <code class="p">[</code><code class="mi">410</code><code class="p">,</code> <code class="mi">12</code><code class="p">],</code> <code class="p">[</code><code class="mi">475</code><code class="p">,</code> <code class="mi">44</code><code class="p">],</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">67</code><code class="p">],</code> <code class="p">[</code><code class="mi">85</code><code class="p">,</code> <code class="mi">21</code><code class="p">],</code> <code class="p">[</code><code class="mi">220</code><code class="p">,</code> <code class="mi">88</code><code class="p">]</code>               <code class="p">];</code>
Remember, <code class="literal">[]</code> means array, so nested hard brackets <code class="literal">[[]]</code> indicate an array within another array. 
We separate array elements with commas, so an array containing three other arrays would look like this: <code class="literal">[[],[],[]]</code>.

We could rewrite our dataset with more whitespace so it’s easier to read:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                   <code class="p">[</code> <code class="mi">5</code><code class="p">,</code>     <code class="mi">20</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">480</code><code class="p">,</code>   <code class="mi">90</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">250</code><code class="p">,</code>   <code class="mi">50</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">100</code><code class="p">,</code>   <code class="mi">33</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">330</code><code class="p">,</code>   <code class="mi">95</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">410</code><code class="p">,</code>   <code class="mi">12</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">475</code><code class="p">,</code>   <code class="mi">44</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">25</code><code class="p">,</code>    <code class="mi">67</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">85</code><code class="p">,</code>    <code class="mi">21</code> <code class="p">],</code>                   <code class="p">[</code> <code class="mi">220</code><code class="p">,</code>   <code class="mi">88</code> <code class="p">]</code>               <code class="p">];</code>
Now you can see that each of these 10 rows will correspond to one point in our visualization. 
With the row <code class="literal">[5, 20]</code>, for example, we’ll use <code class="literal">5</code> as the x value, and <code class="literal">20</code> for the y.

<h3>The Scatterplot</h3>
Let’s carry over most of the code from our bar chart experiments, including the piece that creates the SVG element:

<code class="c1">//Create SVG element</code> <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code>
Instead of creating <code class="literal">rect</code>s, however, we’ll make a <code class="literal">circle</code> for each data point:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>  <code class="c1">// &lt;-- No longer "rect"</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>     <code class="c1">// &lt;-- No longer "rect"</code>
Also, instead of specifying the <code class="literal">rect</code> attributes of <code class="literal">x</code>, <code class="literal">y</code>, <code class="literal">width</code>, and <code class="literal">height</code>, our <code class="literal">circle</code>s need <code class="literal">cx</code>, <code class="literal">cy</code>, and <code class="literal">r</code>:

   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>
See the working scatterplot code that recreates the result shown in

<a class="xref" href="#Simple_scatterplot" title="Figure 6-32. Simple scatterplot">Figure 6-32</a> in

<em>22_scatterplot.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0632.png" alt="Simple scatterplot">
Figure 6-32. Simple scatterplot 
Notice how we access the data values and use them for the <code class="literal">cx</code> and <code class="literal">cy</code> values. 
When using <code class="literal">function(d)</code>, D3 automatically hands off the current data value as <code class="literal">d</code> to your function. 
In this case, the current data value is one of the smaller, subarrays in our larger <code class="literal">dataset</code> array.

When each single datum <code class="literal">d</code> is itself an array of values (and not just a single value, like <code class="literal">3.14159</code>), you need to use bracket notation to access its values. 
Hence, instead of <code class="literal">return d</code>, we use <code class="literal">return d[0]</code> and <code class="literal">return d[1]</code>, which return the first and second values of the array, respectively.

For example, in the case of our first data point <code class="literal">[5, 20]</code>, the first value (array position <code class="literal">0</code>) is <code class="literal">5</code>, and the second value (array position <code class="literal">1</code>) is <code class="literal">20</code>. 
Thus:

d[0] returns 5 d[1] returns 20
By the way, if you ever want to access any value in the larger dataset (outside of D3, say), you can do so using bracket notation. 
For example:

dataset[5] returns [410, 12]
You can even use multiple sets of brackets to access values within nested arrays:

dataset[5][1] returns 12
Don’t believe me? Take another look at the scatterplot page

<em>22_scatterplot.html</em>, open your JavaScript console, type in

<strong><code class="literal">dataset[5]</code></strong> or

<strong><code class="literal">dataset[5][1]</code></strong>, and see what happens.

Try It Now!
Enter the following statements in the JavaScript console below and see the results:

 <code class="literal">dataset</code>  <code class="literal">dataset[5]</code>  <code class="literal">dataset[5][1]</code>  

<h3>Size</h3>
Maybe you want the circles to be different sizes, so each circle’s area corresponds to its y value. 
 As a general rule, when visualizing quantitative values with circles, make sure to encode the values as

<em>area</em>, not as a circle’s

<em>radius</em>. 
 Perceptually, we understand the overall amount of “ink” or pixels to reflect the data value. 
 A common mistake is to map the value to the radius. 
 (I’ve done this many times myself.)  Mapping to the radius is easier to do, as it requires less math, but the result will visually distort your data.

Yet when creating SVG circles, we can’t specify an <code class="literal">area</code> value; we have to calculate the radius <code class="literal">r</code> and then set that. 
 So, starting with a data value as area, how do we get to a radius value?

You might remember that the area of a circle equals π times the radius squared, or
A = πr
<sup>2</sup>.

Let’s say the area, then, is our data value, which is <code class="literal">d[1]</code>, in this case. 
 Actually, let’s subtract that value from <code class="literal">h</code>, so the circles at the top are larger. 
 So our

<em>area</em> value is <code class="literal">h - d[1]</code>. 
 (We’ll cover a cleaner way to achieve this effect using scales in

<a class="xref" href="" title="Chapter 7. Scales">Chapter 7</a>.)

To convert this area to a radius value, we simply have to take its square root. 
 We can do that using JavaScript’s built-in <code class="literal">Math.sqrt()</code> function, as in <code class="literal">Math.sqrt(h - d[1])</code>.

Now, instead of setting all <code class="literal">r</code> values to the static value of <code class="literal">5</code>, try:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">});</code>
See

<em>23_scatterplot_sqrt.html</em> for the code that results in the scatterplot shown in

<a class="xref" href="#Scatterplot_with_sized_circles" title="Figure 6-33. Scatterplot with sized circles">Figure 6-33</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0633.png" alt="Scatterplot with sized circles">
Figure 6-33. Scatterplot with sized circles 
After arbitrarily subtracting the datum’s y value <code class="literal">d[1]</code> from the SVG height <code class="literal">h</code>, and then taking the square root, we see that circles with greater y values (those circles lower down) have smaller areas (and shorter radii).

This particular use of circle area as a visualization tool isn’t necessarily useful. 
 I simply want to illustrate how you can use <code class="literal">d</code>, along with bracket notation, to reference an individual datum, apply some transformation to that value, and use the newly calculated value to

<em>return</em> a value back to the attribute-setting method (a value used for <code class="literal">r</code>, in this case).

<h3>Labels</h3>
Let’s label our data points with <code class="literal">text</code> elements. 
I’ll adapt the label code from our bar chart experiments, starting with the following:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>  <code class="c1">// &lt;-- Note "text", not "circle" or "rect"</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>     <code class="c1">// &lt;-- Same here!</code>
This looks for all <code class="literal">text</code> elements in the SVG (there aren’t any yet), and then appends a new <code class="literal">text</code> element for each data point. 
Then we use the <code class="literal">text()</code> method to specify each element’s contents:

   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>    <code class="p">})</code>
This looks messy, but bear with me. 
Once again, we’re using <code class="literal">function(d)</code> to access each data point. 
Then, within the function, we’re using

<em>both</em> <code class="literal">d[0]</code>

<em>and</em> <code class="literal">d[1]</code> to get both values within that data point array.

The plus <code class="literal">+</code> symbols, when used with strings, such as the comma between quotation marks <code class="literal">","</code>, act as

<em>append</em> operators. 
So what this one line of code is really saying is this: get the values of <code class="literal">d[0]</code> and <code class="literal">d[1]</code> and smush them together with a comma in the middle. 
The end result should be something like <code class="literal">5,20</code> or <code class="literal">25,67</code>.

Next, we specify

<em>where</em> the text should be placed with <code class="literal">x</code> and <code class="literal">y</code> values. 
For now, let’s just use <code class="literal">d[0]</code> and <code class="literal">d[1]</code>, the same values that we used to specify the <code class="literal">circle</code> positions:

   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>    <code class="p">})</code>
Finally, add a bit of font styling with:

   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-family"</code><code class="p">,</code> <code class="s2">"sans-serif"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"11px"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>
The result in

<a class="xref" href="#Scatterplot_with_labels" title="Figure 6-34. Scatterplot with labels">Figure 6-34</a> might not be pretty, but we got it working! See

<em>24_scatterplot_labels.html</em> for the latest.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0634.png" alt="Scatterplot with labels">
Figure 6-34. Scatterplot with labels 

Try It Now!
Experiment with the code for the scatterplot below. 
Adjust the code at left and see the chart output at right.

<a href="http://examples.oreilly.com/0636920026938/chapter_06/24_scatterplot_labels.html" target="_blank">24_scatterplot_labels</a>

<h2>Next Steps</h2>
Hopefully, some core concepts of D3 are becoming clear: loading data, generating new elements, and using data values to derive attribute values for those elements.

Yet the image in

<a class="xref" href="#Scatterplot_with_labels" title="Figure 6-34. Scatterplot with labels">Figure 6-34</a> is barely passable as a data visualization. 
The scatterplot is hard to read, and the code doesn’t use our data flexibly. 
To be honest, we haven’t yet improved on—gag—Excel’s

<em>Chart Wizard!</em>

Not to worry: D3 is way cooler than Chart Wizard (not to mention Clippy), but generating a shiny, interactive chart involves taking our D3 skills to the next level. 
To use data flexibly, we’ll learn about D3’s

<em>scales</em> in the next chapter. 
And to make our scatterplot easier to read, we’ll learn about

<em>axis generators</em> and axis labels.

This would be a good time to take a break and stretch your legs. 
Maybe go for a walk, or grab a coffee or a sandwich. 
I’ll hang out here (if you don’t mind), and when you get back, we’ll jump into D3 scales!

<h1><span class="orange">Chapter 7. Scales</span></h1>
“Scales are functions that map from an input domain to an output range.”

That’s

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales" target="_top">Mike Bostock’s definition of D3 scales</a>, and there is no clearer way to say it.

The values in any dataset are unlikely to correspond exactly to pixel measurements for use in your visualization. 
Scales provide a convenient way to map those data values to new values useful for visualization purposes.

D3 scales are

<em>functions</em> with parameters that you define. 
Once they are created, you call the <code class="literal">scale</code> function, pass it a data value, and it nicely returns a scaled output value. 
You can define and use as many scales as you like.

It might be tempting to think of a scale as something that appears visually in the final image—like a set of tick marks, indicating a progression of values.

<em>Do not be fooled!</em> Those tick marks are part of an

<em>axis</em>, which is a

<em>visual representation</em> of a scale. 
A scale is a mathematical relationship, with no direct visual output. 
I encourage you to think of scales and axes as two different, yet related, elements.

This chapter addresses only

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear" target="_top">

<em>linear</em></a> scales, because they are most common and easiest understood. 
Once you understand linear scales, the others—ordinal, logarithmic, square root, and so
on—will be a piece of cake.

<h2>Apples and Pixels</h2>
Imagine that the following dataset represents the number of apples sold at a roadside fruit stand each month:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">100</code><code class="p">,</code> <code class="mi">200</code><code class="p">,</code> <code class="mi">300</code><code class="p">,</code> <code class="mi">400</code><code class="p">,</code> <code class="mi">500</code> <code class="p">];</code>
First of all, this is great news, as the stand is selling 100 additional apples each month! Business is booming. 
To showcase this success, you want to make a bar chart illustrating the steep upward climb of apple sales, with each data value corresponding to the height of one bar.

Until now, we’ve used data values directly as display values, ignoring unit differences. 
So if 500 apples were sold, the corresponding bar would be 500 pixels tall.

That could work, but what about next month, when 600 apples are sold? And a year later, when 1,800 apples are sold? Your audience would have to purchase ever-larger displays just to be able to see the full height of those very tall apple bars! (Mmm, apple bars!)

This is where scales come in. 
Because apples are not pixels (which are also not oranges), we need scales to translate between them.

<h2>Domains and Ranges</h2>
A scale’s

<em>input domain</em> is the range of possible input data values. 
Given the preceding apples data, appropriate input domains would be either 100 and 500 (the minimum and maximum values of the dataset) or 0 and 500.

A scale’s

<em>output range</em> is the range of possible output values, commonly used as display values in pixel units. 
The output range is completely up to you, as the information designer. 
If you decide the shortest apple bar will be 10 pixels tall, and the tallest will be 350 pixels tall, then you could set an output range of 10 and 350.

For example, create a scale with an input domain of <code class="literal">[100,500]</code> and an output range of <code class="literal">[10,350]</code>. 
If you handed the low input value of <code class="literal">100</code> to that scale, it would return its lowest range value, <code class="literal">10</code>. 
If you gave it <code class="literal">500</code>, it would spit back <code class="literal">350</code>. 
If you gave it <code class="literal">300</code>, it would hand <code class="literal">180</code> back to you on a silver platter. 
(<code class="literal">300</code> is in the center of the domain, and <code class="literal">180</code> is in the center of the range.)

We can visualize the domain and range as corresponding axes, side-by-side, displayed in

<a class="xref" href="#input_output_axes" title="Figure 7-1. An input domain and an output range, visualized as parallel axes">Figure 7-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0701.png" alt="An input domain and an output range, visualized as parallel axes">
Figure 7-1. An input domain and an output range, visualized as parallel axes 
One more thing: to prevent your brain from mixing up the

<em>input domain</em> and

<em>output range</em> terminology, I’d like to propose a little exercise. 
When I say “input,” you say “domain.” Then I say “output,” and you say “range.” Ready? Okay:

<blockquote class="blockquote">
Input! Domain!
</blockquote>

<blockquote class="blockquote">
Output! Range!
</blockquote>

<blockquote class="blockquote">
Input! Domain!
</blockquote>

<blockquote class="blockquote">
Output! Range!
</blockquote>
Got it? Great.

<h2>Normalization</h2>
If you’re familiar with the concept of

<em>normalization</em>, it might be helpful to know that, with a linear scale, that’s all that is really going on here.

Normalization is the process of mapping a numeric value to a new value between 0 and 1, based on the possible minimum and maximum values. 
For example, with 365 days in the year, day number 310 maps to about 0.85, or 85 percent of the way through the year.

With linear scales, we are just letting D3 handle the math of the normalization process. 
The input value is normalized according to the domain, and then the normalized value is scaled to the output range.

<h2>Creating a Scale</h2>
D3’s scale function generators are accessed with <code class="literal">d3.scale</code> followed by

 the type of scale you want. 
I recommend opening up the sample code page

<em>01_scale_test.html</em> and typing each of the following into the console:

<code class="kd">var</code> <code class="nx">scale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">();</code>
Congratulations! Now <code class="literal">scale</code> is a function to which you can pass input values. 
(Don’t be misled by the <code class="literal">var</code>. 
Remember that in JavaScript, variables can store functions.)

<code class="nx">scale</code><code class="p">(</code><code class="mf">2.5</code><code class="p">);</code>  <code class="c1">//Returns 2.5</code>
Because we haven’t set a domain and a range yet, this function will map input to output on a 1:1 scale. 
That is, whatever we input will be returned unchanged.

We can set the scale’s input domain to <code class="literal">100,500</code> by passing those values to the
<code class="literal">domain()</code> method as an array. 
Note the hard brackets indicating an array:

<code class="nx">scale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">100</code><code class="p">,</code> <code class="mi">500</code><code class="p">]);</code>
Set the output range in similar fashion, with <code class="literal">range()</code>:

<code class="nx">scale</code><code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">10</code><code class="p">,</code> <code class="mi">350</code><code class="p">]);</code>
These steps can be done separately, as just shown, or chained together into one line of code:

<code class="kd">var</code> <code class="nx">scale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                     <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">100</code><code class="p">,</code> <code class="mi">500</code><code class="p">])</code>                     <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">10</code><code class="p">,</code> <code class="mi">350</code><code class="p">]);</code>
Either way, our scale is ready to use!

<code class="nx">scale</code><code class="p">(</code><code class="mi">100</code><code class="p">);</code>  <code class="c1">//Returns 10</code> <code class="nx">scale</code><code class="p">(</code><code class="mi">300</code><code class="p">);</code>  <code class="c1">//Returns 180</code> <code class="nx">scale</code><code class="p">(</code><code class="mi">500</code><code class="p">);</code>  <code class="c1">//Returns 350</code>

Try It Now!
Try entering the following <code class="literal">scale</code> statements in the console below to see the results:

 <code class="literal">scale(200);</code>  <code class="literal">scale(450.5);</code>  <code class="literal">scale(-100);</code>  

Typically, you will call scale functions from within an <code class="literal">attr()</code> method or similar, not on their own. 
Let’s modify our scatterplot visualization to use dynamic scales.


<h2>Scaling the Scatterplot</h2>
To revisit our dataset from the scatterplot:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                 <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">20</code><code class="p">],</code> <code class="p">[</code><code class="mi">480</code><code class="p">,</code> <code class="mi">90</code><code class="p">],</code> <code class="p">[</code><code class="mi">250</code><code class="p">,</code> <code class="mi">50</code><code class="p">],</code> <code class="p">[</code><code class="mi">100</code><code class="p">,</code> <code class="mi">33</code><code class="p">],</code> <code class="p">[</code><code class="mi">330</code><code class="p">,</code> <code class="mi">95</code><code class="p">],</code>                 <code class="p">[</code><code class="mi">410</code><code class="p">,</code> <code class="mi">12</code><code class="p">],</code> <code class="p">[</code><code class="mi">475</code><code class="p">,</code> <code class="mi">44</code><code class="p">],</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">67</code><code class="p">],</code> <code class="p">[</code><code class="mi">85</code><code class="p">,</code> <code class="mi">21</code><code class="p">],</code> <code class="p">[</code><code class="mi">220</code><code class="p">,</code> <code class="mi">88</code><code class="p">]</code>               <code class="p">];</code>
You’ll recall that this <code class="literal">dataset</code> is an array of arrays. 
We mapped the first value in each array onto the x-axis, and the second value onto the y-axis. 
Let’s start with the x-axis.

Just by eyeballing the x values, it looks like they range from 5 to 480, so a reasonable input domain to specify might be <code class="literal">0,500</code>, right?

Why are you giving me that look? Oh, because you want to keep your code flexible and scalable, so it will continue to work even if the data changes in the future. 
Very smart! Remember, if we were building a data dashboard for the roadside apple stand, we’d want our code to accommodate the enormous projected growth in apple sales. 
Our chart should work just as well with 5 apples sold as 5 million.

<h3>d3.min() and d3.max()</h3>
Instead of specifying fixed values for the domain, we can use the convenient array functions <code class="literal">d3.min()</code> and <code class="literal">d3.max()</code> to analyze our data set on the fly. 
For example, this loops through each of the x values in our arrays and returns the value of the greatest one:

<code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>  <code class="c1">//References first value in each subarray</code> <code class="p">});</code>
That code will return the value 480, because 480 is the largest x value in our dataset. 
 Let me explain how it works.

Both <code class="literal">min()</code> and <code class="literal">max()</code> work the same way, and they can take either one or two arguments. 
The first argument must be a reference to the array of values you want evaluated, which is <code class="literal">dataset</code>, in this case. 
If you have a simple, one-dimensional array of numeric values, like <code class="literal">[7, 8, 4, 5, 2]</code>, then it’s obvious how to compare the values against each other, and no second argument is needed. 
For example:

<code class="kd">var</code> <code class="nx">simpleDataset</code> <code class="o">=</code> <code class="p">[</code><code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">2</code><code class="p">];</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">simpleDataset</code><code class="p">);</code>  <code class="c1">// Returns 8</code>
The <code class="literal">max()</code> function simply loops through each value in the array, and identifies the largest one.

But our <code class="literal">dataset</code> is not just an array of numbers; it is an array of arrays. 
Calling <code class="literal">d3.max(dataset)</code> might produce unexpected results:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>                 <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">20</code><code class="p">],</code> <code class="p">[</code><code class="mi">480</code><code class="p">,</code> <code class="mi">90</code><code class="p">],</code> <code class="p">[</code><code class="mi">250</code><code class="p">,</code> <code class="mi">50</code><code class="p">],</code> <code class="p">[</code><code class="mi">100</code><code class="p">,</code> <code class="mi">33</code><code class="p">],</code> <code class="p">[</code><code class="mi">330</code><code class="p">,</code> <code class="mi">95</code><code class="p">],</code>                 <code class="p">[</code><code class="mi">410</code><code class="p">,</code> <code class="mi">12</code><code class="p">],</code> <code class="p">[</code><code class="mi">475</code><code class="p">,</code> <code class="mi">44</code><code class="p">],</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">67</code><code class="p">],</code> <code class="p">[</code><code class="mi">85</code><code class="p">,</code> <code class="mi">21</code><code class="p">],</code> <code class="p">[</code><code class="mi">220</code><code class="p">,</code> <code class="mi">88</code><code class="p">]</code>               <code class="p">];</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code>  <code class="c1">// Returns [85, 21]. 
 What???</code>
To tell <code class="literal">max()</code> which

<em>specific</em> values we want compared, we must include a second argument, an

<em>accessor function</em>:

<code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">});</code>
The accessor function is an anonymous function to which <code class="literal">max()</code> hands

 off each value in the data array, one at a time, as <code class="literal">d</code>. 
The accessor function specifies

<em>how to access</em> the value to be used for the comparison. 
In this case, our data array is <code class="literal">dataset</code>, and we want to compare only the x values, which are the first values in each subarray, meaning in position <code class="literal">[0]</code>. 
So our accessor function looks like this:

<code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>  <code class="c1">//Return the first value in each subarray</code> <code class="p">}</code>
Note that this looks suspiciously similar to the syntax we used when generating our scatterplot circles, which also used anonymous functions to retrieve and return values:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">})</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})</code>
This is a common D3 pattern. 
Soon you will be very comfortable with all manner of anonymous functions crawling all over your code.

<h3>Setting Up Dynamic Scales</h3>
Putting together what we’ve covered, let’s create the scale function for

 our x-axis:

<code class="kd">var</code> <code class="nx">xScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">})])</code>                      <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">]);</code>
First, notice that I named it <code class="literal">xScale</code>. 
Of course, you can name your scales whatever you want, but a name like <code class="literal">xScale</code> helps me remember what this function does.

Second, notice that both the domain and range are specified as two-value arrays in hard brackets.

Third, notice that I set the low end of the input domain to 0. 
(Alternatively, you could use <code class="literal">min()</code> to calculate a dynamic value.) The upper end of the domain is set to the maximum value in <code class="literal">dataset</code> (which is currently 480, but could change in the future).

Finally, observe that the output range is set to <code class="literal">0</code> and <code class="literal">w</code>, the SVG’s width.

We’ll use very similar code to create the scale function for the y-axis:

<code class="kd">var</code> <code class="nx">yScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})])</code>                      <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code>
Note that the <code class="literal">max()</code> function here references <code class="literal">d[1]</code>, the y value of each subarray. 
Also, the upper end of <code class="literal">range()</code> is set to <code class="literal">h</code> instead of <code class="literal">w</code>.

The scale functions are in place! Now all we need to do is use them.

<h3>Incorporating Scaled Values</h3>
Revisiting our scatterplot code, we now simply modify the original line

 where we created a <code class="literal">circle</code> for each data value:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>  <code class="c1">//Returns original value bound from dataset</code> <code class="p">})</code>
to return a scaled value (instead of the original value):

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>  <code class="c1">//Returns scaled value</code> <code class="p">})</code>
Likewise, for the y-axis, this:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})</code>
is modified as:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">})</code>
For good measure, let’s make the same change where we set the coordinates for the text labels, so these lines:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code> <code class="p">})</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})</code>
become this:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code> <code class="p">})</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">})</code>
And there we are!

Check out the working code in

<em>02_scaled_plot.html</em>. 
Visually, the result in

<a class="xref" href="#Scatterplot_using_x_and_y_scales" title="Figure 7-2. Scatterplot using x and y scales">Figure 7-2</a> is disappointingly similar to our original scatterplot! Yet we are making more progress than might be apparent.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0702.png" alt="Scatterplot using x and y scales">
Figure 7-2. Scatterplot using x and y scales 

Try It Now!
Experiment with the code for the scatterplot below. 
Adjust the <code class="literal">w</code> and <code class="literal">h</code> values to see the effect on the scale. 
Do the same with the dataset values.

<a href="http://examples.oreilly.com/0636920026938/chapter_07/02_scaled_plot.html" target="_blank">02_scaled_plot</a>

<h2>Refining the Plot</h2>
You might have noticed that smaller y values are at the top of the plot, and the larger y values are toward the bottom. 
Now that we’re using D3 scales, it’s super easy to reverse that, so greater values are higher up, as you would expect. 
It’s just a matter of changing the output range of <code class="literal">yScale</code> from:

<code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code>
to:

<code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">h</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
See

<em>03_scaled_plot_inverted.html</em> for the code that results in

<a class="xref" href="#Scatterplot_with_y_scale_inverted" title="Figure 7-3. Scatterplot with y scale inverted">Figure 7-3</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0703.png" alt="Scatterplot with y scale inverted">
Figure 7-3. Scatterplot with y scale inverted 
Yes, now a

<em>smaller</em> input to <code class="literal">yScale</code> will produce a

<em>larger</em> output value, thereby pushing those <code class="literal">circle</code>s and <code class="literal">text</code> elements down, closer to the base of the image. 
I know, it’s almost too easy!

Yet some elements are getting cut off. 
Let’s introduce a <code class="literal">padding</code> variable:

<code class="kd">var</code> <code class="nx">padding</code> <code class="o">=</code> <code class="mi">20</code><code class="p">;</code>
Then we’ll incorporate the <code class="literal">padding</code> amount when setting the range of both scales. 
This will help push our elements in, away from the edges of the SVG, to prevent them from being clipped.

The range for <code class="literal">xScale</code> was <code class="literal">range([0, w])</code>, but now it’s:

<code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">padding</code><code class="p">,</code> <code class="nx">w</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">]);</code>
The range for <code class="literal">yScale</code> was <code class="literal">range([h, 0])</code>, but now it’s:

<code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">,</code> <code class="nx">padding</code><code class="p">]);</code>
This should provide us with 20 pixels of extra room on the left, right, top, and bottom edges of the SVG. 
And it does (see

<a class="xref" href="#Scatterplot_with_padding" title="Figure 7-4. Scatterplot with padding">Figure 7-4</a>)!

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0704.png" alt="Scatterplot with padding">
Figure 7-4. Scatterplot with padding 
But the text labels on the far right are still getting cut off, so I’ll double the amount of <code class="literal">xScale</code>’s padding on the right side by multiplying by two to achieve the result shown in

<a class="xref" href="#Scatterplot_with_more_padding" title="Figure 7-5. Scatterplot with more padding">Figure 7-5</a>:

<code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">padding</code><code class="p">,</code> <code class="nx">w</code> <code class="o">-</code> <code class="nx">padding</code> <code class="o">*</code> <code class="mi">2</code><code class="p">]);</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0705.png" alt="Scatterplot with more padding">
Figure 7-5. Scatterplot with more padding 

The way I’ve introduced padding here is simple, but not elegant. 
 Eventually, you’ll want more control over how much padding is on each side of your charts (top, right, bottom, left), and it’s useful to standardize how you specify those values across projects. 
 Although I haven’t used

<a class="ulink" href="http://bl.ocks.org/3019563" target="_top">Mike Bostock’s margin convention</a> for the code samples in this book, I recommend taking a look to see if it could work for you.

Better! Reference the code so far in

<em>04_scaled_plot_padding.html</em>. 
But there’s one more change I’d like to make. 
Instead of setting the radius of each <code class="literal">circle</code> as the square root of its y value (which was a bit of a hack, and not visually useful), why not create another custom scale?

<code class="kd">var</code> <code class="nx">rScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code> <code class="p">})])</code>                      <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">2</code><code class="p">,</code> <code class="mi">5</code><code class="p">]);</code>
Then, setting the radius looks like this:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">rScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code> <code class="p">});</code>
This is exciting because we are guaranteeing that our radius values will

<em>always</em> fall within the range of <code class="literal">2,5</code>. 
(Or

<em>almost</em> always; see reference to <code class="literal">clamp()</code> later.) So data values of <code class="literal">0</code> (the minimum input) will get circles of radius <code class="literal">2</code> (or a diameter of 4 pixels). 
The very largest data value will get a circle of radius <code class="literal">5</code> (diameter of 10 pixels).

Voila:

<a class="xref" href="#Scatterplot_with_scaled_radii" title="Figure 7-6. Scatterplot with scaled radii">Figure 7-6</a> shows our first scale used for a visual property other than an axis value. 
(See

<em>05_scaled_plot_radii.html</em>.)

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0706.png" alt="Scatterplot with scaled radii">
Figure 7-6. Scatterplot with scaled radii 
Finally, just in case the power of scales hasn’t yet blown your mind, I’d like to add one more array to the dataset: <code class="literal">[600, 150]</code>.

Boom! Check out

<em>06_scaled_plot_big.html</em>. 
Notice how all the old points in

<a class="xref" href="#Scatterplot_with_big_numbers_added" title="Figure 7-7. Scatterplot with big numbers added">Figure 7-7</a> maintained their relative positions but have migrated closer together, down and to the left, to accommodate the newcomer in the top-right corner.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0707.png" alt="Scatterplot with big numbers added">
Figure 7-7. Scatterplot with big numbers added 
And now, one final revelation: we can now very easily change the size of our SVG, and

<em>everything scales accordingly</em>. 
In

<a class="xref" href="#Large_scaled_scatterplot" title="Figure 7-8. Large, scaled scatterplot">Figure 7-8</a>, I’ve increased the value of <code class="literal">h</code> from <code class="literal">100</code> to <code class="literal">300</code> and made

<em>no other changes</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0708.png" alt="Large, scaled scatterplot">
Figure 7-8. Large, scaled scatterplot 
Boom, again! See

<em>07_scaled_plot_large.html</em>. 
Hopefully, you are seeing this and realizing: no more late nights tweaking your code because the client decided the graphic should be 800 pixels wide instead of 600. 
Yes, you will get more sleep because of me (and D3’s brilliant built-in methods). 
Being well-rested is a competitive advantage. 
You can thank me later.

Try It Now!
Experiment with the code for the final scatterplot below. 
Adjust the code at left and see the chart output at right.

<a href="http://examples.oreilly.com/0636920026938/chapter_07/07_scaled_plot_large.html" target="_blank">07_scaled_plot_large</a>

<h2>Other Methods</h2>
<code class="literal">d3.scale.linear()</code> has several other handy methods that deserve a brief

 mention here:

<dl class="variablelist">
<dt>

<a class="ulink" href="http://bit.ly/ZR9Si0" target="_top"><code class="literal">nice()</code></a> </dt>
<dd> This tells the scale to take whatever input domain that you gave to <code class="literal">range()</code> and expand both ends to the nearest round value. 
From the D3 wiki: “For example,
for a domain of [0.20147987687960267, 0.996679553296417], the nice domain is [0.2, 1].” This is useful for normal people, who are not computers and find it hard to read numbers like 0.20147987687960267. 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/Z2ZLke" target="_top"><code class="literal">rangeRound()</code></a> </dt>
<dd> Use <code class="literal">rangeRound()</code> in place of <code class="literal">range()</code>, and all values output by the scale will be rounded to the nearest whole number. 
This is useful if you want shapes to have exact pixel values, to avoid the fuzzy edges that could arise with antialiasing. 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/12h7uTf" target="_top"><code class="literal">clamp()</code></a> </dt>
<dd> By default, a linear scale

<em>can</em> return values outside of the specified range. 
For example, if given a value outside of its expected input domain, a scale will return a number also outside of the output range. 
Calling <code class="literal">clamp(true)</code> on a scale, however, forces all output values to be within the specified range. 
This means excessive values will be rounded to the range’s low or high value (whichever is nearest). 
</dd> </dl>
To use any of these special methods, just tack them onto the chain in which you define the original scale function. 
 For example, to use <code class="literal">nice()</code>:

<code class="kd">var</code> <code class="nx">scale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                     <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mf">0.123</code><code class="p">,</code> <code class="mf">4.567</code><code class="p">])</code>                     <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">500</code><code class="p">])</code>                     <code class="p">.</code><code class="nx">nice</code><code class="p">();</code> 

<h2>Other Scales</h2>
In addition to

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear" target="_top"><code class="literal">linear</code> scales</a> (discussed earlier), D3 has several other built-in scale methods:

<dl class="variablelist">
<dt>

<a class="ulink" href="http://bit.ly/15ePKWb" target="_top"><code class="literal">sqrt</code></a> </dt>
<dd> A square root scale. 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/XBKvuq" target="_top"><code class="literal">pow</code></a> </dt>
<dd> A power scale (good for the gym, er, I mean, useful when working with exponential series of values, as in “to the power of” some exponent). 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/YTuRdX" target="_top"><code class="literal">log</code></a> </dt>
<dd> A logarithmic scale. 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/ZEJXtP" target="_top"><code class="literal">quantize</code></a> </dt>
<dd> A linear scale with discrete values for its output range, for when you want to sort data into “buckets.” </dd>
<dt>

<a class="ulink" href="http://bit.ly/XxlWlr" target="_top"><code class="literal">quantile</code></a> </dt>
<dd> Similar to <code class="literal">quantize</code>, but with discrete values for its input domain (when you already have “buckets”). 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/XWSVvB" target="_top"><code class="literal">ordinal</code></a> </dt>
<dd> Ordinal scales use nonquantitative values (like category names) for output; perfect for comparing apples and oranges. 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/X6O0fT" target="_top"><code class="literal">d3.scale.category10()</code></a>,

<a class="ulink" href="http://bit.ly/Wn3QPH" target="_top"><code class="literal">d3.scale.category20()</code></a>,

<a class="ulink" href="http://bit.ly/13bmamp" target="_top"><code class="literal">d3.scale.category20b()</code></a>, and

<a class="ulink" href="http://bit.ly/Wn3Saf" target="_top"><code class="literal">d3.scale.category20c()</code></a> </dt>
<dd> Handy preset ordinal scales that output either 10 or 20 categorical colors. 
</dd>
<dt>

<a class="ulink" href="http://bit.ly/Xxm6tc" target="_top"><code class="literal">d3.time.scale()</code></a> </dt>
<dd> A scale method for date and time values, with special handling of ticks for dates. 
</dd> </dl>
Now that you have mastered the power of scales, it’s time to express them visually as, yes,

<em>axes</em>!

<h1><span class="orange">Chapter 8. Axes</span></h1>
Having mastered the use of D3 scales, we now have the scatterplot shown in

<a class="xref" href="#Large_scaled_scatterplot2" title="Figure 8-1. Large, scaled scatterplot">Figure 8-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0801.png" alt="Large, scaled scatterplot">
Figure 8-1. Large, scaled scatterplot 
Let’s add horizontal and vertical axes, so we can do away with the horrible red numbers cluttering up our chart.

<h2>Introducing Axes</h2>
Much like its scales,

<a class="ulink" href="https://github.com/mbostock/d3/wiki/SVG-Axes" target="_top">D3’s

<em>axes</em></a> are actually

<em>functions</em> whose parameters you define. 
Unlike scales, when an axis function is called, it doesn’t return a value, but generates the visual elements of the axis, including lines, labels, and ticks.

Note that the axis functions are SVG-specific, as they generate SVG elements. 
Also, axes are intended for use with quantitative scales (as opposed to ordinal ones).


<h2>Setting Up an Axis</h2>
Use <code class="literal">d3.svg.axis()</code> to create a generic axis

function:

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">();</code>
At a minimum, each axis also needs to be told on what

<em>scale</em> to operate. 
Here we’ll pass in the <code class="literal">xScale</code> from the scatterplot code:

<code class="nx">xAxis</code><code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">);</code>
We can also specify where the labels should appear relative to the axis

 itself. 
The default is <code class="literal">bottom</code>, meaning the labels will appear below the axis line. 
(Although this is the default, it can’t hurt to specify it explicitly.) Possible orientations for horizontal axes are <code class="literal">top</code> and <code class="literal">bottom</code>. 
For vertical axes, use <code class="literal">left</code> and <code class="literal">right</code>:

<code class="nx">xAxis</code><code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">);</code>
Of course, we can be more concise and string all this together into one line:

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>                   <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">);</code>
Finally, to actually generate the axis and insert all those little lines and labels into our SVG, we must

<em>call</em> the <code class="literal">xAxis</code> function. 
This is similar to the scale functions, which we first configured by setting parameters, and then later

<em>called</em>, to put them into action.

I’ll put this code at the end of our script, so the axis is generated after the other elements in the SVG, and therefore appears “on top”:

<code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>
This is where things get a little funky. 
You might be wondering why this looks so different from our friendly scale functions. 
Here’s why: because an

<em>axis</em> function actually draws something to the screen (by appending SVG elements to the DOM), we need to specify

<em>where</em> in the DOM it should place those new elements. 
This is in contrast to scale functions like <code class="literal">xScale()</code>, for example, which calculate a value and return those values, typically for use by yet another function, without impacting the DOM at all.

So what we’re doing with the preceding code is to first reference <code class="literal">svg</code>, the SVG image in the DOM. 
Then, we <code class="literal">append()</code> a new <code class="literal">g</code> element to the end of the SVG. 
In SVG land, a <code class="literal">g</code> element is a

<em>group</em> element. 
Group

 elements are invisible, unlike <code class="literal">line</code>, <code class="literal">rect</code>, and <code class="literal">circle</code>, and they have no visual presence themselves. 
Yet they help us in two ways: first, <code class="literal">g</code> elements can be used to contain (or “group”) other elements, which keeps our code nice and tidy. 
Second, we can apply

<em>transformations</em> to <code class="literal">g</code> elements, which affects how visual elements within that group (such as <code class="literal">line</code>s, <code class="literal">rect</code>s, and <code class="literal">circle</code>s) are rendered. 
We’ll get to transformations in just a minute.

So we’ve created a new <code class="literal">g</code>, and then finally, the function <code class="literal">call()</code> is called on our new <code class="literal">g</code>. 
So what is <code class="literal">call()</code>, and who is it calling?

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-call" target="_top">D3’s <code class="literal">call()</code> function</a> takes the incoming

<em>selection</em>, as received from the prior link in the chain, and hands that selection off to any

<em>function</em>. 
In this case, the selection is our new <code class="literal">g</code> group element. 
 Although the <code class="literal">g</code> isn’t strictly necessary, we are using it because the axis function is about to generate lots of crazy lines and numbers, and it’s nice to contain all those elements within a single group object. 
 <code class="literal">call()</code> hands off <code class="literal">g</code> to the <code class="literal">xAxis</code> function, so our axis is generated

<em>within</em> <code class="literal">g</code>.

If we were messy people who loved messy code, we could also rewrite the preceding snippet as this exact equivalent:

<code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>     <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code>     <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">));</code>
See, you could cram the whole axis function within <code class="literal">call()</code>, but it’s usually easier on our brains to define functions first, then call them later.

In any case,

<a class="xref" href="#Simple_but_ugly_axis" title="Figure 8-2. Simple, but ugly axis">Figure 8-2</a> shows what that looks like. 
See code example

<em>01_axes.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0802.png" alt="Simple, but ugly axis">
Figure 8-2. Simple, but ugly axis 

Try It Now!
Try editing the <code class="literal">dataset</code> values below at left, and watch the scale adjust in the output at right.

<a href="http://examples.oreilly.com/0636920026938/chapter_08/01_axes.html" target="_blank">01_axes</a>

<h2>Cleaning It Up</h2>
Technically, that is an axis, but it’s neither pretty nor useful. 
To

 clean it up, let’s first assign a class of <code class="literal">axis</code> to the new <code class="literal">g</code> element, so we can target it with CSS:

<code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code> <code class="c1">//Assign "axis" class</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>
Then, we introduce our first CSS styles, up in the <code class="literal">&lt;head></code> of our page:

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code> <code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>     <code class="k">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>     <code class="k">stroke</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>     <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code> <code class="p">}</code>  <code class="nc">.axis</code> <code class="nt">text</code> <code class="p">{</code>     <code class="k">font-family</code><code class="o">:</code> <code class="nb">sans-serif</code><code class="p">;</code>     <code class="k">font-size</code><code class="o">:</code> <code class="m">11px</code><code class="p">;</code> <code class="p">}</code>
See how useful it is to group all the axis elements within one <code class="literal">g</code> group? Now we can very easily apply styles to anything within the group using the simple CSS selector <code class="literal">.axis</code>. 
The axes themselves are made up of <code class="literal">path</code>, <code class="literal">line</code>, and <code class="literal">text</code> elements, so those are the three elements that we target in our CSS. 
The <code class="literal">path</code>s and <code class="literal">line</code>s can be styled with the same rules, and <code class="literal">text</code> gets its own rules around font and font size.

You might notice that when we use CSS rules to style SVG elements, only SVG attribute names—not regular CSS properties—should be used. 
This is confusing, because many properties share the same names in both CSS and SVG, but some do not. 
For example, in regular CSS, to set the color

 of some text, you would use the <code class="literal">color</code> property, as in:

<code class="nt">p</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">olive</code><code class="p">;</code> <code class="p">}</code>
That will set the text color of all <code class="literal">p</code> paragraphs to be <code class="literal">olive</code>. 
But try to apply this property to an SVG element, as with:

<code class="nt">text</code> <code class="p">{</code>     <code class="k">color</code><code class="o">:</code> <code class="nb">olive</code><code class="p">;</code> <code class="p">}</code>
and it will have no effect because <code class="literal">color</code> is not a property recognized by SVG. 
Instead, you must use SVG’s equivalent, <code class="literal">fill</code>:

<code class="nt">text</code> <code class="p">{</code>     <code class="k">fill</code><code class="o">:</code> <code class="nb">olive</code><code class="p">;</code> <code class="p">}</code>
If you ever find yourself trying to style SVG elements, but for some reason the stupid CSS code just isn’t working, I suggest you take a deep breath, pause, and then review your

<em>property names</em> very closely to ensure you’re using SVG names, not CSS ones. 
(You can reference the complete SVG attribute list on

<a class="ulink" href="https://developer.mozilla.org/en-US/docs/SVG/Attribute" target="_top">the MDN site</a>.)

<a class="ulink" href="https://developer.mozilla.org/en/SVG/Attribute/shape-rendering" target="_top">The <code class="literal">shape-rendering</code> property</a> is another weird SVG attribute you should know. 
We use it here to make sure our axis and its tick mark lines are pixel-perfect. 
No blurry axes for us!

The chart looks like

<a class="xref" href="#Cleaner_axis" title="Figure 8-3. Cleaner axis">Figure 8-3</a> after our CSS clean-up.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0803.png" alt="Cleaner axis">
Figure 8-3. Cleaner axis 
That’s better, but the top horizontal line of the axis is cut off, and the axis itself should be down at the base of the chart anyway. 
Here’s where SVG

<em>transformations</em> come in. 
By adding one line of code, we can

 <code class="literal">transform</code> the entire axis group, pushing it to the bottom:

<code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>
Note that we use <code class="literal">attr()</code> to apply <code class="literal">transform</code> as an attribute of <code class="literal">g</code>.

<a class="ulink" href="https://developer.mozilla.org/en-US/docs/SVG/Attribute/transform" target="_top">SVG transforms</a> are quite powerful, and can accept several different kinds of transform definitions, including scales and rotations. 
But we are keeping it simple here with only a

<em>translation</em> transform, which simply pushes the whole <code class="literal">g</code> group over and down by some amount.

Translation transforms are specified with the easy syntax of <code class="literal">translate(x,y)</code>, where <code class="literal">x</code> and <code class="literal">y</code> are, obviously, the number of horizontal and vertical pixels by which to translate the element. 
So, in the end, we would like our <code class="literal">g</code> to look like this in the DOM:

<code class="nt">&lt;g</code> <code class="na">class=</code><code class="s">"axis"</code> <code class="na">transform=</code><code class="s">"translate(0,280)"</code><code class="nt">></code>
As you can see, the <code class="literal">g.axis</code> isn’t moved horizontally at all, but it is pushed 280 pixels down, conveniently to the base of our chart. 
We specify as much in this line of code:

    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
Note the use of <code class="literal">(h - padding)</code>, so the group’s top edge is set to <code class="literal">h</code>, the height of the entire image, minus the <code class="literal">padding</code> value we created earlier. 
<code class="literal">(h - padding)</code> is calculated to be <code class="literal">280</code>, and then connected to the rest of the string, so the final transform property value is

 <code class="literal">translate(0,280)</code>.

The result in

<a class="xref" href="#Nice_clean_axis" title="Figure 8-4. Nice, clean axis">Figure 8-4</a> is much better! Check out the code so far in

<em>02_axes_bottom.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0804.png" alt="Nice, clean axis">
Figure 8-4. Nice, clean axis  

<h2>Check for Ticks</h2>
Some ticks spread disease, but

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear_ticks" target="_top">D3’s ticks</a> communicate information. 
Yet more ticks are not necessarily better, and at a certain point, they begin to clutter your chart. 
You’ll notice that we never specified how many ticks to include on the axis, nor at what intervals they should appear. 
Without clear instruction, D3 has automagically examined our scale <code class="literal">xScale</code> and made informed judgments about how many ticks to include, and at what intervals (every 50, in this case).

As you would expect, you can customize all aspects of your axes, starting with the rough number of ticks, using <code class="literal">ticks()</code>:

<code class="kd">var</code> <code class="nx">xAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>                   <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">xScale</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"bottom"</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>  <code class="c1">//Set rough # of ticks</code>
See

<em>03_axes_clean.html</em> for that code.

You’ll notice in

<a class="xref" href="#Fewer_ticks" title="Figure 8-5. Fewer ticks">Figure 8-5</a> that, although we specified only five ticks, D3 has made an executive decision and ordered up a total of seven. 
That’s because D3 has got your back, and figured out that including only

<em>five</em> ticks would require slicing the input domain into less-than-gorgeous values—in this case, 0, 150, 300, 450, and 600. 
D3 inteprets the <code class="literal">ticks()</code> value as merely a suggestion and will override your suggestion with what it determines to be the most clean and human-readable values—in this case, intervals of 100—even when that requires including slightly more or fewer ticks than you requested. 
This is actually a totally brilliant feature that increases the scalability of your design; as the dataset changes and the input domain expands or contracts (bigger numbers or smaller numbers), D3 ensures that the tick labels remain easy to read.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0805.png" alt="Fewer ticks">
Figure 8-5. Fewer ticks  

<h2>Y Not?</h2>
Time to label the vertical axis! By copying and tweaking the code we

 already wrote for the <code class="literal">xAxis</code>, we add this near the top of of our code:

<code class="c1">//Define Y axis</code> <code class="kd">var</code> <code class="nx">yAxis</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">axis</code><code class="p">()</code>                   <code class="p">.</code><code class="nx">scale</code><code class="p">(</code><code class="nx">yScale</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">orient</code><code class="p">(</code><code class="s2">"left"</code><code class="p">)</code>                   <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>
and this, near the bottom:

<code class="c1">//Create Y axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">padding</code> <code class="o">+</code> <code class="s2">",0)"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
Note in

<a class="xref" href="#Initial_Y_axis" title="Figure 8-6. Initial y-axis">Figure 8-6</a> that the labels will be oriented <code class="literal">left</code> and that the <code class="literal">yAxis</code> group <code class="literal">g</code> is translated to the right by the amount <code class="literal">padding</code>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0806.png" alt="Initial y-axis">
Figure 8-6. Initial y-axis 
This is starting to look like a real chart! But the <code class="literal">yAxis</code> labels are getting cut off. 
To give them more room on the left side, I’ll bump up the value of <code class="literal">padding</code> from 20 to 30:

<code class="kd">var</code> <code class="nx">padding</code> <code class="o">=</code> <code class="mi">30</code><code class="p">;</code>
Of course, you could also introduce separate <code class="literal">padding</code> variables for each axis, say
<code class="literal">xPadding</code> and <code class="literal">yPadding</code>, for more control over the layout.

See the updated code in

<em>04_axes_y.html</em>. 
It looks like

<a class="xref" href="#Scatterplot_with_Y_axis" title="Figure 8-7. Scatterplot with y-axis">Figure 8-7</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0807.png" alt="Scatterplot with y-axis">
Figure 8-7. Scatterplot with y-axis 

Try It Now!
Try editing the <code class="literal">dataset</code> values below at left, and watch both the x- and y- scales update at right

<a href="http://examples.oreilly.com/0636920026938/chapter_08/04_axes_y.html" target="_blank">04_axes_y</a>

<h2>Final Touches</h2>
I appreciate that so far you have been very quiet and polite, and not at all confrontational. 
Yet I still feel as though I have to win you over. 
So to prove to you that our new axes are dynamic and scalable, I’d like

 to switch from using a static dataset to using randomized numbers:

<code class="c1">//Dynamic, random dataset</code> <code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[];</code> <code class="kd">var</code> <code class="nx">numDataPoints</code> <code class="o">=</code> <code class="mi">50</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">xRange</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">yRange</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numDataPoints</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>     <code class="kd">var</code> <code class="nx">newNumber1</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">xRange</code><code class="p">);</code>     <code class="kd">var</code> <code class="nx">newNumber2</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">yRange</code><code class="p">);</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="nx">newNumber1</code><code class="p">,</code> <code class="nx">newNumber2</code><code class="p">]);</code> <code class="p">}</code>
This code initializes an empty array, then loops through 50 times, chooses two random numbers each time, and adds (“pushes”) that pair of values to the <code class="literal">dataset</code> array (see

<a class="xref" href="#Scatterplot_with_random_data" title="Figure 8-8. Scatterplot with random data">Figure 8-8</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0808.png" alt="Scatterplot with random data">
Figure 8-8. Scatterplot with random data 
Try out that randomized dataset code in

<em>05_axes_random.html</em>. 
Each time you reload the page, you’ll get different data values. 
Notice how both axes scale to fit the new domains, and ticks and label values are chosen accordingly.

Try It Now!
Regenerate the scatterplot below by hovering over the graph and then hitting the "Run with JS" button, and watch the scales on the axes dynamically update to fit the randomly generated data points.

<a href="http://examples.oreilly.com/0636920026938/chapter_08/05_axes_random.html" target="_blank">05_axes_random</a>

Having made my point, I think we can finally cut those horrible, red labels, by commenting out the relevant lines of code.

The result is shown in

<a class="xref" href="#Scatterplot_with_random_data_and_no_red_labels" title="Figure 8-9. Scatterplot with random data and no red labels">Figure 8-9</a>. 
Our final scatterplot code lives in

<em>06_axes_no_labels.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0809.png" alt="Scatterplot with random data and no red labels">
Figure 8-9. Scatterplot with random data and no red labels  

<h2>Formatting Tick Labels</h2>
One last thing: so far, we’ve been working with integers—whole numbers—which are nice and easy. 
But data is often messier, and in those cases, you might want more control over how the axis labels are formatted.

 Enter

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear_tickFormat" target="_top"><code class="literal">tickFormat()</code></a>, which enables you to specify how your numbers should be formatted. 
For example, you might want to include three places after the decimal point, or display values as percentages, or both.

To use <code class="literal">tickFormat()</code>, first define a new number-formatting function. 
This one, for example, says to treat values as percentages with one decimal point precision. 
That is, if you give this function the number <code class="literal">0.23</code>, it will return the string <code class="literal">23.0%</code>. 
(See

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Formatting#wiki-d3_format" target="_top">the reference entry for <code class="literal">d3.format()</code></a> for more options.)

<code class="kd">var</code> <code class="nx">formatAsPercentage</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">".1%"</code><code class="p">);</code>
Then, tell your axis to use that formatting function for its ticks, for example:

<code class="nx">xAxis</code><code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">formatAsPercentage</code><code class="p">);</code>

I find it easiest to test these formatting functions out in the JavaScript console. 
For example, just open any page that loads D3, such as

<em>06_axes_no_labels.html</em>, and type your format rule into the console. 
Then test it by feeding it a value, as you would with any other function.

You can see in

<a class="xref" href="#Testing_format_console" title="Figure 8-10. Testing format() in the console">Figure 8-10</a> that a data value of <code class="literal">0.54321</code> is converted to <code class="literal">54.3%</code> for display purposes—perfect!

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0810.png" alt="Testing format() in the console">
Figure 8-10. Testing format() in the console  

Try It Now!
Try entering the following <code class="literal">formatAsPercentage</code> statements in the console below to see the results:

 <code class="literal">formatAsPercentage(.365);</code>  <code class="literal">formatAsPercentage(1.2);</code>  <code class="literal">formatAsPercentage(-.5);</code>  

You can play with that code in

<em>07_axes_format.html</em>. 
Obviously, a percentage format doesn’t make sense with our scatterplot’s current dataset, but as an exercise, you could try tweaking how the random numbers are generated, to make more appropriate, non-whole number values, or just experiment with the format function itself.

<h1><span class="orange">Chapter 9. Updates, Transitions, and Motion</span></h1>
Until this point, we have used only static datasets. 
But real-world data almost always

<em>changes</em> over time. 
And you might want your visualization to reflect those changes.

In D3 terms, those changes are handled by

<em>updates</em>. 
The visual adjustments are made pretty with

<em>transitions</em>, which can employ

<em>motion</em> for perceptual benefit.

We’ll start by generating a visualization with one dataset, and then changing the data completely.

<h2>Modernizing the Bar Chart</h2>
Let’s revisit our trusty old bar chart in

<a class="xref" href="#The_bar_chart_as_seen_last" title="Figure 9-1. The bar chart, as seen last">Figure 9-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0901.png" alt="The bar chart, as seen last">
Figure 9-1. The bar chart, as seen last 
If you examine the code in

<em>01_bar_chart.html</em>, you’ll see that we used this static dataset:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code>                 <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>
Since then, we’ve learned how to write more flexible code, so our chart elements resize to accommodate different sized datasets (meaning shorter or longer arrays) and different data values (smaller or larger numbers). 
We accomplished that flexibility using D3 scales, so I’d like to start by bringing our bar chart up to speed.

Ready? Okay, just give me a sec…

Aaaaaand, done! Thanks for waiting.

<a class="xref" href="#A_scalable_flexible_bar_chart" title="Figure 9-2. A scalable, flexible bar chart">Figure 9-2</a> looks pretty similar, but a lot has changed under the hood. 
You can

 follow along by opening up

<em>02_bar_chart_with_scales.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0902.png" alt="A scalable, flexible bar chart">
Figure 9-2. A scalable, flexible bar chart 
To start, I adjusted the width and height, to make the chart taller and wider:

<code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">250</code><code class="p">;</code>
Next, I introduced an

<em>ordinal scale</em> to handle the left/right

 positioning of bars and labels along the x-axis:

<code class="kd">var</code> <code class="nx">xScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">ordinal</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">))</code>                 <code class="p">.</code><code class="nx">rangeRoundBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">],</code> <code class="mf">0.05</code><code class="p">);</code>
This may seem like gobbledegook, so I’ll walk through it one line at a time.

<h3>Ordinal Scales, Explained</h3>
First, in this line:

<code class="kd">var</code> <code class="nx">xScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">ordinal</code><code class="p">()</code>
we declare a new variable called <code class="literal">xScale</code>, just as we had done with our scatterplot. 
Only here, instead of a

<em>linear</em> scale, we create an

<em>ordinal</em> one. 
Ordinal scales are typically used for ordinal data, typically categories with some inherent

<em>order</em> to them, such as:

 freshman, sophomore, junior, senior  grade B, grade A, grade AA  strongly dislike, dislike, neutral, like, strongly like  
We don’t have true ordinal data for use with this bar chart. 
Instead, we just want the bars to be drawn from left to right using the same order in which values occur in our dataset. 
D3’s ordinal scale is useful in this situation, when we have many visual elements (vertical bars) that are positioned in an arbitrary order (left to right), but must be evenly spaced. 
This will become clear in a moment.

<code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">))</code>
This next line of code sets the input domain for the scale. 
Remember how linear scales need a two-value array to set their domains, as in <code class="literal">[0, 100]</code>? For a linear scale, that array would set the low and high values of the domain. 
But ordinal domains are, well, ordinal, so they don’t think in linear, quantitative terms. 
To set the domain of an ordinal scale, you typically specify an array with the category names, as in:

<code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="s2">"freshman"</code><code class="p">,</code> <code class="s2">"sophomore"</code><code class="p">,</code> <code class="s2">"junior"</code><code class="p">,</code> <code class="s2">"senior"</code><code class="p">])</code>
For our bar chart, we don’t have explicit categories, but we could assign each data point or bar an ID value corresponding to its position within the <code class="literal">dataset</code> array, as in 0, 1, 2, 3, and so on. 
So perhaps our domain statement could read:

<code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code>          <code class="mi">10</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">14</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">19</code><code class="p">])</code>
It turns out there is a very simple way to quickly generate an array of sequential numbers: the <code class="literal">d3.range()</code> method.

While viewing

<em>02_bar_chart_with_scales.html</em>, go ahead and open up the console, and type the following:

d3.range(10)
You should see the following output array:

[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
How nice is that? D3 saves you time once again (and the hassle of extra <code class="literal">for()</code> loops).

Coming back to our code, it should now be clear what’s happening here:

<code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">))</code>

<ol class="orderedlist" type="1">
 <code class="literal">dataset.length</code>, in this case, is evaluted as <code class="literal">20</code>, because we have 20 items in our dataset. 
 <code class="literal">d3.range(20)</code> is then evaluated, which returns this array: <code class="literal">[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]</code>. 
 Finally, <code class="literal">domain()</code> sets the domain of our new ordinal scale to those values. 
 </ol>
This might be somewhat confusing because we are using numbers (0, 1, 2…) as ordinal values, but ordinal values are typically nonnumeric.

<h3>Round Bands Are All the Range These Days</h3>
The great thing about <code class="literal">d3.scale.ordinal()</code> is it supports

<em>range banding</em>. 
Instead of returning a continuous range, as any quantitative scale (like <code class="literal">d3.scale.linear()</code>) would, ordinal scales use

<em>discrete</em> ranges, meaning the output values are determined in advance, and could be numeric or not.

We could use <code class="literal">range()</code> like everyone else,

<em>or</em> we can be smooth and use <code class="literal">rangeBands()</code>, which takes a low and high value, and automatically divides it into even chunks or “bands,” based on the length of the domain. 
For example:

<code class="p">.</code><code class="nx">rangeBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">])</code>
this says “calculate even bands starting at 0 and ending at <code class="literal">w</code>, then set this scale’s range to those bands.” In our case, we specified 20 values in the domain, so D3 will calculate:

(w - 0) / xScale.domain().length (600 - 0) / 20 600 / 20 30
In the end, each band will be <code class="literal">30</code> “wide.”

It is also possible to include a second parameter, which includes a bit of spacing between each band. 
Here, I’ve used <code class="literal">0.2</code>, meaning that 20 percent of the width of each band will be used for spacing in between bands:

<code class="p">.</code><code class="nx">rangeBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">],</code> <code class="mf">0.2</code><code class="p">)</code>
We can be even smoother and use <code class="literal">rangeRoundBands()</code>, which is the same as <code class="literal">rangeBands()</code>, except that the output values are rounded to the nearest whole pixel, so 12.3456 becomes just 12, for example. 
This is helpful for keeping visual elements lined up precisely on the pixel grid, for clean, sharp edges.

I’ll also decrease the amount of spacing to just 5 percent. 
 So, our final line of code in that statement is:

<code class="p">.</code><code class="nx">rangeRoundBands</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">w</code><code class="p">],</code> <code class="mf">0.05</code><code class="p">);</code>
This gives us nice, clean pixel values, with a teensy bit of visual space between them.

<h3>Referencing the Ordinal Scale</h3>
Later in the code (and I recommend viewing the source), when we create

 the <code class="literal">rect</code> elements, we set their horizontal, x-axis positions like so:

<code class="c1">//Create bars</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>       <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>         <code class="c1">// &lt;-- Set x values</code>    <code class="p">})</code>            <code class="err">…</code>
Note that, because we include <code class="literal">d</code> and <code class="literal">i</code> as parameters to the anonymous function, D3 will automatically pass in the correct values. 
Of course, <code class="literal">d</code> is the current datum, and <code class="literal">i</code> is its index value. 
So <code class="literal">i</code> will be passed 0, 1, 2, 3, and so on.

Coincidentally (hmmm!), we used those same values (0, 1, 2, 3…) for our ordinal scale’s input domain. 
So when we call <code class="literal">xScale(i)</code>, <code class="literal">xScale()</code> will look up the ordinal value <code class="literal">i</code> and return its associated output (band) value. 
(You can verify all this for yourself in the console. 
Just try typing <code class="literal">xScale(0)</code> or <code class="literal">xScale(5)</code>.)

Try It Now!
Try entering the following <code class="literal">xScale</code> statements in the console below to see the results:

 <code class="literal">xScale(0)</code>  <code class="literal">xScale(5)</code>  

Even better, setting the widths of these bars just got a lot easier. 
Before using the ordinal scale, we had:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="nx">barPadding</code><code class="p">)</code>
We don’t even need <code class="literal">barPadding</code> anymore because now the padding is built into
<code class="literal">rangeRoundBands()</code>. 
Setting the width of each <code class="literal">rect</code> needs only

 this:

        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>
Isn’t it nice when D3 does the math for you?

<h3>Other Updates</h3>
I’ve made several other updates in

<em>02_bar_chart_with_scales.html</em>, including creating a new linear scale <code class="literal">yScale</code> to calculate vertical values. 
You already know how to use linear scales, so you can skim the source and note how that’s being used to set the bar heights.

  

<h2>Updating Data</h2>
Okay, once again, we have the amazing bar chart shown in

<a class="xref" href="#The_bar_chart" title="Figure 9-3. The bar chart">Figure 9-3</a>, flexible enough to handle any data we can throw at it.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0903.png" alt="The bar chart">
Figure 9-3. The bar chart 
Or is it? Let’s see.

The simplest kind of update is when all data values are updated at the same time

<em>and</em> the number of values stays the same.

The basic approach in this scenario is this:

<ol class="orderedlist" type="1">
 Modify the values in your dataset. 
 Rebind the new values to the existing elements (thereby overwriting the original values). 
 Set new attribute values as needed to update the visual display. 
 </ol>
Before any of those steps can happen, though, some

<em>event</em> needs to kick things off. 
So far, all of our code has executed immediately on page load. 
We

<em>could</em> have our update run right after the initial drawing code, but it would happen imperceptibly fast. 
To make sure we can observe the change as it happens, we will separate our update code from everything else. 
We will need a “trigger,” something that happens

<em>after</em> page load to apply the updates. 
How about a mouse click?

<h3>Interaction via Event Listeners</h3>
Any DOM element can be used, so rather than design a fancy button, I’ll

 add a simple <code class="literal">p</code> paragraph to the HTML’s <code class="literal">body</code>:

<code class="nt">&lt;p></code>Click on this text to update the chart with new data values (once).<code class="nt">&lt;/p></code>
Then, down at the end of our D3 code, let’s add the following:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something  on click</code>     <code class="p">});</code>
This selects our new <code class="literal">p</code>, and then adds an

<em>event listener</em> to that element. 
Huh?

In JavaScript, events are happening all the time. 
Not exciting events, like huge parties, but really insignificant events like <code class="literal">mouseover</code> and <code class="literal">click</code>. 
Most of the time, these insignificant events go ignored (just as in life, perhaps). 
But if someone is

<em>listening</em>, then the event will be

<em>heard</em>, and can go down in posterity, or at least trigger some sort of DOM interaction. 
(Rough JavaScript parallel of classic koan: if an event occurs, and no listener hears it, did it ever happen at all?)

An event

<em>listener</em> is an anonymous function that

<em>listens</em> for a

 specific event

<em>on</em> a specific element or elements. 
D3’s method <code class="literal">selection.on()</code> provides a nice shorthand for adding event listeners. 
As you can see, <code class="literal">on()</code> takes two arguments: the event

<em>type</em> (<code class="literal">"click"</code>) and the listener itself (the anonymous function).

In this case, the listener listens for a <code class="literal">click</code> event occurring on our

 selection <code class="literal">p</code>. 
When that happens, the listener function is executed. 
You can put whatever code you want in between the brackets of the anonymous function:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something mundane and annoying on click</code>         <code class="nx">alert</code><code class="p">(</code><code class="s2">"Hey, don't click that!"</code><code class="p">);</code>     <code class="p">});</code>
We’ll talk a lot more about interactivity in

<a class="xref" href="" title="Chapter 10. Interactivity">Chapter 10</a>.

<h3>Changing the Data</h3>
Instead of generating annoying pop-ups, I’d rather simply update

 <code class="literal">dataset</code> by overwriting its original values. 
This is step 1, from earlier:

<code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code>             <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code> <code class="p">];</code>
Step 2 is to rebind the new values to the existing elements. 
We can do that by selecting those <code class="literal">rect</code>s and simply calling <code class="literal">data()</code> one more time:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code>     <code class="c1">//New data successfully bound, sir!</code> 

<h3>Updating the Visuals</h3>
Finally, step 3 is to update the visual attributes, referencing the (now-updated) data values. 
This is super easy, as we simply copy and paste the relevant code that we’ve already written. 
In this case, the <code class="literal">rect</code>s can maintain their horizontal positions and widths; all we really need to update are their <code class="literal">height</code>s and <code class="literal">y</code> positions. 
I’ve added those lines here:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">});</code>
Notice this looks almost exactly like the code that generates the <code class="literal">rect</code>s initially, only without <code class="literal">enter()</code> and <code class="literal">append()</code>.

Putting it all together, here is all of our update code in one place:

<code class="c1">//On click, update with new data</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>          <code class="c1">//New values for dataset</code>         <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">17</code><code class="p">,</code> <code class="mi">16</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">23</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code>                     <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">13</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="mi">25</code><code class="p">,</code> <code class="mi">22</code><code class="p">,</code> <code class="mi">18</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">13</code> <code class="p">];</code>          <code class="c1">//Update all rects</code>         <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>            <code class="p">});</code>      <code class="p">});</code>
Check out the revised bar chart in

<em>03_updates_all_data.html</em>. 
It looks like

<a class="xref" href="#Updateable_bar_chart" title="Figure 9-4. Updatable bar chart">Figure 9-4</a> to start.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0904.png" alt="Updatable bar chart">
Figure 9-4. Updatable bar chart 
Then click anywhere on the paragraph, and it turns into

<a class="xref" href="#Bar_chart_data_updated" title="Figure 9-5. Bar chart, data updated">Figure 9-5</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0905.png" alt="Bar chart, data updated">
Figure 9-5. Bar chart, data updated 
Good news: the values in <code class="literal">dataset</code> were modified, rebound, and used to adjust the <code class="literal">rect</code>s. 
Bad news: it looks weird because we forgot to update the labels, and also the bar colors. 
Good news (because I always like to end with good news): this is easy to fix.

To ensure the colors change on update, we just copy and paste in the

 line where we set the <code class="literal">fill</code>:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>   <code class="c1">// &lt;-- Down here!</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>    <code class="p">});</code>
To update the labels, we use a similar pattern, only here we adjust

 their text content and x/y values:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code>    <code class="p">});</code>
Take a look at

<em>04_updates_all_data_fixed.html</em>. 
You’ll notice it looks the same to start, but click the trigger and now the bar colors and labels update correctly, as shown in

<a class="xref" href="#Updated_chart_with_correct_colors_and_labels" title="Figure 9-6. Updated chart with correct colors and labels">Figure 9-6</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0906.png" alt="Updated chart with correct colors and labels">
Figure 9-6. Updated chart with correct colors and labels 

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/04_updates_all_data_fixed.html" target="_blank">04_updates_all_data_fixed</a>

<h2>Transitions</h2>
Life transitions can be scary: the first day of school, moving to a new city, quitting your day job to do freelance data visualization full-time. 
But D3 transitions are fun, beautiful, and not at all emotionally taxing.

Making a nice, super smooth, animated transition is as simple as adding

 one line of code:

<code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
Specifically, add this link in the chain below where your selection is made, and

<em>above</em> where any attribute changes are applied:

<code class="c1">//Update all rects</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="c1">// &lt;-- This is new! Everything else here is unchanged.</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>    <code class="p">});</code>
Now run the code in

<em>05_transition.html</em>, and click the text to see the transition in action. 
Note that the end result looks the same visually, but the transition from the chart’s initial state to its end state is much, much nicer.

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/05_transition.html" target="_blank">05_transition</a>

Isn’t that

<em>insane</em>? I’m not a psychologist, but I believe it is literally insane that we can add a single line of code, and D3 will

<em>animate</em> our value changes for us over time.

Without <code class="literal">transition()</code>, D3 evaluates every <code class="literal">attr()</code> statement immediately, so the changes in height and fill happen right away. 
When you add <code class="literal">transition()</code>, D3 introduces the element of time. 
Rather than applying new values all at once, D3

<em>interpolates</em> between the old values and the new values, meaning it normalizes the beginning and ending values, and calculates all their in-between states. 
D3 is also smart enough to recognize and interpolate between different attribute value formats. 
For example, if you specified a height of <code class="literal">200px</code> to start but transition to just <code class="literal">100</code> (without the <code class="literal">px</code>). 
Or if a <code class="literal">blue</code> fill turns <code class="literal">rgb(0,255,0)</code>. 
You don’t need to fret about being consistent; D3 takes care of it.

Do you believe me yet? This is really insane. 
And super helpful.

<h3>duration(), or How Long Is This Going to Take?</h3>
So the <code class="literal">attr()</code> values are interpolated over time, but how

<em>much</em> time? It turns out the default is 250 milliseconds, or one-quarter second (1,000 milliseconds = 1 second). 
That’s why the transition in

<em>05_transition.html</em> is so fast.

Fortunately, you can control how much time is spent on any transition by—again, I kid you not—adding a single line of code:

<code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>
The <code class="literal">duration()</code> must be specified

<em>after</em> the <code class="literal">transition()</code>, and durations are always specified in milliseconds, so <code class="literal">duration(1000)</code> is a one-second duration.

Here is that line in context:

<code class="c1">//Update all rects</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>  <code class="c1">// &lt;-- Now this is new!</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>    <code class="p">});</code>
Open up

<em>06_duration.html</em> and see the difference. 
Now make a copy of that file, and try plugging in some different numbers to slow or speed the transition. 
For example, try <code class="literal">3000</code> for a three-second transition, or <code class="literal">100</code> for one-tenth of a second.

The actual durations you choose will depend on the context of your design and what triggers the transition. 
In practice, I find that transitions of around 150 ms are useful for providing minor interface feedback (such as hovering over elements), and about 1,000 ms is ideal for many more significant visual transitions, such as switching from one view of the data to another. 
1,000 ms (one second) is not too long, not too short.

In case you’re feeling lazy, I made

<em>07_duration_slow.html</em>, which uses <code class="literal">5000</code> for a five-second transition.

With such a slow transition, it becomes obvious that the value labels are not transitioning smoothly along with the bar heights. 
As you now know, we can correct that oversight by adding only two new lines of code, this time in the section where we update the labels:

<code class="c1">//Update all labels</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>        <code class="c1">// &lt;-- This is new,</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">5000</code><code class="p">)</code>      <code class="c1">//     and so is this.</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code>    <code class="p">});</code>
Much better! Note in

<em>08_duration_slow_labels_fixed.html</em> how the labels now animate smoothly along with the bars.

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/08_duration_slow_labels_fixed.html" target="_blank">08_duration_slow_labels_fixed</a>

<h3>ease()-y Does It</h3>
With a 5,000-ms, slow-as-molasses transition, we can also perceive the

<em>quality</em> of motion. 
In this case, notice how the animation begins very slowly, then accelerates, then slows down again as the bars reach their destination heights. 
That is, the rate of motion is not

<em>linear</em>, but

<em>variable</em>.

The quality of motion used for a transition is called

<em>easing</em>. 
In animation terms, we think about elements

<em>easing</em> into place, moving from here to there.

With D3, you can specify different kinds of easing by using <code class="literal">ease()</code>. 
The default easing is <code class="literal">"cubic-in-out"</code>, which produces the gradual acceleration and deceleration we see in our chart. 
It’s a good default because you generally can’t go wrong with a nice, smooth transition.

Contrast that smoothness to

<em>09_ease_linear.html</em>, which uses <code class="literal">ease("linear")</code> to specify a linear easing function. 
Notice how the rate of motion is constant. 
That is, there is no gradual acceleration and deceleration—the elements simply begin moving at an even pace, and then they stop abruptly. 
(Also, I lowered the duration to 2,000 ms.)

<code class="literal">ease()</code> must also be specified after <code class="literal">transition()</code>, but before the <code class="literal">attr()</code> statements to which the transition applies. 
<code class="literal">ease()</code> can come before or after <code class="literal">duration()</code>, but this sequence makes the most sense to me:

<code class="err">…</code>   <code class="c1">//Selection statement(s)</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code> <code class="p">.</code><code class="nx">ease</code><code class="p">(</code><code class="s2">"linear"</code><code class="p">)</code> <code class="err">…</code>   <code class="c1">//attr() statements</code>
Fortunately, there are several other built-in easing functions to choose from. 
Some of my favorites are:

<dl class="variablelist">
<dt>
 <code class="literal">circle</code> </dt>
<dd> Gradual ease in and acceleration until elements snap into place. 
</dd>
<dt>
 <code class="literal">elastic</code> </dt>
<dd> The best way to describe this one is “sproingy.” </dd>
<dt>
 <code class="literal">bounce</code> </dt>
<dd> Like a ball bouncing, then coming to rest. 
</dd> </dl>
Sample code files

<em>10_ease_circle.html</em>,

<em>11_ease_elastic.html</em>, and

<em>12_ease_bounce.html</em> illustrate these three functions. 
The complete list of easing functions is on

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_ease" target="_top">the D3 wiki</a>.

Try It Now!

Wow, I already regret telling you about <code class="literal">bounce</code>. 
Please use <code class="literal">bounce</code> only if you are making a satirical infographic that is mocking other bad graphics. 
Perceptually, I don’t think there is a real case to be used for <code class="literal">bounce</code> easing in visualization. 
<code class="literal">cubic-in-out</code> is the default for a reason.

<h3>Please Do Not delay()</h3>
Whereas <code class="literal">ease()</code> controls the quality of motion, <code class="literal">delay()</code> specifies when the transition begins.

<code class="literal">delay()</code> can be given a static value, also in milliseconds, as in:

<code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>     <code class="c1">//1,000 ms or 1 second</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code>  <code class="c1">//2,000 ms or 2 seconds</code> <code class="err">…</code>
As with <code class="literal">duration()</code> and <code class="literal">ease()</code>, the order here is somewhat flexible, but I like to include <code class="literal">delay()</code> before <code class="literal">duration()</code>. 
That makes more sense to me because the delay happens first, followed by the transition itself.

See

<em>13_delay_static.html</em>, in which clicking the text triggers first a 1,000-ms delay (in which nothing happens), followed by a 2,000-ms transition.

Static delays can be useful, but more exciting are delay values that we calculate dynamically. 
A common use of this is to generate staggered delays, so some elements transition before others. 
Staggered delays can assist with perception, as it’s easier for our eyes to follow an individual element’s motion when it is slightly out of sync with its neighboring elements’ motion.

To do this, instead of giving <code class="literal">delay()</code> a static value, we give it a function, in typical D3 fashion:

<code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="mi">100</code><code class="p">;</code> <code class="p">})</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code> <code class="err">…</code>
Just as we’ve seen with other D3 methods, when given an anonymous function, the datum bound to the current element is passed into <code class="literal">d</code>, and the index position of that element is passed into <code class="literal">i</code>. 
So, in this case, as D3 loops through each element, the delay for each element is set to <code class="literal">i * 100</code>, meaning each subsequent element will be delayed 100 ms

<em>more</em> than the preceding element.

All this is to say that we now have staggered transitions. 
Check out the beautifully animated bars in

<em>14_delay_dynamic.html</em> and see for yourself.

Note that I also decreased the duration to 500 ms to make it feel a bit snappier. 
Also note that <code class="literal">duration()</code> sets the duration for each

<em>individual transition</em>, not for all transitions in aggregate. 
So, for example, if 20 elements have 500-ms transitions applied with no delay, then it will all be over in 500 ms, or one-half second. 
But if a 100-ms delay is applied to each subsequent element (<code class="literal">i * 100</code>), then the total running time of all transitions will be 2,400 ms:

Max value of i times 100ms delay plus 500ms duration = 19 * 100 + 500 = 2400
Because these delays are being calculated on a per-element basis, if you added more data, then the total running time of all transitions will increase. 
This is something to keep in mind if you have a dynamically loaded dataset with a variable array length. 
If you suddenly loaded 10,000 data points instead of 20, you could spend a long time watching those bars wiggle around (1,000,400 ms or 16.67 minutes to be precise). 
Suddenly, they’re not so cute anymore.

Fortunately, we can

<em>scale</em> our delay values dynamically to the length of the dataset. 
This isn’t fancy D3 stuff; it’s just math.

See

<em>15_delay_dynamic_scaled.html</em>, in which 30 values are included in the dataset. 
If you get out your stopwatch, you’ll see that the total transition time is 1.5 seconds, or around 1,500 ms.

Now see

<em>16_delay_dynamic_scaled_fewer.html</em>, which uses exactly the same transition code, but with only 10 data points. 
Notice how the delays are slightly longer (well, 200 percent longer), so the total transition time is the same: 1.5 seconds! How is this possible?

Try It Now!

<code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">i</code> <code class="o">/</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">;</code>   <code class="c1">// &lt;-- Where the magic happens</code> <code class="p">})</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code> <code class="err">…</code>
The two preceding sample pages use the same delay calculations here. 
Instead of multiplying <code class="literal">i</code> by some static amount, we first divide <code class="literal">i</code> by <code class="literal">dataset.length</code>, in effect normalizing the value. 
Then, that normalized value is multiplied by <code class="literal">1000</code>, or 1 second. 
The result is that the maximum amount of delay for the last element will be <code class="literal">1000</code>, and all prior elements will be delayed by some amount less than that. 
A max delay of <code class="literal">1000</code> plus a duration of <code class="literal">500</code> equals 1.5 seconds total transition time.

This approach to delays is great because it keeps our code

<em>scalable</em>. 
The total duration will be tolerable whether we have only 10 data points or 10,000.

<h3>Randomizing the Data</h3>
Just to illustrate how cool this is, let’s repurpose our random number generating code from

<a class="xref" href="" title="Chapter 5. Data">Chapter 5</a> here, so we can update the chart as many times as we want, with new data each time.

Down in our click-update function, let’s replace the static <code class="literal">dataset</code> with a randomly generated one:

<code class="c1">//New values for dataset</code> <code class="kd">var</code> <code class="nx">numValues</code> <code class="o">=</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>               <code class="c1">//Count original length of dataset</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[];</code>                                       <code class="c1">//Initialize empty array</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">numValues</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>               <code class="c1">//Loop numValues times</code>     <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">25</code><code class="p">);</code> <code class="c1">//New random integer (0-24)</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">newNumber</code><code class="p">);</code>                        <code class="c1">//Add new number to array</code> <code class="p">}</code>
This will overwrite <code class="literal">dataset</code> with an array of random integers with values between 0 and 24. 
The new array will be the same length as the original array.

Then, I’ll update the paragraph text:

<code class="nt">&lt;p></code>Click on this text to update the chart with new data values as many times as you like!<code class="nt">&lt;/p></code>
Now open up

<em>17_randomized_data.html</em>, and you should see something like

<a class="xref" href="#Initial_view" title="Figure 9-7. Initial view">Figure 9-7</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0907.png" alt="Initial view">
Figure 9-7. Initial view 
Every time you click the paragraph at top, the code will do the following:

<ol class="orderedlist" type="1">
 Generate new, random values. 
 Bind those values to the existing elements. 
 Transition elements to new positions, heights, and colors, using the new values (see

<a class="xref" href="#Random_data_applied" title="Figure 9-8. Random data applied">Figure 9-8</a>). 
 </ol>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0908.png" alt="Random data applied">
Figure 9-8. Random data applied 

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/17_randomized_data.html" target="_blank">17_randomized_data</a>

Pretty cool! If this does not feel pretty cool or even a little cool to you, please turn off your computer and go for a short walk to clear your head, thereby making room for all the coolness to come. 
If, however, you are sufficiently cooled by this knowledge, read on.

<h3>Updating Scales</h3>
Astute readers might take issue with this line from

earlier:

<code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">25</code><code class="p">);</code>
Why 25? In programming, this is referred to as a

<em>magic number</em>. 
I

 know, it sounds fun, but the problem with magic numbers is that it’s difficult to tell why they exist (hence, the “magic”). 
Instead of <code class="literal">25</code>, something like <code class="literal">maxValue</code> would be more meaningful:

<code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">maxValue</code><code class="p">);</code>
Ah, see, now the magic is gone, and I can remember that <code class="literal">25</code> was acting as the

<em>maximum value</em> that could be calculated and put into <code class="literal">newNumber</code>. 
As a general rule, it’s best to avoid magic numbers, and instead store those numbers inside variables with meaningful names, like <code class="literal">maxValue</code> or <code class="literal">numberOfTimesWatchedTheMovieTopSecret</code>.

More important, I now remember that I arbitrarily chose <code class="literal">25</code> because values larger than that exceeded the range of our chart’s scale, so those bars were cut off. 
For example, in

<a class="xref" href="#Tootallwrongnumber" title="Figure 9-9. Too tall! We used the wrong magic number!">Figure 9-9</a>, I replaced <code class="literal">25</code> with <code class="literal">50</code>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0909.png" alt="Too tall! We used the wrong magic number!">
Figure 9-9. Too tall! We used the wrong magic number! 
The real problem is not that I chose the

<em>wrong</em> magic number; it’s that our

<em>scale</em> needs to be updated whenever the dataset is updated. 
Whenever we plug in new data values, we should also recalibrate our scale to ensure that bars don’t get too tall or too short.

Updating a scale is easy. 
You’ll recall we created <code class="literal">yScale</code> with this code:

<code class="kd">var</code> <code class="nx">yScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)])</code>                 <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code>
The

<em>range</em> can stay the same (as the visual size of our chart isn’t changing), but after the new dataset has been generated, we should update the scale’s

<em>domain</em>:

<code class="c1">//Update scale domain</code> <code class="nx">yScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)]);</code>
This sets the upper end of the input domain to the largest data value in <code class="literal">dataset</code>. 
Later, when we update all the bars and labels, we already reference <code class="literal">yScale</code> to calculate their positions, so no other code changes are necessary.

Check it out in

<em>18_dynamic_scale.html</em>. 
I went ahead and replaced our magic number <code class="literal">25</code> with <code class="literal">maxValue</code>, which I set here to <code class="literal">100</code>. 
So now when we click to update, we get random numbers between 0 and 100. 
If the

<em>maximum</em> value in the dataset is 100, then <code class="literal">yScale</code>’s domain will go up to 100, as we see in

<a class="xref" href="#Randomdatabuttheyaxisscaleautomaticallyaccommodates" title="Figure 9-10. Random data, but the y-axis scale automatically accommodates">Figure 9-10</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0910.png" alt="Random data, but the y-axis scale automatically accommodates">
Figure 9-10. Random data, but the y-axis scale automatically accommodates 
But because the numbers are random, they won’t always reach that maximum value of 100. 
In

<a class="xref" href="#Aslightlydifferentscaleduetoslightlydifferentdata" title="Figure 9-11. A slightly different scale, due to slightly different data">Figure 9-11</a>, they top out at 85.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0911.png" alt="A slightly different scale, due to slightly different data">
Figure 9-11. A slightly different scale, due to slightly different data 
Note that the height of the 100 bar in the first chart is

<em>the same</em> as the height of the 85 bar here. 
The data is changing; the scale input domain is changing; the output visual range does

<em>not</em> change.

<h3>Updating Axes</h3>
The bar chart doesn’t have any axes, but our scatterplot from the last

 chapter does (

<a class="xref" href="#Updatedscatterplotnowwithdataupdatesanddynamicscales" title="Figure 9-12. Updated scatterplot, now with data updates and dynamic scales">Figure 9-12</a>). 
I’ve brought it back, with a few tweaks, in

<em>19_axes_static.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0912.png" alt="Updated scatterplot, now with data updates and dynamic scales">
Figure 9-12. Updated scatterplot, now with data updates and dynamic scales 
To summarize the changes to the scatterplot:

 You can now click the text at top to generate and update with new data. 
 Animated transitions are used after data updates. 
 I eliminated the staggered delay, and set all transitions to occur over a full second (1,000 ms). 
 Both the x- and y-axis scales are updated, too. 
 Circles now have a constant radius. 
 
Try clicking the text and watch all those little dots zoom around. 
Cute! I sort of wish they represented some meaningful information, but hey, random data can be fun, too.

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/19_axes_static.html" target="_blank">19_axes_static</a>

What’s

<em>not</em> happening yet is that the axes aren’t updating. 
Fortunately, that is simple to do.

First, I am going to add the class names <code class="literal">x</code> and <code class="literal">y</code> to our x- and y-axes, respectively. 
This will help us select those axes later:

<code class="c1">//Create x-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"x axis"</code><code class="p">)</code>    <code class="c1">// &lt;-- Note x added here</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>  <code class="c1">//Create y-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>    <code class="c1">// &lt;-- Note y added here</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">padding</code> <code class="o">+</code> <code class="s2">",0)"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
Then, down in our click function, we simply add:

<code class="c1">//Update x-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".x.axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">xAxis</code><code class="p">);</code>  <code class="c1">//Update y-axis</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">".y.axis"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>     <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
For each axis, we do the following:

<ol class="orderedlist" type="1">
 Select the axis. 
 Initiate a transition. 
 Set the transition’s duration. 
 Call the appropriate axis generator. 
 </ol>
Remember that each axis generator is already referencing a scale (either <code class="literal">xScale</code> or <code class="literal">yScale</code>). 
Because those scales are being updated, the axis generators can calculate what the new tick marks should be.

Open up

<em>20_axes_dynamic.html</em> and give it a try.

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/20_axes_dynamic.html" target="_blank">20_axes_dynamic</a>

Once again, <code class="literal">transition()</code> handles all the interpolation magic for you—watch those ticks fade in and out. 
Just beautiful, and you barely had to lift a finger.

<h3>each() Transition Starts and Ends</h3>
There will be times when you want to make something happen at the start or end of a transition. 
In those times, you can use <code class="literal">each()</code> to execute arbitrary code for each element in the selection.

<code class="literal">each()</code> expects two arguments:

 Either <code class="literal">"start"</code> or <code class="literal">"end"</code>  An anonymous function, to be executed either at the start of a transition, or as soon as it has ended  
For example, here is our circle-updating code, with two <code class="literal">each()</code> statements added:

<code class="c1">//Update all circles</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>    <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>      <code class="c1">// &lt;-- Executes at start of transition</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"end"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>        <code class="c1">// &lt;-- Executes at end of transition</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>    <code class="p">});</code>
You can see this in action in

<em>21_each.html</em>.

Now you click the trigger, and immediately each circle’s fill is set to magenta, and its radius is set to 3 (see

<a class="xref" href="#Hotpinkcirclesinmidtransition" title="Figure 9-13. Hot pink circles, midtransition">Figure 9-13</a>). 
Then the transition is run, per usual. 
When complete, the fills and radii are restored to their original values.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0913.png" alt="Hot pink circles, midtransition">
Figure 9-13. Hot pink circles, midtransition 
Something to note is that within the anonymous function passed to <code class="literal">each()</code>, the context of <code class="literal">this</code> is maintained as “the current element.” This is handy because then <code class="literal">this</code> can be referenced with the function to easily reselect the current element and modify it, as done here:

   <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>              <code class="c1">// Selects 'this', the current element</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>   <code class="c1">// Sets fill of 'this' to magenta</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>             <code class="c1">// Sets radius of 'this' to 3</code>    <code class="p">})</code>

<h4>Warning: Start carefully</h4>
You might be tempted to throw another transition in here,

 resulting in a smooth fade from black to magenta. 
Don’t do it! Or do it, but note that this will break:

   <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>          <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>              <code class="c1">// New transition</code>          <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">250</code><code class="p">)</code>             <code class="c1">// New duration</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>          <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>    <code class="p">})</code>
If you try this, and I recommend that you do, you’ll find that the circles do indeed fade to pink, but they no longer change positions in space. 
That’s because, by default, only one transition can be active on any given element at any given time. 
Newer transitions interrupt and override older transitions.

This might seem like a design flaw, but D3 operates this way on purpose. 
Imagine if you had several different buttons, each of which triggered a different view of the data, and a visitor was clicking through them in rapid succession. 
Wouldn’t you want an earlier transition to be interrupted, so the last-selected view could be put in place right away?

If you’re familiar with jQuery, you’ll notice a difference here. 
By default, jQuery queues transitions, so they execute one after another, and calling a new transition doesn’t automatically interrupt any existing ones. 
This sometimes results in annoying interface behavior, like menus that fade in when you mouse over them, but won’t start fading out until

<em>after</em> the fade-in has completed.

In this case, the code “breaks” because the first (spatial) transition is begun, then <code class="literal">each("start", …)</code> is called on each element. 
Within <code class="literal">each()</code>, a second transition is initiated (the fade to pink), overriding the first transition, so the circles never make it to their final destinations (although they look great, just sitting at home).

Because of this quirk of transitions, just remember that <code class="literal">each("start", …)</code> should be used only for immediate transformations, with no transitions.


<h4>End gracefully</h4>
<code class="literal">each("end", …)</code>, however,

<em>does</em> support transitions. 
By the time <code class="literal">each("end", …)</code> is called, the primary transition has already ended, so initiating a new transition won’t cause any harm.

See

<em>22_each_combo_transition.html</em>. 
Within the first <code class="literal">each()</code> statement, I bumped the pink circle radius size up to 7. 
In the second, I added two lines for transition and a duration:

<code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"end"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>     <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>       <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>             <code class="c1">// &lt;-- New!</code>       <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>           <code class="c1">// &lt;-- New!</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code> <code class="p">});</code>
Watch that transition: so cool! Note the sequence of events:

<ol class="orderedlist" type="1">
 You click the <code class="literal">p</code> text. 
 Circles turn pink and increase in size immediately. 
 Circles transition to new positions. 
 Circles transition to original color and size. 
 </ol>
Also, try clicking on the <code class="literal">p</code> trigger several times in a row. 
Go ahead, just go nuts, click as fast as you can. 
Notice how each click interrupts the circles’ progress. 
(Sorry, guys!) You’re seeing each new transition request override the old one. 
The circles will never reach their final positions and fade to black unless you stop clicking and give them time to rest.

As cool as that is, there is an even simpler way to schedule multiple transitions to run one after the other: we simply chain transitions together. 
 (This is a new feature in version 3.0 and won’t work with older versions.)  For example, instead of reselecting elements and calling a new transition on each one within <code class="literal">each("end", …)</code>, we can just tack a second transition onto the end of the chain:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="c1">// &lt;-- Transition #1</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>    <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>            <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>              <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"magenta"</code><code class="p">)</code>              <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">7</code><code class="p">);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code>    <code class="p">})</code>    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>    <code class="c1">// &lt;-- Transition #2</code>    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
Try that code out in

<em>23_each_combo_transition_chained.html</em>, and you’ll see it has the same behavior.

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/23_each_combo_transition_chained.html" target="_blank">23_each_combo_transition_chained</a>

When sequencing multiple transitions, I recommend this chaining approach. 
 Then only use <code class="literal">each()</code> for immediate (nontransitioned) changes that need to occur right before or right after transitions. 
 As you can imagine, it’s possible to create quite complex sequences of discrete and animated changes by chaining together multiple transitions, each of which can have its own calls to <code class="literal">each("start", …)</code> and <code class="literal">each("end", …)</code>.

<h4>Transitionless each()</h4>
You can also use <code class="literal">each()</code> outside of a transition, just to execute arbitrary code for each element in a selection. 
Outside of transitions, just omit the <code class="literal">"start"</code> or <code class="literal">"end"</code> parameter, and only pass in the anonymous function.

Although I didn’t do this here, you can also include references to <code class="literal">d</code> and <code class="literal">i</code> within your function definition, and D3 will hand off those values, as you’d expect:

<code class="err">…</code> <code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Do something with d and i here</code> <code class="p">});</code> 

<h4>Containing visual elements with clipping paths</h4>
On a slightly related note, you might have noticed that during these

 transitions, points with low x or y values would exceed the boundaries of the chart area, and overlap the axis lines, as displayed in

<a class="xref" href="#Pointsexceedingthechartarea" title="Figure 9-14. Points exceeding the chart area">Figure 9-14</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0914.png" alt="Points exceeding the chart area">
Figure 9-14. Points exceeding the chart area 
Fortunately, SVG has support for

<em>clipping paths</em>, which might be more familiar to you as

<em>masks</em>, as in Photoshop or Illustrator. 
A clipping path is an SVG element that contains visual elements that, together, make up the clipping path or mask to be applied to other elements. 
When a mask is applied to an element, only the pixels that land within that mask’s shape are displayed.

Much like <code class="literal">g</code>, a <code class="literal">clipPath</code> has no visual presence of its own, but it contains visual elements (which are used to make the mask). 
For example, here’s a simple <code class="literal">clipPath</code>:

<code class="nt">&lt;clipPath</code> <code class="na">id=</code><code class="s">"chart-area"</code><code class="nt">></code>     <code class="nt">&lt;rect</code> <code class="na">x=</code><code class="s">"30"</code> <code class="na">y=</code><code class="s">"30"</code> <code class="na">width=</code><code class="s">"410"</code> <code class="na">height=</code><code class="s">"240"</code><code class="nt">>&lt;/rect></code> <code class="nt">&lt;/clipPath></code>
Note that the outer <code class="literal">clipPath</code> element has been given an ID of <code class="literal">chart-area</code>. 
We can use that ID to reference it later. 
Within the <code class="literal">clipPath</code> is a <code class="literal">rect</code>, which will function as the mask.

So there are three steps to using a clipping path:

<ol class="orderedlist" type="1">
 Define the <code class="literal">clipPath</code> and give it an ID. 
 Put visual elements within the <code class="literal">clipPath</code> (usually just a <code class="literal">rect</code>, but this could be <code class="literal">circle</code>s or any other visual elements). 
 Add a reference to the <code class="literal">clipPath</code> from whatever element(s) you wish to be masked. 
 </ol>
Continuing with the scatterplot, I’ll define the clipping path with this new code (steps 1 and 2):

<code class="c1">//Define clipping path</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>                  <code class="c1">//Make a new clipPath</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"chart-area"</code><code class="p">)</code>           <code class="c1">//Assign an ID</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>                     <code class="c1">//Within the clipPath, create a new rect</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">padding</code><code class="p">)</code>                 <code class="c1">//Set rect's position and size…</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">padding</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code> <code class="o">-</code> <code class="nx">padding</code> <code class="o">*</code> <code class="mi">3</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">padding</code> <code class="o">*</code> <code class="mi">2</code><code class="p">);</code>
I want all of the <code class="literal">circle</code>s to be masked by this <code class="literal">clipPath</code>. 
I could add a <code class="literal">clipPath</code> reference to every single circle, but it’s much easier and cleaner to just put all the <code class="literal">circle</code>s into a <code class="literal">g</code> group, and then add the reference to that (this is step 3).

So, I will modify this code:

<code class="c1">//Create circles</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="err">…</code>
by adding three new lines, creating a new <code class="literal">g</code>, giving it an arbitrary ID, and finally adding the reference to the <code class="literal">chart-area</code> <code class="literal">clipPath</code>:

<code class="c1">//Create circles</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>                             <code class="c1">//Create new g</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"circles"</code><code class="p">)</code>                   <code class="c1">//Assign ID of 'circles'</code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#chart-area)"</code><code class="p">)</code>   <code class="c1">//Add reference to clipPath</code>    <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>                     <code class="c1">//Continue as before…</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>    <code class="err">…</code>
Notice that the attribute name is <code class="literal">clip-path</code>, and the element name is <code class="literal">clipPath</code>. 
Argh! I know; it drives me crazy, too.

View the sample page

<em>24_clip-path.html</em> and open the web inspector. 
Let’s look at that new <code class="literal">rect</code> in

<a class="xref" href="#ThedimensionsofarectwithinaclipPath" title="Figure 9-15. The dimensions of a rect within a clipPath">Figure 9-15</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0915.png" alt="The dimensions of a rect within a clipPath">
Figure 9-15. The dimensions of a rect within a clipPath 
Because <code class="literal">clipPath</code>s have no visual rendering (they only mask other elements), it’s helpful to highlight them in the web inspector, which will then outline the path’s position and size with a blue highlight. 
In

<a class="xref" href="#ThedimensionsofarectwithinaclipPath" title="Figure 9-15. The dimensions of a rect within a clipPath">Figure 9-15</a> we can see that the <code class="literal">clipPath rect</code> is in the right place and is the right size.

Notice, too, that now all the <code class="literal">circle</code>s are grouped within a single <code class="literal">g</code> element, whose <code class="literal">clip-path</code> attribute references our new clipping path, using the slightly peculiar syntax <code class="literal">url(#chart-area)</code>. 
Thanks for that, SVG specification.

The end result is that our <code class="literal">circle</code>s’ pixels get clipped when they get too close to the edge of the chart area. 
Note the points at the extreme top and right edges.

The clipping is easier to see midtransition, as in

<a class="xref" href="#Pointscontainedwithinthechartarea" title="Figure 9-16. Points contained within the chart area">Figure 9-16</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0916.png" alt="Points contained within the chart area">
Figure 9-16. Points contained within the chart area 
Voilà! The points no longer exceed the chart boundaries.

   

<h2>Other Kinds of Data Updates</h2>
Until now, when updating data, we have taken the “whole kit-and-kaboodle” approach: changing values in the dataset array, and then rebinding that revised dataset, overwriting the original values bound to our DOM elements.

That approach is most useful when

<em>all</em> the values are changing, and when the length of the dataset (i.e., the number of values) stays the same. 
But as we know, real-life data is messy, and calls for even more flexibility, such as when you only want to update one or two values, or you even need to add or subtract values. 
D3, again, comes to the rescue.

<h3>Adding Values (and Elements)</h3>
Let’s go back to our lovely bar chart, and say that some user interaction (a mouse click) should now trigger adding a

<em>new</em> value to our dataset. 
That is, the length of the array <code class="literal">dataset</code> will increase by one.

Well, generating a random number and pushing it to the array is easy enough:

<code class="c1">//Add one new value to dataset</code> <code class="kd">var</code> <code class="nx">maxValue</code> <code class="o">=</code> <code class="mi">25</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">maxValue</code><code class="p">);</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">newNumber</code><code class="p">);</code>
Making room for an extra bar will require recalibrating our x-axis scale. 
That’s just a matter of updating its input domain to reflect the new length of <code class="literal">dataset</code>:

<code class="nx">xScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">range</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code><code class="p">));</code>
That’s the easy stuff. 
Now prepare to bend your brain yet again, as we dive into the depths of D3

<em>selections</em>.

<h4>Select</h4>
By now, you are comfortable using <code class="literal">select()</code> and <code class="literal">selectAll()</code> to grab and return DOM element selections. 
And you’ve even seen how, when these methods are chained, they grab selections within selections, and so on,

 as in:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">);</code>   <code class="c1">//Returns all 'p' elements within 'body'</code>
When storing the

<em>results</em> of these selection methods, the most specific result—meaning the result of the last selector in the chain—is the reference handed off to the variable. 
For example:

<code class="kd">var</code> <code class="nx">paragraphs</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">);</code>
Now <code class="literal">paragraphs</code> contains a selection of all <code class="literal">p</code> elements in the DOM, even though we traversed through <code class="literal">body</code> to get there.

The twist here is that the <code class="literal">data()</code> method

<em>also</em> returns a selection. 
Specifically,
<code class="literal">data()</code> returns references to all elements to which data was just bound, which we call the

<em>update</em> selection.

In the case of our bar chart, this means that we can select all the bars, then rebind the new data to those bars, and grab the update selection all in one fell swoop:

<code class="c1">//Select…</code> <code class="kd">var</code> <code class="nx">bars</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code>
Now the update selection is stored in <code class="literal">bars</code>.

<h4>Enter</h4>
When we changed our data values, but not the

<em>length</em> of the whole data set, we didn’t have to worry about an update selection—we simply rebound the data, and transitioned to new attribute values.

But now we have

<em>added</em> a value. 
So <code class="literal">dataset.length</code> was originally 20, but now it is 21. 
How can we address that new data value, specifically, to draw a new <code class="literal">rect</code> for it? Stay with me here; your patience will be rewarded.

The genius of the update selection is that it contains within it references to

<em>enter</em> and

<em>exit</em> subselections.

<em>Entering</em> elements are those that are new to the scene. 
It’s considered good form to welcome such elements to the neighborhood with a plate of cookies.

Whenever there are more data values than corresponding DOM elements, the

<em>enter</em> selection contains references to those elements

<em>that do not yet exist</em>. 
You already know how to access the enter selection: by using <code class="literal">enter()</code> after binding the new data, as we do when first creating the bar chart. 
You have already seen the following code:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> <code class="c1">//Selects all rects (as yet nonexistent)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>     <code class="c1">//Binds data to selection, returns update selection</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>           <code class="c1">//Extracts the enter selection, i.e., 20 placeholder elements</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="c1">//Creates a 'rect' inside each of the placeholder elements</code>    <code class="err">…</code>
You have already seen this sequence of <code class="literal">selectAll()</code>→<code class="literal">data()</code>→<code class="literal">enter()</code>→
<code class="literal">append()</code> many times, but only in the context of creating many elements at once, when the page first loads.

Now that we have added one value to <code class="literal">dataset</code>, we can use <code class="literal">enter()</code> to address the one new corresponding DOM element, without touching all the existing <code class="literal">rect</code>s. 
Following the preceding <code class="literal">Select</code> code, I’ll add:

<code class="c1">//Enter…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">enter</code><code class="p">()</code>     <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>     <code class="p">});</code>
Remember, <code class="literal">bars</code> contains the update selection, so <code class="literal">bars.enter()</code> extracts the enter selection from that. 
In this case, the enter selection is one reference to one new DOM element. 
We follow that with <code class="literal">append()</code> to create the new <code class="literal">rect</code>, and all the other <code class="literal">attr()</code> statements as usual, except for the following line:

<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>
You might notice that this sets the horizontal position of the new <code class="literal">rect</code> to be just past the far right edge of the SVG. 
I want the new bar to be created just out of sight, so I can use a nice, smooth transition to move it gently into view.

<h4>Update</h4>
We made the new <code class="literal">rect</code>; now all that’s left is to update all <code class="literal">rect</code>’s visual attributes. 
Again, <code class="literal">bars</code> here stores the complete update selection (which includes the enter selection):

<code class="c1">//Update…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>     <code class="p">});</code>
This has the effect of taking

<em>all</em> the bars and transitioning them to their new x, y, width, and height values. 
Don’t believe me? See the working code in

<em>25_adding_values.html</em>.

<a class="xref" href="#Initialbarchart" title="Figure 9-17. Initial bar chart">Figure 9-17</a> shows the initial chart.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0917.png" alt="Initial bar chart">
Figure 9-17. Initial bar chart 

<a class="xref" href="#Afteroneclick" title="Figure 9-18. After one click">Figure 9-18</a> shows the chart after one click on the text. 
Note the new bar on the right.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0918.png" alt="After one click">
Figure 9-18. After one click 
After two clicks, we get the chart shown in

<a class="xref" href="#Aftertwoclicks" title="Figure 9-19. After two clicks">Figure 9-19</a>.

<a class="xref" href="#Afterthreeclicks" title="Figure 9-20. After three clicks">Figure 9-20</a> shows the result after three clicks.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0919.png" alt="After two clicks">
Figure 9-19. After two clicks 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0920.png" alt="After three clicks">
Figure 9-20. After three clicks 
After several more clicks, you’ll see the chart shown in

<a class="xref" href="#Aftermanyclicks" title="Figure 9-21. After many clicks">Figure 9-21</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0921.png" alt="After many clicks">
Figure 9-21. After many clicks 
Not only are new bars being created, sized, and positioned, but on every click,

<em>all other bars</em> are rescaled and moved into position as well.

What’s

<em>not</em> happening is that new value labels aren’t being created and transitioned into place. 
I leave that as an exercise for you to pursue.

Exercise
Add code in the below-left panel to add labels to the newly created bars. 
Test your solution in the output panel at right

<a href="http://examples.oreilly.com/0636920026938/chapter_09/25_adding_values.html" target="_blank">25_adding_values</a>

<h3>Removing Values (and Elements)</h3>
Removing elements is easier.

Whenever there are more DOM elements than data values, the

<em>exit</em> selection contains references to those elements without data. 
As you’ve

 already guessed, we can access the exit selection with <code class="literal">exit()</code>.

First, I’ll change our trigger text to indicate we’re removing values:

<code class="nt">&lt;p></code>Click on this text to remove a data value from the chart!<code class="nt">&lt;/p></code>
Then, on click, instead of generating a new random value and adding it to <code class="literal">dataset</code>, we’ll use <code class="literal">shift()</code>, which removes the first element from the array:

<code class="c1">//Remove one value from dataset</code> <code class="nx">dataset</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code>

<h4>Exit</h4>

<em>Exiting</em> elements are those that are on their way out. 
We should be polite and wish these elements a safe journey.

So we grab the exit selection, transition the exiting element off to the right side, and, finally, remove it:

<code class="c1">//Exit…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">exit</code><code class="p">()</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>     <code class="p">.</code><code class="nx">remove</code><code class="p">();</code>
<code class="literal">remove()</code> is a special transition method that waits until the transition is complete, and then deletes the element from the DOM forever. 
(Sorry, there’s no getting it back.)

<h4>Making a smooth exit</h4>
Visually speaking, it’s good practice to perform a transition first, rather than simply <code class="literal">remove()</code> elements right away. 
In this case, we’re moving the bar off to the right, but you could just as easily transition <code class="literal">opacity</code> to zero, or apply some other visual transition.

That said, if you ever need to just get rid of an element ASAP, by all means, you can use <code class="literal">remove()</code> without calling a transition first.

Okay, now try out the code in

<em>26_removing_values.html</em>.

<a class="xref" href="#Initial_bar_chart" title="Figure 9-22. Initial bar chart">Figure 9-22</a> shows the initial view.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0922.png" alt="Initial bar chart">
Figure 9-22. Initial bar chart 
Then, after one click on the text, note the loss of one bar in

<a class="xref" href="#After_one_click" title="Figure 9-23. After one click">Figure 9-23</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0923.png" alt="After one click">
Figure 9-23. After one click 
After two clicks, you’ll see the chart in

<a class="xref" href="#After_two_clicks" title="Figure 9-24. After two clicks">Figure 9-24</a>.

<a class="xref" href="#After_three_clicks" title="Figure 9-25. After three clicks">Figure 9-25</a> shows what displays after three clicks.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0924.png" alt="After two clicks">
Figure 9-24. After two clicks 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0925.png" alt="After three clicks">
Figure 9-25. After three clicks 
After many clicks, the result is shown in

<a class="xref" href="#After_many_clicks" title="Figure 9-26. After many clicks">Figure 9-26</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0926.png" alt="After many clicks">
Figure 9-26. After many clicks 
On each click, one bar moves off to the right, and then is removed from the DOM. 
(You can confirm this with the web inspector.)

But what’s not working as expected? For starters, the value labels aren’t being removed, so they clutter up the top right of our chart. 
Again, I will leave fixing this aspect as an exercise to you.

Exercise
Add code in the below-left panel to remove the labels corresponding to the deleted bars. 
Test your solution in the output panel at right

<a href="http://examples.oreilly.com/0636920026938/chapter_09/26_removing_values.html" target="_blank">26_removing_values</a>

More important, although we are using the <code class="literal">Array.shift()</code> method to remove the

<em>first</em> value from the <code class="literal">dataset</code> array, it’s not the

<em>first</em> bar that is removed, is it? Instead, the last bar in the DOM, the one visually on the far right, is always removed. 
Although the data values are updating correctly (note how they move to the left with each click—5, 10, 13, 19, and so on), the bars are assigned new values, rather than “sticking” with their intial values. 
That is, the anticipated

<em>object constancy</em> is broken—the “5” bar becomes the “10” bar, and so on, yet perceptually we would prefer that the “5” bar simply scoot off to the left and let all the other bars keep their original values.

Why, why, oh, why is this happening?! Not to worry; there’s a perfectly reasonable explanation. 
The key to maintaining object constancy is, well, keys. 
 (On a side note, Mike Bostock has a very eloquent

<a class="ulink" href="http://bost.ocks.org/mike/constancy/" target="_top">overview of the value of object constancy</a>, which I recommend.)

  

<h3>Data Joins with Keys</h3>
Now that you understand update, enter, and exit selections, it’s time to dig deeper into data joins.

A data join happens whenever you bind data to DOM elements; that is, every time you call <code class="literal">data()</code>.

The default join is by

<em>index order</em>, meaning the first data value is bound to the first DOM element in the selection, the second value is bound to the second element, and so on.

But what if the data values and DOM elements are not in the same order? Then you need to tell D3 how to join or pair values and elements. 
Fortunately, you can define those rules by specifying a

<em>key function</em>.

This explains the problem with our bars. 
After we remove the first value from the <code class="literal">dataset</code> array, we rebind the new <code class="literal">dataset</code> on top of the existing elements. 
Those values are joined in index order, so the first <code class="literal">rect</code>, which originally had a value of 5, is now assigned 10. 
The former 10 bar is assigned 13, and so on. 
In the end, that leaves one <code class="literal">rect</code> element without data—the last one on the far right.

We can use a

<em>key function</em> to control the data join with more specificity and ensure that the right datum is bound to the right <code class="literal">rect</code> element.

<h4>Preparing the data</h4>
Until now, our dataset has been a simple array of values. 
But to use a key function, each value must have some “key” associated with it. 
Think of the key as a means of identifying the value without looking at the value itself, as the values themselves might change or exist in duplicate form. 
(If there were two separate values of <code class="literal">3</code>, how could you tell them apart?)

Instead of an array of values, let’s use an array of

<em>objects</em>, within which each object can contain both a key value and the actual data value:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">10</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">13</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">19</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">21</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">25</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">6</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">22</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">18</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">8</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">15</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">9</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">13</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">11</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">11</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">12</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">15</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">13</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">20</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">14</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">18</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">15</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">17</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">16</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">16</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">17</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">18</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">23</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="mi">19</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="mi">25</code> <code class="p">}</code> <code class="p">];</code>
Remember, hard brackets <code class="literal">[]</code> indicate an array, and curly brackets <code class="literal">{}</code> indicate an object.

Note that the data values here are unchanged from our original <code class="literal">dataset</code>. 
What’s new are the keys, which just enumerate each object’s original position within the <code class="literal">dataset</code> array. 
(By the way, your chosen key name doesn’t have to be <code class="literal">key</code>—the name can be anything, like <code class="literal">id</code>, <code class="literal">year</code>, or <code class="literal">fruitType</code>. 
I am using <code class="literal">key</code> here for simplicity.)

<h4>Updating all references</h4>
The next step isn’t fun, but it’s not hard. 
Now that our data values are buried within objects, we can no longer just reference <code class="literal">d</code>. 
(Ah, the good old days.) Anywhere in the code where we want to access the actual data

<em>value</em>, we now need to specify <code class="literal">d.value</code>. 
When we use anonymous functions within D3 methods, <code class="literal">d</code> is handed whatever is in the current position in the array. 
In this case, each position in the array now contains an object, such as <code class="literal">{ key: 12, value: 15 }</code>. 
So to get at the value <code class="literal">15</code>, we now must write <code class="literal">d.value</code> to reach

<em>into</em> the object and grab that <code class="literal">value</code> value. 
(I hope you see a lot of value in this paragraph.)

First, that means a change to the <code class="literal">yScale</code> definition:

<code class="kd">var</code> <code class="nx">yScale</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">linear</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})])</code>                 <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">h</code><code class="p">]);</code>
In the second line, we used to have simply <code class="literal">d3.max(dataset)</code>, but that only works with a simple array. 
Now that we’re using objects, we have to include an

<em>accessor function</em> that tells <code class="literal">d3.max()</code> how to get at the correct values to compare. 
So as <code class="literal">d3.max()</code> loops through all the elements in the <code class="literal">dataset</code> array, now it knows not to look at <code class="literal">d</code> (which is an object, and not easily compared to other objects), but <code class="literal">d.value</code> (a number, which is easily compared to other numbers).

Note we also need to change the second reference to <code class="literal">yScale</code>, down in our click-update function:

<code class="nx">yScale</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})]);</code>
Next up, everywhere <code class="literal">d</code> is used to set attributes, we must change <code class="literal">d</code> to <code class="literal">d.value</code>. 
For example, this:

<code class="err">…</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>        <code class="c1">// &lt;-- d</code> <code class="p">})</code> <code class="err">…</code>
becomes this:

<code class="err">…</code> <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">h</code> <code class="o">-</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>  <code class="c1">// &lt;-- d.value!</code> <code class="p">})</code> <code class="err">…</code> 

<h4>Key functions</h4>
Finally, we define a key function, to be used whenever we bind data to

 elements:

<code class="kd">var</code> <code class="nx">key</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">;</code> <code class="p">};</code>
Notice that, in typical D3 form, the function takes <code class="literal">d</code> as input. 
Then this very simple function specifies to take the <code class="literal">key</code> value of whatever <code class="literal">d</code> object is passed into it.

Now, in all four places where we bind data, we replace this line:

<code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>
with this:

<code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code>
Note that rather than defining the key function first, then referencing it, you could of course simply write the key function directly into the call to <code class="literal">data()</code> like so:

<code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">;</code> <code class="p">})</code>
But in this case, you’d have to write that four times, which is redundant, so I think defining the key function once at the top is cleaner.

That’s it! Consider your data joined.

<h4>Exit transition</h4>
One last tweak: Let’s set the exiting bar to scoot off to the left side

 instead of the right:

<code class="c1">//Exit…</code> <code class="nx">bars</code><code class="p">.</code><code class="nx">exit</code><code class="p">()</code>     <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>     <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="o">-</code><code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">())</code>  <code class="c1">// &lt;-- Exit stage left</code>     <code class="p">.</code><code class="nx">remove</code><code class="p">();</code>
Great! Check out the sample code, with all of those changes, in

<em>27_data_join_with_key.html</em>. 
The initial view shown in

<a class="xref" href="#Initial-bar-chart" title="Figure 9-27. Initial bar chart">Figure 9-27</a> is unchanged.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0927.png" alt="Initial bar chart">
Figure 9-27. Initial bar chart 
Try clicking the text, though, and the leftmost bar slides cleanly off to the left, all other bars’ widths rescale to fit, and then the exited bar is deleted from the DOM. 
(Again, you can confirm this by watching the <code class="literal">rect</code>s disappear one by one in the web inspector.)

<a class="xref" href="#After-one-click" title="Figure 9-28. After one click">Figure 9-28</a> shows the view after one bar is removed.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0928.png" alt="After one click">
Figure 9-28. After one click 
After two clicks, you’ll see the chart in

<a class="xref" href="#After-two-clicks" title="Figure 9-29. After two clicks">Figure 9-29</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0929.png" alt="After two clicks">
Figure 9-29. After two clicks 

<a class="xref" href="#After-three-clicks" title="Figure 9-30. After three clicks">Figure 9-30</a> displays the results after three clicks, and after several clicks, you’ll see the result shown in

<a class="xref" href="#After-many-clicks" title="Figure 9-31. After many clicks">Figure 9-31</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0930.png" alt="After three clicks">
Figure 9-30. After three clicks 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_0931.png" alt="After many clicks">
Figure 9-31. After many clicks 
This is working better than ever. 
The only hitch is that the labels aren’t exiting to the left, and also are not removed from the DOM, so they clutter up the left side of the chart. 
Again, I leave this to you; put your new D3 chops to the test and clean up those labels.

Exercise
Add code in the below-left panel to remove the labels corresponding to the deleted bars. 
Test your solution in the output panel at right

<a href="http://examples.oreilly.com/0636920026938/chapter_09/27_data_join_with_key.html" target="_blank">27_data_join_with_key</a>

<h3>Add and Remove: Combo Platter</h3>
We could stop there and be very satisfied with our newfound skills. 
But why not go all the way, and adjust our chart so data values can be added

<em>and</em> removed?

This is easier than you might think. 
First, we’ll need two different triggers for the user interaction. 
I’ll split the one paragraph into two, and give each a unique ID, so we can tell which one is clicked:

<code class="nt">&lt;p</code> <code class="na">id=</code><code class="s">"add"</code><code class="nt">></code>Add a new data value<code class="nt">&lt;/p></code> <code class="nt">&lt;p</code> <code class="na">id=</code><code class="s">"remove"</code><code class="nt">></code>Remove a data value<code class="nt">&lt;/p></code>
Later, down where we set up the click function, <code class="literal">select()</code> must become
<code class="literal">selectAll()</code>, now that we’re selecting more than one <code class="literal">p</code> element:

<code class="nx">d3</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="err">…</code>
Now that this click function will be bound to both paragraphs, we have to introduce some logic to tell the function to behave differently depending on which paragraph was clicked. 
There are many ways to achieve this; I’ll go with the most straightforward one.

Fortunately, within the context of our anonymous click function, <code class="literal">this</code> refers to the element that was clicked—the paragraph. 
So we can get the ID value of the clicked element by selecting <code class="literal">this</code> and inquiring using <code class="literal">attr()</code>:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">)</code>
That statement will return <code class="literal">"add"</code> when <code class="literal">p#add</code> is clicked, and <code class="literal">"remove"</code> when
<code class="literal">p#remove</code> is clicked. 
Let’s store that value in a variable, and use it to control an <code class="literal">if</code> statement:

<code class="c1">//See which p was clicked</code> <code class="kd">var</code> <code class="nx">paragraphID</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">);</code>  <code class="c1">//Decide what to do next</code> <code class="k">if</code> <code class="p">(</code><code class="nx">paragraphID</code> <code class="o">==</code> <code class="s2">"add"</code><code class="p">)</code> <code class="p">{</code>     <code class="c1">//Add a data value</code>     <code class="kd">var</code> <code class="nx">maxValue</code> <code class="o">=</code> <code class="mi">25</code><code class="p">;</code>     <code class="kd">var</code> <code class="nx">newNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">maxValue</code><code class="p">);</code>     <code class="kd">var</code> <code class="nx">lastKeyValue</code> <code class="o">=</code> <code class="nx">dataset</code><code class="p">[</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">].</code><code class="nx">key</code><code class="p">;</code>     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lastKeyValue</code><code class="p">);</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code>         <code class="nx">key</code><code class="o">:</code> <code class="nx">lastKeyValue</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code>         <code class="nx">value</code><code class="o">:</code> <code class="nx">newNumber</code>     <code class="p">});</code> <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>     <code class="c1">//Remove a value</code>     <code class="nx">dataset</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code> <code class="p">}</code>
So, if <code class="literal">p#add</code> is clicked, we calculate a new random value, and then look up the key value of the last item in <code class="literal">dataset</code>. 
Then we create a new object with an incremented key (to ensure we don’t duplicate keys; insert locksmith joke here) and the random data value.

No additional changes are needed! The enter/update/exit code we wrote is already flexible enough to handle adding

<em>or</em> removing data values—that’s the beauty of it.

Try it out in

<em>28_adding_and_removing.html</em>. 
You’ll see that you can click to add or remove data points at will. 
Of course, real-world data isn’t created this way, but you can imagine these data updates being triggered by some other event—such as data refreshes being pulled from a server—and not mouse clicks.

Also see

<em>29_dynamic_labels.html</em>, which is the same thing, only I’ve updated the code to add, transition, and remove the labels as well.

Try It Now!

<a href="http://examples.oreilly.com/0636920026938/chapter_09/29_dynamic_labels.html" target="_blank">29_dynamic_labels</a>

<h3>Recap</h3>
That was a lot of information! Let’s review:

 <code class="literal">data()</code> binds data to elements, but also returns the

<em>update selection</em>.

  The update selection can contain

<em>enter</em> and

<em>exit</em> selections, which can be accessed via <code class="literal">enter()</code> and <code class="literal">exit()</code>. 
 When there are

<em>more values than elements</em>, an enter selection will reference the placeholder, not-yet-existing elements. 
 When there are

<em>more elements than values</em>, an exit selection will reference the elements without data. 
 Data joins determine how values are matched with elements. 
 By default, data joins are performed by index, meaning in order of appearance. 
 For more control over data joins, you can specify a key function. 
 
As a final note, in the bar chart example, we used this sequence:

<ol class="orderedlist" type="1">
 Enter  Update  Exit  </ol>
Although this worked well for us, this order isn’t set in stone. 
Depending on your design goals, you might want to update first, then enter new elements, and finally exit old ones. 
It all depends—just remember that once you have the update selection in hand, you can reach in to grab the enter and exit selections anytime. 
The order in which you do so is flexible and completely up to you.

Fantastic. 
You are well on your way to becoming a D3 wizard. 
Now let’s get to the really fun stuff: interactivity!

<h1><span class="orange">Chapter 10. Interactivity</span></h1>
Now that you’re an old pro at data updates, transitions, and motion, let’s incorporate true interactivity.

<h2>Binding Event Listeners</h2>
Say

<em>what?</em>  I know, I know:  First, we bound

<em>data</em>, which was weird enough. 
 And now I’m talking about binding

<em>event listeners?</em>  (This is how JavaScript earned its reputation for being such a strange language.)

As explained in

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a>, JavaScript uses an

<em>event model</em> in which “events” are triggered by things happening, such as new input from the user, provided via a keyboard, mouse, or touch screen. 
 Most of the time, events are being triggered constantly, left and right—it’s just that nobody is

<em>listening</em> for them, so they are ignored.

To make our pieces interactive, we define chunks of code that

<em>listen</em> for specific events being triggered on specific DOM elements. 
 In

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a>, we used the following code:

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"p"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something on click</code>     <code class="p">});</code>
This

<em>binds</em> an

<em>event listener</em> to the <code class="literal">p</code> paragraph element. 
 The listener happens to be listening for the <code class="literal">click</code> event, which is the JavaScript event triggered when the user clicks the mouse

<em>on that <code class="literal">p</code> element</em>. 
(D3 doesn’t use custom event names, although you can define your own. 
 For the sake of supporting existing standards, D3 recognizes all the standard JavaScript events, such as <code class="literal">mouseover</code> and <code class="literal">click</code>. 
The events supported vary somewhat by browser. 
Peter-Paul Koch’s

<a class="ulink" href="http://www.quirksmode.org/dom/events/" target="_top">event compatibility tables</a> are a useful reference.)

This gets at one of the nuances of JavaScript’s event model, which is that events don’t happen in a vacuum. 
 Rather, they are always

<em>called on</em> a specific element. 
 So the code just shown isn’t activated whenever

<em>any</em> click occurs; it is run just when a click occurs

<em>on the <code class="literal">p</code> element</em>.

You could achieve all this with raw JavaScript, but D3’s <code class="literal">on()</code> method is a handy way to quickly bind event listeners to D3 selections. 
 As you can see, <code class="literal">on()</code> takes two arguments: the event name, and an anonymous function to be executed when the event is triggered on the selected element.

Making your visualization interactive is a simple, two-step process that includes:

<ol class="orderedlist" type="1">
 Binding event listeners  Defining the behavior  </ol> 

<h2>Introducing Behaviors</h2>
Let’s start by working with an earlier, static version of our bar chart. 
 See sample code

<em>01_start.html</em>.

The example code binds an event on only one element: <code class="literal">p</code>. 
 This is an unusual usage for <code class="literal">on()</code>.

 More commonly, you will want to bind event listeners to more than one element at a time, such as to

<em>all</em> of the visual elements in your visualization. 
 Fortunately, that is very easy to do. 
 Instead of using <code class="literal">select()</code> to select only one element, use
<code class="literal">selectAll()</code> to select multiple elements and pass that selection to <code class="literal">on()</code>.

You can even bind those event listeners right at the moment when you first create elements. 
 For example, here is our existing code that creates our bar chart’s <code class="literal">rect</code>s, to which I’ve simply tacked on <code class="literal">on()</code>:

<code class="c1">//Create bars</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="err">…</code>   <code class="c1">//Set attributes (omitted here)</code>    <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>        <code class="c1">//This will run whenever *any* bar is clicked</code>    <code class="p">});</code>
When defining the anonymous function, you can reference <code class="literal">d</code>, or <code class="literal">d</code> and <code class="literal">i</code>, or neither, just as you’ve seen throughout D3. 
 And then whatever code you put between the function’s brackets will execute on click.

This is a quick and easy way to verify your data values, for example:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>              <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code> <code class="p">});</code>
Try that code by running

<em>02_click.html</em>, open the JavaScript console, and click on some bars. 
 When you click on each bar, you should see that bar’s data value printed to the console. 
 Nice!

<h3>Hover to Highlight</h3>
Highlighting elements in response to mouse interaction is a common way to make your visualization feel more responsive, and it can help users navigate and focus on the data of interest.

A simple hover effect can be achieved with CSS alone—no JavaScript required!  The CSS pseudoclass selector <code class="literal">:hover</code> can be used in combination with any other selector to select, well, that same thing, but when the mouse is hovering

<em>over</em> the element. 
 Here, we select all SVG <code class="literal">rect</code>s and set their fill to <code class="literal">orange</code> (see

<a class="xref" href="#simple_css_only_mouse_hover" title="Figure 10-1. A simple CSS-only mouse hover effect">Figure 10-1</a>):

<code class="nt">rect</code><code class="nd">:hover</code> <code class="p">{</code>         <code class="k">fill</code><code class="o">:</code> <code class="nb">orange</code><code class="p">;</code> <code class="p">}</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1001.png" alt="A simple CSS-only mouse hover effect">
Figure 10-1. A simple CSS-only mouse hover effect 
See

<em>03_hover.html</em>, and try it out yourself.

CSS hover styling is fast and easy, but limited. 
 There’s only so much you can achieve with <code class="literal">:hover</code>. 
 Fortunately, recent browsers support applying the new CSS3 transitions on SVG elements. 
 Try adding this above the <code class="literal">rect:hover</code> rule in that example:

<code class="nt">rect</code> <code class="p">{</code>         <code class="o">-</code><code class="n">moz</code><code class="o">-</code><code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>         <code class="o">-</code><code class="n">o</code><code class="o">-</code><code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>         <code class="o">-</code><code class="n">webkit</code><code class="o">-</code><code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>         <code class="n">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code> <code class="p">}</code>
This tells browsers (including Mozilla, Opera, and Webkit-based browsers) to apply a 0.2-second transition to any changes to the <code class="literal">rect</code> elements. 
 Run that, and you’ll see that the blue/orange switch no longer happens instantly, but smoothly, over a brief
0.2-second period. 
 Nice!

Try It Now!
Add the following lines of code above the <code class="literal">rect:hover</code> rule in the CSS panel below:

<code class="nt">rect</code> <code class="p">{</code>    <code class="k">-moz-transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>    <code class="k">-o-transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>    <code class="k">-webkit-transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code>    <code class="k">transition</code><code class="o">:</code> <code class="n">all</code> <code class="m">0.3s</code><code class="p">;</code> <code class="p">}</code>
Then hover over the bars in the output at right, and note the smooth transitions

<a href="http://examples.oreilly.com/0636920026938/chapter_10/03_hover.html" target="_blank">03_hover</a>

Yet these transitions can also be managed using JavaScript and D3, for additional control and coordination with other parts of our visualization. 
 Luckily for us, D3 handles all the hassle of transitions for us, so working with JavaScript is not so bad. 
 Let’s re-create the orange hover effect without CSS.

Instead of referencing the <code class="literal">click</code> event, as we did earlier, we can call <code class="literal">on()</code> with <code class="literal">mouseover</code>, the JavaScript event equivalent of CSS’s <code class="literal">hover</code>:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="c1">//Do something on mouseover of any bar</code> <code class="p">});</code>
Now we want to set the <code class="literal">fill</code> of

<em>this</em> bar (the one on which the <code class="literal">mouseover</code> event is triggered) to orange. 
 Yet we are operating in the context of an anonymous function—how could we possibly select the same element on which the event was just triggered?

The answer is

<em>this</em>. 
 No, sorry, I mean <code class="literal">this</code>. 
 Just select <code class="literal">this</code>, and set its fill to orange:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"orange"</code><code class="p">);</code> <code class="p">});</code>
Another reason “real” programmers hate JavaScript is because of its notoriously wishy washy use of the keyword <code class="literal">this</code>. 
 In other languages, the meaning of <code class="literal">this</code> is very clearly defined; not so in JavaScript. 
 (jQuery fans are used to this debate.)

For our purposes, here is all you need to know:

 Context is important. 
 Within anonymous functions, D3 automatically sets the context of <code class="literal">this</code> so it references “the current element upon which we are acting.”  
The end result is that, when we hand off anonymous functions to any of D3’s methods, we can reference <code class="literal">this</code> when trying to act on the current element.

Indeed, you can see this (ha!) in action in

<em>04_mouseover.html</em> (

<a class="xref" href="#using_d3" title="Figure 10-2. Using D3 to set an orange fill on mouseover">Figure 10-2</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1002.png" alt="Using D3 to set an orange fill on mouseover">
Figure 10-2. Using D3 to set an orange fill on <code class="literal">mouseover</code>  
Move the mouse over a <code class="literal">rect</code>, the event listener for that <code class="literal">rect</code> is triggered, that same <code class="literal">rect</code> is selected (as <code class="literal">this</code>), and then its fill is set to orange.

<a class="xref" href="#using_d3" title="Figure 10-2. Using D3 to set an orange fill on mouseover">Figure 10-2</a> looks good, but we should probably restore each bar’s original color once the hover is over, meaning on <code class="literal">mouseout</code>:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code> <code class="p">});</code>
Perfect! Try it yourself in

<em>05_mouseout.html</em>. 
See

<a class="xref" href="#results_d3" title="Figure 10-3. Moving the mouse left to right, with fills set on mouseover and mouseout">Figure 10-3</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1003.png" alt="Moving the mouse left to right, with fills set on mouseover and mouseout">
Figure 10-3. Moving the mouse left to right, with fills set on <code class="literal">mouseover</code> and <code class="literal">mouseout</code>  
I am really excited to have accomplished in eight lines of JavaScript what I did originally with CSS in only three!  (Not!)

Actually, what I

<em>am</em> excited about is to now make the outbound transition silky smooth (see

<a class="xref" href="#smooth" title="Figure 10-4. Moving the mouse left to right (Smooth Operator Edition)">Figure 10-4</a>). 
 As you remember from

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a>, accomplishing that involves adding only two lines of code, for <code class="literal">transition()</code> and <code class="literal">duration()</code>:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>     <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>       <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>       <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">250</code><code class="p">)</code>       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"rgb(0, 0, "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code> <code class="p">});</code>
Try that out in

<em>06_smoother.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1004.png" alt="Moving the mouse left to right (Smooth Operator Edition)">
Figure 10-4. Moving the mouse left to right (Smooth Operator Edition) 

Try It Now!
Hover over the bars below, and note the smooth transitions.

<a href="http://examples.oreilly.com/0636920026938/chapter_10/06_smoother.html" target="_blank">06_smoother</a>

Pointer Events on Overlapping Elements
Mouse events are triggered only on elements with pixels that can be “touched” by the mouse. 
 If two elements overlap, and the mouse moves over the element that is “on top” (in other words, closer to the front), then the <code class="literal">mouseover</code> event will be triggered on the frontmost element, and

<em>not</em> on the element behind it.

You can see this in

<em>06_smoother.html</em>. 
 Mouse over any bar, and then move your pointer directly above one of the value labels. 
 You’ll see the bar fade back from orange to blue. 
 The <code class="literal">text</code> elements are in front of the bars, so mousing over a label involves also

<em>mousing out</em> of the <code class="literal">rect</code> behind it. 
 This is counterintuitive because, visually, we haven’t left the <code class="literal">rect</code> at all, but as far as JavaScript is concerned, we have.

Remember that in SVG, elements placed later in the DOM are rendered visually “in front” of earlier elements. 
 (See the section "Layering and Drawing Order" in

<a class="xref" href="" title="Chapter 3. Technology Fundamentals">Chapter 3</a>.)

In many cases, you might want mouse events on some elements (such as our value labels) to be ignored. 
 Luckily, this is as easy as applying one line of CSS to the elements you wish to have ignored:

<code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
This magically tells the browser “Hey, this element shouldn’t trigger any pointer events (such as <code class="literal">click</code>, <code class="literal">mouseover</code>, or <code class="literal">mouseout</code>), so just behave as if this element isn’t here.”  It lets events pass through to the next element below it.

Use normal CSS selectors to target the appropriate elements. 
For example, this would apply that to all SVG <code class="literal">text</code> elements:

<code class="nt">svg</code> <code class="nt">text</code> <code class="p">{</code>         <code class="n">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="k">none</code><code class="p">;</code> <code class="p">}</code>
Or, instead of including this in a stylesheet, you could specify the CSS with D3 directly when you create the <code class="literal">text</code> element, for example:

<code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="err">…</code>  <code class="c1">//other stuff here</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>   

<h2>Grouping SVG Elements</h2>
Note that <code class="literal">g</code> group elements

<em>do not</em>, by themselves, trigger any mouse events. 
 The reason for this is that <code class="literal">g</code> elements have no pixels!  Only their enclosed elements—like <code class="literal">rect</code>s, <code class="literal">circle</code>s, and <code class="literal">text</code> elements—have pixels.

You can still bind event listeners to <code class="literal">g</code> elements. 
 Just keep in mind that the elements within that <code class="literal">g</code> will then behave as a group. 
 For example, if

<em>any</em> of the enclosed elements are clicked or moused over, then the listener function will be activated.

This technique can be quite useful when you have several visual elements that should all act in concert. 
 In our bar chart, for example, we could group <code class="literal">rect</code> and <code class="literal">text</code> elements each into their own groups. 
 The element hierarchy currently looks like this:

svg         rect         rect         rect         …         text         text         text         …
After grouping elements, it could look like this:

svg         g                 rect                 text         g                 rect                 text         …
Instead of worrying about <code class="literal">pointer-events</code> and which element is on top, we just bind the event listener to the whole group. 
 So clicking on some <code class="literal">text</code> will trigger the same code as clicking on a <code class="literal">rect</code> because they’re both in the same group.

Even better, throw an invisible <code class="literal">rect</code> with a <code class="literal">fill</code> of <code class="literal">none</code> and <code class="literal">pointer-events</code> value of <code class="literal">all</code> on the top of each group. 
 Even though the <code class="literal">rect</code> is invisible, it will still trigger mouse events, so you could have the <code class="literal">rect</code> span the whole height of the chart. 
 The net effect is that mousing

<em>anywhere</em> in that column—even in “empty” whitespace above a short blue bar—would trigger the highlight effect.

<h3>Click to Sort</h3>
Interactive visualization is most powerful when it can provide different

<em>views</em> of the data, empowering the user to explore the information from different angles.

The ability to

<em>sort</em> data is extremely important. 
 And yes, as you just guessed, D3 makes it very easy to sort elements.

Continuing with the bar chart, let’s add an event listener for the <code class="literal">click</code> event, to which we bind an anonymous function that, in turn, will call a new function of our own creation, <code class="literal">sortBars()</code>.

<code class="err">…</code> <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>         <code class="nx">sortBars</code><code class="p">();</code> <code class="p">});</code>
For simplicity, we are binding this to every bar, but of course you could bind this instead to a button or any other element, inside or outside of the SVG image.

At the end of the code, let’s define this new function and store it in <code class="literal">sortBars</code>:

<code class="kd">var</code> <code class="nx">sortBars</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>          <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>                  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">);</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>            <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                  <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>            <code class="p">});</code>  <code class="p">};</code>
You can see this code in

<em>07_sort.html</em> and the result in

<a class="xref" href="#click-to-sort" title="Figure 10-5. The view after click-to-sort">Figure 10-5</a>. 
 Try clicking any of the bars, and watch them reorganize.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1005.png" alt="The view after click-to-sort">
Figure 10-5. The view after click-to-sort 
When <code class="literal">sortBars()</code> is called, first we reselect all the <code class="literal">rect</code>s. 
 Then we use D3’s handy <code class="literal">sort()</code> method, which reorders elements based on their bound data values. 
 <code class="literal">sort()</code> needs to know how to decide which elements come first, and which later, so we pass into it a

<em>comparator</em> function.

Unlike our anonymous functions so far, the comparator doesn’t take <code class="literal">d</code> (the current datum) or <code class="literal">i</code> (the current index). 
 Instead, it is passed

<em>two values</em>, <code class="literal">a</code> and <code class="literal">b</code>, which represent the data values of two different elements. 
 (You could name them anything else; <code class="literal">a</code> and <code class="literal">b</code> are just the convention.)  The comparator will be called on every pair of elements in our array, comparing <code class="literal">a</code> to <code class="literal">b</code>, until, in the end, all the array elements are sorted per whatever rules we specify.

We specify

<em>how</em> <code class="literal">a</code> and <code class="literal">b</code> should be compared within the comparator. 
 Thankfully, D3 also provides a handful of comparison functions that spare us from writing more JavaScript. 
 Here, we use <code class="literal">d3.ascending()</code>, into which both <code class="literal">a</code> and <code class="literal">b</code> are passed. 
 Whichever one is bigger comes out the winner. 
 And <code class="literal">sort()</code> loops through all the data values in this way until it has all the elements, er, sorted out. 
 (Note that
<code class="literal">d3.ascending</code> works well in this case, because our values are numbers. 
 Comparing strings of text is a whole other can of worms.)

Finally, our new order in place, we initiate a transition, set a duration of one second, and then calculate the new <code class="literal">x</code> position for each <code class="literal">rect</code>. 
 (This <code class="literal">attr</code> code is just copied from when we created the <code class="literal">rect</code>s initially.)

This works swimmingly, except for two catches.

First, you’ll notice that we haven’t accounted for the value labels yet, so they didn’t slide into place along with the bars. 
 (I leave that to you as an exercise.)

Second, you might observe that if you mouse over some bars

<em>while</em> the
transition is occurring, those bars don’t fall properly into place (see

<a class="xref" href="#interrupted" title="Figure 10-6. Transitions, interrupted">Figure 10-6</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1006.png" alt="Transitions, interrupted">
Figure 10-6. Transitions, interrupted 
Yeeesh, that doesn’t look good.

Remember from

<a class="xref" href="" title="Chapter 9. Updates, Transitions, and Motion">Chapter 9</a> that newer transitions interrupt and override older
transitions. 
 Clicking the bars initiates one transition. 
 Immediately mousing over a bar interrupts that initial transition in order to run the <code class="literal">mouseover</code> highlight transition we specified earlier. 
 The end result is that those moused-over bars never make it to their final destinations.

But don’t worry. 
 This example is just a good argument for keeping hover effects in CSS, while letting D3 and JavaScript manage the more visually intensive actions.

In

<em>08_sort_hover.html</em>, I’ve restored the CSS-only highlight and removed the <code class="literal">mouseover</code> and <code class="literal">mouseout</code> event listeners, so this transition conflict no longer occurs. 
 (The only downside is we no longer have those smooth orange-to-blue fades.)

So far, this sort only goes one direction. 
 Let’s revise this so a second click triggers a re-sort, placing the bars in descending order.

To remember the current state of the chart, we’ll need a Boolean variable:

<code class="kd">var</code> <code class="nx">sortOrder</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
Then, in the <code class="literal">sortBars()</code> function, we should flip the value of <code class="literal">sortOrder</code>, so if it starts out <code class="literal">true</code>, it is changed to <code class="literal">false</code>, and vice versa:

<code class="kd">var</code> <code class="nx">sortBars</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>          <code class="c1">//Flip value of sortOrder</code>         <code class="nx">sortOrder</code> <code class="o">=</code> <code class="o">!</code><code class="nx">sortOrder</code><code class="p">;</code>          <code class="err">…</code>
Down in the comparator function, we can add a bit of logic to say

<em>if</em> <code class="literal">sortOrder</code> is <code class="literal">true</code>, then go ahead and sort

 the bars in

<em>ascending</em> order. 
 Otherwise, use

<em>descending</em> order:

        <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>                         <code class="k">if</code> <code class="p">(</code><code class="nx">sortOrder</code><code class="p">)</code> <code class="p">{</code>                                 <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">);</code>                         <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>                                 <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">descending</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">);</code>                         <code class="p">}</code>                 <code class="p">})</code>                 <code class="err">…</code>
Give that a shot in

<em>09_resort.html</em>. 
 Now each time you click, the sort order reverses, as shown in

<a class="xref" href="#second-sort" title="Figure 10-7. The second sort, now in descending order">Figure 10-7</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1007.png" alt="The second sort, now in descending order">
Figure 10-7. The second sort, now in descending order 
One more thing would make this really nice: a per-element delay. 
 (Remember that whole “object constancy” thing?)

As you know, to do that, we just add a simple <code class="literal">delay()</code> statement after <code class="literal">transition()</code>:

<code class="err">…</code> <code class="p">.</code><code class="nx">transition</code><code class="p">()</code> <code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">i</code> <code class="o">*</code> <code class="mi">50</code><code class="p">;</code> <code class="p">})</code> <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code> <code class="err">…</code>
Now take a look at

<em>10_delay.html</em>, in which you can easily follow individual bars with your eyes as they move left and right during each sort.

Exercise
Add JS code in the panel at left so that the labels sort along with the bars, and check the results in the output panel at right.

<a href="http://examples.oreilly.com/0636920026938/chapter_10/10_delay.html" target="_blank">10_delay</a>

<h2>Tooltips</h2>
In interactive visualizations, tooltips are small overlays that present data values. 
 In many cases, it’s not necessary to label every individual data value in the default view, but that level of detail should still be accessible to users. 
 That’s where tooltips come in.

In this section, I present three different methods to constructing tooltips with D3, ranging from the simplest to the most complex.

<h3>Default Browser Tooltips</h3>
These should be your first stop. 
 A quick-and-dirty, functional but not pretty option, default browser tooltips are usually those ugly yellow boxes you see floating over content when you hold your mouse still for too long. 
 These are very easy to make, and the browser manages the placements for you, but you have zero control over how they look—that’s also set by the browser.

<a class="xref" href="#safari-tooltip" title="Figure 10-8. A ridiculously simple default browser tooltip, as seen in Safari">Figure 10-8</a> shows our bar chart, with value labels removed, and default browser tooltips implemented. 
 The tooltips show up after hovering the mouse over any bar for a few seconds.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1008.png" alt="A ridiculously simple default browser tooltip, as seen in Safari">
Figure 10-8. A ridiculously simple default browser tooltip, as seen in Safari 
See

<em>11_browser_tooltip.html</em> for the code and a demo. 
 To make these tooltips, simply inject a <code class="literal">title</code> element into whatever element should have the tooltip applied. 
 For example, after we create all those <code class="literal">rect</code>s:

<code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">)</code>    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>    <code class="err">…</code>
we can just tack on to the end of that chain:

   <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>          <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">});</code>
<code class="literal">append()</code> creates the new <code class="literal">title</code> element, and then <code class="literal">text()</code> sets its content to <code class="literal">d</code>, the bound value.

We could make this text a little less spare by prefixing it with something (see

<a class="xref" href="#default-tooltip" title="Figure 10-9. A default browser tooltip, with a prefix added">Figure 10-9</a>):

   <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>          <code class="k">return</code> <code class="s2">"This value is "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">;</code>    <code class="p">});</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1009.png" alt="A default browser tooltip, with a prefix added">
Figure 10-9. A default browser tooltip, with a prefix added 
See

<em>12_browser_tooltip_text.html</em> for that code.

Try It Now!
Hover over the bars in the graph to see corresponding tooltips.

<a href="http://examples.oreilly.com/0636920026938/chapter_10/12_browser_tooltip_text.html" target="_blank">12_browser_tooltip_text</a>

<h3>SVG Element Tooltips</h3>
For more visual control over your tooltips, code them as SVG elements.

As usual, there are many different approaches you could take. 
 I’ll suggest adding event listeners, so on each <code class="literal">mouseover</code>, a new value label is created, and on <code class="literal">mouseout</code> it is destroyed. 
 (Another idea would be to pregenerate all the labels, but then just show or hide them based on mouse hover status. 
 Or just stick with one label, but show or hide it and change its position as needed.)

Back to the bars we go. 
 We’ll add back in a <code class="literal">mouseover</code> event listener, in which we first get the <code class="literal">x</code> and <code class="literal">y</code> values for the current element (<code class="literal">this</code>, remember?). 
 We’ll need this information to know where to place the new tooltip, so it appears nicely “on top of” the bar that’s triggering the rollover.

When we retrieve those values, we wrap them in <code class="literal">parseFloat()</code>, which is a JavaScript function for “Hey, even if this information is a string of text, please convert it to a floating point number for me.”

Lastly, I’m adding a bit to both the <code class="literal">x</code> and <code class="literal">y</code> values, to center the new tooltips near the top of any given bar:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">//Get this bar's x/y values, then augment for the tooltip</code> <code class="kd">var</code> <code class="nx">xPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">))</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">yPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">))</code> <code class="o">+</code> <code class="mi">14</code><code class="p">;</code>
That’s the hard part. 
 Now all we do is create the tooltip as a simple <code class="literal">text</code> element, in this case, but of course you could add a background <code class="literal">rect</code> or do anything else here for visual effect:

<code class="c1">//Create the tooltip label</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"tooltip"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">xPosition</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">yPosition</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-family"</code><code class="p">,</code> <code class="s2">"sans-serif"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"11px"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"font-weight"</code><code class="p">,</code> <code class="s2">"bold"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>  <code class="p">})</code>
Yes, this is based on our earlier value label code, simply adapted slightly. 
 Note that the <code class="literal">x</code> and <code class="literal">y</code> attributes are set to the new position values we just calculated, and the actual text content of the label is set to <code class="literal">d</code>, the datum passed into the event listener function.

Also note that I assigned this next <code class="literal">text</code> element an ID of <code class="literal">tooltip</code>. 
 This is so we can easily select (and delete!) the element when we’re done with it—on <code class="literal">mouseout</code>:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>  <code class="c1">//Remove the tooltip</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">).</code><code class="nx">remove</code><code class="p">();</code>  <code class="p">})</code>
Test out the code in

<em>13_svg_tooltip.html</em>.

Try It Now!
Hover over the bars in the graph to see the custom tooltips.

<a href="http://examples.oreilly.com/0636920026938/chapter_10/13_svg_tooltip.html" target="_blank">13_svg_tooltip</a>

As you can see in

<a class="xref" href="#element-tooltip" title="Figure 10-10. An SVG element tooltip">Figure 10-10</a>, you have much more visual control when using SVG elements as tooltips, but they are a little more time-consuming to set up. 
 And of course, you can get much fancier than this simple example.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1010.png" alt="An SVG element tooltip">
Figure 10-10. An SVG element tooltip  

<h3>HTML div Tooltips</h3>
A similar approach can be used with HTML <code class="literal">div</code> elements as tooltips. 
 You might consider using a <code class="literal">div</code> when:

 You want to achieve a visual effect that isn’t possible or well-supported with SVG (such as CSS drop shadows)  You need the tooltips to extend beyond the frame of the SVG image

  
See Figures

<a class="xref" href="#div-tooltip" title="Figure 10-11. An HTML div tooltip">10-11</a> and

<a class="xref" href="#overlapping-tooltip" title="Figure 10-12. An HTML div tooltip, overlapping the bounds of the SVG image beneath">10-12</a> for examples.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1011.png" alt="An HTML div tooltip">
Figure 10-11. An HTML div tooltip 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1012.png" alt="An HTML div tooltip, overlapping the bounds of the SVG image beneath">
Figure 10-12. An HTML div tooltip, overlapping the bounds of the SVG image beneath 
Again, there are many ways to do this, but I like to make a hidden <code class="literal">div</code> in my HTML that gets populated with the data value, and is then unhidden when triggered. 
 You can follow along with the final code in

<em>14_div_tooltip.html</em>.

The <code class="literal">div</code> itself could be created dynamically with D3, but I like to just type it in by hand:

<code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"tooltip"</code> <code class="na">class=</code><code class="s">"hidden"</code><code class="nt">></code>         <code class="nt">&lt;p>&lt;strong></code>Important Label Heading<code class="nt">&lt;/strong>&lt;/p></code>         <code class="nt">&lt;p>&lt;span</code> <code class="na">id=</code><code class="s">"value"</code><code class="nt">></code>100<code class="nt">&lt;/span></code>%<code class="nt">&lt;/p></code> <code class="nt">&lt;/div></code>
Now it’s going to need some special CSS styling rules:

<code class="nf">#tooltip</code> <code class="p">{</code>         <code class="k">position</code><code class="o">:</code> <code class="k">absolute</code><code class="p">;</code>         <code class="k">width</code><code class="o">:</code> <code class="m">200px</code><code class="p">;</code>         <code class="k">height</code><code class="o">:</code> <code class="k">auto</code><code class="p">;</code>         <code class="k">padding</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">background-color</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>         <code class="o">-</code><code class="k">webkit</code><code class="k">-</code><code class="k">border</code><code class="k">-</code><code class="k">radius</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">-</code><code class="k">moz</code><code class="k">-</code><code class="k">border</code><code class="k">-</code><code class="k">radius</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">border</code><code class="k">-</code><code class="k">radius</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>         <code class="k">-</code><code class="k">webkit</code><code class="k">-</code><code class="k">box</code><code class="k">-</code><code class="k">shadow</code><code class="o">:</code> <code class="m">4px</code> <code class="m">4px</code> <code class="m">10px</code> <code class="n">rgba</code><code class="p">(</code><code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">.</code><code class="m">4</code><code class="p">);</code>         <code class="k">-</code><code class="k">moz</code><code class="k">-</code><code class="k">box</code><code class="k">-</code><code class="k">shadow</code><code class="o">:</code> <code class="m">4px</code> <code class="m">4px</code> <code class="m">10px</code> <code class="n">rgba</code><code class="p">(</code><code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">.</code><code class="m">4</code><code class="p">);</code>         <code class="k">box</code><code class="k">-</code><code class="k">shadow</code><code class="o">:</code> <code class="m">4px</code> <code class="m">4px</code> <code class="m">10px</code> <code class="n">rgba</code><code class="p">(</code><code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">,</code> <code class="m">0</code><code class="o">.</code><code class="m">4</code><code class="p">);</code>         <code class="k">pointer</code><code class="k">-</code><code class="k">events</code><code class="o">:</code> <code class="k">none</code><code class="p">;</code> <code class="p">}</code>  <code class="nf">#tooltip</code><code class="nc">.hidden</code> <code class="p">{</code>         <code class="k">display</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code> <code class="p">}</code>  <code class="nf">#tooltip</code> <code class="nt">p</code> <code class="p">{</code>         <code class="k">margin</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>         <code class="k">font-family</code><code class="o">:</code> <code class="nb">sans-serif</code><code class="p">;</code>         <code class="k">font-size</code><code class="o">:</code> <code class="m">16px</code><code class="p">;</code>         <code class="k">line-height</code><code class="o">:</code> <code class="m">20px</code><code class="p">;</code> <code class="p">}</code>
Note in particular that its <code class="literal">position</code> is <code class="literal">absolute</code>, so we can control exactly where it should appear on the page. 
 I’ve also added some fancy rounded corners and a drop shadow. 
 Plus, <code class="literal">pointer-events: none</code> ensures that mousing over the tooltip itself won’t trigger a <code class="literal">mouseout</code> event on the bars, thereby hiding the tooltip. 
 (Try the code without this line, and you’ll see what I mean.)  Lastly, when the tooltip is given a class of
<code class="literal">hidden</code>, it is not displayed.

I made some modifications to the <code class="literal">mouseover</code> function, so the <code class="literal">div</code> is roughly centered vertically against its triggering bar. 
 The revised code now also sets the tooltip’s <code class="literal">left</code> and <code class="literal">top</code> position per CSS layout requirements, sets the text content of the <code class="literal">#value</code> span to <code class="literal">d</code>, and then—now that everything is in place—removes the <code class="literal">hidden</code> class, making the tooltip visible:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>  <code class="c1">//Get this bar's x/y values, then augment for the tooltip</code> <code class="kd">var</code> <code class="nx">xPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">))</code> <code class="o">+</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">()</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">yPosition</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">))</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="nx">h</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>  <code class="c1">//Update the tooltip position and value</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="nx">xPosition</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="nx">yPosition</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#value"</code><code class="p">)</code>   <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>  <code class="c1">//Show the tooltip</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">).</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"hidden"</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code>  <code class="p">})</code>
Hiding the tooltip on <code class="literal">mouseout</code> is much easier; simply add on the <code class="literal">hidden</code> class:

<code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>  <code class="c1">//Hide the tooltip</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tooltip"</code><code class="p">).</code><code class="nx">classed</code><code class="p">(</code><code class="s2">"hidden"</code><code class="p">,</code> <code class="kc">true</code><code class="p">);</code>  <code class="p">})</code>

Try It Now!
Hover over the bars in the graph to see the custom &lt;div> tooltips.

<a href="http://examples.oreilly.com/0636920026938/chapter_10/14_div_tooltip.html" target="_blank">14_div_tooltip</a>

The layout of this simple example works well, but in a real-world situation, the D3 chart would be just one of many other elements on the page. 
 As you probably know, perfecting HTML/CSS layouts can be a challenge, and this is the biggest hassle of getting HTML elements to interact properly with an SVG chart. 
 It can help to put both the tooltip <code class="literal">div</code> and SVG chart within the same enclosing element (like a container <code class="literal">div</code>), so then you only have to worry about relative positions. 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-d3_mouse" target="_top"><code class="literal">d3.mouse</code></a> can be used to get mouse coordinates relative to any other element on the page, and can be useful in cases when you need to position non-SVG elements in relationship to the mouse.
  

<h2>Consideration for Touch Devices</h2>
The browsers on most popular touch devices—such as iOS and Android devices—automatically translate touch events into mouse events, for JavaScript purposes. 
 So a tap on an element is interpreted by the browser as a <code class="literal">click</code> event. 
 This means that, for the most part, your code that was crafted for mouse interfaces will also work just fine for touch-based interfaces.

The primary exception to this is multitouch, which is not automagically handled by D3. 
 There’s no easy answer on how to handle multitouch interactions yet, but D3

<em>does</em> track the touches for you (although it’s up to you to decide how to use them). 
 See the
API reference for

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Selections#wiki-d3_touches" target="_top"><code class="literal">d3.touches</code></a>.

<h2>Moving Forward</h2>
Congratulations!  You now have all the basics of D3 under your cap. 
 You are a pro at binding data, generating and styling elements based on that data, implementing scales and drawing axes, and modifying your creations with new data, animated transitions, and interactivity. 
 What more could you ask for?

How about layouts and geomaps?  The next two chapters will dive into these more advanced topics, but—be warned—without the same level of detail as the prior chapters. 
 Now that you know the basics, you don’t need every little thing spelled out. 
Here we go!

<h1><span class="orange">Chapter 11. Layouts</span></h1>
Contrary to what the name implies, D3

<em>layouts</em> do not, in fact, lay anything out for you on the screen. 
 The layout methods have no direct

<em>visual</em> output. 
 Rather, D3 layouts take data that you provide and remap or otherwise transform it, thereby generating

<em>new</em> data that is more convenient for a specific visual task. 
 It’s still up to you to take that new data and generate visuals from it.

Here is a complete list of all D3 layouts:

 Bundle  Chord  Cluster  Force  Histogram  Pack  Partition  Pie  Stack  Tree  Treemap  
In this chapter, I introduce three of the most common:

<em>pie</em>,

<em>stack</em>, and

<em>force</em>. 
 Each layout performs a different function, and each has its own idiosyncrasies.

If you are curious about any of the other D3 layouts, check out

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Gallery" target="_top">the many examples on the D3 website</a>, and be sure to reference

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Layouts" target="_top">the official API documentation on layouts</a>.

<h2>Pie Layout</h2>
<code class="literal">d3.layout.pie()</code> might not be as delicious as it sounds, but it’s still worthy of your attention. 
 Obviously, its typical use is for creating pie charts, like the example in

<a class="xref" href="#simple_pie_chart" title="Figure 11-1. A simple pie chart">Figure 11-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1101.png" alt="A simple pie chart">
Figure 11-1. A simple pie chart 
Feel free to open up the sample code for this in

<em>01_pie.html</em> and poke around.

To draw those pretty wedges, we need to know a number of measurements, including an inner and outer radius for each wedge, plus the starting and ending angles. 
 The purpose of the pie layout is to take your data and calculate all those messy angles for you, sparing you from ever having to think about radians.

Remember radians?  In case you don’t, here’s a quick refresher. 
 Just as there are 360° in a circle, there are 2π radians. 
 So π radians equals 180°, or half a circle. 
 Most people find it easier to think in terms of degrees; computers prefer radians.

For this pie chart, let’s start, as usual, with a very simple dataset:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">45</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">25</code> <code class="p">];</code>
We can define a default pie layout very simply as:

<code class="kd">var</code> <code class="nx">pie</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">pie</code><code class="p">();</code>
Then, all that remains is to hand off our data to the new <code class="literal">pie()</code> function, as in
<code class="literal">pie(dataset)</code>. 
 Compare the datasets before and after in

<a class="xref" href="#pieified_data" title="Figure 11-2. Your data, pie-ified">Figure 11-2</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1102.png" alt="Your data, pie-ified">
Figure 11-2. Your data, pie-ified 
The pie layout takes our simple array of numbers and generates an array of objects, one object for each value. 
 Each of those objects now has a few new values—most important, <code class="literal">startAngle</code> and <code class="literal">endAngle</code>. 
 Wow, that was easy!

Now, to actually draw the wedges, we turn to <code class="literal">d3.svg.arc()</code>, a handy built-in function for drawing arcs as SVG <code class="literal">path</code> elements. 
 We haven’t talked about <code class="literal">path</code>s yet, but they are SVG’s answer to drawing irregular forms. 
 Anything that’s not a <code class="literal">rect</code>, <code class="literal">circle</code>, or another basic shape can be drawn as a <code class="literal">path</code>. 
 The catch is, the syntax for defining <code class="literal">path</code> values is not particularly human-friendly.

  For example, here’s the code for the big, red wedge in

<a class="xref" href="#simple_pie_chart" title="Figure 11-1. A simple pie chart">Figure 11-1</a>:

<code class="nt">&lt;path</code> <code class="na">fill=</code><code class="s">"#d62728"</code> <code class="na">d=</code><code class="s">"M9.184850993605149e-15,-150A150,150 0 0,1</code> <code class="s">        83.99621792063931,124.27644738657631L0,0Z"</code><code class="nt">>&lt;/path></code>
If you can understand that, then you don’t need this book.

The bottom line is, it’s best to let functions like <code class="literal">d3.svg.arc()</code> handle generating <code class="literal">path</code>s programatically. 
 You don’t want to try writing this stuff out by hand.

Arcs are defined as custom functions, and they require inner and outer radius values:

<code class="kd">var</code> <code class="nx">w</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">h</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>  <code class="kd">var</code> <code class="nx">outerRadius</code> <code class="o">=</code> <code class="nx">w</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">innerRadius</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="kd">var</code> <code class="nx">arc</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">svg</code><code class="p">.</code><code class="nx">arc</code><code class="p">()</code>                 <code class="p">.</code><code class="nx">innerRadius</code><code class="p">(</code><code class="nx">innerRadius</code><code class="p">)</code>                 <code class="p">.</code><code class="nx">outerRadius</code><code class="p">(</code><code class="nx">outerRadius</code><code class="p">);</code>
Here I’m setting the size of the whole chart to be 300 by 300 square. 
 Then I’m setting the <code class="literal">outerRadius</code> to half of that, or 150. 
 The <code class="literal">innerRadius</code> is zero. 
 We’ll revisit
<code class="literal">innerRadius</code> in a moment.

We’re ready to draw some wedges!  First, we create the SVG element, per usual:

<code class="c1">//Create SVG element</code> <code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">w</code><code class="p">)</code>             <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">h</code><code class="p">);</code>
Then we can create new groups for each incoming wedge, binding the pie-ified data to the new elements, and translating each group into the center of the chart, so the <code class="literal">path</code>s will appear in the right place:

<code class="c1">//Set up groups</code> <code class="kd">var</code> <code class="nx">arcs</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"g.arc"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">pie</code><code class="p">(</code><code class="nx">dataset</code><code class="p">))</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"arc"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">outerRadius</code> <code class="o">+</code> <code class="s2">", "</code> <code class="o">+</code> <code class="nx">outerRadius</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
Note that we’re saving a reference to each newly created <code class="literal">g</code> in a variable called <code class="literal">arcs</code>.

Finally, within each new <code class="literal">g</code>, we append a <code class="literal">path</code>. 
 A <code class="literal">path</code>s path description is defined in the <code class="literal">d</code> attribute. 
 So here we call the <code class="literal">arc</code> generator, which generates the path information based on the data already bound to this group:

<code class="c1">//Draw arc paths</code> <code class="nx">arcs</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">color</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">arc</code><code class="p">);</code>
Oh, and you might be wondering where those colors are coming from. 
 If you check out

<em>01_pie.html</em>, you’ll note this line:

<code class="kd">var</code> <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">category10</code><code class="p">();</code>
D3 has a number of handy ways to generate categorical colors. 
 These might not be your favorite colors, but they are quick to drop into any visualization while you’re in the prototyping stage. 
 <code class="literal">d3.scale.category10()</code> creates an

<em>ordinal</em> scale with an output range of 10 different colors. 
 (See

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Ordinal-Scales" target="_top">the wiki</a> for more information on these color scales as well as perceptually calibrated color palettes, based on research by Cynthia Brewer, that are included with D3.)

Lastly, we can generate text labels for each wedge:

<code class="nx">arcs</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">arc</code><code class="p">.</code><code class="nx">centroid</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>     <code class="p">})</code>     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>         <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>     <code class="p">});</code>
Note that in <code class="literal">text()</code>, we reference the value with <code class="literal">d.value</code> instead of just <code class="literal">d</code>. 
 This is because we bound the pie-ified data, so instead of referencing our original array (<code class="literal">d</code>), we have to reference the array of objects (<code class="literal">d.value</code>).

The only thing new here is <code class="literal">arc.centroid(d)</code>. 
 WTH?  A

<em>centroid</em> is the calculated center point of any shape, whether that shape is regular (like a square) or highly irregular (like an outline of the state of Maryland). 
 <code class="literal">arc.centroid()</code> is a super-helpful function that calculates and returns the center point of any arc. 
 We translate each <code class="literal">text</code> label element to each arc’s centroid, and that’s how we get the text labels to float right in the middle of each wedge.

Try It Now!
Try changing the values in <code class="literal">dataset</code> and see how this affects the rendering of the pie chart.

<a href="http://examples.oreilly.com/0636920026938/chapter_11/01_pie.html" target="_blank">01_pie</a>

Bonus tip:  Remember how <code class="literal">arc()</code> required an <code class="literal">innerRadius</code> value?  We can expand that to anything greater than zero, and our pie chart becomes a

<em>ring</em> chart like the one

 shown in

<a class="xref" href="#simple_ring_chart" title="Figure 11-3. A simple ring chart">Figure 11-3</a>:

<code class="kd">var</code> <code class="nx">innerRadius</code> <code class="o">=</code> <code class="nx">w</code> <code class="o">/</code> <code class="mi">3</code><code class="p">;</code>

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1103.png" alt="A simple ring chart">
Figure 11-3. A simple ring chart 
Check it out in

<em>02_ring.html</em>.

Try It Now!
Experiment with changing the values in <code class="literal">dataset</code> and see how this affects the rendering of the ring chart.

<a href="http://examples.oreilly.com/0636920026938/chapter_11/02_ring.html" target="_blank">02_ring</a>

One more thing:  The pie layout automatically reordered our data values from largest to smallest. 
 Remember, we started with <code class="literal">[ 5, 10, 20, 45, 6, 25 ]</code>, so the small value of 6 should have appeared between 45 and 25, but no—the layout sorted our values in descending order, so the chart began with 45 at the 12 o’clock position, and everything just goes clockwise from there.

<h2>Stack Layout</h2>
<code class="literal">d3.layout.stack()</code> converts two-dimensional data into “stacked” data; it calculates a baseline value for each datum, so you can “stack” layers of data on top of one another. 
 This can be used to generate stacked bar charts, stacked area charts, and even
streamgraphs (which are just stacked area charts but without the rigid starting baseline value of zero).

For example, we’ll start with the stacked bar chart in

<a class="xref" href="#simple_stacked_bar_chart" title="Figure 11-4. A simple stacked bar chart">Figure 11-4</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1104.png" alt="A simple stacked bar chart">
Figure 11-4. A simple stacked bar chart 
Let’s say you had some data like this:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">22</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">28</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">19</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">32</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">23</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">35</code> <code class="p">},</code>         <code class="p">{</code> <code class="nx">apples</code><code class="o">:</code> <code class="mi">23</code><code class="p">,</code> <code class="nx">oranges</code><code class="o">:</code> <code class="mi">17</code><code class="p">,</code> <code class="nx">grapes</code><code class="o">:</code> <code class="mi">43</code> <code class="p">}</code> <code class="p">];</code>
The first step is to rearrange that data into an array of arrays. 
 Each array represents the data for one category (e.g., apples, oranges, or grapes). 
 Within each category array, you’ll need an object for each data value, which itself must contain an <code class="literal">x</code> and a <code class="literal">y</code> value. 
 The <code class="literal">x</code> in our case is just an ID number. 
 The <code class="literal">y</code> is the actual data value:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">[</code>         <code class="p">[</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">4</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">2</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">7</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">23</code> <code class="p">}</code>         <code class="p">],</code>         <code class="p">[</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">10</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">12</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">19</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">23</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">17</code> <code class="p">}</code>         <code class="p">],</code>         <code class="p">[</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">22</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">28</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">32</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">35</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">43</code> <code class="p">}</code>         <code class="p">]</code> <code class="p">];</code>
Our original <code class="literal">dataset</code> looks like

<a class="xref" href="#prestacked_data" title="Figure 11-5. The data before stacking">Figure 11-5</a> in the console.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1105.png" alt="The data before stacking">
Figure 11-5. The data before stacking 
Then we initialize our stack layout function, and call it on <code class="literal">dataset</code>:

<code class="kd">var</code> <code class="nx">stack</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">stack</code><code class="p">();</code> <code class="nx">stack</code><code class="p">(</code><code class="nx">dataset</code><code class="p">);</code>
Now the stacked data is shown in

<a class="xref" href="#stacked_data" title="Figure 11-6. The data after stacking">Figure 11-6</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1106.png" alt="The data after stacking">
Figure 11-6. The data after stacking 
Can you spot the difference?  In the stacked data, each object has been given a <code class="literal">y0</code> value. 
 This is the

<em>baseline</em> value. 
 Notice that the <code class="literal">y0</code> baseline value is equal to the sum of all the <code class="literal">y</code> values in the preceding categories. 
 For example, reading left to right across the top, the first object’s <code class="literal">y</code> value is 5, and its <code class="literal">y0</code> is zero. 
 To the right (in the oranges column), the first object has a <code class="literal">y</code> value of 10, and a <code class="literal">y0</code> of 5. 
 (Aha! That’s just the value of the first object’s <code class="literal">y</code>!)  On the far right (in the grapes column), we see a <code class="literal">y</code> value of 22, and a <code class="literal">y0</code> of 15 (which is just 5 + 10).

To “stack” elements visually, now we can reference each data object’s baseline value as well as its height. 
 See all the code in

<em>03_stacked_bar.html</em>. 
 (I leave it as an exercise to you to align the stacks against the bottom x-axis.)  Here’s the critical excerpt:

<code class="kd">var</code> <code class="nx">rects</code> <code class="o">=</code> <code class="nx">groups</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">;</code> <code class="p">})</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">xScale</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y0</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">yScale</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">xScale</code><code class="p">.</code><code class="nx">rangeBand</code><code class="p">());</code>
Note how for <code class="literal">y</code> and <code class="literal">height</code> we reference <code class="literal">d.y0</code> and <code class="literal">d.y</code>, respectively.

Exercise
Add code to the panel at left to align the stacked bars against the x-axis, and check the results in the output panel at right

<a href="http://examples.oreilly.com/0636920026938/chapter_11/03_stacked_bar.html" target="_blank">03_stacked_bar</a>

<h2>Force Layout</h2>
Force-directed layouts are so-called because they use simulations of physical

<em>forces</em> to arrange elements on the screen. 
 Arguably, they are a bit overused, yet they make a great demo and just look

<em>so darn cool</em>. 
 Everyone wants to learn how to make one, so let’s talk about it.

Force layouts are typically used with network data. 
 In computer science, this kind of dataset is called a

<em>graph</em>. 
 A simple graph is a list of

<em>nodes</em> and

<em>edges</em>. 
 The nodes are entities in the dataset, and the edges are the

<em>connections</em> between nodes. 
 Some nodes will be connected by edges, and others won’t. 
 Nodes are commonly represented as circles, and edges as lines. 
 But of course the visual representation is up to you—D3 just helps manage all the mechanics behind the scenes.

The physical metaphor here is of particles that repel each other, yet are also connected by springs. 
 The repelling forces push particles away from each other, preventing visual overlap, and the springs prevent them from just flying out into space, thereby keeping them on the screen where we can see them.

<a class="xref" href="#force_layouta" title="Figure 11-7. A simple force layout">Figure 11-7</a> provides a visual preview of what we’re coding toward.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1107.png" alt="A simple force layout">
Figure 11-7. A simple force layout 
D3’s force layout expects us to provide nodes and edges separately, as arrays of objects. 
 Here we have one <code class="literal">dataset</code> object that contains two elements, <code class="literal">nodes</code> and <code class="literal">edges</code>, each of which is itself an array of objects:

<code class="kd">var</code> <code class="nx">dataset</code> <code class="o">=</code> <code class="p">{</code>         <code class="nx">nodes</code><code class="o">:</code> <code class="p">[</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Adam"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Bob"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Carrie"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Donovan"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Edward"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Felicity"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"George"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Hannah"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Iris"</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Jerry"</code> <code class="p">}</code>         <code class="p">],</code>         <code class="nx">edges</code><code class="o">:</code> <code class="p">[</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">2</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">3</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">4</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">4</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">8</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">9</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">6</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">7</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">8</code> <code class="p">},</code>                 <code class="p">{</code> <code class="nx">source</code><code class="o">:</code> <code class="mi">8</code><code class="p">,</code> <code class="nx">target</code><code class="o">:</code> <code class="mi">9</code> <code class="p">}</code>         <code class="p">]</code> <code class="p">};</code>
As usual for D3, you can store whatever data you like within these objects. 
 Our nodes are simple—just names of people. 
 The edges contain two values each: a source ID and a target ID. 
 These IDs correspond to the nodes above, so ID number 3 is Donovan, for example. 
 If 3 is connected to 4, then Donovan is connected to Edward.

The data shown is a bare minimum for using the force layout. 
 You can add more information, and, in fact, D3 will itself add a lot more data to what we’ve provided, as we’ll see in a moment.

Here’s how to initialize a force layout:

<code class="kd">var</code> <code class="nx">force</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">force</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">edges</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">w</code><code class="p">,</code> <code class="nx">h</code><code class="p">])</code>                      <code class="p">.</code><code class="nx">start</code><code class="p">();</code>
Again, this is just the bare minimum. 
 We specify the nodes and links to be used, the size of the available space, and then call <code class="literal">start()</code> when we’re ready to go.

This generates a default force layout, but the default won’t be ideal for every dataset. 
 As you would expect, there are all kinds of options for customization. 

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Force-Layout" target="_top">See the API wiki</a> for all the gory details. 
 Here, I’ve increased the <code class="literal">linkDistance</code> (the length of the edges between connected nodes) as well as the negative <code class="literal">charge</code> between nodes, so they will repel each other more. 
 (It’s not personal; I just want them to spread out a bit.)

<code class="kd">var</code> <code class="nx">force</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">layout</code><code class="p">.</code><code class="nx">force</code><code class="p">()</code>                      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">edges</code><code class="p">)</code>                      <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">w</code><code class="p">,</code> <code class="nx">h</code><code class="p">])</code>                      <code class="p">.</code><code class="nx">linkDistance</code><code class="p">([</code><code class="mi">50</code><code class="p">])</code>        <code class="c1">// &lt;-- New!</code>                      <code class="p">.</code><code class="nx">charge</code><code class="p">([</code><code class="o">-</code><code class="mi">100</code><code class="p">])</code>            <code class="c1">// &lt;-- New!</code>                      <code class="p">.</code><code class="nx">start</code><code class="p">();</code>
Next, we create an SVG line for each edge:

<code class="kd">var</code> <code class="nx">edges</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">edges</code><code class="p">)</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"#ccc"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
Note that I set all the lines to have the same stroke color and weight, but of course you could set this dynamically based on data (say, thicker or darker lines for “stronger” connections, or some other value).

Then, we create an SVG circle for each node:

<code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>         <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>         <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>         <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                 <code class="k">return</code> <code class="nx">colors</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code>         <code class="p">})</code>         <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">force</code><code class="p">.</code><code class="nx">drag</code><code class="p">);</code>
I set all circles to have the same radius, but each gets a different color fill, just because it’s prettier that way. 
 Of course, these values could be set dynamically, too, for a more useful visualization.

You’ll notice the last line of code, which enabled drag-and-drop interaction. 
 (Comment that out, and the user won’t be able to move nodes around.)

Lastly, we have to specify what happens when the force layout “ticks.”  Yes, these ticks are different from the axis ticks addressed earlier, and definitely different from those little blood-sucking insects. 
 Physics simulations use the word “tick” to refer to the passage of some amount of time, like the ticking second hand of a clock. 
 For example, if an animation were running at 30 frames per second, you could have one tick represent 1/30th of a second. 
 Then each time the simulation ticked, you’d see the calculations of motion update in real time. 
 In some applications, it’s useful to run ticks faster than actual time. 
For example, if you were trying to model the effects of climate change on the planet 50 years from now, you wouldn’t want to wait 50 years to see the results, so you’d program the system to tick on ahead, faster than real time.

For our purposes, what you need to know is that D3’s force layout “ticks” forward through time, just like every other physics simulation. 
 With each tick, the force layout adjusts the position values for each node and edge according to the rules we specified when the layout was first intialized. 
 To see this progress visually, we need to update the associated elements—the lines and circles:

<code class="nx">force</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"tick"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>  <code class="nx">edges</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code> <code class="p">});</code>  <code class="nx">nodes</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code> <code class="p">})</code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code> <code class="p">});</code>  <code class="p">});</code>
This tells D3, “Okay, every time you tick, take the new x/y values for each line and circle and update them in the DOM.”

Wait a minute. 
 Where did these x/y values come from?  We had only specified <code class="literal">name</code>s, <code class="literal">source</code>s, and <code class="literal">target</code>s!

D3 calculated those x/y values and appended them to the existing objects in our original <code class="literal">dataset</code> (see

<a class="xref" href="#force_data_added" title="Figure 11-8. The first node in dataset, with lots of supplemental data added by D3">Figure 11-8</a>). 
 Go ahead and open up

<em>04_force.html</em>, and type

<strong><code class="literal">dataset</code></strong> into the console. 
 Expand any node or edge, and you’ll see lots of additional data that we didn’t provide. 
 That’s where D3 stores the information it needs to continue running the physics simulation. 
 With <code class="literal">on("tick", …)</code>, we are just specifying how to take those updated coordinates and map them on to the visual elements in the DOM.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1108.png" alt="The first node in dataset, with lots of supplemental data added by D3">
Figure 11-8. The first node in dataset, with lots of supplemental data added by D3 
The final result, then, is the lovely entanglement displayed in

<a class="xref" href="#force_layout" title="Figure 11-9. A simple force layout with 10 nodes and 12 edges">Figure 11-9</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1109.png" alt="A simple force layout with 10 nodes and 12 edges">
Figure 11-9. A simple force layout with 10 nodes and 12 edges 
Again, you can run the final code youself in

<em>04_force.html</em>.

Try It Now!
Interact with the force diagram below by clicking and dragging the nodes.

<a href="http://examples.oreilly.com/0636920026938/chapter_11/04_force.html" target="_blank">04_force</a>

Note that each time you reload the page, the circles and lines spring to life, eventually resting in a state of equilibrium. 
 But that final state of rest is different every time because there is an element of randomness to how the circles enter the stage. 
 This illustrates the unpredictable nature of force-based layouts:  they might be quite different each time you use them, and they rely on the data to provide structure. 
 If your data is more structured, you might get a better visual result.

Interactivity can be useful for improving our view of the data. 
 I don’t like how the edges overlap here, so I’ll drag the pink circle out and around (see

<a class="xref" href="#force_drag" title="Figure 11-10. Dragging a node to change the arrangement of nodes">Figure 11-10</a>), then I’ll move the red one up and to the left (see

<a class="xref" href="#force_drag_2" title="Figure 11-11. Dragging some more to untangle nodes">Figure 11-11</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1110.png" alt="Dragging a node to change the arrangement of nodes">
Figure 11-10. Dragging a node to change the arrangement of nodes 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1111.png" alt="Dragging some more to untangle nodes">
Figure 11-11. Dragging some more to untangle nodes 
As a bonus, interactivity + physics simulation = irresistable demo. 
 I can’t explain it, but it’s true. 
 For some reason, we humans just love seeing real-world things replicated on screens.

<h1><span class="orange">Chapter 12. Geomapping</span></h1>
Bar charts, scatterplots, ring charts, and even force-directed graphs… 

<em>Yeah, that’s all okay</em>, you’re thinking,

<em>but get to the maps already!</em>

<h2>JSON, Meet GeoJSON</h2>
You’ve already met JSON. 
 Now meet GeoJSON, the JSON-based standard for encoding geodata for web applications. 
 GeoJSON actually is not a totally different format, but just a very specific use of JSON.

Before you can generate a geographic map, you need to acquire the path data (the outlines) for the shapes you want to display. 
 We’ll start with a common example, mapping US state boundaries. 
 I’ve included a file

<em>us-states.json</em> with the sample code. 
 This file is taken directly from one of the D3 examples, and we owe Mike Bostock a word of thanks for generating this nice, clean file of state boundaries.

Opening up

<em>us-states.json</em>, you’ll see it looks something like this (reformatted and greatly abbreviated here):

<code class="p">{</code>   <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"FeatureCollection"</code><code class="p">,</code>   <code class="s2">"features"</code><code class="o">:</code> <code class="p">[</code>      <code class="p">{</code>        <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code>        <code class="s2">"id"</code><code class="o">:</code> <code class="s2">"01"</code><code class="p">,</code>        <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Alabama"</code> <code class="p">},</code>        <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code>          <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Polygon"</code><code class="p">,</code>          <code class="s2">"coordinates"</code><code class="o">:</code> <code class="p">[[[</code><code class="o">-</code><code class="mf">87.359296</code><code class="p">,</code><code class="mf">35.00118</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">85.606675</code><code class="p">,</code><code class="mf">34.984749</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.431413</code><code class="p">,</code><code class="mf">34.124869</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">85.184951</code><code class="p">,</code><code class="mf">32.859696</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.069935</code><code class="p">,</code><code class="mf">32.580372</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">84.960397</code><code class="p">,</code><code class="mf">32.421541</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.004212</code><code class="p">,</code><code class="mf">32.322956</code><code class="p">],</code>            <code class="p">[</code><code class="o">-</code><code class="mf">84.889196</code><code class="p">,</code><code class="mf">32.262709</code><code class="p">],[</code><code class="o">-</code><code class="mf">85.058981</code><code class="p">,</code><code class="mf">32.13674</code><code class="p">]</code> <code class="err">…</code>           <code class="p">]]</code>       <code class="p">}</code>     <code class="p">},</code>     <code class="p">{</code>          <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code>          <code class="s2">"id"</code><code class="o">:</code> <code class="s2">"02"</code><code class="p">,</code>          <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Alaska"</code> <code class="p">},</code>          <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code>            <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"MultiPolygon"</code><code class="p">,</code>            <code class="s2">"coordinates"</code><code class="o">:</code> <code class="p">[[[[</code><code class="o">-</code><code class="mf">131.602021</code><code class="p">,</code><code class="mf">55.117982</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.569159</code><code class="p">,</code><code class="mf">55.28229</code><code class="p">],[</code><code class="o">-</code><code class="mf">131.355558</code><code class="p">,</code><code class="mf">55.183705</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.38842</code><code class="p">,</code><code class="mf">55.01392</code><code class="p">],[</code><code class="o">-</code><code class="mf">131.645836</code><code class="p">,</code><code class="mf">55.035827</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.602021</code><code class="p">,</code><code class="mf">55.117982</code><code class="p">]]],[[[</code><code class="o">-</code><code class="mf">131.832052</code><code class="p">,</code><code class="mf">55.42469</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.645836</code><code class="p">,</code><code class="mf">55.304197</code><code class="p">],[</code><code class="o">-</code><code class="mf">131.749898</code><code class="p">,</code><code class="mf">55.128935</code><code class="p">],</code>              <code class="p">[</code><code class="o">-</code><code class="mf">131.832052</code><code class="p">,</code><code class="mf">55.189182</code><code class="p">],</code> <code class="err">…</code>             <code class="p">]]]</code>           <code class="p">}</code>       <code class="p">}</code> <code class="err">…</code>
In typical GeoJSON style, we see, first of all, that this is all one giant object. 
 (Curly brackets, remember?)  That object has a <code class="literal">type</code> of <code class="literal">FeatureCollection</code>, followed by <code class="literal">features</code>, which is an array of individual <code class="literal">Feature</code> objects. 
 Each one of these
<code class="literal">Feature</code>s represents a US state. 
 You can see each state’s name under <code class="literal">properties</code>.

But the real meat in any GeoJSON file is under <code class="literal">geometry</code>. 
 This is where the feature’s <code class="literal">type</code> is specified, followed by the many <code class="literal">coordinates</code> that constitute the feature’s boundary. 
 Within the <code class="literal">coordinates</code> are sets of longitude/latitude pairs, each one as a small, two-value array. 
 This is the information that cartographers dedicate their lives to compiling and refining. 
 We owe generations of explorers and researchers our gratitude for creating these sequences of tiny, yet extremely powerful numbers.

It’s important to note that

<em>longitude</em> is always listed first. 
 So despite the cultural bias toward lat/lon, GeoJSON is a lon/lat world.

Also, in case your cartographic skills are a bit rusty, here’s how you can always remember which is which:

 Longtiude is long. 
 Therefore, longitudinal lines run vertically, as though hanging down from above. 
 Latitude is fatitude. 
 Therefore, latitudinal lines run horizontally, as though wrapping around the Earth’s waist. 
 
Longitude and latitude together constitute an enormous grid that encircles the whole globe. 
 Conveniently for us, lon/lat can be easily converted to x/y values for screen display. 
 In bar charts, we map data values to display values—numbers to rectangle heights. 
 In geomapping, we also map data values to display values—lon/lat becomes x/y. 
 Thinking in terms of x/y also makes it easier to get used to the uncomfortable order of longitude first, latitude second.

<a class="ulink" href="http://teczno.com/squares" target="_top">Get Lat+Lon</a> is a great resource by Michal Migurski for double-checking coordinate values. 
 Keep it open in a browser tab whenever you’re working on geomaps. 
 You will reference it often.

<h2>Paths</h2>
We’ve got our geodata. 
 Now get ready to rock.

First, we define our first

<em>path generator</em>:

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">();</code>
<code class="literal">d3.geo.path()</code> is a total lifesaver of a function. 
 It does all the dirty work of translating that mess of GeoJSON coordinates into even messier messes of SVG <code class="literal">path</code> codes. 
 All hail <code class="literal">d3.geo.path()</code>!

Now we

<em>could</em> paste all that GeoJSON directly into our HTML file, but ugh, so many coordinates and curly brackets—what a mess!  It’s cleaner and more common to keep the geodata in a separate file and load it in using <code class="literal">d3.json()</code>:

<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"us-states.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>          <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>            <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>            <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>  <code class="p">});</code>
<code class="literal">d3.json()</code> takes two arguments. 
 First, it takes a string pointing to the path of the file to load in. 
 Second, it takes a callback function that is fired when the JSON file has been loaded and parsed. 
 (See

<a class="xref" href="#handling_data_loading_errors_5" title="Handling Data Loading Errors">“Handling Data Loading Errors”</a> for details on the callback function.)  <code class="literal">d3.json()</code>, just like <code class="literal">d3.csv()</code>, is

<em>asynchronous</em>, meaning it won’t prevent the rest of your code from running while the browser waits for that external file to load. 
 For example, code placed

<em>after</em> the callback function might be executed

<em>before</em> the contents of the callback itself:

<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"someFile.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>         <code class="c1">//Put things here that depend on the JSON loading</code> <code class="p">});</code>  <code class="c1">//Only put things here that can operate independently of the JSON</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"I like cats."</code><code class="p">);</code>
So as a rule, when loading external datafiles, put the code that depends on that data within the callback function. 
 (Or put the code into other custom functions, and then call those functions from within the callback.)

Back to the example. 
 Finally, we bind the GeoJSON features to new <code class="literal">path</code> elements, creating one new <code class="literal">path</code> for each feature:

        <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>            <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>            <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
Notice that last line, in which <code class="literal">d</code> (the path data attribute) is referred to our path generator, which magically takes the bound geodata and calculates all that crazy SVG code. 
The result is

<a class="xref" href="#geojson_simple" title="Figure 12-1. Our first view of GeoJSON data">Figure 12-1</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1201.png" alt="Our first view of GeoJSON data">
Figure 12-1. Our first view of GeoJSON data 
A map!  That was so easy!  Check it out in

<em>01_paths.html</em>. 
 The rest is just customization.

You can find lots more detail on paths and path generator options

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Geo-Paths" target="_top">on the wiki</a>.

<h2>Projections</h2>
As an astute observer, you noticed that our map isn’t quite showing us the entire United States. 
 To correct this, we need to modify the

<em>projection</em> being used.

What is a projection?  Well, as an astute observer, you have also noticed that the globe is round, not flat. 
 Round things are three-dimensional, and don’t take well to being represented on two-dimensional surfaces. 
 A

<em>projection</em> is an algorithm of compromise; it is the method by which 3D space is “projected” onto a 2D plane.

We define D3 projections using a familiar structure:

<code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">albersUsa</code><code class="p">()</code>                        <code class="p">.</code><code class="nx">translate</code><code class="p">([</code><code class="nx">w</code><code class="o">/</code><code class="mi">2</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">]);</code>
D3 has several built-in projections. 
 Albers USA is a composite projection that nicely tucks Alaska and Hawaii beneath the Southwest. 
 (You’ll see in a second.)  <code class="literal">albersUsa</code> is actually the default projection for <code class="literal">d3.path.geo()</code>, but now that we’ve specified it explicitly, we can set several custom options, such as a translation value. 
 You can see we’re translating the projection to the center of the image (half of its width and half of its height).

The only other change we have to make is to tell the path generator explicitly that it should reference our customized projection when generating all those paths:

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">path</code><code class="p">()</code>                  <code class="p">.</code><code class="nx">projection</code><code class="p">(</code><code class="nx">projection</code><code class="p">);</code>
That gives us

<a class="xref" href="#geojson_centered" title="Figure 12-2. The same GeoJSON data, but now with a centered projection">Figure 12-2</a>. 
Getting there!  See

<em>02_projection.html</em> for the working code.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1202.png" alt="The same GeoJSON data, but now with a centered projection">
Figure 12-2. The same GeoJSON data, but now with a centered projection 
We can also add a <code class="literal">scale()</code> method to our projection in order to shrink things down a bit and achieve the result shown in

<a class="xref" href="#geojson_scaled" title="Figure 12-3. The USA, scaled and centered within the image">Figure 12-3</a>:

<code class="kd">var</code> <code class="nx">projection</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">geo</code><code class="p">.</code><code class="nx">albersUsa</code><code class="p">()</code>                        <code class="p">.</code><code class="nx">translate</code><code class="p">([</code><code class="nx">w</code><code class="o">/</code><code class="mi">2</code><code class="p">,</code> <code class="nx">h</code><code class="o">/</code><code class="mi">2</code><code class="p">])</code>                        <code class="p">.</code><code class="nx">scale</code><code class="p">([</code><code class="mi">500</code><code class="p">]);</code>
The default scale value is 1,000. 
 Anything smaller will shrink the map; anything larger will expand it.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1203.png" alt="The USA, scaled and centered within the image">
Figure 12-3. The USA, scaled and centered within the image 
Cool!  See that working code in

<em>03_scaled.html</em>.

By adding a single <code class="literal">style()</code> statement, we could set the path’s fills to something less severe, like the blue shown in

<a class="xref" href="#geojson_filled" title="Figure 12-4. Now more blue-ish than black">Figure 12-4</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1204.png" alt="Now more blue-ish than black">
Figure 12-4. Now more blue-ish than black 
See

<em>04_fill.html</em> for that. 
 You could use the same technique to set stroke color and width, too.

Map projections are extremely powerful algorithms, and different projections are useful for different purposes and different parts of the world (near the poles, versus the equator, for example).

Thanks primarily to the contributions of

<a class="ulink" href="http://www.jasondavies.com" target="_top">Jason Davies</a>, D3’s geo projections plug-ins now support essentially every obscure projection you could imagine. 
 Reference

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Geo-Projections" target="_top">the complete visual reference of D3 projections on the wiki</a>. 
 You might also find the

<a class="ulink" href="http://bl.ocks.org/3711652" target="_top">projection comparison demo</a> useful.


<h2>Choropleth</h2>
Choro-

<em>what?</em>  This word, which can be difficult to pronounce, refers to a geomap with areas filled in with different values (light or dark) or colors to reflect associated data values. 
 In the United States, so-called “red state, blue state” choropleth maps showing the Republican and Democratic leanings of each state are ubiquitous, especially around election time. 
 But choropleths can be generated from any values, not just political ones.

These maps are also some of the most requested uses of D3. 
 Although choropleths can be fantastically useful, keep in mind that they have some inherent perceptual limitations. 
 Because they use

<em>area</em> to encode values, large areas with low density (such as the state of Nevada) might be overrepresented visually. 
 A standard choropleth does not represent per-capita values fairly—Nevada is too big, and Delaware far too small. 
 But they

<em>do</em> retain the geography of a place, and—as maps—they look really, really cool. 
 So let’s dive in. 
 (You can follow along with

<em>05_choropleth.html</em>.)

First, I’ll set up a scale that can take data values as input, and will return colors. 
 This is the heart of choropleth-style mapping:

<code class="kd">var</code> <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scale</code><code class="p">.</code><code class="nx">quantize</code><code class="p">()</code>                     <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="s2">"rgb(237,248,233)"</code><code class="p">,</code> <code class="s2">"rgb(186,228,179)"</code><code class="p">,</code>                      <code class="s2">"rgb(116,196,118)"</code><code class="p">,</code> <code class="s2">"rgb(49,163,84)"</code><code class="p">,</code><code class="s2">"rgb(0,109,44)"</code><code class="p">]);</code>
A

<em>quantize</em> scale functions as a linear scale, but it outputs values from within a discrete range. 
 These output values could be numbers, colors (as we’ve done here), or anything else you like. 
 This is useful for sorting values into “buckets.”  In this case, we’re using five buckets, but there could be as many as you like.

Notice I’ve specified an output range, but not an input domain. 
 (I’m waiting until our data is loaded in to do that.)  These particular colors are taken from the
<code class="literal">colorbrewer.js</code> file included in

<a class="ulink" href="https://github.com/mbostock/d3/tree/master/lib/colorbrewer" target="_top">the D3 GitHub repository</a>—a collection of perceptually optimized colors, selected by Cynthia Brewer, and based on her research.

Next, we need to load in some data. 
 I’ve provided a file

<em>us-ag-productivity-2004.csv</em>, which looks like this:

state,value Alabama,1.1791 Arkansas,1.3705 Arizona,1.3847 California,1.7979 Colorado,1.0325 Connecticut,1.3209 Delaware,1.4345 …
This data, provided by the US Department of Agriculture, reports agricultural productivity by state during the year 2004. 
 The units are relative to an arbitrary baseline of the productivity of the state of Alabama in 1996 (1.0), so greater values are more productive, and smaller values less so. 
 (Find lots of open government datasets at

<a class="ulink" href="http://data.gov" target="_top">http://data.gov</a>.)  I expect this data will give us a nice map of states’ agricultural productivity.

To load in the data, we use <code class="literal">d3.csv()</code>:

<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"us-ag-productivity-2004.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code> <code class="err">…</code>
Then, in the callback function, I want to set the <code class="literal">color</code> quantize scale’s input domain (before I forget!):

        <code class="nx">color</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code>                 <code class="nx">d3</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">}),</code>                 <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})</code>         <code class="p">]);</code>
This uses <code class="literal">d3.min()</code> and <code class="literal">d3.max()</code> to calculate and return the smallest and largest data values, so the scale’s domain is dynamically calculated.

Next, we load in the JSON geodata, as before. 
 But what’s new here is I want to

<em>merge</em> the agricultural data

<em>into</em> the GeoJSON. 
 Why?  Because we can only bind one set of data to elements at a time. 
 We definitely need the GeoJSON, from which the <code class="literal">path</code>s are generated, but we also need the new agricultural data. 
 So if we can smush them into a single, monster array, then we can bind them to the new <code class="literal">path</code> elements all at the same time. 
 (There are several approaches to this step; what follows is my preferred method.)

    <code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"us-states.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">json</code><code class="p">)</code> <code class="p">{</code>          <code class="c1">//Merge the ag. 
data and GeoJSON</code>         <code class="c1">//Loop through once for each ag. 
data value</code>         <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>              <code class="c1">//Grab state name</code>             <code class="kd">var</code> <code class="nx">dataState</code> <code class="o">=</code> <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">state</code><code class="p">;</code>              <code class="c1">//Grab data value, and convert from string to float</code>             <code class="kd">var</code> <code class="nx">dataValue</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">value</code><code class="p">);</code>              <code class="c1">//Find the corresponding state inside the GeoJSON</code>             <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">j</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">j</code> <code class="o">&lt;</code> <code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="nx">j</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>              <code class="kd">var</code> <code class="nx">jsonState</code> <code class="o">=</code> <code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">[</code><code class="nx">j</code><code class="p">].</code><code class="nx">properties</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>              <code class="k">if</code> <code class="p">(</code><code class="nx">dataState</code> <code class="o">==</code> <code class="nx">jsonState</code><code class="p">)</code> <code class="p">{</code>                  <code class="c1">//Copy the data value into the JSON</code>                 <code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">[</code><code class="nx">j</code><code class="p">].</code><code class="nx">properties</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">dataValue</code><code class="p">;</code>                  <code class="c1">//Stop looking through the JSON</code>                 <code class="k">break</code><code class="p">;</code>          <code class="p">}</code>     <code class="p">}</code> <code class="p">}</code>
Read through that closely. 
 Basically, for each state, we are finding the GeoJSON element with the same name (e.g., “Colorado”). 
 Then we take the state’s data value and tuck it in under <code class="literal">json.features[j].properties.value</code>, ensuring it will be bound to the element and available later, when we need it.

Lastly, we create the <code class="literal">path</code>s just as before, only we make our <code class="literal">style()</code> value dynamic:

                <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">json</code><code class="p">.</code><code class="nx">features</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>                    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>                    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                                 <code class="c1">//Get data value</code>                                 <code class="kd">var</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">properties</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>                                  <code class="k">if</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>                                         <code class="c1">//If value exists…</code>                                         <code class="k">return</code> <code class="nx">color</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>                                 <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>                                         <code class="c1">//If value is undefined…</code>                                         <code class="k">return</code> <code class="s2">"#ccc"</code><code class="p">;</code>                                 <code class="p">}</code>                    <code class="p">});</code>
Instead of <code class="literal">"steelblue"</code> for everyone, now each state <code class="literal">path</code> gets a different fill value. 
 The trick is that we don’t have data for

<em>every</em> state. 
 The dataset we’re using doesn’t have information for Alaska, the District of Columbia, Hawaii, or Puerto Rico (which, although not a state, is still included in the GeoJSON and appears in the projection).

So to accommodate those exceptions, we include a little logic: an <code class="literal">if()</code> statement that checks to see whether or not the data value has been defined. 
 If it exists, then we return <code class="literal">color(value)</code>, meaning we pass the data value to our quantize scale, which returns a color. 
 For undefined values, we set a default of light gray (<code class="literal">#ccc</code>).

Beautiful! Just look at the result in

<a class="xref" href="#choropleth_map" title="Figure 12-5. A choropleth map showing agricultural productivity by state">Figure 12-5</a>. 
Check out the final code and try it yourself in

<em>05_choropleth.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1205.png" alt="A choropleth map showing agricultural productivity by state">
Figure 12-5. A choropleth map showing agricultural productivity by state  

<h2>Adding Points</h2>
Wouldn’t it be nice to put some cities on this map, for context?  Maybe it would be interesting or useful to see how many large, urban areas there are in the most (or least) agriculturally productive states. 
 Again, let’s start by finding the data.

Fortunately, the US Census has us covered, once again. 
 (Your tax dollars at work!)  Here’s the start of a raw CSV dataset from the Census that shows

<a class="ulink" href="http://1.usa.gov/XWUSrY" target="_top">“Annual Estimates of the Resident Population for Incorporated Places Over 50,000”</a>.

table with row headers in column A and column headers in rows 3 through 4,,,,,,, ,,, "Table 1. 
Annual Estimates of the Resident Population for Incorporated Places Over 50,000, Ranked by July 1, 2011 Population: April 1, 2010 to July 1, 2011" ,,,,,,,,,, Rank,Geographic Area,,"April 1, 2010",,Population Estimate (as of July 1),, ,,,,Place,State,Census,Estimates Base,2010,2011,,,, 1,New York city,New York,"8,175,133","8,175,133","8,186,443","8,244,910",,,, 2,Los Angeles city,California,"3,792,621","3,792,625","3,795,761","3,819,702" ,,,, 3,Chicago city,Illinois,"2,695,598","2,695,598","2,698,283","2,707,120",,,, 4,Houston city,Texas,"2,099,451","2,099,430","2,108,278","2,145,146",,,, 5,Philadelphia city,Pennsylvania,"1,526,006","1,526,006","1,528,074","1,536,471" ,,,, 6,Phoenix city,Arizona,"1,445,632","1,445,656","1,448,531","1,469,471",,,, 7,San Antonio city,Texas,"1,327,407","1,327,606","1,334,431","1,359,758",,,, 8,San Diego city,California,"1,307,402","1,307,406","1,311,516","1,326,179",,,, 9,Dallas city,Texas,"1,197,816","1,197,816","1,201,715","1,223,229",,,, 10,San Jose city,California,"945,942","952,612","955,091","967,487",,,, …
This is quite messy, and I don’t even need all this data. 
 So I’ll open the CSV up in my favorite spreadsheet program and clean it up a bit, removing unneeded columns. 
 (You could use LibreOffice Calc, Apple Numbers, or Microsoft Excel.)  I’m also interested in only the largest 50 cities, so I’ll delete all the others. 
 Exporting back to CSV, I now have this:

rank,place,population 1,New York city,8175133 2,Los Angeles city,3792621 3,Chicago city,2695598 4,Houston city,2099451 5,Philadelphia city,1526006 6,Phoenix city,1445632 7,San Antonio city,1327407 8,San Diego city,1307402 9,Dallas city,1197816 10,San Jose city,945942 …
This information is useful, but to place it on the map, I’m going to need the latitude and longitude coordinates for each of these places. 
 Looking this up manually would take

<em>forever</em>. 
 Fortunately, we can use a

<em>geocoding</em> service to speed things up. 
 Geocoding is the process of taking place names, looking them up on a map (or in a database, really), and returning precise lat/lon coordinates. 
 “Precise” might be a bit of an overstatement—the geocoder does the best job it can, but it will sometimes be forced to make assumptions given vague data. 
 For example, if you specify “Paris,” it will probably assume you mean Paris, France and not Paris, Texas. 
 It’s good practice to eyeball the geocoder’s output once you get it on the map, and manually adjust any erroneous coordinates (using

<a class="ulink" href="http://www.teczno.com/squares" target="_top">teczno.com/squares</a> as a reference).

I’ll head over to

<a class="ulink" href="http://www.gpsvisualizer.com/geocoder/" target="_top">my favorite batch geocoder</a>, paste in just the place names, and click Start!  A few minutes later, the geocoder spits out some more comma-separated values, which includes lat/lon pairs. 
 I bring those back into my spreadsheet, and save out a new, unified CSV with coordinates:

rank,place,population,lat,lon 1,New York city,8175133,40.71455,-74.007124 2,Los Angeles city,3792621,34.05349,-118.245323 3,Chicago city,2695598,45.37399,-92.888759 4,Houston city,2099451,41.337462,-75.733627 5,Philadelphia city,1526006,37.15477,-94.486114 6,Phoenix city,1445632,32.46764,-85.000823 7,San Antonio city,1327407,37.706576,-122.440612 8,San Diego city,1307402,37.707815,-122.466624 9,Dallas city,1197816,40.636,-91.168309 10,San Jose city,945942,41.209716,-112.003047 …
That was unbelievably easy. 
 Ten years ago that step would have taken us hours of research and tedious data entry, not seconds of mindless copying-and-pasting. 
 Now you see why we’re experiencing an explosion of online mapping.

Our data is ready, and we already know how to load it in:

<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"us-cities.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>         <code class="c1">//Do something…</code> <code class="p">});</code>
In the callback function, we can specify how to create a new <code class="literal">circle</code> element for each city, and then

<em>position each circle</em> according to the corresponding city’s geo-coordinates:

        <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>            <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>            <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                    <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">0</code><code class="p">];</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                    <code class="k">return</code> <code class="nx">projection</code><code class="p">([</code><code class="nx">d</code><code class="p">.</code><code class="nx">lon</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">lat</code><code class="p">])[</code><code class="mi">1</code><code class="p">];</code>            <code class="p">})</code>            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"yellow"</code><code class="p">)</code>            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mf">0.75</code><code class="p">);</code>
The magic here is in those <code class="literal">attr()</code> statements that set the <code class="literal">cx</code> and <code class="literal">cy</code> values. 
 You see, we can access the raw latitude and longitude values as <code class="literal">d.lat</code> and <code class="literal">d.lon</code>. 
 But what we really need for positioning these circles are x/y

<em>screen coordinates</em>, not

<em>geo</em>-coordinates.

So we bring back our magical friend <code class="literal">projection()</code>, which is basically just a two-dimensional scale method. 
 With D3 scales, we put in one number, and get back another. 
 With projections, we put in two numbers, and get back two. 
 (The other main difference is that the behind-the-scenes math for projections is much more complex than the simple normalization of scales.)

The map projection takes a two-value array as input, with

<em>longitude</em> first (remember, it’s lon/lat, not lat/lon, in GeoJSON-ville). 
 Then the projection returns a two-value array with x/y screen values. 
 So, for <code class="literal">cx</code>, we use <code class="literal">[0]</code> to grab the

<em>first</em> of those values, which is

<em>x</em>. 
 For <code class="literal">cy</code>, we use <code class="literal">[1]</code> to grab the

<em>second</em> of those values, which is

<em>y</em>. 
 Make sense?

The resulting map in

<a class="xref" href="#choropleth_with_cities" title="Figure 12-6. The top 50 largest US cities, represented as cute little yellow dots">Figure 12-6</a> is suh-weeeet! Check out the code in

<em>06_points.html</em>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1206.png" alt="The top 50 largest US cities, represented as cute little yellow dots">
Figure 12-6. The top 50 largest US cities, represented as cute little yellow dots 
Yet these dots are all the same size. 
 Let’s link the population data to circle size. 
 Instead of a static area, we’ll reference the <code class="literal">population</code> value:

           <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>                  <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nb">parseInt</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">population</code><code class="p">)</code> <code class="o">*</code> <code class="mf">0.00004</code><code class="p">);</code>            <code class="p">})</code>
Here we grab <code class="literal">d.population</code>, wrap it in <code class="literal">parseInt()</code> to convert it from a string to an integer, scale that value down by an arbitrary amount, and finally take the square root (to convert from an area value to a radius value). 
 See the code in

<em>07_points_sized.html</em>.

As you can see in

<a class="xref" href="#choropleth_with_cities_sized" title="Figure 12-7. Cities as dots, with area set by population">Figure 12-7</a>, now the largest cities really stand out. 
 The differences in city size are significant; this representation might be better suited to a log scale, especially if even smaller cities are included. 
 Instead of multiplying by 0.00004, you could more properly use a custom D3 scale function. 
 (I’ll leave that to you.)

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1207.png" alt="Cities as dots, with area set by population">
Figure 12-7. Cities as dots, with area set by population 
The point here is to see that we’ve successfully loaded and visualized two different datasets on a map. 
 (Make that three, counting the geocoded coordinates we merged in!)

<h2>Acquiring and Parsing Geodata</h2>
If we only ever wanted to make maps of the United States, then we would already have all the GeoJSON we’d ever need. 
 But the world is much bigger than that, and there are lots of other areas to map. 
 So allow me to digress for a moment and address how to acquire and parse geodata for the area of your choosing. 
 The end goal is to produce a GeoJSON file, like

<em>us-states.json</em>, that can be used with D3.

<h3>Find Shapefiles</h3>
So-called

<em>shapefiles</em> predate the current explosion of online mapping and visualization. 
 These are documents that essentially contain the same kind of information you could store in GeoJSON—boundaries of geographic areas, and points within those areas—but their contents are not plain text and, therefore, are very hard to read. 
 The shapefile format grew out of the community of geographers, cartographers, and scientists using Geographic Information Systems (GIS) software. 
 If you have easy access to expensive GIS software, then shapefiles are your best friend. 
 But that’s a small group of people, and web browsers can’t make heads or tails of shapefiles, in any case.

If you can’t find nice GeoJSON describing your area of interest, then hunt down a shapefile. 
 Government websites are good sources, especially if you’re looking for data on a specific country or region. 
 My favorite two sources are:

<dl class="variablelist">
<dt>

<a class="ulink" href="http://www.naturalearthdata.com" target="_top">Natural Earth</a> </dt>
<dd> A massive collection of geographic data for both cultural/political and natural features made available in the public domain. 
 Mapping countries is highly political, and Natural Earth posts detailed notes explaining their design decisions. 
</dd>
<dt>

<a class="ulink" href="http://www.census.gov/geo/www/cob/cbf_state.html" target="_top">The United States Census</a> </dt>
<dd> Boundary data for every US state, plus counties, roadways, water features, and so much more, also in the public domain. 
</dd> </dl> 

<h3>Choose a Resolution</h3>
Before you download, check the

<em>resolution</em> of the data. 
 All shapefiles are vector data (not bitmap), so by resolution I don’t mean pixels—I mean the level of

<em>cartographic detail</em> or granularity.

Natural Earth’s datasets come in three different resolutions, listed here from most detailed to least:

 1:10,000,000  1:50,000,000  1:110,000,000  
That is, in the highest resolution data, one unit of measurement in the file corresponds to 10 million such units in the actual, physical world. 
 Or, to flip that around, every 10 million units in real life is simplified into one. 
 So 10 million inches (158 miles) would translate to a single inch in data terms.

These resolution ratios can be written more simply as:

 1:10m  1:50m  1:110m  
For a low-detail (“zoomed out”) map of the world, the 1:110m resolution could work fine. 
 But to show detailed outlines of a specific state, 1:10m will be better. 
 If you’re mapping a very small (“zoomed in”) area, such as a specific city or even neighborhood, then you’ll need much higher resolution data. 
 (Try local state or city government websites for that information.)

Different sources will offer different resolutions. 
 Many of the US Census shapefiles are available in these three scales:

 1:500,000 (1:500k)  1:5,000,000 (1:5m)  1:20,000,000 (1:20m)  
Choose a resolution, and download the file. 
 Typically you’ll get a compressed ZIP file that contains several other files. 
 As an example, I’m going to download Natural Earth’s 1:110m (low detail) ocean file from here:

<a class="ulink" href="http://www.naturalearthdata.com/downloads/110m-physical-vectors/110m-ocean/" target="_top">http://www.naturalearthdata.com/downloads/110m-physical-vectors/110m-ocean/</a>.

Uncompressed, it contains these files:

ne_110m_ocean.dbf ne_110m_ocean.prj ne_110m_ocean.README.html ne_110m_ocean.shp ne_110m_ocean.shx ne_110m_ocean.VERSION.txt
Wow, those are some funky extensions. 
 We’re primarily interested in the file ending with

<em>.shp</em>, but don’t delete the rest just yet.

<h3>Simplify the Shapes</h3>
Ideally, you can find shapefiles in exactly the resolution you need. 
 But what if you can only find a super-high-resolution file, say at 1:100k?  The size of the file might be huge. 
 And now that you’re a JavaScript programmer, you’re really concerned about efficiency, remember?  So no sending multimegabyte geodata to the browser.

Fortunately, you can

<em>simplify</em> those shapefiles, in effect converting them into lower-detail versions of themselves. 
 The process of simplification is illustrated beautifully in

<a class="ulink" href="http://bost.ocks.org/mike/simplify/" target="_top">this interactive piece by Mike Bostock</a>.

<a class="ulink" href="http://mapshaper.org" target="_top">MapShaper</a>, by Matt Bloch, is an excellent, easy-to-use interactive tool for this purpose. 
 It lets you upload your own shapefiles, and then drag sliders around to preview different levels of simplification. 
 Typically, the trade-off is between good detail and small files.

If you use MapShaper, choose the “Shapefile – polygons” option when exporting. 
This will generate both a

<em>.shp</em> and a

<em>.shx</em> file for you. 
Download both files, and rename them so the filenames match the names of the original

<em>.shp</em> and

<em>.shx</em> files. 
Then, before converting to GeoJSON, make a copy of the original

<em>.dbf</em> file, and put it in the same folder as the simplified shapefiles. 
This important step will ensure you don’t lose any of the important metadata that’s stored in the

<em>.dbf</em>, like country IDs and other path identifiers.

Other options include Mike Migurski’s

<a class="ulink" href="https://github.com/migurski/Bloch" target="_top">Bloch</a> with a Python implementation of Matt Bloch’s simplification algorithms, and a <code class="literal">d3.simplify</code> plug-in (used for Mike’s demo mentioned earlier). 
 The dream is one day we could use JavaScript to perform line simplification directly, and then export that simplified JSON to use in projects. 
 The tools are evolving quickly, so watch this space!  (Literally while I was writing this paragraph, Mr. 
Bostock posted

<a class="ulink" href="http://bl.ocks.org/4090870" target="_top">a demo</a> for a new project for geometry simplification,

<a class="ulink" href="https://github.com/mbostock/topojson" target="_top">TopoJSON</a>. 
 That’s how fast things are changing! By the time you read this, the TopoJSON command-line tool may be your best bet, as it can load shapefiles, perform simplification,

<em>and</em> convert your data to JSON. 
As you’d expect, TopoJSON is designed to play well with D3, although it outputs a new TopoJSON format, which is similar to, but more efficient than GeoJSON.)


<h3>Convert to GeoJSON</h3>
If you don’t already have the right software installed, this can be the hairiest part of the process. 
 Our end goal is to get a terminal command called <code class="literal">ogr2ogr</code> running on your Mac, Unix, or Windows system. 
 The problem is that <code class="literal">ogr2ogr</code> depends on several other frameworks, libraries, and so on, so for it to work, they all have to be in place.

I won’t cover the intricacies of the installation here, but I’ll point you in the right
direction.

First, you need

<a class="ulink" href="http://www.gdal.org" target="_top">the Geospatial Data Abstraction Library</a>, or GDAL. 
 The <code class="literal">ogr2ogr</code> utility is part of this package.

You also need

<a class="ulink" href="http://trac.osgeo.org/geos/" target="_top">GEOS</a>, which cleverly stands for Geometry Engine, Open Source.

If you have a Windows or Unix/Linux machine, you can now have fun downloading the source and installing it by typing funny commands like

<strong><code class="literal">build</code></strong>,

<strong><code class="literal">make</code></strong>, and

<strong><code class="literal">seriously why isn’t this working omg please please please install this time or i will freak out</code></strong>.

I don’t remember the exact command names, but they are something like that. 
 (On a serious note, if you get stuck on this step, be aware that there are literally entire other O’Reilly books on how to download and install software packages like this.)

If you’re on a Mac, and you happen to have both Xcode

<em>and</em> Homebrew installed, then simply type

<strong><code class="literal">brew install gdal</code></strong> into the terminal, and you’re done!  (If you don’t have either of these amazing tools, they might be worth getting. 
 Both tools are free, but could take some time and effort on your part to install. 
 Xcode is a massive

<a class="ulink" href="http://bit.ly/XUTt81" target="_top">download from the App Store</a>. 
 Once you have Xcode, Homebrew can, in theory, be installed with

<a class="ulink" href="http://mxcl.github.com/homebrew/" target="_top">a simple terminal command</a>. 
 In my experience, some troubleshooting was required to get it working.)

To Mac users without Xcode or Homebrew: you are very lucky that some kind soul has precompiled a friendly GUI installer, which installs GDAL, GEOS, and several other tools whose names you don’t really need to know. 
 Look for the newest version of the

<a class="ulink" href="http://www.kyngchaos.com/software/frameworks" target="_top">“GDAL Complete” package</a>. 
 Review the GDAL ReadMe file closely. 
 After installation, you won’t automatically be able to type

<strong><code class="literal">ogr2ogr</code></strong> in a terminal window. 
 You’ll need to add the GDAL programs to your shell path. 
 The easiest way to do that is:  Open a new terminal window. 
 Type

<strong><code class="literal">nano .bash_profile</code></strong>. 
 Paste in <code class="literal">export PATH=/Library/Frameworks/GDAL.framework/Programs:$PATH</code> and then Control-X and Control-y to save. 
 Type

<strong><code class="literal">exit</code></strong> to end the session, then open a new terminal window and type

<strong><code class="literal">ogr2ogr</code></strong> to see if it worked.

No matter what system you’re on, once all the tools are installed, open up a new terminal window and navigate to whatever directory contains all the shapefiles (for example,

<strong><code class="literal">cd ~/ocean_shapes/</code></strong>.)  Then use the form:

ogr2ogr -f <code class="s2">"GeoJSON"</code> output.json filename.shp
This tells <code class="literal">ogr2ogr</code> to take <code class="literal">filename</code>, which should be a

<em>.shp</em> file, convert it to GeoJSON, and finally save it as a file called

<em>output.json</em>.

For my sample ocean data file, using <code class="literal">ogr2ogr</code> looks like the following:

ogr2ogr -f <code class="s2">"GeoJSON"</code> output.json ne_110m_ocean.shp
Type that in, and hopefully you see nothing at all.

So anticlimactic!  I know, after the hours you spent hacking the command line to get ol’ <code class="literal">ogr</code> installed, you were expecting some gradiose finale, as though you saved the princess in Super Mario 3, yet again. 
 (I actually have never done that, but I imagine it is pretty amazing.)

But no, hopefully nothing happened at all. 
 Except there should be a new file in the same directory called

<em>output.json</em>.

Here’s the start of mine:

<code class="p">{</code> <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"FeatureCollection"</code><code class="p">,</code> <code class="s2">"features"</code><code class="o">:</code> <code class="p">[</code> <code class="p">{</code> <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Feature"</code><code class="p">,</code> <code class="s2">"properties"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"scalerank"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"featurecla"</code><code class="o">:</code> <code class="s2">"Ocean"</code> <code class="p">},</code> <code class="s2">"geometry"</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"Polygon"</code><code class="p">,</code> <code class="s2">"coordinates"</code><code class="o">:</code>     <code class="p">[</code> <code class="p">[</code> <code class="p">[</code> <code class="mf">49.110290527343778</code><code class="p">,</code> <code class="mf">41.28228759765625</code> <code class="p">],</code>         <code class="p">[</code> <code class="mf">48.584472656250085</code><code class="p">,</code> <code class="mf">41.80889892578125</code> <code class="p">],</code>     <code class="p">[</code> <code class="mf">47.492492675781335</code><code class="p">,</code> <code class="mf">42.9866943359375</code> <code class="p">],</code>         <code class="p">[</code> <code class="mf">47.590881347656278</code><code class="p">,</code> <code class="mf">43.660278320312528</code> <code class="p">],</code>     <code class="p">[</code> <code class="mf">46.682128906250028</code><code class="p">,</code> <code class="mf">44.609313964843807</code> <code class="p">],</code>         <code class="p">[</code> <code class="mf">47.675903320312585</code><code class="p">,</code> <code class="mf">45.641479492187557</code> <code class="p">],</code>     <code class="p">[</code> <code class="mf">48.645507812500085</code><code class="p">,</code> <code class="mf">45.806274414062557</code> <code class="p">]</code>         <code class="err">…</code>
Hey, finally, this is starting to look familiar!

Excitedly, now we copy our new GeoJSON into our D3 directory. 
 I rename mine

<em>oceans.json</em>, copy an earlier HTML document, and in the D3 code, simply change the reference from <code class="literal">us-states.json</code> to <code class="literal">oceans.json</code>, and then get the result shown in

<a class="xref" href="#oceans" title="Figure 12-8. GeoJSON showing, um, the world’s oceans?">Figure 12-8</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1208.png" alt="GeoJSON showing, um, the world’s oceans?">
Figure 12-8. GeoJSON showing, um, the world’s oceans? 
Blaaa!  What is that?!  Whatever it is, you can see it in

<em>08_oceans.html</em>.

In my haste, I forgot to update the projection!  Let’s make one tiny change, from
<code class="literal">albersUsa</code> to <code class="literal">mercator</code> (see

<a class="xref" href="#oceans2" title="Figure 12-9. GeoJSON of the world’s oceans, now properly projected">Figure 12-9</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1209.png" alt="GeoJSON of the world’s oceans, now properly projected">
Figure 12-9. GeoJSON of the world’s oceans, now properly projected 
See the result in

<em>09_mercator.html</em>—oceanic GeoJSON paths, downloaded, parsed, and visualized.

<h1><span class="orange">Chapter 13. Exporting</span></h1>
Sometimes you need to take your visualization beyond the browser, such as when you’re asked to present your work in a TED talk or in your first solo show at MoMA.

Here are three easy ways to get D3 visualizations out of D3 and into formats suitable for other, noninteractive media. 
 D3 has no explicit “export” function built in (although some people have built their own), so what follows are simple techniques that will work for any SVG image in a web browser.

<h2>Bitmaps</h2>
The easiest and lowest-quality option is, obviously, to take a screenshot. 
 Depending on your operating system, this can be done using the Print Screen button on a PC, or ⌘-Shift-4 on the Mac. 
 (Drag those crosshairs over the area you want to capture, release, and check your desktop for a PNG image.)

<a class="xref" href="#bitmap_export" title="Figure 13-1. A PNG screenshot">Figure 13-1</a> is a bitmap screenshot I made using the latter technique.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1301.png" alt="A PNG screenshot">
Figure 13-1. A PNG screenshot 
This is easy and quick, but generates a bitmap image at screen resolution. 
 So, as you can see, the image won’t scale up nicely, nor print with sharp edges. 
 This approach is
probably suitable only for reuse on-screen. 
 (The exception to this is if you have a super high-res display, then the resolution will be much finer.)

<h2>PDF</h2>
Portable Document Format documents can contain vector-based artwork, such as SVG images, so exporting to PDF gives you a quick, scalable copy of your visualization (see

<a class="xref" href="#pdf_export" title="Figure 13-2. A PDF maintains the original vector data for clarity">Figure 13-2</a>).

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1302.png" alt="A PDF maintains the original vector data for clarity">
Figure 13-2. A PDF maintains the original vector data for clarity 
On the Mac, in your browser, go to File→Print. 
 Then look for the PDF menu, and choose Save as PDF.

On Windows or Linux, you might need to install a third-party utility to enable print-to-PDF functionality. 
 (I’ve heard doPDF for Windows works, and it’s free.)


<h2>SVG</h2>
Finally, it probably occurred to you that, because we are using D3 to generate images in SVG format, why not just save out a copy of the SVG image?  This has all the benefits of PDF: You maintain the original vector data, it’s scalable, and you can even bring the results into Illustrator or another SVG-compatible editor and tweak it after the fact. 
 (This is true to a certain extent for PDF files as well, but depending on the PDF generator, sometimes elements get grouped and layered in unexpected ways.)

The simplest way is to simply copy the SVG code straight out of the DOM (see

<a class="xref" href="#copy_the_svg" title="Figure 13-3. Copying the D3-generated SVG code from the DOM">Figure 13-3</a>). 
 First, inspect the SVG element. 
 Click the element in the web inspector, and then click Copy.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1303.png" alt="Copying the D3-generated SVG code from the DOM">
Figure 13-3. Copying the D3-generated SVG code from the DOM 
Switch back to your text editor, and paste the contents into a new file, as shown in

<a class="xref" href="#paste_the_svg" title="Figure 13-4. SVG code pasted into a new document">Figure 13-4</a>.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1304.png" alt="SVG code pasted into a new document">
Figure 13-4. SVG code pasted into a new document 
Then just save the file as

<em>something.svg</em>. 
 Now you can open it up in Illustrator, as shown in

<a class="xref" href="#svg_in_illustrator" title="Figure 13-5. Exported SVG opened in Illustrator">Figure 13-5</a>, or any other SVG-compatible program.

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1305.png" alt="Exported SVG opened in Illustrator">
Figure 13-5. Exported SVG opened in Illustrator 
As you can see in

<a class="xref" href="#edit_the_svg" title="Figure 13-6. SVG elements selected and highlighted">Figure 13-6</a>, all of the elements remain individually selectable and editable. 
 In the version shown in

<a class="xref" href="#edited_svg_in_illustrator" title="Figure 13-7. My groundbreaking image, made even more so with some manual touch-ups">Figure 13-7</a>, I’ve made some Tuftean enhancements to my design, adding variable-weight strokes and a neutral, lavender fill for a visually “calming” effect. 
 (To be clear, this is a joke, and neither Tufte nor I endorse this
approach.)

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1306.png" alt="SVG elements selected and highlighted">
Figure 13-6. SVG elements selected and highlighted 

<img src="http://orm-chimera-prod.s3.amazonaws.com/1230000000345/images/idvw_1307.png" alt="My groundbreaking image, made even more so with some manual touch-ups">
Figure 13-7. My groundbreaking image, made even more so with some manual
touch-ups  
As you can see, there are many options for getting your work out of the browser, documented, and saved for use in other contexts, whether for print or for the screen.

<h1><span class="orange">Appendix A. Appendix: Further Study</span></h1>
You are a trouper for making it this far. 
 We’ve covered a lot of ground, and by now you have a decent handle on D3’s basic concepts and common techniques. 
 If you’ve learned anything, I hope it’s that there are always several (or tens, or hundreds of) ways to accomplish the same task—that’s the joy of programming, right?  I’ve presented the ways that, to me, are the simplest or most intuitive, and the least difficult to understand. 
 But there are probably

<em>better</em> ways to do anything that you learned in this book, whether “better” means “more computationally efficient” or “makes more sense to you and your way of working.”  I’m a fan of the latter definition. 
 Programming is like solving a puzzle; it’s up to you to figure out how to tell the computer what to do what you want—using language that you, the human, can still understand.

D3 is a powerful tool, and we’ve only scratched the surface. 
 As you begin work on your own visualization projects, you’ll discover many additional helpful methods and sneaky shortcuts. 
 There are lots of valuable bits that I didn’t cover here, such as D3’s built-in methods for working with date and time values, dynamically selecting and calculating colors, and painlessly manipulating arrays, for all your client-side data processing needs—just to name a few. 
 There is a

<em>lot</em> to this tool. 
 I’ve tried to introduce you to the core concepts, and now you’re ready to go dig into the pieces that really interest you.

So, where to turn next?  Here’s a collection of valuable resources to aid you in your quest. 
 Keep in mind that the D3 software itself is still evolving, and so are these resources. 
 By the time you read this, there might be some other helpful website or set of tutorials not mentioned here. 
 That is why I recommend that you don’t just read, but

<em>get involved</em> with the D3 community. 
 Join

<a class="ulink" href="https://groups.google.com/forum/#!forum/d3-js" target="_top">the Google Group</a>, follow people on Twitter, and keep your eyes open for the latest developments. 
 Start a discussion, and meet fellow data visualizers in your local area. 
 If there aren’t D3 datavis groups getting together in your area yet, then start one yourself. 
 The more we can learn from each other, the better.

After all, having worked through this book, you’re part of the community now (whether you like it or not). 
 Welcome!

<h2>Books</h2>

<a class="ulink" href="http://shop.oreilly.com/product/0636920025429.do" target="_top">

<em>Getting Starting with D3</em></a> by Mike Dewar. 
O’Reilly, 2012.

Yes, there’s only one other book on D3 so far. 
 Mike Dewar’s introduction tackles some more advanced topics, and includes sample projects with real-world data from New York City’s transportation system. 
 (Fun!)

<h2>Websites</h2>

<dl class="variablelist">
<dt>

<a class="ulink" href="http://d3js.org" target="_top">d3js.org</a> </dt>
<dd> Your starting point for everything D3. 
</dd>
<dt>

<a class="ulink" href="https://github.com/mbostock/d3/wiki/Gallery" target="_top">github.com/mbostock/d3/wiki/Gallery</a> </dt>
<dd> The D3 gallery contains

<em>hundreds</em> of examples. 
 Add your own work! </dd>
<dt>

<a class="ulink" href="http://bl.ocks.org/mbostock" target="_top">bl.ocks.org/mbostock</a> </dt>
<dd> Even more examples, in this case all by Mike Bostock, each one typically highlighting just one of D3’s features. 
</dd>
<dt>

<a class="ulink" href="https://github.com/mbostock/d3/wiki/API-Reference" target="_top">github.com/mbostock/d3/wiki/API-Reference</a> </dt>
<dd> The D3 API reference, an essential reference for every method and its parameters. 
</dd>
<dt>

<a class="ulink" href="http://stackoverflow.com/questions/tagged/d3.js" target="_top">stackoverflow.com/questions/tagged/d3.js</a> </dt>
<dd> When you get stuck, post questions on StackOverflow with the <code class="literal">d3.js</code> tag. 
</dd>
<dt>

<a class="ulink" href="https://groups.google.com/forum/?fromgroups#!forum/d3-js" target="_top">groups.google.com/forum/?fromgroups#!forum/d3-js</a> </dt>
<dd> Everyone who’s anyone is on the D3 Google Group. 
 Find out about the latest projects and developments here. 
 (Please save technical questions for StackOverflow.) </dd>
<dt>

<a class="ulink" href="http://bl.ocks.org" target="_top">bl.ocks.org</a> </dt>
<dd> A service for posting code hosted on GitHub’s Gist, by Mike Bostock. 
 Perfect for quickly sharing your work with others, such as when seeking help on StackOverflow or boasting about your latest triumph on the Google Group. 
</dd>
<dt>

<a class="ulink" href="http://blog.visual.ly/creating-animations-and-transitions-with-d3-js/" target="_top">blog.visual.ly/creating-animations-and-transitions-with-d3-js/</a> </dt>
<dd> An excellent tutorial on

<em>Creating Animations and Transitions With D3</em> with lots of inline, interactive examples by Jérôme Cukier. 
</dd>
<dt>

<a class="ulink" href="http://www.d3noob.org" target="_top">d3noob.org</a> </dt>
<dd> A new, promising resource for D3 tips and tricks. 
</dd>
<dt>

<a class="ulink" href="http://tributary.io" target="_top">tributary.io</a> </dt>
<dd> A live-coding environment for experimenting with D3 code, by Ian Johnson. 
</dd>
<dt>

<a class="ulink" href="https://github.com/d3/d3-plugins" target="_top">D3 Plug-ins</a> </dt>
<dd> A listing of all the official plug-ins that extend D3’s functionality, in case it doesn’t do enough for you already. 
</dd> </dl> 

<h2>Twitterers</h2>
Twitter is a great way to find out about the latest projects and D3 developments. 
 At the risk of omitting many amazing people, here are some you should follow:

<dl class="variablelist">
<dt>

<a class="ulink" href="https://twitter.com/mbostock" target="_top">@mbostock</a> </dt>
<dd> Mike Bostock, for announcements on D3’s progress as well as new visualizations for

<em>The New York Times</em>. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/jasondavies" target="_top">@jasondavies</a> </dt>
<dd> Jason Davies, for all manner of geographic and mathematical mapping experiments. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/d3visualization" target="_top">@d3visualization</a> </dt>
<dd> Christophe Viau, for frequent updates from all over the D3 universe. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/enjalot" target="_top">@enjalot</a> </dt>
<dd> Ian Johnson, for loads of new coding tools and techniques, plus video tutorials. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/syntagmatic" target="_top">@syntagmatic</a> </dt>
<dd> Kai Chang, for too many D3 experiments to count. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/jcukier" target="_top">@jcukier</a> </dt>
<dd> Jérôme Cukier, for innovative visualization projects with insightful process notes. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/darkgreener" target="_top">@darkgreener</a> </dt>
<dd> Anna Powell-Smith, for beautiful interactive visualizations that explore personally relevant data. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/vlandham" target="_top">@vlandham</a> </dt>
<dd> Jim Vallandingham, for excellent process notes on projects as well as great tutorials. 
</dd>
<dt>

<a class="ulink" href="https://twitter.com/alignedleft" target="_top">@alignedleft</a> </dt>
<dd> Scott Murray, for learning about errata, updates, and revisions to this book, as well as future data-driven projects. 
</dd> </dl>
I should acknowledge that, yes, there are mostly men listed here. 
 As of this writing, the community of D3 users and contributors tends to skew quite male. 
 I hope that future editions of this book can confidently include a more diverse listing.

<script src='https://williamkpchan.github.io/LibDocs/readbook.js'></script>
<script>
var lazyLoadInstance = new LazyLoad({
    elements_selector: ".lazy"
    // ... more custom settings?
});
</script>
</pre>
</body></html>