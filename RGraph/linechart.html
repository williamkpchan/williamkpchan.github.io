<!DOCTYPE html>
<html>
<head>
<title>Line chart</title>
<link rel="stylesheet" href="https://williamkpchan.github.io/maincss.css">
<script src="libraries/RGraph.common.core.js"></script>
<script src="libraries/RGraph.line.js"></script>
<script src="libraries/RGraph.svg.bar.js" ></script>

<style>
body {
 margin: auto;
 width: 80%;
 font-size: 24px;
 background-color: #000000;
 color: #20C030;
}
</style>

</head>
<body onkeypress="chkKey()">
<canvas id="cvs" width="1200" height="600">[No canvas support]</canvas>
<pre>
command: l, paste data array to redraw chart with std dev
3 lines: data, 5 WAve, 10 WAve

</pre>
<script>
	stkpriceDataArr = [74.07,74.87,75.08,76.17,76.05,76.67,77.03,77.26,77.96,77.01,77.24,78.63,78.69,78.64,78.48,79.39,78.77,80.68,79.86,80.06,80.32,79.16,79.48,79.68,79.12,80.12,80.15,80.90,81.18,81.88,82.14,83.51,83.36,83.57,83.61,84.54,84.16,83.99,85.34,84.85,85.09,85.13,85.62,86.87,87.55,87.41,88.24,88.58,89.41,88.27,87.48,88.40,88.38,90.05,90.01,91.21,90.83,91.45,93.41,93.99,94.81,96.44,96.51,98.15,97.41,96.98,96.55,97.13,97.60,97.59,97.45,97.44,98.16,99.43,100.72,99.70,98.73,99.23,100.29,98.89,99.08,99.00,99.11,99.53,99.31,99.15,99.41,98.60,98.24,98.18,99.21,99.80,99.07,98.52,98.16,97.94,96.91,97.29,97.09,97.24,98.13,97.10,96.81,96.68,95.47,94.16,94.31,94.75,94.47,95.04,95.01,94.38,95.15,96.69,98.41,99.17,100.06,101.17,101.79,102.50,102.17,101.12,102.89,103.35,103.94,104.00,104.01,103.82,104.14,104.60,105.46,105.01,104.25,104.93,106.54,105.78,106.85,107.18,106.89,107.99,108.80,108.17,109.81,110.14,111.11,111.19,112.25,114.35,116.07,116.81,116.17,115.05,114.38,114.57,114.97,115.18,115.78,115.60,115.93,118.38,119.13,120.66,121.73,121.58,121.64,121.95,122.09,123.66,123.45,123.01,121.83,120.12,118.71,118.84,118.51,118.58,118.79,119.06,120.14,120.74,119.96,121.22,121.88,119.69,120.14,120.61,120.95,120.41,119.30,119.79,119.85,120.86,121.94,120.84,121.08,120.00,119.83,119.87,120.08,119.50,120.72,119.93,120.13,120.39,119.53,118.96,118.61,118.95,119.07,118.96,117.71,118.20,117.56,118.31,118.08,117.41,117.77,118.02,117.18,118.25,118.42,117.22,118.82,119.04,118.31,118.40,118.12,118.86,118.56,119.07,118.37,119.23,119.89,121.16,121.19,123.35,123.36,123.20,123.54,124.00,125.66,125.31,126.20,126.94,126.14,126.80,127.46,128.14,127.65,129.83,129.38,129.39,129.40,129.69,129.61,130.16,130.46,131.61,132.81,132.69,132.45,133.34,133.64,134.64,134.03,136.35,136.64,137.20,136.20,137.12,138.80,139.03,140.05,139.70,142.36,141.60,140.04,141.22,141.46,141.37,141.30,140.33,141.96,143.31,142.26,141.87,143.56,143.15,142.62,143.32,145.48,146.07,144.29,144.84,145.45,146.78,146.76,146.92,146.67,146.01,146.45,144.61,144.33,142.98,141.76,142.14,141.13,140.27,139.82,138.22,137.30,136.86,135.89,135.83,134.41,134.95,132.90,131.95,131.01,130.58,130.77,131.76,130.30,127.50,128.40,127.46,127.84,128.34,127.96,129.87,128.48,128.63,128.41,128.51,128.37,128.75,129.20,129.38,129.44,128.85,129.84,130.50,130.47,131.34,131.28,133.41,133.13,136.21,137.50,136.57,138.70,137.62,141.04,141.77,141.53,144.09,143.68,143.49,143.95,144.08,144.47,144.91,145.17,145.44,146.30,144.72,144.28,144.16,146.80,145.89,146.59,146.83,147.74,148.22,148.67,149.38,150.55,150.89,152.18,152.57,152.77,154.57,155.45,156.27,156.44,158.26,158.78,158.92,159.88,159.12,160.26,160.05,159.56,159.15,159.88,160.30,159.84,160.14,160.80,161.36,160.61,160.95,160.75,160.93,160.02,159.89,160.57,159.84,158.72,161.83,162.60,162.34,163.34,163.29,164.46,165.30,165.62,165.02,165.59,167.51,167.63,167.96,167.89,168.60,171.59,170.85,171.67,170.82,174.00,174.94,177.61,177.42,179.90,180.00,182.17,183.14,183.23,180.96,181.58,181.60,182.64,184.43,186.33,186.81,187.71,187.31,187.76,188.61,188.36,188.64,187.56,188.44,188.44,187.03,186.60,186.60,185.51,185.25,185.07,184.77,183.70,182.73,180.40,179.18,177.39,176.81,175.59,174.74,174.37,174.49,171.92,170.19,170.64,170.86,169.95,170.39,170.87,171.91,172.24,173.47,174.76,177.41,179.50,180.16,180.37,183.19,183.92,186.07,187.41,188.62,189.42,188.95,186.26,187.02,187.83,190.48,189.77,188.94,189.43,188.76,188.43,188.22,188.39,187.97,185.45,184.96,183.28,182.66,182.24,180.98,180.32,180.07,179.01,179.40,182.10,181.09,181.36,179.88,179.11,179.18,176.98,175.88,177.09,177.58,178.58,178.84,178.80,178.11,174.94,174.03,175.41,175.56,175.51,175.43,174.86,175.68,175.90,175.00,175.94,177.54,178.54,180.26,178.64,180.74,181.12,178.48,178.95,180.81,181.77,181.69,180.74,180.57,180.90,178.71,177.43,177.85,176.76,176.59,176.74,178.05,175.83,176.85];

     mydata= [ // this set of data is the y values, the x values are from 1 to length of data set
        stkpriceDataArr, 
        makeMovAve(stkpriceDataArr, 50),
        makeMovAve(stkpriceDataArr, 100),
     ];

       theMax = Math.max(...[].concat(...mydata));
       theMin = Math.min(...[].concat(...mydata));

     function chkKey() {
       var testkey = getChar(event);
       if(testkey == 'l'){loadLineData();}
     }
     function getChar(event) {
       if (event.which!=0 && event.charCode!=0) {
         return String.fromCharCode(event.which)   // the rest
       } else {
         return null // special key
       }
     }

	function loadLineData() {
      var dataArr = prompt("Enter stk list seperated by space:", "");
      if (dataArr != null && dataArr != "") {
        dataArrArr = dataArr.split(' ');

        stkpriceDataArr = dataArrArr.map(Number);
        RGraph.reset(document.getElementById('cvs'));

        stdDev = makeStd(stkpriceDataArr, 10)
        newDevadd = makeMovAve(stkpriceDataArr, 10).map((a, i) => a + stdDev[i]);
        newDevminus = makeMovAve(stkpriceDataArr, 10).map((a, i) => a - stdDev[i]);

        mydata= [
          stkpriceDataArr, 
          makeMovAve(stkpriceDataArr, 5),
          makeMovAve(stkpriceDataArr, 10),
          newDevadd, newDevminus,
       ];
       theMax = Math.max(...[].concat(...mydata));
       theMin = Math.min(...[].concat(...mydata));

        drawchart()
      }
     }

	function makeMovAve(bigArray, intv) {
	     // the intv-1 is correct
		return bigArray.slice(0, intv-1).concat(calcMovAve(bigArray, intv));
	}
	function calcAve(aveArray) {
		add = (a, b) =>  a + b;
		return aveArray.reduce(add) / aveArray.length;
	}
	
	function calcMovAve(bigArray, intv) {
		var ma = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {ma[i] = calcWAve(bigArray.slice(i, i+intv));} // points to indicator
		return ma;
	}
	function calcWAve(aveArray) {
		var sum = 0
		for( var i = 1; i <= aveArray.length; i++ ) {
			sum += aveArray[i-1] * i;
		}
		return (sum / ((1 + aveArray.length)*aveArray.length/2))
	}

	function makeStd(bigArray, intv) {
	     // the intv-1 is correct
          newArray = new Array(intv-1).fill(0)
		newArray = newArray.concat(calcStd(bigArray, intv));
		return newArray
	}

	function calcStd(bigArray, intv) {
		var stdArrar = [];
		for (var i =0 ; i < (bigArray.length-intv+1); i++) {stdArrar[i] = Std(bigArray.slice(i, i+intv));} // points to indicator
		return stdArrar;
	}

	function Std(array) {
	  const n = array.length
	  const mean = array.reduce((a, b) => a + b) / n
	  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
	}



    myOlddata= [
        [5,2,10,3,5,4,5,5,2.5,6,7,8,9,11],
        [3,1,7,5,10,6,4,4,2,1,2,3,4,5],
        [10, 11, 2, 2.5, 3, 4, 5, 5, 5, 5, 6, 7, 8, 9],
    ];
    
    function drawchart() {
console.log(theMax, theMin)
      var line = new RGraph.Line({
        id:'cvs',
        data:mydata,
        options: {
            // colors: ['darkgreen','blue','grey'],
            backgroundGrid: false,
            axisColor: '#864',
            textColor: '#ccc',
            tickmarks: 'filledcircle',
            ticksize: 1,
            linewidth:1,
			ymax: theMax,
			ymin: theMin,
      // labels control the number of grids
            // labels: ['2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018'],
            spline: true,
            backgroundGrid: false,
            backgroundGridColor: '#002010',
            shadow: false,
            gutterLeft: 50,
            gutterRight: 50,
            gutterTop: 50,
            gutterBottom: 50
            }
          }).trace();
    };
    drawchart();
</script>
</body>
</html>