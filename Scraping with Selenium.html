<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<style>

a:hover,a:active{color:red}
table.w3-table-all{margin:20px 0}
.top {
 position:relative;
 background-color:black;
 height:68px;
 padding-top:20px;
 line-height:50px;
 overflow:hidden;
 z-index:2;
}
body {
 background-color: #000000;
 color: MediumSeaGreen;
 margin-left: 14%;
 margin-right: 14%;
 font-size: 24px;
}
a { text-decoration: none;
	color: #58D858;}
a:visited { color: #88C898;}
A:hover {	color: yellow;}
A:focus {	color: red;}
code { color: gray; background-color: #001010; font-size: 18px;}
pre { color: gray; background-color: #001010; font-size: 18px;}
h1, h2, h3, h4, h5, .goldword {
	color: gold;
}
table{
	width: 100%;
	font-size: 20px;
	border-collapse: collapse;
	border: 1px solid gray;
}
th{
	border: 1px solid gray;
	font-weight:bold;
	color: lightgreen;
}
td{
	padding:10px;
	border: 1px dotted dimgray;
}
tr>th:first-child{
	width:40%;
}
tr>td:first-child{
	color: lime;

}
img{
	margin-top:1%;
	margin-bottom:2%;
}
.topic{
    color: lime;
}
.goldsha {
    color: white;
    border: 1px solid gold;
    padding: 2px;
    border-radius: 3px;
	box-shadow: -2px -2px 3px gold inset;
}
.redsha {
    color: gold;
    border: 1px solid red;
    padding: 2px;
    border-radius: 3px;
	box-shadow: -2px -2px 3px red inset;
}
.whitesha {
    color: red;
    border: 1px solid white;
    padding: 2px;
    border-radius: 3px;
	box-shadow: -3px -2px 3px white inset;
}
.orangesha {
    color: yellow;
    border: 1px solid orange;
    padding: 2px;
    border-radius: 3px;
	box-shadow: -2px -2px 3px orange inset;
}
.yellowsha {
    color: lime;
    border: 1px solid yellow;
    padding: 2px;
    border-radius: 3px;
	box-shadow: 3px 3px 3px silver;
	display: inline-block;
}
.greensha {
    color: lightblue;
    border: 1px solid green;
    padding: 2px;
    border-radius: 3px;
	box-shadow: -2px -2px 3px green inset;
}
.left {
    position: absolute;
    left: 100px;
    color: GoldenRod;
    border: 1px solid GoldenRod;
    padding: 2px;
    font-size: 60%;
}
.bord {
    color: redpink;
    border: 1px solid GoldenRod;
    padding: 1px;
    font-size: 90%;
}
.yellowbord {
    color: lime;
    border: 1px solid yellow;
    padding: 2px;
    border-radius: 3px;
	box-shadow: 3px 3px 3px silver;
}
.bluebord {
    color: white;
    border: 1px solid lightblue;
    padding: 2px;
    border-radius: 3px;
	box-shadow: -2px -2px 3px silver inset;
}
.highlight { 
    color: white;
    background-color: #002030
  }
hr {width: 50%;}
li{
	list-style-type: decimal;
}
#toc, #tang, #san, #pill {
	margin-left: 15%;
	margin-right: 15%;
	color: gold;
	padding: 1%;
	text-align: left;
	box-shadow: 5px 5px 15px silver;
	border-radius: 5px;
	border: 1px solid DarkSlateGray;
    font-size: 90%;
}
.mywords{
    color: Crimson;
}
.orangeword{
    color: orange;
}
.remarks {
	font-size: 22px;
	color: MediumSeaGreen;
}
</STYLE>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.js"></script>
<script>
$(document).ready(function(){
    $('h1, h2, h3, h4, h5, .goldword, .topic').click(function(){
    parent.history.back();
    return false;
    });
});
</script>


</head><body>

<center><h2>Scraping with Selenium</h2></center>
<div id="toc"><ul></ul></div>
<br>
<br>
<br>


<h3 id="how-it-works">How it works</h3>
<p>Selenium is a web automation tool.<br />
While not developed specifically for web scraping, Selenium does it pretty dang well.<br />
Selenium literally “drives” your browser, so it can see anything you see when you right click and inspect element in Chrome or Firefox.<br />
This vastly widens the universe of content that can be extracted from automation, but can be slow as all content must be rendered in the browser.  </p>
<p>There are headless (invisible browsers with no GUI) such as <a href="http://phantomjs.org/" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://phantomjs.org/', 'phantomjs']);" ref="nofollow" target="_blank">phantomjs</a> that 
speed some of this up.  That said, I’ve found that Selenium works best for targeted extraction where the user knows exactly what they want.</p>
<h3 id="example">Example</h3>
<p>I set out to collect tickers for all mutual funds in the asset allocation fund type.  Fidelity provides a list of all these funds <a href="https://www.fidelity.com/fund-screener/evaluator.shtml#!&amp;ntf=N&amp;ft=BAL_all&amp;msrV=advanced&amp;sortBy=FUND_MST_MSTAR_CTGY_NM&amp;pgNo=1" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'https://www.fidelity.com/fund-screener/evaluator.shtml#!&amp;ntf=N&amp;ft=BAL_all&amp;msrV=advanced&amp;sortBy=FUND_MST_MSTAR_CTGY_NM&amp;pgNo=1', 'here']);" ref="nofollow" target="_blank">here</a>.<br />
1,586 funds as of today in 80 conveniently paginated URLs.  Each URL ends in <code>&amp;pgNo=5</code> to indicate you want page 5 (or whatever number between 1 and 80).</p>
<p>In my browser, when I hover my mouse over one of the fund names in the table, I see the 5 character ticker I’m looking for.<br />
I also see the tickers directly on the webpage when I click the link to each fund.<br />
<a href="https://fundresearch.fidelity.com/mutual-funds/summary/72201F433" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'https://fundresearch.fidelity.com/mutual-funds/summary/72201F433', 'Here']);" ref="nofollow" target="_blank">Here</a> for example, where it says PSLDX in the top left.<br />
However, if possible I’d like to scrape the tickers from the table rather than the individual fund pages.<br />
This would mean 80 pages to scrape rather than 1,586.</p>
<h3 id="take-1-traditional-http-request">Take 1: traditional http request</h3>
<p>When possible, it makes sense to use the simple traditional methods.  So I first tried to extract these tickers with the popular <code>httr</code> R package<br />
by making standard http requests.</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span><span class="s">&#39;httr&#39;</span><span class="p">)</span>
url <span class="o">&lt;-</span> <span class="s">&#39;https://www.fidelity.com/fund-screener/evaluator.shtml#!&amp;ft=BAL_all&amp;ntf=N&amp;expand=%24FundType&amp;rsk=5&#39;</span>
page <span class="o">&lt;-</span> GET<span class="p">(</span><span class="kp">url</span><span class="p">)</span></code></pre>
</div>
<p>Success…</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r"><span class="kp">print</span><span class="p">(</span>http_status<span class="p">(</span>page<span class="p">))</span></code></pre>
</div>
<div class="highlight">
<pre><code class="language-text" data-lang="text">## $category
## [1] &quot;success&quot;
## 
## $message
## [1] &quot;success: (200) OK&quot;</code></pre>
</div>
<p>But did our http request return the information we want?</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r">page_text <span class="o">&lt;-</span> content<span class="p">(</span>page<span class="p">,</span> as<span class="o">=</span><span class="s">&#39;text&#39;</span><span class="p">)</span></code></pre>
</div>
<p>Nope – can’t find the tickers (one of them anyway). </p>
<div class="highlight">
<pre><code class="language-r" data-lang="r"><span class="kp">grepl</span><span class="p">(</span><span class="s">&#39;GMMAX&#39;</span><span class="p">,</span> page_text<span class="p">,</span> ignore.case<span class="o">=</span><span class="bp">T</span><span class="p">)</span></code></pre>
</div>
<div class="highlight">
<pre><code class="language-text" data-lang="text">## [1] FALSE</code></pre>
</div>
<p>Nope – can’t even find the fund name that I see in the table from the webpage in my browser. </p>
<div class="highlight">
<pre><code class="language-r" data-lang="r"><span class="kp">grepl</span><span class="p">(</span><span class="s">&#39;Aberdeen&#39;</span><span class="p">,</span> page_text<span class="p">,</span> ignore.case<span class="o">=</span><span class="bp">T</span><span class="p">)</span></code></pre>
</div>
<div class="highlight">
<pre><code class="language-text" data-lang="text">## [1] FALSE</code></pre>
</div>
<p>It appears that the content of interest is being generated dynamically with Javascript and Ajax on this webpage.<br />
So the raw HTML of this page doesn’t help us much.</p>
<p>My plan B was to grab the url for each fund from the table, navigate to that fund’s page, and extract the ticker from there.<br />
However these links weren’t in our http response.  I noticed that the URLs for each fund followed a simple consistent structure.  <br />
<a href="https://fundresearch.fidelity.com/mutual-funds/summary/72201F433" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'https://fundresearch.fidelity.com/mutual-funds/summary/72201F433', 'https://fundresearch.fidelity.com/mutual-funds/summary/72201F433']);" ref="nofollow" target="_blank">https://fundresearch.fidelity.com/mutual-funds/summary/72201F433</a> for example.<br />
I thought maybe I could find 72201F433 which looks like some sort of fund ID in a list with all fund IDs in the http response.<br />
No dice.  Plan C – Selenium.</p>
<h3 id="take-2-selenium">Take 2: Selenium</h3>
<p>I used the <a href="http://www.github.com/ropensci/RSelenium/" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://www.github.com/ropensci/RSelenium/', 'RSelenium']);" ref="nofollow" target="_blank">RSelenium</a> R package for this mini project.  There are also Selenium bindings for Python, Java, C#, Javascript and Ruby which make replicating this process in your programming language of choice relatively straightforward.</p>
<p><strong>Step 1: Fire up Selenium</strong></p>
<div class="highlight">
<pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span><span class="s">&#39;RSelenium&#39;</span><span class="p">)</span>
checkForServer<span class="p">()</span> <span class="c1"># search for and download Selenium Server java binary.  Only need to run once.</span>
startServer<span class="p">()</span> <span class="c1"># run Selenium Server binary</span>
remDr <span class="o">&lt;-</span> remoteDriver<span class="p">(</span>browserName<span class="o">=</span><span class="s">&quot;firefox&quot;</span><span class="p">,</span> port<span class="o">=</span><span class="m">4444</span><span class="p">)</span> <span class="c1"># instantiate remote driver to connect to Selenium Server</span>
remDr<span class="o">$</span><span class="kp">open</span><span class="p">(</span>silent<span class="o">=</span><span class="bp">T</span><span class="p">)</span> <span class="c1"># open web browser</span></code></pre>
</div>
<p><strong>Step 2: Start scraping</strong></p>
<p>To figure which DOM elements I wanted Selenium extract, I used the Chrome Developer Tools which can be invoked by right clicking a fund in the table and selecting Inspect Element.  The HTML displayed here contains exactly what we want, what we didn’t see with our http request.</p>
<p>Since I want to grab all the funds at once, I tell Selenium to select the whole table.  Going a few levels up from the individual cell in the table I’ve selected, I see that <code>&lt;tbody id="tbody"&gt;</code> is the HTML tag that contains the entire table, so I tell Selenium to find this element.  I use the nifty <code>highlightElement</code> function to confirm graphically in the browser that this is what I think it is.</p>
<p>Then it’s business as usual.  I parse the string output from Selenium into an HTML tree and use XPath to parse the table for just the fund name and ticker.</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span><span class="s">&#39;XML&#39;</span><span class="p">)</span>
master <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">()</span>
n <span class="o">&lt;-</span> <span class="m">5</span> <span class="c1"># number of pages to scrape.  80 pages in total.  I just scraped 5 pages for this example.</span>
<span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>n<span class="p">)</span> <span class="p">{</span>
  site <span class="o">&lt;-</span> <span class="kp">paste0</span><span class="p">(</span><span class="s">&quot;https://www.fidelity.com/fund-screener/evaluator.shtml#!&amp;ntf=N&amp;ft=BAL_all&amp;msrV=advanced&amp;sortBy=FUND_MST_MSTAR_CTGY_NM&amp;pgNo=&quot;</span><span class="p">,</span>i<span class="p">)</span> <span class="c1"># create URL for each page to scrape</span>
  remDr<span class="o">$</span>navigate<span class="p">(</span>site<span class="p">)</span> <span class="c1"># navigates to webpage</span>
  
  elem <span class="o">&lt;-</span> remDr<span class="o">$</span>findElement<span class="p">(</span>using<span class="o">=</span><span class="s">&quot;id&quot;</span><span class="p">,</span> value<span class="o">=</span><span class="s">&quot;tbody&quot;</span><span class="p">)</span> <span class="c1"># get big table in text string</span>
  elem<span class="o">$</span>highlightElement<span class="p">()</span> <span class="c1"># just for interactive use in browser.  not necessary.</span>
  elemtxt <span class="o">&lt;-</span> elem<span class="o">$</span>getElementAttribute<span class="p">(</span><span class="s">&quot;outerHTML&quot;</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span> <span class="c1"># gets us the HTML</span>
  elemxml <span class="o">&lt;-</span> htmlTreeParse<span class="p">(</span>elemtxt<span class="p">,</span> useInternalNodes<span class="o">=</span><span class="bp">T</span><span class="p">)</span> <span class="c1"># parse string into HTML tree to allow for querying with XPath</span>
  fundList <span class="o">&lt;-</span> <span class="kp">unlist</span><span class="p">(</span>xpathApply<span class="p">(</span>elemxml<span class="p">,</span> <span class="s">&#39;//input[@title]&#39;</span><span class="p">,</span> xmlGetAttr<span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">))</span> <span class="c1"># parses out just the fund name and ticker using XPath</span>
  master <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span>master<span class="p">,</span> fundList<span class="p">)</span> <span class="c1"># append fund lists from each page together</span>
<span class="p">}</span>

<span class="kp">head</span><span class="p">(</span>master<span class="p">)</span></code></pre>
</div>
<div class="highlight">
<pre><code class="language-text" data-lang="text">## [1] &quot;FidelityAA Global Balanced Fund (FGBLX)&quot;                    
## [2] &quot;FidelityAA Global Strategies Fund (FDYSX)&quot;                  
## [3] &quot;Fidelity FreedomA 2055 Fund (FDEEX)&quot;                       
## [4] &quot;Aberdeen Dynamic Allocation Fund Class A (GMMAX)&quot;           
## [5] &quot;Aberdeen Dynamic Allocation Fund Class C (GMMCX)&quot;           
## [6] &quot;AllianceBernstein Real Asset Strategy Advisor Class (AMTYX)&quot;</code></pre>
</div>
<p><strong>Step 3: Extract ticker</strong></p>
<p>Nothing fancy here – just separating the ticker from the fund name.</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r">master2 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span><span class="kp">sapply</span><span class="p">(</span>master<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="kp">substr</span><span class="p">(</span>x<span class="p">,</span> <span class="kp">nchar</span><span class="p">(</span>x<span class="p">)</span><span class="m">-5</span><span class="p">,</span> <span class="kp">nchar</span><span class="p">(</span>x<span class="p">)</span><span class="m">-1</span><span class="p">)))</span>
master2<span class="o">$</span>name <span class="o">&lt;-</span> <span class="kp">sapply</span><span class="p">(</span>master<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="kp">substr</span><span class="p">(</span>x<span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="kp">nchar</span><span class="p">(</span>x<span class="p">)</span><span class="m">-8</span><span class="p">))</span>
<span class="kp">names</span><span class="p">(</span>master2<span class="p">)</span> <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&#39;ticker&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span>

<span class="kp">head</span><span class="p">(</span>master2<span class="p">)</span></code></pre>
</div>
<div class="highlight">
<pre><code class="language-text" data-lang="text">##   ticker                                                name
## 1  FGBLX                     FidelityAA Global Balanced Fund
## 2  FDYSX                   FidelityAA Global Strategies Fund
## 3  FDEEX                        Fidelity FreedomAA 2055 Fund
## 4  GMMAX            Aberdeen Dynamic Allocation Fund Class A
## 5  GMMCX            Aberdeen Dynamic Allocation Fund Class C
## 6  AMTYX AllianceBernstein Real Asset Strategy Advisor Class</code></pre>
</div>
<h3 id="what-else-can-selenium-do">What else can Selenium do?</h3>
<p>My little example makes use of the simple functionality provided by Selenium for web scraping – rendering HTML that is dynamically generated with Javascript or Ajax.  Since Selenium is actually a web automation tool, one can be much more sophisticated by using it to automate a human navigating a webpage with mouse clicks and writing and submitting forms.  This can be a huge time saver for researchers that rely on front-end interfaces on the web to extract data in chunks.</p>
<p><a href="http://thiagomarzagao.com/2013/11/12/webscraping-with-selenium-part-1/" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://thiagomarzagao.com/2013/11/12/webscraping-with-selenium-part-1/', 'Here’s']);" ref="nofollow" target="_blank">Here’s</a> a basic example using Python.<br />
<a href="http://cran.r-project.org/web/packages/RSelenium/vignettes/RSelenium-basics.html" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://cran.r-project.org/web/packages/RSelenium/vignettes/RSelenium-basics.html', 'Here’s']);" ref="nofollow" target="_blank">Here’s</a> a basic example using R.</p>
<h3 id="getting-setup">Getting setup</h3>
<p>On the several computers I use, I’ve found setup ranging from seamless to frustrating.</p>
<p>The most frustrating issue I encountered while setting up on my Mac was this error message:</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r"><span class="o">&gt;</span> remDr<span class="o">$</span><span class="kp">open</span><span class="p">()</span>

<span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="s">&quot;Connecting to remote server&quot;</span>
Error<span class="o">:</span>    Summary<span class="o">:</span> UnknownError
 	 Detail<span class="o">:</span> An unknown server<span class="o">-</span>side error occurred <span class="kr">while</span> processing the command.
 	 <span class="kp">class</span><span class="o">:</span> java.lang.IllegalStateException</code></pre>
</div>
<p>I was able to resolve it by killing all processes running on port 4444 and trying again.</p>
<p>At the terminal:</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r">lsof <span class="o">-</span>i <span class="o">:</span><span class="m">4444</span></code></pre>
</div>
<p>Kill PIDs of any processes listed.  For example:</p>
<div class="highlight">
<pre><code class="language-r" data-lang="r">kill <span class="m">30681</span></code></pre>
</div>
<br>
<br><br><br><br><br>
<script>
  $(function() {
    var toc = $('#toc>ul');

    function makeLi(text, href) {
      return $('<a href="' + href + '" target="_self">' + text + '</a><br>');
    }

    $('h3').each(function(i) {
      var chapter = $(this), chapterNumber = i + 1;
      toc.append(
        makeLi(chapter.text(), '#chapter-' + chapterNumber)
      );
      chapter.attr('id', 'chapter-' + chapterNumber);
    });

  });
</script>
</body>
</html>
